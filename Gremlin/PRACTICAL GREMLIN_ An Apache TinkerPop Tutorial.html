<!DOCTYPE html>
<!-- saved from url=(0067)https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#javatinker -->
<html lang="en" __snippetscriptloaded__="yes"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.7.1">
<meta name="author" content="Kelvin R. Lawrence">
<title>PRACTICAL GREMLIN: An Apache TinkerPop Tutorial</title>
<link rel="stylesheet" href="./PRACTICAL GREMLIN_ An Apache TinkerPop Tutorial_files/css(1)">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote::before{display:none}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{word-spacing:0;line-height:1.6}
.quoteblock.abstract blockquote::before,.quoteblock.abstract p::before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="./PRACTICAL GREMLIN_ An Apache TinkerPop Tutorial_files/font-awesome.min.css">
<style>
.listingblock .pygments .hll { background-color: #4f424c }
.listingblock .pygments, .listingblock .pygments code { background: #2f1e2e; color: #ffffff }
.listingblock .pygments .tok-c { color: #776e71 } /* Comment */
.listingblock .pygments .tok-err { color: #ef6155 } /* Error */
.listingblock .pygments .tok-k { color: #815ba4 } /* Keyword */
.listingblock .pygments .tok-l { color: #f99b15 } /* Literal */
.listingblock .pygments .tok-n { color: #e7e9db } /* Name */
.listingblock .pygments .tok-o { color: #5bc4bf } /* Operator */
.listingblock .pygments .tok-p { color: #e7e9db } /* Punctuation */
.listingblock .pygments .tok-ch { color: #776e71 } /* Comment.Hashbang */
.listingblock .pygments .tok-cm { color: #776e71 } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #776e71 } /* Comment.Preproc */
.listingblock .pygments .tok-cpf { color: #776e71 } /* Comment.PreprocFile */
.listingblock .pygments .tok-c1 { color: #776e71 } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #776e71 } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #ef6155 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gh { color: #e7e9db; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #48b685 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #ffffff } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #776e71; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #5bc4bf; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-kc { color: #815ba4 } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #815ba4 } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #5bc4bf } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #815ba4 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #815ba4 } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #fec418 } /* Keyword.Type */
.listingblock .pygments .tok-ld { color: #48b685 } /* Literal.Date */
.listingblock .pygments .tok-m { color: #f99b15 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #48b685 } /* Literal.String */
.listingblock .pygments .tok-na { color: #06b6ef } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #e7e9db } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #fec418 } /* Name.Class */
.listingblock .pygments .tok-no { color: #ef6155 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #5bc4bf } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #e7e9db } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #ef6155 } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #06b6ef } /* Name.Function */
.listingblock .pygments .tok-nl { color: #e7e9db } /* Name.Label */
.listingblock .pygments .tok-nn { color: #fec418 } /* Name.Namespace */
.listingblock .pygments .tok-nx { color: #06b6ef } /* Name.Other */
.listingblock .pygments .tok-py { color: #e7e9db } /* Name.Property */
.listingblock .pygments .tok-nt { color: #5bc4bf } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #ef6155 } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #5bc4bf } /* Operator.Word */
.listingblock .pygments .tok-w { color: #ffffff } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #f99b15 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #f99b15 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #f99b15 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #f99b15 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #f99b15 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #48b685 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #e7e9db } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #776e71 } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #48b685 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #f99b15 } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #48b685 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #f99b15 } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #48b685 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #48b685 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #48b685 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #48b685 } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #e7e9db } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #ef6155 } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #ef6155 } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #ef6155 } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #f99b15 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="book" data-new-gr-c-s-check-loaded="14.1086.0" data-gr-ext-installed="" data-new-gr-c-s-loaded="14.1086.0">
<div id="header">
<img src="./PRACTICAL GREMLIN_ An Apache TinkerPop Tutorial_files/PRACTICAL-GREMLIN-Revised-v2.png">
<h1>PRACTICAL GREMLIN:<br>An Apache TinkerPop Tutorial</h1>
<div class="details">
<span id="author" class="author">Kelvin R. Lawrence</span><br>
<span id="email" class="email"><a href="mailto:gfxman@yahoo.com">gfxman@yahoo.com</a></span><br>
<span id="revnumber">version 283-preview,</span>
<span id="revdate">May 4th 2022</span>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_introduction">1. INTRODUCTION</a>
<ul class="sectlevel2">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_how_this_book_came_to_be">1.1. How this book came to be</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_providing_feedback">1.2. Providing feedback</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#thanks">1.3. Some words of thanks</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#about">1.4. What is this book about?</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#samplesintro">1.5. Introducing the book sources, sample programs and data</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#tp34intro">1.6. A word about TinkerPop 3.4</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#tp35intro">1.7. Introducing TinkerPop 3.5</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#tp36intro">1.8. Introducing TinkerPop 3.6</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#whygraph">1.9. So what is a graph database and why should I care?</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#nodevert">1.10. A word about terminology</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#gs">2. GETTING STARTED</a>
<ul class="sectlevel2">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#tpintro">2.1. What is Apache TinkerPop?</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#gconsole">2.2. The Gremlin console</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#gremlininstall">2.2.1. Downloading, installing and launching the console</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#gremlinsave">2.2.2. Saving output from the console to a file</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#tgintro">2.3. Introducing TinkerGraph</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#air">2.4. Introducing the air-routes graph</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#airrouteupdates">2.4.1. Updated versions of the air-route data</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#mn">2.5. TinkerPop 3 migration notes</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#cr">2.5.1. Creating a TinkerGraph TP2 vs TP3</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#ld2">2.5.2. Loading a graphML file TP2 vs TP3</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#sugarplugin">2.5.3. A word about the TinkerPop.sugar plugin</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#ld">2.6. Loading the air-routes graph using the Gremlin console</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#off">2.7. Turning off some of the Gremlin console’s output</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#indexschema">2.8. A word about indexes and schemas</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#gq">3. WRITING GREMLIN QUERIES</a>
<ul class="sectlevel2">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#gremlinintro">3.1. Introducing Gremlin</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#gremlinandsql">3.1.1. A quick look at Gremlin and SQL</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#bq">3.2. Some fairly basic Gremlin queries</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#values">3.2.1. Retrieving property values from a vertex</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#exist">3.2.2. Does a specific property exist on a given vertex or edge?</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#count">3.2.3. Counting things</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#countgroup">3.2.4. Counting groups of things</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#walk">3.3. Starting to walk the graph</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_some_simple_graph_traversal_examples">3.3.1. Some simple graph traversal examples</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#pathintro">3.3.2. What vertices and edges did I visit? - Introducing <em>path</em></a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#pathfromto">3.3.3. Modifying a <em>path</em> using <em>from</em> and <em>to</em> modulators</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#edgeexist">3.3.4. Does an edge exist between two vertices?</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#aselproj">3.3.5. Using <em>as</em>, <em>select</em> and <em>project</em> to refer to traversal steps</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#multias">3.3.6. Using multiple <em>as</em> steps with the same label</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#pathselect">3.3.7. Returning selected parts of a path</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#exedge">3.3.8. Examining the edge between two vertices</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#limit">3.4. Limiting the amount of data returned</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#retrrange">3.4.1. Retrieving a range of vertices</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#dedup">3.4.2. Removing duplicates - introducing <em>dedup</em></a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#vm">3.5. Using <em>valueMap</em> to explore the properties of a vertex or edge</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#tp34vm">3.5.1. Changes to <em>valueMap</em> introduced in TinkerPop 3.4</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#element-map">3.6. An alternative to <em>valueMap</em> - introducing <em>elementMap</em></a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#var">3.7. Assigning query results to a variable</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#setsandlists">3.7.1. Introducing <em>toList</em>, <em>toSet</em>, <em>bulkSet</em> and <em>fill</em></a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#wid">3.8. Working with IDs</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#lab">3.9. Working with labels</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#local">3.10. Using the <em>local</em> step to make sure we get the result we intended</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#st">3.11. Basic statistical and numerical operations</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#tranges">3.12. Testing values and ranges of values</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#startswith">3.12.1. Using <em>between</em> to simulate <em>startsWith</em></a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#winout">3.12.2. Refining flight routes analysis using <em>not</em>, <em>neq</em>, <em>within</em> and <em>without</em></a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_using_coin_and_sample_to_sample_a_dataset">3.12.3. Using <em>coin</em> and <em>sample</em> to sample a dataset</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_using_math_random_to_more_randomly_select_a_single_vertex">3.12.4. Using <em>Math.random</em> to more randomly select a single vertex</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#textpredicates">3.13. New text search predicates added in TinkerPop 3.4</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#startingwith">3.13.1. startingWith</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#endingwith">3.13.2. endingWith</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#containing">3.13.3. containing</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#notStartingWith">3.13.4. notStartingWith</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#notEndingWith">3.13.5. notEndingWith</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#notContaining">3.13.6. notContaining</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#sort">3.14. Sorting things - introducing <em>order</em></a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#sortkeyvalue">3.14.1. Sorting by key or value</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#orderchanges">3.14.2. Changes to <em>order</em> introduced in TinkerPop release 3.3.4</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#bool">3.15. Boolean operations</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#where">3.16. Using <em>where</em> to filter things out of a result</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#whereby">3.16.1. Using <em>where</em> and <em>by</em> to filter results</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#choose">3.17. Using <em>choose</em> to write if…​then…​else type queries</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#chooseconstant">3.17.1. Including a constant value - introducing <em>constant</em></a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#option">3.18. Using <em>option</em> to write case/switch type queries</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#patmatch">3.19. Using <em>match</em> to do pattern matching</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#patternwhere">3.19.1. Pattern matching using a <em>where</em> step</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#union">3.20. Using <em>union</em> to combine query results</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#unionidentity">3.20.1. Introducing the <em>identity</em> step</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#unionconstant">3.20.2. Using <em>constant</em> values as part of a <em>union</em></a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#unionmore">3.20.3. More examples of the <em>union</em> step</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#unionthree">3.20.4. Using <em>union</em> to combine more complex traversal results</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#sideeffect">3.21. Using <em>sideEffect</em> to do things on the side</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#aggregate">3.22. Using <em>aggregate</em> to create a temporary collection</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#inject">3.23. Using <em>inject</em> to insert values into a query</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#injecttrick">3.23.1. A useful trick using <em>inject</em></a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#coalesce">3.24. Using <em>coalesce</em> to see which traversal returns a result</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#coalconst">3.24.1. Combining <em>coalesce</em> with a <em>constant</em> value</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#optional">3.25. Returning one of two possible results - introducing <em>optional</em></a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#otherv">3.26. Other ways to explore vertices and edges using <em>both</em>, <em>bothE</em>, <em>bothV</em> and <em>otherV</em></a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#sp">3.27. Shortest paths (between airports) - introducing <em>repeat</em></a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#emit">3.27.1. Using <em>emit</em> to return results during a <em>repeat</em> loop</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#nestedrepeat">3.27.2. Nested and named <em>repeat</em> steps</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#depthlimit">3.27.3. Limiting the results at each depth</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#cyclicpath">3.27.4. Haven’t I been here before? - Introducing <em>cyclicPath</em></a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#pathwarn">3.27.5. A warning that path finding can be memory and CPU intensive</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#pathstepwarn">3.27.6. A warning that the <em>path</em> and <em>as</em> steps can also be memory intensive</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#nd">3.28. Calculating vertex degree</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#mathstep">3.29. Gremlin’s scientific calculator - introducing <em>math</em></a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#arithmentic">3.29.1. Performing simple arithmetic</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#mathby">3.29.2. Using a <em>by</em> modulator with a <em>math</em> step</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#mathconvert">3.29.3. Converting feet to meters</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#mathtrig">3.29.4. Using the trigonometric functions</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#mathsignum">3.29.5. Using signum to make a choice</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#stddev">3.29.6. Calculating a standard deviation</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#stddevone">3.29.7. Calculating a standard deviation in one query</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#mathproject">3.29.8. Using <em>project</em> to feed values to <em>math</em></a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#withindex">3.30. Including an index with results - introducing <em>withIndex</em> and <em>indexed</em></a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#tp34index">3.30.1. The new <em>index</em> step added in TinkerPop 3.4</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#index-reverse">3.30.2. Using <em>index</em> to reverse a list</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#sx">3.31. More examples using concepts we have covered so far</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#beq">4. BEYOND BASIC QUERIES</a>
<ul class="sectlevel2">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#indents">4.1. A word about layout and indentation</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#rword">4.2. A warning about reserved word conflicts and collisions</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#dmodel">4.3. Thinking about your data model</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_keeping_information_in_two_places_within_the_same_graph">4.3.1. Keeping information in two places within the same graph</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_using_a_graph_as_an_index_into_other_data_sources">4.3.2. Using a graph as an index into other data sources</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_a_few_words_about_supernodes">4.3.3. A few words about <em>supernodes</em></a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#grv">4.4. Making Gremlin even Groovier</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#varaus">4.4.1. Using a variable to feed a traversal</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#addnodes">4.5. Adding vertices, edges and properties</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_adding_an_airport_vertex_and_a_route_edge">4.5.1. Adding an airport (vertex) and a route (edge)</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#addlabeldynamic">4.5.2. Using a traversal to determine a new label name</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#proptraversal">4.5.3. Using a traversal to seed a property with a list</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#injectid">4.5.4. Using <em>inject</em> to specify new vertex ID values</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#testgraph">4.5.5. Quickly building a graph for testing</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#addloop">4.5.6. Adding vertices and edges using a loop</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#coaladdv">4.5.7. Using <em>coalesce</em> to only add a vertex if it does not exist</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#upsert">4.5.8. Using <em>coalesce</em> to derive an <em>upsert</em> pattern</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#vertexcopy">4.5.9. Creating one vertex based on another</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#deleting">4.6. Deleting vertices, edges and properties</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_deleting_a_vertex">4.6.1. Deleting a vertex</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#deledge">4.6.2. Deleting an edge</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#delprop">4.6.3. Deleting a property</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_removing_all_the_edges_or_vertices_in_the_graph">4.6.4. Removing all the edges or vertices in the graph</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#pkvrevisited">4.7. Property keys and values revisited</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#vertexprop">4.7.1. The <em>Property</em> and <em>VertexProperty</em> interfaces</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#propmap">4.7.2. The <em>propertyMap</em> traversal step</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#propid">4.7.3. Properties have IDs too</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#listprop">4.7.4. Attaching multiple values (lists or sets) to a single property</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#propertycaution">4.7.5. A word of caution - behavior differences with <em>property</em></a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#explainstep">4.7.6. What did Gremlin do? - introducing <em>explain</em></a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#updatelist">4.7.7. Updating properties stored in a list</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#propsets">4.7.8. Creating properties that store sets</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#setlistnote">4.7.9. One more note about sets and lists</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#metaprop">4.7.10. Adding properties to other properties (meta properties)</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#tp34vmmetaprop">4.7.11. Using <em>unfold</em> and <em>WithOptions</em> with Meta Properties</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#deduce">4.8. Deducing the schema of a graph using queries</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#collrev">4.9. Collections revisited</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#collsteps">4.9.1. Steps that generate collections</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#collaccess">4.9.2. Accessing the contents of a collection</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#unbundle">4.9.3. Using <em>unfold</em> to unbundle a collection</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#localcollect">4.9.4. Using <em>local</em> scope with collections</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#rbarriers">4.10. Collections and reducing barrier steps</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#sumcollection">4.10.1. Calculating the <em>sum</em> of a collection</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#mathcollection">4.10.2. Using the <em>math</em> step with collections</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#sackintro">4.11. Introducing <em>sack</em> as a way to store values</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#sackbasics">4.11.1. Basic <em>sack</em> operations</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#sackminmax">4.11.2. Using <em>min</em> and <em>max</em> with a <em>sack</em></a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#sackcalc">4.11.3. Doing calculations using a <em>sack</em></a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#nonsackcalc">4.11.4. Doing calculations without using a <em>sack</em></a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#sackpathlength">4.11.5. Computing hop counts using a <em>sack</em></a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#sackbooleans">4.11.6. Using boolean operators with a <em>sack</em></a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#sackaddall">4.11.7. Using <em>addAll</em> and lists with a <em>sack</em></a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#sackpredicate">4.11.8. Comparing properties and constants to the value of a sack</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#lambdas">4.12. Using Lambda functions</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#mapstep">4.12.1. Introducing the <em>Map</em> step</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#lambdasack">4.12.2. Using lambdas with <em>sack</em> steps</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#flatmap">4.12.3. Introducing the <em>flatMap</em> step</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#fuzzyregs">4.12.4. Using regular expressions to do fuzzy searches</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#pred">4.13. Creating custom tests (predicates)</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_creating_a_regular_expression_predicate">4.13.1. Creating a regular expression predicate</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#vmunroll">4.14. Unrolling the lists returned by <em>valueMap</em></a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#graphvars">4.15. Using graph variables to associate metadata with a graph</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#tre">4.16. Turning graphs into trees</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#subgraph">4.17. Creating a sub graph</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#graphmlandjsonintro">4.18. Working with GraphML and GraphSON</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#sav">4.18.1. Saving (serializing) a graph as GraphML (XML) or GraphSON (JSON)</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#reload">4.18.2. Loading a graph stored as GraphML (XML) or GraphSON (JSON)</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#graphsonmapper">4.18.3. Turning the results of a query into JSON</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#performance">4.19. Analyzing the performance of your queries</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#clock">4.19.1. Timing a query - introducing <em>clock</em> and <em>clockWithResult</em></a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#profile">4.19.2. Analyzing where time is spent - introducing <em>profile</em></a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#tinkerindex">4.19.3. Introducing TinkerGraph indexes</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#olapoltp">4.20. OLTP vs OLAP</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#graphcomputer">4.20.1. Introducing the TinkerPop Graph Computer</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#pagerank">4.20.2. Experiments with Page Rank</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#msc">5. MISCELLANEOUS QUERIES AND THEIR RESULTS</a>
<ul class="sectlevel2">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#countmore">5.1. Counting more things</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#noairports">5.1.1. Which countries have no airports?</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#noroutes">5.1.2. Which airports have no routes?</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#runwaydist">5.1.3. What is the distribution of runways?</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#mostroutes">5.1.4. Airports with the most routes</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#oneroute">5.1.5. Airports with just one route</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#onerunway">5.1.6. Single runway airports with the most routes</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#runwaycountproject">5.1.7. Another way of counting runways</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#canadamost">5.1.8. Airports with the most routes in Canada</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#ukdist">5.1.9. Distribution of UK airports</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#countrydist">5.1.10. Distribution of airports by country</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#continentdist">5.1.11. Distribution of airports by continent</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_distribution_of_routes_per_airport">5.1.12. Distribution of routes per airport</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#groupvar">5.1.13. Using groupCount with a traversal variable</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#gcconstant">5.1.14. Combining <em>groupCount</em> and <em>constant</em></a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#chainchoose">5.1.15. Combining <em>choose</em> and <em>groupCount</em></a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#nestedgroup">5.1.16. Nesting one <em>group</em> step inside another</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#eu-usa">5.1.17. Analysis of routes between Europe and the USA</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#mapreduce">5.1.18. Using <em>fold</em> to do simple Map-Reduce computations</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#meanmode">5.1.19. Distribution of routes in the graph (mode and mean)</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_how_many_routes_are_there_from_airports_in_london_uk">5.1.20. How many routes are there from airports in London (UK)?</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#englandroutes">5.1.21. How many routes are there between airports in England?</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#topten">5.1.22. What are the top ten airports by route count?</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#localfold">5.1.23. Using <em>local</em> while counting things</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#noedges">5.1.24. How many vertices have no edges?</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#wherefly">5.2. Where can I fly to from here?</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#doesanyrouteexist">5.2.1. Does any route exist between two airports?</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#uscatoindia">5.2.2. Where in the USA or Canada can I fly to from any airport in India?</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#flleurope">5.2.3. Which cities in Europe can I fly to from Ft. Lauderdale in Florida?</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#clteusa">5.2.4. Where can I fly to from Charlotte, to cities in Europe or South America?</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#usalon">5.2.5. Where in the United States can I fly from to airports in London?</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#txny">5.2.6. Where in New York state can I fly to from any of the airports in Texas?</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#denmex">5.2.7. Which cities in Mexico can I fly to from Denver?</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#deleu">5.2.8. Which cities in Europe can I fly to from Delhi in India?</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#aggrroutes">5.2.9. Finding all routes between London, Munich and Paris</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#moredist">5.3. More analysis of distances between airports</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#gt8k">5.3.1. Finding routes longer than 8,000 miles</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_finding_the_20_longest_routes_in_the_graph">5.3.2. Finding the 20 longest routes in the graph</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#longesteach">5.3.3. Finding the longest route from each airport</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#aggrunion">5.3.4. Combining <em>aggregate</em>, <em>union</em> and <em>filter</em> to compute distances</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_more_queries_that_analyze_distances">5.3.5. More queries that analyze distances</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#AUSLHR-OS">5.3.6. How far is it from AUS to LHR with one stop?</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#sackauslhr">5.3.7. Using <em>sack</em> to calculate the shortest AUS-LHR route with one stop</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#anothersack">5.3.8. Another example of how <em>sack</em> can be used</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#latlonmanual">5.4. Using latitude, longitude and geographical region in queries</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#GreatCircle">5.4.1. Using the <em>math</em> step to calculate Great Circle distances</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#via">5.5. Finding routes that go via a specific airport</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#storesideeffect">5.6. Using <em>store</em> and a <em>sideEffect</em> to make a set of unique values</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#dfwcopy">5.7. Making a copy of the DFW vertex</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#btree">5.8. Modelling an ordered binary tree as a graph</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#mapstr">5.9. Using <em>map</em> to produce a concatenated result string</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#randwalk">5.10. Randomly walking a graph</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#sevendegrees">5.11. Seven degrees of separation!</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#mininetworks">5.11.1. Finding isolated sub-networks</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#longestroutes">5.12. Looking for the journey requiring the most stops</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#quicklyfindhardest">5.12.1. Quickly finding the hardest to get to airports</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#unwantededges">5.13. Finding unwanted parallel edges</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#groupcountpath">5.13.1. Using <em>groupCount</em> with <em>path</em> to find duplicate edges</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#flr">5.14. Finding the longest flight route between two adjacent airports in the graph</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#miscq">5.15. Miscellaneous other queries</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_using_a_calculation_inside_of_an_is_step">5.15.1. Using a calculation inside of an <em>is</em> step</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#beyond">6. MOVING BEYOND THE CONSOLE AND TINKERGRAPH</a>
<ul class="sectlevel2">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#javatinker">6.1. Working with TinkerGraph from a Java Application</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#tpinterfaces">6.1.1. The Apache TinkerPop interfaces and classes</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#javatp1">6.1.2. Writing our first TinkerPop Java program</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#javacompile">6.1.3. Compiling our code</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#javaadd">6.1.4. Adding to our Java program</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#javastatics">6.1.5. Important Classes and Enums to be aware of</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#javapredicates">6.1.6. Using Gremlin predicates in a Java application</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#javacheck">6.1.7. Checking to see if a query returned a result</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#javacreate">6.1.8. Creating a new graph from a Java application</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#javasave">6.1.9. Saving a graph from a Java application</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#groovyapp">6.2. Working with TinkerGraph from a Groovy application</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#groovyc">6.2.1. Compiling our Groovy application</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_running_our_groovy_application">6.2.2. Running our Groovy application</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_adding_to_our_groovy_application">6.2.3. Adding to our Groovy application</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#groovypredicates">6.2.4. Using Gremlin predicates in a Groovy application</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#janusintro">6.3. Introducing JanusGraph</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#janusinstall">6.3.1. Installing JanusGraph</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#janusconsole">6.3.2. Using JanusGraph from the Gremlin Console</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#janusinmemory">6.3.3. Using JanusGraph with the <em>inmemory</em> option</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#janustrans">6.3.4. JanusGraph transactions</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#janusmgmt">6.3.5. The JanusGraph management API</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#cardlist">6.3.6. Creating a property with cardinality LIST</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#cardset">6.3.7. Creating a property with cardinality SET</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#janusschema">6.4. Defining a JanusGraph schema for the air-routes graph</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_defining_edge_labels_and_usage">6.4.1. Defining edge labels and usage</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_defining_vertex_labels">6.4.2. Defining vertex labels</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_defining_vertex_property_keys">6.4.3. Defining vertex property keys</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_defining_edge_property_keys">6.4.4. Defining edge property keys</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#janusload">6.4.5. Loading air-routes into a JanusGraph instance</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#jaindexintro">6.5. JanusGraph indexes</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#graphindexes">6.5.1. Graph indexes</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#vciintro">6.5.2. Vertex centric indexes</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#compositeintro">6.5.3. Introducing <em>composite</em> indexes</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#mixedintro">6.5.4. Introducing <em>mixed</em> indexes</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#compositeindex">6.5.5. Building a composite index to speed up exact match searching</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_a_script_to_automate_schema_creation_indexing_and_graph_loading">6.5.6. A script to automate schema creation, indexing and graph loading</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#janpred">6.6. Additional JanusGraph text search predicates</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_text_comparison_predicates">6.6.1. Text comparison predicates</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_regular_expression_predicates">6.6.2. Regular expression predicates</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_fuzzy_search_predicates">6.6.3. Fuzzy search predicates</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#janusgeo">6.7. The JanusGraph GeoSpatial API</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#janusstorage">6.8. Choosing a persistent storage technology for JanusGraph</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#berkleyintro">6.8.1. Oracle Berkley DB</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#cassandraintro">6.8.2. Apache Cassandra</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#scyllaintro">6.8.3. ScyllaDB</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#hbaseintro">6.8.4. Apache HBase</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_google_bigtable">6.8.5. Google Bigtable</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_ibm_compose_for_janusgraph">6.8.6. IBM Compose for JanusGraph</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_other_tinkerpop_compatible_products_and_services">6.8.7. Other TinkerPop compatible products and services</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#dockercass">6.9. Using Docker to experiment with Cassandra and JanusGraph</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#cassstart">6.9.1. Starting the Cassandra container</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#cassconnect">6.9.2. Connecting JanusGraph to Cassandra</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#nodetool">6.9.3. Finding nodetool</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#extindex">6.10. Using an external index with JanusGraph</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#gremlinserver">7. INTRODUCING GREMLIN SERVER</a>
<ul class="sectlevel2">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#serverconfig">7.1. Configuring Gremlin Server</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#serverconsole">7.2. Connecting to a Gremlin Server from the Gremlin Console</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#remoteconn">7.2.1. Making the remote connection</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#resultvar">7.2.2. The Gremlin Console’s <em>result</em> variable</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#remotemode">7.2.3. Working in remote mode</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#servercli">7.3. Connecting to a Gremlin Server from the command line</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#javagsclient">7.4. Connecting to a Gremlin Server from Java using <em>withRemote</em></a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#rubyclient">7.5. Connecting to a Gremlin Server from Ruby</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#servertinkergraph">7.6. Configuring a Gremlin Server to use a TinkerGraph</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#TGConfig">7.6.1. Creating the configuration files</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#TGStart">7.6.2. Starting the Server</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#TGTest">7.6.3. Testing the Server</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#servertweaks">7.7. Tweaking queries to make the JSON returned easier to work with</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#serverjson">7.8. More examples of the JSON returned from a Gremlin Server</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_no_result">7.8.1. No result</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_integer_result">7.8.2. Integer result</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_string_result">7.8.3. String result</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_list_of_strings">7.8.4. List of strings</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_list_of_integers">7.8.5. List of integers</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_list_of_mixed_types">7.8.6. List of mixed types</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_value_map">7.8.7. Value map</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_single_vertex">7.8.8. Single vertex</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_selected_vertex_information">7.8.9. Selected vertex information</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_single_edge">7.8.10. Single edge</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_new_vertex">7.8.11. New vertex</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_new_vertex_only_returning_the_id">7.8.12. New vertex only returning the ID</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_path_by_value_list_of_strings">7.8.13. Path by value (list of strings)</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_path_by_values_list_of_strings_and_integers">7.8.14. Path by values (list of strings and integers)</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_two_vertex_path">7.8.15. Two vertex path</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_path_with_two_vertices_and_an_edge">7.8.16. Path with two vertices and an edge</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_selection_map">7.8.17. Selection map</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_projected_map">7.8.18. Projected map</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_strings_and_a_map">7.8.19. Strings and a map</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_nested_lists">7.8.20. Nested lists</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#serialize">8. COMMON GRAPH SERIALIZATION FORMATS</a>
<ul class="sectlevel2">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#csv">8.1. Comma Separated Values (CSV)</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#csvair">8.1.1. Using two CSV files to represent the air-routes data</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_adjacency_matrix_format">8.1.2. Adjacency matrix format</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_adjacency_list_format">8.1.3. Adjacency List format</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_edge_list_format">8.1.4. Edge List format</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_graphml">8.2. GraphML</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_graphson">8.3. GraphSON</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_adjacency_list_format_graphson">8.3.1. Adjacency list format GraphSON</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#_wrapped_adjacency_list_format_graphson">8.3.2. Wrapped adjacency list format GraphSON</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#fr">9. FURTHER READING</a>
<ul class="sectlevel2">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#tplinks">9.1. Additional Apache TinkerPop community links</a>
<ul class="sectlevel3">
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#tutorials">9.1.1. Tutorials</a></li>
</ul>
</li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#gremlindiscussionlists">9.2. Gremlin related mailing lists and discussion groups</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#janusgraphlinks">9.3. JanusGraph links</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction">1. INTRODUCTION</h2>
<div class="sectionbody">
<div class="paragraph">
<div class="title">This book is a work in progress. Feedback is very much encouraged and welcomed!</div>
<p>The title of this book could equally well be <em>"A getting started guide for users of
graph databases and the Gremlin query language featuring hints, tips and sample
queries"</em>. It turns out that is a bit too long to fit on one line for a heading
but in a single sentence that describes the focus of this work pretty well.</p>
</div>
<div class="paragraph">
<p>I have resisted the urge to try and cover every single feature of TinkerPop one after
the other in a reference manual fashion. Instead, what I have tried to do is capture
the learning process that I myself have gone through using what I hope is a sensible
flow from getting started to more advanced topics. To get the most from this book I
recommend having the Gremlin console open with my sample data loaded as you follow
along. I have not assumed that anyone reading this has any prior knowledge of Apache
TinkerPop, the Gremlin query language or related tools. I will introduce everything
you need to get started in Chapter 2.</p>
</div>
<div class="paragraph">
<p>I hope people find what follows useful. It definitely remains a work in progress and
more will be added in the coming weeks and months as time permits. I am hopeful that
what is presented so far is of some use to anyone, who like me, is learning to use
the Gremlin query and traversal language and related technologies.</p>
</div>
<div class="paragraph">
<p>A lot of additional material, including the book in many different formats such as
PDF, HTML, ePub and MOBI as well as sample code and data, can be found at the
<a href="https://github.com/krlawrence/graph">project’s home on GitHub</a>. You will find a
summary of everything that is available in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#samplesintro">Introducing the book sources, sample programs and data</a>" section.</p>
</div>
<div class="sect2">
<h3 id="_how_this_book_came_to_be">1.1. How this book came to be</h3>
<div class="paragraph">
<p>I forget exactly when, but sometime early in 2016 I started compiling a list of
notes, hints and tips, initially for my own benefit. My notes were full of things I
had found poorly explained elsewhere while using graph databases and especially while
using Apache TinkerPop, Gremlin and JanusGraph. Over time that document continued to
grow and had effectively become a book in all but name. After some encouragement from
colleagues I decided to release my notes as a <em>living book</em> in an open source venue
so that anyone who is interested can read it. It is definitely aimed at programmers
and data scientists but I hope is also consumable by anyone using the Gremlin graph
query and traversal language to work with graph databases.</p>
</div>
<div class="paragraph">
<p>I have included a large number of code examples and sample queries along with
discussions of best practices and more than a few lessons I learned the hard way,
that I hope you will find informative. I call it a <em>living book</em> as my goal is to
regularly make updates as I discover things that need adding while also trying to
keep the content as up to date as possible as Apache TinkerPop itself evolves.</p>
</div>
<div class="paragraph">
<p>I would like to say very heartfelt <strong>Thank You</strong> to all those that have encouraged me
to keep going with this adventure! It has required quite a lot of work but also
remains a lot of fun.</p>
</div>
<div class="paragraph">
<p>Kelvin R. Lawrence<br>
First draft: October 5th, 2017<br>
Current draft: May 4th 2022<br></p>
</div>
</div>
<div class="sect2">
<h3 id="_providing_feedback">1.2. Providing feedback</h3>
<div class="paragraph">
<p>Please let me know about any mistakes you find in this material and also please feel
free to send me feedback of any sort. Suggested improvements are especially welcome.
A good way to provide feedback is by opening an issue in the GitHub repository
located at <a href="https://github.com/krlawrence/graph" class="bare">https://github.com/krlawrence/graph</a>. You are currently reading revision
283-preview of the book.</p>
</div>
<div class="paragraph">
<p>I am grateful to those who have already taken the time to review the manuscript and
open issues or submit pull requests.</p>
</div>
</div>
<div class="sect2">
<h3 id="thanks">1.3. Some words of thanks</h3>
<div class="paragraph">
<p>I would like to thank my former colleagues, Graham Wallis, Jason Plurad and Adam
Holley for their help in refining and improving several of the queries contained in
this book. Gremlin is definitely a bit of a team sport. We spent many fun hours
discussing the best way to handle different types of queries and traversals!</p>
</div>
<div class="paragraph">
<p>I would also be remiss if I did not give a big shout out to all of the folks that
spend a lot of time replying to questions and suggestions on the
<a href="https://groups.google.com/forum/#!forum/gremlin-users">Gremlin Users Google Group</a>.
Special thanks should go to Daniel Kuppitz, Marko Rodriguez and Stephen Mallette, key
members of the team that created and maintains Apache TinkerPop.</p>
</div>
<div class="paragraph">
<p>Lastly, I would like to thank everyone who has submitted feedback and ideas via
e-mail as well as GitHub issues and pull requests. That is the best part about this
being a <em>living book</em> we can continue to improve and evolve it just as the technology
it is about continues to evolve. Your help and support is very much appreciated.</p>
</div>
</div>
<div class="sect2">
<h3 id="about">1.4. What is this book about?</h3>
<div class="paragraph">
<p>This book introduces the Apache TinkerPop 3 <em>Gremlin</em> graph query and traversal
language via real examples featuring real-world graph data. That data along with
sample code and example applications is available for download from the GitHub
project as well as many other items. The graph, <em>air-routes</em>, is a model of
the world airline route network between 3,373 airports including 43,400 routes. The
examples presented will work unmodified with the <code>air-routes.graphml</code> file loaded into
the Gremlin console running with a TinkerGraph. How to set that environment up is
covered in the <a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#gremlininstall">Downloading, installing and launching the console</a> section below.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The examples in this book have been tested using Apache TinkerPop release
3.5.2. However, work remains to be done to add coverage of new features in
that release to the book.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>TinkerGraph is an <em>in-memory</em> graph, meaning nothing gets saved to disk
automatically. It is shipped as part of the Apache TinkerPop 3 download. The
goal of this tutorial is to allow someone with little to no prior knowledge to
get up and going quickly using the Gremlin console and the <em>air-routes</em> graph.
Later in the book I will discuss using additional technologies such as
JanusGraph, Apache Cassandra, Gremlin Server and Elasticsearch to build
scalable and persisted graph stores that can still be traversed using Gremlin
queries. I will also discuss writing standalone Java and Groovy applications
as well as using the Gremlin Console. I even slipped a couple of Ruby examples in
too!</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In the first few sections of this book I have mainly focussed on
showing the different types of queries that you can issue using Gremlin. I have not
tried to show all of the output that you will get back from entering these queries
but have selectively shown examples of output. I go a lot deeper into things in
chapters 4, 5 and 6.
</td>
</tr>
</tbody></table>
</div>
<div class="dlist">
<div class="title">How this book is organized</div>
<dl>
<dt class="hdlist1">Chapter 1 - INTRODUCTION</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>I start off by briefly doing a recap on why Graph databases are of interest to us
and discuss some good use cases for graphs. I also provide pointers to the sample
programs and other additional materials referenced by the book.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Chapter 2 - GETTING STARTED</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>In Chapter two I introduce several of the components of Apache TinkerPop and
also introduce the <code>air-routes.graphml</code> file that will be used as the graph the
majority of examples shown in this book are based on.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Chapter 3 - WRITING GREMLIN QUERIES</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>In Chapter three things start to get a lot more interesting! I start discussing
how to use the Gremlin graph traversal and
query language to interrogate the <em>air-routes</em> graph. I begin by comparing how we
could have built the <em>air-routes</em> graph using a more traditional relational database
and then look at how SQL and Gremlin are both similar in some ways and very
different in others. For the rest of the Chapter, I introduce several of
the key Gremlin methods, or as they are often called, <em>"steps"</em>. I
mostly focus on reading the graph (not adding or deleting things) in this Chapter.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Chapter 4 - BEYOND BASIC QUERIES</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>In Chapter four the focus moves beyond just reading the graph and I describe how to add
vertices (nodes), edges and properties as well as how to delete and update them.
I also present a discussion of various best practices. I also start to explore
some slightly more advanced topics in this chapter.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Chapter 5 - MISCELLANEOUS QUERIES AND THE RESULTS THEY GENERATE</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>In Chapter five I focus on using what has been covered in the prior Chapters to write
queries that have a more real-world feel. I present a lot more examples of the
output from running queries in this Chapter. I also start to discuss topics such
as analyzing distances, route distribution and writing geospatial queries.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Chapter 6 - MOVING BEYOND THE CONSOLE AND TINKERGRAPH</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>In Chapter six I start to expand the focus to concepts beyond using the Gremlin
Console and a TinkerGraph. I
start by looking at how you can write standalone Java and Groovy applications that
can work with a graph. I then introduce JanusGraph and take a fairly detailed
look at its capabilities such as support for transactions, schemas and indexes.
Various technology choices for back end persistent stores
and indexes are explored along the way.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Chapter 7 - INTRODUCING GREMLIN SERVER</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>In Chapter seven, Gremlin Server is introduced. I begin to explore connecting to
and working with a remote graph both from the Gremlin Console and the command line
as well as from code. When this book was first released, the majority of "real
world" use cases
focussed on directly attached or even in memory graphs. As Apache TinkerPop has
evolved, it has become a lot more common to connect to a graph remotely via a
Gremlin Server.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Chapter 8 - COMMON GRAPH SERIALIZATION FORMATS</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>In Chapter eight a discussion is presented of some common Graph serialization file
formats along with coverage of how to use them in the context of TinkerPop 3
enabled graphs.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Chapter 9 - FURTHER READING</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>I finish up by providing several links to useful web sites where you can find
tools and documentation for many of the topics and technologies covered in this book.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="samplesintro">1.5. Introducing the book sources, sample programs and data</h3>
<div class="paragraph">
<p>All work related to this project is being done in the open at GitHub. A list of where
to find the key components is provided below. The examples in this book make use of a
sample graph called <em>air-routes</em> which contains a graph based on the world airline
route network between over 3,370 airports. The sample graph data, quite a bit of
sample code and some larger demo applications can all be found at the same GitHub
location that hosts the book manuscript. You will also find releases of the the book
in various formats (HTML, PDF, DocBook/XML, MOBI and EPUB) at the same GitHub
location. The sample programs include standalone Java, Groovy, Python and Ruby
examples as well as many examples that can be run from the Gremlin Console. There
are some differences between using Gremlin from a standalone program and from the
Gremlin Console. The sample programs demonstrate several of these differences. The
sample applications area contains a full example HTML and JavaScript application that
lets you explore the <em>air-routes</em> graph visually. The home page for the GitHub
project includes a README.md file to help you navigate the site. Below are some links
to various resources included with this book.</p>
</div>
<div class="dlist">
<div class="title">Where to find the book, samples and data</div>
<dl>
<dt class="hdlist1">Project home</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/krlawrence/graph" class="bare">https://github.com/krlawrence/graph</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Book manuscript in Asciidoc format</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>This file can be viewed using the GitHub web interface. It will always represent
the very latest updates.</p>
</li>
<li>
<p><a href="https://github.com/krlawrence/graph/tree/master/book" class="bare">https://github.com/krlawrence/graph/tree/master/book</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Latest PDF and HTML snapshots</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>These files are regularly updated to reflect any significant changes. These are the
only generated formats that are updated outside of the full release cycle. The PDF
version includes pagination as well as page numbering and is produced using an A4
page size. The HTML version does not include these features. Otherwise they are
more or less identical.</p>
</li>
<li>
<p><a href="http://kelvinlawrence.net/book/PracticalGremlin.pdf" class="bare">http://kelvinlawrence.net/book/PracticalGremlin.pdf</a></p>
</li>
<li>
<p><a href="http://kelvinlawrence.net/book/PracticalGremlin.html" class="bare">http://kelvinlawrence.net/book/PracticalGremlin.html</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Official book releases in multiple formats</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Official releases include Asciidoc, HTML, PDF, ePub, MOBI and DocBook versions as
well as snapshots of all the samples and other materials in a single package. My
goal is to have an official release about once a month providing enough new
material has been created to justify doing it. The eBook and MOBI versions are
really intended to be read using e-reader devices and for that reason use a white
background for all source code highlighting to make it easier to read on monochrome
devices.</p>
</li>
<li>
<p>I recommend using the PDF version if possible as it has page numbering. If
you prefer reading the book as if it were web page then by all means use the HTML
version. You will just not get any pagination or page numbers. The DocBook format
can be read using tools such as Yelp on Linux systems but is primarily included
so that people can use it to generate other formats that I do not already provide.
There is currently an issue with the MOBI and ePub versions that causes links to
have the wrong text. Other than that they should work although you may need to
change the font size you use on your device to make things easier to read.</p>
</li>
<li>
<p><a href="https://github.com/krlawrence/graph/releases" class="bare">https://github.com/krlawrence/graph/releases</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Sample data (<code>air-routes.graphml</code>)</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/krlawrence/graph/tree/master/sample-data" class="bare">https://github.com/krlawrence/graph/tree/master/sample-data</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Sample code</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/krlawrence/graph/tree/master/sample-code" class="bare">https://github.com/krlawrence/graph/tree/master/sample-code</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example applications</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/krlawrence/graph/tree/master/demos" class="bare">https://github.com/krlawrence/graph/tree/master/demos</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Change history</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>If you want to keep up with the changes being made this is the file to keep an eye
on.</p>
</li>
<li>
<p><a href="https://github.com/krlawrence/graph/blob/master/ChangeHistory.md" class="bare">https://github.com/krlawrence/graph/blob/master/ChangeHistory.md</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="tp34intro">1.6. A word about TinkerPop 3.4</h3>
<div class="paragraph">
<p>A major update to Apache TinkerPop, version 3.4.0, was released in January 2019 and a
number of point releases followed. The examples in this book have been tested with
all releases of the 3.4.x line. New examples have also been added as necessitated by
those updates.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The change history contains details of everything that has been added over time
and can be found at this location:
<a href="https://github.com/krlawrence/graph/blob/master/ChangeHistory.md" class="bare">https://github.com/krlawrence/graph/blob/master/ChangeHistory.md</a>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Graph database engines that support Apache TinkerPop often take a while to move up to
new releases and it’s always a good idea to verify the exact level the database you are
using supports.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Full details of all the new features added in the TinkerPop 3.4.x releases can be
found at the following link:
<a href="https://github.com/apache/tinkerpop/blob/master/CHANGELOG.asciidoc" class="bare">https://github.com/apache/tinkerpop/blob/master/CHANGELOG.asciidoc</a>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>As well as updating the book, I continue incrementally adding coverage of these
features to the <code>sample-code</code> folder. Samples currently added include
<code>nested-repeat.groovy</code> that demonstrates the use of the new nested repeat step
capability. It can be loaded and run from the Gremlin console.</p>
</div>
</div>
<div class="sect2">
<h3 id="tp35intro">1.7. Introducing TinkerPop 3.5</h3>
<div class="paragraph">
<p>Apache TinkerPop 3.5.0 was released in May 2021. This update introduced a number of
improvements in areas such as Gremlin client drivers, the Gremlin Server and overall
bug fixes. The release also improved the Gremlin query language in some key areas.
Some features that had been declared deprecated in earlier releases were finally
removed as part of the 3.5.0 update. If you have queries and code that still use
these deprecated features, as part of an upgrade to the 3.5.x level, you will need to
make the appropriate changes.</p>
</div>
<div class="paragraph">
<p>The main breaking change to be aware of is that <em>Order.incr</em> and <em>Order.decr</em> were
removed from the Gremlin language. The newer <em>Order.asc</em> and <em>Order.desc</em> must be
used instead. The examples in this book and those in the <code>sample-code</code> folder have
been updated to reflect these changes.</p>
</div>
<div class="paragraph">
<p>In January 2022, the TinkerPop 3.5.2 release added a native <code>datetime</code> operator to
the Gremlin language such that dates can be added without needing programming
language specific constructs. This is useful when sending Gremlin queries as text
strings.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Full details of all the new features added in the TinkerPop 3.5.x releases can be
found at the following link:
<a href="https://github.com/apache/tinkerpop/blob/master/CHANGELOG.asciidoc" class="bare">https://github.com/apache/tinkerpop/blob/master/CHANGELOG.asciidoc</a>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="tp36intro">1.8. Introducing TinkerPop 3.6</h3>
<div class="paragraph">
<p>Apache TinkerPop 3.6.0 was released in April 2022. Coming almost exactly a year after
the initial 3.5.0 release, this is one of the most significant TinkerPop releases
since TinkerPop 3.4.0 appeared in January 2019. The release contains many
improvements, including several new Gremlin steps, designed to make commonly
performed tasks much easier. Notable improvements include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>New <em>mergeV</em> and <em>mergeE</em> steps that make "create if not exist"
type queries, sometimes referred to as "upserts", much easier to write. Over time,
these steps will replace use of the <em>fold…​coalesce</em> pattern, and will also
replace the various "map injection" patterns that can be used to create multiple
vertices and edges in a single query.</p>
</li>
<li>
<p>A new <em>TextP.regex</em> predicate that allows regular expressions to be
used when comparing strings.</p>
</li>
<li>
<p>The <em>property</em> step can now be given a map of key/value pairs so that several
properties can be created at once.</p>
</li>
<li>
<p>A new <em>element</em> step that can be used to find the parent element (vertex or edge)
of a property.</p>
</li>
<li>
<p>A new <em>call</em> step that lays the foundation enabling Gremlin queries to call other
endpoints. This opens up many types of interesting use cases such as query
federation, and looking up values from other services.</p>
</li>
<li>
<p>A lot of effort has been put into removing unnecessary exceptions by filtering out
parts of traversals instead of failing with an error. This is especially so in the
case of <em>by</em> modulators that now filter when a value does not exist rather than
throw an exception. This work began as part of the TinkerPop 3.5.2 update and is
completed as of TinkerPop 3.6.0.</p>
</li>
<li>
<p>A new <em>fail</em> step that can be used to abort a query in a controlled way.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Over time, new sections will be added to this book that cover each of these features
in detail.</p>
</div>
<div class="paragraph">
<p>As always, check the level of ApacheTinkerPop the graph database you are using
supports before trying to use these new features.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Full details of all the new features added in the TinkerPop 3.6.x releases can be
found at the following link:
<a href="https://github.com/apache/tinkerpop/blob/master/CHANGELOG.asciidoc" class="bare">https://github.com/apache/tinkerpop/blob/master/CHANGELOG.asciidoc</a>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="whygraph">1.9. So what is a graph database and why should I care?</h3>
<div class="paragraph">
<p>This book is mainly intended to be a tutorial in working with graph databases and
related technology using the Gremlin query language. However, it is worth spending
just a few moments to summarize why it is important to understand what a graph
database is, what some good use cases for graphs are and why you should care in a
world that is already full of all kinds of SQL and NoSQL databases. In this book we
are going to be discussing <em>directed property graphs</em>. At the conceptual level these
types of graphs are quite simple to understand. You have three basic building blocks.
Vertices (often referred to as nodes), edges and properties. Vertices represent
"things" such as people or places. Edges represent connections between those
vertices, and properties are information added to the vertices and edges as needed.
The <em>directed</em> part of the name means that any edge has a direction. It goes <em>out</em>
from one vertex and <em>in</em> to another. You will sometimes hear people use the word
<em>digraph</em> as shorthand for <em>directed graph</em>. Consider the relationship "Kelvin knows
Jack". This could be modeled as a vertex for each of the people and an edge for the
relationship as follows.</p>
</div>
<div class="paragraph text-center">
<p>Kelvin — knows → Jack</p>
</div>
<div class="paragraph">
<p>Note the arrow which implies the direction of the relationship. If we wanted to
record the fact that Jack also admits to knowing Kelvin we would need to add a
second edge from Jack to Kelvin. Properties could be added to each person to give
more information about them. For example, my age might be a property on my vertex.</p>
</div>
<div class="paragraph">
<p>It turns out that Jack really likes cats. We might want to store that in our graph as
well so we could create the relationship:</p>
</div>
<div class="paragraph text-center">
<p>Jack — likes → Cats</p>
</div>
<div class="paragraph">
<p>Now that we have a bit more in our graph we could answer the question "who does
Kelvin know that likes cats?"</p>
</div>
<div class="paragraph text-center">
<p>Kelvin — knows → Jack — likes → Cats</p>
</div>
<div class="paragraph">
<p>This is a simple example but hopefully you can already see that we are modelling our
data the way we think about it in the real world. Armed with this knowledge you now
have all of the basic building blocks you need in order to start thinking about how
you might model things you are familiar with as a graph.</p>
</div>
<div class="paragraph">
<p>So getting back to the question "why should I care?", well, if something looks like a
graph, then wouldn’t it be great if we could model it that way. Many things in our
everyday lives center around things that can very nicely be represented in a graph.
Things such as your social and business networks, the route you take to get to work,
the phone network, airline route choices for trips you need to take are all great
candidates. There are also many great business applications for graph databases and
algorithms. These include recommendation systems, crime prevention and fraud
detection to name but three.</p>
</div>
<div class="paragraph">
<p>The reverse is also true. If something does not feel like a graph then don’t try to
force it to be. Your videos are probably doing quite nicely living in the object
store where you currently have them. A sales ledger system built using a relational
database is probably doing just fine where it is and likewise a document store is
quite possibly just the right place to be storing your documents. So "use the right
tool for the job" remains as valid a phrase here as elsewhere. Where graph databases
come into their own is when the data you are storing is intrinsically linked by its
very nature, the air routes network used as the basis for all of the examples in
this book being a perfect example of such a situation.</p>
</div>
<div class="paragraph">
<p>Those of you that looked at graphs as part of a computer science course are correct
if your reaction was "Surely graphs have been around for ages, why is this considered
new?". Indeed, Leonard Euler is credited with demonstrating the first graph problem
and inventing the whole concept of "Graph Theory" all the way back in 1763 when he
investigated the now famous "Seven Bridges of Koenigsberg" problem.</p>
</div>
<div class="paragraph">
<p>If you want to read a bit more about graph theory and its present-day application,
you can find a lot of good information online. Here’s a Wikipedia link to get you
started: <a href="https://en.wikipedia.org/wiki/Graph_theory" class="bare">https://en.wikipedia.org/wiki/Graph_theory</a></p>
</div>
<div class="paragraph">
<p>So, given Graph Theory is anything but a new idea, why is it that only recently we
are seeing a massive growth in the building and deployment of graph database systems
and applications? At least part of the answer is that computer hardware and software
has reached the point where you can build large big data systems that scale well for
a reasonable price. In fact, it’s even easier than ever to build the large systems
because you don’t have to buy the hardware that your system will run on when you use
the cloud.</p>
</div>
<div class="paragraph">
<p>While you can certainly run a graph database on your laptop—​I do just that every
day—​the reality is that in production, at scale, they are big data systems. Large
graphs commonly have many billions of vertices and edges in them, taking up petabytes
of data on disk. Graph algorithms can be both compute- and memory-intensive, and it
is only fairly recently that deploying the necessary resources for such big data
systems has made financial sense for more everyday uses in business, and not just in
government or academia. Graph databases are becoming much more broadly adopted across
the spectrum, from high-end scientific research to financial networks and beyond.</p>
</div>
<div class="paragraph">
<p>Another factor that has really helped start this graph database revolution is the
availability of high-quality open source technology. There are a lot of great open
source projects addressing everything from the databases you need to store the graph
data, to the query languages used to traverse them, all the way up to visually
displaying graphs as part of the user interface layer. In particular, it is so-called
<em>property graphs</em> where we are seeing the broadest development and uptake. In a
property graph, both vertices and edges can have properties (effectively, key-value
pairs) associated with them. There are many styles of graph that you may end up
building and there have been whole books written on these various design patterns,
but the property graph technology we will focus on in this book can support
all of the most common usage patterns. If you hear phrases such as <em>directed graph</em>
and <em>undirected graph</em>, or <em>cyclic</em> and <em>acyclic</em> graph, and many more as you work
with graph databases, a quick online search will get you to a place where you can get
familiar with that terminology. A deep discussion of these patterns is beyond the
scope of this book, and it’s in no way essential to have a full background in
graph theory to get productive quickly.</p>
</div>
<div class="paragraph">
<p>A third, and equally important, factor in the growth we are seeing in graph database
adoption is the low barrier of entry for programmers. As you will see from the
examples in this book, someone wanting to experiment with graph technology can
download the Apache TinkerPop package and as long as Java 8 is installed, be up and
running with zero configuration (other than doing an unzip of the files), in as
little as five minutes. Graph databases do not force you to define schemas or
specify the layout of tables and columns before you can get going and start building
a graph. Programmers also seem to find the graph style of programming quite
intuitive as it closely models the way they think of the world.</p>
</div>
<div class="paragraph">
<p>Graph database technology should not be viewed as a "rip and replace" technology, but
as very much complementary to other databases that you may already have deployed. One
common use case is for the graph to be used as a form of smart index into other data
stores. This is sometimes called having a polyglot data architecture.</p>
</div>
</div>
<div class="sect2">
<h3 id="nodevert">1.10. A word about terminology</h3>
<div class="paragraph">
<p>The words <em>node</em> and <em>vertex</em> are synonymous when discussing a graph. Throughout this
book you may find both words used. However, as the Apache TinkerPop documentation
almost exclusively uses the word <em>vertex</em>, as much as possible when discussing
Gremlin queries and other concepts, I endeavor to stick to the word <em>vertex</em> or the
plural form <em>vertices</em>. As this book has evolved, I realized my use of these terms had
become inconsistent and as I continue to make updates, I plan, with a few exceptions,
such as when discussing binary trees, to standardize on <em>vertex</em> rather than <em>node</em>.
In that way, this book will be consistent with the official TinkerPop documentation.
Similarly, when discussing the connections between vertices I use the term <em>edge</em> or
the plural form, <em>edges</em>. In other books and articles you may also see terms like
<em>relationship</em> or <em>arc</em> used.  Again these terms are synonymous in the context of
graphs.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="gs">2. GETTING STARTED</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let’s take a look at what you will need to have installed and what tools you will
need available to make best use of the examples contained in this tutorial. The key
thing that you will need is the Apache TinkerPop project’s Gremlin Console download.
In the sections below I will walk you through a discussion of what you need to
download and how to set it up.</p>
</div>
<div class="sect2">
<h3 id="tpintro">2.1. What is Apache TinkerPop?</h3>
<div class="paragraph">
<p>Apache TinkerPop is a graph computing framework and top level project hosted by the
Apache Software Foundation. The homepage for the project is located at this URL:
<a href="http://tinkerpop.apache.org/" class="bare">http://tinkerpop.apache.org/</a></p>
</div>
<div class="dlist">
<div class="title">The project includes the following components:</div>
<dl>
<dt class="hdlist1">Gremlin</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A graph traversal (query) language</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Gremlin Console</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>An interactive shell for working with local or remote graphs.</p>
</li>
<li>
<p><a href="http://tinkerpop.apache.org/docs/current/reference/#gremlin-console" class="bare">http://tinkerpop.apache.org/docs/current/reference/#gremlin-console</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Gremlin Server</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Allows hosting of graphs remotely via an HTTP/Web Sockets connection.</p>
</li>
<li>
<p><a href="http://tinkerpop.apache.org/docs/current/reference/#gremlin-server" class="bare">http://tinkerpop.apache.org/docs/current/reference/#gremlin-server</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">TinkerGraph</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A small in-memory graph implementation that is great for learning.</p>
</li>
<li>
<p><a href="http://tinkerpop.apache.org/docs/current/reference/#tinkergraph-gremlin" class="bare">http://tinkerpop.apache.org/docs/current/reference/#tinkergraph-gremlin</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Programming Interfaces</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A set of programming interfaces written in Java</p>
</li>
<li>
<p><a href="http://tinkerpop.apache.org/javadocs/current/full/" class="bare">http://tinkerpop.apache.org/javadocs/current/full/</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Documentation</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A user guide, a tutorial and programming API documentation.</p>
</li>
<li>
<p><a href="http://tinkerpop.apache.org/docs/current/" class="bare">http://tinkerpop.apache.org/docs/current/</a></p>
</li>
<li>
<p><a href="http://tinkerpop.apache.org/docs/current/reference/" class="bare">http://tinkerpop.apache.org/docs/current/reference/</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Useful Recipes</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A set of examples or "recipes" showing how to perform common graph oriented tasks using Gremlin queries.</p>
</li>
<li>
<p><a href="http://tinkerpop.apache.org/docs/current/recipes/" class="bare">http://tinkerpop.apache.org/docs/current/recipes/</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The programming interfaces allow providers of graph databases to build systems that
are TinkerPop enabled and allow application programmers to write programs that talk
to those systems.</p>
</div>
<div class="paragraph">
<p>Any such TinkerPop enabled graph databases can be accessed using the Gremlin query
language and corresponding API. We can also use the TinkerPop API to write client
code in languages like Java that can talk to a TinkerPop enabled graph. For most of
this book we will be working within the Gremlin console with a local graph. However
in Chapter 6 we will take a look at Gremlin Server and some other TinkerPop 3 enabled
environments. Most of Apache Tinkerpop has been developed using Java 8 but there are
also bindings available for many other programming languages such as Groovy and
Python. Parts of TinkerPop are themselves developed in Groovy, most notably the
Gremlin Console. The nice thing about that is that we can use Groovy syntax along
with Gremlin when entering queries into the Console or sending them via REST API to a
Gremlin Server. All of these topics are covered in detail in this book.</p>
</div>
<div class="paragraph">
<p>The queries used as examples in this book have been tested with Apache TinkerPop
version 3.5.2 as well as many prior releases. Tests were performed using the
TinkerGraph in memory graph and the Gremlin console, as well as
other TinkerPop 3 enabled graph stores.</p>
</div>
</div>
<div class="sect2">
<h3 id="gconsole">2.2. The Gremlin console</h3>
<div class="paragraph">
<p>The Gremlin Console is a fairly standard REPL (Read Eval Print Loop) shell. It is
based on the Groovy console and if you have used any of the other console
environments such as those found with Scala, Python and Ruby you will feel right at
home here. The Console offers a low overhead (you can set it up in seconds) and low
barrier of entry way to start to play with graphs on your local computer. The
console can actually work with graphs that are running locally or remotely but for
the majority of this book we will keep things simple and focus on local graphs.</p>
</div>
<div class="paragraph">
<p>To follow along with this tutorial you will need to have installed the Gremlin
console or have access to a TinkerPop3/Gremlin enabled graph store such as
TinkerGraph or JanusGraph.</p>
</div>
<div class="paragraph">
<p>Regardless of the environment you use, if you work with Apache TinkerPop enabled
graphs, the Gremlin console should always be installed on your machine!</p>
</div>
<div class="sect3">
<h4 id="gremlininstall">2.2.1. Downloading, installing and launching the console</h4>
<div class="paragraph">
<p>You can download the Gremlin console from the official Apache TinkerPop website:</p>
</div>
<div class="paragraph">
<p><a href="http://tinkerpop.apache.org/" class="bare">http://tinkerpop.apache.org/</a></p>
</div>
<div class="paragraph">
<p>It only takes a few minutes to get the Gremlin Console installed and running. You
just download the ZIP file and <em>unzip</em> it and you are all set. TinkerPop 3 also
requires a recent version of Java 8 being installed. I have done all of my testing
using Java 8 version 1.8.0_131. The Gremlin Console will not work with versions prior
to 1.8.0_45. If you do not have Java 8 installed it is easy to find and download off
the Web. The download also includes all of the JAR files that are needed to write a
standalone Java or Groovy TinkerPop application but that is a topic for later!</p>
</div>
<div class="paragraph">
<p>When you start the Gremlin console you will be presented with a banner/logo and a
prompt that will look something like this. Don’t worry about the plugin messages yet
we will talk about those a bit later.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ./gremlin.sh

         \,,,/
         (o o)
-----oOOo-(3)-oOOo-----
plugin activated: tinkerpop.server
plugin activated: tinkerpop.utilities
plugin activated: tinkerpop.tinkergraph
gremlin&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>You can get a list of the available commands by typing <em>:help</em>. Note that all
commands to the console itself are prefixed by a colon <em>":"</em>. This enables the
console to distinguish them as special and different from actual Gremlin and
Groovy commands.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>gremlin&gt; :help

For information about Groovy, visit:
    http://groovy-lang.org

Available commands:
  :help       (:h  ) Display this help message
  ?           (:?  ) Alias to: :help
  :exit       (:x  ) Exit the shell
  :quit       (:q  ) Alias to: :exit
  import      (:i  ) Import a class into the namespace
  :display    (:d  ) Display the current buffer
  :clear      (:c  ) Clear the buffer and reset the prompt counter
  :show       (:S  ) Show variables, classes or imports
  :inspect    (:n  ) Inspect a variable or the last result with the GUI object browser
  :purge      (:p  ) Purge variables, classes, imports or preferences
  :edit       (:e  ) Edit the current buffer
  :load       (:l  ) Load a file or URL into the buffer
  .           (:.  ) Alias to: :load
  :save       (:s  ) Save the current buffer to a file
  :record     (:r  ) Record the current session to a file
  :history    (:H  ) Display, manage and recall edit-line history
  :alias      (:a  ) Create an alias
  :grab       (:g  ) Add a dependency to the shell environment
  :register   (:rc ) Register a new command with the shell
  :doc        (:D  ) Open a browser window displaying the doc for the argument
  :set        (:=  ) Set (or list) preferences
  :uninstall  (:-  ) Uninstall a Maven library and its dependencies from the Gremlin Console
  :install    (:+  ) Install a Maven library and its dependencies into the Gremlin Console
  :plugin     (:pin) Manage plugins for the Console
  :remote     (:rem) Define a remote connection
  :submit     (:&gt;  ) Send a Gremlin script to Gremlin Server
  :bytecode   (:bc ) Gremlin bytecode helper commands
  :cls        (:C  ) Clear the screen.

For help on a specific command type:
    :help command</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Of all the commands listed above :clear (:c for short) is an important one to
remember. If the console starts acting strangely or you find yourself stuck with a
prompt like "…​…​1&gt;" , typing <em>:clear</em> will reset things nicely.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>It is worth noting that as mentioned above, the Gremlin console is based on the
Groovy console and as such you can enter valid Groovy code directly into the console.
So as well as using it to experiment with Graphs and Gremlin you can use it as, for
example, a desktop calculator should you so desire!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-mi">2</span><span class="tok-o">+</span><span class="tok-mi">3</span>
<span class="tok-o">==&gt;</span><span class="tok-mi">5</span>

<span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-mi">5</span>
<span class="tok-o">==&gt;</span><span class="tok-mi">5</span>

<span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-n">println</span> <span class="tok-s2">"The number is ${a}"</span>
<span class="tok-n">The</span> <span class="tok-n">number</span> <span class="tok-n">is</span> <span class="tok-mi">5</span>

<span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">a</span> <span class="tok-k">in</span> <span class="tok-mi">1</span><span class="tok-o">..</span><span class="tok-mi">5</span><span class="tok-o">)</span> <span class="tok-o">{</span><span class="tok-n">print</span> <span class="tok-s2">"${a} "</span><span class="tok-o">};</span><span class="tok-n">println</span><span class="tok-o">()</span>
<span class="tok-mi">1</span> <span class="tok-mi">2</span> <span class="tok-mi">3</span> <span class="tok-mi">4</span> <span class="tok-mi">5</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Gremlin Console does a very nice job of only showing you a nice and tidy
set of query results. If you are working with a graph system that supports TinkerPop
3 but not via the Gremlin console (an example of this would be talking to a Gremlin
Server using the HTTP REST API) then what you will get back is going to be a JSON
document that you will need to write some code to parse. We will explore that topic
much later in the book.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>If you want to see lots of examples of the output from running various queries you
will find plenty in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#msc">MISCELLANEOUS QUERIES AND THEIR RESULTS</a>" section of this book where we have tried to go
into more depth on various topics.</p>
</div>
<div class="paragraph">
<p>Mostly you will run the Gremlin console in its interactive mode. However you can also
pass the name of a file as a command line parameter, preceded by the <em>-e</em> flag and
Gremlin will execute the file and exit. For example if you had a file called
"mycode.groovy" you could execute it directly from your command line window or
terminal window as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ./gremlin.sh -e mycode.groovy</pre>
</div>
</div>
<div class="paragraph">
<p>If you wanted to have the console run your script and not exit afterwards, you can
use the <em>-i</em> option instead of <em>-e</em>.</p>
</div>
<div class="paragraph">
<p>You can get help on all of the command line options for the Gremlin console by typing
<em>gremlin --help</em>. You should get back some help text that looks like this</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ./gremlin.sh --help

Usage: gremlin.sh [-CDhlQvV] [-e=&lt;SCRIPT ARG1 ARG2 ...&gt;]... [-i=&lt;SCRIPT ARG1
                  ARG2 ...&gt;...]...
  -C, --color     Disable use of ANSI colors
  -D, --debug     Enabled debug Console output
  -e, --execute=&lt;SCRIPT ARG1 ARG2 ...&gt;
                  Execute the specified script (SCRIPT ARG1 ARG2 ...) and close
                    the console on completion
  -h, --help      Display this help message
  -i, --interactive=&lt;SCRIPT ARG1 ARG2 ...&gt;...
                  Execute the specified script and leave the console open on
                    completion
  -l              Set the logging level of components that use standard logging
                    output independent of the Console
  -Q, --quiet     Suppress superfluous Console output
  -v, --version   Display the version
  -V, --verbose   Enable verbose Console output</pre>
</div>
</div>
<div class="paragraph">
<p>If you ever want to check which version of TinkerPop you have installed you can enter
the following command from inside the Gremlin console.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// What version of Gremlin console am I running?</span>
<span class="tok-n">gremlin</span><span class="tok-o">&gt;</span>  <span class="tok-n">Gremlin</span><span class="tok-o">.</span><span class="tok-na">version</span><span class="tok-o">()</span>
<span class="tok-o">==&gt;</span><span class="tok-mf">3.4</span><span class="tok-o">.</span><span class="tok-mi">10</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>One thing that is not at all obvious or apparent is that the Gremlin console quietly
imports a large number of Java Classes and Enums on your behalf as it starts up. This
makes writing queries within the console simpler. However, as we shall explore in the
"<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#javastatics">Important Classes and Enums to be aware of</a>" section later, once you start writing standalone programs in Java
or other languages, you need to actually know what the console did on your behalf. As
a teaser for what comes later, try typing <em>:show imports</em> when using the Gremlin
Console and see what it returns.</p>
</div>
</div>
<div class="sect3">
<h4 id="gremlinsave">2.2.2. Saving output from the console to a file</h4>
<div class="paragraph">
<p>Sometimes it is useful to save part or all of a console session to a file. You can
turn recording to a file on and off using the <em>:record</em> command.</p>
</div>
<div class="paragraph">
<p>In the following example, we turn recording on using <em>:record start mylog.txt</em> which
will force all commands entered and their output to be written to the file
<em>mylog.txt</em> until the command <em>:record stop</em> is entered. The command
<em>g.V().count().next()</em> just counts how many vertices (nodes) are in the graph. We
will explain the Gremlin graph traversal and query language in detail starting in the
next section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-o">:</span><span class="tok-n">record</span> <span class="tok-n">start</span> <span class="tok-n">mylog</span><span class="tok-o">.</span><span class="tok-na">txt</span>
<span class="tok-n">Recording</span> <span class="tok-n">session</span> <span class="tok-nl">to:</span> <span class="tok-s2">"mylog.txt"</span>

<span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()</span>
<span class="tok-o">==&gt;</span><span class="tok-mi">3618</span>
<span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-o">:</span><span class="tok-n">record</span> <span class="tok-n">stop</span>
<span class="tok-n">Recording</span> <span class="tok-n">stopped</span><span class="tok-o">;</span> <span class="tok-n">session</span> <span class="tok-n">saved</span> <span class="tok-k">as</span><span class="tok-o">:</span> <span class="tok-s2">"mylog.txt"</span> <span class="tok-o">(</span><span class="tok-mi">157</span> <span class="tok-n">bytes</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we were to look at the <em>mylog.txt</em> file, this is what it now contains.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>// OPENED: Tue Sep 12 10:43:40 CDT 2017
// RESULT: mylog.txt
g.V().count().next()
// RESULT: 3618
:record stop
// CLOSED: Tue Sep 12 10:43:50 CDT 2017</pre>
</div>
</div>
<div class="paragraph">
<p>For the remainder of this book I am not going to show the <em>gremlin&gt;</em> prompt or
the <em>=⇒</em> output identifier as part of each example, just to reduce clutter a bit.
You can assume that each command was entered and tested using the Gremlin console
however.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you want to learn more about the console itself you can refer to the official
TinkerPop documentation and, even better, have a play with the console and the built
in help.
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tgintro">2.3. Introducing TinkerGraph</h3>
<div class="paragraph">
<p>As well as the Gremlin Console, the TinkerPop 3 download includes an implementation
of an in-memory graph store called TinkerGraph. This book was mostly developed
using TinkerGraph but I also tested everything using JanusGraph. I will introduce
JanusGraph later in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#janusintro">Introducing JanusGraph</a>" section. The nice thing about TinkerGraph
is that for learning and testing things you can run everything you need on your
laptop or desktop computer and be up and running very quickly. I will also explain how to
get started with the Gremlin Console and TinkerGraph a bit later in this section.</p>
</div>
<div class="paragraph">
<p>Tinkerpop 3 defines a number of capabilities that a graph store should support. Some
are optional others are not. If supported, you can query any TinkerPop 3 enabled
graph store to see which features are supported using a command such as
<em>graph.features()</em> once you have established the <em>graph</em> object. We will look at how
to do that soon. The following list shows the features supported by TinkerGraph. This
is what you would get back should you call the <em>features</em> method provided by
TinkerGraph. I have arranged the list in two columns to aid readability. Don’t worry
if not all of these terms make sense right away - we’ll get there soon!</p>
</div>
<div class="listingblock">
<div class="title">Output from graph.features()</div>
<div class="content">
<pre>&gt; GraphFeatures                          &gt; VertexPropertyFeatures
&gt;-- ConcurrentAccess: false              &gt;-- UserSuppliedIds: true
&gt;-- ThreadedTransactions: false          &gt;-- StringIds: true
&gt;-- Persistence: true                    &gt;-- RemoveProperty: true
&gt;-- Computer: true                       &gt;-- AddProperty: true
&gt;-- Transactions: false                  &gt;-- NumericIds: true
&gt; VariableFeatures                       &gt;-- CustomIds: false
&gt;-- Variables: true                      &gt;-- AnyIds: true
&gt;-- LongValues: true                     &gt;-- UuidIds: true
&gt;-- SerializableValues: true             &gt;-- Properties: true
&gt;-- FloatArrayValues: true               &gt;-- LongValues: true
&gt;-- UniformListValues: true              &gt;-- SerializableValues: true
&gt;-- ByteArrayValues: true                &gt;-- FloatArrayValues: true
&gt;-- MapValues: true                      &gt;-- UniformListValues: true
&gt;-- BooleanArrayValues: true             &gt;-- ByteArrayValues: true
&gt;-- MixedListValues: true                &gt;-- MapValues: true
&gt;-- BooleanValues: true                  &gt;-- BooleanArrayValues: true
&gt;-- DoubleValues: true                   &gt;-- MixedListValues: true
&gt;-- IntegerArrayValues: true             &gt;-- BooleanValues: true
&gt;-- LongArrayValues: true                &gt;-- DoubleValues: true
&gt;-- StringArrayValues: true              &gt;-- IntegerArrayValues: true
&gt;-- StringValues: true                   &gt;-- LongArrayValues: true
&gt;-- DoubleArrayValues: true              &gt;-- StringArrayValues: true
&gt;-- FloatValues: true                    &gt;-- StringValues: true
&gt;-- IntegerValues: true                  &gt;-- DoubleArrayValues: true
&gt;-- ByteValues: true                     &gt;-- FloatValues: true
&gt; VertexFeatures                         &gt;-- IntegerValues: true
&gt;-- AddVertices: true                    &gt;-- ByteValues: true
&gt;-- DuplicateMultiProperties: true       &gt; EdgePropertyFeatures
&gt;-- MultiProperties: true                &gt;-- Properties: true
&gt;-- RemoveVertices: true                 &gt;-- LongValues: true
&gt;-- MetaProperties: true                 &gt;-- SerializableValues: true
&gt;-- UserSuppliedIds: true                &gt;-- FloatArrayValues: true
&gt;-- StringIds: true                      &gt;-- UniformListValues: true
&gt;-- RemoveProperty: true                 &gt;-- ByteArrayValues: true
&gt;-- AddProperty: true                    &gt;-- MapValues: true
&gt;-- NumericIds: true                     &gt;-- BooleanArrayValues: true
&gt;-- CustomIds: false                     &gt;-- MixedListValues: true
&gt;-- AnyIds: true                         &gt;-- BooleanValues: true
&gt;-- UuidIds: true                        &gt;-- DoubleValues: true
&gt; EdgeFeatures                           &gt;-- IntegerArrayValues: true
&gt;-- RemoveEdges: true                    &gt;-- LongArrayValues: true
&gt;-- AddEdges: true                       &gt;-- StringArrayValues: true
&gt;-- UserSuppliedIds: true                &gt;-- StringValues: true
&gt;-- StringIds: true                      &gt;-- DoubleArrayValues: true
&gt;-- RemoveProperty: true                 &gt;-- FloatValues: true
&gt;-- AddProperty: true                    &gt;-- IntegerValues: true
&gt;-- NumericIds: true                     &gt;-- ByteValues: true
&gt;-- CustomIds: false
&gt;-- AnyIds: true
&gt;-- UuidIds: true</pre>
</div>
</div>
<div class="paragraph">
<p>TinkerGraph is really useful while learning to work with Gremlin and great for
testing things out. One common use case where TinkerGraph can be very useful is to
create a sub-graph of a large graph and work with it locally. TinkerGraph can even be
used in production deployments if an all in memory graph fits the bill. Typically,
TinkerGraph is used to explore static (unchanging) graphs but you can also use it
from a programming language like Java and mutate its contents if you want to.
However, TinkerGraph does not support some of the more advanced features you will
find in implementations like JanusGraph such as transactions and external indexes. I
will cover these topics as part of the discussion of JanusGraph in the <a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#janusintro">Introducing JanusGraph</a>
section later on. One other thing worth noting in the list above is that
<em>UserSuppliedIds</em> is set to true for vertex and edge ID values. This means that if
you load a graph file, such as a GraphML format file, that specifies ID values for
vertices and edges then TinkerGraph will honor those IDs and use them. As we shall
see later this is not the case with some other graph database systems.</p>
</div>
<div class="paragraph">
<p>When running in the Gremlin Console, support for TinkerGraph should be on by default.
If for any reason you find it to be off you, can enable it by issuing the following
command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">:</span><span class="tok-n">plugin</span> <span class="tok-n">use</span> <span class="tok-n">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">tinkergraph</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the TinkerGraph plugin is enabled you will need to close and re-load the Gremlin
console. After doing that, you can create a new TinkerGraph instance from the console
as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">graph</span> <span class="tok-o">=</span> <span class="tok-n">TinkerGraph</span><span class="tok-o">.</span><span class="tok-na">open</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In many cases you will want to pass parameters to the <em>open</em> method that give more
information on how the graph is to be configured. We will explore those options later
on. Before you can start to issue Gremlin queries against the graph you also need to
establish a graph traversal source object by calling the new graph’s <em>traversal</em>
method as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span> <span class="tok-o">=</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Throughout the remainder of this book the following convention will be used.
The variable name <em>graph</em> will be used for any object that represents a graph
instance and the variable name <em>g</em> will be used for any object that represents an
instance of a graph traversal source object.
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="air">2.4. Introducing the air-routes graph</h3>
<div class="paragraph">
<p>Along with this book I have provided what is, in big data terms, a very small, but
nonetheless real-world graph that is stored in GraphML, a standard XML format for
describing graphs that can be used to move graphs between applications. The graph,
<em>air-routes</em> is a model I built of the world airline route network that is
fairly accurate.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>air-routes.graphml</code> file can be downloded from the <code>sample-data</code> folder
located in the GitHub repository at the following URL:
<a href="https://github.com/krlawrence/graph/tree/master/sample-data" class="bare">https://github.com/krlawrence/graph/tree/master/sample-data</a>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Of course, in the real world, routes are added and deleted by airlines all the time
so please don’t use this graph to plan your next vacation or business trip! However,
as a learning tool I hope you will find it useful and easy to relate to. If you feel
so inclined you can load the file into a text editor and examine how it is laid out.
As you work with graphs you will want to become familiar with popular graph
serialization formats. Two common ones are GraphML and GraphSON. The latter is a
JSON format that is defined by Apache TinkerPop and heavily used in that environment.
GraphML is widely recognized by TinkerPop and many other tools as well such as
Gephi, a popular open source tool for visualizing graph data. A lot of graph
ingestion tools also still use comma separated values (CSV) format files.</p>
</div>
<div class="paragraph">
<p>We will briefly look at loading and saving graph data in Sections 2 and 4. I take a
look at different ways to work with graph data stored in text format
files including importing and exporting graph data in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#serialize">COMMON GRAPH SERIALIZATION FORMATS</a>" section
towards the end of the book.</p>
</div>
<div class="paragraph">
<p>The <em>air-routes</em> graph contains several vertex types that are specified using labels.
The most common ones being <em>airport</em> and <em>country</em>. There are also vertices for each
of the seven continents (<em>continent</em>) and a single <em>version</em> vertex that I provided
as a way to test which version of the graph you are using.</p>
</div>
<div class="paragraph">
<p>Routes between airports are modeled as edges. These edges carry the <em>route</em> label and
include the distance between the two connected airport vertices as a property called
<em>dist</em>. Connections between countries and airports are modelled using an edge with a
<em>contains</em> label.</p>
</div>
<div class="paragraph">
<p>Each airport vertex has many properties associated with it giving various details
about that airport including its IATA and ICAO codes, its description, the city it is
in and its geographic location.</p>
</div>
<div class="paragraph">
<p>Specifically, each airport vertex has a unique ID, a label of <em>airport</em> and contains
the following properties. The word in parenthesis indicates the type of the property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre> type    (string) : Vertex type. Will be 'airport' for airport vertices
 code    (string) : The three letter IATA code like AUS or LHR
 icao    (string) : The four letter ICAO code or none. Example KAUS or EGLL
 desc    (string) : A text description of the airport
 region  (string) : The geographical region like US-TX or GB-ENG
 runways (int)    : The number of available runways
 longest (int)    : Length of the longest runway in feet
 elev    (int)    : Elevation in feet above sea level
 country (string) : Two letter ISO country code such as US, FR or DE.
 city    (string) : The name of the city the airport is in
 lat     (double) : Latitude of the airport
 lon     (double) : Longitude of the airport</pre>
</div>
</div>
<div class="paragraph">
<p>We can use Gremlin once the air route graph is loaded to show us what properties an
airport vertex has. As an example here is what the Austin airport vertex looks
like. I will explain the steps that make up the Gremlin query shortly. First we need
to dig a little bit into how to load the data and configure a few preferences.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Query the properties of vertex 3</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">()</span>

<span class="tok-n">id</span><span class="tok-o">=</span><span class="tok-mi">3</span>
<span class="tok-n">label</span><span class="tok-o">=</span><span class="tok-n">airport</span>
<span class="tok-n">type</span><span class="tok-o">=[</span><span class="tok-n">airport</span><span class="tok-o">]</span>
<span class="tok-n">code</span><span class="tok-o">=[</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-n">icao</span><span class="tok-o">=[</span><span class="tok-n">KAUS</span><span class="tok-o">]</span>
<span class="tok-n">desc</span><span class="tok-o">=[</span><span class="tok-n">Austin</span> <span class="tok-n">Bergstrom</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span><span class="tok-o">]</span>
<span class="tok-n">region</span><span class="tok-o">=[</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span><span class="tok-o">]</span>
<span class="tok-n">runways</span><span class="tok-o">=[</span><span class="tok-mi">2</span><span class="tok-o">]</span>
<span class="tok-n">longest</span><span class="tok-o">=[</span><span class="tok-mi">12250</span><span class="tok-o">]</span>
<span class="tok-n">elev</span><span class="tok-o">=[</span><span class="tok-mi">542</span><span class="tok-o">]</span>
<span class="tok-n">country</span><span class="tok-o">=[</span><span class="tok-n">US</span><span class="tok-o">]</span>
<span class="tok-n">city</span><span class="tok-o">=[</span><span class="tok-n">Austin</span><span class="tok-o">]</span>
<span class="tok-n">lat</span><span class="tok-o">=[</span><span class="tok-mf">30.1944999694824</span><span class="tok-o">]</span>
<span class="tok-n">lon</span><span class="tok-o">=[-</span><span class="tok-mf">97.6698989868164</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Even though the airport vertex label is <em>airport</em> I chose to also have a property
called <em>type</em> that also contains the string <em>airport</em>. This was done to aid with
indexing when working with other graph database systems and is explained in more
detail later in this book.</p>
</div>
<div class="paragraph">
<p>You may have noticed that the values for each property are represented as lists (or
arrays if you prefer), even though each list only contains one element. The reasons
for this will be explored later in this book but the quick explanation is that
this is because TinkerPop allows us to associate a list of values with any vertex
property. We will explore ways that you can take advantage of this capability in the
"<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#listprop">Attaching multiple values (lists or sets) to a single property</a>" section.</p>
</div>
<div class="paragraph">
<p>The full details of all the features contained in the <em>air-routes</em> graph can be
learned by reading the comments at the start of the <code>air-routes.graphml</code> file or
reading the <code>README.txt</code> file.</p>
</div>
<div class="paragraph">
<p>The graph currently contains a total of 3,619 vertices and 50,148 edges. Of these
3,374 vertices are airports, and 43,400 of the edges represent routes. While in big
data terms this is really a tiny graph, it is plenty big enough for us to build up
and experiment with some very interesting Gremlin queries.</p>
</div>
<div class="paragraph">
<p>Lastly, here are some statistics and facts about the <em>air-routes</em> graph. If you
want to see a lot more statistics check the <code>README.txt</code> file that is included with
the <em>air-routes</em> graph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Air Routes Graph (v0.77, 2017-Oct-06) contains:
  3,374 airports
  43,400 routes
  237 countries (and dependent areas)
  7 continents
  3,619 total nodes
  50,148 total edges

Additional observations:
  Longest route is between DOH and AKL (9,025 miles)
  Shortest route is between WRY and PPW (2 miles)
  Average route distance is 1,164.747 miles.
  Longest runway is 18,045ft (BPX)
  Shortest runway is 1,300ft (SAB)
  Furthest North is LYR (latitude: 78.2461013793945)
  Furthest South is USH (latitude: -54.8433)
  Furthest East is SVU (longitude: 179.341003418)
  Furthest West is TVU (longitude: -179.876998901)
  Closest to the Equator is MDK (latitude: 0.0226000007242)
  Closest to the Greenwich meridian is LDE (longitude: -0.006438999902457)
  Highest elevation is DCY (14,472 feet)
  Lowest elevation is GUW (-72 feet)
  Maximum airport node degree (routes in and out) is 544 (FRA)
  Country with the most airports: United States (579)
  Continent with the most airports: North America (978)
  Average degree (airport nodes) is 25.726
  Average degree (all nodes) is 25.856</pre>
</div>
</div>
<div class="paragraph">
<p>Here are the Top 15 airports sorted by overall number of routes (in and out). In
graph terminology this is often called the degree of the vertex or just <em>vertex degree</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    POS   ID  CODE  TOTAL     DETAILS

     1    52   FRA  (544)  out:272 in:272
     2    70   AMS  (541)  out:269 in:272
     3   161   IST  (540)  out:270 in:270
     4    51   CDG  (524)  out:262 in:262
     5    80   MUC  (474)  out:237 in:237
     6    64   PEK  (469)  out:234 in:235
     7    18   ORD  (464)  out:232 in:232
     8     1   ATL  (464)  out:232 in:232
     9    58   DXB  (458)  out:229 in:229
    10     8   DFW  (442)  out:221 in:221
    11   102   DME  (428)  out:214 in:214
    12    67   PVG  (402)  out:201 in:201
    13    50   LGW  (400)  out:200 in:200
    14    13   LAX  (390)  out:195 in:195
    15    74   MAD  (384)  out:192 in:192</pre>
</div>
</div>
<div class="paragraph">
<p>Throughout this book you will find Gremlin queries that can be used to generate many
of these statistics.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There is a sample script called <em>graph-stats.groovy</em> in
the GitHub repository located in the <em>sample-code</em> folder that shows how to generate
some statistics about the graph. The script can be found at the
following URL: <a href="https://github.com/krlawrence/graph/tree/master/sample-code" class="bare">https://github.com/krlawrence/graph/tree/master/sample-code</a>
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="airrouteupdates">2.4.1. Updated versions of the air-route data</h4>
<div class="paragraph">
<p>To keep things consistent, all of the examples presented in this book were produced
using the same version of the air-routes data set. That data set was generated in
October 2017. While I felt it was important that the examples remained consistent
that does also mean that some of the examples shown in the book, such as the longest
airline route currently being flown, are out of date.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can download the very latest air-routes data set from
<a href="https://github.com/krlawrence/graph/blob/master/sample-data/air-routes-latest.graphml" class="bare">https://github.com/krlawrence/graph/blob/master/sample-data/air-routes-latest.graphml</a>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>If you want to get the most up to date results there is a newer version of the data
set available. That file can be found in the <em>sample-data</em> folder. Look for a file
called <code>air-routes-latest.graphml</code>. There is also a README file to go along with the
updated data set called <code>README-air-routes-latest.txt</code> in the same folder.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mn">2.5. TinkerPop 3 migration notes</h3>
<div class="paragraph">
<p>There are still a large number of examples on the internet that show the TinkerPop 2
way of doing things. Quite a lot of things changed between TinkerPop 2 and TinkerPop
3. If you were an early adopter and are coming from a TinkerPop 2 environment to a
TinkerPop 3 environment you may find some of the tips in this section helpful. As
explained below, using the <em>sugar</em> plugin will make the migration from TinkerPop 2
easier but it is recommended to learn the full TinkerPop 3 Gremlin syntax and get
used to using that as soon as possible. Using the full syntax will make your queries
a lot more portable to other TinkerPop 3 enabled graph systems.</p>
</div>
<div class="paragraph">
<p>TinkerPop 3 requires a minimum of Java 8 v45. It will not run on earlier versions of
Java 8 based on my testing.</p>
</div>
<div class="sect3">
<h4 id="cr">2.5.1. Creating a TinkerGraph TP2 vs TP3</h4>
<div class="paragraph">
<p>The way that you create a TinkerGraph changed between TinkerPop 2 and 3.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">graph</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">TinkerGraph</span><span class="tok-o">()</span>  <span class="tok-c1">// TinkerPop 2</span>
<span class="tok-n">graph</span> <span class="tok-o">=</span> <span class="tok-n">TinkerGraph</span><span class="tok-o">.</span><span class="tok-na">open</span><span class="tok-o">()</span> <span class="tok-c1">// TinkerPop 3</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ld2">2.5.2. Loading a graphML file TP2 vs TP3</h4>
<div class="paragraph">
<p>If you have previous experience with TinkerPop 2 you may also have noticed that the
way a graph is loaded has changed in TinkerPop 3.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">loadGraphML</span><span class="tok-o">(</span><span class="tok-s1">'air-routes.graphml'</span><span class="tok-o">)</span> <span class="tok-c1">// TinkerPop 2</span>
<span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">io</span><span class="tok-o">(</span><span class="tok-n">graphml</span><span class="tok-o">()).</span><span class="tok-na">readGraph</span><span class="tok-o">(</span><span class="tok-s1">'air-routes.graphml'</span><span class="tok-o">)</span> <span class="tok-c1">// TinkerPop 3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Gremlin language itself changed quite a bit between TinkerPop 2 and TinkerPop 3.
The remainder of this book only shows TinkerPop 3 examples.</p>
</div>
</div>
<div class="sect3">
<h4 id="sugarplugin">2.5.3. A word about the TinkerPop.sugar plugin</h4>
<div class="paragraph">
<p>The Gremlin console has a set of plug in modules that can be independently enabled or
disabled. Depending upon your use case you may or may not need to manage plugins.</p>
</div>
<div class="paragraph">
<p>TinkerPop 2 supported by default some syntactic <em>sugar</em> that allowed shorthand
forms of queries to be entered when using the Gremlin console. In TinkerPop 3 that
support has been moved to a plugin and is off by default. It has to be enabled if you
want to continue to use the same shortcuts that TinkerPop 2 allowed by default.</p>
</div>
<div class="paragraph">
<p>You can enable <em>sugar</em> support from the Gremlin console as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">:</span><span class="tok-n">plugin</span> <span class="tok-n">use</span> <span class="tok-n">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">sugar</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The Gremlin Console remembers which plugins are enabled between restarts.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>In the current revision of this book I have tried to remove any dependence on the
<em>TinkerPop.sugar</em> plugin from the examples presented. By not using Sugar, queries
shown in this book should port very easily to other TinkerPop 3 enabled graph
platforms. A few of the queries may not work on versions of TinkerPop prior to 3.2 as
TinkerPop continues to evolve and new features are being added fairly regularly.</p>
</div>
<div class="paragraph">
<p>The <em>Tinkerpop.sugar</em> plugin allows some queries to be expressed in a more shorthand
or lazy form, often leaving out references to <em>values()</em> and leaving out parenthesis.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// With Sugar enabled</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">.</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">code</span>

<span class="tok-c1">// Without Sugar enabled</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>People Migrating from TinkerPop 2 will find the Sugar plugin helps get your existing
queries running more easily but as a general rule it is recommended to become
familiar with the longhand way of writing queries as that will enable your queries to
run as efficiently as possible on graph stores that support TinkerPop 3. Also, due to
changes introduced with TinkerPop 3, using sugar will not be as performant as using
the normal Gremlin syntax.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<em>In earlier versions of this book many of the examples showed the <em>sugar</em>
form. In the current revision I have tried to remove all use of that form. It’s
possible that I may have missed a few and I will continue to check for, and fix, any
that got missed. Please let me know if you find any that slipped through the net!</em>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ld">2.6. Loading the air-routes graph using the Gremlin console</h3>
<div class="paragraph">
<p>Here is some code you can load the air routes graph using the gremlin console by
putting it into a file and using <em>:load</em> to load and run it or by entering each line
into the console manually. These commands will setup the console environment, create
a TinkerGraph graph and load the <code>air-routes.graphml</code> file into it. Some extra
console features are also enabled.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There is a file called <code>load-air-routes-graph.groovy</code>, that contains the
commands shown below, available in the <code>/sample-data</code> directory.
<a href="https://github.com/krlawrence/graph/tree/master/sample-data" class="bare">https://github.com/krlawrence/graph/tree/master/sample-data</a>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>These commands create an in-memory TinkerGraph which will use LONG values for the
vertex, edge and vertex property IDs. TinkerPop 3 introduced the concept of a
<em>traversal</em> so as part of loading a <em>graph</em> we also setup a graph traversal source
object called <em>g</em> which we will then refer to in our subsequent queries of the graph.
The <em>max-iteration</em> option tells the Gremlin console the maximum number of lines of
output that we ever want to see in return from a query. The default, if this is not
specified, is 100.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can use the <em>max-iteration</em> setting to control how much output the Gremlin
Console displays.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>If you are using a different graph environment and GraphML import is supported, you
can still load the <code>air-routes.graphml</code> file by following the instructions specific
to that system. Once loaded, the queries below should still work either unchanged or
with minor modifications.</p>
</div>
<div class="listingblock">
<div class="title">load-air-routes-graph.groovy</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">conf</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">BaseConfiguration</span><span class="tok-o">()</span>
<span class="tok-n">conf</span><span class="tok-o">.</span><span class="tok-na">setProperty</span><span class="tok-o">(</span><span class="tok-s2">"gremlin.tinkergraph.vertexIdManager"</span><span class="tok-o">,</span><span class="tok-s2">"LONG"</span><span class="tok-o">)</span>
<span class="tok-n">conf</span><span class="tok-o">.</span><span class="tok-na">setProperty</span><span class="tok-o">(</span><span class="tok-s2">"gremlin.tinkergraph.edgeIdManager"</span><span class="tok-o">,</span><span class="tok-s2">"LONG"</span><span class="tok-o">)</span>
<span class="tok-n">conf</span><span class="tok-o">.</span><span class="tok-na">setProperty</span><span class="tok-o">(</span><span class="tok-s2">"gremlin.tinkergraph.vertexPropertyIdManager"</span><span class="tok-o">,</span><span class="tok-s2">"LONG"</span><span class="tok-o">);[]</span>
<span class="tok-n">graph</span> <span class="tok-o">=</span> <span class="tok-n">TinkerGraph</span><span class="tok-o">.</span><span class="tok-na">open</span><span class="tok-o">(</span><span class="tok-n">conf</span><span class="tok-o">)</span>
<span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">io</span><span class="tok-o">(</span><span class="tok-n">graphml</span><span class="tok-o">()).</span><span class="tok-na">readGraph</span><span class="tok-o">(</span><span class="tok-s1">'air-routes.graphml'</span><span class="tok-o">)</span>
<span class="tok-n">g</span><span class="tok-o">=</span><span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">()</span>
<span class="tok-o">:</span><span class="tok-n">set</span> <span class="tok-n">max</span><span class="tok-o">-</span><span class="tok-n">iteration</span> <span class="tok-mi">1000</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Setting the ID manager as shown above is important. If you do not do this, by
default, when using TinkerGraph, ID values will have to be specified as strings such
as <em>"3"</em> rather than just the numeral <em>3</em>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>If you download the <code>load-air-routes-graph.groovy</code> file, once the console is up and
running you can load that file by entering the command below. Doing this will save
you a fair bit of time as each time you restart the console you can just reload your
configuration file and the environment will be configured and the graph loaded and
you can get straight to writing queries.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">:</span><span class="tok-n">load</span> <span class="tok-n">load</span><span class="tok-o">-</span><span class="tok-n">air</span><span class="tok-o">-</span><span class="tok-n">routes</span><span class="tok-o">-</span><span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">groovy</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
As a best practice you should use the full path to the location where the
GraphML file resides if at all possible to make sure that the GraphML reading code
can find it.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Once you have the Gremlin Console up and running and have the graph loaded, if
you feel like it you can cut and paste queries from this book directly into
the console to see them run.</p>
</div>
<div class="paragraph">
<p>Once the <em>air-routes</em> graph is loaded you can enter the following command and you will
get back information about the graph. In the case of a TinkerGraph you will get back
a useful message telling you how many vertices and edges the graph contains. Note that
the contents of this message will vary from one graph system to another and should
not be relied upon as a way to keep track of vertex and edge counts. We will look at
some other ways of counting things a bit later.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Tell me something about my graph</span>
<span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">toString</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When using TinkerGraph, the message you get back will look something like this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">tinkergraph</span><span class="tok-o">[</span><span class="tok-nl">vertices:</span><span class="tok-mi">3610</span> <span class="tok-nl">edges:</span><span class="tok-mi">49490</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="off">2.7. Turning off some of the Gremlin console’s output</h3>
<div class="paragraph">
<p>Sometimes, especially when assigning a result to a variable and you are not
interested in seeing all the steps that Gremlin took to get there, the Gremlin
console displays more output than is desirable. An easy way to prevent this is to
just add an empty list ";[]" to the end of your query as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">a</span><span class="tok-o">=</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">toList</span><span class="tok-o">();[]</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="indexschema">2.8. A word about indexes and schemas</h3>
<div class="paragraph">
<p>Some graph implementations have strict requirements on the use of an <em>index</em>. This
means that a schema and an index must be in place before you can work with a graph
and that you can only begin a traversal by referencing a property in the graph that
is included in the index. While that is, for the most part, outside the scope of this
book, it should be pointed out that some of the queries included in this material
will not work on any graph system that requires all queries to be backed by an index.
Such graph stores tend not to allow what are sometimes called <em>full graph searches</em>
for cases where a particular item in a graph is not backed by an index. One example
of this is vertex and edge <em>labels</em> which are typically not indexed but are sometimes
very useful items to specify at the start of a query. As most of the examples in
this book are intended to work just fine with only a basic TinkerGraph the subject of
indexes is not covered in detail until Chapter 6 "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#beyond">MOVING BEYOND THE CONSOLE AND TINKERGRAPH</a>" . However, as
TinkerGraph does have some indexing capability I have also included some discussion
of it in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#tinkerindex">Introducing TinkerGraph indexes</a>" section. In Chapter 6 where I start to look at
additional technologies such as JanusGraph I have included a more in depth discussion
of indexing as part of that coverage. You should always refer to the specific
documentation for the graph system you are using to decide what you need to do about
creating an index and schema for your graph. I will explain what TinkerGraph is in
the next section. I won’t be discussing the creation of an explicit schema again
until Chapter 6. When working with TinkerGraph there is no need to define a schema
ahead of time. The types of each property are derived at creation time. This is a
really convenient feature and allows us to get productive and do some experimenting
really quickly.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In production systems, especially those where the graphs are large, the task of
creating and managing the parts of the index is often handed to an additional
software component such as Apache Solr or Elasticsearch.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>In general for any graph database, regardless of whether it is optional or not, use of an
index should be considered a best practice. As I mentioned, even TinkerGraph has a
way to create an index should you want to.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="gq">3. WRITING GREMLIN QUERIES</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that you hopefully have the <em>air-routes</em> graph loaded it’s time to start writing
some queries!</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Chapter 3 is focussed on queries that simply read from an existing graph. If
you are more interested in adding new vertices, edges and properties or modifying
existing properties you may want to jump to Chapter 4 and in particular the
"<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#addnodes">Adding vertices, edges and properties</a>" section.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>In this chapter we will begin to look at the Gremlin query language. I will start
off with a quick look at how Gremlin and SQL differ and are yet in some ways similar,
then present some fairly basic queries and finally get into some more
advanced concepts. Hopefully each set of examples presented, building upon things
previously discussed, will be easy to understand.</p>
</div>
<div class="sect2">
<h3 id="gremlinintro">3.1. Introducing Gremlin</h3>
<div class="paragraph">
<p>Gremlin is the name of the graph traversal and query language that TinkerPop provides
for working with property graphs. Gremlin can be used with any graph store that is
Apache TinkerPop enabled. Gremlin is a fairly imperative language but also has some
more declarative constructs as well. Using Gremlin we can traverse a graph looking
for values, patterns and relationships we can add or delete vertices and edges, we can
create sub-graphs and lots more.</p>
</div>
<div class="sect3">
<h4 id="gremlinandsql">3.1.1. A quick look at Gremlin and SQL</h4>
<div class="paragraph">
<p>While it is not required to know SQL in order to be productive with Gremlin, if you
do have some experience with SQL you will notice many of the same keywords and
phrases being used in Gremlin. As a simple example the SQL and Gremlin examples below
both show how we might count the number of airports there are in each country using
firstly a relational database and secondly a property graph.</p>
</div>
<div class="paragraph">
<p>When working with a relational database, we might decide to store all of the airport
data in a single table called <em>airports</em>. In a very simple case (the air routes
graph actually stores a lot more data than this about each airport) we could setup
our airports table so that it had entries for each airport as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ID   CODE  ICAO  CITY             COUNTRY
---  ----  ----  ---------------  ----------
1    ATL   KATL  Atlanta          US
3    AUS   KAUS  Austin           US
8    DFW   KDFW  Dallas           US
47   YYZ   CYYZ  Toronto          CA
49   LHR   EGLL  London           UK
51   CDG   LFPG  Paris            FR
52   FRA   EDDF  Frankfurt        DE
55   SYD   YSSY  Sydney           AU</pre>
</div>
</div>
<div class="paragraph">
<p>We could then use a SQL query to count the
distribution of airports in each country as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">select</span> <span class="tok-n">country</span><span class="tok-p">,</span><span class="tok-k">count</span><span class="tok-p">(</span><span class="tok-n">country</span><span class="tok-p">)</span> <span class="tok-k">from</span> <span class="tok-n">airports</span> <span class="tok-k">group</span> <span class="tok-k">by</span> <span class="tok-n">country</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can do this in Gremlin using the <em>air-routes</em> graph with a query like the one below
(I will explain what all of this means later on in the book).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You will discover that Gremlin provides its own flavor of several constructs that you
will be familiar with if you have used SQL before, but again, prior knowledge of SQL
is in no way required to learn Gremlin.</p>
</div>
<div class="paragraph">
<p>One thing you will not find when working with a graph using Gremlin is the concept of
a SQL <em>join</em>. Graph databases by their very nature avoid the need to join things
together (as things that need to be connected already are connected) and this is a
core reason why, for many use cases, Graph databases are a very good choice and can
be more performant than relational databases.</p>
</div>
<div class="paragraph">
<p>Graph databases are usually a good choice for storing and modelling networks. The
<em>air-routes</em> graph is an example of a network graph. A social network is of course
another good example. Networks can be modelled using relational databases too but as
you explore the network and ask questions like "who are my friends' friends?" in a
social network or "where can I fly to from here with a maximum of two stops?" things
rapidly get complicated and result in the need for multiple <em>joins</em>.</p>
</div>
<div class="paragraph">
<p>As an example, imagine adding a second table to our relational database called
routes. It will contain three columns representing the source airport, the
destination airport and the distance between them in miles (SRC,DEST and DIST). It
would contain entries that looked like this (the real table would of course have
thousands of rows but this gives a good idea of what the table would look like).</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SRC  DEST  DIST
---  ----  ----
ATL  DFW   729
ATL  FRA   4600
AUS  DFW   190
AUS  LHR   4901
BOM  AGR   644
BOM  LHR   4479
CDG  DFW   4933
CDG  FRA   278
CDG  LHR   216
DFW  FRA   5127
DFW  LHR   4736
LHR  BOM   4479
LHR  FRA   406
YYZ  FRA   3938
YYZ  LHR   3544</pre>
</div>
</div>
<div class="paragraph">
<p>If we wanted to write a SQL query to calculate the ways of travelling from Austin
(AUS) to Agra (AGR) with two stops, we would end up writing a query that looked
something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">select</span> <span class="tok-n">a1</span><span class="tok-p">.</span><span class="tok-n">code</span><span class="tok-p">,</span><span class="tok-n">r1</span><span class="tok-p">.</span><span class="tok-n">dest</span><span class="tok-p">,</span><span class="tok-n">r2</span><span class="tok-p">.</span><span class="tok-n">dest</span><span class="tok-p">,</span><span class="tok-n">r3</span><span class="tok-p">.</span><span class="tok-n">dest</span> <span class="tok-k">from</span> <span class="tok-n">airports</span> <span class="tok-n">a1</span>
  <span class="tok-k">join</span> <span class="tok-n">routes</span> <span class="tok-n">r1</span> <span class="tok-k">on</span> <span class="tok-n">a1</span><span class="tok-p">.</span><span class="tok-n">code</span><span class="tok-o">=</span><span class="tok-n">r1</span><span class="tok-p">.</span><span class="tok-n">src</span>
  <span class="tok-k">join</span> <span class="tok-n">routes</span> <span class="tok-n">r2</span> <span class="tok-k">on</span> <span class="tok-n">r1</span><span class="tok-p">.</span><span class="tok-n">dest</span><span class="tok-o">=</span><span class="tok-n">r2</span><span class="tok-p">.</span><span class="tok-n">src</span>
  <span class="tok-k">join</span> <span class="tok-n">routes</span> <span class="tok-n">r3</span> <span class="tok-k">on</span> <span class="tok-n">r2</span><span class="tok-p">.</span><span class="tok-n">dest</span><span class="tok-o">=</span><span class="tok-n">r3</span><span class="tok-p">.</span><span class="tok-n">src</span>
  <span class="tok-k">where</span> <span class="tok-n">a1</span><span class="tok-p">.</span><span class="tok-n">code</span><span class="tok-o">=</span><span class="tok-s1">'AUS'</span> <span class="tok-k">and</span> <span class="tok-n">r3</span><span class="tok-p">.</span><span class="tok-n">dest</span><span class="tok-o">=</span><span class="tok-s1">'AGR'</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using our <em>air-routes</em> graph database the query can be expressed quite simply as
follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AGR'</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Adding or removing hops is as simple as adding or removing one or more of the <em>out()</em>
steps which is a lot simpler than having to add additional <em>join</em> clauses to our SQL
query. This is a simple example, but as queries get more and more complicated in
heavily connected data sets like networks, the SQL queries get harder and harder to
write whereas, because Gremlin is designed for working with this type of data,
expressing a traversal remains fairly straightforward.</p>
</div>
<div class="paragraph">
<p>We can go one step further with Gremlin and use <em>repeat</em> to express the concept of
<em>three times</em> as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">()).</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AGR'</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Gremlin also has a <em>repeat …​ until</em> construct that we will see used later in this
book. When combined with the <em>emit</em> step, <em>repeat</em> provides a nice way of getting
back any routes between a source and destination no matter how many hops it might
take to get there.</p>
</div>
<div class="paragraph">
<p>Again, don’t worry if some of the Gremlin steps shown here are confusing, we will
cover them all in detail a bit later. The key point to take away from this discussion
of SQL and Gremlin is that for data that is very connected, Graph databases provide a
very good way to store that data and Gremlin provides a nice and fairly intuitive way
to traverse that data efficiently.</p>
</div>
<div class="paragraph">
<p>One other point worthy of note is that every vertex and every edge in a graph has a
unique ID. Unlike in the relational world where you may or may not decide to give a
table an ID column this is not optional with graph databases. In some cases the ID
can be a user provided ID but more commonly it will be generated by the graph system
when a vertex or edge is first created. If you are familiar with SQL, you can think
of the ID as a primary key of sorts if you want to. Every vertex and edge can be
accessed using its ID. Just as with relational databases, graph databases can be
indexed and any of the properties contained in a vertex or an edge can be added to
the index and can be used to find things efficiently. In large graph deployments this
greatly speeds up the process of finding things as you would expect. We look more
closely at IDs in the <a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#wid">Working with IDs</a> section.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="bq">3.2. Some fairly basic Gremlin queries</h3>
<div class="paragraph">
<p>A graph <em>query</em> is often referred to as a <em>traversal</em> as that is what we are in fact
doing. We are traversing the graph from a starting point to an ending point.
Traversals consist of one or more <em>steps</em> (essentially methods) that are chained
together.</p>
</div>
<div class="paragraph">
<p>As we start to look at some simple traversals here are a few <em>steps</em> that you will
see used a lot. Firstly, you will notice that almost all traversals start with either
a <em>g.V()</em> or a <em>g.E()</em>. Sometimes there will be parameters specified along with those
steps but we will get into that a little later. You may remember from when we looked
at how to load the <em>air-routes</em> graph in Section 2 we used the following instruction
to create a graph traversal source object for our loaded <em>graph</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span> <span class="tok-o">=</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once we have a graph traversal source object we can use it to start exploring the graph.
The <em>V</em> step returns vertices and the <em>E</em> step returns edges. You can also use a <em>V</em>
step in the middle of a traversal as well as at the start but we will examine those
uses a little later. The <em>V</em> and <em>E</em> steps can also take parameters indicating which
set of vertices or edges we are interested in. That usage is explained in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#wid">Working with IDs</a>"
section.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If it helps with remembering you can think of <em>g.V()</em> as meaning "looking at all
of the vertices in the graph" and <em>g.E()</em> as meaning "looking at all of the edges in the
graph". We then add additional steps to narrow down our search criteria.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The other steps we need to introduce are the <em>has</em> and <em>hasLabel</em> steps. They can be
used to test for a certain label or property having a certain value. We will
encounter a lot of different Gremlin steps as we explore various Gremlin queries
throughout the book, including many other forms of the <em>has</em> step, but these few are
enough to get us started.</p>
</div>
<div class="paragraph">
<p>You can refer to the official Apache TinkerPop documentation for full details on all
of the graph traversal steps that are used in this tutorial. With this tutorial I
have not tried to teach every possible usage of every Gremlin step and method,
rather, I have tried to provide a good and approachable foundation in writing many
different types of Gremlin query using an interesting and real-world graph.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The latest TinkerPop 3 documentation is always available at this URL:
<a href="http://tinkerpop.apache.org/docs/current/reference/" class="bare">http://tinkerpop.apache.org/docs/current/reference/</a>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Below are some simple queries against the <em>air-routes</em> graph to get us started. It is
assumed that the <em>air-routes</em> graph has been loaded already per the instructions above.
The query below will return any vertices (nodes) that have the <em>airport</em> label.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Find vertices that are airports</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This query will return the vertex that represents the Dallas Fort Worth (DFW)
airport.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Find the DFW vertex</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The next two queries combine the previous two into a single query. The first one just
chains the queries together. The second shows a form of the <em>has</em> step that we have
not looked at before that takes an additional label value as its first parameter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Combining those two previous queries (two ways that are equivalent)</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">)</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is what we get back from the query. Notice that this is the Gremlin Console’s way
of telling us we got back the <em>Vertex</em> with an ID of 8.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So, what we actually got back from these queries was a TinkerPop <em>Vertex</em> data
structure. Later in this book we will look at ways to store that value into a
variable for additional processing. Remember that even though we are working with a
Groovy environment while inside the Gremlin Console, everything we are working with
here, at its core, is Java code. So we can use the <em>getClass</em> method from Java to
introspect the object. Note the call to <em>next</em> which turns the result of the
traversal into an object we can work with further.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">().</span><span class="tok-na">getClass</span><span class="tok-o">()</span>

<span class="tok-kd">class</span> <span class="tok-nc">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">tinkergraph</span><span class="tok-o">.</span><span class="tok-na">structure</span><span class="tok-o">.</span><span class="tok-na">TinkerVertex</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>next</em> step that we used above is one of a series of steps that the Tinkerpop
documentation describes as <em>terminal steps</em>. We will see more of these <em>terminal
steps</em> in use throughout this book. As mentioned above, a terminal step
essentially ends the graph traversal and returns a concrete object that you can work
with further in your application. You will see <em>next</em> and other related steps used in
this way when we start to look at using Gremlin from a standalone program a bit
later on. We could even add a call to <em>getMethods()</em> at the end of the query above to
get back a list of all the methods and their types supported by the <em>TinkerVertex</em>
class.</p>
</div>
<div class="sect3">
<h4 id="values">3.2.1. Retrieving property values from a vertex</h4>
<div class="paragraph">
<p>There are several different ways of working with vertex properties. We can add,
delete and query properties for any vertex or edge in the graph. We will explore each
of these topics in detail over the course of this book. Initially, let’s look at
a couple of simple ways that we can look up the property values of a given vertex.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// What property values are stored in the DFW vertex?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the output that the query returns. Note that we just get back the values of
the properties when using the <em>values</em> step, we do not get back the associated keys.
We will see how to do that later in the book.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">US</span>
<span class="tok-n">DFW</span>
<span class="tok-mi">13401</span>
<span class="tok-n">Dallas</span>
<span class="tok-mi">607</span>
<span class="tok-n">KDFW</span>
<span class="tok-o">-</span><span class="tok-mf">97.0380020141602</span>
<span class="tok-n">airport</span>
<span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span>
<span class="tok-mi">7</span>
<span class="tok-mf">32.896800994873</span>
<span class="tok-n">Dallas</span><span class="tok-o">/</span><span class="tok-n">Fort</span> <span class="tok-n">Worth</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>values</em> step can take parameters that tell it to only return the values for
the provided key names. The queries below return the values of some specific
properties.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Return just the city name property</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span>

<span class="tok-n">Dallas</span>

<span class="tok-c1">// Return the 'runways' and 'icao' property values.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-s1">'icao'</span><span class="tok-o">)</span>

<span class="tok-n">KDFW</span>
<span class="tok-mi">7</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="exist">3.2.2. Does a specific property exist on a given vertex or edge?</h4>
<div class="paragraph">
<p>You can simply test to see if a property exists as well as testing for it containing
a specific value. To do this we can just provide <em>has</em> with the name of the property
we are interested in. This works equally well for both vertex and edge properties.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Find all edges that have a 'dist' property</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)</span>

<span class="tok-c1">// Find all vertices that have a 'region' property</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">)</span>

<span class="tok-c1">// Find all the vertices that do not have a 'region' property</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasNot</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">)</span>

<span class="tok-c1">// The above is shorthand for</span>
 <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">not</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">))</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="count">3.2.3. Counting things</h4>
<div class="paragraph">
<p>A common need when working with graphs is to be able to count how "many of something"
there are in the graph. We will look in the next section at other ways to count
groups of things but first of all let’s look at some examples of using the <em>count</em>
step to count how many of various things there are in our <em>air-routes</em> graph. First of
all lets find out how many vertices in the graph represent airports.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// How many airports are there in the graph?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">3374</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, looking at edges that have a <em>route</em> label, let’s find out how many flight
routes are stored in the graph. Note that the <em>outE</em> step looks at outgoing edges. In
this case we could also have used the <em>out</em> step instead. The various ways that you
can look at outgoing and incoming edges is discussed in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#walk">Starting to walk the graph</a>" section that
is coming up soon.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// How many routes are there?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">43400</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You could shorten the above a little as follows but this would cause more edges to get
looked at as we do not first filter out all vertices that are not airports.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// How many routes are there?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">outE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">43400</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You could also do it this way but generally starting by looking at all the Edges in
the graph is considered bad form as property graphs tend to have a lot more edges
than vertices.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// How many routes are there?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">43400</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We have not yet looked at the <em>outE</em> step used above. We will look at it very soon
however in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#walk">Starting to walk the graph</a>" section.</p>
</div>
</div>
<div class="sect3">
<h4 id="countgroup">3.2.4. Counting groups of things</h4>
<div class="paragraph">
<p>Sometimes it is useful to count how many of each type (or group) of things there are
in the graph. This can be done using the <em>group</em> and <em>groupCount</em> steps. While for a
very large graph it is not recommended to run queries that look at all of the
vertices or all of the edges in a graph, for smaller graphs this can be quite useful.
For the air routes graph we could easily count the number of different vertex and
edge types in the graph as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// How many of each type of vertex are there?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">label</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we were to run the query we would get back a map where the keys are label names
and the values are the counts for the occurrence of each label in the graph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">continent:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">country:</span><span class="tok-mi">237</span><span class="tok-o">,</span><span class="tok-nl">version:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">airport:</span><span class="tok-mi">3374</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are other ways we could write the query above that will yield the same result.
One such example is shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// How many of each type of vertex are there?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">label</span><span class="tok-o">().</span><span class="tok-na">groupCount</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-nl">continent:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">country:</span><span class="tok-mi">237</span><span class="tok-o">,</span><span class="tok-nl">version:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">airport:</span><span class="tok-mi">3374</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also run a similar query to find out the distribution of edge labels in the
graph. An example of the type of result we would get back is also shown.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// How many of each type of edge are there?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">().</span><span class="tok-na">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">label</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">contains:</span><span class="tok-mi">6748</span><span class="tok-o">,</span><span class="tok-nl">route:</span><span class="tok-mi">43400</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As before we could rewrite the query as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// How many of each type of edge are there?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">().</span><span class="tok-na">label</span><span class="tok-o">().</span><span class="tok-na">groupCount</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-nl">contains:</span><span class="tok-mi">6748</span><span class="tok-o">,</span><span class="tok-nl">route:</span><span class="tok-mi">43400</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By way of a side note, the examples above are shorthand ways of writing
something like this example which also counts vertices by label.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// As above but using group()</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">label</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">count</span><span class="tok-o">())</span>

<span class="tok-o">[</span><span class="tok-nl">continent:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">country:</span><span class="tok-mi">237</span><span class="tok-o">,</span><span class="tok-nl">version:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">airport:</span><span class="tok-mi">3374</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can be more selective in how we specify the groups of things that we want to
count. In the examples below we first count how many airports there are in each
country. This will return a map of key:value pairs where the key is the country code
and the value is the number of airports in that country. As the fourth and fifth
examples show, we can use <em>select</em> to pick just a few values from the whole group
that got counted. Of course if we only wanted a single value we could just count the
airports connected to that country directly but the last two examples are intended to
show that you can count a group of things and still selectively only look at part of
that group.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// How many airports are there in each country?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">)</span>

<span class="tok-c1">// How many airports are there in each country? (look at country first)</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can easily find out how many airports there are in each continent using <em>group</em> to
build a map of continent codes and the number of airports in that continent. The
output from running the query is shown below also.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// How many airports are there in each continent?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'continent'</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">())</span>

<span class="tok-o">[</span><span class="tok-nl">EU:</span><span class="tok-mi">583</span><span class="tok-o">,</span><span class="tok-nl">AS:</span><span class="tok-mi">932</span><span class="tok-o">,</span><span class="tok-nl">NA:</span><span class="tok-mi">978</span><span class="tok-o">,</span><span class="tok-nl">OC:</span><span class="tok-mi">284</span><span class="tok-o">,</span><span class="tok-nl">AF:</span><span class="tok-mi">294</span><span class="tok-o">,</span><span class="tok-nl">AN:</span><span class="tok-mi">0</span><span class="tok-o">,</span><span class="tok-nl">SA:</span><span class="tok-mi">303</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>These queries show how <em>select</em> can be used to extract specific values from the map
that we have created. Again you can see the results we get from running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// How many airports are there in France (having first counted all countries)</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'FR'</span><span class="tok-o">)</span>

<span class="tok-mi">58</span>

<span class="tok-c1">// How many airports are there in France, Greece and Belgium respectively?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'FR'</span><span class="tok-o">,</span><span class="tok-s1">'GR'</span><span class="tok-o">,</span><span class="tok-s1">'BE'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">FR:</span><span class="tok-mi">58</span><span class="tok-o">,</span><span class="tok-nl">GR:</span><span class="tok-mi">39</span><span class="tok-o">,</span><span class="tok-nl">BE:</span><span class="tok-mi">5</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>group</em> and <em>groupCount</em> steps are very useful when you want to count
groups of things or collect things into a group using a selection criteria. You
will find a lot more examples of grouping and counting things in the section called
"<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#countmore">Counting more things</a>".</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="walk">3.3. Starting to walk the graph</h3>
<div class="paragraph">
<p>So far we have mostly just explored queries that look at properties on a vertex or
count how many things we can find of a certain type. Where the power of a graph
really comes into play is when we start to <em>walk</em> or <em>traverse</em> the graph by looking
at the connections (edges) between vertices. The term <em>walking the graph</em> is used to
describe moving from one vertex to another vertex via an edge. Typically when using
the phrase <em>walking a graph</em> the intent is to describe starting at a vertex
traversing one or more vertices and edges and ending up at a different vertex or
sometimes, back where you started in the case of a <em>circular walk</em>. It is very easy
to traverse a graph in this way using Gremlin. The journey we took while on our
<em>walk</em> is often referred to as our <em>path</em>. There are also cases when all you want to
do is return edges or some combination of vertices and edges as the result of a query
and Gremlin allows this as well. We will explore a lot of ways to modify the way a
graph is traversed in the upcoming sections.</p>
</div>
<div class="paragraph">
<p>The table below gives a brief summary of all the steps that can be used to <em>walk</em> or
<em>traverse</em> a graph using Gremlin. You will find all of these steps used in various
ways throughout the book. Think of a graph traversal as moving through the graph from
one place to one or more other places. These steps tell Gremlin which places to move
to next as it traverses a graph for you.</p>
</div>
<div class="paragraph">
<p>In order to better understand these steps it is worth defining some terminology. One
vertex is considered to be <em>adjacent</em> to another vertex if there is an edge
connecting them. A vertex and an edge are considered <em>incident</em> if they are
connected to each other.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Where to move next while traversing a graph</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">out   *</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Outgoing adjacent vertices.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">in    *</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Incoming adjacent vertices.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">both  *</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Both incoming and outgoing adjacent vertices.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">outE  *</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Outgoing incident edges.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">inE   *</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Incoming incident edges.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">bothE *</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Both outgoing and incoming incident edges.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">outV</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Outgoing vertex.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">inV</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Incoming vertex.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">otherV</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The vertex that was not the vertex we came from.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Note that the steps labelled with an <em>*</em> can optionally take the name of one or more
edge labels as a parameter. If omitted, all relevant edges will be traversed.</p>
</div>
<div class="sect3">
<h4 id="_some_simple_graph_traversal_examples">3.3.1. Some simple graph traversal examples</h4>
<div class="paragraph">
<p>To get us started, in this section we will look at some simple graph traversal
examples that use some of the steps that were just introduced. The <em>out</em> step is
used to find vertices connected by an outgoing edge to that vertex and the <em>outE</em>
<em>step</em> is used when you want to examine the outgoing edges from a given vertex.
Conversely the <em>in</em> and <em>inE</em> steps can be used to look for incoming vertices and
edges. The <em>outE</em> and <em>inE</em> steps are especially useful when you want to look at the
properties of an edge as we shall see in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#exedge">Examining the edge between two vertices</a>" section. There are several
other steps that we can use when traversing a graph to move between vertices and
edges. These include <em>bothE</em>, <em>bothV</em> and <em>otherV</em>. We will encounter those in the
"<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#otherv">Other ways to explore vertices and edges using <em>both</em>, <em>bothE</em>, <em>bothV</em> and <em>otherV</em></a>" section.</p>
</div>
<div class="paragraph">
<p>So let’s use a few examples to help better understand these graph traversal steps.
The first query below does a few interesting things. Firstly we find the vertex
representing the Austin airport (the airport with a property of <em>code</em> containing the
value <em>AUS</em>). Having found that vertex we then go <em>out</em> from there. This will find
all of the vertices connected to Austin by an outgoing edge. Having found those
airports we then ask for the values of their <em>code</em> properties using the <em>values</em>
step. Finally the <em>fold</em> step puts all of the results into a list for us. This just
makes it easier for us to inspect the results in the console.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Where can I fly to from Austin?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is what you might get back if you were to run this query in your console.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">YYZ</span><span class="tok-o">,</span> <span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-n">FRA</span><span class="tok-o">,</span> <span class="tok-n">MEX</span><span class="tok-o">,</span> <span class="tok-n">PIT</span><span class="tok-o">,</span> <span class="tok-n">PDX</span><span class="tok-o">,</span> <span class="tok-n">CLT</span><span class="tok-o">,</span> <span class="tok-n">CUN</span><span class="tok-o">,</span> <span class="tok-n">MEM</span><span class="tok-o">,</span> <span class="tok-n">CVG</span><span class="tok-o">,</span> <span class="tok-n">IND</span><span class="tok-o">,</span> <span class="tok-n">MCI</span><span class="tok-o">,</span> <span class="tok-n">DAL</span><span class="tok-o">,</span> <span class="tok-n">STL</span><span class="tok-o">,</span> <span class="tok-n">ABQ</span><span class="tok-o">,</span> <span class="tok-n">MDW</span><span class="tok-o">,</span> <span class="tok-n">LBB</span><span class="tok-o">,</span> <span class="tok-n">HRL</span><span class="tok-o">,</span> <span class="tok-n">GDL</span><span class="tok-o">,</span> <span class="tok-n">PNS</span><span class="tok-o">,</span> <span class="tok-n">VPS</span><span class="tok-o">,</span> <span class="tok-n">SFB</span><span class="tok-o">,</span> <span class="tok-n">BKG</span><span class="tok-o">,</span> <span class="tok-n">PIE</span><span class="tok-o">,</span> <span class="tok-n">ATL</span><span class="tok-o">,</span> <span class="tok-n">BNA</span><span class="tok-o">,</span> <span class="tok-n">BOS</span><span class="tok-o">,</span> <span class="tok-n">BWI</span><span class="tok-o">,</span> <span class="tok-n">DCA</span><span class="tok-o">,</span> <span class="tok-n">DFW</span><span class="tok-o">,</span> <span class="tok-n">FLL</span><span class="tok-o">,</span> <span class="tok-n">IAD</span><span class="tok-o">,</span> <span class="tok-n">IAH</span><span class="tok-o">,</span> <span class="tok-n">JFK</span><span class="tok-o">,</span> <span class="tok-n">LAX</span><span class="tok-o">,</span> <span class="tok-n">MCO</span><span class="tok-o">,</span> <span class="tok-n">MIA</span><span class="tok-o">,</span> <span class="tok-n">MSP</span><span class="tok-o">,</span> <span class="tok-n">ORD</span><span class="tok-o">,</span> <span class="tok-n">PHX</span><span class="tok-o">,</span> <span class="tok-n">RDU</span><span class="tok-o">,</span> <span class="tok-n">SEA</span><span class="tok-o">,</span> <span class="tok-n">SFO</span><span class="tok-o">,</span> <span class="tok-n">SJC</span><span class="tok-o">,</span> <span class="tok-n">TPA</span><span class="tok-o">,</span> <span class="tok-n">SAN</span><span class="tok-o">,</span> <span class="tok-n">LGB</span><span class="tok-o">,</span> <span class="tok-n">SNA</span><span class="tok-o">,</span> <span class="tok-n">SLC</span><span class="tok-o">,</span> <span class="tok-n">LAS</span><span class="tok-o">,</span> <span class="tok-n">DEN</span><span class="tok-o">,</span> <span class="tok-n">MSY</span><span class="tok-o">,</span> <span class="tok-n">EWR</span><span class="tok-o">,</span> <span class="tok-n">HOU</span><span class="tok-o">,</span> <span class="tok-n">ELP</span><span class="tok-o">,</span> <span class="tok-n">CLE</span><span class="tok-o">,</span> <span class="tok-n">OAK</span><span class="tok-o">,</span> <span class="tok-n">PHL</span><span class="tok-o">,</span> <span class="tok-n">DTW</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>All edges in a graph have a label. However, one thing we did not do in the previous
query was specify a label for the <em>out</em> step. If you do not specify a label you will
get back any connected vertex regardless of its edge label. In this case it does not
cause us a problem as airports only have one type of outgoing edge, labeled <em>route</em>.
However, in many cases, in graphs you create or are working with, your vertices may be
connected to other vertices by edges with differing labels so it is good
practice to get into the habit of specifying edge labels as part of your Gremlin
queries. So we could change our query just a bit by adding a label reference on the
<em>out</em> step as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Where can I fly to from Austin?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Despite having just stated that consistently using edge labels in queries is a good
idea, unless you truly do want to get back all edges or all connected vertices, I
will break my own rule quite a bit in this book. The reason for this is purely to
save space and make the queries I present shorter.</p>
</div>
<div class="paragraph">
<p>Here are a few more simple queries similar to the previous one. The first example can
be used to answer the question "Where can I fly to from Austin, with one stop on the
way?". Note that, as written, coming back to Austin will be included in the results
as this query does not rule it out!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Where can I fly to from Austin, with one stop on the way?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This query uses an <em>in</em> step to find all the routes that come into the London City
Airport (LCY) and returns their IATA codes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// What routes come in to LCY?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LCY'</span><span class="tok-o">).</span><span class="tok-na">in</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This query is perhaps a bit more interesting. It finds all the routes from London
Heathrow airport in England that go to an airport in the United States and returns
their IATA codes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Flights from London Heathrow (LHR) to airports in the USA</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'US'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="pathintro">3.3.2. What vertices and edges did I visit? - Introducing <em>path</em></h4>
<div class="paragraph">
<p>A Gremlin method (often called a step) that you will see used a lot in this book is
<em>path</em>. After you have done some graph walking using a query you can use <em>path</em> to
get a summary back of where you went. A simple example of a <em>path</em> step being used is
shown below. Throughout the book you will see numerous examples of <em>path</em> being used
including in conjunction with one or more <em>by</em> steps to specify how the path result
should be formatted.</p>
</div>
<div class="paragraph">
<p>This particular query will return the vertices and outgoing edges starting at the
London City (LCY) airport vertex. You can read this query like this: "Start at the
LCY vertex, find all outgoing edges and also find all of the vertices that are on the
other ends of those edges". The <em>inV</em> step gives us the vertex at the other end of
the outgoing edge.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// This time, for each route, return both vertices and the edge that connects them.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LCY'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run that query as-is you will get back a series of results that look
like this. This shows that there is a route from vertex 88 to vertex 77 via an
edge with an ID of 13698.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">88</span><span class="tok-o">],</span><span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">13698</span><span class="tok-o">][</span><span class="tok-mi">88</span><span class="tok-o">-</span><span class="tok-n">route</span><span class="tok-o">-&gt;</span><span class="tok-mi">77</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">77</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>While this result is useful, we might want to return something more human readable
such as the IATA codes for each airport and perhaps the distance property from the
edge that tells us how far apart the airports are. We could add some <em>by</em> modulators
to our query to do this. The Apache TinkerPop documentation uses the phrase
<em>modulator</em> to describe steps that are not really independent steps but instead alter
the behavior of the steps that they are associated with.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
A <em>modulator</em> is a step that influences the behavior of the step that it is
associated with. Examples of such modulator steps are <em>by</em> and <em>as</em>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Take a look at the modified form of the query shown below and an example of the
results that it will now return. If this is not fully clear yet don’t panic. Both
<em>path</em> and <em>by</em> are used a lot throughout this book.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LCY'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">inV</span><span class="tok-o">().</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When you run this modified version of the query, you will receive a set of results
that look like the following line.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">LCY</span><span class="tok-o">,</span><span class="tok-mi">456</span><span class="tok-o">,</span><span class="tok-n">GVA</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>by</em> modulator steps are processed in a round robin fashion. If there are not
enough modulators specified for the total number of elements in the path, Gremlin
just loops back around to the first <em>by</em> step and so on. So even though there were
three elements in the path that we wanted to have formatted, we only needed to
specify two <em>by</em> modulators. This is because the first and third elements in the path
are of the same type, namely airport vertices, and we wanted to use the same property
name, <em>code</em>, in each of those cases. If we instead wanted to reference a different
property name for each element of the path result, we would need to specify three
explicit <em>by</em> modulator steps. This would be required if, for example, we wanted to
reference the <em>city</em> property of the third element in the path rather than its
<em>code</em>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <em>by</em> modulator steps are processed in a round robin fashion in cases where
there are more results to apply them to than <em>by</em> modulators specified.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The example above is equivalent to this longer form of the same query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LCY'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">inV</span><span class="tok-o">().</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The example below shows a case where three different <em>by</em> modulators are used. This
time the third <em>by</em> modulator step references the <em>city</em> property rather than the
airport <em>code</em>. As you can see from the sample output, this time the city name
<em>Geneva</em> appears rather than the airport code <em>GVA</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LCY'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">inV</span><span class="tok-o">().</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span>


<span class="tok-o">[</span><span class="tok-n">LCY</span><span class="tok-o">,</span><span class="tok-mi">456</span><span class="tok-o">,</span><span class="tok-n">Geneva</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Sometimes it is necessary to use a <em>by</em> modulator that has no parameter as shown
below. This is because the element in the path is not a vertex or edge containing multiple
properties but rather a single value, in this case, an integer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LCY'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The results show the codes for the airports we visited along with a number
representing the number of runways the second airport has.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">LCY</span><span class="tok-o">,</span><span class="tok-n">AGP</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LCY</span><span class="tok-o">,</span><span class="tok-n">ABZ</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LCY</span><span class="tok-o">,</span><span class="tok-n">JER</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LCY</span><span class="tok-o">,</span><span class="tok-n">BSL</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LCY</span><span class="tok-o">,</span><span class="tok-n">BHD</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is also possible to use a traversal inside of a <em>by</em> modulator. Such traversals
are known as <em>"anonymous traversals"</em> as they do not include a beginning <em>V</em> or <em>E</em>
step.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Traversals that do not start with a <em>V</em> or <em>E</em> step are referred to as
<em>"anonymous traversals"</em>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>This capability allows us to do things like combine multiple values together as part
of a path result. The example below finds five routes that start in Austin and
creates a path result containing the airport code and city name for both the source
and destination airports. In this case, the anonymous traversal contained within the
<em>by</em> modulator is applied to each element in the path.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">())</span>

<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">Austin</span><span class="tok-o">],[</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">Toronto</span><span class="tok-o">]]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">Austin</span><span class="tok-o">],[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">London</span><span class="tok-o">]]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">Austin</span><span class="tok-o">],[</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-n">Frankfurt</span><span class="tok-o">]]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">Austin</span><span class="tok-o">],[</span><span class="tok-n">MEX</span><span class="tok-o">,</span><span class="tok-n">Mexico</span> <span class="tok-n">City</span><span class="tok-o">]]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">Austin</span><span class="tok-o">],[</span><span class="tok-n">PIT</span><span class="tok-o">,</span><span class="tok-n">Pittsburgh</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To demonstrate that just about any arbitrary traversal can be placed inside the <em>by</em>
modulator here is one more example that counts the number of outgoing routes for the
source and destination airports as part of generating the <em>path</em> result.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">())</span>

<span class="tok-o">[</span><span class="tok-mi">59</span><span class="tok-o">,</span><span class="tok-mi">181</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">59</span><span class="tok-o">,</span><span class="tok-mi">191</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">59</span><span class="tok-o">,</span><span class="tok-mi">272</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">59</span><span class="tok-o">,</span><span class="tok-mi">105</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">59</span><span class="tok-o">,</span><span class="tok-mi">54</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="pathfromto">3.3.3. Modifying a <em>path</em> using <em>from</em> and <em>to</em> modulators</h4>
<div class="paragraph">
<p>In Apache TinkerPop version 3.2.5 the ability to limit what is returned by the <em>path</em>
step using <em>from</em> and <em>to</em> modulators was added. This enables us to not return the
entire path of a traversal but instead to be more selective.</p>
</div>
<div class="paragraph">
<p>First of all, look at the example below. In this case I have just used the same
<em>path</em> constructs used in the prior examples. The query returns the first 10 routes
found starting at Austin (AUS) with one stop on the way.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As expected the results show each airport that was visited.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YVR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">NRT</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">DEL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">DUB</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">HKG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">PEK</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Given that every journey starts in Austin, we might not actually want the AUS
airport code to be part of the returned results. We might just want to capture the
places that we ended up visiting after leaving Austin. This can be achieved by
labelling the parts of the traversal that we care about using <em>as</em> steps and then
using <em>from</em> and <em>to</em> modulators to tell the <em>path</em> step what we are interested in.
Take a look at the modified version of the query below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This time AUS is not included in the <em>path</em> results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YVR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">NRT</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">DEL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">DUB</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">HKG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">PEK</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Because after skipping the AUS part of the path we did in fact want the rest of the
results we could have left off the <em>to</em> modulator and written the query as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the results are the same as before.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YVR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">NRT</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">DEL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">DUB</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">HKG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">PEK</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Obviously there are a lot of ways that <em>from</em> and <em>to</em> can be used. By way of one
final example, let’s create a version of the query with three <em>out</em> steps. Note that
a bit later we will see how <em>repeat</em> can be used when the same steps need to be used
repeatedly like this but that is not important to this specific example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As expected we now have an additional stop added to each of the journeys.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">BNA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">DCA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">FLL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">IAD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s now modify the query to limit which parts of the path are returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, only the parts of the journey that we selected have been returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could also have written the query as shown below to only show the results of each
path up to a certain point.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This time only the first three airports visited are included in each result.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By way of a side note, in cases like this where more than one of the results is
identical, you may want to remove the duplicates. That is where the <em>dedup</em> step is
useful. You will find coverage of <em>dedup</em> in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#dedup">Removing duplicates - introducing <em>dedup</em></a>" section. However, as a
little taste test, let’s add a <em>dedup</em> step to the end of our previous query and see
what happens.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">dedup</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see all of the duplicate results have now been removed. Hopefully this
gives you a good basic understanding of the <em>path</em> step. You will see it used a lot
throughout the remainder of this book. However, there are a few things to be aware of
when using <em>path</em>. Those concerns are explained in the <a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#pathwarn">A warning that path finding can be memory and CPU intensive</a> section a bit
later.</p>
</div>
</div>
<div class="sect3">
<h4 id="edgeexist">3.3.4. Does an edge exist between two vertices?</h4>
<div class="paragraph">
<p>You can use the <em>hasNext</em> step to check if an edge exists between two vertices and
get a Boolean (true or false) value back. The first query below will return
<strong>true</strong> because there is an edge (a route) between AUS and DFW. The second
query will return <strong>false</strong> because there is no route between AUS and SYD.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">hasNext</span><span class="tok-o">()</span>

<span class="tok-kc">true</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SYD'</span><span class="tok-o">).</span><span class="tok-na">hasNext</span><span class="tok-o">()</span>

<span class="tok-kc">false</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="aselproj">3.3.5. Using <em>as</em>, <em>select</em> and <em>project</em> to refer to traversal steps</h4>
<div class="paragraph">
<p>Sometimes it is useful to be able to remember a point of a traversal by giving it a
name (label) and refer to it later on in the same query. This ability was more
essential in TinkerPop 2 than it is in TinkerPop 3 but it still has many uses. The
query below uses an <em>as</em> step to attach a label at two different parts of the
traversal, each representing different vertices that were found. A <em>select</em> step is
later used to refer back to them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'from'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-CA'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'to'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'from'</span><span class="tok-o">,</span><span class="tok-s1">'to'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This query, while a bit contrived, and in this case probably a poor substitute for
using <em>path</em>, returns the following results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">from:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">],</span><span class="tok-nl">to:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">13</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">from:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">],</span><span class="tok-nl">to:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">23</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">from:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">],</span><span class="tok-nl">to:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">24</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">from:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">],</span><span class="tok-nl">to:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">26</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">from:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">],</span><span class="tok-nl">to:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">28</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">from:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">],</span><span class="tok-nl">to:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">42</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">from:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">],</span><span class="tok-nl">to:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">151</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">from:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">],</span><span class="tok-nl">to:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">181</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">from:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">],</span><span class="tok-nl">to:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">244</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">from:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">],</span><span class="tok-nl">to:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">384</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">from:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">],</span><span class="tok-nl">to:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">877</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above only the vertices themselves were selected. We can also use a
<em>by</em> modulator to specify which property to retrieve from the selected
vertices.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'from'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-CA'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'to'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'from'</span><span class="tok-o">,</span><span class="tok-s1">'to'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This time the results contain the airport codes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">from:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">to:</span><span class="tok-n">LAX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">from:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">to:</span><span class="tok-n">SFO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">from:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">to:</span><span class="tok-n">SJC</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">from:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">to:</span><span class="tok-n">SAN</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">from:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">to:</span><span class="tok-n">SNA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">from:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">to:</span><span class="tok-n">OAK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">from:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">to:</span><span class="tok-n">ONT</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">from:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">to:</span><span class="tok-n">PSP</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">from:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">to:</span><span class="tok-n">SMF</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">from:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">to:</span><span class="tok-n">FAT</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">from:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">to:</span><span class="tok-n">SBA</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>While the prior example was perhaps not ideal, it does show how <em>as</em> and <em>select</em>
work. For completeness, here is the same query but using <em>path</em>. You will see both
the <em>select</em> and <em>path</em> steps used a lot throughout this book.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-CA'</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Which would produce the following results. Notice that this time the results do not
have labels associated with them but are otherwise the same.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">ONT</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">PSP</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">SJC</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">SAN</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">SNA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">OAK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">SMF</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">FAT</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">SBA</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>While the <em>path</em> step is a lot more convenient, in some cases it can be very
expensive in terms of memory and CPU usage so it is worth remembering these
alternative techniques using <em>as</em> and <em>select</em>. That topic is discussed in more
detail in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#pathwarn">A warning that path finding can be memory and CPU intensive</a> section.</p>
</div>
<div class="paragraph">
<p>You can also give a point of a traversal multiple names and refer to each later on in
the traversal/query as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'type'</span><span class="tok-o">,</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">,</span><span class="tok-s1">'c'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">,</span><span class="tok-s1">'c'</span><span class="tok-o">).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the most recent releases of TinkerPop you can also use the new <em>project</em> step and
achieve the same results that you can get from the combination of <em>as</em> and <em>select</em>
steps. The example below shows the previous query, rewritten to use <em>project</em> instead
of <em>as</em> and <em>select</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'type'</span><span class="tok-o">,</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">,</span><span class="tok-s1">'c'</span><span class="tok-o">).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This query, and the prior query, would return the following results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">GA</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-mi">232</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">AK</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-mi">39</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-mi">59</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">BNA</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TN</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-mi">55</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">MA</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-mi">129</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">BWI</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">MD</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-mi">89</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">DCA</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">DC</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-mi">93</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-mi">221</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">FLL</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">FL</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-mi">141</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">IAD</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">VA</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-mi">136</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the prior example we gave our variables simple names like <em>a</em> and <em>b</em>. However, it
is sometimes useful to give our traversal variables and named steps more meaningful
names and it is perfectly OK to do that. Let’s rewrite the query to use some more
descriptive variable names.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'type'</span><span class="tok-o">,</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
       <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'IATA'</span><span class="tok-o">,</span><span class="tok-s1">'Region'</span><span class="tok-o">,</span><span class="tok-s1">'Routes'</span><span class="tok-o">).</span>
         <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When we run the modified query, here is the output we get.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">IATA:</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-nl">Region:</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">GA</span><span class="tok-o">,</span><span class="tok-nl">Routes:</span><span class="tok-mi">232</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">IATA:</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-nl">Region:</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">AK</span><span class="tok-o">,</span><span class="tok-nl">Routes:</span><span class="tok-mi">39</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">IATA:</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-nl">Region:</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span><span class="tok-o">,</span><span class="tok-nl">Routes:</span><span class="tok-mi">59</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">IATA:</span><span class="tok-n">BNA</span><span class="tok-o">,</span><span class="tok-nl">Region:</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TN</span><span class="tok-o">,</span><span class="tok-nl">Routes:</span><span class="tok-mi">55</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">IATA:</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-nl">Region:</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">MA</span><span class="tok-o">,</span><span class="tok-nl">Routes:</span><span class="tok-mi">129</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">IATA:</span><span class="tok-n">BWI</span><span class="tok-o">,</span><span class="tok-nl">Region:</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">MD</span><span class="tok-o">,</span><span class="tok-nl">Routes:</span><span class="tok-mi">89</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">IATA:</span><span class="tok-n">DCA</span><span class="tok-o">,</span><span class="tok-nl">Region:</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">DC</span><span class="tok-o">,</span><span class="tok-nl">Routes:</span><span class="tok-mi">93</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">IATA:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">Region:</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span><span class="tok-o">,</span><span class="tok-nl">Routes:</span><span class="tok-mi">221</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">IATA:</span><span class="tok-n">FLL</span><span class="tok-o">,</span><span class="tok-nl">Region:</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">FL</span><span class="tok-o">,</span><span class="tok-nl">Routes:</span><span class="tok-mi">141</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">IATA:</span><span class="tok-n">IAD</span><span class="tok-o">,</span><span class="tok-nl">Region:</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">VA</span><span class="tok-o">,</span><span class="tok-nl">Routes:</span><span class="tok-mi">136</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="multias">3.3.6. Using multiple <em>as</em> steps with the same label</h4>
<div class="paragraph">
<p>It is actually possible using an <em>as</em> step to give more than one part of a traversal
the same label (name). In the example below, the label <em>'a'</em> is used
twice but you will notice that when the label is selected only the last item added is
returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">)</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are some special keywords that can be used in conjunction with the <em>select</em>
step in cases like this one. These keywords are <em>first</em>, <em>last</em> and <em>all</em> and their
usage is shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">first</span><span class="tok-o">,</span><span class="tok-s1">'a'</span><span class="tok-o">)</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">]</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">last</span><span class="tok-o">,</span><span class="tok-s1">'a'</span><span class="tok-o">)</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">all</span><span class="tok-o">,</span><span class="tok-s1">'a'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is another example of a query that labels two different parts of a traversal
with the same <em>'a'</em> label. As you can see from the results, only the
second one is used because of the <em>last</em> keyword that is provided on the <em>select</em>
step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">last</span><span class="tok-o">,</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-n">MEX</span><span class="tok-o">,</span><span class="tok-n">PIT</span><span class="tok-o">,</span><span class="tok-n">PDX</span><span class="tok-o">,</span><span class="tok-n">CLT</span><span class="tok-o">,</span><span class="tok-n">CUN</span><span class="tok-o">,</span><span class="tok-n">MEM</span><span class="tok-o">,</span><span class="tok-n">CVG</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the same query but using the <em>first</em> keyword this time as part of the
<em>select</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">first</span><span class="tok-o">,</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that when the same name is used to label a step, the data structure created by
Gremlin is essentially a List. As such, the <em>by</em> modulator cannot be used when the
<em>all</em> keyword is used on the <em>select</em> step. To get the values of each element in the
list we can use an <em>unfold</em> step as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">all</span><span class="tok-o">,</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span>
 <span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-n">MEX</span><span class="tok-o">,</span><span class="tok-n">PIT</span><span class="tok-o">,</span><span class="tok-n">PDX</span><span class="tok-o">,</span><span class="tok-n">CLT</span><span class="tok-o">,</span><span class="tok-n">CUN</span><span class="tok-o">,</span><span class="tok-n">MEM</span><span class="tok-o">,</span><span class="tok-n">CVG</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Keywords such as <em>all</em>, <em>first</em> and <em>last</em> are discussed further in the
"<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#javastatics">Important Classes and Enums to be aware of</a>" section later on in the book.</p>
</div>
</div>
<div class="sect3">
<h4 id="pathselect">3.3.7. Returning selected parts of a path</h4>
<div class="paragraph">
<p>Sometimes, even using the <em>from</em> and <em>to</em> modulating steps along with a <em>path</em> step
will not give you the results you are interested in. Using a <em>select</em> step and some
<em>as</em> steps in a similar way to the example in the previous section we can select
specific parts of a traversal’s "path". Consider the query below that finds a route
from Los Angeles (LAX) and returns the path.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LAX'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span>
      <span class="tok-n">out</span><span class="tok-o">().</span>
      <span class="tok-n">out</span><span class="tok-o">().</span>
      <span class="tok-n">out</span><span class="tok-o">().</span>
      <span class="tok-n">out</span><span class="tok-o">().</span>
      <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-n">YYC</span><span class="tok-o">,</span><span class="tok-n">BNA</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">ZRH</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, imagine we want to just return every other stop as the result from our query.
The example below shows how to do just that.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LAX'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'stop'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'stop'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'stop'</span><span class="tok-o">).</span>
      <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">all</span><span class="tok-o">,</span><span class="tok-s1">'stop'</span><span class="tok-o">).</span>
      <span class="tok-n">unfold</span><span class="tok-o">().</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">YYC</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">,</span><span class="tok-n">ZRH</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="exedge">3.3.8. Examining the edge between two vertices</h4>
<div class="paragraph">
<p>Sometimes, it is the edge between two vertices that we are interested in examining
and not the vertices themselves. Typically this is because we want to look at one or
more properties associated with that edge. By way of an example, let’s imagine we
wanted to know how many miles the flight is between Miami (MIA) and Dallas Fort Worth
(DFW). In our air routes graph, the distances between vertices are stored using a
property called <em>dist</em> on any edge that has a <em>route</em> label. We can use the <em>outE</em>
and <em>inV</em> steps to find the edge connecting Miami and Dallas. We can also use the
<em>select</em> and <em>as</em> steps that we just learned about to help with this task. Take a
look at the query below. This will find the outgoing <em>route</em> edge from MIA to DFW,
store it in the traversal variable <em>e</em> and at the end of the query use <em>select</em> to
return it as the result of the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'MIA'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we were to run the query, we would get back something similar to this</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">4127</span><span class="tok-o">][</span><span class="tok-mi">16</span><span class="tok-o">-</span><span class="tok-n">route</span><span class="tok-o">-&gt;</span><span class="tok-mi">8</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So we found the <em>route</em> edge that connects the vertex with an ID of 16 (MIA) with the
airport that has an ID of 8 (DFW). While interesting, this is not exactly what we set
out to achieve. What we actually are interested in is the distance property of that
edge so we can see how far it is from Miami to Dallas Fort Worth. We need to add one
additional step to our query that will look at the <em>dist</em> property of the edge. Let’s
modify our query to do that.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'MIA'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">).</span>
      <span class="tok-n">inV</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we run the query again we get back what we were looking for. We can see that it is
1,120 miles from Miami to Dallas Fort Worth.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-mi">1120</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As a side note, we could have written the query using <em>inE</em> and <em>outV</em> and achieved
the same result by looking at the edge from Dallas to Miami.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'MIA'</span><span class="tok-o">).</span><span class="tok-na">inE</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">).</span>
      <span class="tok-n">outV</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)</span>

<span class="tok-mi">1120</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Throughout the remainder of the book you will find lots of examples that use steps
such as <em>outE</em>, <em>inE</em>, <em>outV</em> and <em>inV</em>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="limit">3.4. Limiting the amount of data returned</h3>
<div class="paragraph">
<p>It is sometimes useful, especially when dealing with large graphs, to limit
the amount of data that is returned from a query. As shown in the examples
below, this can be done using the <em>limit</em> and <em>tail</em> steps. A little later in
this book we also introduce the <em>coin</em> step that allows a pseudo random
sample of the data to be returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Only return the FIRST 20 results</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">20</span><span class="tok-o">)</span>

<span class="tok-c1">// Only return the LAST 20 results</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">tail</span><span class="tok-o">(</span><span class="tok-mi">20</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Depending upon the implementation, it is probably more efficient to write the
query like this, with <em>limit</em> coming before <em>values</em> to guarantee fewer airports
are initially returned but it is also possible that an implementation would
optimize both the same way.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Only return the FIRST 20 results</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">20</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <em>limit</em> provides a shorthand alternative to <em>range</em>. The first of
the two examples above could have been written as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Only return the FIRST 20 results</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">range</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">,</span><span class="tok-mi">20</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also limit a traversal by specifying a maximum amount of time that it is
allowed to run for. The following query is restricted to a maximum limit of ten
milliseconds. The query looks for routes from Austin (AUS) to London Heathrow (LHR).
All the parts of this query are explained in detail later on in this book but I think
what they do is fairly clear. The <em>repeat</em> step is explained in detail in the
"<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#sp">Shortest paths (between airports) - introducing <em>repeat</em></a>" section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Limit the query to however much can be processed within 10 milliseconds</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">timeLimit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">()).</span><span class="tok-na">until</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">)).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is what the query above returned when run on my laptop.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">MEX</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we give the query another 10 milliseconds to run, so 20 in total, you can see that
a few more routes were found.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Limit the query to 20 milliseconds</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">timeLimit</span><span class="tok-o">(</span><span class="tok-mi">20</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">()).</span><span class="tok-na">until</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">)).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">MEX</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">PDX</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">CLT</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="retrrange">3.4.1. Retrieving a range of vertices</h4>
<div class="paragraph">
<p>Gremlin provides various ways to return a sequence of vertices. We have already seen
the <em>limit</em> and <em>range</em> steps used in the previous section to return the first 20
elements of a query result. We can also use the <em>range</em> step to select different
range of vertices by giving a non zero starting offset and an ending offset. The
<em>range</em> offsets are zero based, and while the official documentation states that the
ranges are inclusive/inclusive it actually appears from my testing that they are
inclusive/exclusive.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Return the first two airport vertices found</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">range</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">)</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">]</span>
<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The starting value given to a <em>range</em> step does not have to be <em>0</em>. In the example
below we ask for the 3rd, 4th and 5th results found by specifying a range of
<em>"(3,6)"</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Return the fourth, fifth and sixth airport vertices found (zero based)</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">range</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">)</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">5</span><span class="tok-o">]</span>
<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">6</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example of how we can use the index <em>-1</em> to mean <em>"until the end of the
list"</em>. This is similar to the convention used in many programming languages when
working with arrays and list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Return all the remaining vertices starting at the 3500th one</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">range</span><span class="tok-o">(</span><span class="tok-mi">3500</span><span class="tok-o">,-</span><span class="tok-mi">1</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is another example that uses the <em>range</em> step, this time looking only at
vertices with a label of <em>country</em>. Notice how this time we found vertices with much
higher ID values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">).</span><span class="tok-na">range</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">)</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3376</span><span class="tok-o">]</span>
<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3377</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There is no guarantee as to which airport vertices will be selected as this
depends upon how they are stored by the back end graph. Using TinkerGraph the
airports will most likely come back in the order they are put into the graph. This is
not likely to be the case with other graph stores such as JanusGraph. So do not rely
on any sort of expectation of order when using <em>range</em> to process sets of vertices.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>In TinkerPop 3.3 a new <em>skip</em> step was introduced which can be used as an alternative
to <em>range</em> in some cases. The <em>skip</em> step can be used whenever you would otherwise
use <em>range</em> where the second parameter would be <em>-1</em> meaning "all remaining".</p>
</div>
<div class="paragraph">
<p>The two examples below will produce the same results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">).</span><span class="tok-na">skip</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">).</span><span class="tok-na">range</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">,-</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the output you might get from running either query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">39</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">186</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">273</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">278</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">289</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">314</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">356</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">357</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">358</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">361</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">368</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">370</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">390</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">394</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">404</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">405</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">423</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">426</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">428</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">1118</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3313</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To prove that the <em>skip</em> and <em>range</em> steps used above worked again, we can run the
query again with <em>skip</em> removed and look at the results. You will notice, the first
five vertices listed were not included as part of the results from the prior
queries.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">11</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">33</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">38</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">39</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">186</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">273</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">278</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">289</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">314</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">356</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">357</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">358</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">361</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">368</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">370</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">390</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">394</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">404</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">405</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">423</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">426</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">428</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">1118</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3313</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use the <em>local</em> keyword to have <em>skip</em> work on an incoming collection
within a traversal. The example below, while contrived, applies skip to the list
generated by the <em>fold</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">().</span><span class="tok-na">skip</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">33</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">38</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">39</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">186</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">273</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">278</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">289</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">314</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">356</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">357</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">358</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">361</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">368</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">370</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">390</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">394</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">404</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">405</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">423</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">426</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">428</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">1118</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3313</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are many other ways to specify a range of values using Gremlin. You will find
several additional examples in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#tranges">Testing values and ranges of values</a>" section.</p>
</div>
</div>
<div class="sect3">
<h4 id="dedup">3.4.2. Removing duplicates - introducing <em>dedup</em></h4>
<div class="paragraph">
<p>It is often desirable to remove duplicate values from query results. The <em>dedup</em> step
allows us to do this. If you are already familiar with Groovy collections, the
<em>dedup</em> step is similar to the <em>unique</em> method that Groovy provides. In the example
below, the number of runways for every airport in England is queried. Note that in
the returned results there are many duplicate values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'GB-ENG'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we only wanted a set of unique values in the result we could rewrite the query to
include a <em>dedup</em> step. This time the query results only include one of each value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'GB-ENG'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">dedup</span><span class="tok-o">().</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is also possible to use a <em>by</em> modulator to specify how <em>dedup</em> should be applied.
In the example below we only return one airport for each unique number of runways.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'GB-ENG'</span><span class="tok-o">).</span><span class="tok-na">dedup</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-n">LCY</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">BLK</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-n">LEQ</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There is one more form of the <em>dedup</em> step. In this form, one or more strings
representing labelled steps are provided as parameters. Take a look first of all at
the query below. It finds vertex <em>V(3)</em> and labels it <em>'a'</em>. It then
finds vertex <em>V(4)</em> and labels it <em>'c'</em>. Next it finds all the vertices
connected to V(4) and labels those <em>'b'</em>. Only the first 10 are
retrieved. Lastly a <em>select</em> step is used to return the results. As expected vertices
3 and 4 are present in all of the results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">4</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'c'</span><span class="tok-o">).</span><span class="tok-na">both</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
  <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">,</span><span class="tok-s1">'c'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-nl">b:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">],</span><span class="tok-nl">c:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-nl">b:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-nl">c:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-nl">b:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">5</span><span class="tok-o">],</span><span class="tok-nl">c:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-nl">b:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">6</span><span class="tok-o">],</span><span class="tok-nl">c:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-nl">b:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">7</span><span class="tok-o">],</span><span class="tok-nl">c:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-nl">b:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">],</span><span class="tok-nl">c:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-nl">b:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">9</span><span class="tok-o">],</span><span class="tok-nl">c:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-nl">b:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">10</span><span class="tok-o">],</span><span class="tok-nl">c:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-nl">b:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">11</span><span class="tok-o">],</span><span class="tok-nl">c:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-nl">b:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">12</span><span class="tok-o">],</span><span class="tok-nl">c:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Taking the same query but adding a <em>dedup</em> step that references the <em>'a'</em>
and <em>'c'</em> labels, removes all duplicate references that include those
vertices from the results so this time even though a <em>limit</em> of 10 is used we only
actually get one result back.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">4</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'c'</span><span class="tok-o">).</span><span class="tok-na">both</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
  <span class="tok-n">dedup</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'c'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">,</span><span class="tok-s1">'c'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-nl">b:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">],</span><span class="tok-nl">c:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A bit later we will take a look at the concept of <em>local</em> scope when working with
traversals. There are some examples of <em>local</em> scope being used in conjunction with
<em>dedup</em> in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#localcollect">Using <em>local</em> scope with collections</a>" section.</p>
</div>
<div class="paragraph">
<p>It is also possible to use <em>sets</em> to achieve similar results as we shall see in some
of the following sections such as the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#setsandlists">Introducing <em>toList</em>, <em>toSet</em>, <em>bulkSet</em> and <em>fill</em></a> section that is coming up
soon.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="vm">3.5. Using <em>valueMap</em> to explore the properties of a vertex or edge</h3>
<div class="paragraph">
<p>A call to <em>valueMap</em> will return all of the properties of a vertex or edge as an
array of key:value pairs. Basically what in Java terms is called a HashMap. You can
also select which properties you want <em>valueMap</em> to return if you do not want them
all. Each element in the map can be addressed using the name of the key. By default
the ID and label are not included in the map unless a parameter of <em>true</em> is
provided.</p>
</div>
<div class="paragraph">
<p>The query below will return the keys and values for all properties associated with
the Austin airport vertex.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Return all the properties and values the AUS vertex has</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">().</span><span class="tok-na">unfold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are using the Gremlin console, the output from running the previous command
should look something like this. The unfold step at the end of the query is used
to make the results easier to read.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">country</span><span class="tok-o">=[</span><span class="tok-n">US</span><span class="tok-o">]</span>
<span class="tok-n">code</span><span class="tok-o">=[</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-n">longest</span><span class="tok-o">=[</span><span class="tok-mi">12250</span><span class="tok-o">]</span>
<span class="tok-n">city</span><span class="tok-o">=[</span><span class="tok-n">Austin</span><span class="tok-o">]</span>
<span class="tok-n">elev</span><span class="tok-o">=[</span><span class="tok-mi">542</span><span class="tok-o">]</span>
<span class="tok-n">icao</span><span class="tok-o">=[</span><span class="tok-n">KAUS</span><span class="tok-o">]</span>
<span class="tok-n">lon</span><span class="tok-o">=[-</span><span class="tok-mf">97.6698989868164</span><span class="tok-o">]</span>
<span class="tok-n">type</span><span class="tok-o">=[</span><span class="tok-n">airport</span><span class="tok-o">]</span>
<span class="tok-n">region</span><span class="tok-o">=[</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span><span class="tok-o">]</span>
<span class="tok-n">runways</span><span class="tok-o">=[</span><span class="tok-mi">2</span><span class="tok-o">]</span>
<span class="tok-n">lat</span><span class="tok-o">=[</span><span class="tok-mf">30.1944999694824</span><span class="tok-o">]</span>
<span class="tok-n">desc</span><span class="tok-o">=[</span><span class="tok-n">Austin</span> <span class="tok-n">Bergstrom</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Notice how each key, like <em>country</em>, is followed by a value that is returned as
an element of a list. This is because it is possible (for vertices but not for edges)
to provide more than one property value for a given key by encoding them as a list or
as a set. In the Apache TinkerPop release 3.4 some changes were introduced to make
it easier to control how these results are returned. Those changes are discussed in
the next section.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Here are some more examples of how <em>valueMap</em> can be used. If a parameter of <em>true</em>
is provided, then the results returned will include the ID and label of the element
being examined.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// If you also want the ID and label, add a parameter of true</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">()</span>

<span class="tok-n">id</span><span class="tok-o">=</span><span class="tok-mi">3</span>
<span class="tok-n">label</span><span class="tok-o">=</span><span class="tok-n">airport</span>
<span class="tok-n">country</span><span class="tok-o">=[</span><span class="tok-n">US</span><span class="tok-o">]</span>
<span class="tok-n">code</span><span class="tok-o">=[</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-n">longest</span><span class="tok-o">=[</span><span class="tok-mi">12250</span><span class="tok-o">]</span>
<span class="tok-n">city</span><span class="tok-o">=[</span><span class="tok-n">Austin</span><span class="tok-o">]</span>
<span class="tok-n">elev</span><span class="tok-o">=[</span><span class="tok-mi">542</span><span class="tok-o">]</span>
<span class="tok-n">icao</span><span class="tok-o">=[</span><span class="tok-n">KAUS</span><span class="tok-o">]</span>
<span class="tok-n">lon</span><span class="tok-o">=[-</span><span class="tok-mf">97.6698989868164</span><span class="tok-o">]</span>
<span class="tok-n">type</span><span class="tok-o">=[</span><span class="tok-n">airport</span><span class="tok-o">]</span>
<span class="tok-n">region</span><span class="tok-o">=[</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span><span class="tok-o">]</span>
<span class="tok-n">runways</span><span class="tok-o">=[</span><span class="tok-mi">2</span><span class="tok-o">]</span>
<span class="tok-n">lat</span><span class="tok-o">=[</span><span class="tok-mf">30.1944999694824</span><span class="tok-o">]</span>
<span class="tok-n">desc</span><span class="tok-o">=[</span><span class="tok-n">Austin</span> <span class="tok-n">Bergstrom</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also mix use of <em>true</em> along with requesting the map for specific properties.
The next example will just return the ID, label and <em>region</em> property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// If you want the ID, label and a specific field like the region, you can do this</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">region:</span><span class="tok-o">[</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span><span class="tok-o">],</span><span class="tok-nl">label:</span><span class="tok-n">airport</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you only need the keys and values for specific properties to be returned it
is recommended to pass the names of those properties as parameters to the <em>valueMap</em>
step so it does not return a lot more data than you need. Think of this as the
difference, in the SQL world, between selecting just the columns you are interested
in from a table rather than doing a <em>SELECT *</em>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>As shown above, you can specify which properties you want returned by supplying their
names as parameters to the <em>valueMap</em> step. For completeness, it is worth noting
that you can also use a <em>select</em> step to refine the results of a <em>valueMap</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// You can 'select' specific fields from a value map</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">().</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'icao'</span><span class="tok-o">,</span><span class="tok-s1">'desc'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">],</span><span class="tok-nl">icao:</span><span class="tok-o">[</span><span class="tok-n">KAUS</span><span class="tok-o">],</span><span class="tok-nl">desc:</span><span class="tok-o">[</span><span class="tok-n">Austin</span> <span class="tok-n">Bergstrom</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are reading the output of queries that use <em>valueMap</em> on the Gremlin console,
it is sometimes easier to read the output if you add an <em>unfold</em> step to the end of
the query as follows. The <em>unfold</em> step will unbundle a collection for us. You will
see it used in many parts of this book.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'icao'</span><span class="tok-o">,</span><span class="tok-s1">'desc'</span><span class="tok-o">,</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">()</span>

<span class="tok-n">code</span><span class="tok-o">=[</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-n">city</span><span class="tok-o">=[</span><span class="tok-n">Austin</span><span class="tok-o">]</span>
<span class="tok-n">icao</span><span class="tok-o">=[</span><span class="tok-n">KAUS</span><span class="tok-o">]</span>
<span class="tok-n">id</span><span class="tok-o">=</span><span class="tok-mi">3</span>
<span class="tok-n">label</span><span class="tok-o">=</span><span class="tok-n">airport</span>
<span class="tok-n">desc</span><span class="tok-o">=[</span><span class="tok-n">Austin</span> <span class="tok-n">Bergstrom</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use <em>valueMap</em> to inspect the properties associated with an edge. In
this simple example, the edge with an ID of 5161 is examined. As you can see the edge
represents a route and has a distance (<em>dist</em>) property with a value of 1357 miles.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">(</span><span class="tok-mi">5161</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">5161</span><span class="tok-o">,</span><span class="tok-nl">dist:</span><span class="tok-mi">1357</span><span class="tok-o">,</span><span class="tok-nl">label:</span><span class="tok-n">route</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="tp34vm">3.5.1. Changes to <em>valueMap</em> introduced in TinkerPop 3.4</h4>
<div class="paragraph">
<p>Starting with the Apache TinkerPop 3.4 release, a few changes have been introduced
that allow easier control of the results that a <em>valueMap</em> step returns. Further, the
use of <em>true</em> to return the ID and label properties of a Vertex or an Edge was
deprecated and replaced by the use of a <em>with</em> modulator.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The new valueMap configuration options are described in the official
documentation at the following link
<a href="http://tinkerpop.apache.org/docs/current/reference/#valuemap-step" class="bare">http://tinkerpop.apache.org/docs/current/reference/#valuemap-step</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The previous ways of using <em>valueMap</em> will still work but over time as Graph DB
providers adopt TinkerPop 3.4 the examples shown below will become the preferred way
of controlling the results returned by <em>valueMap</em>.</p>
</div>
<div class="paragraph">
<p>Instead of using <em>valueMap(true)</em> to include the ID and label of an element (a vertex
or an edge) in the results, the new <em>with(WithOptions.tokens)</em> construct can
now be used as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SFO'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">().</span><span class="tok-na">with</span><span class="tok-o">(</span><span class="tok-n">WithOptions</span><span class="tok-o">.</span><span class="tok-na">tokens</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">()</span>

<span class="tok-n">id</span><span class="tok-o">=</span><span class="tok-mi">23</span>
<span class="tok-n">label</span><span class="tok-o">=</span><span class="tok-n">airport</span>
<span class="tok-n">country</span><span class="tok-o">=[</span><span class="tok-n">US</span><span class="tok-o">]</span>
<span class="tok-n">code</span><span class="tok-o">=[</span><span class="tok-n">SFO</span><span class="tok-o">]</span>
<span class="tok-n">longest</span><span class="tok-o">=[</span><span class="tok-mi">11870</span><span class="tok-o">]</span>
<span class="tok-n">city</span><span class="tok-o">=[</span><span class="tok-n">San</span> <span class="tok-n">Francisco</span><span class="tok-o">]</span>
<span class="tok-n">elev</span><span class="tok-o">=[</span><span class="tok-mi">13</span><span class="tok-o">]</span>
<span class="tok-n">icao</span><span class="tok-o">=[</span><span class="tok-n">KSFO</span><span class="tok-o">]</span>
<span class="tok-n">lon</span><span class="tok-o">=[-</span><span class="tok-mf">122.375</span><span class="tok-o">]</span>
<span class="tok-n">type</span><span class="tok-o">=[</span><span class="tok-n">airport</span><span class="tok-o">]</span>
<span class="tok-n">region</span><span class="tok-o">=[</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">CA</span><span class="tok-o">]</span>
<span class="tok-n">runways</span><span class="tok-o">=[</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-n">lat</span><span class="tok-o">=[</span><span class="tok-mf">37.6189994812012</span><span class="tok-o">]</span>
<span class="tok-n">desc</span><span class="tok-o">=[</span><span class="tok-n">San</span> <span class="tok-n">Francisco</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
All of the possible values that can be specified using WithOptions can be found
in the official Apache TinkerPop JavaDoc documentation
<a href="http://tinkerpop.apache.org/javadocs/current/full/org/apache/tinkerpop/gremlin/process/traversal/step/util/WithOptions.html">at
this location</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>You can still include the ID and label in the results, along with a subset of the
properties, by explicitly naming the property keys you are interested in. In the
example below only the <em>code</em> property is requested.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SFO'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">with</span><span class="tok-o">(</span><span class="tok-n">WithOptions</span><span class="tok-o">.</span><span class="tok-na">tokens</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">()</span>

<span class="tok-n">id</span><span class="tok-o">=</span><span class="tok-mi">23</span>
<span class="tok-n">label</span><span class="tok-o">=</span><span class="tok-n">airport</span>
<span class="tok-n">code</span><span class="tok-o">=[</span><span class="tok-n">SFO</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use additional <em>WithOptions</em> qualifiers to select just the labels.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SFO'</span><span class="tok-o">).</span>
      <span class="tok-n">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">with</span><span class="tok-o">(</span><span class="tok-n">WithOptions</span><span class="tok-o">.</span><span class="tok-na">tokens</span><span class="tok-o">,</span><span class="tok-n">WithOptions</span><span class="tok-o">.</span><span class="tok-na">labels</span><span class="tok-o">).</span>
      <span class="tok-n">unfold</span><span class="tok-o">()</span>

<span class="tok-n">label</span><span class="tok-o">=</span><span class="tok-n">airport</span>
<span class="tok-n">code</span><span class="tok-o">=[</span><span class="tok-n">SFO</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the same way you can choose to just have the ID value returned without the label.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SFO'</span><span class="tok-o">).</span>
      <span class="tok-n">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">with</span><span class="tok-o">(</span><span class="tok-n">WithOptions</span><span class="tok-o">.</span><span class="tok-na">tokens</span><span class="tok-o">,</span><span class="tok-n">WithOptions</span><span class="tok-o">.</span><span class="tok-na">ids</span><span class="tok-o">).</span>
      <span class="tok-n">unfold</span><span class="tok-o">()</span>

<span class="tok-n">id</span><span class="tok-o">=</span><span class="tok-mi">23</span>
<span class="tok-n">code</span><span class="tok-o">=[</span><span class="tok-n">SFO</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As discussed in the previous section, the property values returned by <em>valueMap</em> are
by default represented as lists even if there is only a single property value
present.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Using versions of TinkerPop prior to 3.4 it is still possible to generate the
same unrolled results that you get using <em>by(unfold())</em>. How to do that is discussed
a bit later in the book we need to look at a few other steps such as <em>map</em> first.
If you want to jump ahead you will find these examples in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#vmunroll">Unrolling the lists returned by <em>valueMap</em></a>" section.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Starting with TinkerPop 3.4 you can very easily request that these values be returned
as single values not wrapped in lists. This can be done using a <em>by</em> step modulator
as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SFO'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">unfold</span><span class="tok-o">()).</span><span class="tok-na">unfold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice how all the values such as the city name, "San Francisco", are now just simple
strings or numeric values and not a single value wrapped in a list of length one.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">country</span><span class="tok-o">=</span><span class="tok-n">US</span>
<span class="tok-n">code</span><span class="tok-o">=</span><span class="tok-n">SFO</span>
<span class="tok-n">longest</span><span class="tok-o">=</span><span class="tok-mi">11870</span>
<span class="tok-n">city</span><span class="tok-o">=</span><span class="tok-n">San</span> <span class="tok-n">Francisco</span>
<span class="tok-n">elev</span><span class="tok-o">=</span><span class="tok-mi">13</span>
<span class="tok-n">icao</span><span class="tok-o">=</span><span class="tok-n">KSFO</span>
<span class="tok-n">lon</span><span class="tok-o">=-</span><span class="tok-mf">122.375</span>
<span class="tok-n">type</span><span class="tok-o">=</span><span class="tok-n">airport</span>
<span class="tok-n">region</span><span class="tok-o">=</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">CA</span>
<span class="tok-n">runways</span><span class="tok-o">=</span><span class="tok-mi">4</span>
<span class="tok-n">lat</span><span class="tok-o">=</span><span class="tok-mf">37.6189994812012</span>
<span class="tok-n">desc</span><span class="tok-o">=</span><span class="tok-n">San</span> <span class="tok-n">Francisco</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There are additional <em>WithOptions</em> settings we can use to change how
properties with meta properties are returned by <em>valueMap</em> This is covered later as
part of the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#tp34vmmetaprop">Using <em>unfold</em> and <em>WithOptions</em> with Meta Properties</a>" section.
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="element-map">3.6. An alternative to <em>valueMap</em> - introducing <em>elementMap</em></h3>
<div class="paragraph">
<p>A new step, <em>elementMap</em>, was added to the Gremlin language as part of the Apache
TinkerPop 3.4.4 release in October 2019. This new step is similar in many ways
to the <em>valueMap</em> step but makes some things a little easier.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Make sure the graph database you are using has support for Apache TinkerPop
at the 3.4.4 level or higher before using <em>elementMap</em> in your queries.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>When using <em>valueMap</em> you need to explicitly request that the ID and label of a
vertex or an edge are included in query results. This is not necessary when
using <em>elementMap</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">elementMap</span><span class="tok-o">().</span><span class="tok-na">unfold</span><span class="tok-o">()</span>

<span class="tok-n">id</span><span class="tok-o">=</span><span class="tok-mi">3</span>
<span class="tok-n">label</span><span class="tok-o">=</span><span class="tok-n">airport</span>
<span class="tok-n">country</span><span class="tok-o">=</span><span class="tok-n">US</span>
<span class="tok-n">code</span><span class="tok-o">=</span><span class="tok-n">AUS</span>
<span class="tok-n">longest</span><span class="tok-o">=</span><span class="tok-mi">12250</span>
<span class="tok-n">city</span><span class="tok-o">=</span><span class="tok-n">Austin</span>
<span class="tok-n">elev</span><span class="tok-o">=</span><span class="tok-mi">542</span>
<span class="tok-n">icao</span><span class="tok-o">=</span><span class="tok-n">KAUS</span>
<span class="tok-n">lon</span><span class="tok-o">=-</span><span class="tok-mf">97.6698989868164</span>
<span class="tok-n">type</span><span class="tok-o">=</span><span class="tok-n">airport</span>
<span class="tok-n">region</span><span class="tok-o">=</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span>
<span class="tok-n">runways</span><span class="tok-o">=</span><span class="tok-mi">2</span>
<span class="tok-n">lat</span><span class="tok-o">=</span><span class="tok-mf">30.1944999694824</span>
<span class="tok-n">desc</span><span class="tok-o">=</span><span class="tok-n">Austin</span> <span class="tok-n">Bergstrom</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As with <em>valueMap</em>, you can request only certain property values be included in
the resulting map. Note however that the property values are not returned as
list members. This is a key difference from <em>valueMap</em>. In fact, if the value
for a given property is a list or set containing multiple values, <em>elementMap</em>
will only return the first member of that list or set. If you need to return
<em>set</em> or <em>list</em> cardinality values you should use <em>valueMap</em> instead.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">elementMap</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">label:</span><span class="tok-n">airport</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Austin</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The biggest difference between <em>elementMap</em> and <em>valueMap</em> becomes apparent when
looking at edges. For a given edge, as well as the ID and label and properties,
information about the incoming and outgoing vertices is also returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">elementMap</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">5161</span><span class="tok-o">,</span><span class="tok-nl">label:</span><span class="tok-n">route</span><span class="tok-o">,</span><span class="tok-nl">IN:</span><span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">47</span><span class="tok-o">,</span><span class="tok-nl">label:</span><span class="tok-n">airport</span><span class="tok-o">],</span><span class="tok-nl">OUT:</span><span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">label:</span><span class="tok-n">airport</span><span class="tok-o">],</span><span class="tok-nl">dist:</span><span class="tok-mi">1357</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A similar result could be generated using <em>valueMap</em> as shown below but it is
definitely a bit more work.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">(</span><span class="tok-mi">5161</span><span class="tok-o">).</span><span class="tok-na">project</span><span class="tok-o">(</span><span class="tok-s1">'v'</span><span class="tok-o">,</span><span class="tok-s1">'IN'</span><span class="tok-o">,</span><span class="tok-s1">'OUT'</span><span class="tok-o">).</span>
            <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">valueMap</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">)).</span>
            <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">inV</span><span class="tok-o">().</span><span class="tok-na">union</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-o">(),</span><span class="tok-n">label</span><span class="tok-o">()).</span><span class="tok-na">fold</span><span class="tok-o">()).</span>
            <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">outV</span><span class="tok-o">().</span><span class="tok-na">union</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-o">(),</span><span class="tok-n">label</span><span class="tok-o">()).</span><span class="tok-na">fold</span><span class="tok-o">())</span>

<span class="tok-o">[</span><span class="tok-nl">v:</span><span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">5161</span><span class="tok-o">,</span><span class="tok-nl">label:</span><span class="tok-n">route</span><span class="tok-o">,</span><span class="tok-nl">dist:</span><span class="tok-mi">1357</span><span class="tok-o">],</span><span class="tok-nl">IN:</span><span class="tok-o">[</span><span class="tok-mi">47</span><span class="tok-o">,</span><span class="tok-n">airport</span><span class="tok-o">],</span><span class="tok-nl">OUT:</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-n">airport</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To make the output look even closer to the results returned by <em>elementMap</em>
we could decide to add some additional <em>project</em> steps.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">(</span><span class="tok-mi">5161</span><span class="tok-o">).</span><span class="tok-na">project</span><span class="tok-o">(</span><span class="tok-s1">'v'</span><span class="tok-o">,</span><span class="tok-s1">'IN'</span><span class="tok-o">,</span><span class="tok-s1">'OUT'</span><span class="tok-o">).</span>
            <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">valueMap</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">)).</span>
            <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'id'</span><span class="tok-o">,</span><span class="tok-s1">'label'</span><span class="tok-o">).</span>
              <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">inV</span><span class="tok-o">().</span><span class="tok-na">id</span><span class="tok-o">()).</span>
              <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">inV</span><span class="tok-o">().</span><span class="tok-na">label</span><span class="tok-o">())).</span>
            <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'id'</span><span class="tok-o">,</span><span class="tok-s1">'label'</span><span class="tok-o">).</span>
              <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">outV</span><span class="tok-o">().</span><span class="tok-na">id</span><span class="tok-o">()).</span>
              <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">outV</span><span class="tok-o">().</span><span class="tok-na">label</span><span class="tok-o">())).</span>
            <span class="tok-n">unfold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The results of running the query are shown below. I added an unfold step to the query
just to make the results a little easier to read.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">v</span><span class="tok-o">={</span><span class="tok-n">id</span><span class="tok-o">=</span><span class="tok-mi">5161</span><span class="tok-o">,</span> <span class="tok-n">label</span><span class="tok-o">=</span><span class="tok-n">route</span><span class="tok-o">,</span> <span class="tok-n">dist</span><span class="tok-o">=</span><span class="tok-mi">1357</span><span class="tok-o">}</span>
<span class="tok-n">IN</span><span class="tok-o">={</span><span class="tok-n">id</span><span class="tok-o">=</span><span class="tok-mi">47</span><span class="tok-o">,</span> <span class="tok-n">label</span><span class="tok-o">=</span><span class="tok-n">airport</span><span class="tok-o">}</span>
<span class="tok-n">OUT</span><span class="tok-o">={</span><span class="tok-n">id</span><span class="tok-o">=</span><span class="tok-mi">3</span><span class="tok-o">,</span> <span class="tok-n">label</span><span class="tok-o">=</span><span class="tok-n">airport</span><span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="var">3.7. Assigning query results to a variable</h3>
<div class="paragraph">
<p>It is extremely useful to be able to assign the results of a query to a variable. The
example below stores the results of the <em>valueMap</em> call shown above into a variable
called <em>aus</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Store the properties for the AUS airport in the variable aus.</span>
<span class="tok-n">aus</span><span class="tok-o">=</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
It is necessary to add a call to <em>next</em> to the end of the query in order for
this to work. Forgetting to add the call to <em>next</em> is a very commonly made mistake by
people getting used to the Gremlin query language. The call to <em>next</em> terminates the
traversal part of the query and generates a concrete result that can be stored in a
variable. There are other steps such as <em>toList</em> and <em>toSet</em> that also perform this
traversal termination action. We will see those steps used later on.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Once you have some results in a variable you can refer to it as you would in any
other programming language. We will explore mixing Java and Groovy code with your
Gremlin queries later in this book. For now let’s just use the Groovy <em>println</em>
to display the results of the query that we stored in <em>aus</em>. We
will take a deeper look at the use of variables with Gremlin later in the book when
we look at mixing Gremlin and Groovy in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#grv">Making Gremlin even Groovier</a>" section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// We can now refer to aus using key:value syntax</span>
<span class="tok-n">println</span> <span class="tok-s2">"The AUS airport is located in "</span> <span class="tok-o">+</span> <span class="tok-n">aus</span><span class="tok-o">[</span><span class="tok-s1">'city'</span><span class="tok-o">][</span><span class="tok-mi">0</span><span class="tok-o">]</span>

<span class="tok-n">The</span> <span class="tok-n">AUS</span> <span class="tok-n">airport</span> <span class="tok-n">is</span> <span class="tok-n">located</span> <span class="tok-k">in</span> <span class="tok-n">Austin</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Properties are stored as arrays of values. Even if there is only one
property value for the given key, we still have to add the <em>[0]</em> when referencing it
otherwise the whole array will be returned if we just used <em>aus['city']</em>. We
will explore why property values are stored in this way in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#listprop">Attaching multiple values (lists or sets) to a single property</a>"
section.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>As a side note, the <em>next</em> step can take a parameter value that tells it how much
data to return. For example if you wanted the next three vertices from a query like
the one below you can add a call to <em>next(3)</em> at the end of the query. Note that
doing this turns the result into an ArrayList. Each element in the list will contain
a vertex.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">verts</span><span class="tok-o">=</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">)</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">]</span>
<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]</span>
<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can call the Java <em>getClass</em> method to verify the type of the values
returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">verts</span><span class="tok-o">.</span><span class="tok-na">getClass</span><span class="tok-o">()</span>

<span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.</span><span class="tok-na">ArrayList</span>

<span class="tok-n">verts</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">getClass</span><span class="tok-o">()</span>

<span class="tok-kd">class</span> <span class="tok-nc">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">tinkergraph</span><span class="tok-o">.</span><span class="tok-na">structure</span><span class="tok-o">.</span><span class="tok-na">TinkerVertex</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
When using the Gremlin Console, you can check to see what variables you have defined
using the command <em>:show variables</em>.
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="setsandlists">3.7.1. Introducing <em>toList</em>, <em>toSet</em>, <em>bulkSet</em> and <em>fill</em></h4>
<div class="paragraph">
<p>It is often useful to return the results of a query as a list or as a set. One way to
do this is to use <em>toList</em> or <em>toSet</em> methods. Below you will find an example of
each. The call to <em>join</em> is used just to make the results easier to read on a single
line.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Create a list of runway counts in Texas</span>
<span class="tok-n">listr</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">).</span>
              <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">toList</span><span class="tok-o">().</span><span class="tok-na">join</span><span class="tok-o">(</span><span class="tok-s1">','</span><span class="tok-o">)</span>

<span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let’s create a set and observe the different result we get back.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Create a set of runway counts in Texas (no duplicates)</span>
<span class="tok-n">setr</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">).</span>
             <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">toSet</span><span class="tok-o">().</span><span class="tok-na">join</span><span class="tok-o">(</span><span class="tok-s1">','</span><span class="tok-o">)</span>

<span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">7</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As a side note, in many cases we can use the <em>dedup</em> step to remove duplicates from a
result. However, it is worth knowing that a set can be created as a result type as in
some cases this can be very useful. The example below performs the same <em>runways</em>
query using a <em>dedup</em> step. I added an <em>order</em> step so that it is easier to compare
the results with the previous query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Create a list of runway counts in Texas (no duplicates)</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">).</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">dedup</span><span class="tok-o">().</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, let’s create the list again, but without the call to <em>join</em>, as
that creates a single string result which is not what we want in this case.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">listr</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">).</span>
        <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">toList</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The variable can now be used as you would expect.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">listr</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">]</span>
<span class="tok-mi">7</span>

<span class="tok-n">listr</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">()</span>
<span class="tok-mi">26</span>

<span class="tok-n">listr</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-mi">7</span>
<span class="tok-mi">3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>TinkerPop also provides a third method called <em>bulkSet</em> that can be used to create a
collection at the end of a traversal. The difference between a <em>bulkSet</em> and a <em>set</em>
is that <em>bulkSet</em> is a so called <em>weighted set</em>. A <em>bulkSet</em> stores every value but
includes a count of how many of each type is present. Let’s look at a few examples.
First of all we can check that the <em>bulkSet</em> does indeed contain all the values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">setb</span><span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">toBulkSet</span><span class="tok-o">().</span><span class="tok-na">join</span><span class="tok-o">(</span><span class="tok-s1">','</span><span class="tok-o">)</span>
<span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A <em>bulkSet</em> offers some additional methods that we can call. One of these is
<em>uniqueSize</em> which will tell us how many unique values are present.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">setb</span><span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">toBulkSet</span><span class="tok-o">()</span>

<span class="tok-c1">// How many unique values are in the set?</span>
<span class="tok-n">setb</span><span class="tok-o">.</span><span class="tok-na">uniqueSize</span><span class="tok-o">()</span>
<span class="tok-mi">6</span>

<span class="tok-c1">// How many total values are present?</span>
<span class="tok-n">setb</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">()</span>
<span class="tok-mi">26</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>asBulk</em> method returns a map of key/value pairs where the key is the number and
the value is the number of times that number appears in the set.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">setb</span><span class="tok-o">.</span><span class="tok-na">asBulk</span><span class="tok-o">()</span>

<span class="tok-mi">2</span><span class="tok-o">=</span><span class="tok-mi">8</span>
<span class="tok-mi">7</span><span class="tok-o">=</span><span class="tok-mi">1</span>
<span class="tok-mi">5</span><span class="tok-o">=</span><span class="tok-mi">1</span>
<span class="tok-mi">3</span><span class="tok-o">=</span><span class="tok-mi">11</span>
<span class="tok-mi">4</span><span class="tok-o">=</span><span class="tok-mi">4</span>
<span class="tok-mi">1</span><span class="tok-o">=</span><span class="tok-mi">1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There is another way to store the results of a query into a collection. This is
achieved using the <em>fill</em> method. Unlike <em>toList</em> and the other methods that we just
looked at, <em>fill</em> will store the results into a pre-existing variable. The query
below defines a list called <em>a</em> and stores the results of the query into it. This
will produce the same result as using <em>toList</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-o">[]</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">fill</span><span class="tok-o">(</span><span class="tok-n">a</span><span class="tok-o">)</span>

<span class="tok-n">a</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">()</span>
<span class="tok-mi">26</span>

<span class="tok-n">a</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-mi">7</span>
<span class="tok-mi">3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can define a variable that is a set and use <em>fill</em> to achieve the same result as
using <em>toSet</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-o">[]</span> <span class="tok-k">as</span> <span class="tok-n">Set</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">fill</span><span class="tok-o">(</span><span class="tok-n">s</span><span class="tok-o">)</span>

<span class="tok-n">println</span> <span class="tok-n">s</span>

<span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">,</span> <span class="tok-mi">7</span><span class="tok-o">,</span> <span class="tok-mi">5</span><span class="tok-o">,</span> <span class="tok-mi">3</span><span class="tok-o">,</span> <span class="tok-mi">4</span><span class="tok-o">,</span> <span class="tok-mi">1</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="wid">3.8. Working with IDs</h3>
<div class="paragraph">
<p>Every vertex, every edge and even every property in a graph has a unique ID that can
be used to reference it individually or as part of a group. Beware that the IDs you
provide when loading a graph from a GraphML or GraphSON file may not in many cases
end up being the IDs that the back-end graph store actually uses as it builds up your
graph. Tinkergraph for example will preserve user provided IDs but many graph
databases such as JanusGraph generate their own IDs. The same is true when you add
vertices and edges using a graph traversal or using the TinkerPop API. This is a long
winded way of saying that you should not depend on the IDs in your GraphML or
GraphSON file that you just loaded remaining unchanged once the data has been loaded
into the graph store. When you add a new vertex or edge to your graph using a
traversal, the graph system will automatically generate a new, unique ID for it. If
you need to figure out the ID for a vertex or an edge you can always get it from a
query of the graph itself.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Don’t rely on the graph preserving the ID values you provide. Write code that
can query the graph itself for ID values. How IDs are managed will be graph database
implementation dependent.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Especially when dealing with large graphs, because using IDs is typically very
efficient, you will find that many of your queries will involve collecting one or
more IDs and then passing those on to other queries or parts of the same query. In
most if not all cases, the underlying graph system will have setup its data
structures, whether on disk or in memory, to be very rapidly accessed by ID value.</p>
</div>
<div class="paragraph">
<p>Let’s demonstrate the use of ID values using a few simple examples. The query below
finds the ID, which is 8, for the vertex that represents the DFW airport.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"> <span class="tok-c1">// What is the ID of the "DFW" vertex?</span>
 <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">id</span><span class="tok-o">()</span>

 <span class="tok-mi">8</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s reverse the query and find the code for the vertex with an ID of 8.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Simple lookup by ID</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-mi">8</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-n">DFW</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could also have written the above query as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// which is the same as this</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-o">,</span><span class="tok-mi">8</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are some more examples that make use of the ID value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// vertices with an ID between 1 and 5 (note this is inclusive/exclusive)</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-n">between</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">))</span>

<span class="tok-c1">// Which is an alternate form of this</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-o">,</span><span class="tok-n">between</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">))</span>

<span class="tok-c1">// Find routes from the vertex with an ID of 6 to any vertex with an ID less than 46</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-mi">6</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-o">,</span><span class="tok-n">lt</span><span class="tok-o">(</span><span class="tok-mi">46</span><span class="tok-o">)).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-c1">// Which is the same as</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-mi">6</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-n">lt</span><span class="tok-o">(</span><span class="tok-mi">46</span><span class="tok-o">)).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also pass a single ID or multiple IDs directly into the <em>V()</em> step.
Take a look at the two examples below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// What is the code property for the vertex with an ID of 3?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-n">AUS</span>

<span class="tok-c1">// As above but for all of the specified vertex IDs</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">15</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-n">AUS</span>
<span class="tok-n">BWI</span>
<span class="tok-n">DFW</span>
<span class="tok-n">MCO</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also pass a list of ID values into the <em>V</em> step. We take a closer look at
using variables in this way in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#varaus">Using a variable to feed a traversal</a>" section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">a</span><span class="tok-o">=[</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">15</span><span class="tok-o">]</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-n">a</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the graph database that you are using supports it you can set the ID of a
vertex at the time you create it. How that can be done is explained in the
"<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#injectid">Using <em>inject</em> to specify new vertex ID values</a>" section.</p>
</div>
<div class="paragraph">
<p>Every property in the graph also has an ID as we shall explore in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#propid">Properties have IDs too</a>"
section a bit later on.</p>
</div>
</div>
<div class="sect2">
<h3 id="lab">3.9. Working with labels</h3>
<div class="paragraph">
<p>It’s a good idea when designing a graph to give the vertices and edges meaningful
labels. You can use these to help refine searches. For example in the <em>air-routes</em>
graph, every airport vertex is labelled <em>airport</em> and every country vertex, not
surprisingly, is labelled <em>country</em>. Similarly, edges that represent a flight route
are labelled <em>route</em>. You can use labels in many ways. We already saw the <em>hasLabel</em>
step being used in the basic queries section to test for a particular label. Here are
a few more examples.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// What label does the LBB vertex have?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LBB'</span><span class="tok-o">).</span><span class="tok-na">label</span><span class="tok-o">()</span>

<span class="tok-c1">// What airports are located in Australia? Note that 'contains' is an</span>
<span class="tok-c1">// edge label and 'country' is a vertex label.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AU'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">(</span><span class="tok-s1">'contains'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-c1">// We could also write this query as follows</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AU'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By using labels in this way we can effectively group vertices and edges into classes
or types. Imagine if we wanted to build a graph containing different types of
vehicles. We might decide to label all the vertices just <em>vehicle</em> but we could
decide to use labels such as <em>car</em>, <em>truck</em> and <em>bus</em>. Ultimately the overall design
of your graph’s data model will dictate the way you use labels but it is good to be
aware of their value.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As useful as labels are, not all graph database engines provide support for
indexing them. You should check to see if the graph database technology you are using
allows for labels to be indexed. If that is not the case, it is recommended to use a
vertex or edge property, that can be indexed, as a surrogate for the label. This can
then be used in graph queries rather than relying on the vertex label. This is
especially important when working with large graphs where performance can become an
issue if the items you are looking for are not backed by an index.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Here are a few more examples of ways we can work with labels.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// You can explicitly reference a vertex label using the label() method</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">label</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">eq</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">))).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-c1">// Or using the label key word</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-n">label</span><span class="tok-o">,</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-c1">// But you would perhaps use the hasLabel() method in this case instead</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-c1">// How many non airport vertices are there?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-n">label</span><span class="tok-o">,</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">)).</span><span class="tok-na">count</span><span class="tok-o">()</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">label</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">))).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-c1">// Again, it might be more natural to actually write this query like this:</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">not</span><span class="tok-o">(</span><span class="tok-n">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">)).</span><span class="tok-na">count</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The same concepts apply equally well when looking at edge labels as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// The same basic concepts apply equally to edges</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-n">label</span><span class="tok-o">,</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">().</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">label</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">eq</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">))).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course we have already seen another common place where labels might get used.
Namely in the three parameter form of <em>has</em> as in the example below. The first
parameter is the label value. The next two parameters test the properties of all
vertices that have the <em>airport</em> label for a code of "<em>SYD</em>".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SYD'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is also possible to specify more than one label in the same step as shown below.
In general, whenever a step can be provided a label, more than one may also be
provided.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">,</span><span class="tok-s1">'contains'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="local">3.10. Using the <em>local</em> step to make sure we get the result we intended</h3>
<div class="paragraph">
<p>Sometimes it is important to be able to do calculations based on the current state of
a traversal rather than waiting until near the end. A common place where this is
necessary is when calculating the average value of a collection. In the next section
we are going to look at a selection of numerical and statistical operations that
Gremlin allows us to perform. However, for now lets use the <em>mean</em> step to calculate
the average of something and look at the effect the <em>local</em> step has on the
calculation. The <em>mean</em> step works just like you would expect, it returns the mean,
or average, value for a set of numbers.</p>
</div>
<div class="paragraph">
<p>If we wanted to calculate the average number of routes from an airport, the first
query that we would write might look like the one below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">mean</span><span class="tok-o">()</span>

<span class="tok-mf">43400.0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the answer we got back, <em>43400.0</em> looks wrong, and indeed it is. That
number is in fact the total number of outgoing routes in the entire graph. This is
because as written the query counts all of the routes, adds them all up, but does not
keep track of how many airports it visited. This means that calling the <em>mean</em> step
is essentially the same as dividing the count by one.</p>
</div>
<div class="paragraph">
<p>So how do we fix this? The answer is to use the <em>local</em> step. What we really want to
do is to create, in essence, a collection of values, where each value is the route
count for just one airport. Having done that, we want to divide the sum of all of
these numbers by the number of members, airports in this case, into the collection.</p>
</div>
<div class="paragraph">
<p>Take a look at the modified query below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Average number of outgoing routes from an airport.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">local</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">mean</span><span class="tok-o">()</span>

<span class="tok-mf">12.863070539419088</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The result this time is a much more believable answer. Notice how this time we placed
the <em>out(<em>'route</em>').count()</em> steps inside a <em>local</em> step. The query below,
with the mean step removed, shows what is happening during the traversal as this
query runs. I truncated the output to just show a few lines.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">local</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">)</span>

<span class="tok-mi">232</span>
<span class="tok-mi">38</span>
<span class="tok-mi">59</span>
<span class="tok-mi">55</span>
<span class="tok-mi">129</span>
<span class="tok-mi">87</span>
<span class="tok-mi">93</span>
<span class="tok-mi">220</span>
<span class="tok-mi">141</span>
<span class="tok-mi">135</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>What this shows is that for the first ten airports the collection that we are
building up contains one entry for each airport that represents the number of
outgoing routes that airport has. Then, when we eventually apply the <em>mean</em> step it
will calculate the average value of our entire collection and give us back the result
that we were looking for.</p>
</div>
<div class="paragraph">
<p>Let’s look at another example where we can use the <em>local</em> step to change the results
of a query in a useful way. First of all, take a look at the query below and the
results that it generates. The query first finds all the airports located in Scotland
using the region code of <em>GB-SCT</em>. It then creates an ordered list of airport codes
and city names into a list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'GB-SCT'</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results from running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">ABZ</span><span class="tok-o">,</span><span class="tok-n">Aberdeen</span><span class="tok-o">,</span><span class="tok-n">BEB</span><span class="tok-o">,</span><span class="tok-n">Balivanich</span><span class="tok-o">,</span><span class="tok-n">BRR</span><span class="tok-o">,</span><span class="tok-n">Eoligarry</span><span class="tok-o">,</span><span class="tok-n">CAL</span><span class="tok-o">,</span><span class="tok-n">Campbeltown</span><span class="tok-o">,</span><span class="tok-n">DND</span><span class="tok-o">,</span><span class="tok-n">Dundee</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">,</span><span class="tok-n">Edinburgh</span><span class="tok-o">,</span><span class="tok-n">EOI</span><span class="tok-o">,</span><span class="tok-n">Eday</span><span class="tok-o">,</span><span class="tok-n">FIE</span><span class="tok-o">,</span><span class="tok-n">Fair</span> <span class="tok-n">Isle</span><span class="tok-o">,</span><span class="tok-n">FOA</span><span class="tok-o">,</span><span class="tok-n">Foula</span><span class="tok-o">,</span><span class="tok-n">GLA</span><span class="tok-o">,</span><span class="tok-n">Glasgow</span><span class="tok-o">,</span><span class="tok-n">ILY</span><span class="tok-o">,</span><span class="tok-n">Port</span> <span class="tok-n">Ellen</span><span class="tok-o">,</span><span class="tok-n">INV</span><span class="tok-o">,</span><span class="tok-n">Inverness</span><span class="tok-o">,</span><span class="tok-n">KOI</span><span class="tok-o">,</span><span class="tok-n">Orkney</span> <span class="tok-n">Islands</span><span class="tok-o">,</span><span class="tok-n">LSI</span><span class="tok-o">,</span><span class="tok-n">Lerwick</span><span class="tok-o">,</span><span class="tok-n">LWK</span><span class="tok-o">,</span><span class="tok-n">Lerwick</span><span class="tok-o">,</span><span class="tok-n">NDY</span><span class="tok-o">,</span><span class="tok-n">Sanday</span><span class="tok-o">,</span><span class="tok-n">NRL</span><span class="tok-o">,</span><span class="tok-n">North</span> <span class="tok-n">Ronaldsay</span><span class="tok-o">,</span><span class="tok-n">PIK</span><span class="tok-o">,</span><span class="tok-n">Glasgow</span><span class="tok-o">,</span><span class="tok-n">PPW</span><span class="tok-o">,</span><span class="tok-n">Papa</span> <span class="tok-n">Westray</span><span class="tok-o">,</span><span class="tok-n">PSV</span><span class="tok-o">,</span><span class="tok-n">Papa</span> <span class="tok-n">Stour</span> <span class="tok-n">Island</span><span class="tok-o">,</span><span class="tok-n">SOY</span><span class="tok-o">,</span><span class="tok-n">Stronsay</span><span class="tok-o">,</span><span class="tok-n">SYY</span><span class="tok-o">,</span><span class="tok-n">Stornoway</span><span class="tok-o">,</span><span class="tok-n">TRE</span><span class="tok-o">,</span><span class="tok-n">Balemartine</span><span class="tok-o">,</span><span class="tok-n">WIC</span><span class="tok-o">,</span><span class="tok-n">Wick</span><span class="tok-o">,</span><span class="tok-n">WRY</span><span class="tok-o">,</span><span class="tok-n">Westray</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, it would be more convenient perhaps to have the results be returned as a
list of lists where each small list contains the airport code and city name with all
the small lists wrapped inside a big list. We can achieve this by wrapping the second
half of the query inside of a <em>local</em> step as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'GB-SCT'</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
      <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results of running the modified query. I have arranged the results in
two columns to aid readability.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">ABZ</span><span class="tok-o">,</span><span class="tok-n">Aberdeen</span><span class="tok-o">]</span>          <span class="tok-o">[</span><span class="tok-n">LSI</span><span class="tok-o">,</span><span class="tok-n">Lerwick</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">BEB</span><span class="tok-o">,</span><span class="tok-n">Balivanich</span><span class="tok-o">]</span>        <span class="tok-o">[</span><span class="tok-n">LWK</span><span class="tok-o">,</span><span class="tok-n">Lerwick</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">BRR</span><span class="tok-o">,</span><span class="tok-n">Eoligarry</span><span class="tok-o">]</span>         <span class="tok-o">[</span><span class="tok-n">NDY</span><span class="tok-o">,</span><span class="tok-n">Sanday</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">CAL</span><span class="tok-o">,</span><span class="tok-n">Campbeltown</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">NRL</span><span class="tok-o">,</span><span class="tok-n">North</span> <span class="tok-n">Ronaldsay</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DND</span><span class="tok-o">,</span><span class="tok-n">Dundee</span><span class="tok-o">]</span>            <span class="tok-o">[</span><span class="tok-n">PIK</span><span class="tok-o">,</span><span class="tok-n">Glasgow</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EDI</span><span class="tok-o">,</span><span class="tok-n">Edinburgh</span><span class="tok-o">]</span>         <span class="tok-o">[</span><span class="tok-n">PPW</span><span class="tok-o">,</span><span class="tok-n">Papa</span> <span class="tok-n">Westray</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EOI</span><span class="tok-o">,</span><span class="tok-n">Eday</span><span class="tok-o">]</span>              <span class="tok-o">[</span><span class="tok-n">PSV</span><span class="tok-o">,</span><span class="tok-n">Papa</span> <span class="tok-n">Stour</span> <span class="tok-n">Island</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">FIE</span><span class="tok-o">,</span><span class="tok-n">Fair</span> <span class="tok-n">Isle</span><span class="tok-o">]</span>         <span class="tok-o">[</span><span class="tok-n">SOY</span><span class="tok-o">,</span><span class="tok-n">Stronsay</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">FOA</span><span class="tok-o">,</span><span class="tok-n">Foula</span><span class="tok-o">]</span>             <span class="tok-o">[</span><span class="tok-n">SYY</span><span class="tok-o">,</span><span class="tok-n">Stornoway</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">GLA</span><span class="tok-o">,</span><span class="tok-n">Glasgow</span><span class="tok-o">]</span>           <span class="tok-o">[</span><span class="tok-n">TRE</span><span class="tok-o">,</span><span class="tok-n">Balemartine</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">ILY</span><span class="tok-o">,</span><span class="tok-n">Port</span> <span class="tok-n">Ellen</span><span class="tok-o">]</span>        <span class="tok-o">[</span><span class="tok-n">WIC</span><span class="tok-o">,</span><span class="tok-n">Wick</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">INV</span><span class="tok-o">,</span><span class="tok-n">Inverness</span><span class="tok-o">]</span>         <span class="tok-o">[</span><span class="tok-n">WRY</span><span class="tok-o">,</span><span class="tok-n">Westray</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">KOI</span><span class="tok-o">,</span><span class="tok-n">Orkney</span> <span class="tok-n">Islands</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are many other ways that <em>local</em> can be used. You will find examples of those
throughout the book. You will see some that show how local can be used as a parameter
to the <em>order</em> step when we dig deeper into route analysis in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#meanmode">Distribution of routes in the graph (mode and mean)</a>"
section.</p>
</div>
</div>
<div class="sect2">
<h3 id="st">3.11. Basic statistical and numerical operations</h3>
<div class="paragraph">
<p>The following queries demonstrate concepts such as calculating the amount of a
particular item that is present in the graph, calculating the average (mean) of a set
of values and calculating a maximum or minimum value. The table below summarizes the
available steps.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Basic statistical steps</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">count</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Count how many of something exists.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">sum</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sum (add up) a collection of values.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">max</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Find the maximum value in a collection of values.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">min</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Find the minimum value in a collection of values.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">mean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Find the mean (average) value in a collection.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>We will dig a bit deeper into some of these capabilities and explain in more detail
in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#meanmode">Distribution of routes in the graph (mode and mean)</a>" section of the book. Some of these examples also take advantage
of the <em>local</em> step that was introduced in the previous section. A way of calculating
the standard deviation within a data set is presented later in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#mathstep">Gremlin’s scientific calculator - introducing <em>math</em></a>"
section. The results of running each query are also shown in the examples below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// How many routes are there from Austin?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s2">"airport"</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">,</span><span class="tok-s2">"AUS"</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">59</span>

<span class="tok-c1">// Sum of values - total runways of all airports</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">sum</span><span class="tok-o">()</span>

<span class="tok-mi">4828</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>mean</em> step allows us to find the mean (average) value in a data set.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Statistical mean (average) value - average number of runways per airport</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">mean</span><span class="tok-o">()</span>

<span class="tok-mf">1.4309425014819206</span>

<span class="tok-c1">// Average length of the longest runway across all airports</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'longest'</span><span class="tok-o">).</span><span class="tok-na">mean</span><span class="tok-o">()</span>

<span class="tok-mf">7570.862477771191</span>

<span class="tok-c1">// Average number of routes to and from an airport</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">local</span><span class="tok-o">(</span><span class="tok-n">both</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">mean</span><span class="tok-o">()</span>

<span class="tok-mf">25.726141078838175</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following queries find maximum and minimum values using the <em>max</em> and <em>min</em>
steps.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">//maximum value - longest runway</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'longest'</span><span class="tok-o">).</span><span class="tok-na">max</span><span class="tok-o">()</span>

<span class="tok-mi">18045</span>

<span class="tok-c1">// What is the biggest number of outgoing routes any airport has?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">local</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">max</span><span class="tok-o">()</span>

<span class="tok-mi">272</span>

<span class="tok-c1">//minimum value - shortest runway</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'longest'</span><span class="tok-o">).</span><span class="tok-na">min</span><span class="tok-o">()</span>

<span class="tok-mi">1300</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is also possible in more recent versions of Apache TinkerPop to use the <em>min</em> and
<em>max</em> steps with more than just numeric values.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Before TinkerPop 3.4 was released <em>min</em> and <em>max</em> could only be used with
numeric values. It is now possible to also test any values that are considered
<em>"comparable"</em>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Prior to TinkerPop 3.4, it was only possible to work with purely
numeric values when using <em>min</em> and <em>max</em>. It is now possible to apply these steps to
any values that are considered <em>"comparable"</em>. So, for example, we can now compare
strings as well as numbers. The examples below look for the minimum and maximum value
in the descriptive names of the continents.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'continent'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">).</span><span class="tok-na">min</span><span class="tok-o">()</span>

<span class="tok-n">Africa</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'continent'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">).</span><span class="tok-na">max</span><span class="tok-o">()</span>

<span class="tok-n">South</span> <span class="tok-n">America</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Prior to TinkerPop 3.4, a similar result could still be achieved by ordering the
results and simply returning the first one.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'continent'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)</span>

<span class="tok-n">Africa</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'continent'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">desc</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)</span>

<span class="tok-n">South</span> <span class="tok-n">America</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tranges">3.12. Testing values and ranges of values</h3>
<div class="paragraph">
<p>We have already seen some ways of testing whether a value is within a certain range.
Gremlin provides a number of different predicates that we can use to do range
testing. The list below provides a summary of the available predicates. We will see
each of these in use throughout this book.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Predicates that test values or ranges of values</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">eq</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Equal to</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">neq</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not equal to</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">gt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Greater than</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">gte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Greater than or equal to</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">lt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Less than</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">lte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Less than or equal to</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">inside</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inside a lower and upper bound, neither bound is included.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">outside</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Outside a lower and upper bound, neither bound is included.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">between</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Between two values inclusive/exclusive (upper bound is excluded)</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">within</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Must match at least one of the values provided. Can be a range or a list</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">without</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Must not match any of the values provided. Can be a range or a list</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following queries demonstrate these capabilities being used in different ways.
First of all, here are some examples of some of the direct compare steps such as <em>gt</em>
and <em>gte</em> being used. The <em>fold</em> step conveniently folds all of the results into a
list for us.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Airports with at least 5 runways</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-n">gte</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the output that we might get from running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">ORD</span><span class="tok-o">,</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-n">DEN</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-n">DTW</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">AMS</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-n">SNN</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">MKE</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">MDW</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">GIS</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">HLZ</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">NPE</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">NSN</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">PPQ</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">TRG</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">UFA</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">KRP</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The next three queries show examples of <em>lt</em>, <em>eq</em> and <em>neq</em> being used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Airports with fewer than 3 runways</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-n">lt</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-c1">// How many airports have 3 runways?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-n">eq</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">)).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-c1">// How many airports have anything but just 1 runway?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)).</span><span class="tok-na">count</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that in some cases, such as when using a simple <em>has</em> step the <em>eq</em> is not
actually required. For example the query used above could be written as follows
instead.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You could also write this query using an <em>is</em> step. You will find the <em>is</em> step used
a lot in this book but mostly in conjunction with <em>where</em> steps. To me the usage
below does not feel as elegant as the <em>has</em> step alternative used above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// How many airports have 3 runways?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are examples of <em>inside</em> and <em>outside</em> being used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Airports with greater than 3 but fewer than 6 runways.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-n">inside</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">)</span>

<span class="tok-c1">// Airports with fewer than 3 or more than 6 runways.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-n">outside</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Below are some examples showing <em>within</em> and <em>without</em> being used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Airports with at least 3 but not more than 6 runways</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">..</span><span class="tok-mi">6</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">15</span><span class="tok-o">)</span>

<span class="tok-c1">// Airports with 1,2 or 3 runways.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">15</span><span class="tok-o">)</span>

<span class="tok-c1">// Airports with fewer than 3 or more than 6 runways.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-n">without</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">..</span><span class="tok-mi">6</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">15</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>between</em> step lets us test the provided value for being greater than or equal to
a lower bound but less than an upper bound. The query below will find any airport
that has 5,6 or 7 runways. In other words, any airport that has at least 5 but fewer
than 8 runways.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Airports with at least 5 runways but fewer than 8</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-n">between</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">8</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the result of running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">DEN</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-n">DTW</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">AMS</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-n">SNN</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">MKE</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">MDW</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">GIS</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">HLZ</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">NPE</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">NSN</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">PPQ</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">TRG</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">UFA</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">KRP</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As with many queries we may build, there are several ways to get the same answer.
Each of the following queries will return the same result. To an extent which one
you use comes down to personal preference although in some cases one form of a query
may be better than another for reasons of performance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">)).</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-n">lte</span><span class="tok-o">(</span><span class="tok-mi">46</span><span class="tok-o">)).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-n">lte</span><span class="tok-o">(</span><span class="tok-mi">46</span><span class="tok-o">)).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">..</span><span class="tok-mi">46</span><span class="tok-o">)).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-n">lte</span><span class="tok-o">(</span><span class="tok-mi">46</span><span class="tok-o">)).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">..</span><span class="tok-mi">46</span><span class="tok-o">)).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-mi">1L</span><span class="tok-o">..</span><span class="tok-mi">46L</span><span class="tok-o">)).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-n">between</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">47</span><span class="tok-o">)).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-n">lte</span><span class="tok-o">(</span><span class="tok-mi">46</span><span class="tok-o">)).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">..</span><span class="tok-mi">46</span><span class="tok-o">)).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-n">between</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">47</span><span class="tok-o">)).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-n">inside</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">,</span><span class="tok-mi">47</span><span class="tok-o">)).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-n">lte</span><span class="tok-o">(</span><span class="tok-mi">46</span><span class="tok-o">)).</span><span class="tok-na">count</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The values do not have to be numbers. We could also compare strings for
example.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Let’s now look at a query that compares strings rather than numbers. The following
query finds all airports located in the state of Texas in the United States but only
returns their code if the name of the city the airport is located in is not <em>Houston</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-s1">'Houston'</span><span class="tok-o">)).</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This next query can be used to find routes between Austin and Las Vegas. We use a
<em>within</em> step to limit the results we get back to just routes that have a plane
change in Dallas, San Antonio or Houston airports.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
       <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'DFW'</span><span class="tok-o">,</span><span class="tok-s1">'DAL'</span><span class="tok-o">,</span><span class="tok-s1">'IAH'</span><span class="tok-o">,</span><span class="tok-s1">'HOU'</span><span class="tok-o">,</span><span class="tok-s1">'SAT'</span><span class="tok-o">)).</span>
       <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LAS'</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is what the query returns. Looks like we can change planes in Dallas or Houston
but nothing goes via San Antonio.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DAL</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">HOU</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Conversely, if we wanted to avoid certain airports we could use <em>without</em> instead.
This query again finds routes from Austin to Las Vegas but avoids any routes that go
via Phoenix (PHX) or Los Angeles (LAX).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
       <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">without</span><span class="tok-o">(</span><span class="tok-s1">'PHX'</span><span class="tok-o">,</span><span class="tok-s1">'LAX'</span><span class="tok-o">)).</span>
       <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LAS'</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lastly this query uses both within and without to modify the previous query to just
airports within the United States or Canada as Austin now has a direct flight to
London in England. We probably don’t want to go that way if we are headed to Vegas!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'US'</span><span class="tok-o">,</span><span class="tok-s1">'CA'</span><span class="tok-o">)).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">without</span><span class="tok-o">(</span><span class="tok-s1">'PHX'</span><span class="tok-o">,</span><span class="tok-s1">'LAX'</span><span class="tok-o">)).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LAS'</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>within</em> and <em>without</em> steps can take a variety of input types. For example, each
of these queries will yield the same results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Range of values (inclusive, inclusive)</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">..</span><span class="tok-mi">3</span><span class="tok-o">))</span>

<span class="tok-c1">// Explicit set of values</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">))</span>

<span class="tok-c1">// List of values</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-n">within</span><span class="tok-o">([</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You will find more examples of these types of queries in the next two sections.</p>
</div>
<div class="sect3">
<h4 id="startswith">3.12.1. Using <em>between</em> to simulate <em>startsWith</em></h4>
<div class="paragraph">
<p>One thing that may not be obvious is that when using string values with the <em>between</em>
predicate the values do not have to specify exact matches. Take a look at the query
below. This will find any airports in cities whose names start with <em>"Dal"</em> as it
looks for strings between <em>"Dal"</em> and <em>"Dam"</em> in an inclusive/exclusive fashion. The
rest of the characters following <em>"Dal"</em> in the strings being tested are ignored.
Note that this is a case sensitive comparison. In other words <em>"Dal"</em> and <em>"dal"</em> are
different strings in this context.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <em>between</em> predicate can be used to simulate a string <em>startsWith</em> method.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>As discussed more in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#fuzzyregs">Using regular expressions to do fuzzy searches</a>" section, Gremlin does not currently support
any methods for applying regular expressions or even more basic text analysis
operators to strings. This use of the <em>between</em> predicate can at least be used to
simulate a <em>startsWith</em> type of operator. It is likely that support for additional
text search predicates will appear in future Apache TinkerPop releases.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">between</span><span class="tok-o">(</span><span class="tok-s1">'Dal'</span><span class="tok-o">,</span><span class="tok-s1">'Dam'</span><span class="tok-o">)).</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results from running the query. As you can see every city name starts
with the characters <em>"Dal"</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">Dallas</span>
<span class="tok-n">Dallas</span>
<span class="tok-n">Dalaman</span>
<span class="tok-n">Dalian</span>
<span class="tok-n">Dalcahue</span>
<span class="tok-n">Dalat</span>
<span class="tok-n">Dalanzadgad</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You will notice from the results above that <em>"Dallas"</em> appears twice as there are two
airports with that city name. We could add a <em>dedup</em> step to our query to only return
unique matches.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">between</span><span class="tok-o">(</span><span class="tok-s1">'Dal'</span><span class="tok-o">,</span><span class="tok-s1">'Dam'</span><span class="tok-o">)).</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">dedup</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the modified results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">Dallas</span>
<span class="tok-n">Dalaman</span>
<span class="tok-n">Dalian</span>
<span class="tok-n">Dalcahue</span>
<span class="tok-n">Dalat</span>
<span class="tok-n">Dalanzadgad</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is one more example where the range of values being compared is expanded a
little. This query will find any cities that start with <em>"Dal"</em> through <em>"Dar"</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">between</span><span class="tok-o">(</span><span class="tok-s1">'Dal'</span><span class="tok-o">,</span><span class="tok-s1">'Dat'</span><span class="tok-o">)).</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">dedup</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see this time, more cities met our search criteria.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">Dalaman</span>
<span class="tok-n">Dalanzadgad</span>
<span class="tok-n">Dalat</span>
<span class="tok-n">Dalcahue</span>
<span class="tok-n">Dalian</span>
<span class="tok-n">Dallas</span>
<span class="tok-n">Damascus</span>
<span class="tok-n">Dandong</span>
<span class="tok-n">Dangriga</span>
<span class="tok-n">Daocheng</span>
<span class="tok-n">Daqing</span> <span class="tok-n">Shi</span>
<span class="tok-n">Dar</span> <span class="tok-n">es</span> <span class="tok-n">Salaam</span>
<span class="tok-n">Daru</span>
<span class="tok-n">Darwin</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you wanted to find strings that begin with a single character you can achieve
that as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">between</span><span class="tok-o">(</span><span class="tok-s1">'X'</span><span class="tok-o">,</span><span class="tok-s1">'Xa'</span><span class="tok-o">)).</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When run, the query returns all airports with codes that start with the letter <em>"X"</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">XNA</span><span class="tok-o">,</span><span class="tok-n">XMN</span><span class="tok-o">,</span><span class="tok-n">XRY</span><span class="tok-o">,</span><span class="tok-n">XIY</span><span class="tok-o">,</span><span class="tok-n">XUZ</span><span class="tok-o">,</span><span class="tok-n">XSB</span><span class="tok-o">,</span><span class="tok-n">XCH</span><span class="tok-o">,</span><span class="tok-n">XIL</span><span class="tok-o">,</span><span class="tok-n">XFN</span><span class="tok-o">,</span><span class="tok-n">XNN</span><span class="tok-o">,</span><span class="tok-n">XGR</span><span class="tok-o">,</span><span class="tok-n">XFW</span><span class="tok-o">,</span><span class="tok-n">XCR</span><span class="tok-o">,</span><span class="tok-n">XSC</span><span class="tok-o">,</span><span class="tok-n">XQP</span><span class="tok-o">,</span><span class="tok-n">XMH</span><span class="tok-o">,</span><span class="tok-n">XBJ</span><span class="tok-o">,</span><span class="tok-n">XAP</span><span class="tok-o">,</span><span class="tok-n">XMS</span><span class="tok-o">,</span><span class="tok-n">XKH</span><span class="tok-o">,</span><span class="tok-n">XIC</span><span class="tok-o">,</span><span class="tok-n">XTG</span><span class="tok-o">,</span><span class="tok-n">XKS</span><span class="tok-o">,</span><span class="tok-n">XBE</span><span class="tok-o">,</span><span class="tok-n">XTO</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>While Gremlin does not currently provide any advanced text searching capabilities,
graph systems such as JanusGraph do offer such capabilities. Those features are
discussed in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#janpred">Additional JanusGraph text search predicates</a>" section.</p>
</div>
</div>
<div class="sect3">
<h4 id="winout">3.12.2. Refining flight routes analysis using <em>not</em>, <em>neq</em>, <em>within</em> and <em>without</em></h4>
<div class="paragraph">
<p>As we saw in the previous section, it is often useful to be able to specifically
include or exclude values from a query. We have already seen a few examples of
<em>within</em> and <em>without</em> being used in the section above. The following examples show
additional queries that use <em>within</em> and <em>without</em> as well as some examples that use
the <em>neq</em> (not equal) and <em>not</em> steps to exclude certain airports from query results.</p>
</div>
<div class="paragraph">
<p>The following query finds routes from AUS to SYD with only one stop but ignores any
routes that stop in DFW.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-s1">'DFW'</span><span class="tok-o">)).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SYD'</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could also have written the query using <em>not</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">not</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-s1">'DFW'</span><span class="tok-o">)).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SYD'</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Similar to the above but adding an <em>and</em> clause to also avoid LAX</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">and</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-s1">'DFW'</span><span class="tok-o">)),</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-s1">'LAX'</span><span class="tok-o">))).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SYD'</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could also have written the prior query this way replacing <em>and</em> with <em>without</em>.
This approach feels a lot cleaner and it is easy to add more airports to the
<em>without</em> test as needed. We will look more at steps like <em>and</em> in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#bool">Boolean operations</a>"
section that is coming up soon.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Flights to Sydney avoiding DFW and LAX</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">without</span><span class="tok-o">(</span><span class="tok-s1">'DFW'</span><span class="tok-o">,</span><span class="tok-s1">'LAX'</span><span class="tok-o">)).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SYD'</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using <em>without</em> is especially useful when you want to exclude a list of items from a
query. This next query finds routes from San Antonio to Salt Lake City with one stop
but avoids any routes that pass through a list of specified airports.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// How can I get from SAT to SLC but avoiding DFW,LAX,PHX and JFK ?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAT'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">without</span><span class="tok-o">(</span><span class="tok-s1">'DFW'</span><span class="tok-o">,</span><span class="tok-s1">'LAX'</span><span class="tok-o">,</span><span class="tok-s1">'PHX'</span><span class="tok-o">,</span><span class="tok-s1">'JFK'</span><span class="tok-o">)).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SLC'</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In a similar way, <em>within</em> allows us to specifically give a list of things that we
<strong>are</strong> interested in. The query below again looks at routes from SAT to SLC with one
stop but this time only returns routes that stop in one of the designated airports.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// From AUS to SLC with a stop in any one of DFW,LAX,PHX or TUS</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAT'</span><span class="tok-o">).</span>
       <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'DFW'</span><span class="tok-o">,</span><span class="tok-s1">'LAX'</span><span class="tok-o">,</span><span class="tok-s1">'PHX'</span><span class="tok-o">,</span><span class="tok-s1">'TUS'</span><span class="tok-o">)).</span>
       <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SLC'</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is what the query returns.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-n">SLC</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">SLC</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are two more examples that use <em>without</em> and <em>within</em> to find routes based on
countries.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Flights from Austin to countries outside (without) the US and Canada</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-n">without</span><span class="tok-o">(</span><span class="tok-s1">'US'</span><span class="tok-o">,</span><span class="tok-s1">'CA'</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the output from running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">London</span>
<span class="tok-n">Frankfurt</span>
<span class="tok-n">Mexico</span> <span class="tok-n">City</span>
<span class="tok-n">Cancun</span>
<span class="tok-n">Guadalajara</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is a twist on the previous query that looks for destinations in Mexico or Canada
that you can fly to non stop from Austin.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Flights from Austin to airports in (within) Mexico or Canada</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'MX'</span><span class="tok-o">,</span><span class="tok-s1">'CA'</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is what we get back from our new query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">Toronto</span>
<span class="tok-n">Mexico</span> <span class="tok-n">City</span>
<span class="tok-n">Cancun</span>
<span class="tok-n">Guadalajara</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_coin_and_sample_to_sample_a_dataset">3.12.3. Using <em>coin</em> and <em>sample</em> to sample a dataset</h4>
<div class="paragraph">
<p>In any sort of analysis work it is often useful to be able to take a sample, perhaps
a pseudo random sample, of the data set contained within your graph. The <em>coin</em> step
allows you to do just that. It simulates a biased coin toss. You give <em>coin</em> a value
indicating how biased the toss should be. The value should be between 0 and 1, where
0 means there is no chance something will get picked (not that useful!), 1 means
everything will get picked (also not that useful!) and 0.5 means there is an even
50/50 chance that an item will get selected.</p>
</div>
<div class="paragraph">
<p>The following query simply picks airports with a 50/50 coin toss and returns the
airport code for the first 20 found.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Pick 20 airports at random with an evenly biased coin (50% chance).</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">coin</span><span class="tok-o">(</span><span class="tok-mf">0.5</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">20</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This next query is similar to the first but takes a subtly different approach.
It will select a pseudo random sample of vertices from the graph and for each one
picked return its code and its elevation. Note that a very small value of
0.05 (or 5% chance of success) is used for the <em>coin</em> bias parameter this
time. This has the effect that only a small number of vertices are likely to get
selected but there is a better chance they will come from all parts of the
graph and avoids needing a <em>limit</em> step. Of course, there is no guarantee how
many airports this query will pick!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Select some vertices at random and return them with their elevation.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">coin</span><span class="tok-o">(</span><span class="tok-mf">0.05</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'elev'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can see how fairly the <em>coin</em> step is working by counting the number of vertices
returned. The following query should always return a count representing approximately
half of the airports in the graph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">coin</span><span class="tok-o">(</span><span class="tok-mf">0.5</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If all you want is, say 20 randomly selected vertices, without worrying about
setting the value of the coin yourself, you can use the <em>sample</em>
step instead.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">sample</span><span class="tok-o">(</span><span class="tok-mi">20</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_math_random_to_more_randomly_select_a_single_vertex">3.12.4. Using <em>Math.random</em> to more randomly select a single vertex</h4>
<div class="paragraph">
<p>While the <em>sample</em> step allows you to select one or more vertices at random, in my
testing, at least when using a TinkerGraph, it tends to favor vertices with lower
index values. So for example, in a test I ran this query 1000 times.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">sample</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">id</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>What I found was that I always got back an ID of less than 200. This leads me to
believe that the <em>sample(1)</em> call is doing something similar to this</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">coin</span><span class="tok-o">(</span><span class="tok-mf">0.01</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Look at the code below. Even if I run that simple experiment many times it always gives
results similar to these.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">..</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">each</span> <span class="tok-o">{</span> <span class="tok-n">println</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">sample</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">id</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()}</span>

<span class="tok-mi">69</span>
<span class="tok-mi">143</span>
<span class="tok-mi">94</span>
<span class="tok-mi">115</span>
<span class="tok-mi">36</span>
<span class="tok-mi">47</span>
<span class="tok-mi">23</span>
<span class="tok-mi">22</span>
<span class="tok-mi">129</span>
<span class="tok-mi">67</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Given the air routes graph has over 3,300 airport vertices I wanted to come up with a
query that gave a more likely result of picking any one airport from across all of
the possible airports in the graph. By taking advantage of the Java Math class we can
do something that does seem to much more <em>randomly</em> pick one airport from across all
of the possible airports. Take a look at the snippets of Groovy/Gremlin code below.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
More examples of using variables to store values and other ways to use
additional Groovy classes and methods with Gremlin are provided in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#grv">Making Gremlin even Groovier</a>" and
"<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#varaus">Using a variable to feed a traversal</a>" sections.
</td>
</tr>
</tbody></table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// How many airports are there?</span>
<span class="tok-n">numAirports</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()</span>

<span class="tok-mi">3374</span>

<span class="tok-c1">// Pick a random airport ID</span>
<span class="tok-n">x</span><span class="tok-o">=</span><span class="tok-n">Math</span><span class="tok-o">.</span><span class="tok-na">round</span><span class="tok-o">(</span><span class="tok-n">numAirports</span><span class="tok-o">*</span><span class="tok-n">Math</span><span class="tok-o">.</span><span class="tok-na">random</span><span class="tok-o">())</span> <span class="tok-k">as</span> <span class="tok-n">Integer</span>

<span class="tok-mi">2359</span>

<span class="tok-c1">// Get the code for our randomly selected airport</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-n">x</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-n">PHO</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This simple experiment shows that the numbers being generated using the <em>Math.random</em>
approach appears to be a lot more evenly distributed across all of the possible airports.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">..</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">each</span> <span class="tok-o">{</span> <span class="tok-n">println</span> <span class="tok-n">Math</span><span class="tok-o">.</span><span class="tok-na">round</span><span class="tok-o">(</span><span class="tok-n">numAirports</span><span class="tok-o">*</span><span class="tok-n">Math</span><span class="tok-o">.</span><span class="tok-na">random</span><span class="tok-o">())</span> <span class="tok-k">as</span> <span class="tok-n">Integer</span><span class="tok-o">}</span>

<span class="tok-mi">1514</span>
<span class="tok-mi">18</span>
<span class="tok-mi">3087</span>
<span class="tok-mi">1292</span>
<span class="tok-mi">3062</span>
<span class="tok-mi">2772</span>
<span class="tok-mi">2401</span>
<span class="tok-mi">400</span>
<span class="tok-mi">2084</span>
<span class="tok-mi">3028</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that this approach only works unmodified with the <em>air-routes</em> graph loaded into a
TinkerGraph. This is because we know that the TinkerGraph implementation honors user
provided IDs and that in the <em>air-routes</em> graph, airport IDs begin at one and are
sequential with no gaps. However, you could easily modify this approach to work with
other graphs without relying on knowing that the index values are sequential. For
example you could extract all of the IDs into a list and then select one randomly
from that list.</p>
</div>
<div class="paragraph">
<p>It is likely that this apparent lack of randomness is more specific to TinkerGraph
and the fact that it will respect user provided ID values whereas other graph systems
will probably store vertices in a more random order to begin with. Indeed when I ran
these queries on JanusGraph the <em>sample</em> step did yield a better selection of
airports from across the graph.</p>
</div>
<div class="paragraph">
<p>If the airport IDs were not all known to be in a sequential order one after the
other, we could create a list of all the airport IDs and then select one at random by
doing something like this if we wanted to use our <em>Math.random</em> technique.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">airports</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">id</span><span class="tok-o">().</span><span class="tok-na">toList</span><span class="tok-o">()</span>

<span class="tok-n">numAirports</span> <span class="tok-o">=</span> <span class="tok-n">airports</span><span class="tok-o">.</span><span class="tok-na">size</span>

<span class="tok-mi">3374</span>

<span class="tok-n">x</span><span class="tok-o">=</span><span class="tok-n">Math</span><span class="tok-o">.</span><span class="tok-na">round</span><span class="tok-o">(</span><span class="tok-n">numAirports</span><span class="tok-o">*</span><span class="tok-n">Math</span><span class="tok-o">.</span><span class="tok-na">random</span><span class="tok-o">())</span> <span class="tok-k">as</span> <span class="tok-n">Integer</span>

<span class="tok-mi">859</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-n">airports</span><span class="tok-o">[</span><span class="tok-n">x</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-o">])</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">859</span><span class="tok-o">]</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-n">airports</span><span class="tok-o">[</span><span class="tok-n">x</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-o">]).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-n">OSR</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="textpredicates">3.13. New text search predicates added in TinkerPop 3.4</h3>
<div class="paragraph">
<p>Probably one of, if not the, most anticipated features in Apache TinkerPop version
3.4 was the addition of new <em>"predicates"</em> that aid in performing more focused text
searches.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Additional information on the text predicates can be found in the official
Apache TinkerPop documentation here: <a href="http://tinkerpop.apache.org/docs/current/reference/#a-note-on-predicates" class="bare">http://tinkerpop.apache.org/docs/current/reference/#a-note-on-predicates</a>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>In total, six new predicates were added to the Gremlin query language. There are
three predicates that search for the existence of one or more characters within a
string of text and three that search for the non existence of one or more characters.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Text searching predicates</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">startingWith</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Match text that starts with the given character(s)</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">endingWith</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Match text that ends with the given charcter(s)</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">containing</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Match text that contains the given character(s)</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">notStartingWith</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Match text that does not start with the given character(s)</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">notEndingWith</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Match text that does not end with the given charcter(s)</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">notContaining</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Match text that does notcontain the given character(s)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In the sections below you will find examples of each predicate being used. Each
predicate is case sensitive so bear that in mind as you use them. To do a case
insensitive search you can chain multiple steps together combined by an <em>or</em> step.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
All of these predicates are <strong><em>case sensitive</em></strong>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>These predicates add to the existing Gremlin predicates that we looked at in the
<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#tranges">Testing values and ranges of values</a> section.</p>
</div>
<div class="sect3">
<h4 id="startingwith">3.13.1. startingWith</h4>
<div class="paragraph">
<p>The text that you search for can be one or more characters. Here is a
simple example that looks for unique city names that begin with an uppercase "X".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">startingWith</span><span class="tok-o">(</span><span class="tok-s1">'X'</span><span class="tok-o">)).</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As expected, when run we get back a set of names all beginning with an "X".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">Xiamen</span>
<span class="tok-n">Xianyang</span>
<span class="tok-n">Xuzhou</span>
<span class="tok-n">Xilinhot</span>
<span class="tok-n">Xiangfan</span>
<span class="tok-n">Xining</span>
<span class="tok-n">Xalapa</span>
<span class="tok-n">Xieng</span> <span class="tok-n">Khouang</span>
<span class="tok-n">Xiahe</span>
<span class="tok-n">Xiaguan</span>
<span class="tok-n">Xichang</span>
<span class="tok-n">Xingyi</span>
<span class="tok-n">Xinyuan</span>
<span class="tok-n">Xigaze</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The example below looks for any cities with names starting with "Dal". A <em>dedup</em> step
is used to get rid of any duplicate names in the results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">startingWith</span><span class="tok-o">(</span><span class="tok-s1">'Dal'</span><span class="tok-o">)).</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span>
      <span class="tok-n">dedup</span><span class="tok-o">().</span>
      <span class="tok-n">fold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When run, the query finds all the city names in the graph that begin with the
characters "Dal" as expected.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">Dalat</span><span class="tok-o">,</span> <span class="tok-n">Dallas</span><span class="tok-o">,</span> <span class="tok-n">Dalcahue</span><span class="tok-o">,</span> <span class="tok-n">Dalaman</span><span class="tok-o">,</span> <span class="tok-n">Dalian</span><span class="tok-o">,</span> <span class="tok-n">Dalanzadgad</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As I mentioned, all of the text predicates are case sensitive. If we were
to search for city names starting with the characters "dal" we would not find any
matches. The query below demonstrates this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">startingWith</span><span class="tok-o">(</span><span class="tok-s1">'dal'</span><span class="tok-o">)).</span>
      <span class="tok-n">count</span><span class="tok-o">()</span>

<span class="tok-mi">0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Given the predicates are case sensitive, if, for example, you need to find matches
for both <em>Dal</em> or <em>dal</em> you can do that as shown below using an <em>or</em> step and two
<em>has</em> steps.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">or</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">startingWith</span><span class="tok-o">(</span><span class="tok-s1">'dal'</span><span class="tok-o">)),</span>
         <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">startingWith</span><span class="tok-o">(</span><span class="tok-s1">'Dal'</span><span class="tok-o">))).</span>
      <span class="tok-n">dedup</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span>
      <span class="tok-n">count</span><span class="tok-o">()</span>

<span class="tok-mi">6</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="endingwith">3.13.2. endingWith</h4>
<div class="paragraph">
<p>The example below looks for any city names ending with that characters "zhi".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">endingWith</span><span class="tok-o">(</span><span class="tok-s1">'zhi'</span><span class="tok-o">)).</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span>

<span class="tok-n">Changzhi</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="containing">3.13.3. containing</h4>
<div class="paragraph">
<p>We can also look for cities whose names contain a certain string of one or more
characters. The example below looks for any cities with the string "gzh" in their
name.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">containing</span><span class="tok-o">(</span><span class="tok-s1">'gzh'</span><span class="tok-o">)).</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When run the query produces the following results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">Guangzhou</span>
<span class="tok-n">Hangzhou</span>
<span class="tok-n">Zhengzhou</span>
<span class="tok-n">Changzhi</span>
<span class="tok-n">Changzhou</span>
<span class="tok-n">Yongzhou</span>
<span class="tok-n">Yangzho</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="notStartingWith">3.13.4. notStartingWith</h4>
<div class="paragraph">
<p>Each of the text predicates has an inverse step. We can use the <em>notStartingWith</em>
predicate to look for city names that do not start with "Dal".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">notStartingWith</span><span class="tok-o">(</span><span class="tok-s1">'Dal'</span><span class="tok-o">)).</span>
      <span class="tok-n">count</span><span class="tok-o">()</span>

<span class="tok-mi">3367</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above returns the same results we would get if we were to negate a
<em>startingWith</em> predicate as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">not</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">startingWith</span><span class="tok-o">(</span><span class="tok-s1">'Dal'</span><span class="tok-o">))).</span>
      <span class="tok-n">count</span><span class="tok-o">()</span>

<span class="tok-mi">3367</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="notEndingWith">3.13.5. notEndingWith</h4>
<div class="paragraph">
<p>Using <em>notEndingWith</em> we can easily find cities whose names do not end with "zhi".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">notEndingWith</span><span class="tok-o">(</span><span class="tok-s1">'zhi'</span><span class="tok-o">)).</span>
      <span class="tok-n">count</span><span class="tok-o">()</span>

<span class="tok-mi">3373</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="notContaining">3.13.6. notContaining</h4>
<div class="paragraph">
<p>The query below counts the number of cities that do not contain the string "berg" in
their name.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">notContaining</span><span class="tok-o">(</span><span class="tok-s1">'berg'</span><span class="tok-o">)).</span>
      <span class="tok-n">count</span><span class="tok-o">()</span>

<span class="tok-mi">3370</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s now do something a little more interesting. The query below chains together a
number of has steps using <em>notContaining</em> and <em>containing</em> predicates to find cities
with names containing no basic, lowercase, vowels commonly used in the English
language but containing either of the secondary vowels.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">notContaining</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">)).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">notContaining</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">)).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">notContaining</span><span class="tok-o">(</span><span class="tok-s1">'i'</span><span class="tok-o">)).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">notContaining</span><span class="tok-o">(</span><span class="tok-s1">'u'</span><span class="tok-o">)).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">notContaining</span><span class="tok-o">(</span><span class="tok-s1">'o'</span><span class="tok-o">)).</span>
      <span class="tok-n">or</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">containing</span><span class="tok-o">(</span><span class="tok-s1">'y'</span><span class="tok-o">)),</span>
         <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">containing</span><span class="tok-o">(</span><span class="tok-s1">'h'</span><span class="tok-o">))).</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span>
      <span class="tok-n">dedup</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Only two results are found. Note that one of the results does contain a vowel but it
is an uppercase "O" and as such is allowed by the constraints that we specified.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">Osh</span>
<span class="tok-n">Kyzyl</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sort">3.14. Sorting things - introducing <em>order</em></h3>
<div class="paragraph">
<p>You can use <em>order</em> to sort things in either ascending (the default) or descending
order. Note that the sort does not have to be the last step of a query. It is
perfectly OK to sort things in the middle of a query before moving on to a further
step. We can see examples of that in the first two queries below. Note that the first
query will return different results than the second one due to the placement of the
<em>limit</em> step. I used <em>fold</em> at the end of the query to collect all of the results
into a list. The <em>fold</em> step can also do more than this. It provides a way of doing
the <em>reduce</em> part of map-reduce operations. We will see some other examples of its
use elsewhere in this book, such as in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#mapreduce">Using <em>fold</em> to do simple Map-Reduce computations</a>" section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Sort the first 20 airports returned in ascending order</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">20</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">BNA</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">,</span><span class="tok-n">DCA</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">FLL</span><span class="tok-o">,</span><span class="tok-n">IAD</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-n">LGA</span><span class="tok-o">,</span><span class="tok-n">MCO</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">,</span><span class="tok-n">MSP</span><span class="tok-o">,</span><span class="tok-n">ORD</span><span class="tok-o">,</span><span class="tok-n">PBI</span><span class="tok-o">,</span><span class="tok-n">PHX</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As above, but this time perform the <em>limit</em> step after the <em>order</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Sort all of the airports in the graph by their code and then return the first 20</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">20</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">AAE</span><span class="tok-o">,</span><span class="tok-n">AAL</span><span class="tok-o">,</span><span class="tok-n">AAN</span><span class="tok-o">,</span><span class="tok-n">AAQ</span><span class="tok-o">,</span><span class="tok-n">AAR</span><span class="tok-o">,</span><span class="tok-n">AAT</span><span class="tok-o">,</span><span class="tok-n">AAX</span><span class="tok-o">,</span><span class="tok-n">AAY</span><span class="tok-o">,</span><span class="tok-n">ABA</span><span class="tok-o">,</span><span class="tok-n">ABB</span><span class="tok-o">,</span><span class="tok-n">ABD</span><span class="tok-o">,</span><span class="tok-n">ABE</span><span class="tok-o">,</span><span class="tok-n">ABI</span><span class="tok-o">,</span><span class="tok-n">ABJ</span><span class="tok-o">,</span><span class="tok-n">ABL</span><span class="tok-o">,</span><span class="tok-n">ABM</span><span class="tok-o">,</span><span class="tok-n">ABQ</span><span class="tok-o">,</span><span class="tok-n">ABR</span><span class="tok-o">,</span><span class="tok-n">ABS</span><span class="tok-o">,</span><span class="tok-n">ABT</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is a similar example to the previous two. We find all of the places you can fly
to from Austin (AUS) and sort the results as before, using the airport’s IATA code,
but this time we also include the ICAO code for each airport in the result set.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
                        <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'icao'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results from running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">ABQ</span><span class="tok-o">,</span><span class="tok-n">KABQ</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">KATL</span><span class="tok-o">,</span><span class="tok-n">BKG</span><span class="tok-o">,</span><span class="tok-n">KBBG</span><span class="tok-o">,</span><span class="tok-n">BNA</span><span class="tok-o">,</span><span class="tok-n">KBNA</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-n">KBOS</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">,</span><span class="tok-n">KBWI</span><span class="tok-o">,</span><span class="tok-n">CLE</span><span class="tok-o">,</span><span class="tok-n">KCLE</span><span class="tok-o">,</span><span class="tok-n">CLT</span><span class="tok-o">,</span><span class="tok-n">KCLT</span><span class="tok-o">,</span><span class="tok-n">CUN</span><span class="tok-o">,</span><span class="tok-n">MMUN</span><span class="tok-o">,</span><span class="tok-n">CVG</span><span class="tok-o">,</span><span class="tok-n">KCVG</span><span class="tok-o">,</span><span class="tok-n">DAL</span><span class="tok-o">,</span><span class="tok-n">KDAL</span><span class="tok-o">,</span><span class="tok-n">DCA</span><span class="tok-o">,</span><span class="tok-n">KDCA</span><span class="tok-o">,</span><span class="tok-n">DEN</span><span class="tok-o">,</span><span class="tok-n">KDEN</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">KDFW</span><span class="tok-o">,</span><span class="tok-n">DTW</span><span class="tok-o">,</span><span class="tok-n">KDTW</span><span class="tok-o">,</span><span class="tok-n">ELP</span><span class="tok-o">,</span><span class="tok-n">KELP</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">KEWR</span><span class="tok-o">,</span><span class="tok-n">FLL</span><span class="tok-o">,</span><span class="tok-n">KFLL</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-n">EDDF</span><span class="tok-o">,</span><span class="tok-n">GDL</span><span class="tok-o">,</span><span class="tok-n">MMGL</span><span class="tok-o">,</span><span class="tok-n">HOU</span><span class="tok-o">,</span><span class="tok-n">KHOU</span><span class="tok-o">,</span><span class="tok-n">HRL</span><span class="tok-o">,</span><span class="tok-n">KHRL</span><span class="tok-o">,</span><span class="tok-n">IAD</span><span class="tok-o">,</span><span class="tok-n">KIAD</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-n">KIAH</span><span class="tok-o">,</span><span class="tok-n">IND</span><span class="tok-o">,</span><span class="tok-n">KIND</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-n">KJFK</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">,</span><span class="tok-n">KLAS</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-n">KLAX</span><span class="tok-o">,</span><span class="tok-n">LBB</span><span class="tok-o">,</span><span class="tok-n">KLBB</span><span class="tok-o">,</span><span class="tok-n">LGB</span><span class="tok-o">,</span><span class="tok-n">KLGB</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">EGLL</span><span class="tok-o">,</span><span class="tok-n">MCI</span><span class="tok-o">,</span><span class="tok-n">KMCI</span><span class="tok-o">,</span><span class="tok-n">MCO</span><span class="tok-o">,</span><span class="tok-n">KMCO</span><span class="tok-o">,</span><span class="tok-n">MDW</span><span class="tok-o">,</span><span class="tok-n">KMDW</span><span class="tok-o">,</span><span class="tok-n">MEM</span><span class="tok-o">,</span><span class="tok-n">KMEM</span><span class="tok-o">,</span><span class="tok-n">MEX</span><span class="tok-o">,</span><span class="tok-n">MMMX</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">,</span><span class="tok-n">KMIA</span><span class="tok-o">,</span><span class="tok-n">MSP</span><span class="tok-o">,</span><span class="tok-n">KMSP</span><span class="tok-o">,</span><span class="tok-n">MSY</span><span class="tok-o">,</span><span class="tok-n">KMSY</span><span class="tok-o">,</span><span class="tok-n">OAK</span><span class="tok-o">,</span><span class="tok-n">KOAK</span><span class="tok-o">,</span><span class="tok-n">ORD</span><span class="tok-o">,</span><span class="tok-n">KORD</span><span class="tok-o">,</span><span class="tok-n">PDX</span><span class="tok-o">,</span><span class="tok-n">KPDX</span><span class="tok-o">,</span><span class="tok-n">PHL</span><span class="tok-o">,</span><span class="tok-n">KPHL</span><span class="tok-o">,</span><span class="tok-n">PHX</span><span class="tok-o">,</span><span class="tok-n">KPHX</span><span class="tok-o">,</span><span class="tok-n">PIE</span><span class="tok-o">,</span><span class="tok-n">KPIE</span><span class="tok-o">,</span><span class="tok-n">PIT</span><span class="tok-o">,</span><span class="tok-n">KPIT</span><span class="tok-o">,</span><span class="tok-n">PNS</span><span class="tok-o">,</span><span class="tok-n">KPNS</span><span class="tok-o">,</span><span class="tok-n">RDU</span><span class="tok-o">,</span><span class="tok-n">KRDU</span><span class="tok-o">,</span><span class="tok-n">SAN</span><span class="tok-o">,</span><span class="tok-n">KSAN</span><span class="tok-o">,</span><span class="tok-n">SEA</span><span class="tok-o">,</span><span class="tok-n">KSEA</span><span class="tok-o">,</span><span class="tok-n">SFB</span><span class="tok-o">,</span><span class="tok-n">KSFB</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">KSFO</span><span class="tok-o">,</span><span class="tok-n">SJC</span><span class="tok-o">,</span><span class="tok-n">KSJC</span><span class="tok-o">,</span><span class="tok-n">SLC</span><span class="tok-o">,</span><span class="tok-n">KSLC</span><span class="tok-o">,</span><span class="tok-n">SNA</span><span class="tok-o">,</span><span class="tok-n">KSNA</span><span class="tok-o">,</span><span class="tok-n">STL</span><span class="tok-o">,</span><span class="tok-n">KSTL</span><span class="tok-o">,</span><span class="tok-n">TPA</span><span class="tok-o">,</span><span class="tok-n">KTPA</span><span class="tok-o">,</span><span class="tok-n">VPS</span><span class="tok-o">,</span><span class="tok-n">KVPS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">CYYZ</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By default a sort performed using <em>order</em> returns results in ascending order. To
obtain results in descending order instead, <em>desc</em> can be specified using a <code>by</code>
modulator. Likewise, <em>asc</em> can be used to make it clear that sorting in ascending
order is required.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Sort the first 20 airports returned in descending order</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">20</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">desc</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">PHX</span><span class="tok-o">,</span><span class="tok-n">PBI</span><span class="tok-o">,</span><span class="tok-n">ORD</span><span class="tok-o">,</span><span class="tok-n">MSP</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">,</span><span class="tok-n">MCO</span><span class="tok-o">,</span><span class="tok-n">LGA</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-n">IAD</span><span class="tok-o">,</span><span class="tok-n">FLL</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">DCA</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-n">BNA</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also sort things into a random order using <em>shuffle</em>. Take a look at the
example below and the output it produces.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">20</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">shuffle</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">MCO</span><span class="tok-o">,</span><span class="tok-n">LGA</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">,</span><span class="tok-n">IAD</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-n">DCA</span><span class="tok-o">,</span><span class="tok-n">BNA</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">,</span><span class="tok-n">MSP</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-n">ORD</span><span class="tok-o">,</span><span class="tok-n">PBI</span><span class="tok-o">,</span><span class="tok-n">FLL</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-n">PHX</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Below is an example where we combine the field we want to sort by <em>longest</em>
and the direction we want the sort to take, <em>desc</em> into a single <em>by</em> instruction.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// List the 10 airports with the longest runways in decreasing order.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'longest'</span><span class="tok-o">,</span><span class="tok-n">desc</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">().</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'longest'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the output from running the query. To save space I have split the results
into two columns.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">BPX</span><span class="tok-o">],</span><span class="tok-nl">longest:</span><span class="tok-o">[</span><span class="tok-mi">18045</span><span class="tok-o">]]</span>    <span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">DOH</span><span class="tok-o">],</span><span class="tok-nl">longest:</span><span class="tok-o">[</span><span class="tok-mi">15912</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">RKZ</span><span class="tok-o">],</span><span class="tok-nl">longest:</span><span class="tok-o">[</span><span class="tok-mi">16404</span><span class="tok-o">]]</span>    <span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">GOQ</span><span class="tok-o">],</span><span class="tok-nl">longest:</span><span class="tok-o">[</span><span class="tok-mi">15748</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">ULY</span><span class="tok-o">],</span><span class="tok-nl">longest:</span><span class="tok-o">[</span><span class="tok-mi">16404</span><span class="tok-o">]]</span>    <span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">HRE</span><span class="tok-o">],</span><span class="tok-nl">longest:</span><span class="tok-o">[</span><span class="tok-mi">15502</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">UTN</span><span class="tok-o">],</span><span class="tok-nl">longest:</span><span class="tok-o">[</span><span class="tok-mi">16076</span><span class="tok-o">]]</span>    <span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">FIH</span><span class="tok-o">],</span><span class="tok-nl">longest:</span><span class="tok-o">[</span><span class="tok-mi">15420</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">DEN</span><span class="tok-o">],</span><span class="tok-nl">longest:</span><span class="tok-o">[</span><span class="tok-mi">16000</span><span class="tok-o">]]</span>    <span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">ZIA</span><span class="tok-o">],</span><span class="tok-nl">longest:</span><span class="tok-o">[</span><span class="tok-mi">15092</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s look at another way we could have coded the query we used earlier to
find the longest runway in the graph. As you may recall, we used the following
query. While the query does indeed find the longest runway in the graph, if we wanted
to know which airport or airports had runways of that length we would have to run a
second query to find them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'longest'</span><span class="tok-o">).</span><span class="tok-na">max</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we know how to sort things we could write a slightly more complex query that
sorts all the airports by longest runway in descending order and returns the
<em>valueMap</em> for the first of those. While this query could probably be written more
efficiently and also improved to handle cases where more than one airport has the
longest runway, it provides a nice example of using <em>order</em> to find an airport that
we are interested in.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'longest'</span><span class="tok-o">),</span><span class="tok-n">desc</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the case of the <em>air-routes</em> graph there is only one airport with the longest
runway. The runway at the Chinese city of Bangda is 18,045 feet long. The reason the
runway is so long is due to the altitude of the airport which is located 14,219 feet
above sea level. Aircraft need a lot more runway to operate safely at that altitude!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">country:</span><span class="tok-o">[</span><span class="tok-n">CN</span><span class="tok-o">],</span> <span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">BPX</span><span class="tok-o">],</span> <span class="tok-nl">longest:</span><span class="tok-o">[</span><span class="tok-mi">18045</span><span class="tok-o">],</span> <span class="tok-nl">city:</span><span class="tok-o">[</span><span class="tok-n">Bangda</span><span class="tok-o">],</span> <span class="tok-nl">elev:</span><span class="tok-o">[</span><span class="tok-mi">14219</span><span class="tok-o">],</span> <span class="tok-nl">icao:</span><span class="tok-o">[</span><span class="tok-n">ZUBD</span><span class="tok-o">],</span> <span class="tok-nl">lon:</span><span class="tok-o">[</span><span class="tok-mf">97.1082992553711</span><span class="tok-o">],</span> <span class="tok-nl">type:</span><span class="tok-o">[</span><span class="tok-n">airport</span><span class="tok-o">],</span> <span class="tok-nl">region:</span><span class="tok-o">[</span><span class="tok-n">CN</span><span class="tok-o">-</span><span class="tok-mi">54</span><span class="tok-o">],</span> <span class="tok-nl">runways:</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">],</span> <span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">30.5536003112793</span><span class="tok-o">],</span> <span class="tok-nl">desc:</span><span class="tok-o">[</span><span class="tok-n">Qamdo</span> <span class="tok-n">Bangda</span> <span class="tok-n">Airport</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="sortkeyvalue">3.14.1. Sorting by key or value</h4>
<div class="paragraph">
<p>Sometimes, when the results of a query are a set of one or more key:value pairs, we
need to sort by either the key or the value in either ascending or descending order.
Gremlin offers us ways that we can control the sort in these cases. Examples of how
this works are shown below.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In Tinkerpop 3.3 changes to the syntax were made. The previous keywords
<em>valueDecr</em>, <em>valueIncr</em>, <em>keyDecr</em> and <em>keyIncr</em> are now specified using the form
<em>by(keys,asc)</em> or <em>by(values,desc)</em> etc.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The following example shows the difference between running a query with and without
the use of <em>order</em> to sort using the keys of the map created by the <em>group</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Query but do not order</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">BNA:</span><span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">],</span><span class="tok-nl">ANC:</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-nl">BOS:</span><span class="tok-o">[</span><span class="tok-mi">6</span><span class="tok-o">],</span><span class="tok-nl">ATL:</span><span class="tok-o">[</span><span class="tok-mi">5</span><span class="tok-o">],</span><span class="tok-nl">AUS:</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice also how <em>local</em> is used as a parameter to <em>order</em>. This
is required so that the ordering is done while the final list is being constructed.
If you do not specify <em>local</em> then <em>order</em> will have no effect as it will be applied to
the entire result which is treated as a single entity at that point.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Query and order by airport code (the key)</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span>
      <span class="tok-n">order</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">keys</span><span class="tok-o">,</span><span class="tok-n">asc</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">ANC:</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-nl">ATL:</span><span class="tok-o">[</span><span class="tok-mi">5</span><span class="tok-o">],</span><span class="tok-nl">AUS:</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">],</span><span class="tok-nl">BNA:</span><span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">],</span><span class="tok-nl">BOS:</span><span class="tok-o">[</span><span class="tok-mi">6</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example we make the numbers of runways the key field and sort on it in
descending order.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
      <span class="tok-n">order</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">keys</span><span class="tok-o">,</span><span class="tok-n">desc</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-mi">7</span><span class="tok-o">:[</span><span class="tok-n">DFW</span><span class="tok-o">],</span><span class="tok-mi">6</span><span class="tok-o">:[</span><span class="tok-n">BOS</span><span class="tok-o">],</span><span class="tok-mi">5</span><span class="tok-o">:[</span><span class="tok-n">ATL</span><span class="tok-o">],</span><span class="tok-mi">4</span><span class="tok-o">:[</span><span class="tok-n">BNA</span><span class="tok-o">,</span><span class="tok-n">IAD</span><span class="tok-o">],</span><span class="tok-mi">3</span><span class="tok-o">:[</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">,</span><span class="tok-n">DCA</span><span class="tok-o">],</span><span class="tok-mi">2</span><span class="tok-o">:[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">FLL</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="orderchanges">3.14.2. Changes to <em>order</em> introduced in TinkerPop release 3.3.4</h4>
<div class="paragraph">
<p>On October 15th 2018 a change was introduced as part of the Apache TinkerPop 3.3.4
release This change deprecated the <em>incr</em> and <em>decr</em> keywords recognized by the
<em>order</em> step in favor of the, new at the time, <em>asc</em> and <em>desc</em> keywords. This book
and its accompanying code samples have been updated to only use <em>asc</em> and <em>desc</em>. If
the database you are using supports a version of Apache TinkerPop at the 3.3.4 level
or higher you should be using the new keywords.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <em>Order.incr</em> and <em>Order.decr</em> enumerations were deprecated in the TinkerPop
3.3.4 release in favor of <em>Order.asc</em> and <em>Order.desc</em>. This was done bring the
keywords more into line with other commonly used query languages. As of TinkerPop
release 3.5.0, those enumerations were completely removed from the Gremlin reference
implementation and documentation and should no longer be used.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Let’s take a look at how queries are affected by these changes. The query below
finds the 10 airports in England with the most outgoing routes and sorts the results
in descending order. Prior to TinkerPop 3.3.4 the query would have been written as
follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'GB-ENG'</span><span class="tok-o">).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">(),</span><span class="tok-n">decr</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Running the query produces the following results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">LGW</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">200</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">191</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">STN</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">186</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">182</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">BHX</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">109</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">LTN</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">104</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">BRS</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">84</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">EMA</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">64</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">LBA</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">62</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">LPL</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">60</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the new keywords introduced in the 3.3.4 release, the query can be written as
shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'GB-ENG'</span><span class="tok-o">).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">(),</span><span class="tok-n">desc</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The results produced, as you would expect, are the same as before.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">LGW</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">200</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">191</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">STN</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">186</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">182</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">BHX</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">109</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">LTN</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">104</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">BRS</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">84</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">EMA</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">64</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">LBA</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">62</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">LPL</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">60</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For completeness let’s take a look at the same query but sorted in ascending order
using both the original <em>incr</em> keyword and the newly introduced <em>asc</em> keyword. As
with <em>incr</em>, this remains the default behavior if neither <em>asc</em> nor <em>desc</em> is
specified.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'GB-ENG'</span><span class="tok-o">).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">(),</span><span class="tok-n">incr</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This time the query has found the airports with the least outgoing commercial
aviation routes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">CVT</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">0</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">GLO</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">1</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">LEQ</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">1</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">BZZ</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">1</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">MME</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">2</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">ISC</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">HUY</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">6</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">BLK</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">9</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">NQY</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">11</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">DSA</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">15</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The query below is modified to use the new <em>asc</em> keyword.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'GB-ENG'</span><span class="tok-o">).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">(),</span><span class="tok-n">asc</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The results produced are the same as before.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">CVT</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">0</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">GLO</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">1</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">LEQ</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">1</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">BZZ</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">1</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">MME</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">2</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">ISC</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">HUY</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">6</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">BLK</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">9</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">NQY</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">11</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">DSA</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">15</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When TinkerPop 3.3.4 was released, these were not breaking changes. As more graph
database engines move up to the TinkerPop 3.5.0 level these now become breaking
changes and <em>asc</em> and <em>desc</em> must be used. In order for your code and other queries
to be future proof, even if your database is not yet at the TinkerPop 3.5.0 level, I
recommend making these changes to your code as soon as possible.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="bool">3.15. Boolean operations</h3>
<div class="paragraph">
<p>Gremlin provides a set of logical operators such as <em>and</em>, <em>or</em> and <em>not</em> that can be
used to form Boolean (true/false) type queries. In a lot of cases I find that <em>or</em>
can be avoided by using <em>within</em> for example and that <em>not</em> can be sometimes avoided
by using <em>without</em> but it is still good to know that these operators exist. The
<em>and</em> operator can sometimes be avoided by chaining <em>has</em> steps together. That said
there are always cases where having these boolean steps available is extremely
useful.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Simple example of doing a Boolean AND operation</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">and</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">),</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'icao'</span><span class="tok-o">,</span><span class="tok-s1">'KAUS'</span><span class="tok-o">))</span>

<span class="tok-c1">// Simple example of doing a Boolean OR operation</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">or</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">),</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'icao'</span><span class="tok-o">,</span><span class="tok-s1">'KDFW'</span><span class="tok-o">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use <em>and</em> in an infix way as follows so long as you only want to <em>and</em>
two traversals together.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">and</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'icao'</span><span class="tok-o">,</span><span class="tok-s1">'KAUS'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you would probably expect, an <em>or</em> step can have more than two choices. This one
below has four. Also, note that in practice, for this query, using <em>within</em> would be
a better approach but this suffices as an example of a bigger <em>or</em> expression.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">or</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">),</span>
                             <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-LA'</span><span class="tok-o">),</span>
                             <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-AZ'</span><span class="tok-o">),</span>
                             <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-OK'</span><span class="tok-o">)).</span>
                           <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-n">asc</span><span class="tok-o">).</span>
                           <span class="tok-n">valueMap</span><span class="tok-o">().</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using <em>within</em> the example above could be written like this so always keep in mind
that using <em>or</em> may not always be the best approach to use for a given query. We
will look more closely at the <em>within</em> and <em>without</em> steps in the following section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'US-TX'</span><span class="tok-o">,</span><span class="tok-s1">'US-LA'</span><span class="tok-o">,</span><span class="tok-s1">'US-AZ'</span><span class="tok-o">,</span><span class="tok-s1">'US-OK'</span><span class="tok-o">)).</span>
                          <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-n">asc</span><span class="tok-o">).</span>
                          <span class="tok-n">valueMap</span><span class="tok-o">().</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This next example uses an <em>and</em> step to find airports in Texas with a runway at least
12,000 feet long.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">and</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">),</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'longest'</span><span class="tok-o">,</span><span class="tok-n">gte</span><span class="tok-o">(</span><span class="tok-mi">12000</span><span class="tok-o">))).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As with the <em>or</em> step, using <em>and</em> is not always necessary. We could rewrite the
previous query as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'longest'</span><span class="tok-o">,</span><span class="tok-n">gte</span><span class="tok-o">(</span><span class="tok-mi">12000</span><span class="tok-o">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Gremlin also provides a <em>not</em> step which works as you would expect. This query finds
vertices that are not airports.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">not</span><span class="tok-o">(</span><span class="tok-n">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">)).</span><span class="tok-na">count</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This previous query could also be written as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-n">label</span><span class="tok-o">,</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">)).</span><span class="tok-na">count</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Depending on the model of your graph and the query itself it may or may not make
sense to use the boolean steps. Sometimes, as described above chaining <em>has</em> steps
together may be more efficient or using a step like <em>within</em> or <em>without</em> may make
more sense.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Boolean steps such as <em>and</em> can also be dot combined as the example below shows. This
query finds all the airports that have fewer than 100 outbound routes but more than 94
and returns them grouped by airport code and route count. Notice how in this case the
<em>and</em> step is added to the <em>lt</em> step using a dot rather than having the <em>and</em> be the
containing step for the whole test. The results from running the query are shown
below as well.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">lt</span><span class="tok-o">(</span><span class="tok-mi">100</span><span class="tok-o">).</span><span class="tok-na">and</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">94</span><span class="tok-o">)))).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">())</span>

<span class="tok-o">[</span><span class="tok-nl">BUD:</span><span class="tok-mi">98</span><span class="tok-o">,</span><span class="tok-nl">STR:</span><span class="tok-mi">95</span><span class="tok-o">,</span><span class="tok-nl">NCE:</span><span class="tok-mi">97</span><span class="tok-o">,</span><span class="tok-nl">AUH:</span><span class="tok-mi">97</span><span class="tok-o">,</span><span class="tok-nl">WAW:</span><span class="tok-mi">98</span><span class="tok-o">,</span><span class="tok-nl">CRL:</span><span class="tok-mi">95</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The query we just looked at could also be written as follows but in this case using
the <em>and</em> step inline by dot combining it (as above) feels cleaner to me. As you can
see we get the same result as before.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">and</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">lt</span><span class="tok-o">(</span><span class="tok-mi">100</span><span class="tok-o">)),</span>
                <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">94</span><span class="tok-o">)))).</span>
                <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">())</span>

<span class="tok-o">[</span><span class="tok-nl">BUD:</span><span class="tok-mi">98</span><span class="tok-o">,</span><span class="tok-nl">STR:</span><span class="tok-mi">95</span><span class="tok-o">,</span><span class="tok-nl">NCE:</span><span class="tok-mi">97</span><span class="tok-o">,</span><span class="tok-nl">AUH:</span><span class="tok-mi">97</span><span class="tok-o">,</span><span class="tok-nl">WAW:</span><span class="tok-mi">98</span><span class="tok-o">,</span><span class="tok-nl">CRL:</span><span class="tok-mi">95</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As I have pointed out several times already, there are often many ways to write a
query that will produce the same result. Here is an example of the previous two
queries rewritten to use a <em>between</em> step instead of an <em>and</em> step. Remember that
<em>between</em> is inclusive/exclusive, so we have to specify 101 as the upper bound and 95
as the lower bound.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">between</span><span class="tok-o">(</span><span class="tok-mi">95</span><span class="tok-o">,</span><span class="tok-mi">101</span><span class="tok-o">))).</span>
                          <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">())</span>

<span class="tok-o">[</span><span class="tok-nl">BUD:</span><span class="tok-mi">98</span><span class="tok-o">,</span><span class="tok-nl">STR:</span><span class="tok-mi">95</span><span class="tok-o">,</span><span class="tok-nl">NCE:</span><span class="tok-mi">97</span><span class="tok-o">,</span><span class="tok-nl">AUH:</span><span class="tok-mi">97</span><span class="tok-o">,</span><span class="tok-nl">WAW:</span><span class="tok-mi">98</span><span class="tok-o">,</span><span class="tok-nl">CRL:</span><span class="tok-mi">95</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Just for fun, here is the same query but rewritten to use an <em>inside</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">inside</span><span class="tok-o">(</span><span class="tok-mi">94</span><span class="tok-o">,</span><span class="tok-mi">100</span><span class="tok-o">))).</span>
                          <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">())</span>

<span class="tok-o">[</span><span class="tok-nl">BUD:</span><span class="tok-mi">98</span><span class="tok-o">,</span><span class="tok-nl">STR:</span><span class="tok-mi">95</span><span class="tok-o">,</span><span class="tok-nl">NCE:</span><span class="tok-mi">97</span><span class="tok-o">,</span><span class="tok-nl">AUH:</span><span class="tok-mi">97</span><span class="tok-o">,</span><span class="tok-nl">WAW:</span><span class="tok-mi">98</span><span class="tok-o">,</span><span class="tok-nl">CRL:</span><span class="tok-mi">95</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As a side note, if we wanted to reverse the grouping so that the airports were
grouped by the counts rather than the codes we could do that as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">lt</span><span class="tok-o">(</span><span class="tok-mi">100</span><span class="tok-o">).</span><span class="tok-na">and</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">94</span><span class="tok-o">)))).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-mi">97</span><span class="tok-o">:[</span><span class="tok-n">NCE</span><span class="tok-o">,</span><span class="tok-n">AUH</span><span class="tok-o">],</span><span class="tok-mi">98</span><span class="tok-o">:[</span><span class="tok-n">BUD</span><span class="tok-o">,</span><span class="tok-n">WAW</span><span class="tok-o">],</span><span class="tok-mi">95</span><span class="tok-o">:[</span><span class="tok-n">STR</span><span class="tok-o">,</span><span class="tok-n">CRL</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also add additional inline <em>and</em> steps to a query as shown below. Notice that
this time <em>AUH</em> and <em>NCE</em> are not part of the result set as they have 97 routes which
our new <em>and</em> test eliminates.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">lt</span><span class="tok-o">(</span><span class="tok-mi">100</span><span class="tok-o">).</span><span class="tok-na">and</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">94</span><span class="tok-o">)).</span><span class="tok-na">and</span><span class="tok-o">(</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-mi">97</span><span class="tok-o">)))).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-mi">98</span><span class="tok-o">:[</span><span class="tok-n">BUD</span><span class="tok-o">,</span><span class="tok-n">WAW</span><span class="tok-o">],</span><span class="tok-mi">95</span><span class="tok-o">:[</span><span class="tok-n">STR</span><span class="tok-o">,</span><span class="tok-n">CRL</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>where</em> step was used lot in the examples above. Hopefully the effect of using it
was clear. Nonetheless I will explain in more detail how the <em>where</em> step works in
the next section.</p>
</div>
</div>
<div class="sect2">
<h3 id="where">3.16. Using <em>where</em> to filter things out of a result</h3>
<div class="paragraph">
<p>We have already seen the <em>where</em> step used in some of the prior examples. In this
section we will take a slightly more focussed look at the <em>where</em> step. The <em>where</em>
step is an example of a <em>filter</em>. It takes the current state of a traversal and only
allows anything that matches the specified constraint to pass on to any following
steps. <em>Where</em> can be used by itself, or as we shall see later, in conjunction with a
<em>by</em> modulator or following a <em>match</em> or a <em>choose</em> step.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
It is worth noting that some queries that use <em>where</em> can also be written using
<em>has</em> instead.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Let’s start by looking at a simple example of how <em>has</em> and <em>where</em> can be
used to achieve the same result.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Find airports with more than five runways</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">))</span>

<span class="tok-c1">// Find airports with more than five runways</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In examples like the one above, both queries will yield the exact same results but
the <em>has</em> step feels simpler and cleaner for such cases. Notice how in the <em>where</em>
step version the <em>gt</em> predicate has to be placed inside of an <em>is</em> step. The next
example starts to show the real power of the <em>where</em> step. We can include a traversal
inside of the <em>where</em> step that does some filtering for us. In this case, we first
find all vertices that are airports and then use a <em>where</em> step to only keep airports
that have more than 60 outgoing routes. Finally we count how many such airports we
found.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Airports with more than 60 unique routes from them</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">60</span><span class="tok-o">))).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">179</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In our next example, we want to find routes between airports that have an ID of less
than 47 but only return routes that are longer than 4,000 miles. Again, notice how we
are able to look at the incoming vertex ID values by placing a reference to <em>inV</em> at
the start of the <em>where</em> expression. The <em>where</em> step is placed inside of an <em>and</em>
step so that we can also examine the <em>dist</em> property of the edge. Finally we return
the path as the result of our query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Routes longer than 4,000 miles between airports with and ID less than 47</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-n">lt</span><span class="tok-o">(</span><span class="tok-mi">47</span><span class="tok-o">)).</span><span class="tok-na">outE</span><span class="tok-o">().</span>
      <span class="tok-n">and</span><span class="tok-o">(</span><span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">inV</span><span class="tok-o">().</span><span class="tok-na">id</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">lt</span><span class="tok-o">(</span><span class="tok-mi">47</span><span class="tok-o">))),</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">4000</span><span class="tok-o">))).</span>
      <span class="tok-n">inV</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Below is what we get back as a result of running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-mi">4502</span><span class="tok-o">,</span><span class="tok-n">HNL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-mi">4970</span><span class="tok-o">,</span><span class="tok-n">HNL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">ORD</span><span class="tok-o">,</span><span class="tok-mi">4230</span><span class="tok-o">,</span><span class="tok-n">HNL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-mi">4950</span><span class="tok-o">,</span><span class="tok-n">HNL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">HNL</span><span class="tok-o">,</span><span class="tok-mi">4502</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">HNL</span><span class="tok-o">,</span><span class="tok-mi">4970</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">HNL</span><span class="tok-o">,</span><span class="tok-mi">4230</span><span class="tok-o">,</span><span class="tok-n">ORD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">HNL</span><span class="tok-o">,</span><span class="tok-mi">4950</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Sometimes you will be looking for results that match the inverse condition of a
<em>where</em> step. One way this can be achieved is to wrap the <em>where</em> step inside of a
<em>not</em> step, as shown below.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The double underscore prefix <em>"__."</em> before the <em>in</em> step is required as
<em>in</em> is a reserved word in Groovy. If you are using the Gremlin Console and do not
include the prefix you will get an error. This is explained in more detail in the
"<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#rword">A warning about reserved word conflicts and collisions</a>" section a bit later. The <em>"__."</em> notation is actually a reference
to a special TinkerPop Java class that has the name <em>"__"</em> (double underscore)
but don’t worry about that for the time being. In fact, for now, just think of
<em>"__."</em> as meaning <em>"the result of the previous step"</em>. This will become
important once we start looking at writing a Java program to issue Gremlin queries
and is discussed in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#tpinterfaces">The Apache TinkerPop interfaces and classes</a>" section quite a bit later on.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The query starts by finding the Austin airport (AUS) and then finds all outgoing
routes. We then look at all incoming <em>contains</em> edges to see which country each
airport we can fly to is in. The <em>not</em> step ensures that only airports that do not
have the United States country code of <em>US</em> are selected.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">not</span><span class="tok-o">(</span><span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">in</span><span class="tok-o">(</span><span class="tok-s1">'contains'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'US'</span><span class="tok-o">))).</span>
      <span class="tok-n">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'city'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, when we run the query, only destinations outside the United States
are returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">YYZ</span><span class="tok-o">],</span><span class="tok-nl">city:</span><span class="tok-o">[</span><span class="tok-n">Toronto</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">],</span><span class="tok-nl">city:</span><span class="tok-o">[</span><span class="tok-n">London</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">FRA</span><span class="tok-o">],</span><span class="tok-nl">city:</span><span class="tok-o">[</span><span class="tok-n">Frankfurt</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">MEX</span><span class="tok-o">],</span><span class="tok-nl">city:</span><span class="tok-o">[</span><span class="tok-n">Mexico</span> <span class="tok-n">City</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">CUN</span><span class="tok-o">],</span><span class="tok-nl">city:</span><span class="tok-o">[</span><span class="tok-n">Cancun</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">GDL</span><span class="tok-o">],</span><span class="tok-nl">city:</span><span class="tok-o">[</span><span class="tok-n">Guadalajara</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This pattern comes in useful whenever you want to use a traversal inside of a <em>where</em>
step and negate the results. Of course, there are other ways we could write this
particular query but I wanted to show an example of this technique being used. For completeness,
two simpler ways of writing this query that do not use <em>where</em> at all are shown below
but there will be cases where combining <em>not</em> and <em>where</em> are your best option.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span> <span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-s1">'US'</span><span class="tok-o">)).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'city'</span><span class="tok-o">)</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">not</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span> <span class="tok-s1">'US'</span><span class="tok-o">)).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'city'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is also possible to use some special forms of the <em>and</em> and <em>or</em> steps when
working with a <em>where</em> step. Take a look at the query below. This will match airports
that you can fly to from Austin (AUS) so long as they have more than four runways
and do not have exactly six runways.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">4</span><span class="tok-o">).</span><span class="tok-na">and</span><span class="tok-o">(</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-mi">6</span><span class="tok-o">)))).</span>
      <span class="tok-n">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is what the query returns. As you can see we only found airports that you can
fly to from AUS that have 5,7 or 8 runways.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">YYZ</span><span class="tok-o">],</span><span class="tok-nl">runways:</span><span class="tok-o">[</span><span class="tok-mi">5</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">MDW</span><span class="tok-o">],</span><span class="tok-nl">runways:</span><span class="tok-o">[</span><span class="tok-mi">5</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">],</span><span class="tok-nl">runways:</span><span class="tok-o">[</span><span class="tok-mi">5</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">],</span><span class="tok-nl">runways:</span><span class="tok-o">[</span><span class="tok-mi">7</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">IAH</span><span class="tok-o">],</span><span class="tok-nl">runways:</span><span class="tok-o">[</span><span class="tok-mi">5</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">ORD</span><span class="tok-o">],</span><span class="tok-nl">runways:</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The same is true for the <em>or</em> step. We could rewrite our query to find airports we
can fly to from Austin that have more than six or exactly four runways.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">6</span><span class="tok-o">).</span><span class="tok-na">or</span><span class="tok-o">(</span><span class="tok-n">eq</span><span class="tok-o">(</span><span class="tok-mi">4</span><span class="tok-o">)))).</span>
      <span class="tok-n">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The above is a shorter form of the following query which demonstrates another way we
could use the boolean operators within a <em>where</em> step. In this case only two
traversals are allowed to be compared using the boolean operator (in this case an
<em>or</em> step).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">6</span><span class="tok-o">)).</span><span class="tok-na">or</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-mi">4</span><span class="tok-o">)).</span>
      <span class="tok-n">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Our last example in this section uses a <em>where</em> step to make sure we don’t end up
back where we started when looking at airline routes with one stop. We find routes
that start in Austin, with one intermediate stop, that then continue to another
airport, but never end up back in Austin. A <em>limit</em> step is used to just return the
first 10 results that match this criteria. Notice how the <em>as</em> step is used to label
the <em>AUS</em> airport so that we can refer to it later in our <em>where</em> step. The effect of
this query is that routes such as AUS→DFW→AUS will not be returned but
AUS→DFW→LHR will be as it does not end up back in Austin.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// List 10 places you can fly to with one stop, starting at Austin but</span>
<span class="tok-c1">// never ending up back in Austin</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">)).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you work with Gremlin, you will find that the <em>where</em> step is one that you use a
lot. You will see many more examples of <em>where</em> being used throughout the remainder
of this book. In the next section we will look at some additional ways that <em>where</em>
can be used.</p>
</div>
<div class="sect3">
<h4 id="whereby">3.16.1. Using <em>where</em> and <em>by</em> to filter results</h4>
<div class="paragraph">
<p>A new capability was added in the Tinkerpop 3.2.4 release that allows a <em>where</em> step
to be followed with a <em>by</em> modulator. This makes writing certain types of queries a
lot easier than it was before. Hopefully by now, this capability is supported in many
TinkerPop enabled graph stores but it is always a good idea to verify the version of
TinkerPop supported before starting to design queries.</p>
</div>
<div class="paragraph">
<p>The query below starts at the Austin airport and finds all the airports that you can
fly to from there. A <em>where</em> <em>by</em> step is then used to filter the results to just
those airports that have the same number of runways that Austin has. What is really
nice about this is that we do not have to know ahead of time how many runways Austin
itself has as that is handled for us by the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
       <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">eq</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">)).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Combining the <em>where</em> and <em>by</em> steps allows you to write powerful queries in a
nice and simple way.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>If you were to run the query in the Gremlin Console, these are the results that you
should see. Note that all the airports returned have two runways. This is the same
number of runways that the Austin airport has.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">],</span><span class="tok-nl">runways:</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">MEX</span><span class="tok-o">],</span><span class="tok-nl">runways:</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">CUN</span><span class="tok-o">],</span><span class="tok-nl">runways:</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">GDL</span><span class="tok-o">],</span><span class="tok-nl">runways:</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">PNS</span><span class="tok-o">],</span><span class="tok-nl">runways:</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">VPS</span><span class="tok-o">],</span><span class="tok-nl">runways:</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">FLL</span><span class="tok-o">],</span><span class="tok-nl">runways:</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">SNA</span><span class="tok-o">],</span><span class="tok-nl">runways:</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">MSY</span><span class="tok-o">],</span><span class="tok-nl">runways:</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The ability to combine <em>where</em> and <em>by</em> steps together allows us to avoid having to
write the previous query in more complicated ways such as the one shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span>
      <span class="tok-n">filter</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-n">eq</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">))).</span>
      <span class="tok-n">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There is also a two parameter form of the <em>where</em> step that you may have noticed used
above. In this case the first parameter refers to a label defined earlier in the
query. Take a look at the example below. We find the vertex for the Austin (AUS)
airport and label it <em>'a'</em>. We then look at all the airports you can fly
to from there and label them <em>'b'</em>. We then use a <em>where</em> step to compare
<em>'a'</em> and <em>'b'</em>. Only airports with fewer runways than Austin
should be returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">)).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Austin has two runways so only airports with one runway are returned by this query
when run.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">BKG</span><span class="tok-o">],</span><span class="tok-nl">runways:</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">SAN</span><span class="tok-o">],</span><span class="tok-nl">runways:</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is also possible to compare two different properties by adding a second <em>by</em>
modulator. This is useful when vertex properties have different key names but may
contain the same values. The query below is definitely contrived, you could achieve
the same thing in a more simple way, but it does demonstrate two <em>by</em> modulators
being used. The <em>country</em> property of an airport vertex is compared with the <em>code</em>
property of a <em>country</em> vertex. The query first finds any airport vertex with a
<em>city</em> property containing the string <em>London</em>. Next any connecting <em>country</em>
vertices (ones connected by contains edges) are found. The <em>where</em> test compares the
country code value of the two vertices. Lastly a <em>select</em> is used to pick the
results that we want to return.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'London'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'r'</span><span class="tok-o">).</span>
      <span class="tok-k">in</span><span class="tok-o">(</span><span class="tok-s1">'contains'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-n">eq</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">)).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'r'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When the query is run we get back all the airports with a city name of <em>London</em> along
with their region code and country code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-nl">r:</span><span class="tok-n">GB</span><span class="tok-o">-</span><span class="tok-n">ENG</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">UK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">LGW</span><span class="tok-o">,</span><span class="tok-nl">r:</span><span class="tok-n">GB</span><span class="tok-o">-</span><span class="tok-n">ENG</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">UK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">LCY</span><span class="tok-o">,</span><span class="tok-nl">r:</span><span class="tok-n">GB</span><span class="tok-o">-</span><span class="tok-n">ENG</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">UK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">STN</span><span class="tok-o">,</span><span class="tok-nl">r:</span><span class="tok-n">GB</span><span class="tok-o">-</span><span class="tok-n">ENG</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">UK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">LTN</span><span class="tok-o">,</span><span class="tok-nl">r:</span><span class="tok-n">GB</span><span class="tok-o">-</span><span class="tok-n">ENG</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">UK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">YXU</span><span class="tok-o">,</span><span class="tok-nl">r:</span><span class="tok-n">CA</span><span class="tok-o">-</span><span class="tok-n">ON</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">CA</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As I mentioned the above query was used just as an example. In reality the following
query that does not use any <em>where</em> steps would have sufficed in this case.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'London'</span><span class="tok-o">).</span>
      <span class="tok-n">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'country'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">country:</span><span class="tok-o">[</span><span class="tok-n">UK</span><span class="tok-o">],</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">],</span><span class="tok-nl">region:</span><span class="tok-o">[</span><span class="tok-n">GB</span><span class="tok-o">-</span><span class="tok-n">ENG</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">country:</span><span class="tok-o">[</span><span class="tok-n">UK</span><span class="tok-o">],</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">],</span><span class="tok-nl">region:</span><span class="tok-o">[</span><span class="tok-n">GB</span><span class="tok-o">-</span><span class="tok-n">ENG</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">country:</span><span class="tok-o">[</span><span class="tok-n">UK</span><span class="tok-o">],</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LCY</span><span class="tok-o">],</span><span class="tok-nl">region:</span><span class="tok-o">[</span><span class="tok-n">GB</span><span class="tok-o">-</span><span class="tok-n">ENG</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">country:</span><span class="tok-o">[</span><span class="tok-n">UK</span><span class="tok-o">],</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">STN</span><span class="tok-o">],</span><span class="tok-nl">region:</span><span class="tok-o">[</span><span class="tok-n">GB</span><span class="tok-o">-</span><span class="tok-n">ENG</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">country:</span><span class="tok-o">[</span><span class="tok-n">UK</span><span class="tok-o">],</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LTN</span><span class="tok-o">],</span><span class="tok-nl">region:</span><span class="tok-o">[</span><span class="tok-n">GB</span><span class="tok-o">-</span><span class="tok-n">ENG</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">country:</span><span class="tok-o">[</span><span class="tok-n">CA</span><span class="tok-o">],</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">YXU</span><span class="tok-o">],</span><span class="tok-nl">region:</span><span class="tok-o">[</span><span class="tok-n">CA</span><span class="tok-o">-</span><span class="tok-n">ON</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s imagine that we want to write a query to find all airports that have the same
region code as the French airport of Nice. Let’s assume for now that we do not know
what the region code is so we cannot just write a simple query to find all airports
in that region. So, instead we need to write a query that will first find the region
code for Nice and then use that region code to find any other airports in the region.
Finally we want to return the airport code along with the city name and the region
code. One way of writing this query is to take advantage of the <em>where…​by</em>
construct.</p>
</div>
<div class="paragraph">
<p>Take a look at the query below and the output it generates.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'NCE'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'r'</span><span class="tok-o">).</span>
  <span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">).</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">eq</span><span class="tok-o">(</span><span class="tok-s1">'r'</span><span class="tok-o">)).</span><span class="tok-na">by</span><span class="tok-o">().</span>
      <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">())</span>

<span class="tok-o">[</span><span class="tok-n">NCE</span><span class="tok-o">,</span><span class="tok-n">Nice</span><span class="tok-o">,</span><span class="tok-n">FR</span><span class="tok-o">-</span><span class="tok-n">U</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">MRS</span><span class="tok-o">,</span><span class="tok-n">Marseille</span><span class="tok-o">,</span><span class="tok-n">FR</span><span class="tok-o">-</span><span class="tok-n">U</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">TLN</span><span class="tok-o">,</span><span class="tok-n">Toulon</span><span class="tok-s">/Le Palyvestre,FR-U]</span>
<span class="tok-s">[AVN,Avignon/</span><span class="tok-n">Caumont</span><span class="tok-o">,</span><span class="tok-n">FR</span><span class="tok-o">-</span><span class="tok-n">U</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In the sample programs folder you will find a program called GraphRegion.java
that shows how to perform the query shown above in a Java program.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>There are several things about this query that are interesting. Firstly because we
are comparing the results of two <em>values</em> steps we do not provide a parameter to the
<em>by</em> step as we do not need to provide a property key. Secondly, we use a second
<em>V()</em> step in the query to find all the airports that have the same airport code as
Nice. Note that this also means that Nice is included in the results. Lastly we wrap
the part of the query that prepares the output in a form we want in a <em>local</em> step so
that a separate list is created for each airport.</p>
</div>
<div class="paragraph">
<p>You could write this query other ways, perhaps using a <em>match</em> step but once you
understand the pattern used above it is both fairly simple and quite powerful.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="choose">3.17. Using <em>choose</em> to write if…​then…​else type queries</h3>
<div class="paragraph">
<p>The <em>choose</em> step allows the creation of queries that are a lot like the "if then
else" constructs found in most programming languages. If we were programming in Java
we might find ourselves writing something like the following.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">longest</span> <span class="tok-o">&gt;</span> <span class="tok-mi">12000</span><span class="tok-o">)</span>
<span class="tok-o">{</span>
  <span class="tok-k">return</span><span class="tok-o">(</span><span class="tok-n">code</span><span class="tok-o">);</span>
<span class="tok-o">}</span>
<span class="tok-k">else</span>
<span class="tok-o">{</span>
  <span class="tok-k">return</span><span class="tok-o">(</span><span class="tok-n">desc</span><span class="tok-o">);</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Gremlin offers us a way to do the same thing. The query below finds all the airports
in Texas and then will return the value of the <em>code</em> property if an airport has a
runway longer than 12,000 feet otherwise it will return the value of the <em>desc</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// If an airport has a runway &gt; 12,000 feet return its code else return its description</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">).</span>
      <span class="tok-n">choose</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'longest'</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">12000</span><span class="tok-o">)),</span>
             <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">),</span>
             <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">)).</span>
      <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When run the output returned should look like this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">AUS</span>
<span class="tok-n">DFW</span>
<span class="tok-n">IAH</span>
<span class="tok-n">San</span> <span class="tok-n">Antonio</span>
<span class="tok-n">Houston</span> <span class="tok-n">Hobby</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the "else" part of the <em>choose</em> step is not provided then it behaves as a simple
"if".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">).</span>
      <span class="tok-n">choose</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'longest'</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">12000</span><span class="tok-o">)),</span>
             <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)).</span>
             <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The "else" in this case is implied and the incoming element that the <em>choose</em>
step received is passed on as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">AUS</span>
<span class="tok-n">DFW</span>
<span class="tok-n">IAH</span>
<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">33</span><span class="tok-o">]</span>
<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">38</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is another example that uses the same constructs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// If an airport has a code of AUS or DFW report its region else report its country</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">choose</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'AUS'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">)),</span>
             <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">),</span>
             <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">)).</span>
     <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="chooseconstant">3.17.1. Including a constant value - introducing <em>constant</em></h4>
<div class="paragraph">
<p>Sometimes it is very useful, as the example below demonstrates, to return constant
rather than derived values as part of a query. This query will return the string
"some" if an airport has fewer than four runways or "lots" if it has more than four.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// You can also return constants using the constant() step</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">choose</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">lt</span><span class="tok-o">(</span><span class="tok-mi">4</span><span class="tok-o">)),</span>
             <span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'some'</span><span class="tok-o">),</span>
             <span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'lots'</span><span class="tok-o">))</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <em>constant</em> step can be used to return a constant value as part of a query.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Here is one more example that uses a <em>sample</em> step to pick 10 airports and then
return either "lots" or "not so many" depending on whether the airport has more than
50 routes or not. Note also how <em>as</em> and <em>select</em> are used to combine both the
derived and constant parts of the query result that we will ultimately return.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">sample</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
      <span class="tok-n">choose</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">50</span><span class="tok-o">)),</span>
             <span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'lots'</span><span class="tok-o">),</span>
             <span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'not so many'</span><span class="tok-o">)).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example of what the output from running this query might look like.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">YYT</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">not</span> <span class="tok-n">so</span> <span class="tok-n">many</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">YEG</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">not</span> <span class="tok-n">so</span> <span class="tok-n">many</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">LGA</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">lots</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">lots</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">BLR</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">not</span> <span class="tok-n">so</span> <span class="tok-n">many</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">CGN</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">lots</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">lots</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">SIN</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">lots</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">TSF</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">not</span> <span class="tok-n">so</span> <span class="tok-n">many</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">HKG</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">lots</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could go one step further if you don’t want the <em>a:</em> and <em>b:</em> keys returned as
part of the result by adding a <em>select(values)</em> to the end of the query as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">sample</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
      <span class="tok-n">choose</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">50</span><span class="tok-o">)),</span>
             <span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'lots'</span><span class="tok-o">),</span>
             <span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'not so many'</span><span class="tok-o">)).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">().</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is what the output from the modified form of the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">YYT</span><span class="tok-o">,</span><span class="tok-n">not</span> <span class="tok-n">so</span> <span class="tok-n">many</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">YEG</span><span class="tok-o">,</span><span class="tok-n">not</span> <span class="tok-n">so</span> <span class="tok-n">many</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LGA</span><span class="tok-o">,</span><span class="tok-n">lots</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-n">lots</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">BLR</span><span class="tok-o">,</span><span class="tok-n">not</span> <span class="tok-n">so</span> <span class="tok-n">many</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">CGN</span><span class="tok-o">,</span><span class="tok-n">lots</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-n">lots</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SIN</span><span class="tok-o">,</span><span class="tok-n">lots</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">TSF</span><span class="tok-o">,</span><span class="tok-n">not</span> <span class="tok-n">so</span> <span class="tok-n">many</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">HKG</span><span class="tok-o">,</span><span class="tok-n">lots</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>constant</em> step is not limited to use within <em>choose</em> steps. It can be used
wherever needed. You will find many examples of its use throughout this book
including in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#union">Using <em>union</em> to combine query results</a>" section.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="option">3.18. Using <em>option</em> to write case/switch type queries</h3>
<div class="paragraph">
<p>When <em>option</em> is combined with <em>choose</em> the result is similar to the <em>case</em> or
<em>switch</em> style construct found in most programming languages. In Java for example, we
might code a <em>switch</em> statement as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">  <span class="tok-k">switch</span><span class="tok-o">(</span><span class="tok-n">airport</span><span class="tok-o">)</span>
  <span class="tok-o">{</span>
    <span class="tok-k">case</span> <span class="tok-s">"DFW"</span><span class="tok-o">:</span> <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">desc</span><span class="tok-o">);</span> <span class="tok-k">break</span><span class="tok-o">;</span>
    <span class="tok-k">case</span> <span class="tok-s">"AUS"</span><span class="tok-o">:</span> <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">region</span><span class="tok-o">);</span> <span class="tok-k">break</span><span class="tok-o">;</span>
    <span class="tok-k">case</span> <span class="tok-s">"LAX"</span><span class="tok-o">:</span> <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">runways</span><span class="tok-o">);</span>
  <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can write a Gremlin query that follows the same pattern as our Java <em>switch</em>
statement. As in the Java example I decided to lay our query out across multiple
lines to aid readability and clarity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// You can combine choose and option to generate a more "case statement" like query</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">choose</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)).</span>
        <span class="tok-n">option</span><span class="tok-o">(</span><span class="tok-s1">'DFW'</span><span class="tok-o">,</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">)).</span>
        <span class="tok-n">option</span><span class="tok-o">(</span><span class="tok-s1">'AUS'</span><span class="tok-o">,</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">)).</span>
        <span class="tok-n">option</span><span class="tok-o">(</span><span class="tok-s1">'LAX'</span><span class="tok-o">,</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The example below shows a <em>choose</em> followed by four options. Note the default case
of <em>none</em> is used as the catchall. Notice how in this case, the values returned are constants.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// You can return constant values if you need to</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">choose</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">)).</span>
        <span class="tok-n">option</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'just one'</span><span class="tok-o">)).</span>
        <span class="tok-n">option</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'a couple'</span><span class="tok-o">)).</span>
        <span class="tok-n">option</span><span class="tok-o">(</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'lots'</span><span class="tok-o">)).</span>
        <span class="tok-n">option</span><span class="tok-o">(</span><span class="tok-n">none</span><span class="tok-o">,</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'quite a few'</span><span class="tok-o">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Starting with the 3.4.3 release of Apache TinkerPop, the <em>option</em> step can now
include a predicate. A nice improvement allowing additional comparisons to be made
within the <em>option</em> step. This allows testing that a value is greater than or less
than another, for example, as part of the <em>option</em> step without needing to write a
more complex query.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In the TinkerPop 3.4.3 release, a feature was added allowing the <em>option</em> step
to include a predicate.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Using this new capability, a query can be written using a more simple syntax. The
query below creates a group containing the counts of airports that fall into one of
the categories generated by the <em>choose</em> and <em>option</em> steps. Any airport situated
above 5,000 feet of elevation will be categorized as "high", greater than 3,000 feet
as "medium" and all others as "low".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">groupCount</span><span class="tok-o">().</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">choose</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'elev'</span><span class="tok-o">)).</span>
             <span class="tok-n">option</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">5000</span><span class="tok-o">),</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'high'</span><span class="tok-o">)).</span>
             <span class="tok-n">option</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">3000</span><span class="tok-o">),</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'medium'</span><span class="tok-o">)).</span>
             <span class="tok-n">option</span><span class="tok-o">(</span><span class="tok-n">none</span><span class="tok-o">,</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'low'</span><span class="tok-o">)))</span>

<span class="tok-o">[</span><span class="tok-nl">high:</span><span class="tok-mi">157</span><span class="tok-o">,</span><span class="tok-nl">low:</span><span class="tok-mi">3013</span><span class="tok-o">,</span><span class="tok-nl">medium:</span><span class="tok-mi">204</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In TinkerPop releases prior to 3.4.3, the query could still have been written but it
required the use of nested <em>choose</em> steps.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">groupCount</span><span class="tok-o">().</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">choose</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'elev'</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">5000</span><span class="tok-o">)),</span>
             <span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'high'</span><span class="tok-o">),</span>
             <span class="tok-n">choose</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'elev'</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">3000</span><span class="tok-o">)),</span>
               <span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'medium'</span><span class="tok-o">),</span>
               <span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'low'</span><span class="tok-o">))))</span>

<span class="tok-o">[</span><span class="tok-nl">high:</span><span class="tok-mi">157</span><span class="tok-o">,</span><span class="tok-nl">low:</span><span class="tok-mi">3013</span><span class="tok-o">,</span><span class="tok-nl">medium:</span><span class="tok-mi">204</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="patmatch">3.19. Using <em>match</em> to do pattern matching</h3>
<div class="paragraph">
<p>The <em>match</em> step was added in TinkerPop 3 and allows a more declarative style of
pattern based query to be expressed using Gremlin. <em>Match</em> can be a bit hard to
master but once you figure it out it can be a very powerful way of traversing a graph
looking for specific patterns. As we shall see however, sometimes a <code>where</code> step is
more than adequate and can be used to express similar patterns to those supported by
<em>match</em>.</p>
</div>
<div class="paragraph">
<p>Below is an example that uses <em>match</em> to look for airline route patterns where there
is a flight from one airport to another but no return flight back to the original
airport. The first query looks for such patterns involving the JFK airport as the
starting point. You can see the output from running the query below it. This is the
correct answer as, currently, the British Airways Airbus A318 flight from London City
(LCY) airport stops in Dublin (DUB) to take on more fuel on the way to JFK but does
not need to stop on the way back because of the trailing wind.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Find any cases of where you can fly from JFK non stop</span>
<span class="tok-c1">// to a place you cannot get back from non stop. This query</span>
<span class="tok-c1">// should return LCY, as the return flight stops in Dublin</span>
<span class="tok-c1">// to refuel.</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'JFK'</span><span class="tok-o">).</span>
      <span class="tok-n">match</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'s'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'d'</span><span class="tok-o">),</span>
            <span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">not</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'d'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'s'</span><span class="tok-o">))).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'s'</span><span class="tok-o">,</span><span class="tok-s1">'d'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">s:</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-nl">d:</span><span class="tok-n">LCY</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can expand the query by leaving off the specific starting point of JFK and look
for this pattern anywhere in the graph. This really starts to show how important and
useful the <em>match</em> Gremlin step is. We don’t have any idea what we might find, but by
using <em>match</em>, we are able to describe the pattern of behavior that we are looking
for and Gremlin does the rest.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Same as above but from any airport in the graph.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">match</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'s'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'d'</span><span class="tok-o">),</span>
            <span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">not</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'d'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'s'</span><span class="tok-o">))).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'s'</span><span class="tok-o">,</span><span class="tok-s1">'d'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you were to run the query you would find that there are in fact over 200 places in
the graph where this situation applies. We can add a <em>count</em> to the end of query to
find out just how many there are.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// How many occurrences of the pattern in the graph are there?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">match</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'s'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'d'</span><span class="tok-o">),</span>
            <span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">not</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'d'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'s'</span><span class="tok-o">))).</span>
      <span class="tok-n">count</span><span class="tok-o">()</span>

<span class="tok-mi">238</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The next query looks for routes that follow the pattern A→B→C but where there is no
direct flight of the form A→C. In other words it looks for all routes between two
airports with one intermediate stop where there is no direct flight alternative
available. Note that the query also eliminates any routes that would end up back at
the airport of origin. To achieve the requirement that we not end up back where we
started, a <em>where</em> step is included to make sure we do not match any routes of the
form A→B→A.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">match</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">)</span>
           <span class="tok-o">,</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">)).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'c'</span><span class="tok-o">)</span>
           <span class="tok-o">,</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">not</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'c'</span><span class="tok-o">))).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">,</span><span class="tok-s1">'c'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are, of course a lot of places in the <em>air-routes</em> graph where this pattern can
be found. Here are just a few examples of the results you might get from running the
query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">MLB</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">ISP</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">MLB</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">BIM</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">MLB</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">YTZ</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">PHF</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">SFB</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">SBN</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">SFB</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">SBN</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">AZA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">SBN</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">PIE</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">SBN</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">PGD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">TRI</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">SFB</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">TRI</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">PIE</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is another example of using <em>match</em> along with a <em>where</em>. This is actually a
different way of writing a query we saw earlier. This query starts out by looking at
how many runways Austin has and then looks at every airport that you can fly to from
Austin and then looks at how many runways those airports have. Only airports with the
same number as Austin are returned. Using a <em>match</em> step for this task is overkill.
However, it does show the basic constructs used by the <em>match</em> step and again
illustrates using values calculated in one part of a query later on in that same
query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">match</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'aus'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'ausr'</span><span class="tok-o">),</span>
            <span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'aus'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'outa'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'outr'</span><span class="tok-o">)</span>
              <span class="tok-o">.</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-s1">'ausr'</span><span class="tok-o">,</span><span class="tok-n">eq</span><span class="tok-o">(</span><span class="tok-s1">'outr'</span><span class="tok-o">))).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'outa'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">().</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As I mentioned, the example above is not the best way to write this query and it can
be done without using a <em>match</em> step at all and just using a <em>where</em> step as shown in
the three examples below. Each one is simpler than its predecessor.</p>
</div>
<div class="paragraph">
<p>One way we could choose to write this query is using multiple select steps. This is
also not a very efficient solution but does work.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'aus'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'ausr'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'aus'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'outa'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'outr'</span><span class="tok-o">).</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-s1">'ausr'</span><span class="tok-o">,</span><span class="tok-n">eq</span><span class="tok-o">(</span><span class="tok-s1">'outr'</span><span class="tok-o">)).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'outa'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">().</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A better way than either of the prior two combines a <em>filter</em> step with the <em>where</em>
and <em>select</em> steps.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span>
      <span class="tok-n">filter</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-n">eq</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">))).</span>
      <span class="tok-n">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As mentioned in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#whereby">Using <em>where</em> and <em>by</em> to filter results</a>" section, this query can be simplified further using
a <em>where</em> step and a <em>by</em> modulator. This capability was introduced in the TinkerPop
3.2.4 release.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
       <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">eq</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">)).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span>
       <span class="tok-n">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So, while there is often a simpler way to write a query that avoids using the <em>match</em>
step, for some queries, especially in more complex cases, it provides a useful and
powerful way to express in a more declarative way, a set of criteria that must be
met. However, before I resort to using a <em>match</em> step I always think carefully about
other ways that I could write the query that might be simpler. I do this because the
syntax of the <em>match</em> step can be tricky to get right without a fair bit of trial and
error in my experience.</p>
</div>
<div class="sect3">
<h4 id="patternwhere">3.19.1. Pattern matching using a <em>where</em> step</h4>
<div class="paragraph">
<p>As the Gremlin language has evolved, many queries that might seem a perfect candidate
for a <em>match</em> step can actually also be written using a <em>where</em> step but still in a
more declarative style. We can rewrite the query from the previous section that looks
at routes from JFK that do not have a return flight using a <em>where</em> step as shown
below.</p>
</div>
<div class="paragraph">
<p>The way to read this, in a similar way as with a <em>match</em> step is as follows. Starting
at JFK, look at all the places we can fly to but only keep those airports that do not
have a route back to JFK. Note that the <em>as</em> step plays two roles in this query.
Outside of the <em>where</em> step it is used to label steps in the query we want to refer
back to later. Inside the <em>where</em> step it provides a convenient shorthand way to
refer back to the departure airport.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'JFK'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'s'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'d'</span><span class="tok-o">).</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">not</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'s'</span><span class="tok-o">))).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'s'</span><span class="tok-o">,</span><span class="tok-s1">'d'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">s:</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-nl">d:</span><span class="tok-n">LCY</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As we have seen in some prior examples, if you only want the airport codes in the
result and not the "s" and "d" keys, adding an additional <em>select</em> step is all that
it takes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'JFK'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'s'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'d'</span><span class="tok-o">).</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">not</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'s'</span><span class="tok-o">))).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'s'</span><span class="tok-o">,</span><span class="tok-s1">'d'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-n">LCY</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The query can be expanded to search for this same pattern across the whole
graph. The example below returns the first ten routes found where there is no return
flight. The results are sorted in ascending order using the departure airport code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'s'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'d'</span><span class="tok-o">).</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">not</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'s'</span><span class="tok-o">))).</span>
      <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'s'</span><span class="tok-o">,</span><span class="tok-s1">'d'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'s'</span><span class="tok-o">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When run the query returns the following results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">s:</span><span class="tok-n">AMS</span><span class="tok-o">,</span><span class="tok-nl">d:</span><span class="tok-n">HRE</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">s:</span><span class="tok-n">AMS</span><span class="tok-o">,</span><span class="tok-nl">d:</span><span class="tok-n">FNA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">s:</span><span class="tok-n">AMS</span><span class="tok-o">,</span><span class="tok-nl">d:</span><span class="tok-n">UIO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">s:</span><span class="tok-n">BNE</span><span class="tok-o">,</span><span class="tok-nl">d:</span><span class="tok-n">BCI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">s:</span><span class="tok-n">BNE</span><span class="tok-o">,</span><span class="tok-nl">d:</span><span class="tok-n">BKQ</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">s:</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-nl">d:</span><span class="tok-n">DIU</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">s:</span><span class="tok-n">HEL</span><span class="tok-o">,</span><span class="tok-nl">d:</span><span class="tok-n">IVL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">s:</span><span class="tok-n">HPN</span><span class="tok-o">,</span><span class="tok-nl">d:</span><span class="tok-n">HYA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">s:</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-nl">d:</span><span class="tok-n">LCY</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">s:</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-nl">d:</span><span class="tok-n">ANU</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="union">3.20. Using <em>union</em> to combine query results</h3>
<div class="paragraph">
<p>The <em>union</em> step works just as you would expect from its name. It allows us to
combine parts of a query into a single result. Just as with the boolean <em>and</em> and
<em>or</em> steps it is sometimes possible to find other ways to do the same thing without
using <em>union</em> but it does offer some very useful capability.</p>
</div>
<div class="paragraph">
<p>Here is a simple example that uses a <em>union</em> step to produce a list containing a
vertex and the number of outgoing routes from that vertex. Note that in the next
section we will see that there are simpler ways to write this query while still using
a <em>union</em> step. The main point to take away from this example is that you can use a
<em>union</em> step to combine the results of multiple traversals. This example combines the
results of two traversals but you can certainly combine more as needed. Note that the
<em>out</em> step starts from the vertex that was found immediately before the <em>union</em> step
which in this case is the DFW vertex. So in other words the output from the prior
step is available to the steps within the <em>union</em> step just as with other Gremlin
steps we have already looked at.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
      <span class="tok-n">union</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">),</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">],</span><span class="tok-mi">221</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Not that this is recommended, but the previous query could also be written as follows
using two <em>has</em> steps both inside a single <em>union</em> step. This does however
demonstrate that you can use a <em>union</em> step to combine the results of fairly
arbitrary graph traversals.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">union</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">),</span>
            <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span>
               <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">],</span><span class="tok-mi">221</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As a side note, instead of using a <em>union</em> step and producing a list, we might decide
to use a <em>group</em> step and produce a map. A map might be preferable if you want to
access individual keys and values directly. It all depends, as always, on the results
that best fit the problem you are solving.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">())</span>

<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">]:</span><span class="tok-mi">221</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="unionidentity">3.20.1. Introducing the <em>identity</em> step</h4>
<div class="paragraph">
<p>Gremlin has an <em>identity</em> step that we have not seen used so far in this book. The
<em>identity</em> step simply returns the entity that was passed in to the current step of a
traversal (in this case <em>union</em>) from the prior step. We can rewrite the query we
used above to use an <em>identity</em> step. This simplifies the query as it removes the
need to use the <em>as</em> and <em>select</em> steps. As shown below, using <em>identity</em> causes the
vertex <em>V[8]</em> representing the DFW airport from the prior <em>has</em> step to be included
in the result.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span>
      <span class="tok-n">union</span><span class="tok-o">(</span><span class="tok-n">identity</span><span class="tok-o">(),</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">],</span><span class="tok-mi">221</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could modify the query slightly to have the first part of the result returned be
the airport’s IATA code rather than just a vertex.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span>
      <span class="tok-n">union</span><span class="tok-o">(</span><span class="tok-n">identity</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">),</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">221</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="unionconstant">3.20.2. Using <em>constant</em> values as part of a <em>union</em></h4>
<div class="paragraph">
<p>We have already seen the <em>constant</em> step used in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#chooseconstant">Including a constant value - introducing <em>constant</em></a>" section.
As you might expect, you can also use <em>constant</em> steps within a <em>union</em> step as the
two examples below show.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">union</span><span class="tok-o">(</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s2">"Hello"</span><span class="tok-o">),</span>
             <span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s2">"There"</span><span class="tok-o">)).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">Hello</span><span class="tok-o">,</span><span class="tok-n">There</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>identity</em> step that was just introduced above could be used to add the <em>V[3]</em>
vertex to the result. We are now combining three traversal steps together inside of
the <em>union</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">union</span><span class="tok-o">(</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s2">"Hello"</span><span class="tok-o">),</span>
             <span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s2">"There"</span><span class="tok-o">),</span>
             <span class="tok-n">identity</span><span class="tok-o">()).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">Hello</span><span class="tok-o">,</span><span class="tok-n">There</span><span class="tok-o">,</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, let’s change the query again to include a city name in the result. Note that
the <em>values</em> step refers to the property of the vertex that was referenced
immediately before the <em>union</em> step so it will return the <em>city</em> property of vertex
<em>V[3]</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">union</span><span class="tok-o">(</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s2">"Hello"</span><span class="tok-o">),</span>
             <span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s2">"There"</span><span class="tok-o">),</span>
             <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">Hello</span><span class="tok-o">,</span><span class="tok-n">There</span><span class="tok-o">,</span><span class="tok-n">Austin</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="unionmore">3.20.3. More examples of the <em>union</em> step</h4>
<div class="paragraph">
<p>The following query uses a <em>sample</em> step to select 10 airports at random from the
graph. For each selected airport, a <em>union</em> step is then used to combine the <em>id</em> of
the vertex with a few properties. Note that <em>local</em> scope is used so that the results
of each <em>union</em> step are folded into a list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s2">"airport"</span><span class="tok-o">).</span><span class="tok-na">sample</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">union</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-o">(),</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s2">"code"</span><span class="tok-o">,</span><span class="tok-s2">"city"</span><span class="tok-o">)).</span><span class="tok-na">fold</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the output I got back from running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-mi">83</span><span class="tok-o">,</span><span class="tok-n">RSW</span><span class="tok-o">,</span><span class="tok-n">Fort</span> <span class="tok-n">Myers</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">97</span><span class="tok-o">,</span><span class="tok-n">GLA</span><span class="tok-o">,</span><span class="tok-n">Glasgow</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">26</span><span class="tok-o">,</span><span class="tok-n">SAN</span><span class="tok-o">,</span><span class="tok-n">San</span> <span class="tok-n">Diego</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">57</span><span class="tok-o">,</span><span class="tok-n">MEL</span><span class="tok-o">,</span><span class="tok-n">Melbourne</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">136</span><span class="tok-o">,</span><span class="tok-n">MEX</span><span class="tok-o">,</span><span class="tok-n">Mexico</span> <span class="tok-n">City</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">163</span><span class="tok-o">,</span><span class="tok-n">YHZ</span><span class="tok-o">,</span><span class="tok-n">Halifax</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">44</span><span class="tok-o">,</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-n">Santa</span> <span class="tok-n">Fe</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">42</span><span class="tok-o">,</span><span class="tok-n">OAK</span><span class="tok-o">,</span><span class="tok-n">Oakland</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">92</span><span class="tok-o">,</span><span class="tok-n">OSL</span><span class="tok-o">,</span><span class="tok-n">Oslo</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">161</span><span class="tok-o">,</span><span class="tok-n">IST</span><span class="tok-o">,</span><span class="tok-n">Istanbul</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If <em>local</em> scope had not been used, the result would have been a single list
containing all of the results as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s2">"airport"</span><span class="tok-o">).</span><span class="tok-na">sample</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">union</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-o">(),</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s2">"code"</span><span class="tok-o">,</span><span class="tok-s2">"city"</span><span class="tok-o">)).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">84</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">Manchester</span><span class="tok-o">,</span><span class="tok-mi">87</span><span class="tok-o">,</span><span class="tok-n">CGN</span><span class="tok-o">,</span><span class="tok-n">Cologne</span><span class="tok-o">,</span><span class="tok-mi">35</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">Newark</span><span class="tok-o">,</span><span class="tok-mi">37</span><span class="tok-o">,</span><span class="tok-n">HNL</span><span class="tok-o">,</span><span class="tok-n">Honolulu</span><span class="tok-o">,</span><span class="tok-mi">54</span><span class="tok-o">,</span><span class="tok-n">NRT</span><span class="tok-o">,</span><span class="tok-n">Tokyo</span><span class="tok-o">,</span><span class="tok-mi">86</span><span class="tok-o">,</span><span class="tok-n">YEG</span><span class="tok-o">,</span><span class="tok-n">Edmonton</span><span class="tok-o">,</span><span class="tok-mi">45</span><span class="tok-o">,</span><span class="tok-n">PHL</span><span class="tok-o">,</span><span class="tok-n">Philadelphia</span><span class="tok-o">,</span><span class="tok-mi">52</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-n">Frankfurt</span><span class="tok-o">,</span><span class="tok-mi">85</span><span class="tok-o">,</span><span class="tok-n">YUL</span><span class="tok-o">,</span><span class="tok-n">Montreal</span><span class="tok-o">,</span><span class="tok-mi">142</span><span class="tok-o">,</span><span class="tok-n">SOF</span><span class="tok-o">,</span><span class="tok-n">Sofia</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By way of another simple example, the following query returns flights that arrive in
AUS from the UK or that leave AUS and arrive in Mexico.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Flights to AUS from the UK or from AUS to Mexico</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">union</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">in</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'UK'</span><span class="tok-o">),</span>
            <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'MX'</span><span class="tok-o">)).</span>
            <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When we run that query, we get the following results showing that there are routes
from LHR in the UK and to the three airports MEX, CUN and GDL in Mexico.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">MEX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">CUN</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">GDL</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This query solves the problem "Find all routes that start in London, England and end
up in Paris or Berlin with no stops". Because city names are used and not airport
codes, all airports in the respective cities are considered.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'London'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'GB-ENG'</span><span class="tok-o">).</span>
         <span class="tok-n">union</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'Paris'</span><span class="tok-o">),</span>
               <span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'Berlin'</span><span class="tok-o">)).</span>
               <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results from running the query. Note that routes from five different
London airports were found.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">ORY</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">TXL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span><span class="tok-n">SXF</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LCY</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LCY</span><span class="tok-o">,</span><span class="tok-n">ORY</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">STN</span><span class="tok-o">,</span><span class="tok-n">TXL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">STN</span><span class="tok-o">,</span><span class="tok-n">SXF</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LTN</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LTN</span><span class="tok-o">,</span><span class="tok-n">SXF</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As mentioned previously, sometimes, especially for fairly simple queries, there are
alternatives to using <em>union</em>. Indeed, it is actually not necessary to use a <em>union</em>
step to achieve the prior result. The re-written version of the query below will
return the same results as the version that uses a <em>union</em> step. This time a simple
<em>has</em> step featuring a <em>within</em> predicate is used instead.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'London'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'GB-ENG'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'Berlin'</span><span class="tok-o">,</span><span class="tok-s1">'Paris'</span><span class="tok-o">)).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The previous two queries used a <em>path</em> step to essentially show each individual
route. We can adjust the version of the query that uses a <em>union</em> step just a little
bit and instead turn the result into a series of lists where the first item in the
list is the origin airport and the remaining items in the list are the places you can
fly to from there within our criteria. The double underscore <em>"__"</em> is used in the
way that <em>identity</em> could have been used to refer to the incoming vertex. The <em>union</em>
step is wrapped in a <em>local</em> step so that each <em>union</em> is individually folded. If the
<em>local</em> step was omitted all of the results would be folded into a single list. In
this case, the <em>union</em> step makes writing the query relatively easy and this is
probably a good example of where the <em>union</em> step should be used. Namely, when you
want to combine multiple traversal results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'London'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'GB-ENG'</span><span class="tok-o">).</span>
      <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">union</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">),</span>
                  <span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'Paris'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">),</span>
                  <span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'Berlin'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)).</span>
      <span class="tok-n">fold</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Running the amended query shows us the results in perhaps a more useful form.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">ORY</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">,</span><span class="tok-n">TXL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">,</span><span class="tok-n">SXF</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LCY</span><span class="tok-o">,</span><span class="tok-n">ORY</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">STN</span><span class="tok-o">,</span><span class="tok-n">TXL</span><span class="tok-o">,</span><span class="tok-n">SXF</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LTN</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">,</span><span class="tok-n">SXF</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="unionthree">3.20.4. Using <em>union</em> to combine more complex traversal results</h4>
<div class="paragraph">
<p>So far the examples we have looked at mostly show fairly simple traversals being used
inside of a <em>union</em> step. This next query is a bit more interesting. We again start
from any airport in London, but then we want routes that meet any of the criteria:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Go to Berlin and then to Lisbon</p>
</li>
<li>
<p>Go to Paris and then Barcelona</p>
</li>
<li>
<p>Go to Edinburgh and then Rome</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We also want to return the distances in each case. Note that you can union together
as many items as you need to. In this example we combine the results of
three sets of traversals to get the desired results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Returns any paths found along with the distances between airport pairs.</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'London'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'GB-ENG'</span><span class="tok-o">).</span>
      <span class="tok-n">union</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'Berlin'</span><span class="tok-o">).</span>
                   <span class="tok-n">outE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'Lisbon'</span><span class="tok-o">).</span>
                   <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">),</span>
            <span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'Paris'</span><span class="tok-o">).</span>
                   <span class="tok-n">outE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'Barcelona'</span><span class="tok-o">).</span>
                   <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">),</span>
            <span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'Edinburgh'</span><span class="tok-o">).</span>
                   <span class="tok-n">outE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'Rome'</span><span class="tok-o">).</span>
                   <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is what we get back when we run our query</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-mi">227</span><span class="tok-o">,</span><span class="tok-n">ORY</span><span class="tok-o">,</span><span class="tok-mi">513</span><span class="tok-o">,</span><span class="tok-n">BCN</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-mi">216</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">,</span><span class="tok-mi">533</span><span class="tok-o">,</span><span class="tok-n">BCN</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span><span class="tok-mi">591</span><span class="tok-o">,</span><span class="tok-n">SXF</span><span class="tok-o">,</span><span class="tok-mi">1432</span><span class="tok-o">,</span><span class="tok-n">LIS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span><span class="tok-mi">191</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">,</span><span class="tok-mi">533</span><span class="tok-o">,</span><span class="tok-n">BCN</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LCY</span><span class="tok-o">,</span><span class="tok-mi">227</span><span class="tok-o">,</span><span class="tok-n">ORY</span><span class="tok-o">,</span><span class="tok-mi">513</span><span class="tok-o">,</span><span class="tok-n">BCN</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">STN</span><span class="tok-o">,</span><span class="tok-mi">563</span><span class="tok-o">,</span><span class="tok-n">SXF</span><span class="tok-o">,</span><span class="tok-mi">1432</span><span class="tok-o">,</span><span class="tok-n">LIS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LTN</span><span class="tok-o">,</span><span class="tok-mi">589</span><span class="tok-o">,</span><span class="tok-n">SXF</span><span class="tok-o">,</span><span class="tok-mi">1432</span><span class="tok-o">,</span><span class="tok-n">LIS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LTN</span><span class="tok-o">,</span><span class="tok-mi">236</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">,</span><span class="tok-mi">533</span><span class="tok-o">,</span><span class="tok-n">BCN</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The next query finds the total distance of all routes from any airport in Madrid to
any airport anywhere and also does the same calculation but minus any routes that end
up in any Paris airport. We have not yet seen the <em>filter</em> step that is used below.
It is one of the foundational Gremlin steps that many others such as <em>where</em> build
upon. A <em>filter</em> step will only pass on to the next step in the query incoming
elements that meet the criteria specified within the <em>filter</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'Madrid'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span>
      <span class="tok-n">union</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">sum</span><span class="tok-o">(),</span>
            <span class="tok-n">filter</span><span class="tok-o">(</span><span class="tok-n">inV</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-s1">'Paris'</span><span class="tok-o">))).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">sum</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the output from running the query. As you can see the first number is
slightly larger than the second as all routes involving Paris have been
filtered out from the calculation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-mi">397708</span>
<span class="tok-mi">396410</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is worth noting that it is not required that every traversal inside of a union
step returns a result. The returned results will include any of the traversals that
did return something. The example below demonstrates this. Of course in practice you
would not write this particular query this way. However, I think this example
demonstrates a feature of the <em>union</em> step that it is important to understand.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">union</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">),</span>
            <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SYD'</span><span class="tok-o">),</span>
            <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">)).</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we run the query, you will see that SYD is not part of the results as there is no
route between Austin and Sydney.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">LHR</span>
<span class="tok-n">DFW</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For completeness, this query would more likely be written as follows rather than
using a <em>union</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'LHR'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">,</span><span class="tok-s1">'SYD'</span><span class="tok-o">)).</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-n">LHR</span>
<span class="tok-n">DFW</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sideeffect">3.21. Using <em>sideEffect</em> to do things on the side</h3>
<div class="paragraph">
<p>The <em>sideEffect</em> step allows you to do some additional processing as part of a query
without changing what gets passed on to the next stage of the query. The example
below finds the airport vertex V(3) and then uses a <em>sideEffect</em> to count the number
of places that you can fly to from there and stores it in a traversal variable named
<em>a</em> before counting how many places you can get to with one stop and storing that
value in <em>b</em>. Note that there are other ways we could write this query but it
demonstrates quite well how <em>sideEffect</em> works.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">sideEffect</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">store</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">)).</span>
       <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-o">[</span><span class="tok-mi">59</span><span class="tok-o">],</span><span class="tok-nl">b:</span><span class="tok-mi">5911</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Later in the book we will discuss lambda functions, sometimes called closures and
how they can be used. The example below combines a closure with a <em>sideEffect</em> to
print a message before displaying information about the vertex that was found. Again
notice how the <em>sideEffect</em> step has no effect on what is seen by the subsequent
steps. You can see the output generated below the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SFO'</span><span class="tok-o">).</span><span class="tok-na">sideEffect</span><span class="tok-o">{</span><span class="tok-n">println</span> <span class="tok-s2">"I'm working on it"</span><span class="tok-o">}.</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">)</span>

<span class="tok-n">I</span><span class="tok-err">'</span><span class="tok-n">m</span> <span class="tok-n">working</span> <span class="tok-n">on</span> <span class="tok-n">it</span>
<span class="tok-n">San</span> <span class="tok-n">Francisco</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Later in the book we will look at other ways that side effects can be used to
solve more interesting problems.</p>
</div>
</div>
<div class="sect2">
<h3 id="aggregate">3.22. Using <em>aggregate</em> to create a temporary collection</h3>
<div class="paragraph">
<p>At the time of writing this book, there were 59 places you could fly to directly
(non stop) from Austin. We can verify this fact using the following query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">59</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we wanted to count how many places we could go to from Austin with one stop, we
could use the following query. The <em>dedup</em> step is used as we only want to know how
many unique places we can go to, not how many different ways of getting to all of
those places there are.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">dedup</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">871</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There is however a problem with this query. The 871 places is going to include (some
or possibly all of) the places we can also get to non stop from Austin. What we
really want to find are all the places that you can only get to from Austin with one
stop. So what we need is a way to remember all of those places and remove them from
the 871 some how. This is where <em>aggregate</em> is useful. Take a look at the modified
query below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">aggregate</span><span class="tok-o">(</span><span class="tok-s1">'nonstop'</span><span class="tok-o">).</span>
     <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">without</span><span class="tok-o">(</span><span class="tok-s1">'nonstop'</span><span class="tok-o">)).</span><span class="tok-na">dedup</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">812</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After the first <em>out</em> step all of the vertices that were found are stored in a
collection I chose to call <em>nonstop</em>. Then, after the second <em>out</em> we can add a
<em>where</em> step that essentially says "only keep the vertices that are not part of the
nonstop collection". We still do the <em>dedup</em> step as otherwise we will still end up
counting a lot of the remaining airports more than once.</p>
</div>
<div class="paragraph">
<p>Notice that 812 is precisely 59 less than the 871 number returned by the previous
query which shows the places you can get to non stop were all correctly removed from
the second query. This also tells us there are no flights from Austin to places that
you cannot get to from anywhere else!</p>
</div>
<div class="paragraph">
<p>We will take a more in depth look at the various types of collections that you can
use as part of a Gremlin query in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#collrev">Collections revisited</a>" section a bit later.</p>
</div>
</div>
<div class="sect2">
<h3 id="inject">3.23. Using <em>inject</em> to insert values into a query</h3>
<div class="paragraph">
<p>Sometimes you may want to add something additional to be returned along with the
results of your query. This can be done using the <em>inject</em> step. To start off, here
is a simple example showing how <em>inject</em> fundamentally works. We insert some numbers
and ask Gremlin to give us the mean value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">inject</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">).</span><span class="tok-na">mean</span><span class="tok-o">()</span>

<span class="tok-mf">3.0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course just using <em>inject</em> so we can do a simple mathematical computation is of
limited use. The next example shows how <em>inject</em> can be used as part of a query. The
string <em>ABIA</em>, another acronym commonly used when referring to the Austin Bergstrom
International Airport, is injected into the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">().</span><span class="tok-na">inject</span><span class="tok-o">(</span><span class="tok-s1">'ABIA'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we were to run the query, here is what we would get back</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">ABIA</span>
<span class="tok-n">US</span>
<span class="tok-n">AUS</span>
<span class="tok-mi">12250</span>
<span class="tok-n">Austin</span>
<span class="tok-mi">542</span>
<span class="tok-n">KAUS</span>
<span class="tok-o">-</span><span class="tok-mf">97.6698989868164</span>
<span class="tok-n">airport</span>
<span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span>
<span class="tok-mi">2</span>
<span class="tok-mf">30.1944999694824</span>
<span class="tok-n">Austin</span> <span class="tok-n">Bergstrom</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="injecttrick">3.23.1. A useful trick using <em>inject</em></h4>
<div class="paragraph">
<p>There is also a useful trick that can be achieved using <em>inject</em>. Take a look at the
query below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">choose</span><span class="tok-o">(</span><span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'XYZ'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">),</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s2">"None found"</span><span class="tok-o">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we were to run it we would get back multiple lines like those below. One for each
vertex in the graph in fact.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">None</span> <span class="tok-n">found</span>
<span class="tok-n">None</span> <span class="tok-n">found</span>
<span class="tok-n">None</span> <span class="tok-n">found</span>
<span class="tok-n">None</span> <span class="tok-n">found</span>
<span class="tok-n">None</span> <span class="tok-n">found</span>
<span class="tok-o">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to get just one result we might be tempted to write the query as
shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">choose</span><span class="tok-o">(</span><span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'XYZ'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">),</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s2">"None found"</span><span class="tok-o">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However this will cause an error to be returned as a choose step cannot come
immediately after a traversal source object (<em>g</em>). To get around this we can
rewrite the query with an <em>inject</em> step after the <em>g</em>. We do not use the value of the
<em>inject</em> in the query but its presence allows us to follow it with a <em>choose</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">inject</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">choose</span><span class="tok-o">(</span><span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'XYZ'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">),</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s2">"None found"</span><span class="tok-o">))</span>

<span class="tok-n">None</span> <span class="tok-n">found</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a trick that can come in useful from time to time. The query used to
demonstrate this point could indeed be rewritten to avoid any use of <em>choose</em> but
hopefully the usefulness of <em>inject</em> as a way to avoid using a <em>V</em> when not wanted is
clear.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="coalesce">3.24. Using <em>coalesce</em> to see which traversal returns a result</h3>
<div class="paragraph">
<p>Sometimes, when you are uncertain as to which traversal of a set you are interested
in will return a result you can have them evaluated in order by the <em>coalesce</em> step.
The first of the traversals that you specify that returns a result will cause that
result to be the one that is returned to your query.</p>
</div>
<div class="paragraph">
<p>Look at the example below. Starting from the vertex with an ID of 3 it uses
<em>coalesce</em> to first see if there are any outgoing edges with a label of <em>fly</em>. If
there are any, the vertices connected to those edges will be returned. If there are
not any, any vertices on any incoming edges labelled <em>contains</em> will be returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Return the first step inside coalesce that returns a vertex</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">coalesce</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'fly'</span><span class="tok-o">),</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">in</span><span class="tok-o">(</span><span class="tok-s1">'contains'</span><span class="tok-o">)).</span><span class="tok-na">valueMap</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As there are not any edges labelled <em>fly</em> in the <em>air-routes</em> graph, the second
traversal will be the one whose results are returned.</p>
</div>
<div class="paragraph">
<p>If we were to run the above query using the <em>air-routes</em> graph, this is what would be
returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">NA</span><span class="tok-o">],</span><span class="tok-nl">type:</span><span class="tok-o">[</span><span class="tok-n">continent</span><span class="tok-o">],</span><span class="tok-nl">desc:</span><span class="tok-o">[</span><span class="tok-n">North</span> <span class="tok-n">America</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">US</span><span class="tok-o">],</span><span class="tok-nl">type:</span><span class="tok-o">[</span><span class="tok-n">country</span><span class="tok-o">],</span><span class="tok-nl">desc:</span><span class="tok-o">[</span><span class="tok-n">United</span> <span class="tok-n">States</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can put more than two traversals inside of a <em>coalesce</em> step. In the following
example there are now three. Because some <em>contains</em> edges do exist for this vertex,
the <em>route</em> edges will not be looked at as the traversals are evaluated in left to
right order.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">coalesce</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'fly'</span><span class="tok-o">),</span>
              <span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">in</span><span class="tok-o">(</span><span class="tok-s1">'contains'</span><span class="tok-o">),</span>
                <span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">)).</span><span class="tok-na">valueMap</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As we can see the results returned are still the same.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">NA</span><span class="tok-o">],</span><span class="tok-nl">type:</span><span class="tok-o">[</span><span class="tok-n">continent</span><span class="tok-o">],</span><span class="tok-nl">desc:</span><span class="tok-o">[</span><span class="tok-n">North</span> <span class="tok-n">America</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">US</span><span class="tok-o">],</span><span class="tok-nl">type:</span><span class="tok-o">[</span><span class="tok-n">country</span><span class="tok-o">],</span><span class="tok-nl">desc:</span><span class="tok-o">[</span><span class="tok-n">United</span> <span class="tok-n">States</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="coalconst">3.24.1. Combining <em>coalesce</em> with a <em>constant</em> value</h4>
<div class="paragraph">
<p>The <em>coalesce</em> step can also be very useful when combined with a <em>constant</em> value. In
the example below if the airport is in Texas then its description is returned. If it
is not in Texas, the string "Not in Texas" is returned instead.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">coalesce</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">),</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s2">"Not in Texas"</span><span class="tok-o">))</span>

<span class="tok-n">Not</span> <span class="tok-k">in</span> <span class="tok-n">Texas</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">coalesce</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">),</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s2">"Not in Texas"</span><span class="tok-o">))</span>

<span class="tok-n">Austin</span> <span class="tok-n">Bergstrom</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A bit later in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#coaladdv">Using <em>coalesce</em> to only add a vertex if it does not exist</a>" section we will again use <em>coalesce</em> to check to
see if a vertex already exists before we try to add it.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="optional">3.25. Returning one of two possible results - introducing <em>optional</em></h3>
<div class="paragraph">
<p>Sometimes it may be useful to return one of two results depending upon the outcome of
an attempted traversal. The <em>optional</em> step will return either the results of the
provided traversal if there is a result or the result of the prior step if there is
no result.</p>
</div>
<div class="paragraph">
<p>In the example below, there is no direct route between Austin (AUS) and Sydney (SYD)
so the Austin vertex is returned by the <em>optional</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">optional</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SYD'</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span>

<span class="tok-n">Austin</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, there is a route between Austin and Dallas Fort Worth (DFW) so as the
example below shows, this time the <em>optional</em> step returns the DFW vertex.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">optional</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span>

<span class="tok-n">Dallas</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the previous queries behave in the same way that the <em>coalesce</em> step would
behave if used as shown below. In this case, an <em>identity</em> step is used to return the
prior vertex if the provided traversal does not return a result.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">coalesce</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SYD'</span><span class="tok-o">),</span><span class="tok-n">identity</span><span class="tok-o">()).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span>

<span class="tok-n">Austin</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">coalesce</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">),</span><span class="tok-n">identity</span><span class="tok-o">()).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span>

<span class="tok-n">Dallas</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="otherv">3.26. Other ways to explore vertices and edges using <em>both</em>, <em>bothE</em>, <em>bothV</em> and <em>otherV</em></h3>
<div class="paragraph">
<p>We have already looked at examples of how you can walk a graph and examine vertices and
edges using steps such as <em>out</em>, <em>in</em>, <em>outE</em> and <em>inE</em>. In this section we
introduce some additional ways to explore vertices and edges.</p>
</div>
<div class="paragraph">
<p>As a quick recap, we have already seen examples of queries like the one below that
simply counts the number of outgoing edges from the vertex with an ID of 3.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">59</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Likewise, this query counts the number of incoming edges to that same vertex.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">inE</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">61</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following query introduces the <em>bothE</em> step. What this step does is return all of
the edges connected to this vertex whether they are outgoing or incoming. As we can see
the count of 120 lines up with the values we got from counting the number of
outgoing and incoming edges. We might want to retrieve the edges, as a simple example, to
examine a property on each of them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">bothE</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">120</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we wanted to return vertices instead of edges, we could use the <em>both</em> step. This
will return all of the vertices connected to the vertex with an ID of 3 regardless of
whether they are connected by an outgoing or an incoming edge.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">both</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">120</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This next query can be used to show us the 120 vertices that we just counted in the
previous query. I sorted the results and used <em>fold</em> to build them into a list to
make the results easier to read. Note how vertex 3 is <strong>not</strong> returned as part of the
results. This is important, for as we shall see in a few examples time, this is not
always the case.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">both</span><span class="tok-o">().</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">5</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">5</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">6</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">6</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">7</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">7</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">9</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">9</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">10</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">10</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">11</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">11</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">12</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">12</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">13</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">13</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">15</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">15</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">16</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">16</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">17</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">17</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">18</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">18</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">20</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">20</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">21</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">21</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">22</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">22</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">23</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">23</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">24</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">24</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">25</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">25</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">26</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">26</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">27</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">27</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">28</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">28</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">29</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">29</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">30</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">30</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">31</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">31</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">34</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">34</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">35</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">35</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">38</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">38</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">39</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">39</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">41</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">41</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">42</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">42</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">45</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">45</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">46</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">46</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">47</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">47</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">49</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">49</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">52</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">52</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">136</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">136</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">147</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">147</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">149</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">149</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">178</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">178</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">180</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">180</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">182</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">182</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">183</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">183</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">184</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">184</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">185</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">185</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">186</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">186</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">187</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">187</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">188</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">188</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">190</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">190</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">273</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">273</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">278</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">278</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">389</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">389</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">416</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">416</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">430</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">430</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">549</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">549</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">929</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">929</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">1274</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">1274</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3591</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3605</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You probably also noticed that most of the vertices appear twice. This is because
for most air routes there is an outgoing and an incoming edge. If we wanted to
eliminate any duplicate results we can do that by adding a <em>dedup</em> step to our query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">both</span><span class="tok-o">().</span><span class="tok-na">dedup</span><span class="tok-o">().</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">5</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">6</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">7</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">9</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">10</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">11</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">12</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">13</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">15</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">16</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">17</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">18</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">20</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">21</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">22</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">23</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">24</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">25</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">26</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">27</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">28</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">29</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">30</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">31</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">34</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">35</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">38</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">39</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">41</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">42</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">45</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">46</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">47</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">49</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">52</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">136</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">147</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">149</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">178</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">180</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">182</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">183</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">184</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">185</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">186</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">187</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">188</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">190</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">273</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">278</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">389</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">416</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">430</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">549</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">929</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">1274</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3591</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3605</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can do another count using our modified query to check we got the expected number
of results back.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">both</span><span class="tok-o">().</span><span class="tok-na">dedup</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">61</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are a similar set of things we can do when working with edges using the <em>bothV</em>
and <em>otherV</em> steps. The <em>bothV</em> step returns the vertices at both ends of an edge and
the <em>otherV</em> step returns the vertex at the other end of the edge. This is relative to
how we are looking at the edge.</p>
</div>
<div class="paragraph">
<p>The query below starts with our same vertex with the ID of 3 and then looks at all the
edges no matter whether they are incoming or outgoing and retrieves all of the
vertices at each end of those edges using the <em>bothV</em> step. Notice that this time our
count is 240. This is because for every one of the 120 edges, we asked for the vertex
at each end so we ended up with 240 of them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">bothE</span><span class="tok-o">().</span><span class="tok-na">bothV</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">240</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can again add a <em>dedup</em> step to get rid of duplicate vertices as we did before and
re-do the count but notice this time we get back 62 instead of the 61 we got before. So what is going on here?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">bothE</span><span class="tok-o">().</span><span class="tok-na">bothV</span><span class="tok-o">().</span><span class="tok-na">dedup</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">62</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s run another query and take a look at all of the vertices that we got back this
time.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">bothE</span><span class="tok-o">().</span><span class="tok-na">bothV</span><span class="tok-o">().</span><span class="tok-na">dedup</span><span class="tok-o">().</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-o">()).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">5</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">6</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">7</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">9</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">10</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">11</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">12</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">13</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">15</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">16</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">17</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">18</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">20</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">21</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">22</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">23</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">24</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">25</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">26</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">27</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">28</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">29</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">30</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">31</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">34</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">35</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">38</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">39</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">41</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">42</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">45</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">46</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">47</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">49</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">52</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">136</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">147</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">149</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">178</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">180</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">182</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">183</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">184</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">185</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">186</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">187</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">188</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">190</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">273</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">278</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">389</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">416</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">430</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">549</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">929</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">1274</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3591</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3605</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Can you spot the difference? This time, vertex 3 (v[3]) <strong>is</strong> included in our
results. This is because we started out by looking at all of the edges and then asked
for all the vertices connected to those edges. Vertex 3 gets included as part of that
computation. So beware of this subtle difference between using <em>both</em> and the
<em>bothE().bothV()</em> pattern.</p>
</div>
<div class="paragraph">
<p>Let’s rewrite the queries we just used again but replace <em>bothV</em> with <em>otherV</em>.
Notice that when we count the number of results we are back to 61 again.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">bothE</span><span class="tok-o">().</span><span class="tok-na">otherV</span><span class="tok-o">().</span><span class="tok-na">dedup</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>
<span class="tok-mi">61</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So let’s again look at the returned vertices and see what the difference is.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">bothE</span><span class="tok-o">().</span><span class="tok-na">otherV</span><span class="tok-o">().</span><span class="tok-na">dedup</span><span class="tok-o">().</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-o">()).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">5</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">6</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">7</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">9</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">10</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">11</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">12</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">13</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">15</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">16</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">17</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">18</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">20</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">21</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">22</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">23</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">24</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">25</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">26</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">27</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">28</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">29</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">30</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">31</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">34</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">35</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">38</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">39</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">41</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">42</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">45</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">46</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">47</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">49</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">52</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">136</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">147</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">149</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">178</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">180</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">182</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">183</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">184</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">185</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">186</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">187</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">188</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">190</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">273</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">278</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">389</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">416</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">430</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">549</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">929</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">1274</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3591</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3605</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, when we use <em>otherV</em> we do not get <em>v[3]</em> returned as we are only
looking at the other vertices relative to where we started from, which was <em>v[3]</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="sp">3.27. Shortest paths (between airports) - introducing <em>repeat</em></h3>
<div class="paragraph">
<p>Gremlin provides a <em>repeat…​until</em> looping construct similar to those found in many
programming languages. This gives us a nice way to perform simple shortest path type
queries. We can use a <em>repeat…​until</em> loop to look for paths between two airports
without having to specify an explicit number of <em>out</em> steps to try.</p>
</div>
<div class="paragraph">
<p>While performing such computations, we may not want paths we have already travelled
to be travelled again. We can ask for this behavior using the <em>simplePath</em> step.
Doing so will speed up queries that do not need to travel the same paths through a
graph multiple times. Without the <em>simplePath</em> step being used the query we are
about to look at could take a lot longer. The addition of a <em>limit</em> step is also
important as without it this query will run for a LONG time looking for every
possible path!!</p>
</div>
<div class="paragraph">
<p>The query below looks for routes between Austin (AUS) and Agra (AGR). An important
query for those Austinites wanting to visit the Taj Mahal!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// What are some of the ways to travel from AUS to AGR?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span>
        <span class="tok-n">until</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AGR'</span><span class="tok-o">)).</span>
        <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results from running the query. Notice how, using the <em>repeat…​until</em>
construct we did not have to specify how many steps to try.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-n">AGR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-n">AGR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-n">AGR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-n">AGR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">ZRH</span><span class="tok-o">,</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-n">AGR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">BRU</span><span class="tok-o">,</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-n">AGR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">MUC</span><span class="tok-o">,</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-n">AGR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">ICN</span><span class="tok-o">,</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-n">AGR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">CAI</span><span class="tok-o">,</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-n">AGR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">ADD</span><span class="tok-o">,</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-n">AGR</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also place the <em>until</em> before the <em>repeat</em> as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Another shortest path example using until...repeat instead</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">until</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SYD'</span><span class="tok-o">)).</span>
        <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results from running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">HND</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">ICN</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">SCL</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">TPE</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">CAN</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also specify an explicit number of out steps to try using a <em>repeat…​times</em>
loop but this of course assumes that we know ahead of time how many stops we want to
look for between airports. In the next section we will introduce the <em>emit</em> step that
gives you more control over the behavior of what is returned from <em>repeat</em> loops.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">()).</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SYD'</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The previous query is equivalent to this next one but doing it this way is less
flexible in that we can not as easily vary the number of <em>out</em> steps, should, for
example we want to next try five hops instead of the current two.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SYD'</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As is often the case when working with Gremlin there is more than one way to achieve
the same result. The <em>loops</em> step, that can be used to control how long a repeat loop
runs, is essentially equivalent to the <em>times</em> step. Take a look at the two queries
below. Both achieve the same result. The first uses <em>loops</em> while the second uses
<em>times</em>. I prefer the readability offered by the use of <em>times</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">()).</span><span class="tok-na">until</span><span class="tok-o">(</span><span class="tok-n">loops</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">)).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">5894</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">()).</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">5894</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you simply want to find out if any route exists between two airports, there
is a nice optimization that can be used. This is discussed in the
"<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#doesanyrouteexist">Does any route exist between two airports?</a>" section later in the book.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>In the next section, we will look at how <em>emit</em> can be used to
adjust the behavior of a <em>repeat…​times</em> loop.</p>
</div>
<div class="sect3">
<h4 id="emit">3.27.1. Using <em>emit</em> to return results during a <em>repeat</em> loop</h4>
<div class="paragraph">
<p>Sometimes it is useful to be able to return the results of a traversal as it
executes. The example below starts at the Santa Fe airport (SAF) and uses a <em>repeat</em>
to keep going out from there. By placing an <em>emit</em> right after the <em>repeat</em> we will
be able to see the paths that are taken by the traversal. If we did not put the
<em>emit</em> here this query would run for a very long time as the <em>repeat</em> has no other
ending condition!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">()).</span><span class="tok-na">emit</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-n">PHX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-n">DEN</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">BNA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Another place where <em>emit</em> can be useful is when <em>repeat</em> and <em>times</em> are used
together to find paths between vertices. Ordinarily, if you use a step such as
<em>times(3)</em> then the query will only return results that are three hops out. However
if we use an <em>emit</em> we can also see results that take fewer hops. First of all take a
look at the query below that does not use an <em>emit</em> and the results that it
generates.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">()).</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'MIA'</span><span class="tok-o">).</span>
       <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The paths returned show a selection of ways to get to Miami from Austin with two
stops but none of the results show fewer than two stops. Is this what we really
wanted?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">MUC</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">YUL</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">SVO</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">GRU</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let’s change the query to use an <em>emit</em>. This time you can think of the query as
saying "at most three hops" or in airline terms "at most two stops".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span><span class="tok-na">emit</span><span class="tok-o">().</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'MIA'</span><span class="tok-o">).</span>
       <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, by adding an <em>emit</em> we got back a quite different set of results.
This is a really useful and powerful capability. Being able to express ideas such as
"at most three" provides us a way to write very clean queries in cases like this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">MEX</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that using the emit step in the previous query we were able to write a more
compact form of this query which essentially does the same thing. Note the use of the
inline <em>or</em> step in this example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span>
         <span class="tok-n">until</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'MIA'</span><span class="tok-o">).</span><span class="tok-na">or</span><span class="tok-o">().</span><span class="tok-na">loops</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">)).</span>
       <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'MIA'</span><span class="tok-o">).</span>
       <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When run, as you can see, we get the same results back.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">MEX</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>emit</em> step can also take a parameter such as a <em>has</em> step to filter out
intermediate results that we are not interested in. The query below will only show
intermediate results as the <em>repeat</em> operates if they meet a given condition. In this
case the condition is that the path must have passed through the Prague (PRG)
airport’s vertex. A <em>limit</em> step is used to only show the first 10 results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span><span class="tok-na">emit</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'PRG'</span><span class="tok-o">)).</span>
       <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results from running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">PRG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">PRG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-n">PRG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DTW</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">PRG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DTW</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">PRG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DTW</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">,</span><span class="tok-n">PRG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DTW</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-n">PRG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DTW</span><span class="tok-o">,</span><span class="tok-n">PVG</span><span class="tok-o">,</span><span class="tok-n">PRG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DTW</span><span class="tok-o">,</span><span class="tok-n">AMS</span><span class="tok-o">,</span><span class="tok-n">PRG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DTW</span><span class="tok-o">,</span><span class="tok-n">MUC</span><span class="tok-o">,</span><span class="tok-n">PRG</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Without the condition as part of the <em>emit</em> step we get different results as we are
shown every path the graph traverser is taking.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span><span class="tok-na">emit</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DTW</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">MEX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">PIT</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">PDX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">ONT</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">CLT</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">CUN</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So far, while interesting, many of the results shown look at first glance as if they
could have been generated without using an <em>emit</em>. However, the query below
is more interesting in that we use an <em>until</em> step to specify a target airport of
Austin (AUS) that we are interested in getting to from Lerwick (LSI) in the Shetland
Islands. We also specify, as part of the <em>emit</em> step, that we are interested in
seeing any routes found that involve any airports in New York State regardless of
whether or not they end up in Austin.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LSI'</span><span class="tok-o">).</span>
     <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span>
        <span class="tok-n">emit</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-NY'</span><span class="tok-o">)).</span>
        <span class="tok-n">until</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">)).</span>
     <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results the query generates, Notice how we got a mixture of New York
airports as well as Austin as our final destinations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">LSI</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">]</span>
<span class="tok-n">LSI</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">]</span>
<span class="tok-n">LSI</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">,</span><span class="tok-n">SWF</span><span class="tok-o">]</span>
<span class="tok-n">LSI</span><span class="tok-o">,</span><span class="tok-n">GLA</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">]</span>
<span class="tok-n">LSI</span><span class="tok-o">,</span><span class="tok-n">GLA</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">]</span>
<span class="tok-n">LSI</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-n">LSI</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-n">ROC</span><span class="tok-o">]</span>
<span class="tok-n">LSI</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-n">BUF</span><span class="tok-o">]</span>
<span class="tok-n">LSI</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-n">SYR</span><span class="tok-o">]</span>
<span class="tok-n">LSI</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">ROC</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>emit</em> can also be placed before the <em>repeat</em> step. This will cause the
result of the previous step in the query to be emitted before the results that
follow. In the example below, we start in Austin and go out two hops using a <em>repeat</em>
loop. The first ten airport codes of the places we found are returned. Notice how AUS
is returned as the first value even though that is where we started from due to our
use of <em>emit</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">emit</span><span class="tok-o">().</span><span class="tok-na">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">ZRH</span><span class="tok-o">,</span><span class="tok-n">YOW</span><span class="tok-o">,</span><span class="tok-n">BRU</span><span class="tok-o">,</span><span class="tok-n">MUC</span><span class="tok-o">,</span><span class="tok-n">RSW</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">YUL</span><span class="tok-o">,</span><span class="tok-n">YEG</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In some cases, an <em>emit</em> placed after a <em>repeat</em> step has the same effect as an
<em>until</em> step. Both queries below look for routes between Johannesburg (JNB) and
Sydney (SYD).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'JNB'</span><span class="tok-o">).</span><span class="tok-na">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">()).</span><span class="tok-na">until</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SYD'</span><span class="tok-o">)).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">)</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'JNB'</span><span class="tok-o">).</span><span class="tok-na">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">()).</span><span class="tok-na">emit</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SYD'</span><span class="tok-o">)).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When either query is run, the following results are returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">JNB</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">JNB</span><span class="tok-o">,</span><span class="tok-n">BKK</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">JNB</span><span class="tok-o">,</span><span class="tok-n">DOH</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You will see more examples of <em>emit</em> being used in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#btree">Modelling an ordered binary tree as a graph</a>" section a bit
later.</p>
</div>
</div>
<div class="sect3">
<h4 id="nestedrepeat">3.27.2. Nested and named <em>repeat</em> steps</h4>
<div class="paragraph">
<p>Starting with Apache TinkerPop release 3.4 it is now possible to nest a <em>repeat</em> step
inside another <em>repeat</em> step as well as inside <em>emit</em> and <em>until</em> steps.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The official documentation for these new capabilities can be located here: <a href="http://tinkerpop.apache.org/docs/current/reference/#repeat-step" class="bare">http://tinkerpop.apache.org/docs/current/reference/#repeat-step</a>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>It is also possible to label a repeat step with a name so that it can be referenced
later in a traversal. Nested <em>repeat</em> steps allow for some interesting new graph
traversal patterns. For example you might be traversing along a set of outgoing
edges, and for each vertex along the way want to traverse a set of incoming edges.
The <code>air-routes</code> graph does not have any relationships that demonstrate an ideal use
case for nested <em>repeat</em> steps but the query below shows a simple example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">simplePath</span><span class="tok-o">().</span>
        <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">in</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">)).</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">)).</span>
      <span class="tok-n">times</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
      <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span>
      <span class="tok-n">toList</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Running the query will generate results similar to those shown below. We start at
Santa Fe (SAF) and take one outbound route and arrive at Dallas Fort Worth (DFW). We
then look at three incoming routes which yields Corpus Christi (CRP), Lubbock (LBB)
and Austin (AUS). We then take another outbound hop from DFW and find ourselves in
Atlanta(ATL) we then look at three incoming routes from Atlanta and find Lagos (LOS),
Addis Ababa (ADD) and one of Oslo (OSL), Bangkok (BKK) or Mumbai (BOM).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">CRP</span><span class="tok-o">,</span><span class="tok-n">LBB</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">LOS</span><span class="tok-o">,</span><span class="tok-n">ADD</span><span class="tok-o">,</span><span class="tok-n">OSL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">CRP</span><span class="tok-o">,</span><span class="tok-n">LBB</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">LOS</span><span class="tok-o">,</span><span class="tok-n">ADD</span><span class="tok-o">,</span><span class="tok-n">BKK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">CRP</span><span class="tok-o">,</span><span class="tok-n">LBB</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">LOS</span><span class="tok-o">,</span><span class="tok-n">ADD</span><span class="tok-o">,</span><span class="tok-n">BOM</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As I mentioned, working with the air routes data set does not perhaps present an
ideal use case for using nested repeat steps. Most of the edges are routes and most
of the vertices are airports. However, if your data had a broader variety of vertex
and edge types, this capability may come in quite handy.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There is a stand alone example in the <code>sample-code</code> folder that creates a small
social graph and performs various nested <em>repeat</em> step operations. That sample is
located here: <a href="https://github.com/krlawrence/graph/blob/master/sample-code/nested-repeat.groovy" class="bare">https://github.com/krlawrence/graph/blob/master/sample-code/nested-repeat.groovy</a>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>When using nested <em>repeat</em> steps, in order for a <em>loops</em> step to know which repeat
step it is attached to it is necessary to give each <em>repeat</em> step its own label name.
The example below gives the <em>repeat</em> step a label of <em>"r1"</em> and refers to that label
in the subsequent <em>loops</em> step. Obviously, this example does not contain any nested
repeats but hopefully shows how this new labelling capability can be used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-s1">'r1'</span><span class="tok-o">,</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span>
        <span class="tok-n">until</span><span class="tok-o">(</span><span class="tok-n">loops</span><span class="tok-o">(</span><span class="tok-s1">'r1'</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">or</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'MAN'</span><span class="tok-o">)).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span>
      <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span>
      <span class="tok-n">toList</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The results below show that we found Manchester once and reached our <em>loops</em> limit the
other two times.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">Santa</span> <span class="tok-n">Fe</span><span class="tok-o">,</span><span class="tok-n">Los</span> <span class="tok-n">Angeles</span><span class="tok-o">,</span><span class="tok-n">Manchester</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">Santa</span> <span class="tok-n">Fe</span><span class="tok-o">,</span><span class="tok-n">Dallas</span><span class="tok-o">,</span><span class="tok-n">Buenos</span> <span class="tok-n">Aires</span><span class="tok-o">,</span><span class="tok-n">Atlanta</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">Santa</span> <span class="tok-n">Fe</span><span class="tok-o">,</span><span class="tok-n">Dallas</span><span class="tok-o">,</span><span class="tok-n">Buenos</span> <span class="tok-n">Aires</span><span class="tok-o">,</span><span class="tok-n">Houston</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="depthlimit">3.27.3. Limiting the results at each depth</h4>
<div class="paragraph">
<p>Sometimes, while exploring a graph using <em>repeat</em> steps, it is desirable to
limit the amount of results returned at any given depth of a traversal.
Achieving this result is a little more complicated than you might expect. The
<em>limit</em> step has a global scope, as shown below, and is therefore not quite what
we need in this case.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SFO'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span>
      <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When the query is run, we get back five results at depth three (three hops) from
San Francisco (SFO). While interesting, this is not the result we are looking
for in this case.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">BNA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>At first glance, it may appear that simply moving the <em>limit</em> step inside the
body of the <em>repeat</em> step is all we need to do but because of the global nature
of the <em>limit</em> step we need to take a different approach.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SFO'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">().</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">)).</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span>
       <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, when the query is run we get the same result we got when <em>limit</em> was
outside the <em>repeat</em> step body.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">BNA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to construct a traversal that will yield five results at each depth we
need to introduce some additional steps into the query. Rather than jump
straight to the final query though, let’s look at some intermediate steps first.</p>
</div>
<div class="paragraph">
<p>First of all, lets write a query that counts how many places we might end up at
for each depth, starting at SFO to a depth of three hops. To do this we can use
the <em>loops</em> step as the key for a <em>groupCount</em> step. Remember that <em>loops</em> will
tell us the depth we are currently at while executing a <em>repeat</em> step.
The <em>loops</em> step depth counter starts at zero, so a value of zero really means
we are at depth one. The counts generated by this query will include duplicates
as there are multiple ways to get to the same airport beyond depth one but that
is not a problem for the query we are building.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SFO'</span><span class="tok-o">).</span>
       <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">().</span>
              <span class="tok-n">groupCount</span><span class="tok-o">(</span><span class="tok-s1">'airports'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">loops</span><span class="tok-o">())).</span>
       <span class="tok-n">times</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span>
       <span class="tok-n">cap</span><span class="tok-o">(</span><span class="tok-s1">'airports'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When given a label, in this case "<em>airports</em>", the <em>groupCount</em> step acts as a
side effect. This means that it counts what passes through it but does not
change what is passed on to subsequent steps in the query. The <em>cap</em> step at the
end of the query explicitly returns the counts to us. As you can see below, when
run, the query produces a map of the route counts at the first three depths,
where the depth is the map key and the count is the map value. As a side note,
it is interesting to see how quickly queries like this one can "fan out". We
have essentially visited airport vertices over 836,000 times at depth three
given all the duplicate visits.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">:</span><span class="tok-mi">141</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">:</span><span class="tok-mi">11587</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">:</span><span class="tok-mi">836707</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have a query that can count how many vertices we are visiting at
each depth we can use that to add a constraint that limits how many we return.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The query below is available as a script called <code>restricted-repeat.groovy</code>
in the sample-code folder located at
<a href="https://github.com/krlawrence/graph/tree/master/sample-code" class="bare">https://github.com/krlawrence/graph/tree/master/sample-code</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>An updated version of our query is shown below. A <em>where</em> step has been added
that initially selects the map generated by <em>groupCount</em> and from that uses the
current <em>loops</em> value to select an entry from the map. A vertex is passed on
by the <em>where</em> step filter only if five or fewer have been encountered so far.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SFO'</span><span class="tok-o">).</span>
       <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">().</span><span class="tok-na">groupCount</span><span class="tok-o">(</span><span class="tok-s1">'airports'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">loops</span><span class="tok-o">()).</span>
              <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'airports'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">loops</span><span class="tok-o">()).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">lte</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">)))).</span>
       <span class="tok-n">emit</span><span class="tok-o">().</span>
       <span class="tok-n">times</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span>
       <span class="tok-n">path</span><span class="tok-o">().</span>
         <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When we run our modified query, the output is quite different. This time at each
depth, five routes are returned. This is the result we are looking for!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">BNA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-n">PDX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-n">FAI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">BNA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>At first glance, the <em>where</em> step used above can be confusing. I have included
some examples below that hopefully help explain the behavior more easily. First
of all, the query below simply creates a map using <em>groupCount</em> based on five
vertex IDs where the key is simply a constant literal value. As there is no
<em>where</em> step present all five incoming vertices are accounted for in the result.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">).</span><span class="tok-na">groupCount</span><span class="tok-o">(</span><span class="tok-s1">'x'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'A'</span><span class="tok-o">)).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'x'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">A:</span><span class="tok-mi">1</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">A:</span><span class="tok-mi">2</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">A:</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">A:</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">A:</span><span class="tok-mi">5</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we only wanted the third vertex to pass through the <em>where</em> step filter we
could adjust the query as follows. This is essentially what our "five at each
depth" query does but is perhaps easier to follow.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">).</span><span class="tok-na">groupCount</span><span class="tok-o">(</span><span class="tok-s1">'x'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'A'</span><span class="tok-o">)).</span>
               <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'x'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'A'</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">))</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lastly, we can see what happens when we change the constraint to be less than or
equal to three. Only the first three vertices are included in the result.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">).</span><span class="tok-na">groupCount</span><span class="tok-o">(</span><span class="tok-s1">'x'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'A'</span><span class="tok-o">)).</span>
               <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'x'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'A'</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">lte</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">)))</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">]</span>
<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]</span>
<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There is another example of limiting the results of a <em>repeat</em> step using
a combination of <em>local</em> and <em>limit</em> steps in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#randwalk">Randomly walking a graph</a>" section later
in the book.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Hopefully, by decomposing the steps in this way you are able to gain a good
understanding of how this very useful Gremlin query works.</p>
</div>
</div>
<div class="sect3">
<h4 id="cyclicpath">3.27.4. Haven’t I been here before? - Introducing <em>cyclicPath</em></h4>
<div class="paragraph">
<p>You can use the <em>cyclicPath</em> step to find paths through the graph that revisit a
vertex seen earlier in the traversal. This does not necessarily mean revisiting the
starting vertex, it can be any vertex already seen while traversing a graph. An
example of some cyclic paths is shown below. The rather contrived query below finds
ten routes that both start and end in Austin (AUS) with a stop along the way.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// From Austin and back again with one stop.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">cyclicPath</span><span class="tok-o">().</span>
      <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results from running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">TUS</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">PHL</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DTW</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">MEX</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">PIT</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">PDX</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">ONT</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use <em>cyclicPath</em> as a termination condition for a <em>repeat</em> loop. The
query below keeps following outbound <em>route</em> edges until it ends up back where it
started. Once again, only the first ten results are selected.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">)).</span><span class="tok-na">until</span><span class="tok-o">(</span><span class="tok-n">cyclicPath</span><span class="tok-o">()).</span>
      <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results from running the query. As you can see it generated the same
results in this instance but if we let it run for longer than just ten results it
would ultimately find a lot more cyclic paths as it is not restricted to just going
out one hop from its starting point. Indeed, if we did not restrict the number of
results we wanted the query would ultimately find every cyclic route in the graph.
That query could run for quite a while so I would not recommend trying it!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">TUS</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">PHL</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DTW</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">MEX</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">PIT</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">PDX</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">ONT</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we let the previous query run a few hundred times you would start to see examples
of where the cycle is not back to the starting vertex. The two results below were
generated by letting the query find 500 cyclic paths. Note that in the second case
the cycle is back to Miami (MIA) and not the starting vertex (AUS).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">,</span><span class="tok-n">BUF</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">,</span><span class="tok-n">BUF</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use <em>cyclicPath</em> combined with a <em>not</em> predicate to avoid returning
cyclic results from a query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">not</span><span class="tok-o">(</span><span class="tok-n">cyclicPath</span><span class="tok-o">()).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that for the <em>air-routes</em> graph this has the same effect as if we had written
the query as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">)).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Some graphs contain vertices that have an edge that loops immediately back to the
same vertex. Take a look at the code below that creates an edge with a label of
<em>loop</em> from the vertex with an ID of 3 back to the same vertex.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">addE</span><span class="tok-o">(</span><span class="tok-s1">'loop'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">)</span>

<span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">56951</span><span class="tok-o">][</span><span class="tok-mi">3</span><span class="tok-o">-</span><span class="tok-n">loop</span><span class="tok-o">-&gt;</span><span class="tok-mi">3</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can then use the <em>cyclicPath</em> step to find such loops in the graph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">cyclicPath</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To include the edge in the result, you just need to modify the query a little as
shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">cyclicPath</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">56951</span><span class="tok-o">][</span><span class="tok-mi">3</span><span class="tok-o">-</span><span class="tok-n">loop</span><span class="tok-o">-&gt;</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="pathwarn">3.27.5. A warning that path finding can be memory and CPU intensive</h4>
<div class="paragraph">
<p>Take a look at the query below. It returns the first 10 routes found that will get
you from Papa Stour (PSV), a small airport in the Shetland Islands, to Austin (AUS).
The <em>simplePath</em> step is used to make sure the same exact path is never looked at
twice. This query runs quickly and returns some useful results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'PSV'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span>
      <span class="tok-n">until</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">)).</span>
      <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are some of the routes returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">PSV</span><span class="tok-o">,</span><span class="tok-n">LWK</span><span class="tok-o">,</span><span class="tok-n">FIE</span><span class="tok-o">,</span><span class="tok-n">KOI</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">PSV</span><span class="tok-o">,</span><span class="tok-n">LWK</span><span class="tok-o">,</span><span class="tok-n">FIE</span><span class="tok-o">,</span><span class="tok-n">KOI</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">PSV</span><span class="tok-o">,</span><span class="tok-n">LWK</span><span class="tok-o">,</span><span class="tok-n">FIE</span><span class="tok-o">,</span><span class="tok-n">KOI</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">PSV</span><span class="tok-o">,</span><span class="tok-n">LWK</span><span class="tok-o">,</span><span class="tok-n">FIE</span><span class="tok-o">,</span><span class="tok-n">KOI</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">PSV</span><span class="tok-o">,</span><span class="tok-n">LWK</span><span class="tok-o">,</span><span class="tok-n">FIE</span><span class="tok-o">,</span><span class="tok-n">KOI</span><span class="tok-o">,</span><span class="tok-n">GLA</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">PSV</span><span class="tok-o">,</span><span class="tok-n">LWK</span><span class="tok-o">,</span><span class="tok-n">FIE</span><span class="tok-o">,</span><span class="tok-n">KOI</span><span class="tok-o">,</span><span class="tok-n">GLA</span><span class="tok-o">,</span><span class="tok-n">MCO</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">PSV</span><span class="tok-o">,</span><span class="tok-n">LWK</span><span class="tok-o">,</span><span class="tok-n">FIE</span><span class="tok-o">,</span><span class="tok-n">KOI</span><span class="tok-o">,</span><span class="tok-n">GLA</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">PSV</span><span class="tok-o">,</span><span class="tok-n">LWK</span><span class="tok-o">,</span><span class="tok-n">FIE</span><span class="tok-o">,</span><span class="tok-n">KOI</span><span class="tok-o">,</span><span class="tok-n">GLA</span><span class="tok-o">,</span><span class="tok-n">PHL</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">PSV</span><span class="tok-o">,</span><span class="tok-n">LWK</span><span class="tok-o">,</span><span class="tok-n">FIE</span><span class="tok-o">,</span><span class="tok-n">KOI</span><span class="tok-o">,</span><span class="tok-n">GLA</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">PSV</span><span class="tok-o">,</span><span class="tok-n">LWK</span><span class="tok-o">,</span><span class="tok-n">FIE</span><span class="tok-o">,</span><span class="tok-n">KOI</span><span class="tok-o">,</span><span class="tok-n">GLA</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we reverse the query as shown below we can run into trouble. In fact, if
you run this query on your laptop, after a few minutes of high CPU usage and
increased fan noise, it is likely you will get an error that the query ran out of
available memory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span>
      <span class="tok-n">until</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'PSV'</span><span class="tok-o">)).</span>
      <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The reason this happens is as follows. There are very few routes from PSV and not
many more from the airports it is closely connected to. Therefore, if you start the
query from PSV, you will fairly quickly find some paths that end up in AUS. However,
if you start from AUS there are a lot of possible routes that Gremlin has to explore
before it gets close to finding PSV. If it helps, think of a funnel where PSV is at
the narrow end and AUS is at the other. This is also sometimes referred to as having
a high or low "fan out" of possible routes depending on the query direction.</p>
</div>
</div>
<div class="sect3">
<h4 id="pathstepwarn">3.27.6. A warning that the <em>path</em> and <em>as</em> steps can also be memory intensive</h4>
<div class="paragraph">
<p>The Gremlin <em>path</em> step is incredibly useful and I find myself using it a lot.
However, there are some downsides to the use of <em>path</em>, especially when searching
entire graphs for non trivial results. Even if the paths that you are looking for
are less difficult to find than in the prior section, you should be aware that
keeping track of all the paths that you find and retrieving them using a <em>path</em> step
can require a lot of memory to be used.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <em>path</em> and <em>as</em> steps can use a lot of memory and in some cases cause
issues.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The reason that so much memory can be consumed is that the <em>path</em> step, even if
<em>simplePath</em> is used to avoid travelling the same exact path more than once, requires
the query processor to potentially store up a very large number of results before
finding the ones we are actually interested in. So while the <em>path</em> step is
incredibly useful, be aware that in cases where a lot of paths need to be tracked, it
can get you into trouble if not used with care. A Gremlin query processor will have a
limited amount of memory available in which to execute a given query. Storing a large
amount of path information may exceed that limit causing query execution to fail.</p>
</div>
<div class="paragraph">
<p>Something that may not be immediately obvious is that using an <em>as</em> step can also
require the query processor to, at least in part, store path information requiring
significant amounts of memory. The <em>as</em> step allows us to refer back to the previous
state of a traversal but potentially requires a lot of memory to hold this state
during complex queries.</p>
</div>
<div class="paragraph">
<p>If you find yourself running into memory limitation issues there are often ways to
circumvent the problem using different approaches to writing the query. You will find
an example of such a case in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#sackpredicate">Comparing properties and constants to the value of a sack</a>" section.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="nd">3.28. Calculating vertex degree</h3>
<div class="paragraph">
<p>While working with graphs, the word <em>degree</em> is used when discussing the number of
edges coming into a vertex (in degree), going out from a vertex (out degree) or
potentially both coming in and going out (degree). It’s quite simple with Gremlin to
calculate various measures of degree as the following examples demonstrate.</p>
</div>
<div class="paragraph">
<p>The simplest way to calculate vertex degree is simply to count edges as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Outgoing degree</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">191</span>

<span class="tok-c1">// Incoming degree</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span><span class="tok-na">in</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">193</span>

<span class="tok-c1">// Overall degree</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span><span class="tok-na">both</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">384</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to calculate the degree values for more than a single vertex, it can be
done more easily using the <em>group</em> step. The query below will calculate the
number of outgoing routes for every airport in the graph. If you run this query you
will get quite a lot of result data back as there are over 3,300 airports in the
graph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Out degree (number of routes) from each vertex (airport)</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The query below builds upon the prior one but just selects a few of the results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Outbound routes (degree) from LHR, JFK and DFW</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'LHR'</span><span class="tok-o">,</span><span class="tok-s1">'JFK'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we were to run the query the output should look like this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">LHR:</span><span class="tok-mi">191</span><span class="tok-o">,</span><span class="tok-nl">JFK:</span><span class="tok-mi">187</span><span class="tok-o">,</span><span class="tok-nl">DFW:</span><span class="tok-mi">221</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could change the query a little to calculate the in degree values. Note that we
can see that JFK has one fewer incoming route than it has outgoing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">in</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'LHR'</span><span class="tok-o">,</span><span class="tok-s1">'JFK'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">LHR:</span><span class="tok-mi">191</span><span class="tok-o">,</span><span class="tok-nl">JFK:</span><span class="tok-mi">186</span><span class="tok-o">,</span><span class="tok-nl">DFW:</span><span class="tok-mi">221</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The query below is a little more complex but can be used to find the 10 airports with
the highest number of outgoing routes. Some of the concepts used such as <em>local</em>
scope are covered in more detail a bit later on in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#localcollect">Using <em>local</em> scope with collections</a>" section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span>
      <span class="tok-n">order</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">().</span><span class="tok-na">tail</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results from running the query. As you can see, Frankfurt Airport (FRA) has the
highest number of outgoing routes. The topic of analyzing routes is revisited in
detail in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#mostroutes">Airports with the most routes</a>" section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">=</span><span class="tok-mi">221</span><span class="tok-o">,</span><span class="tok-n">DXB</span><span class="tok-o">=</span><span class="tok-mi">229</span><span class="tok-o">,</span><span class="tok-n">ORD</span><span class="tok-o">=</span><span class="tok-mi">232</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">=</span><span class="tok-mi">232</span><span class="tok-o">,</span><span class="tok-n">PEK</span><span class="tok-o">=</span><span class="tok-mi">234</span><span class="tok-o">,</span><span class="tok-n">MUC</span><span class="tok-o">=</span><span class="tok-mi">237</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">=</span><span class="tok-mi">262</span><span class="tok-o">,</span><span class="tok-n">AMS</span><span class="tok-o">=</span><span class="tok-mi">269</span><span class="tok-o">,</span><span class="tok-n">IST</span><span class="tok-o">=</span><span class="tok-mi">270</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">=</span><span class="tok-mi">272</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The next query will calculate the route degree based on all, incoming and outgoing,
routes for ten airports. The query takes advantage of the <em>project</em> step that was
introduced in TinkerPop 3.2.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Calculate degree (in and out) for each vertex.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s2">"v"</span><span class="tok-o">,</span><span class="tok-s2">"degree"</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">bothE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the output that this query generates.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">v:</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-nl">degree:</span><span class="tok-mi">464</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">v:</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-nl">degree:</span><span class="tok-mi">78</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">v:</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-nl">degree:</span><span class="tok-mi">118</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">v:</span><span class="tok-n">BNA</span><span class="tok-o">,</span><span class="tok-nl">degree:</span><span class="tok-mi">110</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">v:</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-nl">degree:</span><span class="tok-mi">260</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">v:</span><span class="tok-n">BWI</span><span class="tok-o">,</span><span class="tok-nl">degree:</span><span class="tok-mi">178</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">v:</span><span class="tok-n">DCA</span><span class="tok-o">,</span><span class="tok-nl">degree:</span><span class="tok-mi">186</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">v:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">degree:</span><span class="tok-mi">442</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">v:</span><span class="tok-n">FLL</span><span class="tok-o">,</span><span class="tok-nl">degree:</span><span class="tok-mi">284</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">v:</span><span class="tok-n">IAD</span><span class="tok-o">,</span><span class="tok-nl">degree:</span><span class="tok-mi">272</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could of course also write the same query using a <em>group</em> step as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">bothE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The results below were generated by running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">DCA:</span><span class="tok-mi">186</span><span class="tok-o">,</span><span class="tok-nl">BNA:</span><span class="tok-mi">110</span><span class="tok-o">,</span><span class="tok-nl">DFW:</span><span class="tok-mi">442</span><span class="tok-o">,</span><span class="tok-nl">BWI:</span><span class="tok-mi">178</span><span class="tok-o">,</span><span class="tok-nl">ANC:</span><span class="tok-mi">78</span><span class="tok-o">,</span><span class="tok-nl">BOS:</span><span class="tok-mi">260</span><span class="tok-o">,</span><span class="tok-nl">FLL:</span><span class="tok-mi">284</span><span class="tok-o">,</span><span class="tok-nl">ATL:</span><span class="tok-mi">464</span><span class="tok-o">,</span><span class="tok-nl">IAD:</span><span class="tok-mi">272</span><span class="tok-o">,</span><span class="tok-nl">AUS:</span><span class="tok-mi">118</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mathstep">3.29. Gremlin’s scientific calculator - introducing <em>math</em></h3>
<div class="paragraph">
<p>As we have seen in some of the prior sections, there are some Gremlin steps such as
<em>sum</em>, <em>count</em> and <em>mean</em> that can be used to perform some fairly basic mathematical
operations. In Apache TinkerPop version 3.3.1 a new <em>math</em> step was introduced that
allows us to perform scientific calculator style mathematical operations as part of a
Gremlin graph traversal. As these operators build upon the Java Math class it is
worth becoming familiar with that class if you are not already. Be aware that this
functionality will only be available to you if the graph implementation that you are
using supports Apache TInkerPop 3.3.1 or higher.</p>
</div>
<div class="paragraph">
<p>The table below provides a summary of the available operators sorted alphabetically.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Scientific calculator operators</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">+</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Arithmetic plus.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Arithmetic minus.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Arithmetic multiply.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Arithmetic divide.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Arithmetic modulo (remainder).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">^</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Raise to the power. (n^x).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">abs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Absolute value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">acos</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Arc (inverse) cosine in radians.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">asin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Arc (inverse) sine in radians.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">atan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Arc (inverse) tangent in radians.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cbrt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cube root</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ceil</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the smallest (closest to negative infinity) double value that is greater than or equal to the argument and is equal to a mathematical integer.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cos</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cosine of angle given in radians.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cosh</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hyperbolic cosine.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">exp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns Euler’s number <em>"e"</em> raised to the given power <em>(e^x)</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">floor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the largest (closest to positive infinity) double value that is less than or equal to the argument and is equal to a mathematical integer.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">log</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Natural logarithm (base <em>e</em>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">log10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Logarithm (base 10)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">log2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Logarithm (base 2)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">signum</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the <em>signum</em> function of the argument; zero if the argument is zero, 1.0 if the argument is greater than zero, -1.0 if the argument is less than zero.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sine of angle given in radians.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sinh</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hyperbolic sine</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sqrt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Square root</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tangent of angle given in radians.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tanh</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hyperbolic tangent.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <em>math</em> step behaves differently from other steps that we have looked at so far in
as much as the entire expression is passed in as a single string. This means that you
can use labels you have assigned as part of a traversal but you cannot use external
variables or static constant references such as <em>Math.PI</em> inside the expression
itself. There are ways to easily work around this however as we shall see below. I
have not attempted to give an example of every single operator being used but the
examples provided should provide all of the basic building blocks you will need to
incorporate mathematical operators into your own Gremlin queries.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
These features require that the graph database system you are using supports a
TinkerPop version of 3.3.1 or higher.
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="arithmentic">3.29.1. Performing simple arithmetic</h4>
<div class="paragraph">
<p>Let’s start by looking at a few basic examples. First of all the query below shows
that we can perform mathematical operations on literal values as part of a
traversal. The vertex we found at the start of the traversal is not used by the math
step in this case.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">math</span><span class="tok-o">(</span><span class="tok-s1">'100/2'</span><span class="tok-o">)</span>

<span class="tok-mf">50.0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to use the result of the prior step of a traversal as part of a <em>math</em>
step the special symbol <em>"_"</em> (underscore) can be used as shown below. Note that the
<em>inject</em> step provides us a nice way to feed in values while experimenting with the
<em>math</em> step</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">inject</span><span class="tok-o">(</span><span class="tok-mi">100</span><span class="tok-o">).</span><span class="tok-na">math</span><span class="tok-o">(</span><span class="tok-s1">'_ /2'</span><span class="tok-o">)</span>

<span class="tok-mf">50.0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let’s look at how vertex properties can be used by a <em>math</em> step. To do this, we
can also use named traversal steps as part of a <em>math</em> operation. The examples below
start by checking how many runways the DFW and SFO airports have. Then a <em>math</em> step
is used to show how we can add those values together as part of a traversal.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// How many runways does DFW have?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">)</span>

<span class="tok-mi">7</span>

<span class="tok-c1">// How many runways does SFO have?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SFO'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">)</span>

<span class="tok-mi">4</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let’s use <em>math</em> to add the values together as part of a single traversal. Note
that even though we are adding two integers together, the result comes back as a
double precision value. Also, note that the named steps <em>'a'</em> and
<em>'b'</em> are specified inside the single string that is passed to the math
step. This is a key difference from all other steps where we refer to one or more
traversal labels inside of a step. Lastly, notice that a <em>by</em> modulator is used to
tell the <em>math</em> step which properties we want to add together.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Use named steps to add some results together.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SFO'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span>
      <span class="tok-n">math</span><span class="tok-o">(</span><span class="tok-s1">'a + b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">)</span>

<span class="tok-mf">11.0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The examples below show division and modulo operators being used on the results of a
<em>count</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">59</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">math</span><span class="tok-o">(</span><span class="tok-s1">'_ / 2'</span><span class="tok-o">)</span>

<span class="tok-mf">29.5</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">math</span><span class="tok-o">(</span><span class="tok-s1">'_ % 5'</span><span class="tok-o">)</span>

<span class="tok-mf">4.0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the underscore character allowed us to avoid having to write the previous
queries using a pattern like the one used below where the count step is labelled as
<em>'a'</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">math</span><span class="tok-o">(</span><span class="tok-s1">'a / 2'</span><span class="tok-o">)</span>

<span class="tok-mf">29.5</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mathby">3.29.2. Using a <em>by</em> modulator with a <em>math</em> step</h4>
<div class="paragraph">
<p>As with many Gremlin steps, a <em>math</em> step can also be combined with one or more <em>by</em>
modulators. First of all let’s write a simple query to inspect the number of runways
and Santa Fe (SAF) and all of the places that you can fly to from there.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">())</span>

<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-nl">b:</span><span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-nl">b:</span><span class="tok-o">[</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-nl">b:</span><span class="tok-o">[</span><span class="tok-n">PHX</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-nl">b:</span><span class="tok-o">[</span><span class="tok-n">DEN</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let’s modify the query to use a <em>math</em> step to add the number of runways each
pair of airports has.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span>
      <span class="tok-n">math</span><span class="tok-o">(</span><span class="tok-s1">'a + b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">)</span>

<span class="tok-mf">10.0</span>
<span class="tok-mf">7.0</span>
<span class="tok-mf">6.0</span>
<span class="tok-mf">9.0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, this is a simple example where <em>math</em> is not really needed but hopefully
it shows how a <em>by</em> modulator can be used with a <em>math</em> step. For completeness, here
is the query rewritten to use a <em>sum</em> step. Notice that in this case the results are
integers whereas the <em>math</em> step always returns floating point values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">).</span><span class="tok-na">sum</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">)</span>

<span class="tok-mi">10</span>
<span class="tok-mi">7</span>
<span class="tok-mi">6</span>
<span class="tok-mi">9</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mathconvert">3.29.3. Converting feet to meters</h4>
<div class="paragraph">
<p>The length of the longest runway at each airport in the graph is stored as units of
feet. We can use a simple <em>math</em> step to convert that value to meters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'longest'</span><span class="tok-o">).</span><span class="tok-na">math</span><span class="tok-o">(</span><span class="tok-s1">'_ * 0.3048'</span><span class="tok-o">)</span>

<span class="tok-mf">4084.6248</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could make the result a bit more interesting by adding a <em>project</em> step to the
query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span>
      <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'Longest runway at'</span><span class="tok-o">,</span><span class="tok-s1">'feet'</span><span class="tok-o">,</span><span class="tok-s1">'meters'</span><span class="tok-o">).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'longest'</span><span class="tok-o">).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'longest'</span><span class="tok-o">).</span><span class="tok-na">math</span><span class="tok-o">(</span><span class="tok-s1">'_ * 0.3048'</span><span class="tok-o">))</span>

<span class="tok-o">[</span><span class="tok-n">Longest</span> <span class="tok-n">runway</span> <span class="tok-nl">at:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">feet:</span><span class="tok-mi">13401</span><span class="tok-o">,</span><span class="tok-nl">meters:</span><span class="tok-mf">4084.6248</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mathtrig">3.29.4. Using the trigonometric functions</h4>
<div class="paragraph">
<p>The trigonometric operators work as you would expect. All angles need to be specified
as radians and not degrees. You can do the conversion to radians yourself or use the
Java <em>Math.toRadians</em> helper method if you prefer. The query below uses the <em>math</em>
step to calculate the sine of 60 degrees and stores the result in a variable called
<em>"x"</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Calculate the sine of 60 degrees</span>
<span class="tok-n">x</span><span class="tok-o">=</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">inject</span><span class="tok-o">(</span><span class="tok-mi">60</span><span class="tok-o">*(</span><span class="tok-n">Math</span><span class="tok-o">.</span><span class="tok-na">PI</span><span class="tok-o">/</span><span class="tok-mi">180</span><span class="tok-o">)).</span><span class="tok-na">math</span><span class="tok-o">(</span><span class="tok-s1">'sin(_)'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span>

<span class="tok-mf">0.8660254037844386</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use our variable <em>"x"</em> to calculate the arcsine.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Calculate the arcsine</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">inject</span><span class="tok-o">(</span><span class="tok-n">x</span><span class="tok-o">).</span><span class="tok-na">math</span><span class="tok-o">(</span><span class="tok-s1">'asin(_)'</span><span class="tok-o">)</span>

<span class="tok-mf">1.0471975511965976</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use the Gremlin console as a calculator to prove that we got the correct
answer back.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Prove this is the right answer</span>
<span class="tok-n">Math</span><span class="tok-o">.</span><span class="tok-na">toRadians</span><span class="tok-o">(</span><span class="tok-mi">60</span><span class="tok-o">)</span>

<span class="tok-mf">1.0471975511965976</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that just as when using the Java Math library you have to be aware of possible
rounding errors. You would expect the calculation below to return 1.0 but it does not
as the conversion of 45 degrees to radians is not precise enough for the Math
library. Note that using the Java <em>Math.toRadians</em> method does not achieve the
desired result either.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Manual conversion</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">inject</span><span class="tok-o">(</span><span class="tok-mi">45</span><span class="tok-o">*(</span><span class="tok-n">Math</span><span class="tok-o">.</span><span class="tok-na">PI</span><span class="tok-o">/</span><span class="tok-mi">180</span><span class="tok-o">)).</span><span class="tok-na">math</span><span class="tok-o">(</span><span class="tok-s1">'tan(_)'</span><span class="tok-o">)</span>

<span class="tok-mf">0.9999999999999999</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Same experiment but using the helper method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Libraray conversion</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">inject</span><span class="tok-o">(</span><span class="tok-n">Math</span><span class="tok-o">.</span><span class="tok-na">toRadians</span><span class="tok-o">(</span><span class="tok-mi">45</span><span class="tok-o">)).</span><span class="tok-na">math</span><span class="tok-o">(</span><span class="tok-s1">'tan(_)'</span><span class="tok-o">)</span>

<span class="tok-mf">0.9999999999999999</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This presents us with a chance to experiment with another of the operators that the
<em>math</em> step provides. We can use the <em>ceil</em> operator to round our result up to the
nearest integer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">inject</span><span class="tok-o">(</span><span class="tok-n">Math</span><span class="tok-o">.</span><span class="tok-na">toRadians</span><span class="tok-o">(</span><span class="tok-mi">45</span><span class="tok-o">)).</span><span class="tok-na">math</span><span class="tok-o">(</span><span class="tok-s1">'tan(_)'</span><span class="tok-o">).</span><span class="tok-na">math</span><span class="tok-o">(</span><span class="tok-s1">'ceil(_)'</span><span class="tok-o">)</span>

<span class="tok-mf">1.0</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mathsignum">3.29.5. Using signum to make a choice</h4>
<div class="paragraph">
<p>The <em>signum</em> operator allows us to make a decision depending upon whether a numeric
value is positive, negative or zero as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">inject</span><span class="tok-o">(-</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">math</span><span class="tok-o">(</span><span class="tok-s1">'signum(_)'</span><span class="tok-o">)</span>
<span class="tok-o">-</span><span class="tok-mf">1.0</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">inject</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">math</span><span class="tok-o">(</span><span class="tok-s1">'signum(_)'</span><span class="tok-o">)</span>
<span class="tok-mf">1.0</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">inject</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">).</span><span class="tok-na">math</span><span class="tok-o">(</span><span class="tok-s1">'signum(_)'</span><span class="tok-o">)</span>
<span class="tok-mf">0.0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use this capability to build a query that reports which side of
the Greenwich meridian an airport is located. Note that I had to use the <em>"D"</em>
suffix on the numbers in the <em>option</em> steps as <em>math</em> returns a double precision
result.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">sample</span><span class="tok-o">(</span><span class="tok-mi">12</span><span class="tok-o">).</span>
      <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'IATA'</span><span class="tok-o">,</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'position'</span><span class="tok-o">).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">choose</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">).</span><span class="tok-na">math</span><span class="tok-o">(</span><span class="tok-s1">'signum(_)'</span><span class="tok-o">)).</span>
          <span class="tok-n">option</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-n">D</span><span class="tok-o">,</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'on the meridian'</span><span class="tok-o">)).</span>
          <span class="tok-n">option</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-n">D</span><span class="tok-o">,</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'East'</span><span class="tok-o">)).</span>
          <span class="tok-n">option</span><span class="tok-o">(-</span><span class="tok-mi">1</span><span class="tok-n">D</span><span class="tok-o">,</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'West'</span><span class="tok-o">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example of the output from running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">IATA:</span><span class="tok-n">LGW</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">London</span><span class="tok-o">,</span><span class="tok-nl">position:</span><span class="tok-n">West</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">IATA:</span><span class="tok-n">STN</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">London</span><span class="tok-o">,</span><span class="tok-nl">position:</span><span class="tok-n">East</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">IATA:</span><span class="tok-n">LIM</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Lima</span><span class="tok-o">,</span><span class="tok-nl">position:</span><span class="tok-n">West</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">IATA:</span><span class="tok-n">SYD</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Sydney</span><span class="tok-o">,</span><span class="tok-nl">position:</span><span class="tok-n">East</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">IATA:</span><span class="tok-n">VCE</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Venice</span><span class="tok-o">,</span><span class="tok-nl">position:</span><span class="tok-n">East</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">IATA:</span><span class="tok-n">FCO</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Rome</span><span class="tok-o">,</span><span class="tok-nl">position:</span><span class="tok-n">East</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">IATA:</span><span class="tok-n">OAK</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Oakland</span><span class="tok-o">,</span><span class="tok-nl">position:</span><span class="tok-n">West</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">IATA:</span><span class="tok-n">GVA</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Geneva</span><span class="tok-o">,</span><span class="tok-nl">position:</span><span class="tok-n">East</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">IATA:</span><span class="tok-n">LAS</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Las</span> <span class="tok-n">Vegas</span><span class="tok-o">,</span><span class="tok-nl">position:</span><span class="tok-n">West</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">IATA:</span><span class="tok-n">NRT</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Tokyo</span><span class="tok-o">,</span><span class="tok-nl">position:</span><span class="tok-n">East</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">IATA:</span><span class="tok-n">DME</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Moscow</span><span class="tok-o">,</span><span class="tok-nl">position:</span><span class="tok-n">East</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">IATA:</span><span class="tok-n">ALC</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Alicante</span><span class="tok-o">,</span><span class="tok-nl">position:</span><span class="tok-n">West</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="stddev">3.29.6. Calculating a standard deviation</h4>
<div class="paragraph">
<p>We could use the new <em>math</em> step to implement a query that calculates the standard
deviation for the number of runways each airport in the graph has. This allows us to
see use of the <em>sqrt</em> and power (^) operators. I broke the solution into three
queries rather than try to force it all into one. Even now the final query of the
three is complicated enough I think! Notice how multiple <em>math</em> steps are used in the
same query with the results from one being used as input to the next.</p>
</div>
<div class="paragraph">
<p>First of all let’s calculate the mean (or average) number of runways in the graph.
Not surprisingly this number is close to 1.5 as as the majority of the airports only
have one or two runways.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Average number of runways</span>
<span class="tok-n">mean</span><span class="tok-o">=</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">mean</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()</span>

<span class="tok-mf">1.4309425014819206</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We also need to know how many airports there are in the graph so that we can
calculate the variance as part of the standard deviation calculation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Total number of airports</span>
<span class="tok-n">count</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()</span>

<span class="tok-mi">3374</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we are ready to make use of the square root and power operators and calculate the
standard deviation. As a reminder, the standard deviation is found by taking the
square root of the variance in a data set. The variance itself is calculated by for
each airport subtracting the mean from the number of runways it has and squaring it
and then taking the sum of those values and finally dividing that sum by the number
of airports. Let’s write a query that can do all of that for us.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Calculate the standard deviation</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSideEffect</span><span class="tok-o">(</span><span class="tok-s2">"m"</span><span class="tok-o">,</span><span class="tok-n">mean</span><span class="tok-o">).</span>
  <span class="tok-n">withSideEffect</span><span class="tok-o">(</span><span class="tok-s2">"c"</span><span class="tok-o">,</span><span class="tok-n">count</span><span class="tok-o">).</span>
  <span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span>
  <span class="tok-n">math</span><span class="tok-o">(</span><span class="tok-s1">'(_ - m)^2'</span><span class="tok-o">).</span><span class="tok-na">sum</span><span class="tok-o">().</span><span class="tok-na">math</span><span class="tok-o">(</span><span class="tok-s1">'_ / c'</span><span class="tok-o">).</span><span class="tok-na">math</span><span class="tok-o">(</span><span class="tok-s1">'sqrt(_)'</span><span class="tok-o">)</span>

<span class="tok-mf">0.7510927827902234</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could use another query to check on the distribution of runways in the graph to
see if we believe our standard deviation result.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">:</span><span class="tok-mi">2316</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">:</span><span class="tok-mi">762</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">:</span><span class="tok-mi">225</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">:</span><span class="tok-mi">51</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">8</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Looking at the distribution, where a large majority of the airports have either one
or two runways, our result looks pretty reasonable. Clearly the few airports with six,
seven or eight runways are the outliers in this sample and would fall well outside of
the standard deviation from the mean that we calculated.</p>
</div>
<div class="paragraph">
<p>Just for fun, let’s use the same basic set of steps once again but this time to find
the standard deviation for the number of outgoing routes in the graph.</p>
</div>
<div class="paragraph">
<p>As before we need to find the mean value for the data set. This time we need to find
the average number of outgoing routes in the graph. The airport count remains the
same of course.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">mean</span><span class="tok-o">=</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">local</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">mean</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()</span>

<span class="tok-mf">12.863070539419088</span>

<span class="tok-n">count</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()</span>

<span class="tok-mi">3374</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we are ready to again calculate the standard deviation for the data set
representing all outgoing routes per airport.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSideEffect</span><span class="tok-o">(</span><span class="tok-s2">"m"</span><span class="tok-o">,</span><span class="tok-n">mean</span><span class="tok-o">).</span>
  <span class="tok-n">withSideEffect</span><span class="tok-o">(</span><span class="tok-s2">"c"</span><span class="tok-o">,</span><span class="tok-n">count</span><span class="tok-o">).</span>
  <span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">local</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span>
  <span class="tok-n">math</span><span class="tok-o">(</span><span class="tok-s1">'(_ - m)^2'</span><span class="tok-o">).</span><span class="tok-na">sum</span><span class="tok-o">().</span><span class="tok-na">math</span><span class="tok-o">(</span><span class="tok-s1">'_ / c'</span><span class="tok-o">).</span><span class="tok-na">math</span><span class="tok-o">(</span><span class="tok-s1">'sqrt(_)'</span><span class="tok-o">)</span>

<span class="tok-mf">28.356862649682018</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This time we got a much bigger number back as the result compared to when we looked
at runways. This reflects the differing distribution of routes between major and more
minor airports.</p>
</div>
</div>
<div class="sect3">
<h4 id="stddevone">3.29.7. Calculating a standard deviation in one query</h4>
<div class="paragraph">
<p>In the previous section the steps to calculate the standard deviation were broken up
into three graph queries. It is possible to perform the entire task in a single
query as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span>
      <span class="tok-n">mean</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'mean'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">().</span>
      <span class="tok-n">math</span><span class="tok-o">(</span><span class="tok-s1">'(_-mean)^2'</span><span class="tok-o">).</span><span class="tok-na">mean</span><span class="tok-o">().</span><span class="tok-na">math</span><span class="tok-o">(</span><span class="tok-s1">'sqrt(_)'</span><span class="tok-o">)</span>

<span class="tok-mf">0.7510927827902234</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using this approach means that we can avoid making multiple round trips to the graph
to generate the values we need. The query is not really a lot more complex either.
Which technique you find more convenient may come down to personal preference. Making
multiple queries in general is not always a bad thing but in this case using a single
query I think makes sense as it does not add much additional complexity to the steps
involved.</p>
</div>
</div>
<div class="sect3">
<h4 id="mathproject">3.29.8. Using <em>project</em> to feed values to <em>math</em></h4>
<div class="paragraph">
<p>The <em>project</em> step can be used to create a map of key/value pairs that can in turn be
passed to a <em>math</em> step. First of all let’s create a query that generates a simple
projection containing the number of incoming and outgoing routes at the Austin
airport.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'in'</span><span class="tok-o">,</span><span class="tok-s1">'out'</span><span class="tok-o">).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">in</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">())</span>

<span class="tok-o">[</span><span class="tok-k">in</span><span class="tok-o">:</span><span class="tok-mi">59</span><span class="tok-o">,</span><span class="tok-nl">out:</span><span class="tok-mi">59</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now add a <em>math</em> step that uses the key names from the map created by the
<em>project</em> step and adds their values together.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'in'</span><span class="tok-o">,</span><span class="tok-s1">'out'</span><span class="tok-o">).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">in</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()).</span>
      <span class="tok-n">math</span><span class="tok-o">(</span><span class="tok-s1">'in + out'</span><span class="tok-o">)</span>

<span class="tok-mf">118.0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are obviously many other operators that I have not provided examples for but
hopefully the ones I have provided give you a feel for ways that the <em>math</em> step can
be used to create interesting queries.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="withindex">3.30. Including an index with results - introducing <em>withIndex</em> and <em>indexed</em></h3>
<div class="paragraph">
<p>If for any reason you wanted an index value included as part of the results from a
query you can use the Groovy <em>withIndex</em> or <em>indexed</em> methods as shown below.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As covered in the next section, a native Gremlin <em>index</em> step was introduced in
the Apache TinkerPop 3.4 release.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The <em>withIndex</em> method adds the index value at the end of a list whereas the
<em>indexed</em> method adds it at the start. You can provide a starting index value as a
parameter. If no value is provided the default value for the first index will be
zero.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-OK'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">withIndex</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">OKC</span><span class="tok-o">,</span><span class="tok-mi">0</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">TUL</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LAW</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SWO</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note that <em>indexed</em> and <em>withIndex</em> are Groovy methods and not Gremlin
traversal steps. They will only work using graph databases that allow Groovy code to
be included as part of a query.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Here is the same query as before but using 1 as the starting index.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-OK'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">withIndex</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">OKC</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">TUL</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LAW</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SWO</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Below is the query used again but this time with the <em>indexed</em> method being used to
generate the index value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-OK'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">indexed</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">OKC</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-n">TUL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-n">LAW</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-n">SWO</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="tp34index">3.30.1. The new <em>index</em> step added in TinkerPop 3.4</h4>
<div class="paragraph">
<p>Apache TinkerPop version 3.4, released at the start of 2019, added a native <em>index</em>
step to the Gremlin language. A new <em>with</em> modulator was also added that can be used
to control how the index step behaves. Unlike the native <em>Groovy</em> methods, there is
no way to specify the starting value for the index range.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The official Apache TinkerPop documentation for the <em>index</em> step can be found at
the following link <a href="http://tinkerpop.apache.org/docs/current/reference/#index-step" class="bare">http://tinkerpop.apache.org/docs/current/reference/#index-step</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The use of <em>index</em> only really makes sense in the context of a collection such as a
<em>list</em> or a <em>map</em>. As shown below, without a <em>fold</em> step in the query, the result set
will consist of a number of individual lists all with an index of zero.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">index</span><span class="tok-o">()</span>

<span class="tok-o">[[</span><span class="tok-n">HKG</span><span class="tok-o">,</span><span class="tok-mi">0</span><span class="tok-o">]]</span>
<span class="tok-o">[[</span><span class="tok-n">PEK</span><span class="tok-o">,</span><span class="tok-mi">0</span><span class="tok-o">]]</span>
<span class="tok-o">[[</span><span class="tok-n">PVG</span><span class="tok-o">,</span><span class="tok-mi">0</span><span class="tok-o">]]</span>
<span class="tok-o">[[</span><span class="tok-n">FCO</span><span class="tok-o">,</span><span class="tok-mi">0</span><span class="tok-o">]]</span>
<span class="tok-o">[[</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-mi">0</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we had a <em>fold</em> step before calling <em>index</em> however, the results will be indexed
in increments of one, starting at zero.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">().</span><span class="tok-na">index</span><span class="tok-o">()</span>

<span class="tok-o">[[</span><span class="tok-n">HKG</span><span class="tok-o">,</span><span class="tok-mi">0</span><span class="tok-o">],[</span><span class="tok-n">PEK</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">],[</span><span class="tok-n">PVG</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">],[</span><span class="tok-n">FCO</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">],[</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Adding an <em>unfold</em> step will yield a set of individual lists with each containing an
airport code and its index.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">().</span><span class="tok-na">index</span><span class="tok-o">().</span>
      <span class="tok-n">unfold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">HKG</span><span class="tok-o">,</span><span class="tok-mi">0</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">PEK</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">PVG</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">FCO</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The new <em>with</em> modulator can be used to control the type of collection that <em>index</em>
produces. To have the result returned as a map where the key is the index value the
query can be modified as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">().</span>
      <span class="tok-n">index</span><span class="tok-o">().</span><span class="tok-na">with</span><span class="tok-o">(</span><span class="tok-n">WithOptions</span><span class="tok-o">.</span><span class="tok-na">indexer</span><span class="tok-o">,</span><span class="tok-n">WithOptions</span><span class="tok-o">.</span><span class="tok-na">map</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">:</span><span class="tok-n">HKG</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">:</span><span class="tok-n">PEK</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">:</span><span class="tok-n">PVG</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">:</span><span class="tok-n">FCO</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">:</span><span class="tok-n">BOM</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally the example below shows a <em>with</em> step being used to ask for results as a list
which is the default. The results are then sorted in reverse order.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
All of the possible values that can be specified using WithOptions can be found
in the official Apache TinkerPop JavaDoc documentation
<a href="http://tinkerpop.apache.org/javadocs/current/full/org/apache/tinkerpop/gremlin/process/traversal/step/util/WithOptions.html">at
this location</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Note that this query uses <em>desc</em> rather than the now deprecated <em>decr</em> to ask for
descending order results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">().</span>
      <span class="tok-n">index</span><span class="tok-o">().</span><span class="tok-na">with</span><span class="tok-o">(</span><span class="tok-n">WithOptions</span><span class="tok-o">.</span><span class="tok-na">indexer</span><span class="tok-o">,</span><span class="tok-n">WithOptions</span><span class="tok-o">.</span><span class="tok-na">list</span><span class="tok-o">).</span>
      <span class="tok-n">unfold</span><span class="tok-o">().</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">tail</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">),</span><span class="tok-n">desc</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">FCO</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">PVG</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">PEK</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">HKG</span><span class="tok-o">,</span><span class="tok-mi">0</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="index-reverse">3.30.2. Using <em>index</em> to reverse a list</h4>
<div class="paragraph">
<p>The Gremlin query language does not have a built in step or function that can be used
to reverse the contents of a list or other collection. However, this can be achieved
using the <em>index</em> step. The example below takes advantage of the index step to give
each element of a list an index number.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">inject</span><span class="tok-o">([</span><span class="tok-s1">'A'</span><span class="tok-o">,</span><span class="tok-s1">'B'</span><span class="tok-o">,</span><span class="tok-s1">'C'</span><span class="tok-o">,</span><span class="tok-s1">'D'</span><span class="tok-o">]).</span><span class="tok-na">index</span><span class="tok-o">()</span>

<span class="tok-o">[[</span><span class="tok-n">A</span><span class="tok-o">,</span><span class="tok-mi">0</span><span class="tok-o">],[</span><span class="tok-n">B</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">],[</span><span class="tok-n">C</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">],[</span><span class="tok-n">D</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Given that building block, we can use those index values to order the list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">inject</span><span class="tok-o">([</span><span class="tok-s1">'A'</span><span class="tok-o">,</span><span class="tok-s1">'B'</span><span class="tok-o">,</span><span class="tok-s1">'C'</span><span class="tok-o">,</span><span class="tok-s1">'D'</span><span class="tok-o">]).</span><span class="tok-na">index</span><span class="tok-o">().</span>
  <span class="tok-n">unfold</span><span class="tok-o">().</span>
  <span class="tok-n">order</span><span class="tok-o">().</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">tail</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">),</span><span class="tok-n">desc</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">D</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">C</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">B</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">A</span><span class="tok-o">,</span><span class="tok-mi">0</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The query can be further refined so that the index values are not part of the result.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">inject</span><span class="tok-o">([</span><span class="tok-s1">'A'</span><span class="tok-o">,</span><span class="tok-s1">'B'</span><span class="tok-o">,</span><span class="tok-s1">'C'</span><span class="tok-o">,</span><span class="tok-s1">'D'</span><span class="tok-o">]).</span><span class="tok-na">index</span><span class="tok-o">().</span>
  <span class="tok-n">unfold</span><span class="tok-o">().</span>
  <span class="tok-n">order</span><span class="tok-o">().</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">tail</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">),</span><span class="tok-n">desc</span><span class="tok-o">).</span>
  <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">).</span>
  <span class="tok-n">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">D</span><span class="tok-o">,</span><span class="tok-n">C</span><span class="tok-o">,</span><span class="tok-n">B</span><span class="tok-o">,</span><span class="tok-n">A</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The same technique can be used with any collection generated as part of a query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">().</span><span class="tok-na">index</span><span class="tok-o">()</span>

<span class="tok-o">[[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">0</span><span class="tok-o">],[</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">],[</span><span class="tok-n">PHX</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">],[</span><span class="tok-n">DEN</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once again we can order the results using the index values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span>
  <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span>
  <span class="tok-n">out</span><span class="tok-o">().</span>
  <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
  <span class="tok-n">fold</span><span class="tok-o">().</span>
  <span class="tok-n">index</span><span class="tok-o">().</span>
  <span class="tok-n">unfold</span><span class="tok-o">().</span>
  <span class="tok-n">order</span><span class="tok-o">().</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">tail</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">),</span><span class="tok-n">desc</span><span class="tok-o">).</span>
  <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">).</span>
  <span class="tok-n">fold</span><span class="tok-o">()</span>

  <span class="tok-o">[</span><span class="tok-n">DEN</span><span class="tok-o">,</span><span class="tok-n">PHX</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sx">3.31. More examples using concepts we have covered so far</h3>
<div class="paragraph">
<p>The examples in this section build upon the topics that we have covered so far. The
query below finds cities that can be flown to from any airport in the Hawaiian
islands.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Which cities can I fly to from any airport in the Hawaiian islands?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-HI'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we run the query we would get back results similar to those below. Only a few of the
full result set are shown.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">Honolulu</span><span class="tok-o">,</span><span class="tok-n">San</span> <span class="tok-n">Francisco</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">Honolulu</span><span class="tok-o">,</span><span class="tok-n">Osaka</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">Honolulu</span><span class="tok-o">,</span><span class="tok-n">San</span> <span class="tok-n">Diego</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">Honolulu</span><span class="tok-o">,</span><span class="tok-n">Sapporo</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">Honolulu</span><span class="tok-o">,</span><span class="tok-n">Las</span> <span class="tok-n">Vegas</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">Honolulu</span><span class="tok-o">,</span><span class="tok-n">Sacramento</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">Honolulu</span><span class="tok-o">,</span><span class="tok-n">Denver</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">Kahului</span><span class="tok-o">,</span><span class="tok-n">Portland</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">Kahului</span><span class="tok-o">,</span><span class="tok-n">Sacramento</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">Kahului</span><span class="tok-o">,</span><span class="tok-n">Lahaina</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">Lihue</span><span class="tok-o">,</span><span class="tok-n">Oakland</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">Lihue</span><span class="tok-o">,</span><span class="tok-n">Vancouver</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">Lihue</span><span class="tok-o">,</span><span class="tok-n">Seattle</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">Lihue</span><span class="tok-o">,</span><span class="tok-n">San</span> <span class="tok-n">Francisco</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The query below looks for airports in Europe using the continent vertex with a code of
<em>EU</em> as the starting point. The results are sorted in ascending order and folded
into a list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Find all the airports that are in Europe (The graph stores continent information</span>
<span class="tok-c1">// as "contains" edges connected from a "continent" vertex to each airport vertex.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'continent'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'EU'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">(</span><span class="tok-s1">'contains'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">fold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is what we get back from running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AAL</span><span class="tok-o">,</span><span class="tok-n">AAQ</span><span class="tok-o">,</span><span class="tok-n">AAR</span><span class="tok-o">,</span><span class="tok-n">ABZ</span><span class="tok-o">,</span><span class="tok-n">ACE</span><span class="tok-o">,</span><span class="tok-n">ACH</span><span class="tok-o">,</span><span class="tok-n">ACI</span><span class="tok-o">,</span><span class="tok-n">AER</span><span class="tok-o">,</span><span class="tok-n">AES</span><span class="tok-o">,</span><span class="tok-n">AEY</span><span class="tok-o">,</span><span class="tok-n">AGB</span><span class="tok-o">,</span><span class="tok-n">AGF</span><span class="tok-o">,</span><span class="tok-n">AGH</span><span class="tok-o">,</span><span class="tok-n">AGP</span><span class="tok-o">,</span><span class="tok-n">AHO</span><span class="tok-o">,</span><span class="tok-n">AJA</span><span class="tok-o">,</span><span class="tok-n">AJR</span><span class="tok-o">,</span><span class="tok-n">ALC</span><span class="tok-o">,</span><span class="tok-n">ALF</span><span class="tok-o">,</span><span class="tok-n">AMS</span><span class="tok-o">,</span><span class="tok-n">ANE</span><span class="tok-o">,</span><span class="tok-n">ANG</span><span class="tok-o">,</span><span class="tok-n">ANR</span><span class="tok-o">,</span><span class="tok-n">ANX</span><span class="tok-o">,</span><span class="tok-n">AOI</span><span class="tok-o">,</span><span class="tok-n">AOK</span><span class="tok-o">,</span><span class="tok-n">ARH</span><span class="tok-o">,</span><span class="tok-n">ARN</span><span class="tok-o">,</span><span class="tok-n">ARW</span><span class="tok-o">,</span><span class="tok-n">ASF</span><span class="tok-o">,</span><span class="tok-n">ATH</span><span class="tok-o">,</span><span class="tok-n">AUR</span><span class="tok-o">,</span><span class="tok-n">AVN</span><span class="tok-o">,</span><span class="tok-n">AXD</span><span class="tok-o">,</span><span class="tok-n">BAY</span><span class="tok-o">,</span><span class="tok-n">BCM</span><span class="tok-o">,</span><span class="tok-n">BCN</span><span class="tok-o">,</span><span class="tok-n">BDS</span><span class="tok-o">,</span><span class="tok-n">BDU</span><span class="tok-o">,</span><span class="tok-n">BEB</span><span class="tok-o">,</span><span class="tok-n">BEG</span><span class="tok-o">,</span><span class="tok-n">BES</span><span class="tok-o">,</span><span class="tok-n">BFS</span><span class="tok-o">,</span><span class="tok-n">BGO</span><span class="tok-o">,</span><span class="tok-n">BGY</span><span class="tok-o">,</span><span class="tok-n">BHD</span><span class="tok-o">,</span><span class="tok-n">BHX</span><span class="tok-o">,</span><span class="tok-n">BIA</span><span class="tok-o">,</span><span class="tok-n">BIO</span><span class="tok-o">,</span><span class="tok-n">BIQ</span><span class="tok-o">,</span><span class="tok-n">BJF</span><span class="tok-o">,</span><span class="tok-n">BJZ</span><span class="tok-o">,</span><span class="tok-n">BLE</span><span class="tok-o">,</span><span class="tok-n">BLK</span><span class="tok-o">,</span><span class="tok-n">BLL</span><span class="tok-o">,</span><span class="tok-n">BLQ</span><span class="tok-o">,</span><span class="tok-n">BMA</span><span class="tok-o">,</span><span class="tok-n">BNN</span><span class="tok-o">,</span><span class="tok-n">BNX</span><span class="tok-o">,</span><span class="tok-n">BOD</span><span class="tok-o">,</span><span class="tok-n">BOH</span><span class="tok-o">,</span><span class="tok-n">BOJ</span><span class="tok-o">,</span><span class="tok-n">BOO</span><span class="tok-o">,</span><span class="tok-n">BRE</span><span class="tok-o">,</span><span class="tok-n">BRI</span><span class="tok-o">,</span><span class="tok-n">BRN</span><span class="tok-o">,</span><span class="tok-n">BRQ</span><span class="tok-o">,</span><span class="tok-n">BRR</span><span class="tok-o">,</span><span class="tok-n">BRS</span><span class="tok-o">,</span><span class="tok-n">BRU</span><span class="tok-o">,</span><span class="tok-n">BSL</span><span class="tok-o">,</span><span class="tok-n">BTS</span><span class="tok-o">,</span><span class="tok-n">BUD</span><span class="tok-o">,</span><span class="tok-n">BVA</span><span class="tok-o">,</span><span class="tok-n">BVE</span><span class="tok-o">,</span><span class="tok-n">BVG</span><span class="tok-o">,</span><span class="tok-n">BWK</span><span class="tok-o">,</span><span class="tok-n">BZG</span><span class="tok-o">,</span><span class="tok-n">BZK</span><span class="tok-o">,</span><span class="tok-n">BZO</span><span class="tok-o">,</span><span class="tok-n">BZR</span><span class="tok-o">,</span><span class="tok-n">BZZ</span><span class="tok-o">,</span><span class="tok-n">CAG</span><span class="tok-o">,</span><span class="tok-n">CAL</span><span class="tok-o">,</span><span class="tok-n">CCF</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">,</span><span class="tok-n">CDT</span><span class="tok-o">,</span><span class="tok-n">CEE</span><span class="tok-o">,</span><span class="tok-n">CEG</span><span class="tok-o">,</span><span class="tok-n">CFE</span><span class="tok-o">,</span><span class="tok-n">CFN</span><span class="tok-o">,</span><span class="tok-n">CFR</span><span class="tok-o">,</span><span class="tok-n">CFU</span><span class="tok-o">,</span><span class="tok-n">CGN</span><span class="tok-o">,</span><span class="tok-n">CHQ</span><span class="tok-o">,</span><span class="tok-n">CIA</span><span class="tok-o">,</span><span class="tok-n">CIY</span><span class="tok-o">,</span><span class="tok-n">CLJ</span><span class="tok-o">,</span><span class="tok-n">CLY</span><span class="tok-o">,</span><span class="tok-n">CMF</span><span class="tok-o">,</span><span class="tok-n">CND</span><span class="tok-o">,</span><span class="tok-n">CPH</span><span class="tok-o">,</span><span class="tok-n">CRA</span><span class="tok-o">,</span><span class="tok-n">CRL</span><span class="tok-o">,</span><span class="tok-n">CSH</span><span class="tok-o">,</span><span class="tok-n">CSY</span><span class="tok-o">,</span><span class="tok-n">CTA</span><span class="tok-o">,</span><span class="tok-n">CUF</span><span class="tok-o">,</span><span class="tok-n">CVT</span><span class="tok-o">,</span><span class="tok-n">CVU</span><span class="tok-o">,</span><span class="tok-n">CWC</span><span class="tok-o">,</span><span class="tok-n">CWL</span><span class="tok-o">,</span><span class="tok-n">DBV</span><span class="tok-o">,</span><span class="tok-n">DCM</span><span class="tok-o">,</span><span class="tok-n">DEB</span><span class="tok-o">,</span><span class="tok-n">DIJ</span><span class="tok-o">,</span><span class="tok-n">DLE</span><span class="tok-o">,</span><span class="tok-n">DME</span><span class="tok-o">,</span><span class="tok-n">DND</span><span class="tok-o">,</span><span class="tok-n">DNK</span><span class="tok-o">,</span><span class="tok-n">DNR</span><span class="tok-o">,</span><span class="tok-n">DOK</span><span class="tok-o">,</span><span class="tok-n">DOL</span><span class="tok-o">,</span><span class="tok-n">DRS</span><span class="tok-o">,</span><span class="tok-n">DSA</span><span class="tok-o">,</span><span class="tok-n">DTM</span><span class="tok-o">,</span><span class="tok-n">DUB</span><span class="tok-o">,</span><span class="tok-n">DUS</span><span class="tok-o">,</span><span class="tok-n">EAS</span><span class="tok-o">,</span><span class="tok-n">EBA</span><span class="tok-o">,</span><span class="tok-n">EBJ</span><span class="tok-o">,</span><span class="tok-n">EBU</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">,</span><span class="tok-n">EFL</span><span class="tok-o">,</span><span class="tok-n">EGC</span><span class="tok-o">,</span><span class="tok-n">EGO</span><span class="tok-o">,</span><span class="tok-n">EGS</span><span class="tok-o">,</span><span class="tok-n">EIN</span><span class="tok-o">,</span><span class="tok-n">EMA</span><span class="tok-o">,</span><span class="tok-n">ENF</span><span class="tok-o">,</span><span class="tok-n">EOI</span><span class="tok-o">,</span><span class="tok-n">ERF</span><span class="tok-o">,</span><span class="tok-n">ESL</span><span class="tok-o">,</span><span class="tok-n">ETZ</span><span class="tok-o">,</span><span class="tok-n">EVE</span><span class="tok-o">,</span><span class="tok-n">EVG</span><span class="tok-o">,</span><span class="tok-n">EXT</span><span class="tok-o">,</span><span class="tok-n">FAE</span><span class="tok-o">,</span><span class="tok-n">FAO</span><span class="tok-o">,</span><span class="tok-n">FCO</span><span class="tok-o">,</span><span class="tok-n">FDE</span><span class="tok-o">,</span><span class="tok-n">FDH</span><span class="tok-o">,</span><span class="tok-n">FIE</span><span class="tok-o">,</span><span class="tok-n">FKB</span><span class="tok-o">,</span><span class="tok-n">FLR</span><span class="tok-o">,</span><span class="tok-n">FLW</span><span class="tok-o">,</span><span class="tok-n">FMM</span><span class="tok-o">,</span><span class="tok-n">FMO</span><span class="tok-o">,</span><span class="tok-n">FNC</span><span class="tok-o">,</span><span class="tok-n">FNI</span><span class="tok-o">,</span><span class="tok-n">FOA</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-n">FRO</span><span class="tok-o">,</span><span class="tok-n">FSC</span><span class="tok-o">,</span><span class="tok-n">FUE</span><span class="tok-o">,</span><span class="tok-n">GCI</span><span class="tok-o">,</span><span class="tok-n">GDN</span><span class="tok-o">,</span><span class="tok-n">GDZ</span><span class="tok-o">,</span><span class="tok-n">GEV</span><span class="tok-o">,</span><span class="tok-n">GIB</span><span class="tok-o">,</span><span class="tok-n">GLA</span><span class="tok-o">,</span><span class="tok-n">GLO</span><span class="tok-o">,</span><span class="tok-n">GMZ</span><span class="tok-o">,</span><span class="tok-n">GNB</span><span class="tok-o">,</span><span class="tok-n">GOA</span><span class="tok-o">,</span><span class="tok-n">GOJ</span><span class="tok-o">,</span><span class="tok-n">GOT</span><span class="tok-o">,</span><span class="tok-n">GPA</span><span class="tok-o">,</span><span class="tok-n">GRO</span><span class="tok-o">,</span><span class="tok-n">GRQ</span><span class="tok-o">,</span><span class="tok-n">GRV</span><span class="tok-o">,</span><span class="tok-n">GRW</span><span class="tok-o">,</span><span class="tok-n">GRX</span><span class="tok-o">,</span><span class="tok-n">GRZ</span><span class="tok-o">,</span><span class="tok-n">GSE</span><span class="tok-o">,</span><span class="tok-n">GVA</span><span class="tok-o">,</span><span class="tok-n">GWT</span><span class="tok-o">,</span><span class="tok-n">HAA</span><span class="tok-o">,</span><span class="tok-n">HAD</span><span class="tok-o">,</span><span class="tok-n">HAJ</span><span class="tok-o">,</span><span class="tok-n">HAM</span><span class="tok-o">,</span><span class="tok-n">HAU</span><span class="tok-o">,</span><span class="tok-n">HDF</span><span class="tok-o">,</span><span class="tok-n">HEL</span><span class="tok-o">,</span><span class="tok-n">HER</span><span class="tok-o">,</span><span class="tok-n">HFS</span><span class="tok-o">,</span><span class="tok-n">HFT</span><span class="tok-o">,</span><span class="tok-n">HHN</span><span class="tok-o">,</span><span class="tok-n">HMV</span><span class="tok-o">,</span><span class="tok-n">HOR</span><span class="tok-o">,</span><span class="tok-n">HOV</span><span class="tok-o">,</span><span class="tok-n">HRK</span><span class="tok-o">,</span><span class="tok-n">HUY</span><span class="tok-o">,</span><span class="tok-n">IAR</span><span class="tok-o">,</span><span class="tok-n">IAS</span><span class="tok-o">,</span><span class="tok-n">IBZ</span><span class="tok-o">,</span><span class="tok-n">IEV</span><span class="tok-o">,</span><span class="tok-n">IFJ</span><span class="tok-o">,</span><span class="tok-n">IFO</span><span class="tok-o">,</span><span class="tok-n">IJK</span><span class="tok-o">,</span><span class="tok-n">ILD</span><span class="tok-o">,</span><span class="tok-n">ILY</span><span class="tok-o">,</span><span class="tok-n">INI</span><span class="tok-o">,</span><span class="tok-n">INN</span><span class="tok-o">,</span><span class="tok-n">INV</span><span class="tok-o">,</span><span class="tok-n">IOA</span><span class="tok-o">,</span><span class="tok-n">IOM</span><span class="tok-o">,</span><span class="tok-n">ISC</span><span class="tok-o">,</span><span class="tok-n">IST</span><span class="tok-o">,</span><span class="tok-n">IVL</span><span class="tok-o">,</span><span class="tok-n">JER</span><span class="tok-o">,</span><span class="tok-n">JIK</span><span class="tok-o">,</span><span class="tok-n">JKG</span><span class="tok-o">,</span><span class="tok-n">JKH</span><span class="tok-o">,</span><span class="tok-n">JKL</span><span class="tok-o">,</span><span class="tok-n">JMK</span><span class="tok-o">,</span><span class="tok-n">JNX</span><span class="tok-o">,</span><span class="tok-n">JOE</span><span class="tok-o">,</span><span class="tok-n">JSH</span><span class="tok-o">,</span><span class="tok-n">JSI</span><span class="tok-o">,</span><span class="tok-n">JSY</span><span class="tok-o">,</span><span class="tok-n">JTR</span><span class="tok-o">,</span><span class="tok-n">JTY</span><span class="tok-o">,</span><span class="tok-n">JYV</span><span class="tok-o">,</span><span class="tok-n">KAJ</span><span class="tok-o">,</span><span class="tok-n">KAO</span><span class="tok-o">,</span><span class="tok-n">KBP</span><span class="tok-o">,</span><span class="tok-n">KEF</span><span class="tok-o">,</span><span class="tok-n">KEM</span><span class="tok-o">,</span><span class="tok-n">KGD</span><span class="tok-o">,</span><span class="tok-n">KGS</span><span class="tok-o">,</span><span class="tok-n">KHE</span><span class="tok-o">,</span><span class="tok-n">KID</span><span class="tok-o">,</span><span class="tok-n">KIR</span><span class="tok-o">,</span><span class="tok-n">KIT</span><span class="tok-o">,</span><span class="tok-n">KIV</span><span class="tok-o">,</span><span class="tok-n">KKN</span><span class="tok-o">,</span><span class="tok-n">KLR</span><span class="tok-o">,</span><span class="tok-n">KLU</span><span class="tok-o">,</span><span class="tok-n">KLV</span><span class="tok-o">,</span><span class="tok-n">KLX</span><span class="tok-o">,</span><span class="tok-n">KOI</span><span class="tok-o">,</span><span class="tok-n">KOK</span><span class="tok-o">,</span><span class="tok-n">KRF</span><span class="tok-o">,</span><span class="tok-n">KRK</span><span class="tok-o">,</span><span class="tok-n">KRN</span><span class="tok-o">,</span><span class="tok-n">KRP</span><span class="tok-o">,</span><span class="tok-n">KRR</span><span class="tok-o">,</span><span class="tok-n">KRS</span><span class="tok-o">,</span><span class="tok-n">KSC</span><span class="tok-o">,</span><span class="tok-n">KSD</span><span class="tok-o">,</span><span class="tok-n">KSF</span><span class="tok-o">,</span><span class="tok-n">KSJ</span><span class="tok-o">,</span><span class="tok-n">KSO</span><span class="tok-o">,</span><span class="tok-n">KSU</span><span class="tok-o">,</span><span class="tok-n">KTT</span><span class="tok-o">,</span><span class="tok-n">KTW</span><span class="tok-o">,</span><span class="tok-n">KUF</span><span class="tok-o">,</span><span class="tok-n">KUN</span><span class="tok-o">,</span><span class="tok-n">KUO</span><span class="tok-o">,</span><span class="tok-n">KVA</span><span class="tok-o">,</span><span class="tok-n">KVK</span><span class="tok-o">,</span><span class="tok-n">KVX</span><span class="tok-o">,</span><span class="tok-n">KZI</span><span class="tok-o">,</span><span class="tok-n">KZN</span><span class="tok-o">,</span><span class="tok-n">KZR</span><span class="tok-o">,</span><span class="tok-n">KZS</span><span class="tok-o">,</span><span class="tok-n">LAI</span><span class="tok-o">,</span><span class="tok-n">LBA</span><span class="tok-o">,</span><span class="tok-n">LBC</span><span class="tok-o">,</span><span class="tok-n">LCG</span><span class="tok-o">,</span><span class="tok-n">LCJ</span><span class="tok-o">,</span><span class="tok-n">LCY</span><span class="tok-o">,</span><span class="tok-n">LDE</span><span class="tok-o">,</span><span class="tok-n">LDY</span><span class="tok-o">,</span><span class="tok-n">LED</span><span class="tok-o">,</span><span class="tok-n">LEH</span><span class="tok-o">,</span><span class="tok-n">LEI</span><span class="tok-o">,</span><span class="tok-n">LEJ</span><span class="tok-o">,</span><span class="tok-n">LEN</span><span class="tok-o">,</span><span class="tok-n">LEQ</span><span class="tok-o">,</span><span class="tok-n">LGG</span><span class="tok-o">,</span><span class="tok-n">LGW</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">LIG</span><span class="tok-o">,</span><span class="tok-n">LIL</span><span class="tok-o">,</span><span class="tok-n">LIN</span><span class="tok-o">,</span><span class="tok-n">LIS</span><span class="tok-o">,</span><span class="tok-n">LJU</span><span class="tok-o">,</span><span class="tok-n">LKL</span><span class="tok-o">,</span><span class="tok-n">LKN</span><span class="tok-o">,</span><span class="tok-n">LLA</span><span class="tok-o">,</span><span class="tok-n">LMP</span><span class="tok-o">,</span><span class="tok-n">LNZ</span><span class="tok-o">,</span><span class="tok-n">LPA</span><span class="tok-o">,</span><span class="tok-n">LPI</span><span class="tok-o">,</span><span class="tok-n">LPK</span><span class="tok-o">,</span><span class="tok-n">LPL</span><span class="tok-o">,</span><span class="tok-n">LPP</span><span class="tok-o">,</span><span class="tok-n">LPY</span><span class="tok-o">,</span><span class="tok-n">LRH</span><span class="tok-o">,</span><span class="tok-n">LRS</span><span class="tok-o">,</span><span class="tok-n">LRT</span><span class="tok-o">,</span><span class="tok-n">LSI</span><span class="tok-o">,</span><span class="tok-n">LTN</span><span class="tok-o">,</span><span class="tok-n">LUG</span><span class="tok-o">,</span><span class="tok-n">LUX</span><span class="tok-o">,</span><span class="tok-n">LUZ</span><span class="tok-o">,</span><span class="tok-n">LWK</span><span class="tok-o">,</span><span class="tok-n">LWO</span><span class="tok-o">,</span><span class="tok-n">LXS</span><span class="tok-o">,</span><span class="tok-n">LYC</span><span class="tok-o">,</span><span class="tok-n">LYR</span><span class="tok-o">,</span><span class="tok-n">LYS</span><span class="tok-o">,</span><span class="tok-n">MAD</span><span class="tok-o">,</span><span class="tok-n">MAH</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">MCX</span><span class="tok-o">,</span><span class="tok-n">MEH</span><span class="tok-o">,</span><span class="tok-n">MHG</span><span class="tok-o">,</span><span class="tok-n">MHQ</span><span class="tok-o">,</span><span class="tok-n">MJF</span><span class="tok-o">,</span><span class="tok-n">MJT</span><span class="tok-o">,</span><span class="tok-n">MJV</span><span class="tok-o">,</span><span class="tok-n">MLA</span><span class="tok-o">,</span><span class="tok-n">MLN</span><span class="tok-o">,</span><span class="tok-n">MLO</span><span class="tok-o">,</span><span class="tok-n">MME</span><span class="tok-o">,</span><span class="tok-n">MMK</span><span class="tok-o">,</span><span class="tok-n">MMX</span><span class="tok-o">,</span><span class="tok-n">MOL</span><span class="tok-o">,</span><span class="tok-n">MPL</span><span class="tok-o">,</span><span class="tok-n">MQF</span><span class="tok-o">,</span><span class="tok-n">MQN</span><span class="tok-o">,</span><span class="tok-n">MRS</span><span class="tok-o">,</span><span class="tok-n">MRV</span><span class="tok-o">,</span><span class="tok-n">MSQ</span><span class="tok-o">,</span><span class="tok-n">MST</span><span class="tok-o">,</span><span class="tok-n">MUC</span><span class="tok-o">,</span><span class="tok-n">MXP</span><span class="tok-o">,</span><span class="tok-n">MXX</span><span class="tok-o">,</span><span class="tok-n">NAL</span><span class="tok-o">,</span><span class="tok-n">NAP</span><span class="tok-o">,</span><span class="tok-n">NBC</span><span class="tok-o">,</span><span class="tok-n">NCE</span><span class="tok-o">,</span><span class="tok-n">NCL</span><span class="tok-o">,</span><span class="tok-n">NDY</span><span class="tok-o">,</span><span class="tok-n">NDZ</span><span class="tok-o">,</span><span class="tok-n">NNM</span><span class="tok-o">,</span><span class="tok-n">NOC</span><span class="tok-o">,</span><span class="tok-n">NQY</span><span class="tok-o">,</span><span class="tok-n">NRK</span><span class="tok-o">,</span><span class="tok-n">NRL</span><span class="tok-o">,</span><span class="tok-n">NRN</span><span class="tok-o">,</span><span class="tok-n">NTE</span><span class="tok-o">,</span><span class="tok-n">NUE</span><span class="tok-o">,</span><span class="tok-n">NVK</span><span class="tok-o">,</span><span class="tok-n">NWI</span><span class="tok-o">,</span><span class="tok-n">NYO</span><span class="tok-o">,</span><span class="tok-n">ODS</span><span class="tok-o">,</span><span class="tok-n">OER</span><span class="tok-o">,</span><span class="tok-n">OGZ</span><span class="tok-o">,</span><span class="tok-n">OLA</span><span class="tok-o">,</span><span class="tok-n">OLB</span><span class="tok-o">,</span><span class="tok-n">OMO</span><span class="tok-o">,</span><span class="tok-n">OMR</span><span class="tok-o">,</span><span class="tok-n">OPO</span><span class="tok-o">,</span><span class="tok-n">ORB</span><span class="tok-o">,</span><span class="tok-n">ORK</span><span class="tok-o">,</span><span class="tok-n">ORY</span><span class="tok-o">,</span><span class="tok-n">OSD</span><span class="tok-o">,</span><span class="tok-n">OSI</span><span class="tok-o">,</span><span class="tok-n">OSL</span><span class="tok-o">,</span><span class="tok-n">OSR</span><span class="tok-o">,</span><span class="tok-n">OST</span><span class="tok-o">,</span><span class="tok-n">OSW</span><span class="tok-o">,</span><span class="tok-n">OSY</span><span class="tok-o">,</span><span class="tok-n">OTP</span><span class="tok-o">,</span><span class="tok-n">OUL</span><span class="tok-o">,</span><span class="tok-n">OVD</span><span class="tok-o">,</span><span class="tok-n">OZH</span><span class="tok-o">,</span><span class="tok-n">PAD</span><span class="tok-o">,</span><span class="tok-n">PAS</span><span class="tok-o">,</span><span class="tok-n">PDL</span><span class="tok-o">,</span><span class="tok-n">PDV</span><span class="tok-o">,</span><span class="tok-n">PED</span><span class="tok-o">,</span><span class="tok-n">PEE</span><span class="tok-o">,</span><span class="tok-n">PEG</span><span class="tok-o">,</span><span class="tok-n">PES</span><span class="tok-o">,</span><span class="tok-n">PEZ</span><span class="tok-o">,</span><span class="tok-n">PGF</span><span class="tok-o">,</span><span class="tok-n">PGX</span><span class="tok-o">,</span><span class="tok-n">PIK</span><span class="tok-o">,</span><span class="tok-n">PIS</span><span class="tok-o">,</span><span class="tok-n">PIX</span><span class="tok-o">,</span><span class="tok-n">PJA</span><span class="tok-o">,</span><span class="tok-n">PLQ</span><span class="tok-o">,</span><span class="tok-n">PMF</span><span class="tok-o">,</span><span class="tok-n">PMI</span><span class="tok-o">,</span><span class="tok-n">PMO</span><span class="tok-o">,</span><span class="tok-n">PNA</span><span class="tok-o">,</span><span class="tok-n">PNL</span><span class="tok-o">,</span><span class="tok-n">POR</span><span class="tok-o">,</span><span class="tok-n">POZ</span><span class="tok-o">,</span><span class="tok-n">PPW</span><span class="tok-o">,</span><span class="tok-n">PRG</span><span class="tok-o">,</span><span class="tok-n">PRN</span><span class="tok-o">,</span><span class="tok-n">PSA</span><span class="tok-o">,</span><span class="tok-n">PSR</span><span class="tok-o">,</span><span class="tok-n">PSV</span><span class="tok-o">,</span><span class="tok-n">PUF</span><span class="tok-o">,</span><span class="tok-n">PUY</span><span class="tok-o">,</span><span class="tok-n">PVK</span><span class="tok-o">,</span><span class="tok-n">PXO</span><span class="tok-o">,</span><span class="tok-n">RDZ</span><span class="tok-o">,</span><span class="tok-n">REG</span><span class="tok-o">,</span><span class="tok-n">REN</span><span class="tok-o">,</span><span class="tok-n">RET</span><span class="tok-o">,</span><span class="tok-n">REU</span><span class="tok-o">,</span><span class="tok-n">RGS</span><span class="tok-o">,</span><span class="tok-n">RHO</span><span class="tok-o">,</span><span class="tok-n">RIX</span><span class="tok-o">,</span><span class="tok-n">RJK</span><span class="tok-o">,</span><span class="tok-n">RJL</span><span class="tok-o">,</span><span class="tok-n">RKV</span><span class="tok-o">,</span><span class="tok-n">RLG</span><span class="tok-o">,</span><span class="tok-n">RMI</span><span class="tok-o">,</span><span class="tok-n">RNB</span><span class="tok-o">,</span><span class="tok-n">RNN</span><span class="tok-o">,</span><span class="tok-n">RNS</span><span class="tok-o">,</span><span class="tok-n">ROV</span><span class="tok-o">,</span><span class="tok-n">RRS</span><span class="tok-o">,</span><span class="tok-n">RTM</span><span class="tok-o">,</span><span class="tok-n">RTW</span><span class="tok-o">,</span><span class="tok-n">RVK</span><span class="tok-o">,</span><span class="tok-n">RVN</span><span class="tok-o">,</span><span class="tok-n">RYG</span><span class="tok-o">,</span><span class="tok-n">RZE</span><span class="tok-o">,</span><span class="tok-n">SBZ</span><span class="tok-o">,</span><span class="tok-n">SCN</span><span class="tok-o">,</span><span class="tok-n">SCQ</span><span class="tok-o">,</span><span class="tok-n">SCV</span><span class="tok-o">,</span><span class="tok-n">SCW</span><span class="tok-o">,</span><span class="tok-n">SDL</span><span class="tok-o">,</span><span class="tok-n">SDN</span><span class="tok-o">,</span><span class="tok-n">SDR</span><span class="tok-o">,</span><span class="tok-n">SEN</span><span class="tok-o">,</span><span class="tok-n">SFT</span><span class="tok-o">,</span><span class="tok-n">SGD</span><span class="tok-o">,</span><span class="tok-n">SIP</span><span class="tok-o">,</span><span class="tok-n">SJJ</span><span class="tok-o">,</span><span class="tok-n">SJZ</span><span class="tok-o">,</span><span class="tok-n">SKE</span><span class="tok-o">,</span><span class="tok-n">SKG</span><span class="tok-o">,</span><span class="tok-n">SKN</span><span class="tok-o">,</span><span class="tok-n">SKP</span><span class="tok-o">,</span><span class="tok-n">SKU</span><span class="tok-o">,</span><span class="tok-n">SKX</span><span class="tok-o">,</span><span class="tok-n">SLM</span><span class="tok-o">,</span><span class="tok-n">SMA</span><span class="tok-o">,</span><span class="tok-n">SMI</span><span class="tok-o">,</span><span class="tok-n">SNN</span><span class="tok-o">,</span><span class="tok-n">SOF</span><span class="tok-o">,</span><span class="tok-n">SOG</span><span class="tok-o">,</span><span class="tok-n">SOJ</span><span class="tok-o">,</span><span class="tok-n">SOU</span><span class="tok-o">,</span><span class="tok-n">SOY</span><span class="tok-o">,</span><span class="tok-n">SPC</span><span class="tok-o">,</span><span class="tok-n">SPU</span><span class="tok-o">,</span><span class="tok-n">SRP</span><span class="tok-o">,</span><span class="tok-n">SSJ</span><span class="tok-o">,</span><span class="tok-n">STN</span><span class="tok-o">,</span><span class="tok-n">STR</span><span class="tok-o">,</span><span class="tok-n">STW</span><span class="tok-o">,</span><span class="tok-n">SUF</span><span class="tok-o">,</span><span class="tok-n">SUJ</span><span class="tok-o">,</span><span class="tok-n">SVG</span><span class="tok-o">,</span><span class="tok-n">SVJ</span><span class="tok-o">,</span><span class="tok-n">SVL</span><span class="tok-o">,</span><span class="tok-n">SVO</span><span class="tok-o">,</span><span class="tok-n">SVQ</span><span class="tok-o">,</span><span class="tok-n">SXB</span><span class="tok-o">,</span><span class="tok-n">SXF</span><span class="tok-o">,</span><span class="tok-n">SYY</span><span class="tok-o">,</span><span class="tok-n">SZG</span><span class="tok-o">,</span><span class="tok-n">SZY</span><span class="tok-o">,</span><span class="tok-n">SZZ</span><span class="tok-o">,</span><span class="tok-n">TAY</span><span class="tok-o">,</span><span class="tok-n">TBW</span><span class="tok-o">,</span><span class="tok-n">TEQ</span><span class="tok-o">,</span><span class="tok-n">TER</span><span class="tok-o">,</span><span class="tok-n">TFN</span><span class="tok-o">,</span><span class="tok-n">TFS</span><span class="tok-o">,</span><span class="tok-n">TGD</span><span class="tok-o">,</span><span class="tok-n">TGK</span><span class="tok-o">,</span><span class="tok-n">TGM</span><span class="tok-o">,</span><span class="tok-n">THN</span><span class="tok-o">,</span><span class="tok-n">TIA</span><span class="tok-o">,</span><span class="tok-n">TIV</span><span class="tok-o">,</span><span class="tok-n">TKU</span><span class="tok-o">,</span><span class="tok-n">TLL</span><span class="tok-o">,</span><span class="tok-n">TLN</span><span class="tok-o">,</span><span class="tok-n">TLS</span><span class="tok-o">,</span><span class="tok-n">TMP</span><span class="tok-o">,</span><span class="tok-n">TOS</span><span class="tok-o">,</span><span class="tok-n">TPS</span><span class="tok-o">,</span><span class="tok-n">TRD</span><span class="tok-o">,</span><span class="tok-n">TRE</span><span class="tok-o">,</span><span class="tok-n">TRF</span><span class="tok-o">,</span><span class="tok-n">TRN</span><span class="tok-o">,</span><span class="tok-n">TRS</span><span class="tok-o">,</span><span class="tok-n">TSF</span><span class="tok-o">,</span><span class="tok-n">TSR</span><span class="tok-o">,</span><span class="tok-n">TUF</span><span class="tok-o">,</span><span class="tok-n">TXL</span><span class="tok-o">,</span><span class="tok-n">TYF</span><span class="tok-o">,</span><span class="tok-n">TZL</span><span class="tok-o">,</span><span class="tok-n">UCT</span><span class="tok-o">,</span><span class="tok-n">UDJ</span><span class="tok-o">,</span><span class="tok-n">UFA</span><span class="tok-o">,</span><span class="tok-n">UIP</span><span class="tok-o">,</span><span class="tok-n">UKS</span><span class="tok-o">,</span><span class="tok-n">ULV</span><span class="tok-o">,</span><span class="tok-n">ULY</span><span class="tok-o">,</span><span class="tok-n">UME</span><span class="tok-o">,</span><span class="tok-n">URE</span><span class="tok-o">,</span><span class="tok-n">URO</span><span class="tok-o">,</span><span class="tok-n">URS</span><span class="tok-o">,</span><span class="tok-n">USK</span><span class="tok-o">,</span><span class="tok-n">UTS</span><span class="tok-o">,</span><span class="tok-n">UUA</span><span class="tok-o">,</span><span class="tok-n">VAA</span><span class="tok-o">,</span><span class="tok-n">VAR</span><span class="tok-o">,</span><span class="tok-n">VAW</span><span class="tok-o">,</span><span class="tok-n">VBY</span><span class="tok-o">,</span><span class="tok-n">VCE</span><span class="tok-o">,</span><span class="tok-n">VDB</span><span class="tok-o">,</span><span class="tok-n">VDE</span><span class="tok-o">,</span><span class="tok-n">VDS</span><span class="tok-o">,</span><span class="tok-n">VGO</span><span class="tok-o">,</span><span class="tok-n">VHM</span><span class="tok-o">,</span><span class="tok-n">VIE</span><span class="tok-o">,</span><span class="tok-n">VIN</span><span class="tok-o">,</span><span class="tok-n">VIT</span><span class="tok-o">,</span><span class="tok-n">VKO</span><span class="tok-o">,</span><span class="tok-n">VLC</span><span class="tok-o">,</span><span class="tok-n">VLL</span><span class="tok-o">,</span><span class="tok-n">VLY</span><span class="tok-o">,</span><span class="tok-n">VNO</span><span class="tok-o">,</span><span class="tok-n">VOG</span><span class="tok-o">,</span><span class="tok-n">VOL</span><span class="tok-o">,</span><span class="tok-n">VOZ</span><span class="tok-o">,</span><span class="tok-n">VRN</span><span class="tok-o">,</span><span class="tok-n">VST</span><span class="tok-o">,</span><span class="tok-n">VTB</span><span class="tok-o">,</span><span class="tok-n">VUS</span><span class="tok-o">,</span><span class="tok-n">VXO</span><span class="tok-o">,</span><span class="tok-n">WAT</span><span class="tok-o">,</span><span class="tok-n">WAW</span><span class="tok-o">,</span><span class="tok-n">WIC</span><span class="tok-o">,</span><span class="tok-n">WMI</span><span class="tok-o">,</span><span class="tok-n">WRO</span><span class="tok-o">,</span><span class="tok-n">WRY</span><span class="tok-o">,</span><span class="tok-n">XCR</span><span class="tok-o">,</span><span class="tok-n">XFW</span><span class="tok-o">,</span><span class="tok-n">XRY</span><span class="tok-o">,</span><span class="tok-n">ZAD</span><span class="tok-o">,</span><span class="tok-n">ZAG</span><span class="tok-o">,</span><span class="tok-n">ZAZ</span><span class="tok-o">,</span><span class="tok-n">ZIA</span><span class="tok-o">,</span><span class="tok-n">ZQW</span><span class="tok-o">,</span><span class="tok-n">ZRH</span><span class="tok-o">,</span><span class="tok-n">ZTH</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The next queries show two ways of finding airports with 6 or more runways.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gte</span><span class="tok-o">(</span><span class="tok-mi">6</span><span class="tok-o">))).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-n">gte</span><span class="tok-o">(</span><span class="tok-mi">6</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, let’s look at two ways of finding flights from airports in South America to
Miami. The first query uses <em>select</em> which is what we would have had to do in the
TinkerPop 2 days. The second query, which feels cleaner to me, uses the <em>path</em> and
<em>by</em> step combination introduced in TinkerPop 3.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'continent'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SA'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'x'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'y'</span><span class="tok-o">).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'MIA'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'x'</span><span class="tok-o">,</span><span class="tok-s1">'y'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'continent'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SA'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'MIA'</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This query finds the edge that connects Austin (AUS) with Dallas Ft. Worth (DFW) and
returns the <em>dist</em> property of that edge so we know how far that journey is.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// How far is it from DFW to AUS?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)</span>

<span class="tok-mi">190</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As an alternative approach, we could return a path that would include both airport
codes and the distance. Notice how we need to use <em>outE</em> and <em>inV</em> rather than just
<em>out</em> as we still need the edge to be part of our path so that we can get its <em>dist</em>
property using a <em>by</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">190</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we wanted to find out if there are any ways to get from Brisbane to Austin with
only one stop, this query will do nicely!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Routes from BNE to AUS with only one stop</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'BNE'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">BNE</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is another way of doing the same thing but, once again, to me using <em>path</em> feels
more concise. The only advantage of this query is that if all you want is the name
of any intermediate airports then that’s all you get!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'BNE'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'stop'</span><span class="tok-o">).</span>
                        <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'stop'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-n">LAX</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A common thing you will find yourself doing when working with a graph is counting
things. This next query looks for all the airports that have fewer than five outgoing
routes and counts them. It does this by counting the number of airports that have
fewer than five outgoing edges with a <em>route</em> label. There are a surprisingly high
number of airports that offer this small number of destinations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Airports with fewer than 5 outgoing edges</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">lt</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">))).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">2058</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In a similar vein this query finds the airports with more than 200 outgoing routes.
The second query shows that <em>where</em> is a synonym for <em>filter</em> in many cases.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s2">"airport"</span><span class="tok-o">).</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">200</span><span class="tok-o">))).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s2">"airport"</span><span class="tok-o">).</span><span class="tok-na">filter</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">(</span><span class="tok-s2">"route"</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">200</span><span class="tok-o">))).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are two more queries that look for things that meet a specific criteria. The
first finds routes where the distance is exactly 100 miles and returns the source and
destination airport codes. The first query uses <em>as</em> and <em>select</em> while the second
one uses <em>path</em> and includes the distance in the result.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// List ten (or less) routes where the distance is exactly 100 miles</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">eq</span><span class="tok-o">(</span><span class="tok-mi">100</span><span class="tok-o">)).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">IAD</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">RIC</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">HNL</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">OGG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">OGG</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">HNL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">SJO</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">LIR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">SVG</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">KRS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">RIC</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">IAD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">LIR</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">SJO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">KRS</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">SVG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">CYB</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">GCM</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">GCM</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">CYB</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Similar to the prior query but using <em>path</em> and displaying the distance as well as
the airport codes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">eq</span><span class="tok-o">(</span><span class="tok-mi">100</span><span class="tok-o">)).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">IAD</span><span class="tok-o">,</span><span class="tok-mi">100</span><span class="tok-o">,</span><span class="tok-n">RIC</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">HNL</span><span class="tok-o">,</span><span class="tok-mi">100</span><span class="tok-o">,</span><span class="tok-n">OGG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">OGG</span><span class="tok-o">,</span><span class="tok-mi">100</span><span class="tok-o">,</span><span class="tok-n">HNL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SJO</span><span class="tok-o">,</span><span class="tok-mi">100</span><span class="tok-o">,</span><span class="tok-n">LIR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SVG</span><span class="tok-o">,</span><span class="tok-mi">100</span><span class="tok-o">,</span><span class="tok-n">KRS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">RIC</span><span class="tok-o">,</span><span class="tok-mi">100</span><span class="tok-o">,</span><span class="tok-n">IAD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LIR</span><span class="tok-o">,</span><span class="tok-mi">100</span><span class="tok-o">,</span><span class="tok-n">SJO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">KRS</span><span class="tok-o">,</span><span class="tok-mi">100</span><span class="tok-o">,</span><span class="tok-n">SVG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">CYB</span><span class="tok-o">,</span><span class="tok-mi">100</span><span class="tok-o">,</span><span class="tok-n">GCM</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">GCM</span><span class="tok-o">,</span><span class="tok-mi">100</span><span class="tok-o">,</span><span class="tok-n">CYB</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This query looks for any airports that have an elevation above 10,000 feet. Two ways
of achieving the more or less the same result are shown. The first uses <em>valueMap</em>
and the second uses a <em>project</em> step instead.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Airports above 10,000ft sorted by ascending elevation</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'elev'</span><span class="tok-o">,</span> <span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">10000</span><span class="tok-o">)).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'elev'</span><span class="tok-o">,</span><span class="tok-n">asc</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'elev'</span><span class="tok-o">)</span>


<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'elev'</span><span class="tok-o">,</span> <span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">10000</span><span class="tok-o">)).</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'elev'</span><span class="tok-o">,</span><span class="tok-n">asc</span><span class="tok-o">).</span>
      <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'elevation'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'elev'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we ran the query that uses the <em>project</em> step here is what we should get back.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Xiahe</span><span class="tok-o">,</span><span class="tok-nl">elevation:</span><span class="tok-mi">10510</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Leh</span><span class="tok-o">,</span><span class="tok-nl">elevation:</span><span class="tok-mi">10682</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Shangri</span><span class="tok-o">-</span><span class="tok-n">La</span><span class="tok-o">,</span><span class="tok-nl">elevation:</span><span class="tok-mi">10761</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Cusco</span><span class="tok-o">,</span><span class="tok-nl">elevation:</span><span class="tok-mi">10860</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Jauja</span><span class="tok-o">,</span><span class="tok-nl">elevation:</span><span class="tok-mi">11034</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Andahuaylas</span><span class="tok-o">,</span><span class="tok-nl">elevation:</span><span class="tok-mi">11300</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Jiuzhaigou</span><span class="tok-o">,</span><span class="tok-nl">elevation:</span><span class="tok-mi">11327</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Navoi</span><span class="tok-o">,</span><span class="tok-nl">elevation:</span><span class="tok-mi">11420</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Hongyuan</span><span class="tok-o">,</span><span class="tok-nl">elevation:</span><span class="tok-mi">11598</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Lhasa</span><span class="tok-o">,</span><span class="tok-nl">elevation:</span><span class="tok-mi">11713</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Oruro</span><span class="tok-o">,</span><span class="tok-nl">elevation:</span><span class="tok-mi">12152</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Xigaze</span><span class="tok-o">,</span><span class="tok-nl">elevation:</span><span class="tok-mi">12408</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Golog</span><span class="tok-o">,</span><span class="tok-nl">elevation:</span><span class="tok-mi">12427</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Juliaca</span><span class="tok-o">,</span><span class="tok-nl">elevation:</span><span class="tok-mi">12552</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Yushu</span><span class="tok-o">,</span><span class="tok-nl">elevation:</span><span class="tok-mi">12816</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Potosi</span><span class="tok-o">,</span><span class="tok-nl">elevation:</span><span class="tok-mi">12913</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Quijarro</span><span class="tok-o">,</span><span class="tok-nl">elevation:</span><span class="tok-mi">12972</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">La</span> <span class="tok-n">Paz</span> <span class="tok-o">/</span> <span class="tok-n">El</span> <span class="tok-n">Alto</span><span class="tok-o">,</span><span class="tok-nl">elevation:</span><span class="tok-mi">13355</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Shiquanhe</span><span class="tok-o">,</span><span class="tok-nl">elevation:</span><span class="tok-mi">14022</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Kangding</span><span class="tok-o">,</span><span class="tok-nl">elevation:</span><span class="tok-mi">14042</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Bangda</span><span class="tok-o">,</span><span class="tok-nl">elevation:</span><span class="tok-mi">14219</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Daocheng</span><span class="tok-o">,</span><span class="tok-nl">elevation:</span><span class="tok-mi">14472</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The next query finds any routes between Austin and Sydney that only require one
stop.The <em>by</em> step offers a clean way of doing this query by combining it with
<em>path</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SYD'</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following three queries all achieve the same result. They find flights from any
airport in Africa to any airport in the United States. These queries are intresting
as the continent information is represented in the graph as edges connecting an
airport vertex with a continent vertex. This is about as close as Gremlin gets to a SQL
join statement!</p>
</div>
<div class="paragraph">
<p>The first query starts by looking at airports the second starts from the vertex that
represents Africa. The third query uses <em>where</em> to show an alternate way of achieving
the same result.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">in</span><span class="tok-o">(</span><span class="tok-s1">'contains'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AF'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'US'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'continent'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'US'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">in</span><span class="tok-o">(</span><span class="tok-s1">'contains'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AF'</span><span class="tok-o">)).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'US'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we run the query we should get results that look like this. I have laid them out
in two columns to save space.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">JNB</span><span class="tok-o">,</span> <span class="tok-nl">b:</span><span class="tok-n">ATL</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">ACC</span><span class="tok-o">,</span> <span class="tok-nl">b:</span><span class="tok-n">JFK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">JNB</span><span class="tok-o">,</span> <span class="tok-nl">b:</span><span class="tok-n">JFK</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">CMN</span><span class="tok-o">,</span> <span class="tok-nl">b:</span><span class="tok-n">IAD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">CAI</span><span class="tok-o">,</span> <span class="tok-nl">b:</span><span class="tok-n">JFK</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">CMN</span><span class="tok-o">,</span> <span class="tok-nl">b:</span><span class="tok-n">JFK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">ADD</span><span class="tok-o">,</span> <span class="tok-nl">b:</span><span class="tok-n">IAD</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">GCK</span><span class="tok-o">,</span> <span class="tok-nl">b:</span><span class="tok-n">DFW</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">ADD</span><span class="tok-o">,</span> <span class="tok-nl">b:</span><span class="tok-n">EWR</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">DKR</span><span class="tok-o">,</span> <span class="tok-nl">b:</span><span class="tok-n">IAD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">LOS</span><span class="tok-o">,</span> <span class="tok-nl">b:</span><span class="tok-n">ATL</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">DKR</span><span class="tok-o">,</span> <span class="tok-nl">b:</span><span class="tok-n">JFK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">LOS</span><span class="tok-o">,</span> <span class="tok-nl">b:</span><span class="tok-n">IAH</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">LFW</span><span class="tok-o">,</span> <span class="tok-nl">b:</span><span class="tok-n">EWR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">LOS</span><span class="tok-o">,</span> <span class="tok-nl">b:</span><span class="tok-n">JFK</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">RAI</span><span class="tok-o">,</span> <span class="tok-nl">b:</span><span class="tok-n">BOS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">ACC</span><span class="tok-o">,</span> <span class="tok-nl">b:</span><span class="tok-n">IAD</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The query below shows how to use the <em>project</em> step that was introduced in TinkerPop
3, along with <em>order</em> and <em>select</em> to produce a sorted table of airports you can fly
to from AUSTIN along with their runway counts. The <em>limit</em> step is used to only
return the top ten results. You will find several examples elsewhere in this book
that use variations of this collection of steps.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">project</span><span class="tok-o">(</span><span class="tok-s1">'ap'</span><span class="tok-o">,</span><span class="tok-s1">'rw'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'rw'</span><span class="tok-o">),</span><span class="tok-n">desc</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results we get from running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">ORD</span><span class="tok-o">,</span> <span class="tok-nl">rw:</span><span class="tok-mi">8</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">DFW</span><span class="tok-o">,</span> <span class="tok-nl">rw:</span><span class="tok-mi">7</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">BOS</span><span class="tok-o">,</span> <span class="tok-nl">rw:</span><span class="tok-mi">6</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">DEN</span><span class="tok-o">,</span> <span class="tok-nl">rw:</span><span class="tok-mi">6</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">DTW</span><span class="tok-o">,</span> <span class="tok-nl">rw:</span><span class="tok-mi">6</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">YYZ</span><span class="tok-o">,</span> <span class="tok-nl">rw:</span><span class="tok-mi">5</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">MDW</span><span class="tok-o">,</span> <span class="tok-nl">rw:</span><span class="tok-mi">5</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">ATL</span><span class="tok-o">,</span> <span class="tok-nl">rw:</span><span class="tok-mi">5</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">IAH</span><span class="tok-o">,</span> <span class="tok-nl">rw:</span><span class="tok-mi">5</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">FRA</span><span class="tok-o">,</span> <span class="tok-nl">rw:</span><span class="tok-mi">4</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="beq">4. BEYOND BASIC QUERIES</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far we have looked mostly at querying an existing graph. In the following sections
we will look at many other topics that it is also important to be familiar with when
working with Gremlin. These topics include mixing in some Groovy or Java code with
your queries, as well as adding vertices (nodes), edges and properties to a graph and
also deleting them. We will also look at how to create a sub-graph and how to save a
graph to an XML or JSON file and a lot more. Let’s start off with a short discussion
of query layout, reserved words and data modelling.</p>
</div>
<div class="sect2">
<h3 id="indents">4.1. A word about layout and indentation</h3>
<div class="paragraph">
<p>As you begin to write more complex Gremlin queries they can get quite lengthy. In
order to make them easier for others to read it is recommended to spread them over
multiple lines and indent them in a way that makes sense. I am not going to propose
an indentation standard, I believe this should be left to personal preference however
there are a few things I want to mention in passing. When working with the Gremlin
console, if you want to spread a query over multiple lines then you will need to end
each line with a backslash character or with a character such as a period or a comma
that tells the Gremlin parser that there is more to come.</p>
</div>
<div class="paragraph">
<p>The following example shows the query we already looked at in the Boolean operations
section of this book but this time edited so that it could be copy and pasted
directly into the Gremlin console.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">)</span> <span class="tok-err">\</span>
     <span class="tok-o">.</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'US-TX'</span><span class="tok-o">,</span><span class="tok-s1">'US-LA'</span><span class="tok-o">,</span><span class="tok-s1">'US-AZ'</span><span class="tok-o">,</span><span class="tok-s1">'US-OK'</span><span class="tok-o">))</span>   <span class="tok-err">\</span>
     <span class="tok-o">.</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-n">asc</span><span class="tok-o">)</span>   <span class="tok-err">\</span>
     <span class="tok-o">.</span><span class="tok-na">valueMap</span><span class="tok-o">().</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can avoid the use of backslash characters if we lay the query out as follows. Each
line ends with a period which tells the parser that there are more steps coming.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'US-TX'</span><span class="tok-o">,</span><span class="tok-s1">'US-LA'</span><span class="tok-o">,</span><span class="tok-s1">'US-AZ'</span><span class="tok-o">,</span><span class="tok-s1">'US-OK'</span><span class="tok-o">)).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-n">asc</span><span class="tok-o">).</span>
      <span class="tok-n">valueMap</span><span class="tok-o">().</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we do not give the parser one of these clues that there is more to come, the
Gremlin console will try and execute each line without waiting for the next line.</p>
</div>
<div class="paragraph">
<p>Some people find it easier to read queries when each step or modulator is given its
own line and indented appropriately. So we could layout the query as shown below and
it will still work just fine.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'US-TX'</span><span class="tok-o">,</span><span class="tok-s1">'US-LA'</span><span class="tok-o">,</span><span class="tok-s1">'US-AZ'</span><span class="tok-o">,</span><span class="tok-s1">'US-OK'</span><span class="tok-o">)).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-n">asc</span><span class="tok-o">).</span>
      <span class="tok-n">valueMap</span><span class="tok-o">().</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Whether you decide to use the backslash as a continuation character or leave the
period on the previous line is really a matter of personal preference. Just be sure
to do one or the other if you want to use multiple line queries within the Gremlin
console. There is no golden rule as to how many lines and how much indenting you
should use when laying out your more complex queries. However, whatever you decide to
do, it is worth remembering that others reading your work may find well laid out and
appropriately indented steps easier to read and understand.</p>
</div>
</div>
<div class="sect2">
<h3 id="rword">4.2. A warning about reserved word conflicts and collisions</h3>
<div class="paragraph">
<p>Most of the time the issue I am about to describe will not be a problem. However,
there are cases where names of Gremlin steps conflict with reserved words and method
names in Groovy. Remember that Gremlin is coded in Groovy and Java. If you hit one of
these cases, often the error message that you will get presented with does not make
it at all clear that you have run into this particular issue. Let’s look at some
examples. One step name in Gremlin that can sometimes run into this naming conflict
is the <em>in</em> step. However, you do not have to worry about this in all cases. First
take a look at the following query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">in</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That query does not cause an error and correctly returns all of the vertices that are
connected by an incoming edge, to the <em>AUS</em> vertex. There is no conflict of names
here because it is clear that the <em>in</em> reference applies to the result of the has
step. However, now take a look at this query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">union</span><span class="tok-o">(</span><span class="tok-k">in</span><span class="tok-o">(),</span><span class="tok-n">out</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case the <em>in</em> is on its own and not <em>dot connected</em> to a previous step.
The Gremlin runtime (which remember is written in Groovy) will try to interpret this
and will throw an error because it thinks this is a reference to its own <em>in</em> method.
To make this query work we have to adjust the syntax slightly as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">union</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">in</span><span class="tok-o">(),</span><span class="tok-n">out</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that I added the <em>"__."</em> (underscore underscore period) in front of the <em>in</em>
step. This is shorthand for <em>"the thing we are currently looking at"</em>, so in this
case, the result of the <em>has</em> step.</p>
</div>
<div class="paragraph">
<p>There are currently not too many Groovy reserved words to worry about. The three that
you have to watch out for are <em>in</em>, <em>not</em> and <em>as</em> which have special meanings in
both Gremlin and Groovy. Remember though, you will only need to use the <em>"__."</em>
notation when it is not clear what the reserved word, like <em>in</em>, applies to.</p>
</div>
<div class="paragraph">
<p>You will find an example of <em>not</em> being used with the <em>"__."</em> prefix in the
"<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#btree">Modelling an ordered binary tree as a graph</a>" section a bit later on.</p>
</div>
</div>
<div class="sect2">
<h3 id="dmodel">4.3. Thinking about your data model</h3>
<div class="paragraph">
<p>As important as it is to become good at writing effective Gremlin queries, it
is equally important, if not more so, to put careful consideration into how
you model your data as a graph. Ideally you want to arrange your graph so that
it can efficiently support the most common queries that you foresee it needing
to handle.</p>
</div>
<div class="paragraph">
<p>Consider this query description. "Find all flight routes that exist between airports
anywhere in the continent of Africa and the United States". When putting the
<em>air-routes</em> graph together I decided to model continents as their own vertices. So each
of the seven continents has a vertex. Each vertex is connected to airports within that
continent by an edge labeled "contains".</p>
</div>
<div class="paragraph">
<p>I could have chosen to just make the continent a property of each airport vertex but
had I done that, to answer the question about "routes starting in Africa" I would
have to look at every single airport vertex in the graph just to figure out which
continent contained it. By giving each continent its own vertex I am able to greatly
simplify the query we need to write.</p>
</div>
<div class="paragraph">
<p>Take a look at the query below. We first look just for vertices that are continents. We
then only look at the Africa vertex and the connections it has (each will be to a
different airport). By starting the query in this way, we have very efficiently
avoided looking at a large number of the airports in the graph altogether. Finally we
look at any routes from airports in Africa that end up in the United States. This
turns out to yield a nice and simple query in no small part because our data model in
the graph made it so easy to do.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Flights from any Airport in Africa to any airport in the United States</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'continent'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'US'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could also have started our query by looking at each airport and looking to
see if it is in Africa but that would involve looking at a lot more vertices. The
point to be made here is that even if our data model is good we still need to
always be thinking about the most efficient way to write our queries.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Gives same results but not as efficient</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">in</span><span class="tok-o">(</span><span class="tok-s1">'contains'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AF'</span><span class="tok-o">).</span>
     <span class="tok-o">.</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'US'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now for a fairly simple graph, like <em>air-routes</em>, this discussion of efficiency is
perhaps not such a big deal, but as you start to work with large graphs,
getting the data model right can be the difference between good and bad query
response times. If the data model is bad you won’t always be able to work
around that deficiency simply by writing clever queries!</p>
</div>
<div class="sect3">
<h4 id="_keeping_information_in_two_places_within_the_same_graph">4.3.1. Keeping information in two places within the same graph</h4>
<div class="paragraph">
<p>Sometimes, to improve query efficiency I find it is actually worth having the
data available more than one place within the same graph. An example of this
in the air routes graph would be the way I decided to model countries. I have
a unique vertex for each country but I also store the country code as a property
of each airport vertex. In a small graph this perhaps is overkill but I did it
to make a point. Look at the following two queries that return the same
results - the cities in Portugal that have airports in the graph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'PT'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">(</span><span class="tok-s2">"contains"</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'PT'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The first query finds the country vertex for Portugal and then, finds all of the
countries connected to it. The second query looks at all airport vertices and
looks to see if they contain <em>PT</em> as the country property.</p>
</div>
<div class="paragraph">
<p>In the first example it is likely that a lot fewer vertices will get looked at
than the first even though a few edges will also get walked as there are over
3,000 airport vertices but fewer than 300 country vertices. Also, in a production
system with an index in place finding the <em>Portugal</em> vertex should be very fast.</p>
</div>
<div class="paragraph">
<p>Conversely, if we were already looking at an airport vertex for some other
reason and just wanted to see what country it is in, it is more convenient to
just look at the <em>country</em> property of that vertex.</p>
</div>
<div class="paragraph">
<p>So there is no golden rule here but it is something to think about while
designing your data model.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_a_graph_as_an_index_into_other_data_sources">4.3.2. Using a graph as an index into other data sources</h4>
<div class="paragraph">
<p>While on the topic of what to keep in the graph, something to resist being
drawn into in many cases is the desire to keep absolutely everything in the
graph. For example, in the air routes graph I do not keep every single detail
about an airport (radio frequencies, runway names, weather information etc.)
in the airport vertices. That information is available in other places and easy
to find. In a production system you should consider carefully what needs to be
in your graph and what more naturally belongs elsewhere. One thing I could do
is add a URL as a property of each airport vertex that points to the airports
home page or some other resource that has all of the information. In this way
the graph becomes a high quality index into other data sources. This is a
common and useful pattern when working with graphs. This model of having
multiple data sources working together is sometimes referred to as <em>Polyglot
storage</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_a_few_words_about_supernodes">4.3.3. A few words about <em>supernodes</em></h4>
<div class="paragraph">
<p>When a vertex in a graph has a large number of edges and is disproportionately
connected to many of the other vertices in the graph it is likely that many, if not
all, graph traversals of any consequence will include that vertex. Such vertices
(nodes) are often referred to as <em>supernodes</em>. In some cases the presence of
<em>supernodes</em> may be unavoidable but with careful planning as you design your graph
model you can reduce the likelihood that vertices become <em>supernodes</em>. The reason we
worry about <em>supernodes</em> is that they can significantly impact the performance of
graph traversals. This is because it is likely that any graph traversal that goes via
such a vertex will have to look at most if not all of the edges connected to that vertex
as part of a traversal.</p>
</div>
<div class="paragraph">
<p>The <em>air-routes</em> graph does not really have anything that could be classed as a
<em>supernode</em>. The vertex with the most edges is the continent vertex for North America
that has approximately 980 edges. The busiest airports are IST and AMS and they both
have just over 530 total edges. So in the case of the <em>air-routes</em> graph we do not have
to worry too much.</p>
</div>
<div class="paragraph">
<p>If we were building a graph of a social network that included famous people we might
have to worry. Consider some of the people on Twitter with millions of followers.
Without taking some precautions, such a social network, modelled as a graph, could
face issues.</p>
</div>
<div class="paragraph">
<p>As you design your graph model it is worth considering that some things are perhaps
better modelled as a vertex property than as a vertex with lots of edges needing to
connect to it. For example in the air routes graph there are country vertices and each
airport is connected to one of the country vertices. In the air routes graph this is not
a problem as even if all of the airports in the graph were in the same country that
would still give us fewer than 3,500 edges connected to that vertex. However, imagine
if we were building a graph of containing a very large number of people. If we had
several million people in the graph all living in same the country that would be a
guaranteed way to get a <em>supernode</em> if we modelled that relationship by connecting
every person vertex to a country vertex using a <em>lives in</em> edge. In such situations, it
would be far more sensible to make the country where a person lives a property of
their own vertex.</p>
</div>
<div class="paragraph">
<p>A detailed discussion of <em>supernode</em> mitigation is beyond the scope of this book
but I encourage you to always be thinking about their possibility as you design your
graph and also be thinking about how you can prevent them becoming a big issue for
you.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="grv">4.4. Making Gremlin even Groovier</h3>
<div class="paragraph">
<p>As we have already discussed, the Gremlin console builds upon the Groovy console, and
Groovy itself is coded in Java. This means that all of the classes and methods that
you would expect to have available while writing Groovy or Java programs are also
available to you as you work with the Gremlin Console. You can intermix additional
features from Groovy and Java classes along with the features provided by the
TinkerPop 3 classes as needed. This capability makes Gremlin additionally powerful.
You can also take advantage of these features when working with Gremlin Server and
with other TinkerPop enabled graph services with the caveat that some features may be
blocked if viewed as a potential security risk to the server or simply because they
are not supported.</p>
</div>
<div class="paragraph">
<p>Every Gremlin query we have demonstrated so far is also, in reality, valid Groovy. We
have already shown examples of storing values into variables and looping using Groovy
constructs as part of a single or multi part Gremlin query.</p>
</div>
<div class="paragraph">
<p>In this section we are going to go one step further and actually define some
methods, using Groovy syntax, that can be run while still inside the Gremlin Console.
By way of a simple example, let’s define a method that will tell us how far apart two
airports are and then invoke it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// A simple function to return the distance between two airports</span>
<span class="tok-kt">def</span> <span class="tok-nf">dist</span><span class="tok-o">(</span><span class="tok-n">g</span><span class="tok-o">,</span><span class="tok-n">from</span><span class="tok-o">,</span><span class="tok-n">to</span><span class="tok-o">)</span> <span class="tok-o">{</span>
  <span class="tok-n">d</span><span class="tok-o">=</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">from</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">to</span><span class="tok-o">)</span>
         <span class="tok-o">.</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span>
  <span class="tok-k">return</span> <span class="tok-n">d</span> <span class="tok-o">}</span>

<span class="tok-c1">// Can be called like this</span>
<span class="tok-n">dist</span><span class="tok-o">(</span><span class="tok-n">g</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">,</span><span class="tok-s1">'MEX'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This next example shows how to define a slightly longer method that prints out
information about the degree of a vertex in a nice, human readable, form.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Groovy function to display vertex degree</span>
<span class="tok-kt">def</span> <span class="tok-nf">degree</span><span class="tok-o">(</span><span class="tok-n">g</span><span class="tok-o">,</span><span class="tok-n">s</span><span class="tok-o">)</span> <span class="tok-o">{</span>
  <span class="tok-n">v</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">s</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">();</span>
  <span class="tok-n">o</span><span class="tok-o">=</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-n">v</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">();</span>
  <span class="tok-n">i</span><span class="tok-o">=</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-n">v</span><span class="tok-o">).</span><span class="tok-na">in</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()</span> <span class="tok-o">;</span>
  <span class="tok-n">println</span> <span class="tok-s2">"Edges in  : "</span> <span class="tok-o">+</span> <span class="tok-n">i</span><span class="tok-o">;</span>
  <span class="tok-n">println</span> <span class="tok-s2">"Edges out : "</span> <span class="tok-o">+</span> <span class="tok-n">o</span><span class="tok-o">;</span>
  <span class="tok-n">println</span> <span class="tok-s2">"Total     : "</span> <span class="tok-o">+(</span><span class="tok-n">i</span><span class="tok-o">+</span><span class="tok-n">o</span><span class="tok-o">);</span>
<span class="tok-o">}</span>

<span class="tok-c1">// Can be called like this</span>
<span class="tok-n">degree</span><span class="tok-o">(</span><span class="tok-n">g</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example that shows how we can query the graph, get back a list of values
and then use a <em>for</em> loop to display them. Notice this time how we initially store
the results of the query into the variable <em>x</em>. The call to <em>toList</em> ensures that <em>x</em>
will contain a list (array) of the returned values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Using a Groovy for() loop to iterate over a list returned by Gremlin</span>
<span class="tok-n">x</span><span class="tok-o">=</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">toList</span><span class="tok-o">()</span>
<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">a</span> <span class="tok-k">in</span> <span class="tok-n">x</span><span class="tok-o">)</span> <span class="tok-o">{</span><span class="tok-n">println</span><span class="tok-o">(</span><span class="tok-n">a</span><span class="tok-o">.</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()+</span><span class="tok-s2">" "</span><span class="tok-o">+</span><span class="tok-n">a</span><span class="tok-o">.</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'icao'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()+</span><span class="tok-s2">" "</span><span class="tok-o">+</span><span class="tok-n">a</span><span class="tok-o">.</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">())}</span>

<span class="tok-c1">// We can also do this just using a 'for' loop and not storing anything into a variable.</span>
<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">a</span> <span class="tok-k">in</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">toList</span><span class="tok-o">())</span> <span class="tok-o">{</span><span class="tok-n">println</span><span class="tok-o">(</span><span class="tok-n">a</span><span class="tok-o">.</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()+</span><span class="tok-s2">""</span><span class="tok-o">+</span><span class="tok-n">a</span><span class="tok-o">.</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'icao'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">())}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Sometimes (as you have seen above) it is necessary to make a call to <em>next</em> to get
the result you expect returned to your variable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">number</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()</span>
<span class="tok-n">println</span> <span class="tok-s2">"The number of airports in the graph is "</span> <span class="tok-o">+</span> <span class="tok-n">number</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is another example that makes a Gremlin query inside a <em>for</em> loop.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">a</span> <span class="tok-k">in</span> <span class="tok-mi">1</span><span class="tok-o">..</span><span class="tok-mi">10</span><span class="tok-o">)</span> <span class="tok-n">print</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-o">,</span><span class="tok-n">a</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()+</span><span class="tok-s2">" "</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This example returns a hash of vertices, with vertex labels as the keys and the
code property as the values. It then uses the label names to access the returned
hash.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">a</span><span class="tok-o">=</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">label</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span>
<span class="tok-n">println</span><span class="tok-o">(</span><span class="tok-n">a</span><span class="tok-o">[</span><span class="tok-s2">"country"</span><span class="tok-o">].</span><span class="tok-na">size</span><span class="tok-o">())</span>
<span class="tok-n">println</span><span class="tok-o">(</span><span class="tok-n">a</span><span class="tok-o">[</span><span class="tok-s2">"country"</span><span class="tok-o">][</span><span class="tok-mi">5</span><span class="tok-o">])</span>
<span class="tok-n">println</span><span class="tok-o">(</span><span class="tok-n">a</span><span class="tok-o">[</span><span class="tok-s2">"airport"</span><span class="tok-o">][</span><span class="tok-mi">2</span><span class="tok-o">])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is another example. This time we define a method that takes as input a traversal
object and the code for an airport. It then uses those parameters to run a simple
Gremlin query to retrieve all of the places that you can fly to from that airport.
It then uses a simple <em>for</em> loop to print the results in a table. Note the use of
<em>next</em> as part of the <em>println</em>. This is needed in order to get the actual values
that we are looking for. If we did not include the calls to <em>next</em> we would actually
get back the iterator object itself and not the actual values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Given a traversal and an airport code print a list of all the places you can</span>
<span class="tok-c1">// fly to from there including the IATA code and airport description.</span>
<span class="tok-kt">def</span> <span class="tok-nf">from</span><span class="tok-o">(</span><span class="tok-n">g</span><span class="tok-o">,</span><span class="tok-n">a</span><span class="tok-o">)</span> <span class="tok-o">{</span>
  <span class="tok-n">places</span><span class="tok-o">=</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">a</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">toList</span><span class="tok-o">();</span>
  <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">x</span> <span class="tok-k">in</span> <span class="tok-n">places</span><span class="tok-o">)</span> <span class="tok-o">{</span><span class="tok-n">println</span> <span class="tok-n">x</span><span class="tok-o">.</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()+</span><span class="tok-s2">" "</span><span class="tok-o">+</span><span class="tok-n">x</span><span class="tok-o">.</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()}</span>
<span class="tok-o">}</span>

<span class="tok-c1">// Call like this</span>
<span class="tok-n">from</span><span class="tok-o">(</span><span class="tok-n">g</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This example creates a hash map of all the airports, using their IATA code as the
key. We can then access the map using the IATA code to query information about those
airports. Remember that the <em>;[]</em> at the end of the query just stops the console from
displaying unwanted output.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Create a map (a) of all vertices with the code property as the key</span>
<span class="tok-n">a</span><span class="tok-o">=</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">();[]</span>

<span class="tok-c1">// Show the description stored in the JFK vertex</span>
<span class="tok-n">a</span><span class="tok-o">[</span><span class="tok-s1">'JFK'</span><span class="tok-o">][</span><span class="tok-mi">0</span><span class="tok-o">].</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Another useful way to work with variables is to establish the variable and then use
the <em>fill</em> step to place the results of a query into it. The example below creates an
empty list called <em>german</em>. The query then finds all the vertices for airports
located in Germany and uses the <em>fill</em> step to place them into the variable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">german</span> <span class="tok-o">=</span> <span class="tok-o">[]</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'DE'</span><span class="tok-o">).</span><span class="tok-na">fill</span><span class="tok-o">(</span><span class="tok-n">german</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can then use our list as you would expect. Remember that as we are running inside
the Gremlin console we do not have to explicitly iterate through the list as you
would if you were writing a standalone Groovy application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// How many results did we get back?</span>
<span class="tok-n">german</span><span class="tok-o">.</span><span class="tok-na">size</span>

<span class="tok-mi">32</span>

<span class="tok-c1">// Query some values from one of the airports in the list</span>
<span class="tok-n">german</span><span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">].</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-n">FRA</span>
<span class="tok-n">Frankfurt</span>

<span class="tok-c1">// Feed an entry from our list back into a traversal</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-n">german</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">]).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span>

<span class="tok-n">Munich</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-n">german</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">]).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">237</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Towards the end of the book, in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#groovyapp">Working with TinkerGraph from a Groovy application</a>" section, we will explore
writing some standalone Groovy code that can use the TinkerPop API and issue Gremlin
queries while running outside of the Gremlin Console as a standalone application.</p>
</div>
<div class="sect3">
<h4 id="varaus">4.4.1. Using a variable to feed a traversal</h4>
<div class="paragraph">
<p>Sometimes it is very useful to store the result of a query in a variable and
then, later on, use that variable to start a new traversal. You may have noticed we
did that in the very last example of the prior section where we fed the <em>german</em>
variable back in to a traversal. By way of another simple
example, the code below stores the result of the first query in the variable
<em>austin</em> and then uses it to look for routes from Austin in second query.
Notice how we do this by passing the variable containing the Austin vertex
into the <em>V()</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"> <span class="tok-n">austin</span><span class="tok-o">=</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span>
 <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-n">austin</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can take this technique one step further and pass an entire saved list of
vertices to <em>V()</em>. In the next example we first generate a list of all
airports that are in Scotland and then pass that entire list into <em>V()</em> to
first of all count how many routes there are from those airports and then we
start another query that looks for any route from those airports to airports
in Germany.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Find all airports in Scotland</span>
<span class="tok-n">a</span><span class="tok-o">=</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'GB-SCT'</span><span class="tok-o">).</span><span class="tok-na">toList</span><span class="tok-o">()</span>

<span class="tok-c1">// How many routes from these airports?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-n">a</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-c1">// How many of those routes end up in Germany?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-n">a</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'DE'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example of using with variables to drive traversals, we again
create a list of airports. This time we find all the airports in Texas. We
then use a Groovy <em>each</em> loop to iterate through the list. For each airport in
the list we print the code of the starting airport and then the codes of every
airport that you can fly to from there.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Find all of the airports in Texas</span>
<span class="tok-n">texas</span><span class="tok-o">=</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">).</span><span class="tok-na">toList</span><span class="tok-o">()</span>

<span class="tok-c1">// For each airport, print a list of all the airports that you can fly to from there.</span>
<span class="tok-n">texas</span><span class="tok-o">.</span><span class="tok-na">each</span> <span class="tok-o">{</span><span class="tok-n">println</span> <span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-s2">"===&gt;"</span> <span class="tok-o">+</span>
                    <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-n">it</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">toList</span><span class="tok-o">()}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This example, which is admittedly a bit contrived, we use a variable inside of a
<em>has</em> step. We initially create a list containing all of the IATA codes for each
airport in the graph. We then iterate through that list and calculate how many
outgoing routes there are from each place and print out a string containing the
airport IATA code and the count for that airport. Note that this could easily be done
just using a Gremlin query with no additional Groovy code. The point of this example
is more to show another example of mixing Gremlin, Groovy and variables.
Knowing that you can do this kind of thing may come in useful as you start to write
more complicated graph database applications that use Gremlin. You will see this
type of query done using just Gremlin in the section called "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#unwantededges">Finding unwanted parallel edges</a>""
later in this book.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">m</span><span class="tok-o">=</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">toList</span><span class="tok-o">()</span>
<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">a</span> <span class="tok-k">in</span> <span class="tok-n">m</span><span class="tok-o">)</span> <span class="tok-n">println</span> <span class="tok-n">a</span> <span class="tok-o">+</span> <span class="tok-s2">" : "</span> <span class="tok-o">+</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">a</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lastly, here is an example that uses an array of values to seed a query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-s1">'AUS'</span><span class="tok-o">,</span><span class="tok-s1">'RDU'</span><span class="tok-o">,</span><span class="tok-s1">'MCO'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">].</span>
     <span class="tok-n">each</span> <span class="tok-o">{</span><span class="tok-n">println</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'JFK'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">inV</span><span class="tok-o">().</span>
                         <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">it</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the output from running the code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">JFK</span><span class="tok-o">,</span> <span class="tok-mi">1520</span><span class="tok-o">,</span> <span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">JFK</span><span class="tok-o">,</span> <span class="tok-mi">427</span><span class="tok-o">,</span> <span class="tok-n">RDU</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">JFK</span><span class="tok-o">,</span> <span class="tok-mi">945</span><span class="tok-o">,</span> <span class="tok-n">MCO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">JFK</span><span class="tok-o">,</span> <span class="tok-mi">3440</span><span class="tok-o">,</span> <span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">JFK</span><span class="tok-o">,</span> <span class="tok-mi">1390</span><span class="tok-o">,</span> <span class="tok-n">DFW</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="addnodes">4.5. Adding vertices, edges and properties</h3>
<div class="paragraph">
<p>So far in this book we have largely focussed on loading a graph from a file and
running queries against it. As you start to build your own graphs you will not always
start with a graph saved as a text file in GraphML, CSV, GraphSON or some other
format. You may start with an empty graph and incrementally add vertices and edges.
Just as likely you may start with a graph like the air routes graph, read from a
file, but want to add vertices, edges and properties to it over time. In this section
we will explore various ways of doing just that.</p>
</div>
<div class="paragraph">
<p>Vertices and edges can be added directly to the graph using the <em>graph</em> object or as
part of a graph traversal. We will look at both of these techniques over course of
the following pages.</p>
</div>
<div class="sect3">
<h4 id="_adding_an_airport_vertex_and_a_route_edge">4.5.1. Adding an airport (vertex) and a route (edge)</h4>
<div class="paragraph">
<p>The following code uses the <em>graph</em> object that we created when we first loaded the
<em>air-routes</em> graph to create a new airport vertex (node) and then adds a route (edge)
from it to the existing DFW vertex. We can specify the label name (<em>airport</em>) and as
many properties as we wish to while creating the vertex. In this case we just provide
three. We can additionally add and delete vertex properties after a vertex has been
created. While using the <em>graph</em> object in this way works, it is strongly recommended
that the traversal source object <em>g</em> be used instead and that vertices and edges be
added using a traversal. Examples of how to do that are coming up next.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Add an imaginary airport with a code of 'XYZ' and connect it to DFW</span>
<span class="tok-n">xyz</span> <span class="tok-o">=</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">addVertex</span><span class="tok-o">(</span><span class="tok-n">label</span><span class="tok-o">,</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span>
                      <span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'XYZ'</span><span class="tok-o">,</span>
                      <span class="tok-s1">'icao'</span><span class="tok-o">,</span><span class="tok-s1">'KXYZ'</span><span class="tok-o">,</span>
                      <span class="tok-s1">'desc'</span><span class="tok-o">,</span><span class="tok-s1">'This is not a real airport'</span><span class="tok-o">)</span>

<span class="tok-c1">// Find the DFW vertex</span>
<span class="tok-n">dfw</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span>

<span class="tok-c1">// Create a route from our new airport to DFW</span>
<span class="tok-n">xyz</span><span class="tok-o">.</span><span class="tok-na">addEdge</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">,</span><span class="tok-n">dfw</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In many cases it is more convenient, and also recommended, to perform each of the
previous operations using just the traversal object <em>g</em>. The following example does
just that. We first create a new airport vertex for our imaginary airport and store
its vertex in the variable <em>xyz</em>. We can then use that stored value when we create
the edge also using a traversal. As with many parts of the Gremlin language, there is
more than one way to achieve the same results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Add an imaginary airport with a code of 'XYZ' and connect it to DFW</span>
<span class="tok-n">xyz</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">addV</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'XYZ'</span><span class="tok-o">).</span>
                        <span class="tok-n">property</span><span class="tok-o">(</span><span class="tok-s1">'icao'</span><span class="tok-o">,</span><span class="tok-s1">'KXYZ'</span><span class="tok-o">).</span>
                        <span class="tok-n">property</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">,</span><span class="tok-s1">'This is not a real airport'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice, in the code above, how each property step can be chained to the previous one
when adding multiple properties. Whether you need to do it while creating a vertex or
to add and edit properties on a vertex at a later date you can use the same <em>property</em>
step.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is strongly recommended that the traversal source object <em>g</em> be used when
adding, updating or deleting vertices and edges. Using the <em>graph</em> object directly is
not viewed as a TinkerPop best practice.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>We can now add a route from DFW to XYZ. We are able
to use our <em>xyz</em> variable to specify the destination of the new route using a <em>to</em>
step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Add a route from DFW to XYZ</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">addE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-n">xyz</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could have written the previous line to use a second <em>V()</em> step if we had not
previously saved anything in a variable. Note that while this use of a second <em>V()</em>
step will work locally, if you are sending queries to a Gremlin Server (a topic we
will discuss later in this book) this syntax is not supported and will not work.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">addE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'XYZ'</span><span class="tok-o">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We might also want to add a returning route from XYZ back to DFW. We can do this
using the <em>from</em> step in a similar way as we used the <em>to</em> step above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Add the return route back to DFW</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">addE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-n">xyz</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Another way that we could have chosen to create our edge involves labelling the "XYZ"
vertex using an <code>as</code> step. The example below demonstrates this. Notice also how a <em>V</em>
step is used to start a new traversal midway through the current one. The label
created using the <code>as</code> step is used to instruct the <code>to</code> step about the target vertex
for the new edge.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'XYZ'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">addE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In earlier versions of Apache TinkerPop there was an <code>addOutE</code> step. That step
has since been deprecated and removed from the language in favor of always using
<code>addE</code>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>You will see a bigger example that uses <em>as</em> steps while creating vertices and edges
in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#testgraph">Quickly building a graph for testing</a>" section that is coming up soon.</p>
</div>
</div>
<div class="sect3">
<h4 id="addlabeldynamic">4.5.2. Using a traversal to determine a new label name</h4>
<div class="paragraph">
<p>In TinkerPop 3.3.1 a new capability was added to the <em>addV</em> and <em>addE</em> steps. This
new capability allows us to use a traversal to determine what the label used by a new
vertex or edge should be. Take a look at the query below. We have seen this type of
query used earlier in the book. It simply tells us what label the vertex representing
the Austin (AUS) airport has.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">label</span><span class="tok-o">()</span>

<span class="tok-n">airport</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>What the new capability added in TinkerPop 3.3.1 allows us to do is include the
traversal above inside of an <em>addV</em> step as shown below. The first string result
returned by the provided traversal will be used as the label name.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">addV</span><span class="tok-o">(</span><span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">label</span><span class="tok-o">()).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'XYZ'</span><span class="tok-o">)</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">53768</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can inspect the new vertex using <em>valueMap</em> to make sure that our label was
correctly assigned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">53768</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">53768</span><span class="tok-o">,</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">XYZ</span><span class="tok-o">],</span><span class="tok-nl">label:</span><span class="tok-n">airport</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
These features require that the graph database system you are using supports
a TinkerPop version of 3.3.1 or higher.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>We can now do something similar to dynamically work out what the label should be for
an edge between our new airport and Austin.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">53768</span><span class="tok-o">).</span><span class="tok-na">addE</span><span class="tok-o">(</span><span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">label</span><span class="tok-o">()).</span>
           <span class="tok-n">to</span><span class="tok-o">(</span><span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">))</span>

<span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">53770</span><span class="tok-o">][</span><span class="tok-mi">53768</span><span class="tok-o">-</span><span class="tok-n">route</span><span class="tok-o">-&gt;</span><span class="tok-mi">3</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Later in the book we will build upon these concepts to show how the property
keys and values from one vertex, as well as the label, can be copied into a new
vertex using a single query.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Once again, we can use a <em>valueMap</em> step to make sure our new edge label looks OK.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">(</span><span class="tok-mi">53770</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">53770</span><span class="tok-o">,</span><span class="tok-nl">label:</span><span class="tok-n">route</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="proptraversal">4.5.3. Using a traversal to seed a property with a list</h4>
<div class="paragraph">
<p>You can use the results of a traversal to create or update properties. The example
below creates a new property called <em>places</em> for the Austin airport vertex. The
values of the property are the results of finding all of the places that you can
travel to from that airport and folding their <em>code</em> values into a list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Add a list as a property value</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'places'</span><span class="tok-o">,</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use a <em>valueMap</em> step to make sure the property was created as we expected it
to be. As you can see a new property called <em>places</em> has been created containing as
its value a list of codes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'places'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">places:</span><span class="tok-o">[[</span><span class="tok-n">YYZ</span><span class="tok-o">,</span> <span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-n">FRA</span><span class="tok-o">,</span> <span class="tok-n">MEX</span><span class="tok-o">,</span> <span class="tok-n">PIT</span><span class="tok-o">,</span> <span class="tok-n">PDX</span><span class="tok-o">,</span> <span class="tok-n">CLT</span><span class="tok-o">,</span> <span class="tok-n">CUN</span><span class="tok-o">,</span> <span class="tok-n">MEM</span><span class="tok-o">,</span> <span class="tok-n">CVG</span><span class="tok-o">,</span> <span class="tok-n">IND</span><span class="tok-o">,</span> <span class="tok-n">MCI</span><span class="tok-o">,</span> <span class="tok-n">DAL</span><span class="tok-o">,</span> <span class="tok-n">STL</span><span class="tok-o">,</span> <span class="tok-n">ABQ</span><span class="tok-o">,</span> <span class="tok-n">MDW</span><span class="tok-o">,</span> <span class="tok-n">LBB</span><span class="tok-o">,</span> <span class="tok-n">HRL</span><span class="tok-o">,</span> <span class="tok-n">GDL</span><span class="tok-o">,</span> <span class="tok-n">PNS</span><span class="tok-o">,</span> <span class="tok-n">VPS</span><span class="tok-o">,</span> <span class="tok-n">SFB</span><span class="tok-o">,</span> <span class="tok-n">BKG</span><span class="tok-o">,</span> <span class="tok-n">PIE</span><span class="tok-o">,</span> <span class="tok-n">ATL</span><span class="tok-o">,</span> <span class="tok-n">BNA</span><span class="tok-o">,</span> <span class="tok-n">BOS</span><span class="tok-o">,</span> <span class="tok-n">BWI</span><span class="tok-o">,</span> <span class="tok-n">DCA</span><span class="tok-o">,</span> <span class="tok-n">DFW</span><span class="tok-o">,</span> <span class="tok-n">FLL</span><span class="tok-o">,</span> <span class="tok-n">IAD</span><span class="tok-o">,</span> <span class="tok-n">IAH</span><span class="tok-o">,</span> <span class="tok-n">JFK</span><span class="tok-o">,</span> <span class="tok-n">LAX</span><span class="tok-o">,</span> <span class="tok-n">MCO</span><span class="tok-o">,</span> <span class="tok-n">MIA</span><span class="tok-o">,</span> <span class="tok-n">MSP</span><span class="tok-o">,</span> <span class="tok-n">ORD</span><span class="tok-o">,</span> <span class="tok-n">PHX</span><span class="tok-o">,</span> <span class="tok-n">RDU</span><span class="tok-o">,</span> <span class="tok-n">SEA</span><span class="tok-o">,</span> <span class="tok-n">SFO</span><span class="tok-o">,</span> <span class="tok-n">SJC</span><span class="tok-o">,</span> <span class="tok-n">TPA</span><span class="tok-o">,</span> <span class="tok-n">SAN</span><span class="tok-o">,</span> <span class="tok-n">LGB</span><span class="tok-o">,</span> <span class="tok-n">SNA</span><span class="tok-o">,</span> <span class="tok-n">SLC</span><span class="tok-o">,</span> <span class="tok-n">LAS</span><span class="tok-o">,</span> <span class="tok-n">DEN</span><span class="tok-o">,</span> <span class="tok-n">MSY</span><span class="tok-o">,</span> <span class="tok-n">EWR</span><span class="tok-o">,</span> <span class="tok-n">HOU</span><span class="tok-o">,</span> <span class="tok-n">ELP</span><span class="tok-o">,</span> <span class="tok-n">CLE</span><span class="tok-o">,</span> <span class="tok-n">OAK</span><span class="tok-o">,</span> <span class="tok-n">PHL</span><span class="tok-o">,</span> <span class="tok-n">DTW</span><span class="tok-o">]]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To gain access to these values from your code or Gremlin console queries, we can use
the <em>next</em> step. A simple example is given below where <em>values</em> is used to retrieve
the values of the <em>places</em> property and then we use <em>size</em> to see how many entries
there are in the list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'places'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">().</span><span class="tok-na">size</span><span class="tok-o">()</span>

<span class="tok-mi">59</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once we have access to the list of values we can access them using the normal Groovy
array syntax. The example below returns the three values with an index between 2 and
4.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'places'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()[</span><span class="tok-mi">2</span><span class="tok-o">..</span><span class="tok-mi">4</span><span class="tok-o">]</span>

<span class="tok-n">FRA</span>
<span class="tok-n">MEX</span>
<span class="tok-n">PIT</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="injectid">4.5.4. Using <em>inject</em> to specify new vertex ID values</h4>
<div class="paragraph">
<p>If the graph database you are using supports user provided ID values, you can use an
<em>inject</em> step as one way to specify what you want the ID value of a new vertex to be.
For example consider the example below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">inject</span><span class="tok-o">(</span><span class="tok-mi">99999L</span><span class="tok-o">).</span><span class="tok-na">addV</span><span class="tok-o">().</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-o">,</span><span class="tok-n">identity</span><span class="tok-o">())</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">99999</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also specify more than one ID value if you want to create multiple vertices.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">inject</span><span class="tok-o">(</span><span class="tok-mi">99997L</span><span class="tok-o">,</span><span class="tok-mi">99998L</span><span class="tok-o">).</span><span class="tok-na">addV</span><span class="tok-o">().</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-o">,</span><span class="tok-n">identity</span><span class="tok-o">())</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">99997</span><span class="tok-o">]</span>
<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">99998</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I chose to show use of <em>inject</em> as it provides an interesting example. However, it is
not required to create new IDs in this way. Both of the examples below are also valid
ways to do the same thing. The first example just uses a literal value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">addV</span><span class="tok-o">().</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-o">,</span><span class="tok-mi">99999L</span><span class="tok-o">)</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">99999</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively we could pass in a variable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">n</span><span class="tok-o">=</span><span class="tok-mi">99999L</span><span class="tok-o">;</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">addV</span><span class="tok-o">().</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-o">,</span><span class="tok-n">n</span><span class="tok-o">)</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">99999</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Remember that these methods of specifying an ID value will only work if the
graph database that you are using allows you to specify your own ID values. This
varies by graph database implementation and you should check the documentation for
the system you are using before assuming that you can create your own custom ID
values.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Even if the graph database that you are using does support user provided ID values
you should check to see what data types can be used for them. All of the examples
above used LONG values. However, as one example, some graph databases that do allow
you to specify custom IDs only support String values. So the key thing is to check
the documentation before you start building your graph.</p>
</div>
<div class="paragraph">
<p>Even if a graph database does support custom ID values, if you try to create a vertex
using an ID that already exists the operation will fail. The example below shows what
happens when we try to add a vertex using an ID that already exists to a TinkerGraph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">inject</span><span class="tok-o">(</span><span class="tok-mi">99999L</span><span class="tok-o">).</span><span class="tok-na">addV</span><span class="tok-o">().</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-o">,</span><span class="tok-n">identity</span><span class="tok-o">())</span>

<span class="tok-n">Vertex</span> <span class="tok-n">with</span> <span class="tok-n">id</span> <span class="tok-n">already</span> <span class="tok-nl">exists:</span> <span class="tok-mi">99999</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="testgraph">4.5.5. Quickly building a graph for testing</h4>
<div class="paragraph">
<p>Sometimes for testing and for when you want to report a problem or ask for help on a
mailing list it is handy to have a small standalone graph that you can use. The code
below will create a mini version of the air routes graph in the Gremlin Console. Note
how all of the vertices and edges are created in a single query with each step joined
together.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">graph</span><span class="tok-o">=</span><span class="tok-n">TinkerGraph</span><span class="tok-o">.</span><span class="tok-na">open</span><span class="tok-o">()</span>
<span class="tok-n">g</span><span class="tok-o">=</span><span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">()</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">addV</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'aus'</span><span class="tok-o">).</span>
  <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">).</span>
  <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LAX'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'lax'</span><span class="tok-o">).</span>
  <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'JFK'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'jfk'</span><span class="tok-o">).</span>
  <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'ATL'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'atl'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'aus'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'aus'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'atl'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'atl'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'atl'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'jfk'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'jfk'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'lax'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'lax'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'jfk'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'lax'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'aus'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'lax'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The form of <em>addV</em> that used to allow creation of a vertex and a property using
something like <em>g.addV(label,"airport","code","AUS")</em> is now deprecated and should
not be used.
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="addloop">4.5.6. Adding vertices and edges using a loop</h4>
<div class="paragraph">
<p>Sometimes it is more efficient to define the details of the vertices or edges that
you plan to add to the graph in an array and then add each vertex or edge using a
simple <em>for</em> loop that iterates over it. The following example adds our
imaginary airports directly to the graph using such a loop. Notice that we do
not have to specify the ID that we want each vertex to have. The graph will
assign a unique ID to each new vertex for us.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">vertices</span> <span class="tok-o">=</span> <span class="tok-o">[[</span><span class="tok-s2">"WYZ"</span><span class="tok-o">,</span><span class="tok-s2">"KWYZ"</span><span class="tok-o">],[</span><span class="tok-s2">"XYZ"</span><span class="tok-o">,</span><span class="tok-s2">"KXYZ"</span><span class="tok-o">]]</span>
<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">a</span> <span class="tok-k">in</span> <span class="tok-n">vertices</span><span class="tok-o">)</span> <span class="tok-o">{</span><span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">addVertex</span><span class="tok-o">(</span><span class="tok-n">label</span><span class="tok-o">,</span><span class="tok-s2">"airport"</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">,</span><span class="tok-n">a</span><span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">],</span><span class="tok-s2">"iata"</span><span class="tok-o">,</span><span class="tok-n">a</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">])}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could also have added the vertices using the traversal object <em>g</em> as follows. Notice
the call to <em>next()</em>. Without this the vertex creation will not work as expected.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">vertices</span> <span class="tok-o">=</span> <span class="tok-o">[[</span><span class="tok-s2">"WYZ"</span><span class="tok-o">,</span><span class="tok-s2">"KWYZ"</span><span class="tok-o">],[</span><span class="tok-s2">"XYZ"</span><span class="tok-o">,</span><span class="tok-s2">"KXYZ"</span><span class="tok-o">]]</span>
<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">a</span> <span class="tok-k">in</span> <span class="tok-n">vertices</span><span class="tok-o">)</span> <span class="tok-o">{</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">addV</span><span class="tok-o">(</span><span class="tok-s2">"airport"</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s2">"code"</span><span class="tok-o">,</span><span class="tok-n">a</span><span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">],</span><span class="tok-s2">"iata"</span><span class="tok-o">,</span><span class="tok-n">a</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">]).</span><span class="tok-na">next</span><span class="tok-o">()}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This technique of creating vertices and/or edges using a <em>for</em> loop can also be useful
when working with graphs remotely over HTTP connections. It is a very convenient way
to combine a set of creation steps into a single REST API call.</p>
</div>
<div class="paragraph">
<p>If you prefer a more Groovy like syntax you can also do this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">vertices</span> <span class="tok-o">=</span> <span class="tok-o">[[</span><span class="tok-s2">"WYZ"</span><span class="tok-o">,</span><span class="tok-s2">"KWYZ"</span><span class="tok-o">],[</span><span class="tok-s2">"XYZ"</span><span class="tok-o">,</span><span class="tok-s2">"KXYZ"</span><span class="tok-o">]]</span>
<span class="tok-n">vertices</span><span class="tok-o">.</span><span class="tok-na">each</span> <span class="tok-o">{</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">addV</span><span class="tok-o">(</span><span class="tok-s2">"airport"</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s2">"code"</span><span class="tok-o">,</span><span class="tok-n">it</span><span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">],</span><span class="tok-s2">"iata"</span><span class="tok-o">,</span><span class="tok-n">it</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">]).</span><span class="tok-na">next</span><span class="tok-o">()}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="coaladdv">4.5.7. Using <em>coalesce</em> to only add a vertex if it does not exist</h4>
<div class="paragraph">
<p>In the <a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#coalconst">Combining <em>coalesce</em> with a <em>constant</em> value</a> section we looked at how coalesce could be used to return a
constant value if the other entities that we were looking for did not exist. We can
reuse that pattern to produce a traversal that will only add a vertex to the graph if
that vertex has not already been created.</p>
</div>
<div class="paragraph">
<p>Let’s assume we wanted to add a new airport, with the code <em>"XYZ"</em> but we are not
sure if the airport might have already been added.</p>
</div>
<div class="paragraph">
<p>We can check to see if the airport exists, using a basic <em>has</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'XYZ'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If it does not exist yet, which in this case it does not, noting will be returned. We
could go one step further and change the query to return an empty list <em>[]</em> if the
airport does not exist by adding a <em>fold</em> step to the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'XYZ'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have a query that can return an empty list if a vertex does not exist we
can take advantage of this in a <em>coalesce</em> step. The query below looks to see if the
airport already exists and passes the result of that into a <em>coalesce</em> step.
Remember, <em>coalesce</em> will return the result of the first traversal it looks at that
returns a good result. We can make the first parameter passed to <em>coalesce</em> and
<em>unfold</em> step. This way in the case where the airport does not exist, <em>unfold</em> will
return nothing and so <em>coalesce</em> will attempt the second step. In this case our
second step creates a vertex for the airport <em>"XYZ"</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'XYZ'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">().</span><span class="tok-na">coalesce</span><span class="tok-o">(</span><span class="tok-n">unfold</span><span class="tok-o">(),</span><span class="tok-n">addV</span><span class="tok-o">().</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'XYZ'</span><span class="tok-o">))</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">53865</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the query above created a new vertex with an ID of <em>53865</em> as the
<em>XYZ</em> airport did not already exist. However, if we run the same query again, notice
that we get the same vertex back that we just created and not a new one. This is
because this time, the <em>coalesce</em> step <strong>does</strong> find a result from the <em>unfold</em> step
and so completed before attempting the <em>addV</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'XYZ'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">().</span><span class="tok-na">coalesce</span><span class="tok-o">(</span><span class="tok-n">unfold</span><span class="tok-o">(),</span><span class="tok-n">addV</span><span class="tok-o">().</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'XYZ'</span><span class="tok-o">))</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">53865</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="upsert">4.5.8. Using <em>coalesce</em> to derive an <em>upsert</em> pattern</h4>
<div class="paragraph">
<p>Using <em>coalesce</em> in this way provides us with a nice pattern for a commonly performed
task of checking to see if something already exists before we try to update it and
otherwise create it. This is often called an <em>"upsert"</em> pattern as the operation
potentially updates or inserts a vertex based on its existence or not.</p>
</div>
<div class="paragraph">
<p>The query below is perhaps a better example of an <em>"upsert"</em>. The query looks to
see if the vertex with an ID of 3 already exists. If it does it updates the <em>runways</em>
property of that vertex be the value 3. If it does not exist it creates a new vertex and
the property. As vertex v[3] already exists that is what the query returns, having
first updated the <em>runways</em> property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">().</span>
       <span class="tok-n">coalesce</span><span class="tok-o">(</span><span class="tok-n">unfold</span><span class="tok-o">().</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">),</span>
       <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">))</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we now examine the properties of the vertex v[3] we can see that the <em>runways</em>
value has been set to 3.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">().</span><span class="tok-na">unfold</span><span class="tok-o">()</span>

<span class="tok-n">country</span><span class="tok-o">=[</span><span class="tok-n">US</span><span class="tok-o">]</span>
<span class="tok-n">code</span><span class="tok-o">=[</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-n">longest</span><span class="tok-o">=[</span><span class="tok-mi">12250</span><span class="tok-o">]</span>
<span class="tok-n">city</span><span class="tok-o">=[</span><span class="tok-n">Austin</span><span class="tok-o">]</span>
<span class="tok-n">elev</span><span class="tok-o">=[</span><span class="tok-mi">542</span><span class="tok-o">]</span>
<span class="tok-n">icao</span><span class="tok-o">=[</span><span class="tok-n">KAUS</span><span class="tok-o">]</span>
<span class="tok-n">lon</span><span class="tok-o">=[-</span><span class="tok-mf">97.6698989868164</span><span class="tok-o">]</span>
<span class="tok-n">type</span><span class="tok-o">=[</span><span class="tok-n">airport</span><span class="tok-o">]</span>
<span class="tok-n">region</span><span class="tok-o">=[</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span><span class="tok-o">]</span>
<span class="tok-n">runways</span><span class="tok-o">=[</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-n">lat</span><span class="tok-o">=[</span><span class="tok-mf">30.1944999694824</span><span class="tok-o">]</span>
<span class="tok-n">desc</span><span class="tok-o">=[</span><span class="tok-n">Austin</span> <span class="tok-n">Bergstrom</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the air routes graph there is no vertex with an ID of 9999999. So if we rerun the
previous <em>"upsert"</em> query, this time a new vertex will be created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">9999999</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">().</span>
             <span class="tok-n">coalesce</span><span class="tok-o">(</span><span class="tok-n">unfold</span><span class="tok-o">().</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-s1">'3'</span><span class="tok-o">),</span>
             <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">))</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">57343</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we look at the <em>valueMap</em> for the new vertex we can see that it was created as we
would have expected.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">57343</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">().</span><span class="tok-na">unfold</span><span class="tok-o">()</span>

<span class="tok-n">runways</span><span class="tok-o">=[</span><span class="tok-mi">3</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This technique is currently the recommended way of doing <em>"upsert"</em> operations with
Gremlin.</p>
</div>
</div>
<div class="sect3">
<h4 id="vertexcopy">4.5.9. Creating one vertex based on another</h4>
<div class="paragraph">
<p>It is sometimes useful to be able to create a new vertex using the label and
properties from an existing vertex. We have already looked, in the
"<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#addlabeldynamic">Using a traversal to determine a new label name</a>" section, at some ways to create a new label using the value
of other labels but we have not yet looked at how to clone the properties from one
vertex onto another. A technique for doing that is discussed in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#dfwcopy">Making a copy of the DFW vertex</a>"
section. Feel free to skip ahead but be aware that the techniques used in that
section have not yet been fully covered so you may want to also take a look at some
other sections along the way.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="deleting">4.6. Deleting vertices, edges and properties</h3>
<div class="paragraph">
<p>So far in this book we have looked at several examples where we created new
vertices, edges and properties but we have not yet looked at how we can delete them.
Gremlin provides the <em>drop</em> step that we can use to remove things from a graph.</p>
</div>
<div class="sect3">
<h4 id="_deleting_a_vertex">4.6.1. Deleting a vertex</h4>
<div class="paragraph">
<p>In some of our earlier examples we created a fictitious airport vertex with a code of
<em>XYZ</em> and added it to the air routes graph. If we now wanted to delete it we could
use the following Gremlin code. Note that removing the vertex will also remove any
edges we created connected to that vertex.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Remove the XYZ vertex</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'XYZ'</span><span class="tok-o">).</span><span class="tok-na">drop</span><span class="tok-o">()</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="deledge">4.6.2. Deleting an edge</h4>
<div class="paragraph">
<p>We can also use <em>drop</em> to remove specific edges. The following code
will remove the flights, in both directions between AUS and LHR.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Remove the flight from AUS to LHR (both directions).</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">).</span><span class="tok-na">drop</span><span class="tok-o">()</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">).</span><span class="tok-na">drop</span><span class="tok-o">()</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="delprop">4.6.3. Deleting a property</h4>
<div class="paragraph">
<p>Lastly, we can use <em>drop</em> to delete a specific property value from a specific vertex.
Let’s start by querying the properties defined by the <em>air-routes</em> graph for the San
Francisco airport.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SFO'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-nl">country:</span><span class="tok-o">[</span><span class="tok-n">US</span><span class="tok-o">],</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">],</span><span class="tok-nl">longest:</span><span class="tok-o">[</span><span class="tok-mi">11870</span><span class="tok-o">],</span><span class="tok-nl">city:</span><span class="tok-o">[</span><span class="tok-n">San</span> <span class="tok-n">Francisco</span><span class="tok-o">],</span><span class="tok-nl">elev:</span><span class="tok-o">[</span><span class="tok-mi">13</span><span class="tok-o">],</span><span class="tok-nl">icao:</span><span class="tok-o">[</span><span class="tok-n">KSFO</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">122.375</span><span class="tok-o">],</span><span class="tok-nl">type:</span><span class="tok-o">[</span><span class="tok-n">airport</span><span class="tok-o">],</span><span class="tok-nl">region:</span><span class="tok-o">[</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">CA</span><span class="tok-o">],</span><span class="tok-nl">runways:</span><span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">37.6189994812012</span><span class="tok-o">],</span><span class="tok-nl">desc:</span><span class="tok-o">[</span><span class="tok-n">San</span> <span class="tok-n">Francisco</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s now drop the <em>desc</em> property and re-query the property values to prove that it has
been deleted.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SFO'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">).</span><span class="tok-na">drop</span><span class="tok-o">()</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SFO'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-nl">country:</span><span class="tok-o">[</span><span class="tok-n">US</span><span class="tok-o">],</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">],</span><span class="tok-nl">longest:</span><span class="tok-o">[</span><span class="tok-mi">11870</span><span class="tok-o">],</span><span class="tok-nl">city:</span><span class="tok-o">[</span><span class="tok-n">San</span> <span class="tok-n">Francisco</span><span class="tok-o">],</span><span class="tok-nl">elev:</span><span class="tok-o">[</span><span class="tok-mi">13</span><span class="tok-o">],</span><span class="tok-nl">icao:</span><span class="tok-o">[</span><span class="tok-n">KSFO</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">122.375</span><span class="tok-o">],</span><span class="tok-nl">type:</span><span class="tok-o">[</span><span class="tok-n">airport</span><span class="tok-o">],</span><span class="tok-nl">region:</span><span class="tok-o">[</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">CA</span><span class="tok-o">],</span><span class="tok-nl">runways:</span><span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">37.6189994812012</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we wanted to delete all of the properties currently associated with the SFO
airport vertex we could do that as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SFO'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">().</span><span class="tok-na">drop</span><span class="tok-o">()</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_removing_all_the_edges_or_vertices_in_the_graph">4.6.4. Removing all the edges or vertices in the graph</h4>
<div class="paragraph">
<p>This may not be something you want to do very often, but should you wish to remove
every edge in the graph you could do it, using the traversal object, <em>g</em>, as follows.
Note that for very large graphs this may not be the most efficient way of doing it
depending upon how the graph store handles this request.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Remove all the edges from the graph</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">().</span><span class="tok-na">drop</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You could also use the <em>graph</em> object to do this. The code below uses the graph
object to retrieve all of the edges and then iterates over them dropping them one by
one. Again for very large graphs this may not be an ideal approach as this requires
reading all of the edge definitions into memory. Note that in this case we call the
<em>remove</em> method rather than use <em>drop</em> as we are not using a graph traversal in this
case.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Remove all the edges from the graph</span>
<span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">edges</span><span class="tok-o">().</span><span class="tok-na">each</span><span class="tok-o">{</span><span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">remove</span><span class="tok-o">()}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You could also delete the whole graph, vertices and edges, by deleting all of the
vertices!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Delete the entire graph!</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">drop</span><span class="tok-o">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="pkvrevisited">4.7. Property keys and values revisited</h3>
<div class="paragraph">
<p>We have already looked, earlier in the book, at numerous queries that retrieve,
create or manipulate in some way the value of a given property. There are still
however a few things that we have not covered in any detail concerning properties.
Most of the property values we have looked at so far have been simple types such as a
String or an Integer. In this section we shall look more closely at properties and
explain how they can in fact be used to store lists and sets of values. We will also
introduce in this section the concept of a property ID.</p>
</div>
<div class="sect3">
<h4 id="vertexprop">4.7.1. The <em>Property</em> and <em>VertexProperty</em> interfaces</h4>
<div class="paragraph">
<p>In a TinkerPop 3 enabled graph, all properties are implementations of the <em>Property</em>
interface. Vertex properties implement the <em>VertexProperty</em> interface which itself
extends the <em>Property</em> interface. These interfaces are documented as part of the
Apache TinkerPop 3 JavaDoc. The interface defines the methods that you can use when
working with a vertex property object in your code. One important thing to note about
vertex properties is that they are immutable. You can create them but once created
they cannot be updated.</p>
</div>
<div class="paragraph">
<p>We will look more closely at the Java interfaces that TinkerPop 3 defines in the
"<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#javatinker">Working with TinkerGraph from a Java Application</a>" section a bit later in this book.</p>
</div>
<div class="paragraph">
<p>The VertexProperty interface does not define any "setter" methods
beyond the basic constructor itself. Your immediate reaction to this is likely to be
"but I know you can change a property’s value using the <em>property</em> step". Indeed we
have already discussed doing just that in this book. However, behind the scenes,
what actually happens when you change a property, is that a new property object is
created and used to replace the prior one. We will examine this more in a minute but
first let’s revisit a few of the basic concepts of properties.</p>
</div>
<div class="paragraph">
<p>In a <em>property graph</em> both vertices and edges can contain one or more properties. We
have already seen a query like the one below that retrieves the values from each of
the property keys associated with the DFW airport vertex.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">()</span>

<span class="tok-n">US</span>
<span class="tok-n">DFW</span>
<span class="tok-mi">13401</span>
<span class="tok-n">Dallas</span>
<span class="tok-mi">607</span>
<span class="tok-n">KDFW</span>
<span class="tok-o">-</span><span class="tok-mf">97.0380020141602</span>
<span class="tok-n">airport</span>
<span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span>
<span class="tok-mi">7</span>
<span class="tok-mf">32.896800994873</span>
<span class="tok-n">Dallas</span><span class="tok-o">/</span><span class="tok-n">Fort</span> <span class="tok-n">Worth</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>What we have not mentioned so far, however, is that the previous query is a shortened
form of this one.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">().</span><span class="tok-na">value</span><span class="tok-o">()</span>

<span class="tok-n">US</span>
<span class="tok-n">DFW</span>
<span class="tok-mi">13401</span>
<span class="tok-n">Dallas</span>
<span class="tok-mi">607</span>
<span class="tok-n">KDFW</span>
<span class="tok-o">-</span><span class="tok-mf">97.0380020141602</span>
<span class="tok-n">airport</span>
<span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span>
<span class="tok-mi">7</span>
<span class="tok-mf">32.896800994873</span>
<span class="tok-n">Dallas</span><span class="tok-o">/</span><span class="tok-n">Fort</span> <span class="tok-n">Worth</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we wanted to retrieve the VertexProperty (<em>vp</em>) objects for each of the properties
associated with the DFW vertex we could do that too. In a lot of cases it will be
sufficient just to use <em>values</em> or <em>valueMap</em> to access the values of one or more
properties but there are some cases, as we shall see when we look at property IDs,
where having access to the vertex property object itself is useful.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">()</span>

<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">country</span><span class="tok-o">-&gt;</span><span class="tok-n">US</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">code</span><span class="tok-o">-&gt;</span><span class="tok-n">DFW</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">longest</span><span class="tok-o">-&gt;</span><span class="tok-mi">13401</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">city</span><span class="tok-o">-&gt;</span><span class="tok-n">Dallas</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">elev</span><span class="tok-o">-&gt;</span><span class="tok-mi">607</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">icao</span><span class="tok-o">-&gt;</span><span class="tok-n">KDFW</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">lon</span><span class="tok-o">-&gt;-</span><span class="tok-mf">97.0380020141602</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">type</span><span class="tok-o">-&gt;</span><span class="tok-n">airport</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">region</span><span class="tok-o">-&gt;</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">runways</span><span class="tok-o">-&gt;</span><span class="tok-mi">7</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">lat</span><span class="tok-o">-&gt;</span><span class="tok-mf">32.896800994873</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">desc</span><span class="tok-o">-&gt;</span><span class="tok-n">Dallas</span><span class="tok-o">/</span><span class="tok-n">Fort</span> <span class="tok-n">Worth</span> <span class="tok-n">In</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We have already seen how each property on a vertex or edge is represented as a key
and value pair. If we wanted to retrieve a list of all of the property keys
associated with a given vertex we could write a query like the one below that finds all
of the property keys associated with the DFW vertex in the <em>air-routes</em> graph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">().</span><span class="tok-na">key</span><span class="tok-o">()</span>

<span class="tok-n">country</span>
<span class="tok-n">code</span>
<span class="tok-n">longest</span>
<span class="tok-n">city</span>
<span class="tok-n">elev</span>
<span class="tok-n">icao</span>
<span class="tok-n">lon</span>
<span class="tok-n">type</span>
<span class="tok-n">region</span>
<span class="tok-n">runways</span>
<span class="tok-n">lat</span>
<span class="tok-n">desc</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could likewise find the names, with duplicates removed, of any property keys
associated with any outgoing edges from the DFW vertex using this query. Note that edge
properties are implementations of <em>Property</em> and not <em>VertexProperty</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">properties</span><span class="tok-o">().</span><span class="tok-na">key</span><span class="tok-o">().</span><span class="tok-na">dedup</span><span class="tok-o">()</span>

<span class="tok-n">dist</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use the fact that we now know how to specifically reference both the key and
value parts of any property to construct a query like the one below that adds up the
total length of all the longest runway values and number of runways in the graph and
groups them by property key first and sum of the values second.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s2">"airport"</span><span class="tok-o">).</span>
      <span class="tok-n">properties</span><span class="tok-o">(</span><span class="tok-s2">"runways"</span><span class="tok-o">,</span><span class="tok-s2">"longest"</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">key</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">().</span><span class="tok-na">sum</span><span class="tok-o">())</span>

<span class="tok-o">[</span><span class="tok-nl">longest:</span><span class="tok-mi">25497644</span><span class="tok-o">,</span> <span class="tok-nl">runways:</span><span class="tok-mi">4816</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="propmap">4.7.2. The <em>propertyMap</em> traversal step</h4>
<div class="paragraph">
<p>We have previously used the <em>valueMap</em> step to produce a map of key/value pairs for
all of the properties associated with a vertex or edge. There is also a <em>propertyMap</em>
step that can be used that yields a similar result but the map includes the vertex
property objects for each property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">propertyMap</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the properties returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">country:</span><span class="tok-o">[</span><span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">country</span><span class="tok-o">-&gt;</span><span class="tok-n">US</span><span class="tok-o">]],</span> <span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">code</span><span class="tok-o">-&gt;</span><span class="tok-n">AUS</span><span class="tok-o">]],</span> <span class="tok-nl">longest:</span><span class="tok-o">[</span><span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">longest</span><span class="tok-o">-&gt;</span><span class="tok-mi">12250</span><span class="tok-o">]],</span> <span class="tok-nl">city:</span><span class="tok-o">[</span><span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">city</span><span class="tok-o">-&gt;</span><span class="tok-n">Austin</span><span class="tok-o">]],</span> <span class="tok-nl">lon:</span><span class="tok-o">[</span><span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">lon</span><span class="tok-o">-&gt;-</span><span class="tok-mf">97.6698989868164</span><span class="tok-o">]],</span> <span class="tok-nl">type:</span><span class="tok-o">[</span><span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">type</span><span class="tok-o">-&gt;</span><span class="tok-n">airport</span><span class="tok-o">]],</span> <span class="tok-nl">places:</span><span class="tok-o">[</span><span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">places</span><span class="tok-o">-&gt;[</span><span class="tok-n">YYZ</span><span class="tok-o">,</span> <span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-n">FRA</span><span class="tok-o">,</span> <span class="tok-n">MEX</span><span class="tok-o">,]],</span> <span class="tok-nl">elev:</span><span class="tok-o">[</span><span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">elev</span><span class="tok-o">-&gt;</span><span class="tok-mi">542</span><span class="tok-o">]],</span> <span class="tok-nl">icao:</span><span class="tok-o">[</span><span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">icao</span><span class="tok-o">-&gt;</span><span class="tok-n">KAUS</span><span class="tok-o">]],</span> <span class="tok-nl">region:</span><span class="tok-o">[</span><span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">region</span><span class="tok-o">-&gt;</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span><span class="tok-o">]],</span> <span class="tok-nl">runways:</span><span class="tok-o">[</span><span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">runways</span><span class="tok-o">-&gt;</span><span class="tok-mi">2</span><span class="tok-o">]],</span> <span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">lat</span><span class="tok-o">-&gt;</span><span class="tok-mf">30.1944999694824</span><span class="tok-o">]],</span> <span class="tok-nl">desc:</span><span class="tok-o">[</span><span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">desc</span><span class="tok-o">-&gt;</span><span class="tok-n">Austin</span> <span class="tok-n">Bergstrom</span> <span class="tok-n">Int</span><span class="tok-o">]]]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="propid">4.7.3. Properties have IDs too</h4>
<div class="paragraph">
<p>We have seen many examples already that show how both vertices and edges have a unique
ID. What may not have been obvious however is that properties also have an ID. Unlike
vertex and edge IDs property IDs are not guaranteed to be unique across the graph.
Certainly with TinkerGraph I have encountered cases where a vertex and a property
share the same ID. This is not really an issue because they are used in different
ways to access their associated graph element.</p>
</div>
<div class="paragraph">
<p>The query below returns the vertex property object (vp) for any property in the graph
that has a value of <em>London</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">properties</span><span class="tok-o">().</span><span class="tok-na">hasValue</span><span class="tok-o">(</span><span class="tok-s1">'London'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The query finds several London values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">city</span><span class="tok-o">-&gt;</span><span class="tok-n">London</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">city</span><span class="tok-o">-&gt;</span><span class="tok-n">London</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">city</span><span class="tok-o">-&gt;</span><span class="tok-n">London</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">city</span><span class="tok-o">-&gt;</span><span class="tok-n">London</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">city</span><span class="tok-o">-&gt;</span><span class="tok-n">London</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">city</span><span class="tok-o">-&gt;</span><span class="tok-n">London</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>At first glance, each of the values returned above looks identical. However, let’s
now query their ID values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">properties</span><span class="tok-o">().</span><span class="tok-na">hasValue</span><span class="tok-o">(</span><span class="tok-s1">'London'</span><span class="tok-o">).</span><span class="tok-na">id</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see each property has a different, and unique, ID.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-mi">583</span>
<span class="tok-mi">595</span>
<span class="tok-mi">1051</span>
<span class="tok-mi">1123</span>
<span class="tok-mi">2467</span>
<span class="tok-mi">7783</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use these ID values in other queries in the same way as we have for vertices
and edges in some of our earlier examples.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">properties</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-mi">583</span><span class="tok-o">)</span>

<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">city</span><span class="tok-o">-&gt;</span><span class="tok-n">London</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can query the value of this property as you would expect.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">properties</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-mi">583</span><span class="tok-o">).</span><span class="tok-na">value</span><span class="tok-o">()</span>

<span class="tok-n">London</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can retrieve the name of the property key as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">properties</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-mi">583</span><span class="tok-o">).</span><span class="tok-na">key</span><span class="tok-o">()</span>

<span class="tok-n">city</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could also have used <em>label</em> instead of <em>key</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">properties</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-mi">583</span><span class="tok-o">).</span><span class="tok-na">label</span><span class="tok-o">()</span>

<span class="tok-n">city</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also find out which element (vertex or edge) that this property belongs to.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">properties</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-mi">583</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">().</span><span class="tok-na">element</span><span class="tok-o">()</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">49</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also look at other property values of the element containing our property with
an ID of 583.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">properties</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-mi">583</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">().</span><span class="tok-na">element</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">)</span>

<span class="tok-n">London</span> <span class="tok-n">Heathrow</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Should you need to you can also find out which graph this property is part of. In
this case it is part of a TinkerGraph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">().</span><span class="tok-na">graph</span><span class="tok-o">()</span>

<span class="tok-n">tinkergraph</span><span class="tok-o">[</span><span class="tok-nl">vertices:</span><span class="tok-mi">3619</span> <span class="tok-nl">edges:</span><span class="tok-mi">50148</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To further show that each property has an ID the following code retrieves a list of
all the vertex properties associated with vertex <em>V(3)</em> and prints out the property
key along with its corresponding ID.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">p</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">().</span><span class="tok-na">toList</span><span class="tok-o">()</span>
<span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-na">each</span> <span class="tok-o">{</span><span class="tok-n">println</span> <span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">key</span> <span class="tok-o">+</span> <span class="tok-s2">"\t:"</span> <span class="tok-o">+</span> <span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">id</span><span class="tok-o">}</span>

<span class="tok-n">country</span> <span class="tok-o">:</span><span class="tok-mi">28</span>
<span class="tok-n">code</span>    <span class="tok-o">:</span><span class="tok-mi">29</span>
<span class="tok-n">longest</span> <span class="tok-o">:</span><span class="tok-mi">30</span>
<span class="tok-n">city</span>    <span class="tok-o">:</span><span class="tok-mi">31</span>
<span class="tok-n">elev</span>    <span class="tok-o">:</span><span class="tok-mi">32</span>
<span class="tok-n">icao</span>    <span class="tok-o">:</span><span class="tok-mi">33</span>
<span class="tok-n">lon</span>     <span class="tok-o">:</span><span class="tok-mi">34</span>
<span class="tok-n">type</span>    <span class="tok-o">:</span><span class="tok-mi">35</span>
<span class="tok-n">region</span>  <span class="tok-o">:</span><span class="tok-mi">36</span>
<span class="tok-n">runways</span> <span class="tok-o">:</span><span class="tok-mi">37</span>
<span class="tok-n">lat</span>     <span class="tok-o">:</span><span class="tok-mi">38</span>
<span class="tok-n">desc</span>    <span class="tok-o">:</span><span class="tok-mi">39</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you update a property, its ID value will also be changed as you have in
reality replaced the property with a new one which is allocated a new ID.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Take a look at the example below. First of all we query the ID of the <em>city</em> property
from vertex <em>V(4)</em>. Next we change its value to be <em>newname</em> and then query the
property ID again. Note that the ID has changed. As mentioned above, vertex
properties are immutable. When you update a property value using the <em>property</em> step,
a new property object is created that replaces the prior one.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">4</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">id</span><span class="tok-o">()</span>

<span class="tok-mi">43</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">4</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'newname'</span><span class="tok-o">)</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">4</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">id</span><span class="tok-o">()</span>

<span class="tok-mi">53361</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The fact that every property in a graph has an ID can improve performance of
accessing properties, especially in large graphs.</p>
</div>
</div>
<div class="sect3">
<h4 id="listprop">4.7.4. Attaching multiple values (lists or sets) to a single property</h4>
<div class="paragraph">
<p>A vertex property value can be a basic type such as a String or an Integer but it can
also be something more sophisticated such as a Set or a List containing multiple
values. You can think of these values as being an array but depending on how you
create them you have to work with them differently. In this section we will look at
how we can create multiple values for a single property key. Such values can be
setup when the vertex is first created or added afterwards. These more complex type of
property values are not supported on edges.</p>
</div>
<div class="paragraph">
<p>If we wanted to store the IATA and ICAO codes for the Austin airport in a list
associated with a single property rather than as separate properties we could have
created them when we created the Austin vertex follows. You can also add properties to
an existing vertex that have lists of values. We will look at how to do that later in
this section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">addV</span><span class="tok-o">().</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'KAUS'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The version of <em>addV</em> that allowed you to specify something like
<em>g.addV('code</em>,<em>AUS</em>,<em>code</em>,<em>KAUS</em>)' is now deprecated and should not be used.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>By creating the <em>code</em> property in this way, its cardinality type is now effectively
<em>LIST</em> rather than <em>SINGLE</em>. While working with TinkerGraph we do not need to setup
explicit schemas for our property types. However, once we start working with a more
sophisticated graph system such as JanusGraph, that is something that we will both
want and need to be able to do. We cover the topic of cardinality in detail in the
"<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#janusmgmt">The JanusGraph management API</a>" section later in the book.</p>
</div>
<div class="paragraph">
<p>Now that we have created the <em>code</em> property to have a list of values we can query
either one of the values in the list. If we look at the value map we get back from
the following example queries you can see both values in the list we associated with
the property <em>code</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">KAUS</span><span class="tok-o">]]</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'KAUS'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">KAUS</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>we can also query the values as normal.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">()</span>

<span class="tok-n">AUS</span>
<span class="tok-n">KAUS</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also use the <em>properties</em> step to get the result back as vertex properties
(vp). We discuss vertex properties in detail in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#vertexprop">The <em>Property</em> and <em>VertexProperty</em> interfaces</a>" section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">()</span>

<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">code</span><span class="tok-o">-&gt;</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">code</span><span class="tok-o">-&gt;</span><span class="tok-n">KAUS</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For completeness we could also do this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">properties</span><span class="tok-o">().</span><span class="tok-na">hasValue</span><span class="tok-o">(</span><span class="tok-s1">'AUS'</span><span class="tok-o">)</span>

<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">code</span><span class="tok-o">-&gt;</span><span class="tok-n">AUS</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="propertycaution">4.7.5. A word of caution - behavior differences with <em>property</em></h4>
<div class="paragraph">
<div class="title">Be aware!</div>
<p>There is a subtlety to be aware of when using <em>property</em>. What happens can vary
depending on the context in which it is used. Only when done as part of an <em>addV</em>
step immediately followed by multiple <em>property</em> steps using the same key value will
a list be created. Look at the two examples below. They do not produce the same
results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">addV</span><span class="tok-o">().</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'one'</span><span class="tok-o">,</span><span class="tok-s1">'hi'</span><span class="tok-o">).</span>
         <span class="tok-n">property</span><span class="tok-o">(</span><span class="tok-s1">'one'</span><span class="tok-o">,</span><span class="tok-s1">'hello'</span><span class="tok-o">).</span>
         <span class="tok-n">property</span><span class="tok-o">(</span><span class="tok-s1">'two'</span><span class="tok-o">,</span><span class="tok-s1">'goodbye'</span><span class="tok-o">).</span>
         <span class="tok-n">property</span><span class="tok-o">(</span><span class="tok-s1">'one'</span><span class="tok-o">,</span><span class="tok-s1">'hello again'</span><span class="tok-o">).</span>
         <span class="tok-n">valueMap</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-nl">one:</span><span class="tok-o">[</span><span class="tok-n">hi</span><span class="tok-o">,</span><span class="tok-n">hello</span><span class="tok-o">,</span><span class="tok-n">hello</span> <span class="tok-n">again</span><span class="tok-o">],</span><span class="tok-nl">two:</span><span class="tok-o">[</span><span class="tok-n">goodbye</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So our first query create a property with a key called <em>one</em> followed by a list
containing <em>[hi,hello,hello again]</em>. Let’s do the same test again but this time
create the vertex first and use an already created vertex to add properties to.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">v</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">addV</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-n">v</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'one'</span><span class="tok-o">,</span><span class="tok-s1">'hi'</span><span class="tok-o">).</span>
       <span class="tok-n">property</span><span class="tok-o">(</span><span class="tok-s1">'one'</span><span class="tok-o">,</span><span class="tok-s1">'hello'</span><span class="tok-o">).</span>
       <span class="tok-n">property</span><span class="tok-o">(</span><span class="tok-s1">'two'</span><span class="tok-o">,</span><span class="tok-s1">'goodbye'</span><span class="tok-o">).</span>
       <span class="tok-n">property</span><span class="tok-o">(</span><span class="tok-s1">'one'</span><span class="tok-o">,</span><span class="tok-s1">'hello again'</span><span class="tok-o">).</span>
       <span class="tok-n">valueMap</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-nl">one:</span><span class="tok-o">[</span><span class="tok-n">hello</span> <span class="tok-n">again</span><span class="tok-o">],</span><span class="tok-nl">two:</span><span class="tok-o">[</span><span class="tok-n">goodbye</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This time, as we were not creating the vertex as part of the same set of steps, the
behavior changes. Each time the property key of <em>one</em> is used the existing value is
replaced rather than being added as part of a list. I have seen this behavior cause
confusion more than once and it is something to be aware of! In the next section we
will ask Gremlin to explain this behavior to us!</p>
</div>
</div>
<div class="sect3">
<h4 id="explainstep">4.7.6. What did Gremlin do? - introducing <em>explain</em></h4>
<div class="paragraph">
<p>If you ever want to know how Gremlin compiles your query into a form that it is able
to execute you can ask it to tell you by adding an <em>explain</em> step to the end of your
query. The query will not execute, instead you will be shown how Gremlin decided to
optimize your query. It actually shows you all the choices it considered but in the
examples below I am just going to show the one it picked in each case.</p>
</div>
<div class="paragraph">
<p>So, thinking about our previous discussion of how <em>property</em> works differently
depending upon the context, if you were to use the <em>explain</em> step to have Gremlin
show us the way it is going to execute our query you can see clearly the difference
between the two forms. I have truncated the output to keep things simple.</p>
</div>
<div class="paragraph">
<p>Here is what Gremlin shows us for the first query when we use an <em>explain</em> step.
As you can see our query has been compiled into an <em>AddVertexStep</em> with two
properties one of which is a list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">addV</span><span class="tok-o">().</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'one'</span><span class="tok-o">,</span><span class="tok-s1">'hi'</span><span class="tok-o">).</span>
         <span class="tok-n">property</span><span class="tok-o">(</span><span class="tok-s1">'one'</span><span class="tok-o">,</span><span class="tok-s1">'hello'</span><span class="tok-o">).</span>
         <span class="tok-n">property</span><span class="tok-o">(</span><span class="tok-s1">'two'</span><span class="tok-o">,</span><span class="tok-s1">'goodbye'</span><span class="tok-o">).</span>
         <span class="tok-n">property</span><span class="tok-o">(</span><span class="tok-s1">'one'</span><span class="tok-o">,</span><span class="tok-s1">'hello again'</span><span class="tok-o">).</span>
         <span class="tok-n">explain</span><span class="tok-o">()</span>

<span class="tok-n">Final</span> <span class="tok-n">Traversal</span>    <span class="tok-o">[</span><span class="tok-n">AddVertexStartStep</span><span class="tok-o">({</span><span class="tok-n">one</span><span class="tok-o">=[</span><span class="tok-n">hi</span><span class="tok-o">,</span> <span class="tok-n">hello</span><span class="tok-o">,</span> <span class="tok-n">hello</span>
                      <span class="tok-n">again</span><span class="tok-o">],</span> <span class="tok-n">two</span><span class="tok-o">=[</span><span class="tok-n">goodbye</span><span class="tok-o">]})]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now if we look at the case where we have already created a vertex let’s see what
<em>explain</em> returns. What we find is that this time Gremlin has compiled our query to a
<em>TinkerGraphStep</em> and is handling each property one by one. This has the result that
each time the same key is reused, the previous value is replaced.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-n">v</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'one'</span><span class="tok-o">,</span><span class="tok-s1">'hi'</span><span class="tok-o">).</span>
       <span class="tok-n">property</span><span class="tok-o">(</span><span class="tok-s1">'one'</span><span class="tok-o">,</span><span class="tok-s1">'hello'</span><span class="tok-o">).</span>
       <span class="tok-n">property</span><span class="tok-o">(</span><span class="tok-s1">'two'</span><span class="tok-o">,</span><span class="tok-s1">'goodbye'</span><span class="tok-o">).</span>
       <span class="tok-n">property</span><span class="tok-o">(</span><span class="tok-s1">'one'</span><span class="tok-o">,</span><span class="tok-s1">'hello again'</span><span class="tok-o">).</span>
       <span class="tok-n">explain</span><span class="tok-o">()</span>

<span class="tok-n">Final</span> <span class="tok-n">Traversal</span>  <span class="tok-o">[</span><span class="tok-n">TinkerGraphStep</span><span class="tok-o">(</span><span class="tok-n">vertex</span><span class="tok-o">,[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">54800</span><span class="tok-o">]]),</span>
                    <span class="tok-n">AddPropertyStep</span><span class="tok-o">({</span><span class="tok-n">value</span><span class="tok-o">=[</span><span class="tok-n">hi</span><span class="tok-o">],</span> <span class="tok-n">key</span><span class="tok-o">=[</span><span class="tok-n">one</span><span class="tok-o">]}),</span>
                    <span class="tok-n">AddPropertyStep</span><span class="tok-o">({</span><span class="tok-n">value</span><span class="tok-o">=[</span><span class="tok-n">hello</span><span class="tok-o">],</span> <span class="tok-n">key</span><span class="tok-o">=[</span><span class="tok-n">one</span><span class="tok-o">]}),</span>
                    <span class="tok-n">AddPropertyStep</span><span class="tok-o">({</span><span class="tok-n">value</span><span class="tok-o">=[</span><span class="tok-n">goodbye</span><span class="tok-o">],</span> <span class="tok-n">key</span><span class="tok-o">=[</span><span class="tok-n">two</span><span class="tok-o">]}</span>
                    <span class="tok-o">),</span> <span class="tok-n">AddPropertyStep</span><span class="tok-o">({</span><span class="tok-n">value</span><span class="tok-o">=[</span><span class="tok-n">hello</span> <span class="tok-n">again</span><span class="tok-o">],</span> <span class="tok-n">key</span><span class="tok-o">=[</span><span class="tok-n">one</span><span class="tok-o">]})]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you need to work with properties and treat them as lists once the vertex has been
created, you need to explicitly add the <em>list</em> keyword as part of the <em>property</em> step
as we shall see in the next section.</p>
</div>
</div>
<div class="sect3">
<h4 id="updatelist">4.7.7. Updating properties stored in a list</h4>
<div class="paragraph">
<p>So now we know how to create a vertex with property values in a list we need a way to
update those properties. We can do this using a special form of the <em>property</em> step
where the first parameter is <em>list</em> to show that what follows are updates to the
existing list and not replacements for the whole list.</p>
</div>
<div class="paragraph">
<p>The example below adds another code that is sometimes used when talking about the
Austin airport to our list of codes. If we left off the <em>list</em> parameter the whole
property would be overwritten with a value of <em>ABIA</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-n">list</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'ABIA'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we query the properties again we can see that there are now three values for the
<em>code</em> property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">()</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">code</span><span class="tok-o">-&gt;</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">code</span><span class="tok-o">-&gt;</span><span class="tok-n">KAUS</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">code</span><span class="tok-o">-&gt;</span><span class="tok-n">ABIA</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can observe the same thing by looking at our <em>valueMap</em> results again.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">()</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">KAUS</span><span class="tok-o">,</span><span class="tok-n">ABIA</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we want to delete one of the properties from the list we can do it using <em>drop</em>.
If we look the value map after dropping <em>ABIA</em> we can indeed see that it is gone from
the list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">().</span><span class="tok-na">hasValue</span><span class="tok-o">(</span><span class="tok-s1">'ABIA'</span><span class="tok-o">).</span><span class="tok-na">drop</span><span class="tok-o">()</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">()</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">KAUS</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we want to drop an entire property containing one or more values we can do it as
follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">drop</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To add multiple values to the same property key in the same query we just need to
chain the <em>property</em> steps together as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">property</span><span class="tok-o">(</span><span class="tok-n">list</span><span class="tok-o">,</span><span class="tok-s1">'desc'</span><span class="tok-o">,</span><span class="tok-s1">'Austin Airport'</span><span class="tok-o">).</span>
      <span class="tok-n">property</span><span class="tok-o">(</span><span class="tok-n">list</span><span class="tok-o">,</span><span class="tok-s1">'desc'</span><span class="tok-o">,</span><span class="tok-s1">'Bergstrom'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This technique can be used to update an existing property that already has a list
of values or to add a new property with a list of values.</p>
</div>
<div class="paragraph">
<p>The same value can appear more than once with a property that has LIST cardinality.
The code fragment below creates a new vertex, with some duplicate values associated
with the <em>dups</em> property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">addV</span><span class="tok-o">(</span><span class="tok-s1">'test'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'dups'</span><span class="tok-o">,</span><span class="tok-s1">'one'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'dups'</span><span class="tok-o">,</span><span class="tok-s1">'two'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'dups'</span><span class="tok-o">,</span><span class="tok-s1">'one'</span><span class="tok-o">)</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'test'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-nl">dups:</span><span class="tok-o">[</span><span class="tok-n">one</span><span class="tok-o">,</span><span class="tok-n">two</span><span class="tok-o">,</span><span class="tok-n">one</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can add additional duplicate values after the vertex has been created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'test'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-n">list</span><span class="tok-o">,</span><span class="tok-s1">'dups'</span><span class="tok-o">,</span><span class="tok-s1">'two'</span><span class="tok-o">)</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'test'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-nl">dups:</span><span class="tok-o">[</span><span class="tok-n">one</span><span class="tok-o">,</span><span class="tok-n">two</span><span class="tok-o">,</span><span class="tok-n">one</span><span class="tok-o">,</span><span class="tok-n">two</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="propsets">4.7.8. Creating properties that store sets</h4>
<div class="paragraph">
<p>So far we have just created values in a list that have <em>LIST</em> cardinality which means
that duplicate values are allowed. If we wanted to prevent that from
happening we can use the <em>set</em> keyword when adding properties to force a cardinality
of <em>SET</em>.</p>
</div>
<div class="paragraph">
<p>In the example below we create a new property called <em>hw</em> for vertex <em>V(3)</em> with
multiple values but using the <em>set</em> keyword rather than the <em>list</em> keyword that we
have used previously. We then look at the valueMap for the <em>hw</em> property to check
that inded our set was created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-n">set</span><span class="tok-o">,</span><span class="tok-s1">'hw'</span><span class="tok-o">,</span><span class="tok-s1">'hello'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-n">set</span><span class="tok-o">,</span><span class="tok-s1">'hw'</span><span class="tok-o">,</span><span class="tok-s1">'world'</span><span class="tok-o">)</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'hw'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">hw:</span><span class="tok-o">[</span><span class="tok-n">hello</span><span class="tok-o">,</span><span class="tok-n">world</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s now test that our set is really working as a set by adding a couple of
additional values. Note that we have already added the value <em>hello</em> in the prior
steps so with the cardinality being <em>SET</em> we expect that value to be ignored as there
is already a value of <em>hello</em> in the set. We again display the valueMap to prove that
the set only has unique values in it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-n">set</span><span class="tok-o">,</span><span class="tok-s1">'hw'</span><span class="tok-o">,</span><span class="tok-s1">'hello'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-n">set</span><span class="tok-o">,</span><span class="tok-s1">'hw'</span><span class="tok-o">,</span><span class="tok-s1">'apple'</span><span class="tok-o">)</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'hw'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">hw:</span><span class="tok-o">[</span><span class="tok-n">hello</span><span class="tok-o">,</span><span class="tok-n">world</span><span class="tok-o">,</span><span class="tok-n">apple</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="setlistnote">4.7.9. One more note about sets and lists</h4>
<div class="paragraph">
<p>Note that the other examples we have shown in this section are not the same as just
adding a list directly as a property value. In the example below the entire list is
treated as a single value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'x'</span><span class="tok-o">,[</span><span class="tok-s1">'AAAA'</span><span class="tok-o">,</span><span class="tok-s1">'BBBB'</span><span class="tok-o">])</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'x'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">x:</span><span class="tok-o">[[</span><span class="tok-n">AAAA</span><span class="tok-o">,</span><span class="tok-n">BBBB</span><span class="tok-o">]]]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="metaprop">4.7.10. Adding properties to other properties (meta properties)</h4>
<div class="paragraph">
<p>TinkerPop 3 introduced the ability to add a property to another property. Think of
this in a way as being able to add a bit of metadata about a property to the property
itself. This capability, not surprisingly, is often referred to as <em>"adding a meta
property to a property"</em>. There are a number of use cases where this capability can
be extremely useful. Common ones might be adding a date that a property was last
updated or perhaps adding access control information to a property.</p>
</div>
<div class="paragraph">
<p>The example below adds a meta property with a key of <em>date</em> and a value of <em>6/6/2017</em>
to the property with a key of <em>code</em> and a value of <em>AUS</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">().</span><span class="tok-na">hasValue</span><span class="tok-o">(</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'date'</span><span class="tok-o">,</span><span class="tok-s1">'6/6/2017'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you wanted to add the date to the <em>code</em> property regardless of its current value,
then you could just do this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'date'</span><span class="tok-o">,</span><span class="tok-s1">'6/6/2017'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can retrieve all of the meta properties on a specific property, such as the <em>code</em>
property as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">()</span>

<span class="tok-n">p</span><span class="tok-o">[</span><span class="tok-n">date</span><span class="tok-o">-&gt;</span><span class="tok-mi">6</span><span class="tok-s">/6/</span><span class="tok-mi">2017</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to find all the properties associated with the AUS vertex that have a
meta property with a date of <em>6/6/2017</em> you can do that as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'date'</span><span class="tok-o">,</span><span class="tok-s1">'6/6/2017'</span><span class="tok-o">)</span>

<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">code</span><span class="tok-o">-&gt;</span><span class="tok-n">AUS</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can query for a specific meta property as follows, which will return any meta
properties that have a key of <em>date</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">().</span><span class="tok-na">hasValue</span><span class="tok-o">(</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">(</span><span class="tok-s1">'date'</span><span class="tok-o">)</span>

<span class="tok-n">p</span><span class="tok-o">[</span><span class="tok-n">date</span><span class="tok-o">-&gt;</span><span class="tok-mi">6</span><span class="tok-s">/6/</span><span class="tok-mi">2017</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can add multiple meta properties to a property while creating it. The following
will add a property called <em>comment</em> to vertex <em>V(3)</em> and also add two meta
properties to it representing the date the comment was made and who made it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'comment'</span><span class="tok-o">,</span><span class="tok-s1">'I like this airport'</span><span class="tok-o">,</span><span class="tok-s1">'date'</span><span class="tok-o">,</span><span class="tok-s1">'6/6/2017'</span><span class="tok-o">,</span><span class="tok-s1">'user'</span><span class="tok-o">,</span><span class="tok-s1">'Kelvin'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can query the graph to make sure everything worked as expected.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">(</span><span class="tok-s1">'comment'</span><span class="tok-o">)</span>

<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">Comment</span><span class="tok-o">-&gt;</span><span class="tok-n">I</span> <span class="tok-n">like</span> <span class="tok-k">this</span> <span class="tok-n">airport</span><span class="tok-o">]</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">(</span><span class="tok-s1">'comment'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">()</span>

<span class="tok-n">p</span><span class="tok-o">[</span><span class="tok-n">date</span><span class="tok-o">-&gt;</span><span class="tok-mi">6</span><span class="tok-s">/6/</span><span class="tok-mi">2017</span><span class="tok-o">]</span>
<span class="tok-n">p</span><span class="tok-o">[</span><span class="tok-n">user</span><span class="tok-o">-&gt;</span><span class="tok-n">Kelvin</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use <em>drop</em> to remove meta properties but take care when doing so.
Take a look at the query below, which looks like it might
drop the meta property <em>date</em>, but will in fact drop the whole vertex.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">().</span><span class="tok-na">hasValue</span><span class="tok-o">(</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'date'</span><span class="tok-o">,</span><span class="tok-s1">'6/6/2017'</span><span class="tok-o">).</span><span class="tok-na">drop</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To remove a single meta property we need to use drop in this way</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">(</span><span class="tok-s1">'date'</span><span class="tok-o">).</span><span class="tok-na">drop</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that you cannot chain meta properties together endlessly. The main properties on
a vertex are <em>VertexProperty</em> types. The meta property is a <em>Property</em> type and you
cannot add another property to those. You can however add more than one meta
property to the same vertex property.</p>
</div>
<div class="paragraph">
<p>So as mentioned above, the meta property provides a way to attach metadata to another
property. This enables a number of important use cases including being able to attach
a date or ACL information to individual properties.</p>
</div>
</div>
<div class="sect3">
<h4 id="tp34vmmetaprop">4.7.11. Using <em>unfold</em> and <em>WithOptions</em> with Meta Properties</h4>
<div class="paragraph">
<p>A new feature was introduced in Apache TinkerPop version 3.4 that allows us to more
easily include both properties and their meta properties in the result from a
<em>valueMap</em> step that follows a <em>properties</em> step.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
All of the possible values that can be specified using WithOptions can be found
in the official Apache TinkerPop JavaDoc documentation
<a href="http://tinkerpop.apache.org/javadocs/current/full/org/apache/tinkerpop/gremlin/process/traversal/step/util/WithOptions.html">at
this location</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>To use this new capability
requires that the graph database you are using has support for both meta properties
and TinkerPop version 3.4. The examples below build upon the examples shown in the
previous section.</p>
</div>
<div class="paragraph">
<p>First of all, we know how to inspect the properties present for any vertex using the
<em>properties</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">()</span>

<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">country</span><span class="tok-o">-&gt;</span><span class="tok-n">US</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">code</span><span class="tok-o">-&gt;</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">longest</span><span class="tok-o">-&gt;</span><span class="tok-mi">12250</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">city</span><span class="tok-o">-&gt;</span><span class="tok-n">Austin</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">elev</span><span class="tok-o">-&gt;</span><span class="tok-mi">542</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">icao</span><span class="tok-o">-&gt;</span><span class="tok-n">KAUS</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">lon</span><span class="tok-o">-&gt;-</span><span class="tok-mf">97.6698989868164</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">type</span><span class="tok-o">-&gt;</span><span class="tok-n">airport</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">region</span><span class="tok-o">-&gt;</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">runways</span><span class="tok-o">-&gt;</span><span class="tok-mi">2</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">lat</span><span class="tok-o">-&gt;</span><span class="tok-mf">30.1944999694824</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">desc</span><span class="tok-o">-&gt;</span><span class="tok-n">Austin</span> <span class="tok-n">Bergstrom</span> <span class="tok-o">...]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We also know how to look at the meta properties by following the <em>properties</em> step
with a <em>valueMap</em> step or a second <em>properties</em> step. However, a value is returned
only when a property has a meta property. For all other properties the result is
simply an empty list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">().</span><span class="tok-na">valueMap</span><span class="tok-o">()</span>

<span class="tok-o">[]</span>
<span class="tok-o">[</span><span class="tok-nl">date:</span><span class="tok-mi">6</span><span class="tok-s">/6/</span><span class="tok-mi">2017</span><span class="tok-o">]</span>
<span class="tok-o">[]</span>
<span class="tok-o">[]</span>
<span class="tok-o">[]</span>
<span class="tok-o">[]</span>
<span class="tok-o">[]</span>
<span class="tok-o">[]</span>
<span class="tok-o">[]</span>
<span class="tok-o">[]</span>
<span class="tok-o">[]</span>
<span class="tok-o">[]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the new <em>with</em> step and specifying options using <em>WithOptions</em> we can generate
a result from <em>valueMap</em> that includes the property values and their respective meta
properties. The example below generates a map containing the values for all
properties plus the key and value for any meta properties present.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">properties</span><span class="tok-o">().</span>
      <span class="tok-n">valueMap</span><span class="tok-o">().</span><span class="tok-na">with</span><span class="tok-o">(</span><span class="tok-n">WithOptions</span><span class="tok-o">.</span><span class="tok-na">tokens</span><span class="tok-o">,</span><span class="tok-n">WithOptions</span><span class="tok-o">.</span><span class="tok-na">values</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The values are shown for all properties but for the case where we have a <em>date</em>
meta property, that is also shown.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">value:</span><span class="tok-n">US</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">value:</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-nl">date:</span><span class="tok-mi">6</span><span class="tok-s">/6/</span><span class="tok-mi">2017</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">value:</span><span class="tok-mi">12250</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">value:</span><span class="tok-n">Austin</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">value:</span><span class="tok-mi">542</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">value:</span><span class="tok-n">KAUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">value:</span><span class="tok-o">-</span><span class="tok-mf">97.6698989868164</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">value:</span><span class="tok-n">airport</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">value:</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">value:</span><span class="tok-mi">2</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">value:</span><span class="tok-mf">30.1944999694824</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">value:</span><span class="tok-n">Austin</span> <span class="tok-n">Bergstrom</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly we could just decide to include the key names in the results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">properties</span><span class="tok-o">().</span>
      <span class="tok-n">valueMap</span><span class="tok-o">().</span><span class="tok-na">with</span><span class="tok-o">(</span><span class="tok-n">WithOptions</span><span class="tok-o">.</span><span class="tok-na">tokens</span><span class="tok-o">,</span><span class="tok-n">WithOptions</span><span class="tok-o">.</span><span class="tok-na">keys</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once again the key and value are shown for the <em>date</em> meta property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">key:</span><span class="tok-n">country</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">key:</span><span class="tok-n">code</span><span class="tok-o">,</span><span class="tok-nl">date:</span><span class="tok-mi">6</span><span class="tok-s">/6/</span><span class="tok-mi">2017</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">key:</span><span class="tok-n">longest</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">key:</span><span class="tok-n">city</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">key:</span><span class="tok-n">elev</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">key:</span><span class="tok-n">icao</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">key:</span><span class="tok-n">lon</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">key:</span><span class="tok-n">type</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">key:</span><span class="tok-n">region</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">key:</span><span class="tok-n">runways</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">key:</span><span class="tok-n">lat</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">key:</span><span class="tok-n">desc</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To include both the keys and the values in the result along with the meta properties,
<em>WithOptions.all</em> can be used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">properties</span><span class="tok-o">().</span>
      <span class="tok-n">valueMap</span><span class="tok-o">().</span><span class="tok-na">with</span><span class="tok-o">(</span><span class="tok-n">WithOptions</span><span class="tok-o">.</span><span class="tok-na">tokens</span><span class="tok-o">,</span><span class="tok-n">WithOptions</span><span class="tok-o">.</span><span class="tok-na">all</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that in this case, the ID for each property is also shown.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">28</span><span class="tok-o">,</span><span class="tok-nl">key:</span><span class="tok-n">country</span><span class="tok-o">,</span><span class="tok-nl">value:</span><span class="tok-n">US</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">29</span><span class="tok-o">,</span><span class="tok-nl">key:</span><span class="tok-n">code</span><span class="tok-o">,</span><span class="tok-nl">value:</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-nl">date:</span><span class="tok-mi">6</span><span class="tok-s">/6/</span><span class="tok-mi">2017</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">30</span><span class="tok-o">,</span><span class="tok-nl">key:</span><span class="tok-n">longest</span><span class="tok-o">,</span><span class="tok-nl">value:</span><span class="tok-mi">12250</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">31</span><span class="tok-o">,</span><span class="tok-nl">key:</span><span class="tok-n">city</span><span class="tok-o">,</span><span class="tok-nl">value:</span><span class="tok-n">Austin</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">32</span><span class="tok-o">,</span><span class="tok-nl">key:</span><span class="tok-n">elev</span><span class="tok-o">,</span><span class="tok-nl">value:</span><span class="tok-mi">542</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">33</span><span class="tok-o">,</span><span class="tok-nl">key:</span><span class="tok-n">icao</span><span class="tok-o">,</span><span class="tok-nl">value:</span><span class="tok-n">KAUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">34</span><span class="tok-o">,</span><span class="tok-nl">key:</span><span class="tok-n">lon</span><span class="tok-o">,</span><span class="tok-nl">value:</span><span class="tok-o">-</span><span class="tok-mf">97.6698989868164</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">35</span><span class="tok-o">,</span><span class="tok-nl">key:</span><span class="tok-n">type</span><span class="tok-o">,</span><span class="tok-nl">value:</span><span class="tok-n">airport</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">36</span><span class="tok-o">,</span><span class="tok-nl">key:</span><span class="tok-n">region</span><span class="tok-o">,</span><span class="tok-nl">value:</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">37</span><span class="tok-o">,</span><span class="tok-nl">key:</span><span class="tok-n">runways</span><span class="tok-o">,</span><span class="tok-nl">value:</span><span class="tok-mi">2</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">38</span><span class="tok-o">,</span><span class="tok-nl">key:</span><span class="tok-n">lat</span><span class="tok-o">,</span><span class="tok-nl">value:</span><span class="tok-mf">30.1944999694824</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">39</span><span class="tok-o">,</span><span class="tok-nl">key:</span><span class="tok-n">desc</span><span class="tok-o">,</span><span class="tok-nl">value:</span><span class="tok-n">Austin</span> <span class="tok-n">Bergstrom</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="deduce">4.8. Deducing the schema of a graph using queries</h3>
<div class="paragraph">
<p>Sometimes, you may find yourself working with a graph while being unsure of its data
model or schema. Using some simple Gremlin queries we can quite easily figure out the
major elements that a graph contains. This technique should only be used if the
graph database you are using does not provide an explicit API for working with the
schema of a graph. First of all, we can figure out the vertex labels that are in use
as shown below. The <em>dedup</em> step insures that we get a list of unique label names
back.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">label</span><span class="tok-o">().</span><span class="tok-na">dedup</span><span class="tok-o">()</span>

<span class="tok-n">version</span>
<span class="tok-n">airport</span>
<span class="tok-n">country</span>
<span class="tok-n">continent</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, we can find out the names of the edge labels in the graph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">().</span><span class="tok-na">label</span><span class="tok-o">().</span><span class="tok-na">dedup</span><span class="tok-o">()</span>

<span class="tok-n">route</span>
<span class="tok-n">contains</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we know the label names it is very easy to get the names of the property
keys for a vertex with a given label. The query below will display the names of the
property keys found in an <em>airport</em> vertex.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">().</span><span class="tok-na">keys</span><span class="tok-o">()</span>

<span class="tok-n">country</span>
<span class="tok-n">code</span>
<span class="tok-n">longest</span>
<span class="tok-n">city</span>
<span class="tok-n">elev</span>
<span class="tok-n">icao</span>
<span class="tok-n">lon</span>
<span class="tok-n">type</span>
<span class="tok-n">region</span>
<span class="tok-n">runways</span>
<span class="tok-n">lat</span>
<span class="tok-n">desc</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You could easily put the previous query inside a simple loop if you wanted to iterate
through each of the vertex labels that were discovered. As with vertices we can also
query edges to discover their key names. The query below finds the property key names
for <em>route</em> edges.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">().</span><span class="tok-na">keys</span><span class="tok-o">()</span>

<span class="tok-n">dist</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lastly now that we know the label names and we know how to find out the property key
names, we can also figure out the types associated with each key. The code below
creates an array called <em>pkeys</em> containing all of the property key names for an
<em>airport</em> vertex. Having done that, the code iterates through the list in a simple
loop to find the type for each key. The code as shown is intended to be run inside
the Gremlin Console.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">pkeys</span><span class="tok-o">=</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">().</span><span class="tok-na">keys</span><span class="tok-o">()</span>

<span class="tok-n">pkeys</span><span class="tok-o">.</span><span class="tok-na">each</span> <span class="tok-o">{</span>
  <span class="tok-n">printf</span><span class="tok-o">(</span><span class="tok-s2">"%10s : %s\n"</span> <span class="tok-o">,</span> <span class="tok-n">it</span><span class="tok-o">,</span>
          <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span>
            <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-n">it</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">().</span><span class="tok-na">class</span><span class="tok-o">)};[]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When run, we get back a nicely formatted table showing the key names and their types.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">   <span class="tok-n">country</span> <span class="tok-o">:</span> <span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">String</span>
      <span class="tok-n">code</span> <span class="tok-o">:</span> <span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">String</span>
   <span class="tok-n">longest</span> <span class="tok-o">:</span> <span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">Integer</span>
      <span class="tok-n">city</span> <span class="tok-o">:</span> <span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">String</span>
      <span class="tok-n">elev</span> <span class="tok-o">:</span> <span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">Integer</span>
      <span class="tok-n">icao</span> <span class="tok-o">:</span> <span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">String</span>
       <span class="tok-n">lon</span> <span class="tok-o">:</span> <span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">Double</span>
      <span class="tok-n">type</span> <span class="tok-o">:</span> <span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">String</span>
    <span class="tok-n">region</span> <span class="tok-o">:</span> <span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">String</span>
   <span class="tok-n">runways</span> <span class="tok-o">:</span> <span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">Integer</span>
       <span class="tok-n">lat</span> <span class="tok-o">:</span> <span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">Double</span>
      <span class="tok-n">desc</span> <span class="tok-o">:</span> <span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">String</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Later, in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#janusmgmt">The JanusGraph management API</a>" section, we will look at how JanusGraph allows us to
define an explicit schema and also to query the schema using its Graph Management
API.</p>
</div>
</div>
<div class="sect2">
<h3 id="collrev">4.9. Collections revisited</h3>
<div class="paragraph">
<p>As we have seen in many of the prior examples, very often, either in the middle or at
the end of a traversal, or both, we generate some kind of collection. In this section
we are going to take a more focused look at these collections and how to work with
them. In the following section we will look at collections and how they can be used
effectively in conjunction with so called <em>reducing barrier</em> traversal steps.</p>
</div>
<div class="sect3">
<h4 id="collsteps">4.9.1. Steps that generate collections</h4>
<div class="paragraph">
<p>Let’s start this discussion by first reviewing a few ways that a collection can be
generated. A simple example of a collection is the map that is generated by the
<em>group</em> step as shown in the example below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">..</span><span class="tok-mi">5</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">BNA:</span><span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">],</span><span class="tok-nl">ANC:</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-nl">BOS:</span><span class="tok-o">[</span><span class="tok-mi">6</span><span class="tok-o">],</span><span class="tok-nl">ATL:</span><span class="tok-o">[</span><span class="tok-mi">5</span><span class="tok-o">],</span><span class="tok-nl">AUS:</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly a map is created when the <em>groupCount</em> step is used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">40</span><span class="tok-o">).</span><span class="tok-na">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-nl">FL:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-n">PR</span><span class="tok-o">-</span><span class="tok-n">U</span><span class="tok-o">-</span><span class="tok-nl">A:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-nl">NV:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-nl">MN:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-nl">HI:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-nl">IL:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-nl">TX:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-nl">AK:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-nl">WA:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-nl">VA:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-nl">NY:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-nl">CO:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-nl">NC:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-nl">LA:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-nl">MD:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-nl">IA:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-nl">MA:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-nl">CA:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-nl">DC:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-nl">UT:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-nl">AZ:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-nl">GA:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-nl">TN:</span><span class="tok-mi">1</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Likewise, when we use the fold step a list is generated. We can use the <em>order</em> step
with a <em>local</em> scope to order the contents of the list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">20</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span>
      <span class="tok-n">fold</span><span class="tok-o">().</span><span class="tok-na">order</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">8</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example of a <em>union</em> step followed by a <em>fold</em> step that generates a list
of two values. The <em>union</em> step contains an <em>identity</em> step to indicate that we want
the value of the incoming vertex as the first item of the union. We union that vertex
with a count of all routes from that vertex (DFW) and finally use a <em>fold</em> step to
generate a list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">union</span><span class="tok-o">(</span><span class="tok-n">identity</span><span class="tok-o">(),</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">],</span><span class="tok-mi">221</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the above syntax, is a shorthand form of the following.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">union</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">),</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">],</span><span class="tok-mi">221</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we wanted to generate a map with keys and values rather than a list, we could use
a <em>group</em> step. In this case the vertex is the keys and the number of outgoing
routes is the value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">())</span>

<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">]:</span><span class="tok-mi">221</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Another way that a map can be created is when the <em>project</em> step is used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'IE'</span><span class="tok-o">).</span><span class="tok-na">project</span><span class="tok-o">(</span><span class="tok-s1">'loc'</span><span class="tok-o">,</span><span class="tok-s1">'iata'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">loc:</span><span class="tok-n">Dublin</span><span class="tok-o">,</span><span class="tok-nl">iata:</span><span class="tok-n">DUB</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">loc:</span><span class="tok-n">Shannon</span><span class="tok-o">,</span><span class="tok-nl">iata:</span><span class="tok-n">SNN</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">loc:</span><span class="tok-n">Cork</span><span class="tok-o">,</span><span class="tok-nl">iata:</span><span class="tok-n">ORK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">loc:</span><span class="tok-n">Charleston</span><span class="tok-o">,</span><span class="tok-nl">iata:</span><span class="tok-n">NOC</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">loc:</span><span class="tok-n">Killarney</span><span class="tok-o">,</span><span class="tok-nl">iata:</span><span class="tok-n">KIR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">loc:</span><span class="tok-n">Waterford</span><span class="tok-o">,</span><span class="tok-nl">iata:</span><span class="tok-n">WAT</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">loc:</span><span class="tok-n">Donegal</span><span class="tok-o">,</span><span class="tok-nl">iata:</span><span class="tok-n">CFN</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Also using a <em>project</em> step, but a little more complex, this example creates a map with
two keys. The first, called <em>dfw</em>, will contain the vertex for the DFW airport and
the second, called <em>route_count</em>, will contain the number of outgoing routes from
DFW. Notice how the first <em>by</em> step has no parameters so it returns the actual vertex
(rather than say a property from the vertex that we could select).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">project</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">,</span><span class="tok-s1">'route_count'</span><span class="tok-o">).</span>
       <span class="tok-n">by</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">())</span>

<span class="tok-o">[</span><span class="tok-nl">dfw:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">],</span><span class="tok-nl">route_count:</span><span class="tok-mi">221</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As well as generating maps, we can also generate a set using a <em>store</em> step so that
duplicate values are not stored. The <em>withSideEffect</em> step can be used to initialize
the set. The <em>cap</em> step emits the collection resulting from the side effect that we
created using the <em>store</em> step. Among other things this allows us to return this
collection as the final result of a query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSideEffect</span><span class="tok-o">(</span><span class="tok-s1">'s'</span><span class="tok-o">,</span> <span class="tok-o">[]</span> <span class="tok-k">as</span> <span class="tok-n">Set</span><span class="tok-o">).</span>
  <span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">20</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span>
      <span class="tok-n">store</span><span class="tok-o">(</span><span class="tok-s1">'s'</span><span class="tok-o">).</span><span class="tok-na">cap</span><span class="tok-o">(</span><span class="tok-s1">'s'</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">8</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>store</em> step can also be used in conjunction with a <em>by</em> modulator to specify
exactly what is <em>stored</em>. The query below uses a <em>store</em> step to create a collection
of runways but avoids the need to use a <em>values</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">).</span><span class="tok-na">store</span><span class="tok-o">(</span><span class="tok-s1">'r'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">cap</span><span class="tok-o">(</span><span class="tok-s1">'r'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>aggregate</em> step also generates a collection as shown below. The collection is
actually a <em>BulkSet</em> as we shall confirm shortly. The <em>store</em> step also generates a
BulkSet.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'IE'</span><span class="tok-o">).</span><span class="tok-na">aggregate</span><span class="tok-o">(</span><span class="tok-s1">'ireland'</span><span class="tok-o">).</span><span class="tok-na">cap</span><span class="tok-o">(</span><span class="tok-s1">'ireland'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">60</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">91</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">311</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">477</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">635</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">785</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">1269</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The query below uses an <em>aggregate</em> step to find all the countries that you can fly
to from airports in Ireland but excludes routes that are between airports within
Ireland.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'IE'</span><span class="tok-o">).</span><span class="tok-na">aggregate</span><span class="tok-o">(</span><span class="tok-s1">'ireland'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">without</span><span class="tok-o">(</span><span class="tok-s1">'ireland'</span><span class="tok-o">)).</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">).</span>
      <span class="tok-n">dedup</span><span class="tok-o">().</span><span class="tok-na">fold</span><span class="tok-o">().</span><span class="tok-na">order</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see by looking at the results, the country code for Ireland, <em>IE</em>, is not
present in the list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AE</span><span class="tok-o">,</span><span class="tok-n">AT</span><span class="tok-o">,</span><span class="tok-n">BE</span><span class="tok-o">,</span><span class="tok-n">BG</span><span class="tok-o">,</span><span class="tok-n">CA</span><span class="tok-o">,</span><span class="tok-n">CH</span><span class="tok-o">,</span><span class="tok-n">CY</span><span class="tok-o">,</span><span class="tok-n">CZ</span><span class="tok-o">,</span><span class="tok-n">DE</span><span class="tok-o">,</span><span class="tok-n">DK</span><span class="tok-o">,</span><span class="tok-n">ES</span><span class="tok-o">,</span><span class="tok-n">ET</span><span class="tok-o">,</span><span class="tok-n">FI</span><span class="tok-o">,</span><span class="tok-n">FR</span><span class="tok-o">,</span><span class="tok-n">GR</span><span class="tok-o">,</span><span class="tok-n">HR</span><span class="tok-o">,</span><span class="tok-n">HU</span><span class="tok-o">,</span><span class="tok-n">IM</span><span class="tok-o">,</span><span class="tok-n">IS</span><span class="tok-o">,</span><span class="tok-n">IT</span><span class="tok-o">,</span><span class="tok-n">JE</span><span class="tok-o">,</span><span class="tok-n">LT</span><span class="tok-o">,</span><span class="tok-n">LU</span><span class="tok-o">,</span><span class="tok-n">LV</span><span class="tok-o">,</span><span class="tok-n">MA</span><span class="tok-o">,</span><span class="tok-n">MD</span><span class="tok-o">,</span><span class="tok-n">MT</span><span class="tok-o">,</span><span class="tok-n">NL</span><span class="tok-o">,</span><span class="tok-n">NO</span><span class="tok-o">,</span><span class="tok-n">PL</span><span class="tok-o">,</span><span class="tok-n">PT</span><span class="tok-o">,</span><span class="tok-n">QA</span><span class="tok-o">,</span><span class="tok-n">RO</span><span class="tok-o">,</span><span class="tok-n">SE</span><span class="tok-o">,</span><span class="tok-n">SK</span><span class="tok-o">,</span><span class="tok-n">TR</span><span class="tok-o">,</span><span class="tok-n">UK</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>While <em>aggregate</em> and <em>store</em> on the surface appear identical, they actually behave
differently. The <em>aggregate</em> step will block and immediately gather up everything from
the prior traversal, whereas the <em>store</em> step will only add things to its collection
as they are seen. This is sometimes referred to as <em>lazy aggregation</em>. Note also that
even though we specified a <em>limit</em> of 2, the <em>store</em> step collected three elements as
the third has already been seen before the limit step is applied.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'IE'</span><span class="tok-o">).</span><span class="tok-na">store</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">).</span><span class="tok-na">cap</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">60</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">91</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">311</span><span class="tok-o">]]</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'IE'</span><span class="tok-o">).</span><span class="tok-na">aggregate</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">).</span><span class="tok-na">cap</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">60</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">91</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">311</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">477</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">635</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">785</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">1269</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Both <em>aggregate</em> and <em>store</em> can be followed by a <em>by</em> modulator to specify more
precisely what should be collected. For example, if we wanted to store the number of
runways that each airport in Ireland has we could do so as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'IE'</span><span class="tok-o">).</span>
      <span class="tok-n">aggregate</span><span class="tok-o">(</span><span class="tok-s1">'ireland'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">cap</span><span class="tok-o">(</span><span class="tok-s1">'ireland'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we are ever unsure what type of object has been created a call to <em>getClass</em> can
be used to find out.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">..</span><span class="tok-mi">5</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">().</span><span class="tok-na">getClass</span><span class="tok-o">()</span>

<span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.</span><span class="tok-na">HashMap</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">..</span><span class="tok-mi">5</span><span class="tok-o">).</span><span class="tok-na">aggregate</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">cap</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">().</span><span class="tok-na">getClass</span><span class="tok-o">()</span>

<span class="tok-kd">class</span> <span class="tok-nc">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.</span><span class="tok-na">step</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.</span><span class="tok-na">BulkSet</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have examined the various ways in which collections may get generated
during a traversal, it is important to understand how the contents of a collection
can be accessed and manipulated.</p>
</div>
</div>
<div class="sect3">
<h4 id="collaccess">4.9.2. Accessing the contents of a collection</h4>
<div class="paragraph">
<p>The keywords <em>keys</em> and <em>values</em> can be used to access the respective
parts of a collection that is a map. Take a look at the query below which returns a
map where airport codes are the keys and their city names are the values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">BNA:</span><span class="tok-o">[</span><span class="tok-n">Nashville</span><span class="tok-o">],</span><span class="tok-nl">ANC:</span><span class="tok-o">[</span><span class="tok-n">Anchorage</span><span class="tok-o">],</span><span class="tok-nl">BOS:</span><span class="tok-o">[</span><span class="tok-n">Boston</span><span class="tok-o">],</span><span class="tok-nl">ATL:</span><span class="tok-o">[</span><span class="tok-n">Atlanta</span><span class="tok-o">],</span><span class="tok-nl">AUS:</span><span class="tok-o">[</span><span class="tok-n">Austin</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use a <em>count</em> step with <em>local</em> scope to find out how big the collection is.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">)</span>

<span class="tok-mi">5</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The queries below extract the keys and values from the map that the <em>group</em> step
creates.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">keys</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">BNA</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">)</span>

<span class="tok-o">[[</span><span class="tok-n">Nashville</span><span class="tok-o">],[</span><span class="tok-n">Anchorage</span><span class="tok-o">],[</span><span class="tok-n">Boston</span><span class="tok-o">],[</span><span class="tok-n">Atlanta</span><span class="tok-o">],[</span><span class="tok-n">Austin</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also extract the keys and values from the results of the <em>project</em> step we
used earlier. Note that the values comeback as a list containing a the DFW vertex and
the number of routes from DFW.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">project</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">,</span><span class="tok-s1">'route_count'</span><span class="tok-o">).</span>
      <span class="tok-n">by</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">],</span><span class="tok-mi">221</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Likewise the keys come back in a list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">project</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">,</span><span class="tok-s1">'route_count'</span><span class="tok-o">).</span>
      <span class="tok-n">by</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">keys</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">dfw</span><span class="tok-o">,</span><span class="tok-n">route_count</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could also be even more specific and select which values we are interested in.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">project</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">,</span><span class="tok-s1">'route_count'</span><span class="tok-o">).</span>
       <span class="tok-n">by</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'route_count'</span><span class="tok-o">)</span>

<span class="tok-mi">221</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also access the DFW vertex directly from the map.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">project</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">,</span><span class="tok-s1">'route_count'</span><span class="tok-o">).</span>
      <span class="tok-n">by</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">)</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Having extracted the vertex we can retrieve values from it. A bit later we will look
at ways we could continue our traversal from this point if we needed to, perhaps
looking at outgoing routes from DFW or adding a new route. You will find that
discussion in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#rbarriers">Collections and reducing barrier steps</a>" section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">project</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">,</span><span class="tok-s1">'route_count'</span><span class="tok-o">).</span>
      <span class="tok-n">by</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">)</span>

<span class="tok-n">Dallas</span><span class="tok-o">/</span><span class="tok-n">Fort</span> <span class="tok-n">Worth</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As we shall see in the next two sections, sometimes it is necessary to use the
<em>unfold</em> step to access the contents of a collection and it is also sometimes
necessary to use <em>local</em> scope.</p>
</div>
</div>
<div class="sect3">
<h4 id="unbundle">4.9.3. Using <em>unfold</em> to unbundle a collection</h4>
<div class="paragraph">
<p>Sometimes it is desirable to unbundle a collection so that we can work on it further.
This is what the <em>unfold</em> step does. If we apply <em>unfold</em> to the previous query you
can see what is generated. The collection that the <em>group</em> step generates is a
Java HashMap. The <em>unfold</em> step turns the HashMap into a series of HashMap.Node
elements.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">()</span>

<span class="tok-n">BNA</span><span class="tok-o">=[</span><span class="tok-n">Nashville</span><span class="tok-o">]</span>
<span class="tok-n">ANC</span><span class="tok-o">=[</span><span class="tok-n">Anchorage</span><span class="tok-o">]</span>
<span class="tok-n">BOS</span><span class="tok-o">=[</span><span class="tok-n">Boston</span><span class="tok-o">]</span>
<span class="tok-n">ATL</span><span class="tok-o">=[</span><span class="tok-n">Atlanta</span><span class="tok-o">]</span>
<span class="tok-n">AUS</span><span class="tok-o">=[</span><span class="tok-n">Austin</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we wanted a list of values we could use <em>unfold</em> again as shown below. You will
recall from our earlier discussion that vertex properties are stored as lists even
if there is only one property - a list of length one in other words. Note that this
shows that a single <em>unfold</em> step will not recursively unbundle elements from a
collection.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">Nashville</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">Anchorage</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">Boston</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">Atlanta</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">Austin</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could add a second <em>unfold</em> to just get the city names back and remove the
containing lists.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">().</span><span class="tok-na">unfold</span><span class="tok-o">()</span>

<span class="tok-n">Nashville</span>
<span class="tok-n">Anchorage</span>
<span class="tok-n">Boston</span>
<span class="tok-n">Atlanta</span>
<span class="tok-n">Austin</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As an alternative, <em>repeat</em> can be used when you want to unfold more than once as
shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">).</span><span class="tok-na">repeat</span><span class="tok-o">(</span><span class="tok-n">unfold</span><span class="tok-o">()).</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">)</span>

<span class="tok-n">Nashville</span>
<span class="tok-n">Anchorage</span>
<span class="tok-n">Boston</span>
<span class="tok-n">Atlanta</span>
<span class="tok-n">Austin</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we were not sure how many times we needed to <em>unfold</em> we could change the query as
follows. The <em>repeat</em> loop will unfold until there is only a list of lists left. The
final unfold will remove the remaining lists leaving us with just the text values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">).</span><span class="tok-na">repeat</span><span class="tok-o">(</span><span class="tok-n">unfold</span><span class="tok-o">()).</span><span class="tok-na">until</span><span class="tok-o">(</span><span class="tok-n">count</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)).</span><span class="tok-na">unfold</span><span class="tok-o">()</span>

<span class="tok-n">Nashville</span>
<span class="tok-n">Anchorage</span>
<span class="tok-n">Boston</span>
<span class="tok-n">Atlanta</span>
<span class="tok-n">Austin</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Having used <em>unfold</em> to extract just the city names as strings, we could re-fold one
time to produce a list of airport names using the <em>fold</em> step. This pattern of
unfolding, performing an operation and refolding is one that comes in handy quite
often, especially in more complex queries.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">().</span><span class="tok-na">unfold</span><span class="tok-o">().</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">Nashville</span><span class="tok-o">,</span><span class="tok-n">Anchorage</span><span class="tok-o">,</span><span class="tok-n">Boston</span><span class="tok-o">,</span><span class="tok-n">Atlanta</span><span class="tok-o">,</span><span class="tok-n">Austin</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is probably worth pointing out that the <em>keys</em> and <em>values</em> keywords can also be
used with something as simple as a <em>valueMap</em> step. Here is a simple example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">().</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">keys</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">country</span><span class="tok-o">,</span><span class="tok-n">code</span><span class="tok-o">,</span><span class="tok-n">longest</span><span class="tok-o">,</span><span class="tok-n">city</span><span class="tok-o">,</span><span class="tok-n">elev</span><span class="tok-o">,</span><span class="tok-n">icao</span><span class="tok-o">,</span><span class="tok-n">lon</span><span class="tok-o">,</span><span class="tok-n">type</span><span class="tok-o">,</span><span class="tok-n">region</span><span class="tok-o">,</span><span class="tok-n">runways</span><span class="tok-o">,</span><span class="tok-n">lat</span><span class="tok-o">,</span><span class="tok-n">desc</span><span class="tok-o">]</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">().</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">)</span>

<span class="tok-o">[[</span><span class="tok-n">US</span><span class="tok-o">],[</span><span class="tok-n">AUS</span><span class="tok-o">],[</span><span class="tok-mi">12250</span><span class="tok-o">],[</span><span class="tok-n">Austin</span><span class="tok-o">],[</span><span class="tok-mi">542</span><span class="tok-o">],[</span><span class="tok-n">KAUS</span><span class="tok-o">],[-</span><span class="tok-mf">97.6698989868164</span><span class="tok-o">],[</span><span class="tok-n">airport</span><span class="tok-o">],[</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span><span class="tok-o">],[</span><span class="tok-mi">2</span><span class="tok-o">],[</span><span class="tok-mf">30.1944999694824</span><span class="tok-o">],[</span><span class="tok-n">Austin</span> <span class="tok-n">Bergstrom</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="localcollect">4.9.4. Using <em>local</em> scope with collections</h4>
<div class="paragraph">
<p>Sometimes if you want to work on the contents of a collection, whether to sort it or
perhaps select some subset of it it is often necessary to use <em>local</em> scope. There
are other ways the following examples could be written but I wanted to show some ways
that <em>local</em> scope can be combined with the <em>order</em>, <em>range</em>, <em>limit</em> and <em>tail</em>
steps while working with collections.</p>
</div>
<div class="paragraph">
<p>First of all let’s, once again produce a collection using airports in Ireland. This
time we produce a map where the keys are the airport codes and the values are the
number of runways at that airport.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'IE'</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">DUB:</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">],</span><span class="tok-nl">SNN:</span><span class="tok-o">[</span><span class="tok-mi">5</span><span class="tok-o">],</span><span class="tok-nl">NOC:</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">],</span><span class="tok-nl">KIR:</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">],</span><span class="tok-nl">ORK:</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">],</span><span class="tok-nl">CFN:</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">],</span><span class="tok-nl">WAT:</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We already know how to select the keys from the map using our prior examples but for
completeness let’s take a another look.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'IE'</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">keys</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">DUB</span><span class="tok-o">,</span><span class="tok-n">SNN</span><span class="tok-o">,</span><span class="tok-n">NOC</span><span class="tok-o">,</span><span class="tok-n">KIR</span><span class="tok-o">,</span><span class="tok-n">ORK</span><span class="tok-o">,</span><span class="tok-n">CFN</span><span class="tok-o">,</span><span class="tok-n">WAT</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we wanted to sort the keys by ascending order we could use an <em>order</em> step with
<em>local</em> scope.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'IE'</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">keys</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">CFN</span><span class="tok-o">,</span><span class="tok-n">DUB</span><span class="tok-o">,</span><span class="tok-n">KIR</span><span class="tok-o">,</span><span class="tok-n">NOC</span><span class="tok-o">,</span><span class="tok-n">ORK</span><span class="tok-o">,</span><span class="tok-n">SNN</span><span class="tok-o">,</span><span class="tok-n">WAT</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is worth noting that this is a case where we could have used the <em>unfold</em> and
<em>fold</em> pattern instead as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'IE'</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">keys</span><span class="tok-o">).</span>
      <span class="tok-n">unfold</span><span class="tok-o">().</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">CFN</span><span class="tok-o">,</span><span class="tok-n">DUB</span><span class="tok-o">,</span><span class="tok-n">KIR</span><span class="tok-o">,</span><span class="tok-n">NOC</span><span class="tok-o">,</span><span class="tok-n">ORK</span><span class="tok-o">,</span><span class="tok-n">SNN</span><span class="tok-o">,</span><span class="tok-n">WAT</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The next example also uses <em>local</em> scope along with a <em>limit</em> step to retrieve the
first two airport keys.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'IE'</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">keys</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">DUB</span><span class="tok-o">,</span><span class="tok-n">SNN</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use the same <em>local</em> scope with the <em>tail</em> step to select the last three keys.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'IE'</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">keys</span><span class="tok-o">).</span><span class="tok-na">tail</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">ORK</span><span class="tok-o">,</span><span class="tok-n">CFN</span><span class="tok-o">,</span><span class="tok-n">WAT</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you would expect we can also specify <em>local</em> scope on a <em>range</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'IE'</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">keys</span><span class="tok-o">).</span><span class="tok-na">range</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">KIR</span><span class="tok-o">,</span><span class="tok-n">ORK</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can combine the <em>limit</em> and <em>tail</em> steps with <em>local</em> scope to extract the
beginning or ending entries from a list of values as shown below. The following
query creates a list containing the IATA codes for all airports in Texas.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-n">HOU</span><span class="tok-o">,</span><span class="tok-n">ELP</span><span class="tok-o">,</span><span class="tok-n">DAL</span><span class="tok-o">,</span><span class="tok-n">LBB</span><span class="tok-o">,</span><span class="tok-n">HRL</span><span class="tok-o">,</span><span class="tok-n">MAF</span><span class="tok-o">,</span><span class="tok-n">CRP</span><span class="tok-o">,</span><span class="tok-n">ABI</span><span class="tok-o">,</span><span class="tok-n">ACT</span><span class="tok-o">,</span><span class="tok-n">CLL</span><span class="tok-o">,</span><span class="tok-n">BPT</span><span class="tok-o">,</span><span class="tok-n">AMA</span><span class="tok-o">,</span><span class="tok-n">BRO</span><span class="tok-o">,</span><span class="tok-n">GGG</span><span class="tok-o">,</span><span class="tok-n">GRK</span><span class="tok-o">,</span><span class="tok-n">LRD</span><span class="tok-o">,</span><span class="tok-n">MFE</span><span class="tok-o">,</span><span class="tok-n">SJT</span><span class="tok-o">,</span><span class="tok-n">SPS</span><span class="tok-o">,</span><span class="tok-n">TYR</span><span class="tok-o">,</span><span class="tok-n">VCT</span><span class="tok-o">,</span><span class="tok-n">AFW</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using <em>local</em> scope with a <em>limit</em> step we can extract just the first two entries
from the list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">().</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Likewise, using <em>local</em> scope with a <em>tail</em> step we can extract just the last two
entries from the list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">().</span><span class="tok-na">tail</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">VCT</span><span class="tok-o">,</span><span class="tok-n">AFW</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is worth noting that <em>local</em> scope can also be used with a <em>dedup</em> step. The
query below finds airports in the US and produces a sorted list of the unique region
codes by only allowing one airport from each region to proceed to the next steps of
the traversal.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'US'</span><span class="tok-o">).</span><span class="tok-na">dedup</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">fold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The rewritten version of the query below allows the region codes for every airport to
be collected and then the <em>dedup</em> is applied to the resultant collection using
<em>local</em> scope. The prior query is likely to be the more efficient way of doing this
but I wanted to make it clear that existing collections of values can have <em>dedup</em>
applied to them using <em>local</em> scope.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'US'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">fold</span><span class="tok-o">().</span><span class="tok-na">dedup</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When either query is run, here are the results that are returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">AK</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">AL</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">AR</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">AZ</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">CA</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">CO</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">CT</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">DC</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">DE</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">FL</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">GA</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">HI</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">IA</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">ID</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">IL</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">IN</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">KS</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">KY</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">LA</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">MA</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">MD</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">ME</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">MI</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">MN</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">MO</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">MS</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">MT</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">NC</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">ND</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">NE</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">NH</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">NJ</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">NM</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">NV</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">NY</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">OH</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">OK</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">OR</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">PA</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">RI</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">SC</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">SD</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TN</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">UT</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">VA</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">VT</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">WA</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">WI</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">WV</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">WY</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lastly, we can combine some of the prior examples to limit, order and deduplicate the
contents of a group. The query below does not include a <em>limit</em> step so it retrieves
all possible results. The goal of the query is to build a group, with labels as the
keys and vertex <em>code</em> properties as the values for both incoming and outgoing edges
connected to AUS (Austin). The results are deduplicated so that no airport code
appears twice.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">both</span><span class="tok-o">().</span>
      <span class="tok-n">group</span><span class="tok-o">().</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">label</span><span class="tok-o">).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">().</span><span class="tok-na">dedup</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When run it returns the following results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">continent:</span><span class="tok-o">[</span><span class="tok-n">NA</span><span class="tok-o">],</span><span class="tok-nl">country:</span><span class="tok-o">[</span><span class="tok-n">US</span><span class="tok-o">],</span><span class="tok-nl">airport:</span><span class="tok-o">[</span><span class="tok-n">ABQ</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">BKG</span><span class="tok-o">,</span><span class="tok-n">BNA</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">,</span><span class="tok-n">CLE</span><span class="tok-o">,</span><span class="tok-n">CLT</span><span class="tok-o">,</span><span class="tok-n">CUN</span><span class="tok-o">,</span><span class="tok-n">CVG</span><span class="tok-o">,</span><span class="tok-n">DAL</span><span class="tok-o">,</span><span class="tok-n">DCA</span><span class="tok-o">,</span><span class="tok-n">DEN</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">DTW</span><span class="tok-o">,</span><span class="tok-n">ELP</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">FLL</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-n">GDL</span><span class="tok-o">,</span><span class="tok-n">HOU</span><span class="tok-o">,</span><span class="tok-n">HRL</span><span class="tok-o">,</span><span class="tok-n">IAD</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-n">IND</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-n">LBB</span><span class="tok-o">,</span><span class="tok-n">LGB</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">MCI</span><span class="tok-o">,</span><span class="tok-n">MCO</span><span class="tok-o">,</span><span class="tok-n">MDW</span><span class="tok-o">,</span><span class="tok-n">MEM</span><span class="tok-o">,</span><span class="tok-n">MEX</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">,</span><span class="tok-n">MSP</span><span class="tok-o">,</span><span class="tok-n">MSY</span><span class="tok-o">,</span><span class="tok-n">OAK</span><span class="tok-o">,</span><span class="tok-n">ORD</span><span class="tok-o">,</span><span class="tok-n">PDX</span><span class="tok-o">,</span><span class="tok-n">PHL</span><span class="tok-o">,</span><span class="tok-n">PHX</span><span class="tok-o">,</span><span class="tok-n">PIE</span><span class="tok-o">,</span><span class="tok-n">PIT</span><span class="tok-o">,</span><span class="tok-n">PNS</span><span class="tok-o">,</span><span class="tok-n">RDU</span><span class="tok-o">,</span><span class="tok-n">SAN</span><span class="tok-o">,</span><span class="tok-n">SEA</span><span class="tok-o">,</span><span class="tok-n">SFB</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">SJC</span><span class="tok-o">,</span><span class="tok-n">SLC</span><span class="tok-o">,</span><span class="tok-n">SNA</span><span class="tok-o">,</span><span class="tok-n">STL</span><span class="tok-o">,</span><span class="tok-n">TPA</span><span class="tok-o">,</span><span class="tok-n">VPS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, let’s assume we wanted to limit the query to a maximum of ten results for
any of the keys in the group. We can do so by adding a <em>limit</em> step with <em>local</em>
scope as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">both</span><span class="tok-o">().</span>
      <span class="tok-n">group</span><span class="tok-o">().</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">label</span><span class="tok-o">).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">().</span><span class="tok-na">dedup</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">,</span><span class="tok-mi">10</span><span class="tok-o">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This time when run, the amount of results returned is restricted.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">continent:</span><span class="tok-o">[</span><span class="tok-n">NA</span><span class="tok-o">],</span><span class="tok-nl">country:</span><span class="tok-o">[</span><span class="tok-n">US</span><span class="tok-o">],</span><span class="tok-nl">airport:</span><span class="tok-o">[</span><span class="tok-n">ABQ</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">BKG</span><span class="tok-o">,</span><span class="tok-n">BNA</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">,</span><span class="tok-n">CLE</span><span class="tok-o">,</span><span class="tok-n">CLT</span><span class="tok-o">,</span><span class="tok-n">CUN</span><span class="tok-o">,</span><span class="tok-n">CVG</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the next section we will continue our look at Gremlin’s collections and how they
can be used in conjunction with <em>reducing barrier</em> steps to still achieve a desired
result. We will also see other cases where <em>unfold</em> is needed to access the parts of
a collection that we care about.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="rbarriers">4.10. Collections and reducing barrier steps</h3>
<div class="paragraph">
<p>If you look at commonly asked questions about writing Gremlin queries on the Gremlin
Users discussion list, one area that repeatedly seems to cause people confusion is
the behavior of certain traversal steps that are known as <em>reducing barrier</em> steps.
What these steps in essence do is reduce the results of the traversal so far to a
single traversal, often just a value or a collection of some kind and from that point
on you cannot refer back to things you did earlier in the query.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. Reducing barrier steps</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">max</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the maximum value from a set of values.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">min</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the minimum value from a set of values.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">sum</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the sum of a set of values.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">count</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counts the number of current elements.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">fold</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Aggregates current traversal into a map.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Take a look at the example below. On the surface, you might expect the query to count
all of the routes originating from the DFW airport and return the count <em>"b"</em> along
with the airport vertex <em>"a"</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>What actually happens is that nothing is returned. This is because the <em>count</em> step
is a so called <em>reducing barrier</em> step. Once the <em>count</em> has been processed, you have
crossed the <em>barrier</em> and the traversal variable <em>"a"</em> is no longer available to us.
We can still access <em>"b"</em> if we reference it by itself  as it is defined after the
<em>count</em> step as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">)</span>

<span class="tok-mi">221</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In cases such as this, it is almost always possible to achieve the results that you
want by changing the way you write the query. It is important to gain an
understanding of how different traversal steps work. A great way to do that is to
experiment using the Gremlin Console and look at the way different steps operate. The
rewritten query below achieves our original goal.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">())</span>

<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">]:</span><span class="tok-mi">221</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If this was all we needed then our job is done. We have a map containing the vertex
as the key and its outgoing route count as the value. However, there is still an
issue if we want to go further with this query. Take a look at the example below.
Because the query has reduced the prior traversal to essentially a small map,
including a count, we can no longer refer back to <em>"a"</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If for some reason, we wanted to retrieve the vertex that we had stored in <em>"a"</em>, we
should instead pull it from the map that the <em>group</em> step created. You can access the
keys of a map using the <em>keys</em> keyword as a parameter to a <em>select</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span>
                        <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">keys</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We have still not quite got the result we wanted as the vertex is still returned in a
list. So we can modify the query again to <em>unfold</em> the map before we select the keys
from it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span>
                        <span class="tok-n">unfold</span><span class="tok-o">().</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">keys</span><span class="tok-o">)</span>
<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we wanted to get the value back instead of the key we can use the <em>values</em> keyword
as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span>
                        <span class="tok-n">unfold</span><span class="tok-o">().</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">)</span>

<span class="tok-mi">221</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To prove we could carry on adding to the query from here let’s get back the airport
code that we started with.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span>
                        <span class="tok-n">unfold</span><span class="tok-o">().</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">keys</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-n">DFW</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So, lets now add to our query and create a new vertex with a label <em>dfwcount</em> that is
going to store the number of routes originating in DFW using a property called
<em>current_count</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'ct'</span><span class="tok-o">).</span>
      <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s1">'dfwcount'</span><span class="tok-o">).</span>
      <span class="tok-n">property</span><span class="tok-o">(</span><span class="tok-s1">'current_count'</span><span class="tok-o">,</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'ct'</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">().</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">))</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">54931</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can inspect the new vertex to double check that our query worked as intended.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">54931</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">54931</span><span class="tok-o">,</span><span class="tok-nl">current_count:</span><span class="tok-o">[</span><span class="tok-mi">221</span><span class="tok-o">],</span><span class="tok-nl">label:</span><span class="tok-n">dfwcount</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hopefully you are starting to see a pattern here. It is important to understand which
steps are <em>reducing barrier</em> steps and be able to work with them in a way that allows
you to write queries that do what you need.</p>
</div>
<div class="sect3">
<h4 id="sumcollection">4.10.1. Calculating the <em>sum</em> of a collection</h4>
<div class="paragraph">
<p>The query below returns a map where the keys are airport IATA codes and the values
are the number of runways at the airport. The results are ordered to aid readability.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">)).</span>
      <span class="tok-n">order</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">FLL:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">AUS:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">DCA:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">BWI:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">ANC:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">BNA:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">IAD:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">ATL:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">BOS:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">DFW:</span><span class="tok-mi">7</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Given such a collection of airports and runways, we might want to calculate the total
number of runways present. The query below achieves that. Note that in order to
select the values from the collection an <em>unfold</em> step is used to turn the collection
back into a stream from which the values can be selected.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">)).</span>
      <span class="tok-n">unfold</span><span class="tok-o">().</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">).</span>
      <span class="tok-n">sum</span><span class="tok-o">()</span>

<span class="tok-mi">39</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also write the query using <em>local</em> scope rather than an <em>unfold</em> step as shown
below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">)).</span>
      <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">).</span><span class="tok-na">sum</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">))</span>

<span class="tok-mi">39</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mathcollection">4.10.2. Using the <em>math</em> step with collections</h4>
<div class="paragraph">
<p>Building on the examples from the previous section, let’s now take these experiments
one step further and look at ways to apply the <em>math</em> step to values from one or more
collections. Given we know that there are 10 values in our collection we can easily
use a <em>math</em> step to calculate the average of those values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">)).</span>
      <span class="tok-n">unfold</span><span class="tok-o">().</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">).</span>
      <span class="tok-n">sum</span><span class="tok-o">().</span>
      <span class="tok-n">math</span><span class="tok-o">(</span><span class="tok-s1">'_ / 10'</span><span class="tok-o">)</span>

<span class="tok-mf">3.9</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We may not always know ahead of time  how many entries a collection has. The modified
example below uses a <em>project</em> step to feed the <em>math</em> step with two values
representing the total number of runways and the number of members in the collection.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">)).</span>
      <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'total'</span><span class="tok-o">,</span><span class="tok-s1">'number'</span><span class="tok-o">).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">().</span><span class="tok-na">sum</span><span class="tok-o">()).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">count</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">)).</span>
      <span class="tok-n">math</span><span class="tok-o">(</span><span class="tok-s1">'total / number'</span><span class="tok-o">)</span>

<span class="tok-mf">3.9</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Sometimes you may want to perform computations on the sums of multiple collections.
The two queries shown below create maps of airport and runway key/value pairs for all
the airports in New Mexico and Arizona respectively.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-NM'</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">))</span>

<span class="tok-o">[</span><span class="tok-nl">ABQ:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">SVC:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">CNM:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">FMN:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">SAF:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">LAM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">HOB:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">CVN:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">ROW:</span><span class="tok-mi">3</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you were to add up the runways at the New Mexico airports you would find there are
27 and likewise there are 26 runways across the Arizona airports.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-AZ'</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">))</span>

<span class="tok-o">[</span><span class="tok-nl">YUM:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">PRC:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">FLG:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">PHX:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">IFP:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">TUS:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">GCN:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">AZA:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">SOW:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">PGA:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">IGM:</span><span class="tok-mi">3</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Given these two collections, we might want to divide the sum of one set of values by
the other to calculate the ratio between the total number of runways in Arizona and
New Mexico. The query below does just that. While at first glance this query looks a
bit complicated, it is in fact just the result of combining the prior few queries we
have looked at into a single query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-NM'</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">)).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">).</span>
      <span class="tok-n">unfold</span><span class="tok-o">().</span>
      <span class="tok-n">sum</span><span class="tok-o">().</span>
      <span class="tok-n">store</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
      <span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-AZ'</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">)).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">).</span>
      <span class="tok-n">unfold</span><span class="tok-o">().</span>
      <span class="tok-n">sum</span><span class="tok-o">().</span>
      <span class="tok-n">store</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span>
      <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'first'</span><span class="tok-o">,</span><span class="tok-s1">'second'</span><span class="tok-o">).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">()).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">()).</span>
      <span class="tok-n">math</span><span class="tok-o">(</span><span class="tok-s1">'first / second'</span><span class="tok-o">)</span>

<span class="tok-mf">1.0384615384615385</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Given we calculated that there were 27 runways in New Mexico and 26 in Arizona we can
verify that we have the right result using the Gremlin Console.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">gremlin&gt; 27/26</span>

<span class="tok-go">==&gt;1.0384615385</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sackintro">4.11. Introducing <em>sack</em> as a way to store values</h3>
<div class="paragraph">
<p>As is hopefully now becoming apparent, to efficiently write certain types of queries
you need a way to build up a collection of items as the traversal takes place. We
have already looked at steps like <em>aggregate</em> and <em>store</em> that can create collections
of items during a traversal. However, the <em>sack</em> step offers an additional capability
in that we can specify how items are added to the collection. For example they can be
added using addition, multiplication, subtraction or division. Alternatively we can
store the minimum or maximum value of a pair of values. These and other sack
operators will be used in different parts of this book.</p>
</div>
<div class="sect3">
<h4 id="sackbasics">4.11.1. Basic <em>sack</em> operations</h4>
<div class="paragraph">
<p>The <em>sack</em> step, as shown in the examples below, is a side effect step, meaning it
can store values during a traversal but has no effect on what is passed on to the
next step.</p>
</div>
<div class="paragraph">
<p>By way of an introduction, take a look at the example below. All the query does as it
stands is create a list of the number of runways that each airport that you can fly
to from Santa Fe (SAF) has. We have not introduced a <em>sack</em> step into the equation
yet.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let’s start to introduce some usage of sacks into the query. When working with a
<em>sack</em> we typically initialize the sack in some way. The example below initializes a
sack with a value of zero but does not yet do anything with it so the result is
unchanged.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">).</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
              <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This time we add the runways to our sack using a sum operation, but as our starting
value is zero we are not actually changing the end result in any way. This is because
we essentially perform the operation <em>0 + runways</em> for each runway value. The final
call to <em>sack</em> with no parameters causes the current contents of the <em>sack</em> to be
returned. The <em>fold</em> step, as before, puts whatever results we got from the <em>sack</em>
into a list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">).</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
              <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">sum</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">().</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So let’s finally do something that will change the result. Let’s make the starting
value one rather than zero and see what happens.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
              <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">sum</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">().</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, each time the number of runways was added to the sack using a <em>sum</em> operator,
the operation that was performed was <em>1 + runways</em>. As you can see from the results,
in each case, the value returned is one higher than those from the previous query.
This is a very simple example but hopefully you can start to see how useful sacks can
be.</p>
</div>
<div class="paragraph">
<p>Before getting into some more interesting examples, it is worth pointing out that you
can also initialize a sack using the <em>assign</em> operator as shown below. It is also
important to note that this sack initialization does not have to happen at the start
of the query when done in this way. In the example below, a constant value of one is
used, but we could equally well have used a traversal to initialize that sack as we
shall see in the next example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">assign</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">sum</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">().</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s now make our query a bit more interesting. There are a couple of interesting
new twists shown in the query below. Firstly, the sack is initialized to contain the
number of runways from the AUS vertex whereas before we just used a simple constant.
Secondly, notice that rather than make an explicit call to <em>values</em> before adding to
the sack, we can just use a <em>by</em> modulator to specify what we want added to our sack.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">assign</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span>
  <span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">sack</span><span class="tok-o">(</span><span class="tok-n">sum</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">().</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">8</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This time, as the Austin (AUS) airport has two runways our calculation in effect
became <em>2 + runways</em>.</p>
</div>
<div class="paragraph">
<p>Before looking at some slightly more complex queries that use multiple <em>sack</em> steps,
we should take a look at some of the other operators. So far we have just used <em>sum</em>.
The query below uses <em>mult</em> which as its name implies will multiply the values
together rather than add them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">assign</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span>
  <span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">sack</span><span class="tok-o">(</span><span class="tok-n">mult</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">().</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">12</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Likewise, minus will subtract the values before putting them into the sack. Note that
the values are subtracted <strong>from</strong> the sack’s initialization value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">assign</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span>
  <span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">sack</span><span class="tok-o">(</span><span class="tok-n">minus</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">().</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[-</span><span class="tok-mi">5</span><span class="tok-o">,-</span><span class="tok-mi">2</span><span class="tok-o">,-</span><span class="tok-mi">1</span><span class="tok-o">,-</span><span class="tok-mi">4</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we wanted to subtract the sack’s initial value from the other values we can simply
initialize it with a negative value and perform a <em>sum</em> operation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">assign</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">constant</span><span class="tok-o">(-</span><span class="tok-mi">1</span><span class="tok-o">)).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">sum</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">().</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sackminmax">4.11.2. Using <em>min</em> and <em>max</em> with a <em>sack</em></h4>
<div class="paragraph">
<p>There are many different operators that can be used with sacks. They are defined as
part of the TinkerPop Java Enum called <em>Operator</em>. Two such operators that we
can use are <em>min</em> and <em>max</em>. The example below looks at the distances of
all routes that start at SAF and in each case returns the minimum of the distance or
400 which is assigned to the sack at the start of the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">assign</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-mi">400</span><span class="tok-o">)).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span>
      <span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">min</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">().</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">400</span><span class="tok-o">,</span><span class="tok-mi">400</span><span class="tok-o">,</span><span class="tok-mi">369</span><span class="tok-o">,</span><span class="tok-mi">303</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In a similar vein, this query picks the maximum of the actual distance or 400.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">assign</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-mi">400</span><span class="tok-o">)).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span>
      <span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">max</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">().</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-mi">708</span><span class="tok-o">,</span><span class="tok-mi">400</span><span class="tok-o">,</span><span class="tok-mi">400</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sackcalc">4.11.3. Doing calculations using a <em>sack</em></h4>
<div class="paragraph">
<p>Now let’s look at a more complex, and hopefully more interesting, example. The
challenge is to write a query that shows 10 routes that start at Santa Fe (SAF) and
have one stop. We also want to return the distance between each hop and the total
distance of the two hops. This is a perfect example of a query where using a <em>sack</em>
can help. For completeness the results are sorted by overall route distance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">).</span>
  <span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">sum</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">()).</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">sack</span><span class="tok-o">()).</span>
      <span class="tok-n">sack</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">().</span>
      <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we run our query, we should get back something that looks like the output shown
below. Notice how the output from the <em>sack</em> (the last item in each row) contains the
sum of the two prior route distances. So, for example, we can see that the total
distance from SAF to ATL with a stop in DFW is 1278 miles.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">190</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">739</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">225</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-mi">774</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">630</span><span class="tok-o">,</span><span class="tok-n">BNA</span><span class="tok-o">,</span><span class="tok-mi">1179</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">729</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-mi">1278</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1120</span><span class="tok-o">,</span><span class="tok-n">FLL</span><span class="tok-o">,</span><span class="tok-mi">1669</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1170</span><span class="tok-o">,</span><span class="tok-n">IAD</span><span class="tok-o">,</span><span class="tok-mi">1719</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1190</span><span class="tok-o">,</span><span class="tok-n">DCA</span><span class="tok-o">,</span><span class="tok-mi">1739</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1210</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">,</span><span class="tok-mi">1759</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1560</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-mi">2109</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">3030</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-mi">3579</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>What may not be obvious from the query above is that we are in fact using multiple
<em>sack</em> steps within the same query. If we were to remove the <em>repeat</em> and write the
query out in full this becomes more obvious.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">).</span>
  <span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span>
      <span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">sum</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">().</span>
      <span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">sum</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">().</span>
      <span class="tok-n">sack</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">().</span>
      <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Later, in the <a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#sackauslhr">Using <em>sack</em> to calculate the shortest AUS-LHR route with one stop</a> section, we will again use a <em>sack</em> to help calculate
multi hop route distances using an approach similar to the example above.</p>
</div>
<div class="paragraph">
<p>So far we have just used simple integer values to initialize our sacks. However it is
also possible to use non primitive types such as maps when working with a sack. You
will find an example of <em>sack</em> being used to generate a map in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#anothersack">Another example of how <em>sack</em> can be used</a>
section.</p>
</div>
</div>
<div class="sect3">
<h4 id="nonsackcalc">4.11.4. Doing calculations without using a <em>sack</em></h4>
<div class="paragraph">
<p>A similar result to those from the queries in the previous section can actually be
achieved without using a <em>sack</em>. I find the <em>sack</em> form to be quite concise but you
can also use a <em>project</em> step to achieve similar results as shown below. The key
thing to notice about this query is that the path generated by the first half of the
query is unfolded to get the distances from the edges. As only edges have a <em>dist</em>
property in the <code>air-routes</code> graph, a coalesce step is used to generate the distance
from the edges or a constant value of zero otherwise. If we did not do this the query
would generate an error message as airport vertices does not have a <em>dist</em> property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
        <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'path'</span><span class="tok-o">,</span><span class="tok-s1">'total'</span><span class="tok-o">).</span>
          <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)).</span>
          <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">unfold</span><span class="tok-o">().</span><span class="tok-na">coalesce</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">),</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">)).</span><span class="tok-na">sum</span><span class="tok-o">()).</span>
          <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'total'</span><span class="tok-o">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When run the query produces the following results. Note that the output includes the
<em>path</em> and <em>total</em> key names and also that the path is in a list nested inside
another list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">path:</span><span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">190</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">],</span><span class="tok-nl">total:</span><span class="tok-mi">739</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">path:</span><span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">225</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">],</span><span class="tok-nl">total:</span><span class="tok-mi">774</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">path:</span><span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">630</span><span class="tok-o">,</span><span class="tok-n">BNA</span><span class="tok-o">],</span><span class="tok-nl">total:</span><span class="tok-mi">1179</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">path:</span><span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">729</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">],</span><span class="tok-nl">total:</span><span class="tok-mi">1278</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">path:</span><span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1120</span><span class="tok-o">,</span><span class="tok-n">FLL</span><span class="tok-o">],</span><span class="tok-nl">total:</span><span class="tok-mi">1669</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">path:</span><span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1170</span><span class="tok-o">,</span><span class="tok-n">IAD</span><span class="tok-o">],</span><span class="tok-nl">total:</span><span class="tok-mi">1719</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">path:</span><span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1190</span><span class="tok-o">,</span><span class="tok-n">DCA</span><span class="tok-o">],</span><span class="tok-nl">total:</span><span class="tok-mi">1739</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">path:</span><span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1210</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">],</span><span class="tok-nl">total:</span><span class="tok-mi">1759</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">path:</span><span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1560</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">],</span><span class="tok-nl">total:</span><span class="tok-mi">2109</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">path:</span><span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">3030</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">],</span><span class="tok-nl">total:</span><span class="tok-mi">3579</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The query can be refined a bit more to remove the <em>path</em> and <em>total</em> key names from
the result by just selecting the values for each.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
        <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'path'</span><span class="tok-o">,</span><span class="tok-s1">'total'</span><span class="tok-o">).</span>
          <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)).</span>
          <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">unfold</span><span class="tok-o">().</span><span class="tok-na">coalesce</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">),</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">)).</span><span class="tok-na">sum</span><span class="tok-o">()).</span>
          <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'total'</span><span class="tok-o">)).</span>
          <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the results are exactly the same as from the version of the query that used
<em>sack</em>. This was a longer query to write but in some cases, depending upon the graph
database implementation, could be more efficient as processing of results is left
until the second half of the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">190</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">],</span><span class="tok-mi">739</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">225</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">],</span><span class="tok-mi">774</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">630</span><span class="tok-o">,</span><span class="tok-n">BNA</span><span class="tok-o">],</span><span class="tok-mi">1179</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">729</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">],</span><span class="tok-mi">1278</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1120</span><span class="tok-o">,</span><span class="tok-n">FLL</span><span class="tok-o">],</span><span class="tok-mi">1669</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1170</span><span class="tok-o">,</span><span class="tok-n">IAD</span><span class="tok-o">],</span><span class="tok-mi">1719</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1190</span><span class="tok-o">,</span><span class="tok-n">DCA</span><span class="tok-o">],</span><span class="tok-mi">1739</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1210</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">],</span><span class="tok-mi">1759</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1560</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">],</span><span class="tok-mi">2109</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">3030</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">],</span><span class="tok-mi">3579</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can add one more refinement to make the results exactly the same as those from the
version of the query that used <em>sack</em> by unfolding the results and then refolding
them with <em>local</em> scope.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
        <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'path'</span><span class="tok-o">,</span><span class="tok-s1">'total'</span><span class="tok-o">).</span>
          <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)).</span>
          <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">unfold</span><span class="tok-o">().</span><span class="tok-na">coalesce</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">),</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">)).</span><span class="tok-na">sum</span><span class="tok-o">()).</span>
          <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'total'</span><span class="tok-o">)).</span>
          <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">).</span><span class="tok-na">local</span><span class="tok-o">(</span><span class="tok-n">unfold</span><span class="tok-o">().</span><span class="tok-na">unfold</span><span class="tok-o">().</span><span class="tok-na">fold</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the results look just the same was those we got using <em>sack</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">190</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">739</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">225</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-mi">774</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">630</span><span class="tok-o">,</span><span class="tok-n">BNA</span><span class="tok-o">,</span><span class="tok-mi">1179</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">729</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-mi">1278</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1120</span><span class="tok-o">,</span><span class="tok-n">FLL</span><span class="tok-o">,</span><span class="tok-mi">1669</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1170</span><span class="tok-o">,</span><span class="tok-n">IAD</span><span class="tok-o">,</span><span class="tok-mi">1719</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1190</span><span class="tok-o">,</span><span class="tok-n">DCA</span><span class="tok-o">,</span><span class="tok-mi">1739</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1210</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">,</span><span class="tok-mi">1759</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1560</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-mi">2109</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">3030</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-mi">3579</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The query can also be written using the same <em>path</em> and <em>coalesce</em> approach but this
time using a <em>union</em> step with <em>local</em> scope. This is more concise than the version
that uses <em>project</em> and may be sufficient if you do not need to select parts of the
result individually using a key name.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">union</span><span class="tok-o">(</span><span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">(),</span>
                  <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">unfold</span><span class="tok-o">().</span><span class="tok-na">coalesce</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">),</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">)).</span><span class="tok-na">sum</span><span class="tok-o">()).</span><span class="tok-na">fold</span><span class="tok-o">()).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">tail</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once again we have the same results as we had when using <em>sack</em> or <em>project</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">190</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">739</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">225</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-mi">774</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">630</span><span class="tok-o">,</span><span class="tok-n">BNA</span><span class="tok-o">,</span><span class="tok-mi">1179</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">729</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-mi">1278</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1120</span><span class="tok-o">,</span><span class="tok-n">FLL</span><span class="tok-o">,</span><span class="tok-mi">1669</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1170</span><span class="tok-o">,</span><span class="tok-n">IAD</span><span class="tok-o">,</span><span class="tok-mi">1719</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1190</span><span class="tok-o">,</span><span class="tok-n">DCA</span><span class="tok-o">,</span><span class="tok-mi">1739</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1210</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">,</span><span class="tok-mi">1759</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1560</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-mi">2109</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">3030</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-mi">3579</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As we have seen, the <em>sack</em> form is quite concise however, the <em>project</em> and <em>union</em>
forms have a nice feature that they will work unchanged no matter how long the
resultant path is. As you may have noticed in the prior section the <em>sack</em> version of
the query was tailored to produce results for a two hop query. We could of course
rewrite the <em>sack</em> version to be equally flexible as shown below. The key difference
is that the result from the sack is not included in the path but factored in later
inside a <em>union</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">).</span>
  <span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">sum</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">()).</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">sack</span><span class="tok-o">()).</span>
      <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">union</span><span class="tok-o">(</span><span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">),</span>
                  <span class="tok-n">sack</span><span class="tok-o">()).</span><span class="tok-na">fold</span><span class="tok-o">()).</span>
      <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">unfold</span><span class="tok-o">().</span><span class="tok-na">unfold</span><span class="tok-o">().</span><span class="tok-na">fold</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Again we have the same results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">190</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">739</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">225</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-mi">774</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">630</span><span class="tok-o">,</span><span class="tok-n">BNA</span><span class="tok-o">,</span><span class="tok-mi">1179</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">729</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-mi">1278</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1120</span><span class="tok-o">,</span><span class="tok-n">FLL</span><span class="tok-o">,</span><span class="tok-mi">1669</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1170</span><span class="tok-o">,</span><span class="tok-n">IAD</span><span class="tok-o">,</span><span class="tok-mi">1719</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1190</span><span class="tok-o">,</span><span class="tok-n">DCA</span><span class="tok-o">,</span><span class="tok-mi">1739</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1210</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">,</span><span class="tok-mi">1759</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1560</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-mi">2109</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">3030</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-mi">3579</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So in summary, as is almost always the case, there is more than one way to get the
results you need using a Gremlin query.</p>
</div>
</div>
<div class="sect3">
<h4 id="sackpathlength">4.11.5. Computing hop counts using a <em>sack</em></h4>
<div class="paragraph">
<p>The next query we are going to look at uses a <em>sack</em> to keep track of how many flight
segments (or hops) a <em>path</em> consists of. This means that along with the <em>path</em> result
we can also return the path’s <em>hop count</em>.</p>
</div>
<div class="paragraph">
<p>The query below looks for routes between Austin and Wellington and returns the first
10 results found along with the number of flights that would need to be taken between
the source and destination airports. As part of the <em>repeat</em> step, each time an <em>out</em>
step is taken a <em>constant</em> value of one is added to the sack for that individual
path. Finally a <em>union</em> step is used to combine the individual path with its hop
count.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">).</span><span class="tok-na">V</span><span class="tok-o">().</span>
  <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
  <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">().</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">sum</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">))).</span>
    <span class="tok-n">until</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'WLG'</span><span class="tok-o">)).</span>
  <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
  <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">union</span><span class="tok-o">(</span><span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">),</span><span class="tok-n">sack</span><span class="tok-o">()).</span><span class="tok-na">fold</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When run the query returns ten lists containing the airports visited and the number of
hops in each individual list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-n">MEL</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-n">BNE</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">HND</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">HND</span><span class="tok-o">,</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">4</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To return the results with the longer routes coming first we could use the values in
the sack along with an <em>order</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">).</span><span class="tok-na">V</span><span class="tok-o">().</span>
  <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
  <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">().</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">sum</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">))).</span>
    <span class="tok-n">until</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'WLG'</span><span class="tok-o">)).</span>
  <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
  <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">sack</span><span class="tok-o">(),</span><span class="tok-n">desc</span><span class="tok-o">).</span>
  <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">union</span><span class="tok-o">(</span><span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">),</span><span class="tok-n">sack</span><span class="tok-o">()).</span><span class="tok-na">fold</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This time the four hop routes appear first in the results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">HND</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">HND</span><span class="tok-o">,</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-n">MEL</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-n">BNE</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">3</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As a side note, if we wanted to include the path’s length rather than the hop count we
could change the query as shown below. In this case a <em>sack</em> step is not needed as we
can just count the length of each path.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span>
        <span class="tok-n">until</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'WLG'</span><span class="tok-o">)).</span>
      <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">union</span><span class="tok-o">(</span><span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">),</span><span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">)).</span><span class="tok-na">fold</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This time the number shown is one bigger than in the previous example as the starting
airport is included in the overall count.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-n">MEL</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-n">BNE</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">HND</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">5</span><span class="tok-o">]</span>
<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">HND</span><span class="tok-o">,</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-n">WLG</span><span class="tok-o">],</span><span class="tok-mi">5</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sackbooleans">4.11.6. Using boolean operators with a <em>sack</em></h4>
<div class="paragraph">
<p>You can also use the boolean operators <em>or</em> and <em>and</em> when working with a <em>sack</em>. The
examples below just test the basic functionality using constants of <em>true</em> and
<em>false</em>. In the first example the result returned in the <em>sack</em> is <em>false</em> as we used
an <em>and</em> operator to <em>and</em> together the sack’s initial value of <em>true</em> and a constant
value of <em>false</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">assign</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">)).</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">and</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-kc">false</span><span class="tok-o">)).</span><span class="tok-na">sack</span><span class="tok-o">()</span>

<span class="tok-kc">false</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This time we replace the <em>and</em> operator with an <em>or</em> and the result, as we would
expect, is <em>true</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">assign</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">)).</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">or</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-kc">false</span><span class="tok-o">)).</span><span class="tok-na">sack</span><span class="tok-o">()</span>

<span class="tok-kc">true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>While proving we can do boolean operations using constants is interesting it is
perhaps not that useful. Where this functionality becomes more interesting is if the
values being used come from, for example, a vertex property. So let’s create a couple
of vertices that each have a boolean property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">addV</span><span class="tok-o">(</span><span class="tok-s1">'happy'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'happy'</span><span class="tok-o">,</span><span class="tok-kc">true</span><span class="tok-o">)</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">54852</span><span class="tok-o">]</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">addV</span><span class="tok-o">(</span><span class="tok-s1">'sad'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'happy'</span><span class="tok-o">,</span><span class="tok-kc">false</span><span class="tok-o">)</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">54854</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now write a query that uses a boolean operator to generate a result in our
sack. The example below is a bit arbitrary but it shows how the boolean operators can
be used. We start at the vertex with an ID of 3, initialize a <em>sack</em> with the
constant <em>true</em> and the use the <em>and</em> operator against the <em>happy</em> property of the
vertex with a label of <em>happy</em>. We return the results in a path, which will contain
the starting vertex and the results of the <em>and</em> operation. The result of the <em>and</em>
is <em>true</em> as the <em>happy</em> vertex has a value of <em>true</em> for its <em>happy</em> property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">assign</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">)).</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">and</span><span class="tok-o">).</span>
       <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'happy'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'happy'</span><span class="tok-o">)).</span><span class="tok-na">sack</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-kc">true</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we repeat the query but this time use the <em>sad</em> vertex, we get the expected result
of <em>false</em> from the <em>and</em> operation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">assign</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">)).</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">and</span><span class="tok-o">).</span>
       <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'sad'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'happy'</span><span class="tok-o">)).</span><span class="tok-na">sack</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-kc">false</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sackaddall">4.11.7. Using <em>addAll</em> and lists with a <em>sack</em></h4>
<div class="paragraph">
<p>So far we have looked at using numbers and boolean values with a sack. However, sacks
can also contain lists and, as we shall see later, maps.</p>
</div>
<div class="paragraph">
<p>The example below initializes a sack with an empty list <em>"[]"</em> and then uses the
<em>addAll</em> operator to store the same results we have seen generated above in a list.
Note that a <em>fold</em> step is used to create a list of values that can then be added to
the sack. Later we shall look at other ways to build up lists with sacks that do not
first fold all of the traversal results into a list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">([]).</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
               <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">().</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">addAll</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You might be thinking, and you would be right, that we could have achieved the same
result without using a <em>sack</em> at all and just using a fold <em>step</em> as shown below.
However, the power of using a <em>sack</em> becomes apparent when you need to build up a list
containing the results of various parts of the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The next example, below, shows how a list can be built up using more than one <em>sack</em>
step. The <em>sack</em> is initialized with an empty list and the runway counts of the
airports reachable from SAF are again added initially to the list using the <em>addAll</em>
operator. Having done that we add the runway counts for the airports reachable from
AUS to the sack. You can see that the output starts with the same 7,4,3,6 sequence we
have seen before but is then followed by all the other values that were added by the
second <em>sack</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">([]).</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
               <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">().</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">addAll</span><span class="tok-o">).</span>
               <span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">().</span>
               <span class="tok-n">sack</span><span class="tok-o">(</span><span class="tok-n">addAll</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, here is the previous query again but this time the <em>sack</em> is initialized
with a list that already has some values in it. You can see from the output that the
values we generated above are added after the 1,1,1,1 sequence that the sack was
initialized with.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">([</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">]).</span>
     <span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
     <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">().</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">addAll</span><span class="tok-o">).</span>
     <span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">().</span>
     <span class="tok-n">sack</span><span class="tok-o">(</span><span class="tok-n">addAll</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So far, all of the examples have used a <em>fold</em> step before the <em>sack</em> step. While
this gives us a useful result, it may not always be the result that we want. To put
it another way, what we get back is a single list containing all of the values that
we generated during the traversal. In some cases what we actually want might be a set
of lists where each list contains whatever the <em>sack</em> was initialized with plus just
the values specific to each path the traverser takes. In other words, we want the
<em>sack</em> to have more of a local scope and not act like a global variable.</p>
</div>
<div class="paragraph">
<p>When I was thinking about this and doing some experiments using the Gremlin Console,
my first thought was "I can use a <em>local</em> step for this". So, I initially tried the
query shown below. However, as you can see, while this definitely generated some
different output, it did not generate what I wanted.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">([</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">]).</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
     <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">local</span><span class="tok-o">(</span><span class="tok-n">fold</span><span class="tok-o">().</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">addAll</span><span class="tok-o">)).</span><span class="tok-na">sack</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>What is happening above is that the <em>sack</em> is still acting more like a global
variable than a local one. Each <em>sack</em> step generated a list that was based on the
previous one.</p>
</div>
<div class="paragraph">
<p>To get the results I wanted, I needed to use a <em>clone</em> operation. This query uses the
Groovy closure or <em>Lambda</em> syntax. We will investigate that syntax more a bit later
in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#lambdas">Using Lambda functions</a>" section but for now all we need to know is that the <em>clone</em> will
ensure that each traverser gets its own copy of the original sack and is not affected
by what other traversers do to their sacks. Remember that a Gremlin query, or
traversal, in essence causes a set of traversers to follow the paths through the
graph that your query demands.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">{[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">]}{</span><span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">clone</span><span class="tok-o">()}</span><span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span>
       <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">local</span><span class="tok-o">(</span><span class="tok-n">fold</span><span class="tok-o">().</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">addAll</span><span class="tok-o">)).</span><span class="tok-na">sack</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Later in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#lambdasack">Using lambdas with <em>sack</em> steps</a>" section we  will revisit the topic of <em>sacks</em> and
lambda expressions and see other ways that we could have written the previous query.</p>
</div>
</div>
<div class="sect3">
<h4 id="sackpredicate">4.11.8. Comparing properties and constants to the value of a sack</h4>
<div class="paragraph">
<p>During a traversal you may want to incrementally modify a sack and then compare a
vertex or edge property against the current contents of a sack. The examples below
show ways of doing this. To keep things simple, initially we will use a sack that is
initialized to a value of six and does not change. This demonstrates how to compare
each airport’s runway count against the value stored in the sack.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">(</span><span class="tok-mi">6</span><span class="tok-o">).</span><span class="tok-na">V</span><span class="tok-o">().</span>
  <span class="tok-n">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
  <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">)).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">sack</span><span class="tok-o">()).</span>
  <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-n">DFW</span>
<span class="tok-n">ORD</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As I mentioned in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#pathstepwarn">A warning that the <em>path</em> and <em>as</em> steps can also be memory intensive</a>" section, using an <em>as</em> step to remember a
prior part of a traversal can be expensive in terms of memory usage. This will not be
an issue with small graphs such as <code>air-routes</code>, but can be problematic when
working with larger graphs. The query can be rewritten without the use of an <em>as</em>
step as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">(</span><span class="tok-mi">6</span><span class="tok-o">).</span><span class="tok-na">V</span><span class="tok-o">().</span>
  <span class="tok-n">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
  <span class="tok-n">filter</span><span class="tok-o">(</span><span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span>
           <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span>
           <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">sack</span><span class="tok-o">()).</span>
         <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span> <span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">))).</span>
  <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-n">DFW</span>
<span class="tok-n">ORD</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Obviously, while these examples demonstrate the concept, in reality we have not done
anything that truly warrants use of a <em>sack</em> step so far. The query could easily have
been written as shown below. However, hopefully this gives you some basic building
blocks that enable sack and property values to be compared.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">6</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-n">DFW</span>
<span class="tok-n">ORD</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s change our query to make the use of a sack more interesting. The query below
starts at Santa Fe (SAF) and traverses outgoing edges until the distance travelled
exceeds 10,000 miles. Only five results are returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">).</span><span class="tok-na">V</span><span class="tok-o">().</span>
  <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span>
  <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span>
         <span class="tok-n">sack</span><span class="tok-o">(</span><span class="tok-n">sum</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span>
         <span class="tok-n">inV</span><span class="tok-o">()).</span>
  <span class="tok-n">until</span><span class="tok-o">(</span><span class="tok-n">sack</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">10000</span><span class="tok-o">))).</span>
  <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span>
  <span class="tok-n">path</span><span class="tok-o">().</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When we run the query we get back a series of routes that stop as soon as we have
travelled more than 10,000 miles.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1560</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-mi">7952</span><span class="tok-o">,</span><span class="tok-n">HKG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1230</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-mi">8287</span><span class="tok-o">,</span><span class="tok-n">DOH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1230</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-mi">8372</span><span class="tok-o">,</span><span class="tok-n">AUH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1230</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-mi">8314</span><span class="tok-o">,</span><span class="tok-n">JED</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">549</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1230</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-mi">8246</span><span class="tok-o">,</span><span class="tok-n">RUH</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, let’s modify the query again to keep following routes starting at SAF, but
this time adding an additional constraint that each route must be no more than 2,500
miles. We keep going until we have travelled more than 8,000 miles. This again
demonstrates how we can use a sack to store a running total over the course of a
graph traversal. This time, the path that was followed along with the total distance
are combined using a <em>union</em> step. I also added a <em>simplePath</em> step to the query to
make sure we do not revisit airports.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Splitting long queries over multiple lines makes them easier to read and
understand.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>You will notice that I have split the queries in this section over multiple lines to
aid readability. As your queries become more complex this becomes more important.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">).</span>
  <span class="tok-n">V</span><span class="tok-o">().</span>
  <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span>
  <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span>
         <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">lte</span><span class="tok-o">(</span><span class="tok-mi">2500</span><span class="tok-o">)).</span>
         <span class="tok-n">sack</span><span class="tok-o">(</span><span class="tok-n">sum</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span>
         <span class="tok-n">inV</span><span class="tok-o">().</span>
         <span class="tok-n">simplePath</span><span class="tok-o">()).</span>
  <span class="tok-n">until</span><span class="tok-o">(</span><span class="tok-n">sack</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">8000</span><span class="tok-o">))).</span>
  <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span>
  <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">union</span><span class="tok-o">(</span><span class="tok-n">path</span><span class="tok-o">().</span>
                <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
                <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span>
              <span class="tok-n">unfold</span><span class="tok-o">(),</span>
              <span class="tok-n">sack</span><span class="tok-o">()).</span>
        <span class="tok-n">fold</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The results from running the modified query are shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">708</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-mi">2481</span><span class="tok-o">,</span><span class="tok-n">OGG</span><span class="tok-o">,</span><span class="tok-mi">2401</span><span class="tok-o">,</span><span class="tok-n">SMF</span><span class="tok-o">,</span><span class="tok-mi">2492</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-mi">8082</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">708</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-mi">2481</span><span class="tok-o">,</span><span class="tok-n">OGG</span><span class="tok-o">,</span><span class="tok-mi">2401</span><span class="tok-o">,</span><span class="tok-n">SMF</span><span class="tok-o">,</span><span class="tok-mi">2459</span><span class="tok-o">,</span><span class="tok-n">HNL</span><span class="tok-o">,</span><span class="tok-mi">8049</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">708</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-mi">2481</span><span class="tok-o">,</span><span class="tok-n">OGG</span><span class="tok-o">,</span><span class="tok-mi">2352</span><span class="tok-o">,</span><span class="tok-n">SJC</span><span class="tok-o">,</span><span class="tok-mi">2462</span><span class="tok-o">,</span><span class="tok-n">LIH</span><span class="tok-o">,</span><span class="tok-mi">8003</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">708</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-mi">2500</span><span class="tok-o">,</span><span class="tok-n">KOA</span><span class="tok-o">,</span><span class="tok-mi">2375</span><span class="tok-o">,</span><span class="tok-n">OAK</span><span class="tok-o">,</span><span class="tok-mi">2440</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">,</span><span class="tok-mi">8023</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-mi">708</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-mi">2500</span><span class="tok-o">,</span><span class="tok-n">KOA</span><span class="tok-o">,</span><span class="tok-mi">2375</span><span class="tok-o">,</span><span class="tok-n">OAK</span><span class="tok-o">,</span><span class="tok-mi">2453</span><span class="tok-o">,</span><span class="tok-n">LIH</span><span class="tok-o">,</span><span class="tok-mi">8036</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="lambdas">4.12. Using Lambda functions</h3>
<div class="paragraph">
<p>Gremlin allows you to include a code fragment (sometimes called a Lambda function or
a closure) as part of a query. This is typically done as part of a <em>filter</em>, <em>map</em> or
<em>sideEffect</em> step but there are other places where you will find this concept used
such as when working with <em>sacks</em>. This technique provides a lot of additional
flexibility in how queries can be written. However, care should be used. When
processing your query, Gremlin will try to optimize it as best as it can. For regular
traversal steps such as <em>out</em> and <em>has</em> Gremlin will do this optimization for you.
However for closures (code inside braces <em>{}</em>) Gremlin cannot do this and will just
pass the closure on to the underlying runtime. With people just getting started with
Gremlin there is a great temptation to over use in-line code. This is a natural thing
to want to do as for programmers it feels like the programming they are used to.
However, there is often, if not always, a pure Gremlin traversal step that can be
used to do what is needed. Of course with all rules there are exceptions.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For reasons of security not all graph databases, especially those that are
managed as hosted services, allow lambdas to be included in queries. You should
always check the documentation for the graph database that you are using.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>By way of a very simple example, the code below declares a variable <em>"c"</em> and
initializes it to zero. The Gremlin query that follows then adds one to <em>"c"</em> each
time it finds an airport vertex located in Oregon. We then use a <em>println</em> to display
the updated value for <em>"c"</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">c</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-OR'</span><span class="tok-o">).</span><span class="tok-na">sideEffect</span><span class="tok-o">{</span> <span class="tok-n">c</span> <span class="tok-o">+=</span> <span class="tok-mi">1</span> <span class="tok-o">}.</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-n">println</span> <span class="tok-s2">"I found ${c} airports in Oregon"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When we run our query here is what comes back.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">PDX</span><span class="tok-o">,</span><span class="tok-n">EUG</span><span class="tok-o">,</span><span class="tok-n">LMT</span><span class="tok-o">,</span><span class="tok-n">MFR</span><span class="tok-o">,</span><span class="tok-n">OTH</span><span class="tok-o">,</span><span class="tok-n">RDM</span><span class="tok-o">,</span><span class="tok-n">PDT</span><span class="tok-o">]</span>
<span class="tok-n">I</span> <span class="tok-n">found</span> <span class="tok-mi">7</span> <span class="tok-n">airports</span> <span class="tok-k">in</span> <span class="tok-n">Oregon</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, in reality we would probably just use a <em>count</em> when counting things or
put them into a list and look at the size of the list returned  but
the above example gives a nice, and hopefully easy to understand, example of a
closure being used as part of a <em>sideEffect</em> step.</p>
</div>
<div class="paragraph">
<p>For completeness, here is the query re-written a couple of different ways without the
use of a <em>sideEffect</em> or closures. If all we wanted was the count we could do this of
course.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">num</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-OR'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()</span>
<span class="tok-n">println</span> <span class="tok-s2">"I found ${num} airports in Oregon"</span>

<span class="tok-n">I</span> <span class="tok-n">found</span> <span class="tok-mi">7</span> <span class="tok-n">airports</span> <span class="tok-k">in</span> <span class="tok-n">Oregon</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we wanted to save a list of the airport codes found and also count them we could
do this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">oregon</span> <span class="tok-o">=</span> <span class="tok-o">[]</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-OR'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fill</span><span class="tok-o">(</span><span class="tok-n">oregon</span><span class="tok-o">);[]</span>
<span class="tok-n">println</span> <span class="tok-n">oregon</span>
<span class="tok-n">println</span> <span class="tok-s2">"I found ${oregon.size} airports in Oregon"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the output, this time  with the airport codes and the count.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">PDX</span><span class="tok-o">,</span> <span class="tok-n">EUG</span><span class="tok-o">,</span> <span class="tok-n">LMT</span><span class="tok-o">,</span> <span class="tok-n">MFR</span><span class="tok-o">,</span> <span class="tok-n">OTH</span><span class="tok-o">,</span> <span class="tok-n">RDM</span><span class="tok-o">,</span> <span class="tok-n">PDT</span><span class="tok-o">]</span>
<span class="tok-n">I</span> <span class="tok-n">found</span> <span class="tok-mi">7</span> <span class="tok-n">airports</span> <span class="tok-k">in</span> <span class="tok-n">Oregon</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is another example of a closure being used where a <em>has</em> step could and should
have been used instead.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// What airports are located in London?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">filter</span><span class="tok-o">{</span><span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">().</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">value</span><span class="tok-o">()</span> <span class="tok-o">==</span><span class="tok-s2">"London"</span><span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the same query just using the <em>has()</em> step. This is a case where we
should not be using a lambda function as Gremlin can handle this just fine all
by itself.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// What airports are located in London?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'London'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I think you will agree that the second version is a lot simpler to read and
enables Gremlin to do its thing.</p>
</div>
<div class="paragraph">
<p>Here is one more example of a query that contains a <em>sideEffect</em> step.
The main part of the query finds airports with 6 runways and counts them. That result
will still be returned but the side effect will also cause the codes of those
airports to also be printed. This is a bit of a contrived example but it shows how
<em>sideEffect</em> behaves when combined with a closure.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Example of the 'sideEffect' step</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">).</span><span class="tok-na">sideEffect</span><span class="tok-o">{</span><span class="tok-n">print</span> <span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()+</span><span class="tok-s2">" "</span><span class="tok-o">}.</span><span class="tok-na">count</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The moral here is, avoid closures unless you can genuinely find no other way to
achieve what you need. It is fair I think to observe that sometimes coming up with a
closure to do what you want is easier than figuring out the pure Gremlin way to do it
but if at all possible using just Gremlin steps is still the recommended path to
take. Lambda functions in general are discouraged.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Gremlin currently does not have any regular expression support built in to the
language. However, as we will explore later in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#janpred">Additional JanusGraph text search predicates</a>" section, JanusGraph
does provide some support. When working with a graph, such as TinkerGraph, that has
no built in regular expression support you can use a <em>filter</em> step combined with a
Lambda as shown in the following two examples. The examples take advantage of methods
provided by the Java String class. Support for additional text search predicates is
likely to appear in future Apache TinkerPop releases.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">filter</span><span class="tok-o">{</span> <span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">().</span><span class="tok-na">value</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">startsWith</span><span class="tok-o">(</span><span class="tok-s1">'Dal'</span><span class="tok-o">)}.</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When the query is run, all the airport city names matching the pattern are found.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">Dallas</span>
<span class="tok-n">Dallas</span>
<span class="tok-n">Dalaman</span>
<span class="tok-n">Dalian</span>
<span class="tok-n">Dalcahue</span>
<span class="tok-n">Dalat</span>
<span class="tok-n">Dalanzadgad</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The next example uses a <em>filter</em> step combined with a closure to
find any airport vertex that has a description containing the letter <em>"F"</em> followed by
a period, as in <em>"F."</em>. While this makes an interesting example, there are other ways
to achieve this result. One such way would be to used a mixed index and special text
searching predicates. That, however, is a topic for quite a bit later on.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">).</span>
     <span class="tok-n">filter</span><span class="tok-o">{</span><span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">toString</span><span class="tok-o">().</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-s1">'F.'</span><span class="tok-o">)}.</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
     <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'desc'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">())</span>

<span class="tok-o">[</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-n">New</span> <span class="tok-n">York</span> <span class="tok-n">John</span> <span class="tok-n">F</span><span class="tok-o">.</span> <span class="tok-n">Kennedy</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">BDA</span><span class="tok-o">,</span><span class="tok-n">Bermuda</span><span class="tok-o">,</span> <span class="tok-n">L</span><span class="tok-o">.</span><span class="tok-na">F</span><span class="tok-o">.</span> <span class="tok-n">Wade</span> <span class="tok-n">International</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SLU</span><span class="tok-o">,</span><span class="tok-n">George</span> <span class="tok-n">F</span><span class="tok-o">.</span> <span class="tok-n">L</span><span class="tok-o">.</span> <span class="tok-n">Charles</span> <span class="tok-n">Airport</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EUX</span><span class="tok-o">,</span><span class="tok-n">F</span><span class="tok-o">.</span> <span class="tok-n">D</span><span class="tok-o">.</span> <span class="tok-n">Roosevelt</span> <span class="tok-n">Airport</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You will see more examples of how to use Lambda expressions with the <em>filter</em> step in
the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#fuzzyregs">Using regular expressions to do fuzzy searches</a>" section.</p>
</div>
<div class="sect3">
<h4 id="mapstep">4.12.1. Introducing the <em>Map</em> step</h4>
<div class="paragraph">
<p>The <em>map</em> step will be familiar to users of programming languages such as Ruby,
Python or indeed Groovy. It is often useful to be able to take a set of results, or
in the case of Gremlin, the current state of a graph traversal, and modify it in some
way before passing on those results to the next part of the traversal. This is what
the <em>map</em> step allows us to do.</p>
</div>
<div class="paragraph">
<p>The <em>map</em> step can accept a traversal or a closure as input. The results of the
traversal or closure will be passed on to the next step in the overall traversal.
Below is a simple example of a <em>map</em> step using a traversal to modify what is passed
on.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">map</span><span class="tok-o">(</span><span class="tok-n">properties</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When this query is run the output returned is the selected vertex properties for each
of the 10 airports that were selected.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">city</span><span class="tok-o">-&gt;</span><span class="tok-n">Atlanta</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">city</span><span class="tok-o">-&gt;</span><span class="tok-n">Anchorage</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">city</span><span class="tok-o">-&gt;</span><span class="tok-n">Austin</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">city</span><span class="tok-o">-&gt;</span><span class="tok-n">Nashville</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">city</span><span class="tok-o">-&gt;</span><span class="tok-n">Boston</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">city</span><span class="tok-o">-&gt;</span><span class="tok-n">Baltimore</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">city</span><span class="tok-o">-&gt;</span><span class="tok-n">Washington</span> <span class="tok-n">D</span><span class="tok-o">.</span><span class="tok-na">C</span><span class="tok-o">.]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">city</span><span class="tok-o">-&gt;</span><span class="tok-n">Dallas</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">city</span><span class="tok-o">-&gt;</span><span class="tok-n">Fort</span> <span class="tok-n">Lauderdale</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">city</span><span class="tok-o">-&gt;</span><span class="tok-n">Washington</span> <span class="tok-n">D</span><span class="tok-o">.</span><span class="tok-na">C</span><span class="tok-o">.]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could go one step further and have the <em>map</em> step produce a key and value map for
us.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
       <span class="tok-n">map</span><span class="tok-o">(</span><span class="tok-n">properties</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">key</span><span class="tok-o">()).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">()))</span>

<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Atlanta</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Anchorage</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Austin</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Nashville</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Boston</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Baltimore</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Washington</span> <span class="tok-n">D</span><span class="tok-o">.</span><span class="tok-na">C</span><span class="tok-o">.]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Dallas</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Fort</span> <span class="tok-n">Lauderdale</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-n">Washington</span> <span class="tok-n">D</span><span class="tok-o">.</span><span class="tok-na">C</span><span class="tok-o">.]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As I mentioned above, in many cases, a <em>map</em> step is used in the middle of a query to
change what is passed on to the next step. The example below takes the output from
the <em>map</em> step and sorts the results in descending order based on the city names.
Obviously there are simpler ways we could write this query but this demonstrates what
<em>map</em> does quite well.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">map</span><span class="tok-o">(</span><span class="tok-n">properties</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">key</span><span class="tok-o">()).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">())).</span>
      <span class="tok-n">unfold</span><span class="tok-o">().</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">,</span><span class="tok-n">asc</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the output from running the query showing the sorted city names.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">city</span><span class="tok-o">=</span><span class="tok-n">Anchorage</span>
<span class="tok-n">city</span><span class="tok-o">=</span><span class="tok-n">Atlanta</span>
<span class="tok-n">city</span><span class="tok-o">=</span><span class="tok-n">Austin</span>
<span class="tok-n">city</span><span class="tok-o">=</span><span class="tok-n">Baltimore</span>
<span class="tok-n">city</span><span class="tok-o">=</span><span class="tok-n">Boston</span>
<span class="tok-n">city</span><span class="tok-o">=</span><span class="tok-n">Dallas</span>
<span class="tok-n">city</span><span class="tok-o">=</span><span class="tok-n">Fort</span> <span class="tok-n">Lauderdale</span>
<span class="tok-n">city</span><span class="tok-o">=</span><span class="tok-n">Nashville</span>
<span class="tok-n">city</span><span class="tok-o">=</span><span class="tok-n">Washington</span> <span class="tok-n">D</span><span class="tok-o">.</span><span class="tok-na">C</span><span class="tok-o">.</span>
<span class="tok-n">city</span><span class="tok-o">=</span><span class="tok-n">Washington</span> <span class="tok-n">D</span><span class="tok-o">.</span><span class="tok-na">C</span><span class="tok-o">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In some cases there are other steps, such as the <em>values</em> step that can be used as a
shorthand form of a <em>map</em> step. The following two queries yield the same results for
example. There is no need to write an explicit <em>map</em> step when a shorthand form
exists.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">map</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">Atlanta</span><span class="tok-o">,</span><span class="tok-n">Anchorage</span><span class="tok-o">,</span><span class="tok-n">Austin</span><span class="tok-o">,</span><span class="tok-n">Nashville</span><span class="tok-o">,</span><span class="tok-n">Boston</span><span class="tok-o">,</span><span class="tok-n">Baltimore</span><span class="tok-o">,</span><span class="tok-n">Washington</span> <span class="tok-n">D</span><span class="tok-o">.</span><span class="tok-na">C</span><span class="tok-o">.,</span><span class="tok-n">Dallas</span><span class="tok-o">,</span><span class="tok-n">Fort</span> <span class="tok-n">Lauderdale</span><span class="tok-o">,</span><span class="tok-n">Washington</span> <span class="tok-n">D</span><span class="tok-o">.</span><span class="tok-na">C</span><span class="tok-o">.]</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">Atlanta</span><span class="tok-o">,</span><span class="tok-n">Anchorage</span><span class="tok-o">,</span><span class="tok-n">Austin</span><span class="tok-o">,</span><span class="tok-n">Nashville</span><span class="tok-o">,</span><span class="tok-n">Boston</span><span class="tok-o">,</span><span class="tok-n">Baltimore</span><span class="tok-o">,</span><span class="tok-n">Washington</span> <span class="tok-n">D</span><span class="tok-o">.</span><span class="tok-na">C</span><span class="tok-o">.,</span><span class="tok-n">Dallas</span><span class="tok-o">,</span><span class="tok-n">Fort</span> <span class="tok-n">Lauderdale</span><span class="tok-o">,</span><span class="tok-n">Washington</span> <span class="tok-n">D</span><span class="tok-o">.</span><span class="tok-na">C</span><span class="tok-o">.]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let’s look at an example where a lambda function (closure) is used. First of
all, take a look at the query below. It simply returns us a list containing the IDs
of the first ten airports in the graph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">id</span><span class="tok-o">().</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-mi">10</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Imagine we wanted to write a query, similar to the one above, that will modify each
of those IDs returned in the query above by adding one to each. Take a look at the
query below. We have introduced a <em>map</em> step. The <em>map</em> step takes as a parameter a
closure (or lambda) function telling it how we want it to operate on the values
flowing in to it. The <em>it</em> is Groovy syntax for <em>"the thing that came in"</em> (in this
case a traversal). The <em>get</em> is needed to gain access to the current vertex and its
properties. Lastly we get the <em>id</em> of the vertex and add one to it. The modified
values are then passed on to the next step of the traversal where they are made into
a list by the <em>fold</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">map</span><span class="tok-o">{</span><span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">().</span><span class="tok-na">id</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-o">}.</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-mi">11</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is an area where Groovy and Java have a similar but different syntax.
If you wanted to use the query above in a Java program you would need to use the
Java lambda function syntax.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>What is nice about the <em>map</em> step is that it allows us to do within the query itself
what we would otherwise have to do after the query was over using a <em>for each</em> type
of loop construct.</p>
</div>
<div class="paragraph">
<p>One other thing to note about the <em>map</em> step is that the closure provided can have
multiple steps, separated by semi-colons. The following query demonstrates this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">map</span><span class="tok-o">{</span><span class="tok-n">a</span><span class="tok-o">=</span><span class="tok-mi">1</span><span class="tok-o">;</span><span class="tok-n">b</span><span class="tok-o">=</span><span class="tok-mi">2</span><span class="tok-o">;</span><span class="tok-n">c</span><span class="tok-o">=</span><span class="tok-n">a</span><span class="tok-o">+</span><span class="tok-n">b</span><span class="tok-o">;</span><span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">().</span><span class="tok-na">id</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-n">c</span><span class="tok-o">}.</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-mi">11</span><span class="tok-o">,</span><span class="tok-mi">12</span><span class="tok-o">,</span><span class="tok-mi">13</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that only the value from the last expression in the closure is returned from the
<em>map</em>. So in the example above the result of <em>c=a+b</em>, 3, is added to each ID.</p>
</div>
<div class="paragraph">
<p>As we have already seen, there are often multiple ways to achieve the same result
when working with Gremlin. It is also true that some ways are almost always better
than others in terms of performance or some other metric. In the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#sackintro">Introducing <em>sack</em> as a way to store values</a>" we
used a <em>sack</em> step to add one to a set of results as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
              <span class="tok-n">sack</span><span class="tok-o">(</span><span class="tok-n">sum</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">().</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could achieve the same result using a <em>map</em> step. However, doing so introduces the
need to use a closure which the version using <em>sack</em> avoids. Avoiding unnecessary use
of closures is a Gremlin best practice.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">map</span><span class="tok-o">{</span><span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-o">}.</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the next section we will take a look at some other cases where lambda expressions
are very useful as well as a few more examples of the <em>map</em> step being used.</p>
</div>
</div>
<div class="sect3">
<h4 id="lambdasack">4.12.2. Using lambdas with <em>sack</em> steps</h4>
<div class="paragraph">
<p>In the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#sackaddall">Using <em>addAll</em> and lists with a <em>sack</em></a>" section we introduced ways in which <em>sack</em> steps could
operate on lists. Now that we know a bit more about the <em>map</em> step and how Gremlin
can take advantage of Groovy closures (lambda functions) we can explore some
additional ways of working with sacks.</p>
</div>
<div class="paragraph">
<p>When we looked at <em>sack</em> steps and lists earlier we used the query below as one of
the examples.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">{[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">]}{</span><span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">clone</span><span class="tok-o">()}</span><span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span>
       <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">local</span><span class="tok-o">(</span><span class="tok-n">fold</span><span class="tok-o">().</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">addAll</span><span class="tok-o">)).</span><span class="tok-na">sack</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have looked at <em>map</em> steps, another way we could write the query, not
necessarily the best way, but it does illustrate use of a <em>map</em>, is shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">{[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">]}{</span><span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">clone</span><span class="tok-o">()}</span><span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
     <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">map</span><span class="tok-o">{</span><span class="tok-n">x</span><span class="tok-o">-&gt;[</span><span class="tok-n">x</span><span class="tok-o">]}.</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">addAll</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Just for completeness, here is what would happen if we ran the same query, without
the <em>clone</em> (or split) being used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">([</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">]).</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
     <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">map</span><span class="tok-o">{</span><span class="tok-n">x</span><span class="tok-o">-&gt;[</span><span class="tok-n">x</span><span class="tok-o">]}.</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">addAll</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A different way we could write the query, and this is something that we have not yet
examined in this book, is to use a closure directly with the <em>sack</em> step itself.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">([</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">]).</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">{</span><span class="tok-n">a</span><span class="tok-o">,</span><span class="tok-n">v</span><span class="tok-o">-&gt;</span><span class="tok-n">a</span><span class="tok-o">+=[</span><span class="tok-n">v</span><span class="tok-o">]}.</span><span class="tok-na">sack</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could also initialize the sack with a map <em>"[:]</em>" instead of a list and use a
lambda function to manipulate it as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">{[:]}{</span><span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">clone</span><span class="tok-o">()}.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
     <span class="tok-n">sack</span> <span class="tok-o">{</span><span class="tok-n">m</span><span class="tok-o">,</span><span class="tok-n">v</span><span class="tok-o">-&gt;</span><span class="tok-n">m</span><span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">.</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()]=</span><span class="tok-n">v</span><span class="tok-o">.</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">();</span><span class="tok-n">m</span><span class="tok-o">}.</span><span class="tok-na">sack</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-nl">DFW:</span><span class="tok-mi">7</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">LAX:</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">PHX:</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">DEN:</span><span class="tok-mi">6</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Just to show what happens, here is the same query with the <em>clone</em> step removed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">([:]).</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
     <span class="tok-n">sack</span> <span class="tok-o">{</span><span class="tok-n">m</span><span class="tok-o">,</span><span class="tok-n">v</span><span class="tok-o">-&gt;</span><span class="tok-n">m</span><span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">.</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()]=</span><span class="tok-n">v</span><span class="tok-o">.</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">();</span><span class="tok-n">m</span><span class="tok-o">}.</span><span class="tok-na">sack</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-nl">DFW:</span><span class="tok-mi">7</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">DFW:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">LAX:</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">DFW:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">LAX:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">PHX:</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">DFW:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">LAX:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">PHX:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">DEN:</span><span class="tok-mi">6</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If all we wanted back was a single list of key value pairs, such as the one in the
last line of the output above, we can write a query to do that. One way we could do
it is to use a <em>map</em> and not use a <em>sack</em> step at all as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">map</span><span class="tok-o">{</span><span class="tok-n">m</span><span class="tok-o">=[:];</span><span class="tok-n">m</span><span class="tok-o">[</span><span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()]=</span>
      <span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">();</span><span class="tok-n">m</span><span class="tok-o">}.</span><span class="tok-na">unfold</span><span class="tok-o">().</span><span class="tok-na">fold</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">().</span><span class="tok-na">getClass</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">=</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">=</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-n">PHX</span><span class="tok-o">=</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-n">DEN</span><span class="tok-o">=</span><span class="tok-mi">6</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, doing it using a <em>sack</em> feels cleaner in my view, as shown below. Note that
in this case what is returned is a Java LinkedHashMap data structure whereas the
previous query generated an ArrayList of  LinkedHashMap.Entry objects. Also, it is
worth noting that all we had to do to get the result that we wanted in this case was
to add a <em>fold</em> step between the <em>sack</em> steps.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">([:]).</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">sack</span><span class="tok-o">{</span><span class="tok-n">m</span><span class="tok-o">,</span><span class="tok-n">v</span> <span class="tok-o">-&gt;</span> <span class="tok-n">m</span><span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">.</span><span class="tok-na">value</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)]=</span><span class="tok-n">v</span><span class="tok-o">.</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()}.</span><span class="tok-na">fold</span><span class="tok-o">().</span><span class="tok-na">sack</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-nl">DFW:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">LAX:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">PHX:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">DEN:</span><span class="tok-mi">6</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are other ways that you might choose to write queries like these, that avoid the
use of closures altogether, but hopefully these examples show some interesting ways
that closures can be combined with <em>sack</em> steps.</p>
</div>
</div>
<div class="sect3">
<h4 id="flatmap">4.12.3. Introducing the <em>flatMap</em> step</h4>
<div class="paragraph">
<p>There are a set of fundamental steps that the other Gremlin query language steps
build upon. One of those is <em>map</em>. Another, that we have not looked at so far in
this book, is <em>flatMap</em>. The two steps are similar but have a fundamental difference
that may not be obvious from the examples we have looked at so far. The key
difference is as follows. If a <em>map</em> step receives multiple inputs it only passes on
the first one it received to the next step whereas a <em>flatMap</em> step passes them all
on. Let’s look at a couple of examples that demonstrate this and then look at how we
can take advantage of this in practice.</p>
</div>
<div class="paragraph">
<p>The example below shows what happens when an <em>out</em> step is used inside of a <em>map</em>
step. Only the first vertex that was encountered is returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">map</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">())</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we do the same experiment but using a <em>flatMap</em> step you can see that all of the
vertices are returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">flatMap</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">())</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">]</span>
<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">13</span><span class="tok-o">]</span>
<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">20</span><span class="tok-o">]</span>
<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">31</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Where a flatMap can be useful is in a case like the one below. The example is a bit
contrived but there are situations where being able to do things like this come in
quite handy. Take a look at the query below. It starts off by finding the AUS vertex.
Next it traverses all of the outgoing edges, finds the vertices at the end of those
edges and returns all  the paths travelled. Notice that both the city names and the
edge are included in the results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">inV</span><span class="tok-o">().</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">().</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">Austin</span><span class="tok-o">,</span><span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">3712</span><span class="tok-o">][</span><span class="tok-mi">3</span><span class="tok-o">-</span><span class="tok-n">route</span><span class="tok-o">-&gt;</span><span class="tok-mi">43</span><span class="tok-o">],</span><span class="tok-n">Tucson</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">Austin</span><span class="tok-o">,</span><span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">3713</span><span class="tok-o">][</span><span class="tok-mi">3</span><span class="tok-o">-</span><span class="tok-n">route</span><span class="tok-o">-&gt;</span><span class="tok-mi">45</span><span class="tok-o">],</span><span class="tok-n">Philadelphia</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">Austin</span><span class="tok-o">,</span><span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">3714</span><span class="tok-o">][</span><span class="tok-mi">3</span><span class="tok-o">-</span><span class="tok-n">route</span><span class="tok-o">-&gt;</span><span class="tok-mi">46</span><span class="tok-o">],</span><span class="tok-n">Detroit</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s imagine we have a good reason for needing to look at the edge but that we don’t
want the edge to be part of the result. What we can do is put the <em>outE().inV()</em> part
of the traversal inside a <em>flatMap</em>. As we know from our tests above, a <em>flatMap</em>
will return all of the results passed into it, which in this case will be the
incoming vertices connected to the edges. When we now perform the <em>path</em> step, the
edge details are no longer part of the path because they were essentially removed
from the path by the <em>flatMap</em> step. This is a useful pattern to be aware of as it
can come in handy in some cases.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Hide the edge from the path!</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">flatMap</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">inV</span><span class="tok-o">()).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">Austin</span><span class="tok-o">,</span><span class="tok-n">Tucson</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">Austin</span><span class="tok-o">,</span><span class="tok-n">Philadelphia</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">Austin</span><span class="tok-o">,</span><span class="tok-n">Detroit</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We cannot use a <em>map</em> step to achieve the same result as it will only return the first
path as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">map</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">inV</span><span class="tok-o">()).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">Austin</span><span class="tok-o">,</span><span class="tok-n">Tucson</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, if all we really wanted was the result from the prior query we could just
do this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">Austin</span><span class="tok-o">,</span><span class="tok-n">Tucson</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">Austin</span><span class="tok-o">,</span><span class="tok-n">Philadelphia</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">Austin</span><span class="tok-o">,</span><span class="tok-n">Detroit</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lastly, here is one more case where a <em>flatMap</em> can be useful. In the example below I
wanted to check the property on an edge as part of a <em>repeat</em> step but not have the
edge itself be included in the resultant paths. The query uses the route distance to
filter out routes between airports that are shorter than 2,000 miles.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">flatMap</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">2000</span><span class="tok-o">)).</span><span class="tok-na">inV</span><span class="tok-o">())).</span>
      <span class="tok-n">times</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span>
      <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When the query is run the results returned only include the vertices. Note that once
again, the <em>flatMap</em> step differs from the <em>map</em> step in that for each path being
explored, it allows the last result generated, in this case the result of the <em>inV</em>
step, to pass to the next step in the traversal.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">49</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">61</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">49</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">64</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">49</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">67</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">49</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">69</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">49</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">71</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The query below has the  <em>flatMap</em> step removed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">2000</span><span class="tok-o">)).</span><span class="tok-na">inV</span><span class="tok-o">()).</span>
      <span class="tok-n">times</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span>
      <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When run, this time the results do indeed include the edges as well as the vertices.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">5162</span><span class="tok-o">][</span><span class="tok-mi">3</span><span class="tok-o">-</span><span class="tok-n">route</span><span class="tok-o">-&gt;</span><span class="tok-mi">49</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">49</span><span class="tok-o">],</span><span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">8448</span><span class="tok-o">][</span><span class="tok-mi">49</span><span class="tok-o">-</span><span class="tok-n">route</span><span class="tok-o">-&gt;</span><span class="tok-mi">61</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">61</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">5162</span><span class="tok-o">][</span><span class="tok-mi">3</span><span class="tok-o">-</span><span class="tok-n">route</span><span class="tok-o">-&gt;</span><span class="tok-mi">49</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">49</span><span class="tok-o">],</span><span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">8449</span><span class="tok-o">][</span><span class="tok-mi">49</span><span class="tok-o">-</span><span class="tok-n">route</span><span class="tok-o">-&gt;</span><span class="tok-mi">64</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">64</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">5162</span><span class="tok-o">][</span><span class="tok-mi">3</span><span class="tok-o">-</span><span class="tok-n">route</span><span class="tok-o">-&gt;</span><span class="tok-mi">49</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">49</span><span class="tok-o">],</span><span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">8450</span><span class="tok-o">][</span><span class="tok-mi">49</span><span class="tok-o">-</span><span class="tok-n">route</span><span class="tok-o">-&gt;</span><span class="tok-mi">67</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">67</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">5162</span><span class="tok-o">][</span><span class="tok-mi">3</span><span class="tok-o">-</span><span class="tok-n">route</span><span class="tok-o">-&gt;</span><span class="tok-mi">49</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">49</span><span class="tok-o">],</span><span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">8452</span><span class="tok-o">][</span><span class="tok-mi">49</span><span class="tok-o">-</span><span class="tok-n">route</span><span class="tok-o">-&gt;</span><span class="tok-mi">69</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">69</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">5162</span><span class="tok-o">][</span><span class="tok-mi">3</span><span class="tok-o">-</span><span class="tok-n">route</span><span class="tok-o">-&gt;</span><span class="tok-mi">49</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">49</span><span class="tok-o">],</span><span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">8454</span><span class="tok-o">][</span><span class="tok-mi">49</span><span class="tok-o">-</span><span class="tok-n">route</span><span class="tok-o">-&gt;</span><span class="tok-mi">71</span><span class="tok-o">],</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">71</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="fuzzyregs">4.12.4. Using regular expressions to do fuzzy searches</h4>
<div class="paragraph">
<p>Let’s take a look at one case where use of closures might be helpful. It is a
common requirement when working with any kind of database to want to do some
sort of fuzzy text search or even to search using a regular expression. TinkerPop 3
itself does not provide direct support for this. In other words there
currently is no sophisticated text search method beyond the basic <em>has()</em> type steps
we have looked at above. However, the underlying graph store can still expose
such capabilities.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Most TinkerPop enabled graph stores that you are likely to use for any sort of
serious deployment will also be backed by an indexing technology like Solr or
Elasticsearch. In those cases some amount of more sophisticated search methods will
likely be made available to you. You should always check the documentation for the
system you are using to see what is recommended.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>When working with Tinkergraph and the Gremlin console if we want to do any
sort of text search beyond very basic things like <em>city == "Dallas"</em> then we
will have to fall back on the Lambda function concept to take advantage of
underlying Groovy and Java features. Note that even in graph
systems backed by a real index the examples we are about to look at should
still work but may not be the preferred way.</p>
</div>
<div class="paragraph">
<p>So let’s look at some examples. First of all, every airport in the air routes
graph contains a description which will be something like <em>Dallas Fort Worth
International Airport</em> in the case of DFW. If we wanted to search the vertices in
the graph for any airport that has the word <em>Dallas</em> in the description we
could take advantage of the Groovy <em>String.contains()</em> method and do it like this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Airport descriptions containing the word 'Dallas'</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">filter</span><span class="tok-o">{</span><span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">().</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">).</span><span class="tok-na">value</span><span class="tok-o">().</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-s1">'Dallas'</span><span class="tok-o">)}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Where things get even more interesting is when you want to use a regular
expression as part of a query. Note that the first example below could also be
achieved using a Gremlin <em>within()</em> step as it is still really doing exact
string comparisons but it gives us a template for how to write any query
containing a regular expression. The example that follows finds all airports
in cities with names that begin with <em>Dal</em> so it will find Dallas, Dalaman, Dalian,
Dalcahue, Dalat and Dalanzadgad!.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Using a filter to search using a regular expression</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'type'</span><span class="tok-o">,</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">filter</span><span class="tok-o">{</span><span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">().</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">value</span> <span class="tok-o">==~</span><span class="tok-s">/Dallas|Austin/</span><span class="tok-o">}.</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-c1">// A regular expression to find any airport with a city name that begins with "Dal"</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'type'</span><span class="tok-o">,</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">filter</span><span class="tok-o">{</span><span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">().</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">value</span><span class="tok-o">()==~</span><span class="tok-s">/^Dal\w*/</span><span class="tok-o">}.</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So in summary it is useful to know about closures and the way you can use them
with filters but as stated above - use them sparingly and only when a "pure
Gremlin" alternative does not present itself.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We could actually go one step further and create a custom predicate (see
next section) that handles regular expressions for us.
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="pred">4.13. Creating custom tests (predicates)</h3>
<div class="paragraph">
<p>TinkerPop comes with a set of built in methods that can be used for testing values.
These methods are commonly referred to as <em>predicates</em>. Examples of existing Gremlin
predicates include methods like <em>gte()</em>, <em>lte()</em> and <em>neq()</em>. Sometimes, however, it
is useful to be able to define your own custom predicate that can be passed in to a
<em>has(</em>), <em>where()</em> or <em>filter()</em> step as part of a Gremlin query.</p>
</div>
<div class="paragraph">
<p>The following example uses the Groovy closure syntax to define a custom predicate,
called <em>f</em>, that tests the two values passed in to see if <em>x</em> is greater than twice
<em>y</em>. This new predicate can then be used as part of a <em>has()</em> step by using it as a
parameter to the <em>test()</em> method. When <em>f</em> is called, it will be passed two
parameters. The first one will be the value returned in response to asking <em>has()</em> to
return the property called <em>longest</em>. The second parameter passed to <em>f</em> will be the
value of <em>a</em> that we provide. This is a simple example, but shows the flexibility
that Gremlin provides for extending the basic predicates.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Find the average longest runway length.</span>
<span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'longest'</span><span class="tok-o">).</span><span class="tok-na">mean</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()</span>

<span class="tok-c1">// Define a custom predicate</span>
<span class="tok-n">f</span> <span class="tok-o">=</span> <span class="tok-o">{</span><span class="tok-n">x</span><span class="tok-o">,</span><span class="tok-n">y</span> <span class="tok-o">-&gt;</span> <span class="tok-n">x</span> <span class="tok-o">&gt;</span> <span class="tok-n">y</span><span class="tok-o">*</span><span class="tok-mi">2</span><span class="tok-o">}</span>

<span class="tok-c1">// Find airports with runways more than twice the average maximum length.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'longest'</span><span class="tok-o">,</span><span class="tok-n">test</span><span class="tok-o">(</span><span class="tok-n">f</span><span class="tok-o">,</span><span class="tok-n">a</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_creating_a_regular_expression_predicate">4.13.1. Creating a regular expression predicate</h4>
<div class="paragraph">
<p>In the previous section we used a closure to filter values using a regular
expression. Now that we know how to create our own predicates we could go one
step further and create a predicate that accepts regular expressions for us.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Create our method</span>
<span class="tok-n">f</span> <span class="tok-o">=</span> <span class="tok-o">{</span><span class="tok-n">x</span><span class="tok-o">,</span><span class="tok-n">y</span> <span class="tok-o">-&gt;</span> <span class="tok-n">x</span> <span class="tok-o">==~</span> <span class="tok-n">y</span><span class="tok-o">}</span>

<span class="tok-c1">// Use it to find any vertices where the description string starts with 'Dal'</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">,</span><span class="tok-n">test</span><span class="tok-o">(</span><span class="tok-n">f</span><span class="tok-o">,</span><span class="tok-s">/^Dal.*/</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can actually go one step further and create a custom method called <em>regex</em>
rather than use the <em>test</em> method directly. If the following code seems a bit
unclear don’t worry too much. It works and that may be all you need to know.
However if you want to understand the TinkerPop API in more detail the
documentation that can be found on the Apache TinkerPop web page explains things
like <em>P</em> in detail. Also remember that Gremlin is written in Groovy/Java and we
take advantage of that here as well.</p>
</div>
<div class="paragraph">
<p>In the following example, rather than use <em>test</em> directly we use the
<em>BiPredicate</em> functional interface that is part of Java 8. <em>BiPredicate</em> is
sometimes referred to was a <em>two-arity</em> predicate as it takes two parameters. We
will create an implementation of the interface called <em>bp</em>. The interface
requires that we provide one method called <em>test</em> that does the actual
comparison between two objects and returns a simple true or false result. Like
we did in the previous section we simply perform a regular expression compare
using the <em>==~</em> operator.</p>
</div>
<div class="paragraph">
<p>We can then use our <em>bp</em> implementation to build a named closure that we will call
<em>regex</em>. TinkerPop includes a predicate class P that is an implementation of the Java
Predicate functional interface. We we can use <em>P</em> to build our new <em>regex</em> method. We
can then pass <em>regex</em> directly to steps like <em>has</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Create a new BiPredicate that handles regular expression pattern matching</span>
<span class="tok-n">bp</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.</span><span class="tok-na">function</span><span class="tok-o">.</span><span class="tok-na">BiPredicate</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">,</span> <span class="tok-n">String</span><span class="tok-o">&gt;()</span> <span class="tok-o">{</span>
         <span class="tok-kt">boolean</span> <span class="tok-nf">test</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">val</span><span class="tok-o">,</span> <span class="tok-n">String</span> <span class="tok-n">pattern</span><span class="tok-o">)</span> <span class="tok-o">{</span>
           <span class="tok-k">return</span> <span class="tok-n">val</span> <span class="tok-o">==~</span> <span class="tok-n">pattern</span>  <span class="tok-o">}}</span>

<span class="tok-c1">// Create a new closure we can use for regular expression pattern matching.</span>
<span class="tok-n">regex</span> <span class="tok-o">=</span> <span class="tok-o">{</span><span class="tok-k">new</span> <span class="tok-n">P</span><span class="tok-o">(</span><span class="tok-n">bp</span><span class="tok-o">,</span> <span class="tok-n">it</span><span class="tok-o">)}</span>

<span class="tok-c1">// Use our new closure to find descriptions that start with 'Dal'. As this</span>
<span class="tok-c1">// unwinds, the contents of 'desc' are passed to the test method as the first parameter</span>
<span class="tok-c1">// and the regex pattern as the second paramter.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">,</span> <span class="tok-n">regex</span><span class="tok-o">(</span><span class="tok-s">/^Dal.*/</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="vmunroll">4.14. Unrolling the lists returned by <em>valueMap</em></h3>
<div class="paragraph">
<p>In the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#tp34vm">Changes to <em>valueMap</em> introduced in TinkerPop 3.4</a>" section, I showed some examples that used <em>by(unfold())</em> following
a <em>valueMap</em> step unroll property values. As you may recall, this means that single
property values are not returned wrapped inside lists. This feature was introduced in
TinkerPop 3.4. However, you can achieve the same results using earlier versions of
TinkerPop, it just takes a bit more work.</p>
</div>
<div class="paragraph">
<p>In case you jumped ahead to this section, here is an example of the new feature and
the output it produces.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SFO'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">unfold</span><span class="tok-o">()).</span><span class="tok-na">unfold</span><span class="tok-o">()</span>

<span class="tok-n">country</span><span class="tok-o">=</span><span class="tok-n">US</span>
<span class="tok-n">code</span><span class="tok-o">=</span><span class="tok-n">SFO</span>
<span class="tok-n">longest</span><span class="tok-o">=</span><span class="tok-mi">11870</span>
<span class="tok-n">city</span><span class="tok-o">=</span><span class="tok-n">San</span> <span class="tok-n">Francisco</span>
<span class="tok-n">elev</span><span class="tok-o">=</span><span class="tok-mi">13</span>
<span class="tok-n">icao</span><span class="tok-o">=</span><span class="tok-n">KSFO</span>
<span class="tok-n">lon</span><span class="tok-o">=-</span><span class="tok-mf">122.375</span>
<span class="tok-n">type</span><span class="tok-o">=</span><span class="tok-n">airport</span>
<span class="tok-n">region</span><span class="tok-o">=</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">CA</span>
<span class="tok-n">runways</span><span class="tok-o">=</span><span class="tok-mi">4</span>
<span class="tok-n">lat</span><span class="tok-o">=</span><span class="tok-mf">37.6189994812012</span>
<span class="tok-n">desc</span><span class="tok-o">=</span><span class="tok-n">San</span> <span class="tok-n">Francisco</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could use a query like the one below to achieve the same result. A <em>map</em> step is
used to unpackage and then repackage the results of the <em>valueMap</em> step with the
values unrolled from their lists.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SFO'</span><span class="tok-o">).</span>
      <span class="tok-n">valueMap</span><span class="tok-o">().</span>
      <span class="tok-n">map</span><span class="tok-o">(</span><span class="tok-n">unfold</span><span class="tok-o">().</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">keys</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">())).</span>
      <span class="tok-n">unfold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output looks just like that from the prior query, which is good. However, there
is still an issue with the query. It will not do quite what we want if any property
has a list or set of values associated with it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">country</span><span class="tok-o">=</span><span class="tok-n">US</span>
<span class="tok-n">code</span><span class="tok-o">=</span><span class="tok-n">SFO</span>
<span class="tok-n">longest</span><span class="tok-o">=</span><span class="tok-mi">11870</span>
<span class="tok-n">city</span><span class="tok-o">=</span><span class="tok-n">San</span> <span class="tok-n">Francisco</span>
<span class="tok-n">elev</span><span class="tok-o">=</span><span class="tok-mi">13</span>
<span class="tok-n">icao</span><span class="tok-o">=</span><span class="tok-n">KSFO</span>
<span class="tok-n">lon</span><span class="tok-o">=-</span><span class="tok-mf">122.375</span>
<span class="tok-n">type</span><span class="tok-o">=</span><span class="tok-n">airport</span>
<span class="tok-n">region</span><span class="tok-o">=</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">CA</span>
<span class="tok-n">runways</span><span class="tok-o">=</span><span class="tok-mi">4</span>
<span class="tok-n">lat</span><span class="tok-o">=</span><span class="tok-mf">37.6189994812012</span>
<span class="tok-n">desc</span><span class="tok-o">=</span><span class="tok-n">San</span> <span class="tok-n">Francisco</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s imagine we wanted to add an additional region classification of "Bay Area" to
the San Francisco airport vertex. We might do that as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SFO'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-n">list</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'Bay Area'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can look at the valueMap for the <em>region</em> property to validate we now have a list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SFO'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">region:</span><span class="tok-o">[</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">CA</span><span class="tok-o">,</span><span class="tok-n">Bay</span> <span class="tok-n">Area</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we were to use the <em>map</em> step that we just created, it would try to unroll this
property which in this case is not what we want as we want to preserve the list. We
can modify this a little to include a <em>choose</em> step that only unrolls the
list if it has a length of one.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SFO'</span><span class="tok-o">).</span>
      <span class="tok-n">valueMap</span><span class="tok-o">().</span>
      <span class="tok-n">map</span><span class="tok-o">(</span><span class="tok-n">unfold</span><span class="tok-o">().</span>
        <span class="tok-n">group</span><span class="tok-o">().</span>
          <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">keys</span><span class="tok-o">).</span>
          <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">choose</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">),</span>
                    <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">(),</span>
                    <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">)))).</span>
      <span class="tok-n">unfold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This time the results are still unrolled except for the <em>region</em> property which
remained a list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">country</span><span class="tok-o">=</span><span class="tok-n">US</span>
<span class="tok-n">code</span><span class="tok-o">=</span><span class="tok-n">SFO</span>
<span class="tok-n">longest</span><span class="tok-o">=</span><span class="tok-mi">11870</span>
<span class="tok-n">city</span><span class="tok-o">=</span><span class="tok-n">San</span> <span class="tok-n">Francisco</span>
<span class="tok-n">elev</span><span class="tok-o">=</span><span class="tok-mi">13</span>
<span class="tok-n">icao</span><span class="tok-o">=</span><span class="tok-n">KSFO</span>
<span class="tok-n">lon</span><span class="tok-o">=-</span><span class="tok-mf">122.375</span>
<span class="tok-n">type</span><span class="tok-o">=</span><span class="tok-n">airport</span>
<span class="tok-n">region</span><span class="tok-o">=[</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">CA</span><span class="tok-o">,</span> <span class="tok-n">Bay</span> <span class="tok-n">Area</span><span class="tok-o">]</span>
<span class="tok-n">runways</span><span class="tok-o">=</span><span class="tok-mi">4</span>
<span class="tok-n">lat</span><span class="tok-o">=</span><span class="tok-mf">37.6189994812012</span>
<span class="tok-n">desc</span><span class="tok-o">=</span><span class="tok-n">San</span> <span class="tok-n">Francisco</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="graphvars">4.15. Using graph variables to associate metadata with a graph</h3>
<div class="paragraph">
<p>TinkerPop 3 introduced the concept of graph variables. A graph variable is a
key/value pair that can be associated with the graph itself. Graph variables are not
considered part of the graph that you would process with Gremlin traversals but are
in essence a way to associate metadata with a graph. You can set and retrieve graph
variables using the <em>variables</em> method of the graph object. Let’s assume I wanted to
add some metadata that allowed me to record who the maintainer of the <em>air-routes</em>
graph is and when it was last updated. We could do that as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">variables</span><span class="tok-o">().</span><span class="tok-na">set</span><span class="tok-o">(</span><span class="tok-s1">'maintainer'</span><span class="tok-o">,</span><span class="tok-s1">'Kelvin'</span><span class="tok-o">)</span>
<span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">variables</span><span class="tok-o">().</span><span class="tok-na">set</span><span class="tok-o">(</span><span class="tok-s1">'updated'</span><span class="tok-o">,</span><span class="tok-s1">'July 18th 2017'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use any string that makes sense to you when naming your graph variable keys.
We can use the <em>keys</em> method to retrieve the names of any keys currently in place as
graph variables.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">variables</span><span class="tok-o">().</span><span class="tok-na">keys</span><span class="tok-o">()</span>

<span class="tok-n">updated</span>
<span class="tok-n">maintainer</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>asMap</em> method will return any graph variables that are currently set as a map of
key/value pairs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">variables</span><span class="tok-o">().</span><span class="tok-na">asMap</span><span class="tok-o">()</span>

<span class="tok-n">updated</span><span class="tok-o">=</span><span class="tok-n">July</span> <span class="tok-mi">18</span><span class="tok-n">th</span> <span class="tok-mi">2017</span>
<span class="tok-n">maintainer</span><span class="tok-o">=</span><span class="tok-n">Kelvin</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use the <em>get</em> method to retrieve the value of a particular key. Note that the
value returned is an instance of the <em>java.util.Optional</em> class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">variables</span><span class="tok-o">().</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s1">'updated'</span><span class="tok-o">)</span>

<span class="tok-n">Optional</span><span class="tok-o">[</span><span class="tok-n">July</span> <span class="tok-mi">18</span><span class="tok-n">th</span> <span class="tok-mi">2017</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to delete a graph variable you can use the <em>remove</em> method. In this next
example we will delete the <em>maintainer</em> graph variable and re-query the variable map
to prove it has been deleted.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">variables</span><span class="tok-o">().</span><span class="tok-na">remove</span><span class="tok-o">(</span><span class="tok-s1">'maintainer'</span><span class="tok-o">)</span>
<span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">variables</span><span class="tok-o">().</span><span class="tok-na">asMap</span><span class="tok-o">()</span>

<span class="tok-n">updated</span><span class="tok-o">=</span><span class="tok-n">July</span> <span class="tok-mi">18</span><span class="tok-n">th</span> <span class="tok-mi">2017</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tre">4.16. Turning graphs into trees</h3>
<div class="paragraph">
<p>TinkerPop defines a Tree API but it is not that well fleshed out and has not been
updated in a long time. The <em>tree</em> step allows you to create a tree from part of a
graph using a Gremlin traversal. The example below creates a tree, of depth 3, where
the Austin (AUS) vertex is the root of the tree. The next level of the tree is all
vertices directly connected to AUS. The third level is made up of all the vertices
connected by routes to the vertices in the previous level.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">//Generate a tree the AUS vertex and its neighbors and their neighbors</span>
<span class="tok-n">tree</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
             <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">()).</span>
               <span class="tok-n">times</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">).</span>
             <span class="tok-n">tree</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The object returned to our variable <em>tree</em> will be an instance of the
<em>org.apache.tinkerpop.gremlin.process.traversal.step.util.Tree</em> class. That class
provides a set of methods that can be used when working with a Tree.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Look at part of the tree directly</span>
<span class="tok-n">tree</span><span class="tok-o">[</span><span class="tok-s1">'AUS'</span><span class="tok-o">][</span><span class="tok-s1">'DFW'</span><span class="tok-o">]</span>

<span class="tok-c1">// You can also use the TinkerPop Tree API to work with the tree</span>
<span class="tok-n">tree</span><span class="tok-o">.</span><span class="tok-na">getLeafObjects</span><span class="tok-o">()</span>
<span class="tok-n">tree</span><span class="tok-o">.</span><span class="tok-na">getObjectsAtDepth</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)</span>
<span class="tok-n">tree</span><span class="tok-o">.</span><span class="tok-na">getObjectsAtDepth</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)</span>
<span class="tok-n">tree</span><span class="tok-o">.</span><span class="tok-na">getObjectsAtDepth</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We will see the  Tree API used again in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#btree">Modelling an ordered binary tree as a graph</a>" section later on.</p>
</div>
</div>
<div class="sect2">
<h3 id="subgraph">4.17. Creating a sub graph</h3>
<div class="paragraph">
<p>Using Gremlin, you can create a subgraph which is a subset of the vertices and edges
in a larger graph you are working with. Once created, to work with a sub graph, you
create a traversal source object specific to that new graph and distinct from the one
being used to process the main graph. Subgraphs are created using the <em>subgraph</em>
traversal step. Note that <em>subgraph</em> works with edges (not vertices) and adds both
those edges and the vertices that they connect with to the new subgraph being
created.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can find all of the sample data in the book’s GitHub repository.
<a href="https://github.com/krlawrence/graph/tree/master/sample-data" class="bare">https://github.com/krlawrence/graph/tree/master/sample-data</a>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Let’s start with a simple example. One of the sample data sets shipped with this book
is a small version of the main <em>'air-routes</em>' graph called <code>air-routes-small.graphml</code>.
It contains routes between just the first 46 airports in the full graph. We can quite
easily write a query to generate the subgraph representing the flights between those
airports by extracting the edges and vertices from the full graph. Take a look at the
query below. First we find all the vertices that have an ID between 1 and 46
inclusive. Then we find all of their outgoing edges but filter out any that do not
also end up at an airport within the same ID range of 1 through 46. Lastly we use a
<em>subgraph</em> step to add those edges and vertices to a new subgraph. Note that the
<em>subgraph</em> step has to be given a label. In this case I just used <em>'a'</em>.
This allows us, should we need to, to add to a new subgraph from more that one part
of a traversal. In this case we have no more to add so a <em>cap</em> step is used to
complete the creating of the <em>subgraph</em>. The variable <em>subg</em> will now contain a
reference to the newly created graph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">subg</span><span class="tok-o">=</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">..</span><span class="tok-mi">46</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span>
       <span class="tok-n">filter</span><span class="tok-o">(</span><span class="tok-n">inV</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-mi">1L</span><span class="tok-o">..</span><span class="tok-mi">46L</span><span class="tok-o">))).</span>
       <span class="tok-n">subgraph</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">cap</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that when we run the query, Gremlin shows is that we created a new TinkerGraph
containing 46 vertices and 1326 edges.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">tinkergraph</span><span class="tok-o">[</span><span class="tok-nl">vertices:</span><span class="tok-mi">46</span> <span class="tok-nl">edges:</span><span class="tok-mi">1326</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that the subgraph is created, we need to create a traversal source object for it
so that we can issue queries against it. Gremlin shows us details of the new
traversal source object once it has been created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">sgt</span> <span class="tok-o">=</span> <span class="tok-n">subg</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">()</span>

<span class="tok-n">graphtraversalsource</span><span class="tok-o">[</span><span class="tok-n">tinkergraph</span><span class="tok-o">[</span><span class="tok-nl">vertices:</span><span class="tok-mi">46</span> <span class="tok-nl">edges:</span><span class="tok-mi">1326</span><span class="tok-o">],</span> <span class="tok-n">standard</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have a traversal source object for our newly created subgraph we can run
some queries against it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// What airports are in the subgraph?</span>
<span class="tok-n">sgt</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">BNA</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">,</span><span class="tok-n">DCA</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">FLL</span><span class="tok-o">,</span><span class="tok-n">IAD</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-n">LGA</span><span class="tok-o">,</span><span class="tok-n">MCO</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">,</span><span class="tok-n">MSP</span><span class="tok-o">,</span><span class="tok-n">ORD</span><span class="tok-o">,</span><span class="tok-n">PBI</span><span class="tok-o">,</span><span class="tok-n">PHX</span><span class="tok-o">,</span><span class="tok-n">RDU</span><span class="tok-o">,</span><span class="tok-n">SEA</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">SJC</span><span class="tok-o">,</span><span class="tok-n">TPA</span><span class="tok-o">,</span><span class="tok-n">SAN</span><span class="tok-o">,</span><span class="tok-n">LGB</span><span class="tok-o">,</span><span class="tok-n">SNA</span><span class="tok-o">,</span><span class="tok-n">SLC</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">,</span><span class="tok-n">DEN</span><span class="tok-o">,</span><span class="tok-n">HPN</span><span class="tok-o">,</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-n">MSY</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">CID</span><span class="tok-o">,</span><span class="tok-n">HNL</span><span class="tok-o">,</span><span class="tok-n">HOU</span><span class="tok-o">,</span><span class="tok-n">ELP</span><span class="tok-o">,</span><span class="tok-n">SJU</span><span class="tok-o">,</span><span class="tok-n">CLE</span><span class="tok-o">,</span><span class="tok-n">OAK</span><span class="tok-o">,</span><span class="tok-n">TUS</span><span class="tok-o">,</span><span class="tok-n">SAF</span><span class="tok-o">,</span><span class="tok-n">PHL</span><span class="tok-o">,</span><span class="tok-n">DTW</span><span class="tok-o">]</span>

<span class="tok-c1">// How many of the 46 airports can you fly to from LAX?</span>
<span class="tok-n">sgt</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LAX'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">40</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are some more examples of working with subgraphs. The query below will create a
subgraph of all vertices and edges directly connected to the Austin (AUS) vertex. Note
that using <em>bothE</em> means we get incoming and outgoing edges. In these examples the
more meaningful label <em>subGraph</em> is used to label the subgraph being created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">subg</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">bothE</span><span class="tok-o">().</span>
             <span class="tok-n">subgraph</span><span class="tok-o">(</span><span class="tok-s1">'subGraph'</span><span class="tok-o">).</span><span class="tok-na">cap</span><span class="tok-o">(</span><span class="tok-s1">'subGraph'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we only wanted the outgoing routes from Austin we could change the query to just
use an <em>outE</em> step instead.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">subg</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span>
             <span class="tok-n">subgraph</span><span class="tok-o">(</span><span class="tok-s1">'subGraph'</span><span class="tok-o">).</span><span class="tok-na">cap</span><span class="tok-o">(</span><span class="tok-s1">'subGraph'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The next example is a little more sophisticated. It will create a subgraph starting
with the Austin vertex but this time going out two hops. We achieve this using a
<em>repeat</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">subg</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
       <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">bothE</span><span class="tok-o">().</span><span class="tok-na">subgraph</span><span class="tok-o">(</span><span class="tok-s1">'subGraph'</span><span class="tok-o">).</span><span class="tok-na">outV</span><span class="tok-o">()).</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">).</span>
       <span class="tok-n">cap</span><span class="tok-o">(</span><span class="tok-s1">'subGraph'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">tinkergraph</span><span class="tok-o">[</span><span class="tok-nl">vertices:</span><span class="tok-mi">1294</span> <span class="tok-nl">edges:</span><span class="tok-mi">11336</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As before we can now work with the newly created subgraph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Get a traversal source object so that we can traverse</span>
<span class="tok-c1">// the newly created sub graph.</span>
<span class="tok-n">sgt</span> <span class="tok-o">=</span> <span class="tok-n">subg</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">()</span>

<span class="tok-c1">// What sort of vertices ended up in the subgraph?</span>
<span class="tok-n">sgt</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">label</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">continent:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">country:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">airport:</span><span class="tok-mi">1287</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is a more complicated example. The query will create a subgraph just of airports
and routes that are inside Europe. Effectively this will make the Europe only version
of the air routes main graph. At first glance, this query looks a bit overwhelming
but if you read it slowly and look at each step you should be able to make sense of
what it is doing. It is quite a bit more sophisticated than the previous examples in
that as well as extracting the routes and airports into the subgraph it also extracts
all of the relevant countries and continents as well.Note that this query also uses
multiple <em>subgraph</em> steps.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Create a sub graph only of airports in Europe and routes between those airports</span>

<span class="tok-n">subg</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'continent'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'EU'</span><span class="tok-o">).</span>
             <span class="tok-n">outE</span><span class="tok-o">(</span><span class="tok-s1">'contains'</span><span class="tok-o">).</span><span class="tok-na">subgraph</span><span class="tok-o">(</span><span class="tok-s1">'eu-air-routes'</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
             <span class="tok-n">inE</span><span class="tok-o">(</span><span class="tok-s1">'contains'</span><span class="tok-o">).</span><span class="tok-na">subgraph</span><span class="tok-o">(</span><span class="tok-s1">'eu-air-routes'</span><span class="tok-o">).</span>
             <span class="tok-n">outV</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">).</span>
             <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'r'</span><span class="tok-o">).</span>
             <span class="tok-n">inV</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">in</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'continent'</span><span class="tok-o">).</span>
             <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'EU'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'r'</span><span class="tok-o">).</span><span class="tok-na">subgraph</span><span class="tok-o">(</span><span class="tok-s1">'eu-air-routes'</span><span class="tok-o">).</span>
             <span class="tok-n">cap</span><span class="tok-o">(</span><span class="tok-s1">'eu-air-routes'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span>

<span class="tok-n">tinkergraph</span><span class="tok-o">[</span><span class="tok-nl">vertices:</span><span class="tok-mi">630</span> <span class="tok-nl">edges:</span><span class="tok-mi">13665</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As before we can now work with the newly created subgraph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Create a traversal source object for the subgraph</span>
<span class="tok-n">sgt</span> <span class="tok-o">=</span> <span class="tok-n">subg</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">()</span>

<span class="tok-c1">// How many routes are there in the subgraph?</span>
<span class="tok-n">sgt</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">12499</span>

<span class="tok-c1">// What sort of vertices ended up in the subgraph?</span>
<span class="tok-n">sgt</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">label</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">continent:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">country:</span><span class="tok-mi">46</span><span class="tok-o">,</span><span class="tok-nl">airport:</span><span class="tok-mi">583</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following query uses the new Europe only subgraph to find out where we can
get to from London Heathrow (LHR) within Europe.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">sgt</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">FAO</span><span class="tok-o">,</span><span class="tok-n">JMK</span><span class="tok-o">,</span><span class="tok-n">FCO</span><span class="tok-o">,</span><span class="tok-n">JTR</span><span class="tok-o">,</span><span class="tok-n">KBP</span><span class="tok-o">,</span><span class="tok-n">AMS</span><span class="tok-o">,</span><span class="tok-n">RJK</span><span class="tok-o">,</span><span class="tok-n">TLS</span><span class="tok-o">,</span><span class="tok-n">PRG</span><span class="tok-o">,</span><span class="tok-n">BCN</span><span class="tok-o">,</span><span class="tok-n">LED</span><span class="tok-o">,</span><span class="tok-n">MAD</span><span class="tok-o">,</span><span class="tok-n">OPO</span><span class="tok-o">,</span><span class="tok-n">VIE</span><span class="tok-o">,</span><span class="tok-n">ZRH</span><span class="tok-o">,</span><span class="tok-n">GVA</span><span class="tok-o">,</span><span class="tok-n">LCG</span><span class="tok-o">,</span><span class="tok-n">BRU</span><span class="tok-o">,</span><span class="tok-n">MUC</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">INN</span><span class="tok-o">,</span><span class="tok-n">CGN</span><span class="tok-o">,</span><span class="tok-n">INV</span><span class="tok-o">,</span><span class="tok-n">GOT</span><span class="tok-o">,</span><span class="tok-n">BLL</span><span class="tok-o">,</span><span class="tok-n">VCE</span><span class="tok-o">,</span><span class="tok-n">KRK</span><span class="tok-o">,</span><span class="tok-n">SNN</span><span class="tok-o">,</span><span class="tok-n">MJV</span><span class="tok-o">,</span><span class="tok-n">OSL</span><span class="tok-o">,</span><span class="tok-n">MPL</span><span class="tok-o">,</span><span class="tok-n">ARN</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">,</span><span class="tok-n">PUY</span><span class="tok-o">,</span><span class="tok-n">GLA</span><span class="tok-o">,</span><span class="tok-n">BDS</span><span class="tok-o">,</span><span class="tok-n">DME</span><span class="tok-o">,</span><span class="tok-n">SVO</span><span class="tok-o">,</span><span class="tok-n">ORY</span><span class="tok-o">,</span><span class="tok-n">NCE</span><span class="tok-o">,</span><span class="tok-n">MXP</span><span class="tok-o">,</span><span class="tok-n">ATH</span><span class="tok-o">,</span><span class="tok-n">ZAG</span><span class="tok-o">,</span><span class="tok-n">BUD</span><span class="tok-o">,</span><span class="tok-n">BIO</span><span class="tok-o">,</span><span class="tok-n">IBZ</span><span class="tok-o">,</span><span class="tok-n">WAW</span><span class="tok-o">,</span><span class="tok-n">MLA</span><span class="tok-o">,</span><span class="tok-n">SOF</span><span class="tok-o">,</span><span class="tok-n">BEG</span><span class="tok-o">,</span><span class="tok-n">IST</span><span class="tok-o">,</span><span class="tok-n">HAM</span><span class="tok-o">,</span><span class="tok-n">STR</span><span class="tok-o">,</span><span class="tok-n">PSA</span><span class="tok-o">,</span><span class="tok-n">BLQ</span><span class="tok-o">,</span><span class="tok-n">NTE</span><span class="tok-o">,</span><span class="tok-n">CPH</span><span class="tok-o">,</span><span class="tok-n">LUX</span><span class="tok-o">,</span><span class="tok-n">DUS</span><span class="tok-o">,</span><span class="tok-n">TXL</span><span class="tok-o">,</span><span class="tok-n">LIS</span><span class="tok-o">,</span><span class="tok-n">GIB</span><span class="tok-o">,</span><span class="tok-n">KEF</span><span class="tok-o">,</span><span class="tok-n">PMI</span><span class="tok-o">,</span><span class="tok-n">AGP</span><span class="tok-o">,</span><span class="tok-n">LBA</span><span class="tok-o">,</span><span class="tok-n">ABZ</span><span class="tok-o">,</span><span class="tok-n">NCL</span><span class="tok-o">,</span><span class="tok-n">BSL</span><span class="tok-o">,</span><span class="tok-n">SVG</span><span class="tok-o">,</span><span class="tok-n">BGO</span><span class="tok-o">,</span><span class="tok-n">TLL</span><span class="tok-o">,</span><span class="tok-n">ORK</span><span class="tok-o">,</span><span class="tok-n">VKO</span><span class="tok-o">,</span><span class="tok-n">SPU</span><span class="tok-o">,</span><span class="tok-n">BHD</span><span class="tok-o">,</span><span class="tok-n">HAJ</span><span class="tok-o">,</span><span class="tok-n">LIN</span><span class="tok-o">,</span><span class="tok-n">LYS</span><span class="tok-o">,</span><span class="tok-n">MRS</span><span class="tok-o">,</span><span class="tok-n">OTP</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">,</span><span class="tok-n">RTM</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-n">HEL</span><span class="tok-o">,</span><span class="tok-n">DUB</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The ability to create a subgraph from a larger graph is a very powerful feature that
Gremlin provides for us. If you have a large graph but only want to work with a part
of it it is nice to be able to create a subgraph from it and perhaps even work with
that subgraph locally in memory while running some queries.</p>
</div>
</div>
<div class="sect2">
<h3 id="graphmlandjsonintro">4.18. Working with GraphML and GraphSON</h3>
<div class="paragraph">
<p>Apache TinkerPop supports the loading and saving of entire graphs using GraphML and
GraphSON. GraphML is a broadly supported XML standard that can be used to represent
entire graphs. GraphSON is a JSON format defined as part of the Apache TinkerPop
project that also allows whole graphs to be represented. It is also possible to use
GraphSON to represent the results of a Gremlin graph query in JSON format. In this
section we will take a look at all of these topics. The whole subject of using
GraphML and GraphSON will be revisited a few more times later in the book. Knowledge
of GraphSON becomes especially important once you start working with the Gremlin
Server. That topic will be covered in detail as part of the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#gremlinserver">INTRODUCING GREMLIN SERVER</a>"
section quite a bit later. Both GraphML and GraphSON are covered in detail as part of
the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#serialize">COMMON GRAPH SERIALIZATION FORMATS</a>" section.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The official Apache TinkerPop documentation includes some good coverage of this
topic. That documentation can be found at
<a href="http://tinkerpop.apache.org/docs/current/reference/#_gremlin_i_o" class="bare">http://tinkerpop.apache.org/docs/current/reference/#_gremlin_i_o</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>There are currently three versions of GraphSON. The original 1.0 version and then
versions 2.0 and 3.0 that added type information to the format. These were added in
TinkerPop versions 3.2.2 and 3.3 respectively. The default format
unless explicitly specified is currently GraphSON 3.0</p>
</div>
<div class="sect3">
<h4 id="sav">4.18.1. Saving (serializing) a graph as GraphML (XML) or GraphSON (JSON)</h4>
<div class="paragraph">
<p>Using TinkerPop 3 you can save a graph either in GraphML or Graphson format. GraphML
is an industry standard XML format for describing a graph and is recognized by many
other applications such as Gephi. GraphSON was defined as part of the TinkerPop
project and is less broadly supported outside of TinkerPop enabled tools and graphs.
However, whereas GraphML is considered lossee for some graphs (it does not support
all of the data types and structures used by TinkerPop 3). GraphSON is not
considered lossee.</p>
</div>
<div class="paragraph">
<p>Saving a graph to a GraphML file can be done using the following Gremlin expression.
You might want to try it on one of your graphs and look at the output generated. You
can also take a look at the <code>air-routes.graphml</code> file distribued with this book if
you want to look at a well laid out (for human readability) GraphML file. Bear in
mind that by default, TinkerPop will save your graph in a way that is not easily
human readable without using a code beautifier first. Most modern text editors can
also beautify XML files well.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Save the graph as GraphML</span>
<span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">io</span><span class="tok-o">(</span><span class="tok-n">graphml</span><span class="tok-o">()).</span><span class="tok-na">writeGraph</span><span class="tok-o">(</span><span class="tok-s1">'my-graph.graphml'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>TinkerPop 3 offers two different JSON packaging options. These are not to be confused
with the three different syntax versions. The default encoding option  stores each
vertex in a graph and all of its edges as a single JSON document. This is repeated
for every vertex in the graph. This is essentially what is known as <em>adjacency list</em>
format. If you serialize a graph to file using this method and look at the file
afterwards you will see that each line (which could be very wide) is a standalone
JSON obect.</p>
</div>
<div class="paragraph">
<p>The second variant is referred to as a <em>wrapped adjacency list</em> format. In this flavor
all of the vertices and edges are stored in a single large JSON oject inside of an
enclosing <em>vertices</em> object.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The GraphSON file generated will not be very human readable without doing
      some pretty printing on it using something like the Python json tool
      (<em>python -m json.tool my-graph.json</em>) or using a text editor that can beautify
      JSON.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The Gremlin line below will create a file containing the <em>adjacency list</em> form of
GraphSON.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Save the graph as unwrapped JSON</span>
<span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">io</span><span class="tok-o">(</span><span class="tok-n">graphson</span><span class="tok-o">()).</span><span class="tok-na">writeGraph</span><span class="tok-o">(</span><span class="tok-s2">"my-graph.json"</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following will create a file containing the <em>wrapped adjacency list</em> form of
GraphSON.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Create a single (wrapped) JSON file</span>
<span class="tok-n">fos</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">FileOutputStream</span><span class="tok-o">(</span><span class="tok-s2">"my-graph.json"</span><span class="tok-o">)</span>

<span class="tok-n">GraphSONWriter</span><span class="tok-o">.</span><span class="tok-na">build</span><span class="tok-o">().</span><span class="tok-na">wrapAdjacencyList</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">).</span><span class="tok-na">create</span><span class="tok-o">().</span><span class="tok-na">writeGraph</span><span class="tok-o">(</span><span class="tok-n">fos</span><span class="tok-o">,</span><span class="tok-n">graph</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you are ingesting large amounts of data into a TinkerPop 3 enabled graph, the
unwrapped flavor of GraphSON is probably a much better choice than GraphML or wrapped
GraphSON. Using this format you can stream data into a graph one vertex at a time
rather than having to try and send the entire graph as a potentially huge JSON file
all in one go.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Note that by default your graph will be saved using the GraphSON 3.0 format. Should
you wish to use one of the older formats you can still do so but will need to
explicitly specify which version you want Gremlin to generate. In the example below
the graph is saved using GraphSON 1.0 format. Doing this requires the creation and
use of a mapper that will produce the format we need.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">fos</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">FileOutputStream</span><span class="tok-o">(</span><span class="tok-s2">"my-graph.json"</span><span class="tok-o">)</span>

<span class="tok-n">mapper</span> <span class="tok-o">=</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">io</span><span class="tok-o">(</span><span class="tok-n">IoCore</span><span class="tok-o">.</span><span class="tok-na">graphson</span><span class="tok-o">()).</span>
         <span class="tok-n">mapper</span><span class="tok-o">().</span><span class="tok-na">version</span><span class="tok-o">(</span><span class="tok-n">GraphSONVersion</span><span class="tok-o">.</span><span class="tok-na">V1_0</span><span class="tok-o">).</span><span class="tok-na">create</span><span class="tok-o">()</span>

<span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">io</span><span class="tok-o">(</span><span class="tok-n">IoCore</span><span class="tok-o">.</span><span class="tok-na">graphson</span><span class="tok-o">()).</span>
    <span class="tok-n">writer</span><span class="tok-o">().</span><span class="tok-na">mapper</span><span class="tok-o">(</span><span class="tok-n">mapper</span><span class="tok-o">).</span>
    <span class="tok-n">create</span><span class="tok-o">().</span><span class="tok-na">writeGraph</span><span class="tok-o">(</span><span class="tok-n">fos</span><span class="tok-o">,</span> <span class="tok-n">graph</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to learn more about the specifics of the GraphML and GraphSON formats,
they are covered in detail near the end of this book in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#serialize">COMMON GRAPH SERIALIZATION FORMATS</a>"
section.</p>
</div>
</div>
<div class="sect3">
<h4 id="reload">4.18.2. Loading a graph stored as GraphML (XML) or GraphSON (JSON)</h4>
<div class="paragraph">
<p>In section 2 we saw how to load the <code>air-routes.graphml</code> file. In case you skipped
that part lets do a quick recap on loading GraphML files and also look at loading
a GraphSON JSON format file.</p>
</div>
<div class="paragraph">
<p>The only difference between loading a GraphML file or a GraphSON file is in the name
of the method from the IoCore Tinkerpop 3 class that we use. When we want to load
a graphML file we specify <em>IoCore.graphml()</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Load a graphML file</span>
<span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">io</span><span class="tok-o">(</span><span class="tok-n">IoCore</span><span class="tok-o">.</span><span class="tok-na">graphml</span><span class="tok-o">()).</span><span class="tok-na">readGraph</span><span class="tok-o">(</span><span class="tok-s1">'my-graph.graphml'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we are loading a GraphSON format file we instead specify <em>IoCore.graphson()</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Load a grapSON file</span>
<span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">io</span><span class="tok-o">(</span><span class="tok-n">IoCore</span><span class="tok-o">.</span><span class="tok-na">graphson</span><span class="tok-o">()).</span><span class="tok-na">readGraph</span><span class="tok-o">(</span><span class="tok-s1">'my-graph.json'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="graphsonmapper">4.18.3. Turning the results of a query into JSON</h4>
<div class="paragraph">
<p>In the sections above we explored how to save and load an entire graph using GraphSON
(JSON) or GraphML (XML). However what we have not looked at so far are any ways to
see query results expressed as JSON objects within the Gremlin console. As we shall
explore in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#gremlinserver">INTRODUCING GREMLIN SERVER</a>" section when you communicate with a Gremlin Server
from an application or from the command line using a tool such as <em>curl</em> and send
queries to a graph over HTTP or WebSockets the results are returned as JSON objects.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There is not an equivalent XML object mapping capability. This is because
GraphML is designed to contain whole graphs and not query results.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>When using the Gremlin Console the results of queries are presented to us in
a nice and fairly terse way and we are not shown any JSON. Most of the time this is
exactly what we want. However, if for any reason you want to see what the JSON for a
query result looks like it is possible to do just that. You can do this using the
regular Gremlin Console and a TinkerGraph on your laptop. You do not need to be
connected to a Gremlin Server to use the examples that I am about to present.</p>
</div>
<div class="paragraph">
<p>The first thing you need to do is create an instance of a GraphSON mapper that can be
used to generate JSON for us from a query result. Note that since TinkerPop 3.2.2 there
have been multiple versions of the GraphSON format. The original 1.0 version did not
contain any type information. Version 2.0 introduced the concept of including data
types within the JSON. As part of TinkerPop 3.3 GraphSON 3.0 was introduced to add a
few additional types. All three formats are still supported. The default is now
GraphSON 3.0.</p>
</div>
<div class="paragraph">
<p>The example below creates a <em>GraphSONMapper</em> object that will generate GraphSON 1.0
format JSON.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">json_mapper</span> <span class="tok-o">=</span> <span class="tok-n">GraphSONMapper</span><span class="tok-o">.</span>
                <span class="tok-n">build</span><span class="tok-o">().</span>
                <span class="tok-n">version</span><span class="tok-o">(</span><span class="tok-n">GraphSONVersion</span><span class="tok-o">.</span><span class="tok-na">V1_0</span><span class="tok-o">).</span>
                <span class="tok-n">create</span><span class="tok-o">().</span>
                <span class="tok-n">createMapper</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next let’s run a simple query that finds the vertex representing the Los Angeles
(LAX) airport.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">lax</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LAX'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The JSON mapper that we just created can now be used to display the query results as
JSON</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">json_mapper</span><span class="tok-o">.</span><span class="tok-na">writeValueAsString</span><span class="tok-o">(</span><span class="tok-n">lax</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the JSON that was generated. I have pretty printed it a bit to make it more
readable. Notice that the JSON includes the ID values for every property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="json"><span class="tok-p">{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">13</span><span class="tok-p">,</span><span class="tok-nt">"label"</span><span class="tok-p">:</span><span class="tok-s2">"airport"</span><span class="tok-p">,</span><span class="tok-nt">"type"</span><span class="tok-p">:</span><span class="tok-s2">"vertex"</span><span class="tok-p">,</span>
 <span class="tok-nt">"properties"</span><span class="tok-p">:</span>
   <span class="tok-p">{</span><span class="tok-nt">"country"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">148</span><span class="tok-p">,</span><span class="tok-nt">"value"</span><span class="tok-p">:</span><span class="tok-s2">"US"</span><span class="tok-p">}],</span>
   <span class="tok-nt">"code"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">149</span><span class="tok-p">,</span><span class="tok-nt">"value"</span><span class="tok-p">:</span><span class="tok-s2">"LAX"</span><span class="tok-p">}],</span>
   <span class="tok-nt">"longest"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">150</span><span class="tok-p">,</span><span class="tok-nt">"value"</span><span class="tok-p">:</span><span class="tok-mi">12091</span><span class="tok-p">}],</span>
   <span class="tok-nt">"city"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">151</span><span class="tok-p">,</span><span class="tok-nt">"value"</span><span class="tok-p">:</span><span class="tok-s2">"Los Angeles"</span><span class="tok-p">}],</span>
   <span class="tok-nt">"elev"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">152</span><span class="tok-p">,</span><span class="tok-nt">"value"</span><span class="tok-p">:</span><span class="tok-mi">127</span><span class="tok-p">}],</span>
   <span class="tok-nt">"icao"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">153</span><span class="tok-p">,</span><span class="tok-nt">"value"</span><span class="tok-p">:</span><span class="tok-s2">"KLAX"</span><span class="tok-p">}],</span>
   <span class="tok-nt">"lon"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">154</span><span class="tok-p">,</span><span class="tok-nt">"value"</span><span class="tok-p">:</span><span class="tok-mf">-118.4079971</span><span class="tok-p">}],</span>
   <span class="tok-nt">"type"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">155</span><span class="tok-p">,</span><span class="tok-nt">"value"</span><span class="tok-p">:</span><span class="tok-s2">"airport"</span><span class="tok-p">}],</span>
   <span class="tok-nt">"region"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">156</span><span class="tok-p">,</span><span class="tok-nt">"value"</span><span class="tok-p">:</span><span class="tok-s2">"US-CA"</span><span class="tok-p">}],</span>
   <span class="tok-nt">"runways"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">157</span><span class="tok-p">,</span><span class="tok-nt">"value"</span><span class="tok-p">:</span><span class="tok-mi">4</span><span class="tok-p">}],</span>
   <span class="tok-nt">"lat"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">158</span><span class="tok-p">,</span><span class="tok-nt">"value"</span><span class="tok-p">:</span><span class="tok-mf">33.94250107</span><span class="tok-p">}],</span>
   <span class="tok-nt">"desc"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">159</span><span class="tok-p">,</span><span class="tok-nt">"value"</span><span class="tok-p">:</span><span class="tok-s2">"Los Angeles International Airport"</span><span class="tok-p">}]}}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s create another <em>GraphSONMapper</em> instance. This time we will be generating
version 3.0 GraphSON.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">json_mapper_v3</span> <span class="tok-o">=</span> <span class="tok-n">GraphSONMapper</span><span class="tok-o">.</span>
                 <span class="tok-n">build</span><span class="tok-o">().</span>
                 <span class="tok-n">version</span><span class="tok-o">(</span><span class="tok-n">GraphSONVersion</span><span class="tok-o">.</span><span class="tok-na">V3_0</span><span class="tok-o">).</span>
                 <span class="tok-n">create</span><span class="tok-o">().</span>
                 <span class="tok-n">createMapper</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As there is a lot more information contained in the GraphSON 3.0 format I
decided to use a somewhat simpler query and just generate a <em>valueMap</em> for a few of
the properties contained in the LAX vertex to avoid having to show too much output!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">lax</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LAX'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As before, we can use the mapper to generate the JSON.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">json_mapper_v3</span><span class="tok-o">.</span><span class="tok-na">writeValueAsString</span><span class="tok-o">(</span><span class="tok-n">lax</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This time, as you can see, the JSON returned contains a lot more information. The key
thing to notice is the presence of all the <em>@type</em> and <em>@value</em> keys.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="json"><span class="tok-p">{</span>
  <span class="tok-nt">"@type"</span><span class="tok-p">:</span> <span class="tok-s2">"g:Map"</span><span class="tok-p">,</span>
  <span class="tok-nt">"@value"</span><span class="tok-p">:</span> <span class="tok-p">[</span>
    <span class="tok-p">{</span>
      <span class="tok-nt">"@type"</span><span class="tok-p">:</span> <span class="tok-s2">"g:T"</span><span class="tok-p">,</span>
      <span class="tok-nt">"@value"</span><span class="tok-p">:</span> <span class="tok-s2">"id"</span>
    <span class="tok-p">},</span>
    <span class="tok-p">{</span>
      <span class="tok-nt">"@type"</span><span class="tok-p">:</span> <span class="tok-s2">"g:Int64"</span><span class="tok-p">,</span>
      <span class="tok-nt">"@value"</span><span class="tok-p">:</span> <span class="tok-mi">13</span>
    <span class="tok-p">},</span>
    <span class="tok-s2">"code"</span><span class="tok-p">,</span>
    <span class="tok-p">{</span>
      <span class="tok-nt">"@type"</span><span class="tok-p">:</span> <span class="tok-s2">"g:List"</span><span class="tok-p">,</span>
      <span class="tok-nt">"@value"</span><span class="tok-p">:</span> <span class="tok-p">[</span>
        <span class="tok-s2">"LAX"</span>
      <span class="tok-p">]</span>
    <span class="tok-p">},</span>
    <span class="tok-s2">"city"</span><span class="tok-p">,</span>
    <span class="tok-p">{</span>
      <span class="tok-nt">"@type"</span><span class="tok-p">:</span> <span class="tok-s2">"g:List"</span><span class="tok-p">,</span>
      <span class="tok-nt">"@value"</span><span class="tok-p">:</span> <span class="tok-p">[</span>
        <span class="tok-s2">"Los Angeles"</span>
      <span class="tok-p">]</span>
    <span class="tok-p">},</span>
    <span class="tok-p">{</span>
      <span class="tok-nt">"@type"</span><span class="tok-p">:</span> <span class="tok-s2">"g:T"</span><span class="tok-p">,</span>
      <span class="tok-nt">"@value"</span><span class="tok-p">:</span> <span class="tok-s2">"label"</span>
    <span class="tok-p">},</span>
    <span class="tok-s2">"airport"</span>
  <span class="tok-p">]</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As I mentioned, the subject of JSON will come up again when we start looking at
working with a Gremlin Server. This section has hopefully shown you how to save and
load an entire graph as either GraphML or GraphSON and should you so desire to see
the results of your queries as JSON. Remember that if you do save an entire graph as
JSON, unless you specify otherwise, the default format is GraphSON 3.0.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="performance">4.19. Analyzing the performance of your queries</h3>
<div class="paragraph">
<p>Apache TinkerPop includes a class called TimeUtil that provides methods that you can
use to time how long your queries are taking to run. A second class called
ProfileStep provides a way to get a more fine grained analysis of where the time is
spent during execution of a query. In this section I am going to provide a few
examples of how to use the methods provided to analyze the execution time of a few
queries. I ran the tests on a laptop using the Gremlin Console with the <em>air-routes</em>
data loaded into an in-memory TinkerGraph.</p>
</div>
<div class="sect3">
<h4 id="clock">4.19.1. Timing a query - introducing <em>clock</em> and <em>clockWithResult</em></h4>
<div class="paragraph">
<p>The <em>TimeUtil</em> class provides several methods that can be used when working with
time. I am just going to focus on two of them, namely, <em>clock</em> and <em>clockWithResult</em>.
These methods allow you to have a query run one or more times while the execution
time is tracked. After all iterations have completed, the average time the query took
in milliseconds is returned. Note that, especially for longer queries, the time
returned will not appear to be the same as if you tried to measure the same <em>clock</em>
procedure using a stopwatch. This is because these methods both perform a warm up
pass before doing the actual timing. The warm up simply consists of running the query
one time before timing starts. This means that for a single timing iteration, the
<em>human perceived time</em> will be roughly double the time returned by the <em>clock</em>
analysis. Let’s take a look at a few examples.</p>
</div>
<div class="paragraph">
<p>Below is a very simple example of using a <em>clock</em> step to measure the time it takes
to find all airport vertices in the graph that are in China. Note that the clock step
takes two parameters. The first is an integer telling it how many times to run the
query. The second is a query to execute wrapped in braces <em>"{…​}"</em>. In other words a
closure. In the example below, the query is only run once as a parameter of 1 is
passed to the <em>clock</em> method. From the result we can see that running this query one
time on my laptop took a bit more than 1.3 milliseconds.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">clock</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)</span> <span class="tok-o">{</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'CN'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()}</span>

<span class="tok-mf">1.364199</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To get a more accurate assessment of how long a query takes it is sometimes a good
idea to average out the time over multiple attempts. This should reduce the impact of
any random system events from impacting your overall result. The example below
repeats the previous query but measures the average time taken across 100 iterations.
Note that, especially for longer running queries, the time returned will not be the
same as if you tried to time this process yourself using a stopwatch. This is because
the clock steps do a warm up pass before doing the actual testing. The warm up step
basically runs the query one time before it starts timing anything. This means that
for a single iteration the <em>human perceived time</em> will be roughly double the time
returned by the <em>clock</em> analysis. You can see from the results that when averaged
over 100 iteration the time taken is a bit less. You should not use these numbers as
hard and fast answers but rather use them to get a sense of in general how long a
query takes. If you repeated this test five times you would definitely get five
different results of a similar but not identical magnitude.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">clock</span><span class="tok-o">(</span><span class="tok-mi">100</span><span class="tok-o">)</span> <span class="tok-o">{</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'CN'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()}</span>

<span class="tok-mf">0.70694013</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the same query run 1000 times just to verify that the timings stay more or
less the same.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">clock</span><span class="tok-o">(</span><span class="tok-mi">1000</span><span class="tok-o">)</span> <span class="tok-o">{</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'CN'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()}</span>

<span class="tok-mf">0.6931818670000001</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We have seen the following query before in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#sp">Shortest paths (between airports) - introducing <em>repeat</em></a>" section. As you may recall it
finds 10 routes between Austin and Agra. Because there are not that many ways to get
to Agra this query requires a lot of graph traversals and so takes a while to
complete. Let’s time how long it takes to execute this query one time.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">clock</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">){</span>
    <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
          <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">()).</span><span class="tok-na">until</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AGR'</span><span class="tok-o">)).</span>
          <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">toList</span><span class="tok-o">()}</span>

<span class="tok-mf">4643.605562</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see it took quite a bit longer to run than our search for Chinese
airports. In fact it took well over 4 seconds to run. Let’s run the same query 100
times and see what the average time taken looks like.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">clock</span><span class="tok-o">(</span><span class="tok-mi">100</span><span class="tok-o">){</span>
    <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
          <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">()).</span><span class="tok-na">until</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AGR'</span><span class="tok-o">)).</span>
          <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">toList</span><span class="tok-o">()}</span>

<span class="tok-mf">4816.6515936999995</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So running the query 100 times gave a very similar result in this case. By way of an
interesting observation, notice the difference in time taken if we start in Agra and
look for routes to Austin. The average time over 100 iterations is less than 10
milliseconds. So we have uncovered an interesting possible optimization. Because
there are a lot more ways to get to Austin, finding 10 routes did not take very long.
This may not always be possible but keep in mind as you model your graph and design
your queries that where you start from can make a big difference!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">clock</span><span class="tok-o">(</span><span class="tok-mi">100</span><span class="tok-o">){</span>
   <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AGR'</span><span class="tok-o">).</span>
         <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">()).</span><span class="tok-na">until</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">)).</span>
         <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">toList</span><span class="tok-o">()}</span>

<span class="tok-mf">9.068097369999998</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You may have noticed that the <em>clock</em> method only shows us the time that a query
takes to run and does not show us the actual result of running the query. This is
where the <em>clockWithResult</em> method comes into play. We can reuse our <em>airports in
China</em> query but this time notice that we also get the result of the query back.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">clockWithResult</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)</span> <span class="tok-o">{</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'CN'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()}</span>

<span class="tok-mf">0.918276</span>
<span class="tok-mi">209</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we run the <em>Austin to Agra</em> query using <em>clockWithResult</em> you can see that we do
indeed get the routes back as well as the timing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">clockWithResult</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">){</span>
    <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
          <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">()).</span><span class="tok-na">until</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AGR'</span><span class="tok-o">)).</span>
          <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">toList</span><span class="tok-o">()}</span>

<span class="tok-mf">4266.584279</span>

<span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-n">AGR</span><span class="tok-o">],[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-n">AGR</span><span class="tok-o">],[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-n">AGR</span><span class="tok-o">],[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-n">AGR</span><span class="tok-o">],[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">CLE</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-n">AGR</span><span class="tok-o">],[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">CLE</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-n">AGR</span><span class="tok-o">],[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">OAK</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-n">AGR</span><span class="tok-o">],[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">PHL</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-n">AGR</span><span class="tok-o">],[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">PHL</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-n">AGR</span><span class="tok-o">],[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">PHL</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-n">AGR</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Just for fun, the next four queries look for all the ways you can fly between Austin
(AUS) and Los Angeles (LAX) with zero, one, two or three stops. The query avoids any
routes that revisit Austin and uses <em>simplePath</em> to avoid repeating the same route
twice. As you can see by the time we get to the last query, that takes three stops,
the query takes quite a bit of time to complete.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">clockWithResult</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">){</span>
    <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
          <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">))).</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">simplePath</span><span class="tok-o">().</span>
          <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LAX'</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()}</span>

<span class="tok-mf">1.698357</span>
<span class="tok-mi">1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you would expect, looking for routes with exactly one stop, does not take too long.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">clockWithResult</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
          <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">))).</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">).</span><span class="tok-na">simplePath</span><span class="tok-o">().</span>
          <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LAX'</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()}</span>

<span class="tok-mf">7.988092999999999</span>
<span class="tok-mi">51</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Looking for routes with exactly two stops takes quite a bit longer but is still
fairly fast.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">clockWithResult</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
          <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">))).</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">simplePath</span><span class="tok-o">().</span>
          <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LAX'</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()}</span>

<span class="tok-mf">435.423921</span>
<span class="tok-mi">3389</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see by the time we get to the last query, that looks for exactly three stops,
things take a lot longer to complete.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">clockWithResult</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
          <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">))).</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">4</span><span class="tok-o">).</span><span class="tok-na">simplePath</span><span class="tok-o">().</span>
          <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LAX'</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()}</span>

<span class="tok-mf">35295.633811</span>
<span class="tok-mi">203359</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that for the <em>clock</em> and <em>clockWithResult</em> methods to work correctly you need
to end the query with a termination step such as <em>next</em> or <em>toList</em>. Alternatively
you can end the query with <em>iterate</em>. In my testing I found things did not always
work correctly when using <em>iterate</em> so I tend to avoid it.</p>
</div>
</div>
<div class="sect3">
<h4 id="profile">4.19.2. Analyzing where time is spent - introducing <em>profile</em></h4>
<div class="paragraph">
<p>You can use the <em>profile</em> step to ask Gremlin to give you a more fine grained summary
of where the time is spent processing your query. Take a look at the example below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-CA'</span><span class="tok-o">).</span>
                            <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'DE'</span><span class="tok-o">).</span><span class="tok-na">profile</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After you run the query, instead of showing you the results, Gremlin will show you
where the time was spent processing the components of the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">Step                                       Count  Traversers  Time (ms)    % Dur</span>
<span class="tok-go">===============================================================================</span>
<span class="tok-go">TinkerGraphStep(vertex,[region.eq(US-TX)])   26          26      1.810     9.71</span>
<span class="tok-go">VertexStep(OUT,vertex)                      701         701      0.877     4.70</span>
<span class="tok-go">HasStep([region.eq(US-CA)])                  47          47      0.561     3.01</span>
<span class="tok-go">VertexStep(OUT,vertex)                     3464        3464     12.035    64.54</span>
<span class="tok-go">NoOpBarrierStep(2500)                      3464         224      3.157    16.93</span>
<span class="tok-go">HasStep([country.eq(DE)])                    59           4      0.206     1.11</span>
<span class="tok-go">   &gt;TOTAL                                     -           -     18.650        -</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we profile the <em>Austin to Agra</em> query from the previous section you can see that
almost all the time was spent inside the <em>repeat</em> loop looking for routes. In this
case that is not surprising but for more complex queries <em>profile</em> can help you to
refine them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">()).</span><span class="tok-na">until</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AGR'</span><span class="tok-o">)).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">profile</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the <em>profile</em> report. I truncated some of the text with '"…​" so that it
will fit on a single page.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">Step                              Count  Traversers       Time (ms)    % Dur</span>
<span class="tok-go">============================================================================</span>
<span class="tok-go">TinkerGraphStep(vertex,[~l...         1           1           2.125     0.02</span>
<span class="tok-go">RepeatStep([VertexStep(OUT,..        11          11        9357.962    99.97</span>
<span class="tok-go">  HasStep([code.eq(AGR)])                                  2627.621</span>
<span class="tok-go">  VertexStep(OUT,vertex)        1799981     1799981         509.392</span>
<span class="tok-go">  RepeatEndStep                      11          11        8848.030</span>
<span class="tok-go">RangeGlobalStep(0,10)                10          10           0.278     0.00</span>
<span class="tok-go">PathStep([value(code)])              10          10           0.126     0.00</span>
<span class="tok-go">   &gt;TOTAL                             -           -        9360.493        -</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tinkerindex">4.19.3. Introducing TinkerGraph indexes</h4>
<div class="paragraph">
<p>TinkerGraph provides a rudimentary indexing capability but using it can still improve
overall performance of your queries. Two methods <em>createIndex</em> and <em>dropIndex</em> are
provided for creating and deleting indexes. Vertex and Edge properties can be indexed
as needed. A third method, <em>getIndexedKeys</em> can be used to query what indexes have
been created. The example below runs the query we used in some of our prior tests
with and without an index being present for the <em>code</em> vertex property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">clock</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">){</span>
    <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span>
          <span class="tok-n">until</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AGR'</span><span class="tok-o">)).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">toList</span><span class="tok-o">()}</span>

<span class="tok-mf">2019.8820959999998</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s now create an index for the <em>code</em> property of every vertex and try the query
again. Note that <em>Vertex</em> as used below is shorthand for <em>Vertex.class</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">createIndex</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">Vertex</span><span class="tok-o">)</span>

 <span class="tok-n">clock</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">){</span>
     <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span>
           <span class="tok-n">until</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AGR'</span><span class="tok-o">)).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">toList</span><span class="tok-o">()}</span>

<span class="tok-mf">1298.386245</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can query what indexes we have creates as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">getIndexedKeys</span><span class="tok-o">(</span><span class="tok-n">Vertex</span><span class="tok-o">)</span>

<span class="tok-n">code</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let’s drop the index.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">dropIndex</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">Vertex</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Because the air routes graph is small, a Vertex property index has little effect on
overall performance. However, as there are a lot more edges, perhaps creating an edge
property index could help some queries. Let’s try an experiment. The following query
looks for all edges that have a <em>dist</em> property of 1000.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">clockWithResult</span><span class="tok-o">(</span><span class="tok-mi">100</span><span class="tok-o">)</span> <span class="tok-o">{</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-mi">1000</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()}</span>

<span class="tok-mf">9.80906926</span>
<span class="tok-mi">24</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s now create an index for the edge property called <em>dist</em> and run the query
again. We can also, as before, check to see what edge indexes have been created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">createIndex</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">Edge</span><span class="tok-o">)</span>

<span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">getIndexedKeys</span><span class="tok-o">(</span><span class="tok-n">Edge</span><span class="tok-o">)</span>

<span class="tok-n">dist</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This time you can see that our index has made a big difference.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">clockWithResult</span><span class="tok-o">(</span><span class="tok-mi">100</span><span class="tok-o">)</span> <span class="tok-o">{</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-mi">1000</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()}</span>

<span class="tok-mf">0.046712609999999995</span>
<span class="tok-mi">24</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The timing difference between the two queries can be attributed to the index. In the
first case every edge in the graph (over 50,000 of them) had to be inspected. In the
second case the index was used to go directly to the edges with a <em>dist</em> of 1000 and
no searching of all the edges was required. Note that the index only helps with exact
comparisons. A query such as the one below will not benefit from the index.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">clockWithResult</span><span class="tok-o">(</span><span class="tok-mi">100</span><span class="tok-o">)</span> <span class="tok-o">{</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">1000</span><span class="tok-o">)).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()}</span>

<span class="tok-mf">11.980037119999999</span>
<span class="tok-mi">16430</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Later on we will take a look at using an index with JanusGraph and look at external
indexing technologies such as Apache Solr and Elasticsearch that do support
more complex types of comparison predicates.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="olapoltp">4.20. OLTP vs OLAP</h3>
<div class="paragraph">
<p>When discussing graph processing two terms regularly come up. These terms are Online
Transaction Processing (OLTP) and Online Analytical Processing (OLAP). Most of the
queries we have looked at so far definitely fall into the OLTP category. Queries that
only look at a small part of a graph, often starting at a single node or a small
group of nodes and traversing out a few hops from there are considered OLTP
operations. Typically, an OLTP query takes a few seconds or less to run. They are
often used in response to a user query where an almost real time answer is needed.
Because the air routes graph is small - we can do even quite complex queries using
little more than a TinkerGraph and the Gremlin Console. This is not the case if your
graph contains billions of vertices and edges. That said, I have seen some OLTP type
queries, such as those looking for routes to remote airports, that can take
several minutes to run in the TinkerGraph environment.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The TinkerPop documentation has in depth coverage of the various OLAP
capabilities that are supported.
<a href="http://tinkerpop.apache.org/docs/current/reference/#graphcomputer" class="bare">http://tinkerpop.apache.org/docs/current/reference/#graphcomputer</a>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Where OLAP comes into play is when you want to do detailed analysis across an entire
graph. This is especially true as graphs get large and require  powerful clusters of
nodes to underpin them. While OLTP queries typically take seconds or less, OLAP
queries can often take many minutes or even hours to complete.</p>
</div>
<div class="paragraph">
<p>Apache TinkerPop provides significant support for OLAP graph processing out of the
box and is designed to work well with distributed backend systems and software such
as Apache Spark and Apache Hadoop.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
While OLAP processing is typically done using powerful clusters, you can run
simple experiments using nothing more than a standalone in memory TinkerGraph.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Detailed coverage of doing OLAP processing is beyond the current scope of this book
but I am going to give a few simple examples below to at least provide a little
insight into what can be done. The TinkerPop documentation includes in depth coverage
of how to perform OLAP operations on a TinkerPop enabled graph and I recommend
reading it if you plan to perform OLAP style graph processing.</p>
</div>
<div class="sect3">
<h4 id="graphcomputer">4.20.1. Introducing the TinkerPop Graph Computer</h4>
<div class="paragraph">
<p>A lot of new capability was added to the TinkerPop framework as part of the version 3
release. One such new capability is the concept of a <em>Graph Computer</em>. In concrete
terms, GraphComputer is a Java interface that other TinkerPop classes implement to
provide the capability for different back end environments. Along with
<em>GraphComputer</em>, the concept of a <em>VertexProgram</em> is also introduced. Vertex Programs
allow us to specify the operations that we want to be performed across a graph,
potentially in conjunction with map reduce operations. TinkerPop comes with a set of
pre configured Vertex Programs and vertex program steps. Of course you can also write
your own.</p>
</div>
<div class="paragraph">
<p>One of the pre configured Vertex Programs is Page Rank. Let’s take a look next at one
way it can be used.</p>
</div>
</div>
<div class="sect3">
<h4 id="pagerank">4.20.2. Experiments with Page Rank</h4>
<div class="paragraph">
<p>Probably one of, if not the, most famous algorithms in the big data world is <em>Page
Rank</em>. Originally developed at Google, the Page Rank algorithm was created as a way
to measure the relative importance of web pages. At a high level the algorithm looks
at the number of connections to a web page and the quality of those connections (as
in are they from a prominent place). That algorithm ports well to a graph database
environment as a graph, like the Web, is a heavily connected data structure. In our
graph database environment, we can use a page rank algorithm to assess a graph and
compute the likelihood in any given traversal that a particular vertex will get
visited. Although the new Graph Computer capabilities have been designed from the
ground up with distributed systems in mind, it is possible to use a stand a alone
TinkerGraph to experiment with a few of the capabilities.</p>
</div>
<div class="paragraph">
<p>The example below only assumes that you have a TinkerGraph running locally inside the
Gremlin Console with the <em>air-routes</em> data loaded. You will notice a few differences
from the examples we have seen so far in this book. First of all, when we create our
graph traversal source object, we add a call to <em>withComputer</em> to indicate that we
plan to be doing some things that require the Graph Computer capabilities. Having
created the traversal source we can setup our page rank. The query initially filters
out any vertex that is not an airport as will only want to rank airport vertices.
Next a call is made to the <em>pageRank</em> step. The <em>by</em> modulators tell the page rank
algorithm how we want the ranking done and what label to use for the ranking
results. In this case we want to look at outgoing <em>route</em> edges and label all results
<em>r</em>. Before returning the results, we order based on descending ranking value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Page rank based on outgoing routes</span>
<span class="tok-n">g3</span> <span class="tok-o">=</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">().</span><span class="tok-na">withComputer</span><span class="tok-o">()</span>

<span class="tok-n">g3</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">pageRank</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">)).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'r'</span><span class="tok-o">).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'r'</span><span class="tok-o">,</span><span class="tok-n">desc</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'r'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the output from running the page rank algorithm. The results show the airport
code along with the page rank value that was calculated.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">r:</span><span class="tok-o">[</span><span class="tok-mf">15.527963207609702</span><span class="tok-o">],</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">IST</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">r:</span><span class="tok-o">[</span><span class="tok-mf">15.005583346944613</span><span class="tok-o">],</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">r:</span><span class="tok-o">[</span><span class="tok-mf">14.673184454287105</span><span class="tok-o">],</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">ORD</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">r:</span><span class="tok-o">[</span><span class="tok-mf">14.365370693500969</span><span class="tok-o">],</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">r:</span><span class="tok-o">[</span><span class="tok-mf">14.099719956639161</span><span class="tok-o">],</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">PEK</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">r:</span><span class="tok-o">[</span><span class="tok-mf">14.061408826784106</span><span class="tok-o">],</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">DXB</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">r:</span><span class="tok-o">[</span><span class="tok-mf">13.729782985109942</span><span class="tok-o">],</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">DEN</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">r:</span><span class="tok-o">[</span><span class="tok-mf">13.552238441619048</span><span class="tok-o">],</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">DME</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">r:</span><span class="tok-o">[</span><span class="tok-mf">13.502681833743711</span><span class="tok-o">],</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">FRA</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">r:</span><span class="tok-o">[</span><span class="tok-mf">13.189393240835944</span><span class="tok-o">],</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">CDG</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Just as a point of reference, the query below finds the top 10 airports with the most
incoming routes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">inE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">(),</span><span class="tok-n">desc</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">inE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see there is some correlation between the page rank results and the
airports with the most incoming routes which is perhaps not surprising. However,
notice that the page rank algorithm came up with some airports that a simple node
degree test did not come up with.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">282</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">AMS</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">275</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">IST</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">271</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">CDG</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">267</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">MUC</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">240</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">PEK</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">239</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">ORD</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">237</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">237</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">235</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">221</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>pageRank</em> step used in the prior query is a nice and convenient way for us to
quickly generate some rankings. However, it is important to understand how the query
would be written if we were to use the Graph Computer more directly and submit a
Vertex Program. The example below sets up a <em>PageRankVertexProgram</em> and runs it.
Notice that the result we get back includes a new graph with 3624 vertices and no
edges.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">dcr</span> <span class="tok-o">=</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">compute</span><span class="tok-o">().</span>
      <span class="tok-n">program</span><span class="tok-o">(</span><span class="tok-n">PageRankVertexProgram</span><span class="tok-o">.</span><span class="tok-na">build</span><span class="tok-o">().</span>
      <span class="tok-n">edges</span><span class="tok-o">(</span><span class="tok-n">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">)).</span>
      <span class="tok-n">create</span><span class="tok-o">()).</span><span class="tok-na">submit</span><span class="tok-o">().</span><span class="tok-na">get</span><span class="tok-o">()</span>

<span class="tok-n">result</span><span class="tok-o">[</span><span class="tok-n">tinkergraph</span><span class="tok-o">[</span><span class="tok-nl">vertices:</span><span class="tok-mi">3624</span> <span class="tok-nl">edges:</span><span class="tok-mi">0</span><span class="tok-o">],</span><span class="tok-n">memory</span><span class="tok-o">[</span><span class="tok-nl">size:</span><span class="tok-mi">0</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In case you are curious, we can check the precise type of the result object that is
returned from creating our vertex program.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">dcr</span><span class="tok-o">.</span><span class="tok-na">getClass</span><span class="tok-o">()</span>

<span class="tok-kd">class</span> <span class="tok-nc">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span>
      <span class="tok-n">process</span><span class="tok-o">.</span><span class="tok-na">computer</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.</span><span class="tok-na">DefaultComputerResult</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Given the result we got back was a new graph we can create a new traversal and
inspect it. Notice that the Istanbul (IST) vertex in this graph contains an
additional property called <em>gremlin.pageRankVertexProgram.pageRank</em>. This property
contains the page rank score that was returned for this vertex.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g2</span> <span class="tok-o">=</span> <span class="tok-n">dcr</span><span class="tok-o">.</span><span class="tok-na">graph</span><span class="tok-o">().</span><span class="tok-na">traversal</span><span class="tok-o">()</span>

<span class="tok-n">g2</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'IST'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">161</span><span class="tok-o">,</span><span class="tok-nl">country:</span><span class="tok-o">[</span><span class="tok-n">TR</span><span class="tok-o">],</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">IST</span><span class="tok-o">],</span><span class="tok-nl">longest:</span><span class="tok-o">[</span><span class="tok-mi">9843</span><span class="tok-o">],</span><span class="tok-n">gremlin</span><span class="tok-o">.</span><span class="tok-na">pageRankVertexProgram</span><span class="tok-o">.</span><span class="tok-na">pageRank</span><span class="tok-o">:[</span><span class="tok-mf">0.0047038762655771775</span><span class="tok-o">],</span><span class="tok-nl">city:</span><span class="tok-o">[</span><span class="tok-n">Istanbul</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[</span><span class="tok-mf">28.8145999908</span><span class="tok-o">],</span><span class="tok-nl">type:</span><span class="tok-o">[</span><span class="tok-n">airport</span><span class="tok-o">],</span><span class="tok-nl">label:</span><span class="tok-n">airport</span><span class="tok-o">,</span><span class="tok-nl">elev:</span><span class="tok-o">[</span><span class="tok-mi">163</span><span class="tok-o">],</span><span class="tok-nl">icao:</span><span class="tok-o">[</span><span class="tok-n">LTBA</span><span class="tok-o">],</span><span class="tok-nl">region:</span><span class="tok-o">[</span><span class="tok-n">TR</span><span class="tok-o">-</span><span class="tok-mi">34</span><span class="tok-o">],</span><span class="tok-nl">runways:</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">40.9768981934</span><span class="tok-o">],</span><span class="tok-nl">desc:</span><span class="tok-o">[</span><span class="tok-n">Ataturk</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Just to prove the original graph was untouched, let’s check the IST vertex in that
graph. As you can see there are no new properties present.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'IST'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">161</span><span class="tok-o">,</span><span class="tok-nl">country:</span><span class="tok-o">[</span><span class="tok-n">TR</span><span class="tok-o">],</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">IST</span><span class="tok-o">],</span><span class="tok-nl">longest:</span><span class="tok-o">[</span><span class="tok-mi">9843</span><span class="tok-o">],</span><span class="tok-nl">city:</span><span class="tok-o">[</span><span class="tok-n">Istanbul</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[</span><span class="tok-mf">28.8145999908</span><span class="tok-o">],</span><span class="tok-nl">type:</span><span class="tok-o">[</span><span class="tok-n">airport</span><span class="tok-o">],</span><span class="tok-nl">label:</span><span class="tok-n">airport</span><span class="tok-o">,</span><span class="tok-nl">elev:</span><span class="tok-o">[</span><span class="tok-mi">163</span><span class="tok-o">],</span><span class="tok-nl">icao:</span><span class="tok-o">[</span><span class="tok-n">LTBA</span><span class="tok-o">],</span><span class="tok-nl">region:</span><span class="tok-o">[</span><span class="tok-n">TR</span><span class="tok-o">-</span><span class="tok-mi">34</span><span class="tok-o">],</span><span class="tok-nl">runways:</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">40.9768981934</span><span class="tok-o">],</span><span class="tok-nl">desc:</span><span class="tok-o">[</span><span class="tok-n">Ataturk</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally let’s look at the 10 airports sorted by page rank score in descending order.
As you will observe, the scoring system is different but the selected airports are
the same as the ones returned by the in-line <em>pageRank</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g2</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'gremlin.pageRankVertexProgram.pageRank'</span><span class="tok-o">,</span><span class="tok-n">desc</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
       <span class="tok-n">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'gremlin.pageRankVertexProgram.pageRank'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">IST</span><span class="tok-o">],</span><span class="tok-n">gremlin</span><span class="tok-o">.</span><span class="tok-na">pageRankVertexProgram</span><span class="tok-o">.</span><span class="tok-na">pageRank</span><span class="tok-o">:[</span><span class="tok-mf">0.004594389373424941</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">],</span><span class="tok-n">gremlin</span><span class="tok-o">.</span><span class="tok-na">pageRankVertexProgram</span><span class="tok-o">.</span><span class="tok-na">pageRank</span><span class="tok-o">:[</span><span class="tok-mf">0.004440623428637068</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">ORD</span><span class="tok-o">],</span><span class="tok-n">gremlin</span><span class="tok-o">.</span><span class="tok-na">pageRankVertexProgram</span><span class="tok-o">.</span><span class="tok-na">pageRank</span><span class="tok-o">:[</span><span class="tok-mf">0.004342068075230758</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">],</span><span class="tok-n">gremlin</span><span class="tok-o">.</span><span class="tok-na">pageRankVertexProgram</span><span class="tok-o">.</span><span class="tok-na">pageRank</span><span class="tok-o">:[</span><span class="tok-mf">0.004251005124367605</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">PEK</span><span class="tok-o">],</span><span class="tok-n">gremlin</span><span class="tok-o">.</span><span class="tok-na">pageRankVertexProgram</span><span class="tok-o">.</span><span class="tok-na">pageRank</span><span class="tok-o">:[</span><span class="tok-mf">0.004172537469821617</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">DXB</span><span class="tok-o">],</span><span class="tok-n">gremlin</span><span class="tok-o">.</span><span class="tok-na">pageRankVertexProgram</span><span class="tok-o">.</span><span class="tok-na">pageRank</span><span class="tok-o">:[</span><span class="tok-mf">0.004161183557641767</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">DEN</span><span class="tok-o">],</span><span class="tok-n">gremlin</span><span class="tok-o">.</span><span class="tok-na">pageRankVertexProgram</span><span class="tok-o">.</span><span class="tok-na">pageRank</span><span class="tok-o">:[</span><span class="tok-mf">0.004063035588247088</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">DME</span><span class="tok-o">],</span><span class="tok-n">gremlin</span><span class="tok-o">.</span><span class="tok-na">pageRankVertexProgram</span><span class="tok-o">.</span><span class="tok-na">pageRank</span><span class="tok-o">:[</span><span class="tok-mf">0.004009614722586433</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">FRA</span><span class="tok-o">],</span><span class="tok-n">gremlin</span><span class="tok-o">.</span><span class="tok-na">pageRankVertexProgram</span><span class="tok-o">.</span><span class="tok-na">pageRank</span><span class="tok-o">:[</span><span class="tok-mf">0.003994862262812258</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">CDG</span><span class="tok-o">],</span><span class="tok-n">gremlin</span><span class="tok-o">.</span><span class="tok-na">pageRankVertexProgram</span><span class="tok-o">.</span><span class="tok-na">pageRank</span><span class="tok-o">:[</span><span class="tok-mf">0.0039023184469861244</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I have barely scratched the surface in this section on these new TinkerPop OLAP
capabilities. If this is an area that you are interested in I strongly recommend
reading the official TinkerPop reference documentation.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="msc">5. MISCELLANEOUS QUERIES AND THEIR RESULTS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this chapter you will find more Gremlin queries that operate on the <em>air-routes</em>
graph. All of these queries build upon the topics  covered in the prior sections.
In this section I have included lots of examples of the output returned by running
queries. In cases where the output is rather lengthy I have either truncated it or
laid it out in columns to make it easier to read and to save space. It is my hope
also that from reading the examples in this section that you will get a sense for how
good data modelled as a graph can be when used for analysis. I also think that the
queries in this section show that you can achieve useful results from a graph using
nothing more than some OLTP style queries and a TinkerGraph. This is actually a great
example of an ideal use case for TinkerGraph. Even if you have your main data in a
massive hosted graph, extracting parts of it and doing analysis locally using
TinkerGraph is a technique that can make you very productive.</p>
</div>
<div class="sect2">
<h3 id="countmore">5.1. Counting more things</h3>
<div class="paragraph">
<p>To get things started, let’s look at a few more examples that basically just count
occurrences and distributions of things but are a little more complex than the
examples we looked at earlier in the book.</p>
</div>
<div class="sect3">
<h4 id="noairports">5.1.1. Which countries have no airports?</h4>
<div class="paragraph">
<p>This first query looks for any <em>country</em> vertices that have no outgoing edges. This
indicates that there are no airports in the graph for those countries.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Are there any countries that have no airports?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">).</span><span class="tok-na">not</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">()).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So it seems there are six countries for which no airports were found.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">Andorra</span>
<span class="tok-n">Liechtenstein</span>
<span class="tok-n">Monaco</span>
<span class="tok-n">Montserrat</span>
<span class="tok-n">Pitcairn</span>
<span class="tok-n">San</span> <span class="tok-n">Marino</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The previous query is a slightly shorter form of the two queries below which would
both yield the same results. Note the use of the <em>"__"</em> prefix in front of the <em>not</em>
step in the second query. This is because <em>not</em> is a reserved word in Groovy and has
to be prefixed in this way when not directly connected to a prior step by a dot.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">).</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">)</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">).</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">not</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">())).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="noroutes">5.1.2. Which airports have no routes?</h4>
<div class="paragraph">
<p>There are a few airports in the graph that currently have no commercial routes. This
is either because they used to have service and it was discontinued or they are new
airports still awaiting service to start. We can write a query to easily find these
"orphan" airports. Note that this is query based on the version 0.77 release of
<code>air-routes.graphml</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can always find the version of the <code>air-routes.graphml</code> file used for the
examples in the book and also the most recent data set in the <code>sample-data</code> folder
located at <a href="https://github.com/krlawrence/graph/tree/master/sample-data" class="bare">https://github.com/krlawrence/graph/tree/master/sample-data</a> .
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>In more recent updates of the data set, some of these airports
do now have commercial airline service.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">not</span><span class="tok-o">(</span><span class="tok-n">bothE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When we run the query, you can see we find quite a few orphan airport nodes that have
no outgoing or incoming routes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">ILG</span><span class="tok-o">,</span><span class="tok-n">TWB</span><span class="tok-o">,</span><span class="tok-n">TUA</span><span class="tok-o">,</span><span class="tok-n">BVS</span><span class="tok-o">,</span><span class="tok-n">KGG</span><span class="tok-o">,</span><span class="tok-n">RIG</span><span class="tok-o">,</span><span class="tok-n">INT</span><span class="tok-o">,</span><span class="tok-n">APA</span><span class="tok-o">,</span><span class="tok-n">BWU</span><span class="tok-o">,</span><span class="tok-n">BID</span><span class="tok-o">,</span><span class="tok-n">NBW</span><span class="tok-o">,</span><span class="tok-n">SFH</span><span class="tok-o">,</span><span class="tok-n">CVT</span><span class="tok-o">,</span><span class="tok-n">AFW</span><span class="tok-o">,</span><span class="tok-n">PSY</span><span class="tok-o">,</span><span class="tok-n">HLE</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="runwaydist">5.1.3. What is the distribution of runways?</h4>
<div class="paragraph">
<p>We can easily count the distribution per airport of runways. We can observe from the
results of running the query that the vast majority of airports in the graph have
either one or two runways.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// What is the distribution of runways in the graph</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">:</span><span class="tok-mi">2316</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">:</span><span class="tok-mi">762</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">:</span><span class="tok-mi">225</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">:</span><span class="tok-mi">51</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">8</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mostroutes">5.1.4. Airports with the most routes</h4>
<div class="paragraph">
<p>This next query finds all airports that have more than 180 outgoing routes and
returns their IATA codes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Airports with more than 180 outgoing routes</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">180</span><span class="tok-o">))).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-n">ORD</span><span class="tok-o">,</span><span class="tok-n">DEN</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">LGW</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-n">PEK</span><span class="tok-o">,</span><span class="tok-n">PVG</span><span class="tok-o">,</span><span class="tok-n">FCO</span><span class="tok-o">,</span><span class="tok-n">AMS</span><span class="tok-o">,</span><span class="tok-n">BCN</span><span class="tok-o">,</span><span class="tok-n">MAD</span><span class="tok-o">,</span><span class="tok-n">MUC</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">STN</span><span class="tok-o">,</span><span class="tok-n">DME</span><span class="tok-o">,</span><span class="tok-n">IST</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could improve our query a bit to include the IATA code and the exact number of
outgoing routes in the returned result. There are a few different ways that we could
do this. One way that is quite convenient is to use <em>group</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Same basic query but return the airport code and the route count</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">180</span><span class="tok-o">))).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I have laid the results out in a grid to make them easier to read.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">ORD:</span><span class="tok-mi">232</span><span class="tok-o">,</span><span class="tok-nl">PVG:</span><span class="tok-mi">201</span><span class="tok-o">,</span><span class="tok-nl">LAX:</span><span class="tok-mi">195</span><span class="tok-o">,</span><span class="tok-nl">CDG:</span><span class="tok-mi">262</span><span class="tok-o">,</span>
 <span class="tok-nl">STN:</span><span class="tok-mi">186</span><span class="tok-o">,</span><span class="tok-nl">JFK:</span><span class="tok-mi">187</span><span class="tok-o">,</span><span class="tok-nl">DFW:</span><span class="tok-mi">221</span><span class="tok-o">,</span><span class="tok-nl">LHR:</span><span class="tok-mi">191</span><span class="tok-o">,</span>
 <span class="tok-nl">MUC:</span><span class="tok-mi">237</span><span class="tok-o">,</span><span class="tok-nl">DME:</span><span class="tok-mi">214</span><span class="tok-o">,</span><span class="tok-nl">EWR:</span><span class="tok-mi">182</span><span class="tok-o">,</span><span class="tok-nl">AMS:</span><span class="tok-mi">269</span><span class="tok-o">,</span>
 <span class="tok-nl">IST:</span><span class="tok-mi">270</span><span class="tok-o">,</span><span class="tok-nl">DEN:</span><span class="tok-mi">188</span><span class="tok-o">,</span><span class="tok-nl">BCN:</span><span class="tok-mi">190</span><span class="tok-o">,</span><span class="tok-nl">DXB:</span><span class="tok-mi">229</span><span class="tok-o">,</span>
 <span class="tok-nl">IAH:</span><span class="tok-mi">192</span><span class="tok-o">,</span><span class="tok-nl">MAD:</span><span class="tok-mi">192</span><span class="tok-o">,</span><span class="tok-nl">FCO:</span><span class="tok-mi">189</span><span class="tok-o">,</span><span class="tok-nl">FRA:</span><span class="tok-mi">272</span><span class="tok-o">,</span>
 <span class="tok-nl">PEK:</span><span class="tok-mi">234</span><span class="tok-o">,</span><span class="tok-nl">ATL:</span><span class="tok-mi">232</span><span class="tok-o">,</span><span class="tok-nl">YYZ:</span><span class="tok-mi">181</span><span class="tok-o">,</span><span class="tok-nl">MAN:</span><span class="tok-mi">182</span><span class="tok-o">,</span>
 <span class="tok-nl">LGW:</span><span class="tok-mi">200</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can add one further refinement to the query. This time the results are ordered by
the number or routes in descending order. Note the use of <em>local</em> to make sure that
<em>order</em> is applied to the contents of the collection that was generated by the
<em>group</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Same query with ordered results</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">180</span><span class="tok-o">))).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span>
      <span class="tok-n">order</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">,</span><span class="tok-n">desc</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I have again laid the results out in a grid.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">FRA:</span><span class="tok-mi">272</span><span class="tok-o">,</span><span class="tok-nl">IST:</span><span class="tok-mi">270</span><span class="tok-o">,</span><span class="tok-nl">AMS:</span><span class="tok-mi">269</span><span class="tok-o">,</span><span class="tok-nl">CDG:</span><span class="tok-mi">262</span><span class="tok-o">,</span>
 <span class="tok-nl">MUC:</span><span class="tok-mi">237</span><span class="tok-o">,</span><span class="tok-nl">PEK:</span><span class="tok-mi">234</span><span class="tok-o">,</span><span class="tok-nl">ORD:</span><span class="tok-mi">232</span><span class="tok-o">,</span><span class="tok-nl">ATL:</span><span class="tok-mi">232</span><span class="tok-o">,</span>
 <span class="tok-nl">DXB:</span><span class="tok-mi">229</span><span class="tok-o">,</span><span class="tok-nl">DFW:</span><span class="tok-mi">221</span><span class="tok-o">,</span><span class="tok-nl">DME:</span><span class="tok-mi">214</span><span class="tok-o">,</span><span class="tok-nl">PVG:</span><span class="tok-mi">201</span><span class="tok-o">,</span>
 <span class="tok-nl">LGW:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-nl">LAX:</span><span class="tok-mi">195</span><span class="tok-o">,</span><span class="tok-nl">IAH:</span><span class="tok-mi">192</span><span class="tok-o">,</span><span class="tok-nl">MAD:</span><span class="tok-mi">192</span><span class="tok-o">,</span>
 <span class="tok-nl">LHR:</span><span class="tok-mi">191</span><span class="tok-o">,</span><span class="tok-nl">BCN:</span><span class="tok-mi">190</span><span class="tok-o">,</span><span class="tok-nl">FCO:</span><span class="tok-mi">189</span><span class="tok-o">,</span><span class="tok-nl">DEN:</span><span class="tok-mi">188</span><span class="tok-o">,</span>
 <span class="tok-nl">JFK:</span><span class="tok-mi">187</span><span class="tok-o">,</span><span class="tok-nl">STN:</span><span class="tok-mi">186</span><span class="tok-o">,</span><span class="tok-nl">EWR:</span><span class="tok-mi">182</span><span class="tok-o">,</span><span class="tok-nl">MAN:</span><span class="tok-mi">182</span><span class="tok-o">,</span>
 <span class="tok-nl">YYZ:</span><span class="tok-mi">181</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As I mentioned earlier in the book, the number of incoming and outgoing routes for
any given airport will not always be the same due to how airlines operate their
flight routings. The query below looks for any airports that have more than 400 total
routes (inbound and outbound).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Airports with more than 400 total routes</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">both</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">400</span><span class="tok-o">))).</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">ORD</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-n">PEK</span><span class="tok-o">,</span><span class="tok-n">PVG</span><span class="tok-o">,</span><span class="tok-n">AMS</span><span class="tok-o">,</span><span class="tok-n">MUC</span><span class="tok-o">,</span><span class="tok-n">DME</span><span class="tok-o">,</span><span class="tok-n">IST</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="oneroute">5.1.5. Airports with just one route</h4>
<div class="paragraph">
<p>There are, perhaps surprisingly, a large number of airports that only have one route.
The query below will figure out just how many fall into that category.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// How many airports have only one route?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
  <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">eq</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">))).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">770</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="onerunway">5.1.6. Single runway airports with the most routes</h4>
<div class="paragraph">
<p>It is interesting to look at how busy some single runway airports are. The query
below looks for the ten airports with just one runway that have the most outgoing
routes. You will notice that I have included London Gatwick in the query using an
<em>or</em> step. This is because while technically Gatwick is listed in the graph as an
airport with two runways, in practice the second runway is primarily used as a
taxiway and reserved for emergency use only. Therefore, Gatwick is really a single
runway airport. This also makes the query a bit more interesting!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">or</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">),</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LGW'</span><span class="tok-o">)).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">(),</span><span class="tok-n">desc</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'apt'</span><span class="tok-o">,</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'routes'</span><span class="tok-o">).</span>
      <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When we run the query here are the results we get back. One interesting observation
is that three of the top five busiest single runway airports are in England.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">apt:</span><span class="tok-n">LGW</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">London</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">200</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">apt:</span><span class="tok-n">STN</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">London</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">186</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">apt:</span><span class="tok-n">CTU</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Chengdu</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">124</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">apt:</span><span class="tok-n">LIS</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Lisbon</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">116</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">apt:</span><span class="tok-n">BHX</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Birmingham</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">109</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">apt:</span><span class="tok-n">SAW</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Istanbul</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">109</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">apt:</span><span class="tok-n">KMG</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Kunming</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">107</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">apt:</span><span class="tok-n">ALC</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Alicante</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">106</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">apt:</span><span class="tok-n">CKG</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Chongqing</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">106</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">apt:</span><span class="tok-n">XIY</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Xianyang</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">105</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="runwaycountproject">5.1.7. Another way of counting runways</h4>
<div class="paragraph">
<p>Let’s assume we wanted to count the runways in the graph and for each number of
runways produce a simple map result where the runway number and total count of
airports having that number of runways  are each meaningfully labeled. One way we
could do that is to use a <em>groupCount</em> step to calculate the distribution of runways
and then use a <em>project</em> step to produce the nicely labeled result. That is what the
query below does. Notice that an <em>unfold</em> step is used so that the results of
the <em>groupCount</em> which itself produces a map, can be further processed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span>
      <span class="tok-n">unfold</span><span class="tok-o">().</span>
      <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-s1">'count'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">keys</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When run we get a nice map back showing us the number of runways and for each the
total count. Each value has a meaningful key name of <em>runways</em> and <em>count</em>
respectively.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">runways:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">count:</span><span class="tok-mi">2316</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">runways:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">count:</span><span class="tok-mi">762</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">runways:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">count:</span><span class="tok-mi">225</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">runways:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">count:</span><span class="tok-mi">51</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">runways:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">count:</span><span class="tok-mi">14</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">runways:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">count:</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">runways:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">count:</span><span class="tok-mi">1</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">runways:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">count:</span><span class="tok-mi">1</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that if the unfold step had not been used, a very different result would have
been generated.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span>
      <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-s1">'count'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">keys</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">runways:</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">8</span><span class="tok-o">],</span><span class="tok-nl">count:</span><span class="tok-o">[</span><span class="tok-mi">2316</span><span class="tok-o">,</span><span class="tok-mi">762</span><span class="tok-o">,</span><span class="tok-mi">225</span><span class="tok-o">,</span><span class="tok-mi">51</span><span class="tok-o">,</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="canadamost">5.1.8. Airports with the most routes in Canada</h4>
<div class="paragraph">
<p>The following query finds the top 10 airports in Canada sorted by descending number
of outgoing routes. Just for fun, this time I used the <em>index</em> method to include a
one based index as part of the results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'CA'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">(),</span><span class="tok-n">desc</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'apt'</span><span class="tok-o">,</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'routes'</span><span class="tok-o">).</span>
      <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">indexed</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results of running the query along with the index that we added.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,[</span><span class="tok-nl">apt:</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Toronto</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">181</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">,[</span><span class="tok-nl">apt:</span><span class="tok-n">YUL</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Montreal</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">101</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">,[</span><span class="tok-nl">apt:</span><span class="tok-n">YVR</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Vancouver</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">94</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-mi">4</span><span class="tok-o">,[</span><span class="tok-nl">apt:</span><span class="tok-n">YYC</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Calgary</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">68</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-mi">5</span><span class="tok-o">,[</span><span class="tok-nl">apt:</span><span class="tok-n">YEG</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Edmonton</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">41</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-mi">6</span><span class="tok-o">,[</span><span class="tok-nl">apt:</span><span class="tok-n">YHZ</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Halifax</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">40</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-mi">7</span><span class="tok-o">,[</span><span class="tok-nl">apt:</span><span class="tok-n">YWG</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Winnipeg</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">32</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">,[</span><span class="tok-nl">apt:</span><span class="tok-n">YOW</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Ottawa</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">31</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-mi">9</span><span class="tok-o">,[</span><span class="tok-nl">apt:</span><span class="tok-n">YZF</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Yellowknife</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">20</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-mi">10</span><span class="tok-o">,[</span><span class="tok-nl">apt:</span><span class="tok-n">YQB</span><span class="tok-o">,</span><span class="tok-nl">city:</span><span class="tok-n">Quebec</span> <span class="tok-n">City</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">19</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ukdist">5.1.9. Distribution of UK airports</h4>
<div class="paragraph">
<p>How many airports are there in each of the UK regions of England, Scotland,
Wales and Northern Ireland?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'UK'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">(</span><span class="tok-s1">'contains'</span><span class="tok-o">).</span><span class="tok-na">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">GB</span><span class="tok-o">-</span><span class="tok-nl">ENG:</span><span class="tok-mi">27</span><span class="tok-o">,</span><span class="tok-n">GB</span><span class="tok-o">-</span><span class="tok-nl">WLS:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-n">GB</span><span class="tok-o">-</span><span class="tok-nl">NIR:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-n">GB</span><span class="tok-o">-</span><span class="tok-nl">SCT:</span><span class="tok-mi">25</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="countrydist">5.1.10. Distribution of airports by country</h4>
<div class="paragraph">
<p>This query uses <em>groupCount</em> to produce a map of key value pairs where the key is the
two character ISO country code and the value is the number of airports that country
has.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// How many airports does each country have in the graph?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When run the query produces quite a lot of output. As the values are not sorted it is
hard to find the countries with the most airports. Note that the <em>groupCount</em> step
does not include countries that had no airports. In other words if the count is zero
the country was skipped.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">PR:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">PT:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">PW:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">PY:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">QA:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">AE:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">AF:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">AG:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">AI:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">AL:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">AM:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">AO:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">AR:</span><span class="tok-mi">36</span><span class="tok-o">,</span><span class="tok-nl">AS:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">AT:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">RE:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">AU:</span><span class="tok-mi">124</span><span class="tok-o">,</span><span class="tok-nl">AW:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">AZ:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">RO:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">BA:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">BB:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">RS:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">BD:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">BE:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">RU:</span><span class="tok-mi">120</span><span class="tok-o">,</span><span class="tok-nl">BF:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">BG:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">RW:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">BH:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BI:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BJ:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BL:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BN:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BO:</span><span class="tok-mi">15</span><span class="tok-o">,</span><span class="tok-nl">SA:</span><span class="tok-mi">26</span><span class="tok-o">,</span><span class="tok-nl">BQ:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">SB:</span><span class="tok-mi">17</span><span class="tok-o">,</span><span class="tok-nl">BR:</span><span class="tok-mi">115</span><span class="tok-o">,</span><span class="tok-nl">SC:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">BS:</span><span class="tok-mi">18</span><span class="tok-o">,</span><span class="tok-nl">SD:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">SE:</span><span class="tok-mi">39</span><span class="tok-o">,</span><span class="tok-nl">BT:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SG:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BW:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">SH:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">SI:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BY:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">BZ:</span><span class="tok-mi">13</span><span class="tok-o">,</span><span class="tok-nl">SK:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">SL:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SN:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">SO:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">CA:</span><span class="tok-mi">203</span><span class="tok-o">,</span><span class="tok-nl">SR:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SS:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">CC:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">CD:</span><span class="tok-mi">11</span><span class="tok-o">,</span><span class="tok-nl">ST:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SV:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">CF:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">CG:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">CH:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">SX:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">CI:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SY:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">SZ:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">CK:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">CL:</span><span class="tok-mi">17</span><span class="tok-o">,</span><span class="tok-nl">CM:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">CN:</span><span class="tok-mi">209</span><span class="tok-o">,</span><span class="tok-nl">CO:</span><span class="tok-mi">50</span><span class="tok-o">,</span><span class="tok-nl">CR:</span><span class="tok-mi">13</span><span class="tok-o">,</span><span class="tok-nl">TC:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">TD:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">CU:</span><span class="tok-mi">12</span><span class="tok-o">,</span><span class="tok-nl">CV:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">TG:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">TH:</span><span class="tok-mi">32</span><span class="tok-o">,</span><span class="tok-nl">CW:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">CX:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">CY:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">TJ:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">CZ:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">TL:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">TM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">TN:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">TO:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">TR:</span><span class="tok-mi">48</span><span class="tok-o">,</span><span class="tok-nl">TT:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">DE:</span><span class="tok-mi">33</span><span class="tok-o">,</span><span class="tok-nl">TV:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">TW:</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-nl">TZ:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">DJ:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">DK:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">DM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">DO:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">UA:</span><span class="tok-mi">15</span><span class="tok-o">,</span><span class="tok-nl">UG:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">UK:</span><span class="tok-mi">58</span><span class="tok-o">,</span><span class="tok-nl">DZ:</span><span class="tok-mi">29</span><span class="tok-o">,</span><span class="tok-nl">US:</span><span class="tok-mi">579</span><span class="tok-o">,</span><span class="tok-nl">EC:</span><span class="tok-mi">15</span><span class="tok-o">,</span><span class="tok-nl">EE:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">EG:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">EH:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">UY:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">UZ:</span><span class="tok-mi">11</span><span class="tok-o">,</span><span class="tok-nl">ER:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">VC:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">ES:</span><span class="tok-mi">42</span><span class="tok-o">,</span><span class="tok-nl">ET:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">VE:</span><span class="tok-mi">24</span><span class="tok-o">,</span><span class="tok-nl">VG:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">VI:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">VN:</span><span class="tok-mi">21</span><span class="tok-o">,</span><span class="tok-nl">VU:</span><span class="tok-mi">26</span><span class="tok-o">,</span><span class="tok-nl">FI:</span><span class="tok-mi">20</span><span class="tok-o">,</span><span class="tok-nl">FJ:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">FK:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">FM:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">FO:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">FR:</span><span class="tok-mi">58</span><span class="tok-o">,</span><span class="tok-nl">WF:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">GA:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">WS:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GD:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GE:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">GF:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GG:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">GH:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">GI:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GL:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">GM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GN:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GP:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GQ:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">GR:</span><span class="tok-mi">39</span><span class="tok-o">,</span><span class="tok-nl">GT:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">GU:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GW:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GY:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">HK:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">HN:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">HR:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">HT:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">YE:</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-nl">HU:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">ID:</span><span class="tok-mi">67</span><span class="tok-o">,</span><span class="tok-nl">YT:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">IE:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">IL:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">IM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">IN:</span><span class="tok-mi">73</span><span class="tok-o">,</span><span class="tok-nl">ZA:</span><span class="tok-mi">20</span><span class="tok-o">,</span><span class="tok-nl">IQ:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">IR:</span><span class="tok-mi">44</span><span class="tok-o">,</span><span class="tok-nl">IS:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">IT:</span><span class="tok-mi">36</span><span class="tok-o">,</span><span class="tok-nl">ZM:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">JE:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">ZW:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">JM:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">JO:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">JP:</span><span class="tok-mi">63</span><span class="tok-o">,</span><span class="tok-nl">KE:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">KG:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">KH:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">KI:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">KM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">KN:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">KP:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">KR:</span><span class="tok-mi">15</span><span class="tok-o">,</span><span class="tok-nl">KS:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">KW:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">KY:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">KZ:</span><span class="tok-mi">20</span><span class="tok-o">,</span><span class="tok-nl">LA:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">LB:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">LC:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">LK:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">LR:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">LS:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">LT:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">LU:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">LV:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">LY:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">MA:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">MD:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">ME:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">MF:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MG:</span><span class="tok-mi">13</span><span class="tok-o">,</span><span class="tok-nl">MH:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">MK:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">ML:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MM:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">MN:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">MO:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MP:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">MQ:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MR:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">MS:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MT:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MU:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">MV:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">MW:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">MX:</span><span class="tok-mi">59</span><span class="tok-o">,</span><span class="tok-nl">MY:</span><span class="tok-mi">34</span><span class="tok-o">,</span><span class="tok-nl">MZ:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">NA:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">NC:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">NE:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">NF:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">NG:</span><span class="tok-mi">18</span><span class="tok-o">,</span><span class="tok-nl">NI:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">NL:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">NO:</span><span class="tok-mi">49</span><span class="tok-o">,</span><span class="tok-nl">NP:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">NR:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">NZ:</span><span class="tok-mi">25</span><span class="tok-o">,</span><span class="tok-nl">OM:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">PA:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">PE:</span><span class="tok-mi">20</span><span class="tok-o">,</span><span class="tok-nl">PF:</span><span class="tok-mi">30</span><span class="tok-o">,</span><span class="tok-nl">PG:</span><span class="tok-mi">26</span><span class="tok-o">,</span><span class="tok-nl">PH:</span><span class="tok-mi">38</span><span class="tok-o">,</span><span class="tok-nl">PK:</span><span class="tok-mi">21</span><span class="tok-o">,</span><span class="tok-nl">PL:</span><span class="tok-mi">13</span><span class="tok-o">,</span><span class="tok-nl">PM:</span><span class="tok-mi">1</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we wanted to sort the list in descending order using the numeric values we could
adjust the query as follows. Once again note the use of <em>local</em> to specify how the
ordering is applied.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">).</span>
      <span class="tok-n">order</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">,</span><span class="tok-n">desc</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This time it is much easier to see which countries have the most airports.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">US:</span><span class="tok-mi">579</span><span class="tok-o">,</span><span class="tok-nl">CN:</span><span class="tok-mi">209</span><span class="tok-o">,</span><span class="tok-nl">CA:</span><span class="tok-mi">203</span><span class="tok-o">,</span><span class="tok-nl">AU:</span><span class="tok-mi">124</span><span class="tok-o">,</span><span class="tok-nl">RU:</span><span class="tok-mi">120</span><span class="tok-o">,</span><span class="tok-nl">BR:</span><span class="tok-mi">115</span><span class="tok-o">,</span><span class="tok-nl">IN:</span><span class="tok-mi">73</span><span class="tok-o">,</span><span class="tok-nl">ID:</span><span class="tok-mi">67</span><span class="tok-o">,</span><span class="tok-nl">JP:</span><span class="tok-mi">63</span><span class="tok-o">,</span><span class="tok-nl">MX:</span><span class="tok-mi">59</span><span class="tok-o">,</span><span class="tok-nl">UK:</span><span class="tok-mi">58</span><span class="tok-o">,</span><span class="tok-nl">FR:</span><span class="tok-mi">58</span><span class="tok-o">,</span><span class="tok-nl">CO:</span><span class="tok-mi">50</span><span class="tok-o">,</span><span class="tok-nl">NO:</span><span class="tok-mi">49</span><span class="tok-o">,</span><span class="tok-nl">TR:</span><span class="tok-mi">48</span><span class="tok-o">,</span><span class="tok-nl">IR:</span><span class="tok-mi">44</span><span class="tok-o">,</span><span class="tok-nl">ES:</span><span class="tok-mi">42</span><span class="tok-o">,</span><span class="tok-nl">SE:</span><span class="tok-mi">39</span><span class="tok-o">,</span><span class="tok-nl">GR:</span><span class="tok-mi">39</span><span class="tok-o">,</span><span class="tok-nl">PH:</span><span class="tok-mi">38</span><span class="tok-o">,</span><span class="tok-nl">AR:</span><span class="tok-mi">36</span><span class="tok-o">,</span><span class="tok-nl">IT:</span><span class="tok-mi">36</span><span class="tok-o">,</span><span class="tok-nl">MY:</span><span class="tok-mi">34</span><span class="tok-o">,</span><span class="tok-nl">DE:</span><span class="tok-mi">33</span><span class="tok-o">,</span><span class="tok-nl">TH:</span><span class="tok-mi">32</span><span class="tok-o">,</span><span class="tok-nl">PF:</span><span class="tok-mi">30</span><span class="tok-o">,</span><span class="tok-nl">DZ:</span><span class="tok-mi">29</span><span class="tok-o">,</span><span class="tok-nl">SA:</span><span class="tok-mi">26</span><span class="tok-o">,</span><span class="tok-nl">VU:</span><span class="tok-mi">26</span><span class="tok-o">,</span><span class="tok-nl">PG:</span><span class="tok-mi">26</span><span class="tok-o">,</span><span class="tok-nl">NZ:</span><span class="tok-mi">25</span><span class="tok-o">,</span><span class="tok-nl">VE:</span><span class="tok-mi">24</span><span class="tok-o">,</span><span class="tok-nl">VN:</span><span class="tok-mi">21</span><span class="tok-o">,</span><span class="tok-nl">PK:</span><span class="tok-mi">21</span><span class="tok-o">,</span><span class="tok-nl">FI:</span><span class="tok-mi">20</span><span class="tok-o">,</span><span class="tok-nl">ZA:</span><span class="tok-mi">20</span><span class="tok-o">,</span><span class="tok-nl">KZ:</span><span class="tok-mi">20</span><span class="tok-o">,</span><span class="tok-nl">PE:</span><span class="tok-mi">20</span><span class="tok-o">,</span><span class="tok-nl">BS:</span><span class="tok-mi">18</span><span class="tok-o">,</span><span class="tok-nl">NG:</span><span class="tok-mi">18</span><span class="tok-o">,</span><span class="tok-nl">SB:</span><span class="tok-mi">17</span><span class="tok-o">,</span><span class="tok-nl">CL:</span><span class="tok-mi">17</span><span class="tok-o">,</span><span class="tok-nl">BO:</span><span class="tok-mi">15</span><span class="tok-o">,</span><span class="tok-nl">UA:</span><span class="tok-mi">15</span><span class="tok-o">,</span><span class="tok-nl">EC:</span><span class="tok-mi">15</span><span class="tok-o">,</span><span class="tok-nl">KR:</span><span class="tok-mi">15</span><span class="tok-o">,</span><span class="tok-nl">PT:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">AO:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">RO:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">ET:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">GL:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">KE:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">MA:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">MM:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">BZ:</span><span class="tok-mi">13</span><span class="tok-o">,</span><span class="tok-nl">CR:</span><span class="tok-mi">13</span><span class="tok-o">,</span><span class="tok-nl">MG:</span><span class="tok-mi">13</span><span class="tok-o">,</span><span class="tok-nl">PL:</span><span class="tok-mi">13</span><span class="tok-o">,</span><span class="tok-nl">CU:</span><span class="tok-mi">12</span><span class="tok-o">,</span><span class="tok-nl">CD:</span><span class="tok-mi">11</span><span class="tok-o">,</span><span class="tok-nl">UZ:</span><span class="tok-mi">11</span><span class="tok-o">,</span><span class="tok-nl">AE:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">EG:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">FJ:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">LY:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">MN:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">MZ:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">NP:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">TW:</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-nl">YE:</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-nl">TN:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">TZ:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">DK:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">HR:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">ZM:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">LA:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">MV:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">BD:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">CV:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">DO:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">IE:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">PR:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">AT:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">CK:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">HN:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">IQ:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">LK:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">AZ:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">BE:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">SD:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">SO:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">CH:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">CM:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">CZ:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">GH:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">IL:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">IS:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">NL:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">PA:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">AF:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">BA:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">BG:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">BW:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">TC:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">TJ:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">UG:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">FM:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">NA:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">OM:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">BQ:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">SN:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">CG:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">CY:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">EE:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">GE:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">ZW:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">KH:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">KY:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">LT:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">MR:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">PY:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">AM:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">RE:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">RS:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">BF:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">RW:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">SC:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">SH:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">BY:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">SK:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">SY:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">TT:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">EH:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">UY:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">VG:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">VI:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">FK:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">WF:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">GA:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">GG:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">GQ:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">GT:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">GY:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">HT:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">HU:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">JM:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">JO:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">KG:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">KI:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">KN:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">LC:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">LR:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">ME:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">MH:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">MP:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">MU:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">MW:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">PW:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">QA:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">AG:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">AI:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">AL:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">AS:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">AW:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BB:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BH:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BI:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BJ:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BL:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BN:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BT:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SG:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SI:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SL:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SR:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SS:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">CC:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">ST:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SV:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">CF:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SX:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">CI:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SZ:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">TD:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">TG:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">CW:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">CX:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">TL:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">TM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">TO:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">TV:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">DJ:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">DM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">ER:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">VC:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">FO:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">WS:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GD:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GF:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GI:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GN:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GP:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GU:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GW:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">HK:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">YT:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">IM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">JE:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">KM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">KP:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">KS:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">KW:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">LB:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">LS:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">LU:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">LV:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MD:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MF:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MK:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">ML:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MO:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MQ:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MS:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MT:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">NC:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">NE:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">NF:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">NI:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">NR:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">PM:</span><span class="tok-mi">1</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we wanted to sort by the country code, the <em>key</em> in other words, we could change
the query accordingly. In this case we will use <em>by(keys,asc)</em> to get a sort in
ascending order. If we wanted to sort in descending order by key we could use
<em>by(keys,desc)</em> instead.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">).</span>
      <span class="tok-n">order</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">keys</span><span class="tok-o">,</span><span class="tok-n">asc</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This time the results are now sorted using the country codes in ascending
alphabetical order.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">AE:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">AF:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">AG:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">AI:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">AL:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">AM:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">AO:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">AR:</span><span class="tok-mi">36</span><span class="tok-o">,</span><span class="tok-nl">AS:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">AT:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">AU:</span><span class="tok-mi">124</span><span class="tok-o">,</span><span class="tok-nl">AW:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">AZ:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">BA:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">BB:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BD:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">BE:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">BF:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">BG:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">BH:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BI:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BJ:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BL:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BN:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BO:</span><span class="tok-mi">15</span><span class="tok-o">,</span><span class="tok-nl">BQ:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">BR:</span><span class="tok-mi">115</span><span class="tok-o">,</span><span class="tok-nl">BS:</span><span class="tok-mi">18</span><span class="tok-o">,</span><span class="tok-nl">BT:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BW:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">BY:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">BZ:</span><span class="tok-mi">13</span><span class="tok-o">,</span><span class="tok-nl">CA:</span><span class="tok-mi">203</span><span class="tok-o">,</span><span class="tok-nl">CC:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">CD:</span><span class="tok-mi">11</span><span class="tok-o">,</span><span class="tok-nl">CF:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">CG:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">CH:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">CI:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">CK:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">CL:</span><span class="tok-mi">17</span><span class="tok-o">,</span><span class="tok-nl">CM:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">CN:</span><span class="tok-mi">209</span><span class="tok-o">,</span><span class="tok-nl">CO:</span><span class="tok-mi">50</span><span class="tok-o">,</span><span class="tok-nl">CR:</span><span class="tok-mi">13</span><span class="tok-o">,</span><span class="tok-nl">CU:</span><span class="tok-mi">12</span><span class="tok-o">,</span><span class="tok-nl">CV:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">CW:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">CX:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">CY:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">CZ:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">DE:</span><span class="tok-mi">33</span><span class="tok-o">,</span><span class="tok-nl">DJ:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">DK:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">DM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">DO:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">DZ:</span><span class="tok-mi">29</span><span class="tok-o">,</span><span class="tok-nl">EC:</span><span class="tok-mi">15</span><span class="tok-o">,</span><span class="tok-nl">EE:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">EG:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">EH:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">ER:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">ES:</span><span class="tok-mi">42</span><span class="tok-o">,</span><span class="tok-nl">ET:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">FI:</span><span class="tok-mi">20</span><span class="tok-o">,</span><span class="tok-nl">FJ:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">FK:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">FM:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">FO:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">FR:</span><span class="tok-mi">58</span><span class="tok-o">,</span><span class="tok-nl">GA:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">GD:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GE:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">GF:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GG:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">GH:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">GI:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GL:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">GM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GN:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GP:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GQ:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">GR:</span><span class="tok-mi">39</span><span class="tok-o">,</span><span class="tok-nl">GT:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">GU:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GW:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GY:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">HK:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">HN:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">HR:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">HT:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">HU:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">ID:</span><span class="tok-mi">67</span><span class="tok-o">,</span><span class="tok-nl">IE:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">IL:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">IM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">IN:</span><span class="tok-mi">73</span><span class="tok-o">,</span><span class="tok-nl">IQ:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">IR:</span><span class="tok-mi">44</span><span class="tok-o">,</span><span class="tok-nl">IS:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">IT:</span><span class="tok-mi">36</span><span class="tok-o">,</span><span class="tok-nl">JE:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">JM:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">JO:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">JP:</span><span class="tok-mi">63</span><span class="tok-o">,</span><span class="tok-nl">KE:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">KG:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">KH:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">KI:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">KM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">KN:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">KP:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">KR:</span><span class="tok-mi">15</span><span class="tok-o">,</span><span class="tok-nl">KS:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">KW:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">KY:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">KZ:</span><span class="tok-mi">20</span><span class="tok-o">,</span><span class="tok-nl">LA:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">LB:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">LC:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">LK:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">LR:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">LS:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">LT:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">LU:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">LV:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">LY:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">MA:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">MD:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">ME:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">MF:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MG:</span><span class="tok-mi">13</span><span class="tok-o">,</span><span class="tok-nl">MH:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">MK:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">ML:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MM:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">MN:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">MO:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MP:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">MQ:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MR:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">MS:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MT:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MU:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">MV:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">MW:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">MX:</span><span class="tok-mi">59</span><span class="tok-o">,</span><span class="tok-nl">MY:</span><span class="tok-mi">34</span><span class="tok-o">,</span><span class="tok-nl">MZ:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">NA:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">NC:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">NE:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">NF:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">NG:</span><span class="tok-mi">18</span><span class="tok-o">,</span><span class="tok-nl">NI:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">NL:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">NO:</span><span class="tok-mi">49</span><span class="tok-o">,</span><span class="tok-nl">NP:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">NR:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">NZ:</span><span class="tok-mi">25</span><span class="tok-o">,</span><span class="tok-nl">OM:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">PA:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">PE:</span><span class="tok-mi">20</span><span class="tok-o">,</span><span class="tok-nl">PF:</span><span class="tok-mi">30</span><span class="tok-o">,</span><span class="tok-nl">PG:</span><span class="tok-mi">26</span><span class="tok-o">,</span><span class="tok-nl">PH:</span><span class="tok-mi">38</span><span class="tok-o">,</span><span class="tok-nl">PK:</span><span class="tok-mi">21</span><span class="tok-o">,</span><span class="tok-nl">PL:</span><span class="tok-mi">13</span><span class="tok-o">,</span><span class="tok-nl">PM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">PR:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">PT:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">PW:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">PY:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">QA:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">RE:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">RO:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">RS:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">RU:</span><span class="tok-mi">120</span><span class="tok-o">,</span><span class="tok-nl">RW:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">SA:</span><span class="tok-mi">26</span><span class="tok-o">,</span><span class="tok-nl">SB:</span><span class="tok-mi">17</span><span class="tok-o">,</span><span class="tok-nl">SC:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">SD:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">SE:</span><span class="tok-mi">39</span><span class="tok-o">,</span><span class="tok-nl">SG:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SH:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">SI:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SK:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">SL:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SN:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">SO:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">SR:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SS:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">ST:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SV:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SX:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SY:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">SZ:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">TC:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">TD:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">TG:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">TH:</span><span class="tok-mi">32</span><span class="tok-o">,</span><span class="tok-nl">TJ:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">TL:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">TM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">TN:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">TO:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">TR:</span><span class="tok-mi">48</span><span class="tok-o">,</span><span class="tok-nl">TT:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">TV:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">TW:</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-nl">TZ:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">UA:</span><span class="tok-mi">15</span><span class="tok-o">,</span><span class="tok-nl">UG:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">UK:</span><span class="tok-mi">58</span><span class="tok-o">,</span><span class="tok-nl">US:</span><span class="tok-mi">579</span><span class="tok-o">,</span><span class="tok-nl">UY:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">UZ:</span><span class="tok-mi">11</span><span class="tok-o">,</span><span class="tok-nl">VC:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">VE:</span><span class="tok-mi">24</span><span class="tok-o">,</span><span class="tok-nl">VG:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">VI:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">VN:</span><span class="tok-mi">21</span><span class="tok-o">,</span><span class="tok-nl">VU:</span><span class="tok-mi">26</span><span class="tok-o">,</span><span class="tok-nl">WF:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">WS:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">YE:</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-nl">YT:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">ZA:</span><span class="tok-mi">20</span><span class="tok-o">,</span><span class="tok-nl">ZM:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">ZW:</span><span class="tok-mi">3</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that we can use <em>select</em> to only return one or more of the full set of key/value
pairs returned. Here is an example of doing just that.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Only return the values for Germany, China, Holland and the US.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'DE'</span><span class="tok-o">,</span><span class="tok-s1">'CN'</span><span class="tok-o">,</span><span class="tok-s1">'NL'</span><span class="tok-o">,</span><span class="tok-s1">'US'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">DE:</span><span class="tok-mi">32</span><span class="tok-o">,</span> <span class="tok-nl">CN:</span><span class="tok-mi">179</span><span class="tok-o">,</span> <span class="tok-nl">NL:</span><span class="tok-mi">5</span><span class="tok-o">,</span> <span class="tok-nl">US:</span><span class="tok-mi">566</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Because the <em>air-routes</em> graph also has country specific vertices, we could chose to
write the previous queries a different way. We could start by finding country
vertices and then see how many airport vertices each one is connected to. In this
instance, because a <em>group</em> step is being used, countries with no airports will be
included.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Another way to ask the question above, this time by counting the</span>
<span class="tok-c1">// edges (out degree) from each country</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span>
      <span class="tok-n">order</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">,</span><span class="tok-n">desc</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This time the countries with no airports <strong>are</strong> included in the results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">US:</span><span class="tok-mi">579</span><span class="tok-o">,</span><span class="tok-nl">CN:</span><span class="tok-mi">209</span><span class="tok-o">,</span><span class="tok-nl">CA:</span><span class="tok-mi">204</span><span class="tok-o">,</span><span class="tok-nl">AU:</span><span class="tok-mi">125</span><span class="tok-o">,</span><span class="tok-nl">RU:</span><span class="tok-mi">122</span><span class="tok-o">,</span><span class="tok-nl">BR:</span><span class="tok-mi">115</span><span class="tok-o">,</span><span class="tok-nl">IN:</span><span class="tok-mi">74</span><span class="tok-o">,</span><span class="tok-nl">ID:</span><span class="tok-mi">67</span><span class="tok-o">,</span><span class="tok-nl">JP:</span><span class="tok-mi">63</span><span class="tok-o">,</span><span class="tok-nl">MX:</span><span class="tok-mi">59</span><span class="tok-o">,</span><span class="tok-nl">UK:</span><span class="tok-mi">58</span><span class="tok-o">,</span><span class="tok-nl">FR:</span><span class="tok-mi">58</span><span class="tok-o">,</span><span class="tok-nl">CO:</span><span class="tok-mi">50</span><span class="tok-o">,</span><span class="tok-nl">NO:</span><span class="tok-mi">49</span><span class="tok-o">,</span><span class="tok-nl">TR:</span><span class="tok-mi">48</span><span class="tok-o">,</span><span class="tok-nl">IR:</span><span class="tok-mi">45</span><span class="tok-o">,</span><span class="tok-nl">ES:</span><span class="tok-mi">42</span><span class="tok-o">,</span><span class="tok-nl">SE:</span><span class="tok-mi">39</span><span class="tok-o">,</span><span class="tok-nl">GR:</span><span class="tok-mi">39</span><span class="tok-o">,</span><span class="tok-nl">PH:</span><span class="tok-mi">39</span><span class="tok-o">,</span><span class="tok-nl">AR:</span><span class="tok-mi">37</span><span class="tok-o">,</span><span class="tok-nl">IT:</span><span class="tok-mi">36</span><span class="tok-o">,</span><span class="tok-nl">MY:</span><span class="tok-mi">34</span><span class="tok-o">,</span><span class="tok-nl">DE:</span><span class="tok-mi">33</span><span class="tok-o">,</span><span class="tok-nl">TH:</span><span class="tok-mi">32</span><span class="tok-o">,</span><span class="tok-nl">PF:</span><span class="tok-mi">30</span><span class="tok-o">,</span><span class="tok-nl">DZ:</span><span class="tok-mi">29</span><span class="tok-o">,</span><span class="tok-nl">SA:</span><span class="tok-mi">26</span><span class="tok-o">,</span><span class="tok-nl">VU:</span><span class="tok-mi">26</span><span class="tok-o">,</span><span class="tok-nl">PG:</span><span class="tok-mi">26</span><span class="tok-o">,</span><span class="tok-nl">NZ:</span><span class="tok-mi">25</span><span class="tok-o">,</span><span class="tok-nl">VE:</span><span class="tok-mi">24</span><span class="tok-o">,</span><span class="tok-nl">VN:</span><span class="tok-mi">21</span><span class="tok-o">,</span><span class="tok-nl">PK:</span><span class="tok-mi">21</span><span class="tok-o">,</span><span class="tok-nl">FI:</span><span class="tok-mi">20</span><span class="tok-o">,</span><span class="tok-nl">ZA:</span><span class="tok-mi">20</span><span class="tok-o">,</span><span class="tok-nl">KZ:</span><span class="tok-mi">20</span><span class="tok-o">,</span><span class="tok-nl">PE:</span><span class="tok-mi">20</span><span class="tok-o">,</span><span class="tok-nl">BS:</span><span class="tok-mi">18</span><span class="tok-o">,</span><span class="tok-nl">NG:</span><span class="tok-mi">18</span><span class="tok-o">,</span><span class="tok-nl">SB:</span><span class="tok-mi">17</span><span class="tok-o">,</span><span class="tok-nl">CL:</span><span class="tok-mi">17</span><span class="tok-o">,</span><span class="tok-nl">BO:</span><span class="tok-mi">15</span><span class="tok-o">,</span><span class="tok-nl">UA:</span><span class="tok-mi">15</span><span class="tok-o">,</span><span class="tok-nl">EC:</span><span class="tok-mi">15</span><span class="tok-o">,</span><span class="tok-nl">KR:</span><span class="tok-mi">15</span><span class="tok-o">,</span><span class="tok-nl">PT:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">AO:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">RO:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">ET:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">GL:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">KE:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">MA:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">MM:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">BZ:</span><span class="tok-mi">13</span><span class="tok-o">,</span><span class="tok-nl">CR:</span><span class="tok-mi">13</span><span class="tok-o">,</span><span class="tok-nl">MG:</span><span class="tok-mi">13</span><span class="tok-o">,</span><span class="tok-nl">PL:</span><span class="tok-mi">13</span><span class="tok-o">,</span><span class="tok-nl">CU:</span><span class="tok-mi">12</span><span class="tok-o">,</span><span class="tok-nl">CD:</span><span class="tok-mi">11</span><span class="tok-o">,</span><span class="tok-nl">UZ:</span><span class="tok-mi">11</span><span class="tok-o">,</span><span class="tok-nl">AE:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">EG:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">FJ:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">LY:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">MN:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">MZ:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">NP:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">TW:</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-nl">YE:</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-nl">TN:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">TZ:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">DK:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">HR:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">ZM:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">LA:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">MV:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">BD:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">CV:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">DO:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">IE:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">PR:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">AT:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">CK:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">HN:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">IQ:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">LK:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">AZ:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">BE:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">SD:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">SO:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">CH:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">CM:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">CZ:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">GH:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">IL:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">IS:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">NA:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">NL:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">PA:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">AF:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">BA:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">BG:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">BW:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">TC:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">TJ:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">UG:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">FM:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">OM:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">BQ:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">SN:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">CG:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">CY:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">EE:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">GE:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">ZW:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">KH:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">KY:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">LT:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">MR:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">PY:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">AM:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">RE:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">RS:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">BF:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">RW:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">SC:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">SH:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">SI:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">BY:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">SK:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">SY:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">TT:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">EH:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">UY:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">VG:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">VI:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">FK:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">WF:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">GA:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">GG:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">GQ:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">GT:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">GY:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">HT:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">HU:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">JM:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">JO:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">KG:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">KI:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">KN:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">LC:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">LR:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">ME:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">MH:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">MP:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">MU:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">MW:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">PW:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">QA:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">AG:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">AI:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">AL:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">AS:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">AW:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BB:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BH:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BI:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BJ:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BL:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BN:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BT:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SG:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SL:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SR:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">CC:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SS:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">ST:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">CF:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SV:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SX:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">CI:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">SZ:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">TD:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">TG:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">CW:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">CX:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">TL:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">TM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">TO:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">TV:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">DJ:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">DM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">ER:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">VC:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">FO:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">WS:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GD:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GF:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GI:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GN:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GP:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GU:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">GW:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">HK:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">YT:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">IM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">JE:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">KM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">KP:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">KS:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">KW:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">LB:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">LS:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">LU:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">LV:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MD:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MF:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MK:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">ML:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MO:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MQ:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MS:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MT:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">NC:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">NE:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">NF:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">NI:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">NR:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">PM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">AD:</span><span class="tok-mi">0</span><span class="tok-o">,</span><span class="tok-nl">SM:</span><span class="tok-mi">0</span><span class="tok-o">,</span><span class="tok-nl">LI:</span><span class="tok-mi">0</span><span class="tok-o">,</span><span class="tok-nl">MC:</span><span class="tok-mi">0</span><span class="tok-o">,</span><span class="tok-nl">PN:</span><span class="tok-mi">0</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we only wanted to see the last few of the sorted results we could add a <em>tail</em>
step with <em>local</em> scope to the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span>
      <span class="tok-n">order</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">,</span><span class="tok-n">desc</span><span class="tok-o">).</span>
      <span class="tok-n">tail</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">,</span><span class="tok-mi">20</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">LV:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MD:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MF:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MK:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">ML:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MO:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MQ:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MS:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">MT:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">NC:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">NE:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">NF:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">NI:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">NR:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">PM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">AD:</span><span class="tok-mi">0</span><span class="tok-o">,</span><span class="tok-nl">SM:</span><span class="tok-mi">0</span><span class="tok-o">,</span><span class="tok-nl">LI:</span><span class="tok-mi">0</span><span class="tok-o">,</span><span class="tok-nl">MC:</span><span class="tok-mi">0</span><span class="tok-o">,</span><span class="tok-nl">PN:</span><span class="tok-mi">0</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="continentdist">5.1.11. Distribution of airports by continent</h4>
<div class="paragraph">
<p>We can use a similar query to the one above to find out how many airports are located in
each of the seven continents. As you can see from the output, a key/value map is again
returned where the key is the continent code and the value is the number of airports in
that continent. Note that currently  there are no airports with regular scheduled service
in Antarctica!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// How many airports are there in each continent?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'continent'</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">())</span>

<span class="tok-o">[</span><span class="tok-nl">EU:</span><span class="tok-mi">583</span><span class="tok-o">,</span><span class="tok-nl">AS:</span><span class="tok-mi">932</span><span class="tok-o">,</span><span class="tok-nl">NA:</span><span class="tok-mi">978</span><span class="tok-o">,</span><span class="tok-nl">OC:</span><span class="tok-mi">284</span><span class="tok-o">,</span><span class="tok-nl">AF:</span><span class="tok-mi">294</span><span class="tok-o">,</span><span class="tok-nl">AN:</span><span class="tok-mi">0</span><span class="tok-o">,</span><span class="tok-nl">SA:</span><span class="tok-mi">303</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_distribution_of_routes_per_airport">5.1.12. Distribution of routes per airport</h4>
<div class="paragraph">
<p>We have already examined various ways to calculate the distribution of routes in the
graph. The following query will, for each airport, return a key value pair where the
key is the airport code and the value is the number of outgoing routes from that
airport. Because there are over 3,000 airports in the graph, this query will produce
a large results. I decided not to include those results here. The second query just
picks the results from the map for a few airports. Those results are shown.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// How many flights are there from each airport?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-c1">// count the routes from all the airports and then select a few.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'AUS'</span><span class="tok-o">,</span><span class="tok-s1">'AMS'</span><span class="tok-o">,</span><span class="tok-s1">'JFK'</span><span class="tok-o">,</span><span class="tok-s1">'DUB'</span><span class="tok-o">,</span><span class="tok-s1">'MEX'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">AUS:</span><span class="tok-mi">59</span><span class="tok-o">,</span><span class="tok-nl">AMS:</span><span class="tok-mi">272</span><span class="tok-o">,</span><span class="tok-nl">JFK:</span><span class="tok-mi">186</span><span class="tok-o">,</span><span class="tok-nl">DUB:</span><span class="tok-mi">165</span><span class="tok-o">,</span><span class="tok-nl">MEX:</span><span class="tok-mi">105</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This next query essentially asks the same question about how many outgoing routes
each airport has. However, rather than return the count for each airport
individually, it groups the ones with the same number of routes together. As this
query returns a lot of data I just included a few lines from the full result below
the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Same query except sorted into groups by ascending count</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
      <span class="tok-n">order</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">keys</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As can be seen this time the count value is the key and the airport codes are the
values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-mi">76</span><span class="tok-o">:[</span><span class="tok-n">TPA</span><span class="tok-o">,</span><span class="tok-n">BNE</span><span class="tok-o">,</span><span class="tok-n">PDX</span><span class="tok-o">],</span><span class="tok-mi">77</span><span class="tok-o">:[</span><span class="tok-n">RIX</span><span class="tok-o">,</span><span class="tok-n">WUH</span><span class="tok-o">],</span><span class="tok-mi">78</span><span class="tok-o">:[</span><span class="tok-n">IBZ</span><span class="tok-o">,</span><span class="tok-n">PTY</span><span class="tok-o">],</span><span class="tok-mi">79</span><span class="tok-o">:[</span><span class="tok-n">ADD</span><span class="tok-o">,</span><span class="tok-n">AYT</span><span class="tok-o">],</span><span class="tok-mi">80</span><span class="tok-o">:[</span><span class="tok-n">MNL</span><span class="tok-o">,</span><span class="tok-n">BOG</span><span class="tok-o">,</span><span class="tok-n">XMN</span><span class="tok-o">,</span><span class="tok-n">CSX</span><span class="tok-o">],</span><span class="tok-mi">81</span><span class="tok-o">:[</span><span class="tok-n">SFB</span><span class="tok-o">],</span><span class="tok-mi">82</span><span class="tok-o">:[</span><span class="tok-n">GLA</span><span class="tok-o">,</span><span class="tok-n">HND</span><span class="tok-o">],</span><span class="tok-mi">83</span><span class="tok-o">:[</span><span class="tok-n">CAI</span><span class="tok-o">,</span><span class="tok-n">MDW</span><span class="tok-o">,</span><span class="tok-n">OTP</span><span class="tok-o">],</span><span class="tok-mi">84</span><span class="tok-o">:[</span><span class="tok-n">VCE</span><span class="tok-o">,</span><span class="tok-n">BRS</span><span class="tok-o">,</span><span class="tok-n">HGH</span><span class="tok-o">],</span><span class="tok-mi">85</span><span class="tok-o">:[</span><span class="tok-n">JNB</span><span class="tok-o">,</span><span class="tok-n">MLA</span><span class="tok-o">,</span><span class="tok-n">NAP</span><span class="tok-o">,</span><span class="tok-n">RUH</span><span class="tok-o">],</span><span class="tok-mi">86</span><span class="tok-o">:[</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-n">SHJ</span><span class="tok-o">],</span><span class="tok-mi">89</span><span class="tok-o">:[</span><span class="tok-n">BWI</span><span class="tok-o">],</span><span class="tok-mi">90</span><span class="tok-o">:[</span><span class="tok-n">CMN</span><span class="tok-o">],</span><span class="tok-mi">91</span><span class="tok-o">:[</span><span class="tok-n">LPA</span><span class="tok-o">,</span><span class="tok-n">VKO</span><span class="tok-o">],</span><span class="tok-mi">92</span><span class="tok-o">:[</span><span class="tok-n">SXF</span><span class="tok-o">],</span><span class="tok-mi">93</span><span class="tok-o">:[</span><span class="tok-n">DCA</span><span class="tok-o">,</span><span class="tok-n">GRU</span><span class="tok-o">,</span><span class="tok-n">LYS</span><span class="tok-o">],</span><span class="tok-mi">94</span><span class="tok-o">:[</span><span class="tok-n">SLC</span><span class="tok-o">,</span><span class="tok-n">YVR</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">,</span><span class="tok-n">MRS</span><span class="tok-o">,</span><span class="tok-n">TFS</span><span class="tok-o">],</span><span class="tok-mi">95</span><span class="tok-o">:[</span><span class="tok-n">STR</span><span class="tok-o">,</span><span class="tok-n">CRL</span><span class="tok-o">],</span><span class="tok-mi">97</span><span class="tok-o">:[</span><span class="tok-n">NCE</span><span class="tok-o">,</span><span class="tok-n">AUH</span><span class="tok-o">],</span><span class="tok-mi">98</span><span class="tok-o">:[</span><span class="tok-n">BUD</span><span class="tok-o">,</span><span class="tok-n">WAW</span><span class="tok-o">],</span><span class="tok-mi">101</span><span class="tok-o">:[</span><span class="tok-n">YUL</span><span class="tok-o">],</span><span class="tok-mi">102</span><span class="tok-o">:[</span><span class="tok-n">BGY</span><span class="tok-o">],</span><span class="tok-mi">104</span><span class="tok-o">:[</span><span class="tok-n">LTN</span><span class="tok-o">,</span><span class="tok-n">JED</span><span class="tok-o">,</span><span class="tok-n">SZX</span><span class="tok-o">],</span><span class="tok-mi">105</span><span class="tok-o">:[</span><span class="tok-n">PHX</span><span class="tok-o">,</span><span class="tok-n">MEX</span><span class="tok-o">,</span><span class="tok-n">TLV</span><span class="tok-o">,</span><span class="tok-n">HAM</span><span class="tok-o">,</span><span class="tok-n">XIY</span><span class="tok-o">],</span><span class="tok-mi">106</span><span class="tok-o">:[</span><span class="tok-n">ALC</span><span class="tok-o">,</span><span class="tok-n">CUN</span><span class="tok-o">,</span><span class="tok-n">CKG</span><span class="tok-o">],</span><span class="tok-mi">107</span><span class="tok-o">:[</span><span class="tok-n">HEL</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">,</span><span class="tok-n">KMG</span><span class="tok-o">],</span><span class="tok-mi">108</span><span class="tok-o">:[</span><span class="tok-n">DEL</span><span class="tok-o">],</span><span class="tok-mi">109</span><span class="tok-o">:[</span><span class="tok-n">BHX</span><span class="tok-o">,</span><span class="tok-n">SAW</span><span class="tok-o">],</span><span class="tok-mi">110</span><span class="tok-o">:[</span><span class="tok-n">TPE</span><span class="tok-o">],</span><span class="tok-mi">112</span><span class="tok-o">:[</span><span class="tok-n">NRT</span><span class="tok-o">],</span><span class="tok-mi">113</span><span class="tok-o">:[</span><span class="tok-n">GVA</span><span class="tok-o">],</span><span class="tok-mi">114</span><span class="tok-o">:[</span><span class="tok-n">SEA</span><span class="tok-o">],</span><span class="tok-mi">115</span><span class="tok-o">:[</span><span class="tok-n">PRG</span><span class="tok-o">],</span><span class="tok-mi">116</span><span class="tok-o">:[</span><span class="tok-n">CGN</span><span class="tok-o">,</span><span class="tok-n">LIS</span><span class="tok-o">],</span><span class="tok-mi">118</span><span class="tok-o">:[</span><span class="tok-n">ATH</span><span class="tok-o">,</span><span class="tok-n">TXL</span><span class="tok-o">],</span><span class="tok-mi">119</span><span class="tok-o">:[</span><span class="tok-n">OSL</span><span class="tok-o">],</span><span class="tok-mi">122</span><span class="tok-o">:[</span><span class="tok-n">KUL</span><span class="tok-o">],</span><span class="tok-mi">123</span><span class="tok-o">:[</span><span class="tok-n">MCO</span><span class="tok-o">],</span><span class="tok-mi">124</span><span class="tok-o">:[</span><span class="tok-n">MXP</span><span class="tok-o">,</span><span class="tok-n">CTU</span><span class="tok-o">],</span><span class="tok-mi">126</span><span class="tok-o">:[</span><span class="tok-n">AGP</span><span class="tok-o">],</span><span class="tok-mi">127</span><span class="tok-o">:[</span><span class="tok-n">ORY</span><span class="tok-o">],</span><span class="tok-mi">129</span><span class="tok-o">:[</span><span class="tok-n">PHL</span><span class="tok-o">],</span><span class="tok-mi">130</span><span class="tok-o">:[</span><span class="tok-n">BOS</span><span class="tok-o">],</span><span class="tok-mi">132</span><span class="tok-o">:[</span><span class="tok-n">BKK</span><span class="tok-o">],</span><span class="tok-mi">133</span><span class="tok-o">:[</span><span class="tok-n">LED</span><span class="tok-o">],</span><span class="tok-mi">136</span><span class="tok-o">:[</span><span class="tok-n">IAD</span><span class="tok-o">],</span><span class="tok-mi">137</span><span class="tok-o">:[</span><span class="tok-n">DTW</span><span class="tok-o">],</span><span class="tok-mi">141</span><span class="tok-o">:[</span><span class="tok-n">SFO</span><span class="tok-o">],</span><span class="tok-mi">142</span><span class="tok-o">:[</span><span class="tok-n">FLL</span><span class="tok-o">],</span><span class="tok-mi">143</span><span class="tok-o">:[</span><span class="tok-n">ARN</span><span class="tok-o">,</span><span class="tok-n">PMI</span><span class="tok-o">],</span><span class="tok-mi">144</span><span class="tok-o">:[</span><span class="tok-n">MSP</span><span class="tok-o">,</span><span class="tok-n">ICN</span><span class="tok-o">],</span><span class="tok-mi">145</span><span class="tok-o">:[</span><span class="tok-n">LAS</span><span class="tok-o">,</span><span class="tok-n">CPH</span><span class="tok-o">],</span><span class="tok-mi">146</span><span class="tok-o">:[</span><span class="tok-n">SIN</span><span class="tok-o">],</span><span class="tok-mi">151</span><span class="tok-o">:[</span><span class="tok-n">HKG</span><span class="tok-o">],</span><span class="tok-mi">152</span><span class="tok-o">:[</span><span class="tok-n">ZRH</span><span class="tok-o">],</span><span class="tok-mi">156</span><span class="tok-o">:[</span><span class="tok-n">SVO</span><span class="tok-o">],</span><span class="tok-mi">162</span><span class="tok-o">:[</span><span class="tok-n">VIE</span><span class="tok-o">],</span><span class="tok-mi">163</span><span class="tok-o">:[</span><span class="tok-n">DOH</span><span class="tok-o">],</span><span class="tok-mi">164</span><span class="tok-o">:[</span><span class="tok-n">CAN</span><span class="tok-o">],</span><span class="tok-mi">165</span><span class="tok-o">:[</span><span class="tok-n">DUB</span><span class="tok-o">],</span><span class="tok-mi">166</span><span class="tok-o">:[</span><span class="tok-n">DUS</span><span class="tok-o">],</span><span class="tok-mi">168</span><span class="tok-o">:[</span><span class="tok-n">CLT</span><span class="tok-o">],</span><span class="tok-mi">171</span><span class="tok-o">:[</span><span class="tok-n">MIA</span><span class="tok-o">],</span><span class="tok-mi">180</span><span class="tok-o">:[</span><span class="tok-n">BRU</span><span class="tok-o">],</span><span class="tok-mi">181</span><span class="tok-o">:[</span><span class="tok-n">YYZ</span><span class="tok-o">],</span><span class="tok-mi">182</span><span class="tok-o">:[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">],</span><span class="tok-mi">186</span><span class="tok-o">:[</span><span class="tok-n">STN</span><span class="tok-o">],</span><span class="tok-mi">187</span><span class="tok-o">:[</span><span class="tok-n">JFK</span><span class="tok-o">],</span><span class="tok-mi">188</span><span class="tok-o">:[</span><span class="tok-n">DEN</span><span class="tok-o">],</span><span class="tok-mi">189</span><span class="tok-o">:[</span><span class="tok-n">FCO</span><span class="tok-o">],</span><span class="tok-mi">190</span><span class="tok-o">:[</span><span class="tok-n">BCN</span><span class="tok-o">],</span><span class="tok-mi">191</span><span class="tok-o">:[</span><span class="tok-n">LHR</span><span class="tok-o">],</span><span class="tok-mi">192</span><span class="tok-o">:[</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-n">MAD</span><span class="tok-o">],</span><span class="tok-mi">195</span><span class="tok-o">:[</span><span class="tok-n">LAX</span><span class="tok-o">],</span><span class="tok-mi">200</span><span class="tok-o">:[</span><span class="tok-n">LGW</span><span class="tok-o">],</span><span class="tok-mi">201</span><span class="tok-o">:[</span><span class="tok-n">PVG</span><span class="tok-o">],</span><span class="tok-mi">214</span><span class="tok-o">:[</span><span class="tok-n">DME</span><span class="tok-o">],</span><span class="tok-mi">221</span><span class="tok-o">:[</span><span class="tok-n">DFW</span><span class="tok-o">],</span><span class="tok-mi">229</span><span class="tok-o">:[</span><span class="tok-n">DXB</span><span class="tok-o">],</span><span class="tok-mi">232</span><span class="tok-o">:[</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">ORD</span><span class="tok-o">],</span><span class="tok-mi">234</span><span class="tok-o">:[</span><span class="tok-n">PEK</span><span class="tok-o">],</span><span class="tok-mi">237</span><span class="tok-o">:[</span><span class="tok-n">MUC</span><span class="tok-o">],</span><span class="tok-mi">262</span><span class="tok-o">:[</span><span class="tok-n">CDG</span><span class="tok-o">],</span><span class="tok-mi">269</span><span class="tok-o">:[</span><span class="tok-n">AMS</span><span class="tok-o">],</span><span class="tok-mi">270</span><span class="tok-o">:[</span><span class="tok-n">IST</span><span class="tok-o">],</span><span class="tok-mi">272</span><span class="tok-o">:[</span><span class="tok-n">FRA</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As the above query returns a lot of data, we can also extract specific values we are
interested in as follows. Only airports with 105 outgoing routes are selected.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Which of these airports have 105 outgoing routes?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">().</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-mi">105L</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Currently <em>select</em> can only take a string value as the key so we have to
use the slightly awkward <em>next().get()</em> syntax to get a numeric key from a
result.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>This time the results only include the airports with 105 outgoing routes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">PHX</span>
<span class="tok-n">MEX</span>
<span class="tok-n">TLV</span>
<span class="tok-n">HAM</span>
<span class="tok-n">XIY</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="groupvar">5.1.13. Using groupCount with a traversal variable</h4>
<div class="paragraph">
<p>So far we have just used <em>groupCount</em> with no parameters. When used in that way,
<em>groupCount</em> behaves like a <em>map</em> step in that it passes the transformed data on to
the next step. However, if you specify the name of a traversal variable as a
parameter, the results of the count will be stored in that variable and <em>groupCount</em>
will act the same way as a <em>sideEffect</em> would, nothing is passed on from <em>groupCount</em>
to the next step. We can use this capability to keep track of things during a query
while not actually changing the overall state of the traversal.</p>
</div>
<div class="paragraph">
<p>The example below starts at the vertex <em>V(3)</em> and goes <em>out</em> from there. A
<em>groupCount</em> step is then used to group the vertices we visited by a count of the
number of runways each has. We then go <em>out</em> again and count how many vertices we
found and save that result in the variable <em>b</em>. Note that the <em>groupCount</em> when used
in this way did not pass anything on to the following step. Finally we use <em>select</em>
to return our two variables as the results of the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">groupCount</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span>
       <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">:</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">:</span><span class="tok-mi">17</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">:</span><span class="tok-mi">22</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">8</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">],</span><span class="tok-nl">b:</span><span class="tok-mi">5942</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the next section we will see another example of a <em>groupCount</em> step that uses a
traversal variable.</p>
</div>
</div>
<div class="sect3">
<h4 id="gcconstant">5.1.14. Combining <em>groupCount</em> and <em>constant</em></h4>
<div class="paragraph">
<p>You can use a <em>constant</em> value in combination with a <em>groupCount</em> step as one way of
setting the name of the key that will be used in the result. The example below shows
a <em>groupCount</em> step that is provided a traversal variable <em>"a"</em> as a parameter and a
constant as part of the <em>by</em> modulator. The query starts by finding any airports in
the US state of Oklahoma. A <em>constant</em> step is used to tell the <em>groupCount</em> step
what to use as the key name in the result. At the end of the query a <em>cap</em> step is
used to close and return the contents of <em>"a"</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-OK'</span><span class="tok-o">).</span><span class="tok-na">groupCount</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'OK'</span><span class="tok-o">)).</span><span class="tok-na">cap</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we run the query, here is what we will get back. Notice the key is our constant
value <em>"OK"</em> and the value is the number of airports found in Oklahoma.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">OK:</span><span class="tok-mi">4</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above is intended purely to demonstrate the fact that you can use a
<em>constant</em> value with <em>groupCount</em>. However, for this specific example, you would
probably code a query something like the one below instead.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-OK'</span><span class="tok-o">).</span><span class="tok-na">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-nl">OK:</span><span class="tok-mi">4</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="chainchoose">5.1.15. Combining <em>choose</em> and <em>groupCount</em></h4>
<div class="paragraph">
<p>Using the ideas discussed above, we can write a query that chains several
<em>choose</em> steps together to build a result set made up of various key:value pairs
representing different things that we are interested in counting. The query below
looks at all vertices that represent an airport. For each vertex found, various
properties are examined using a <em>choose</em> step. If the test returns <em>true</em> a count,
stored in the traversal variable "<em>a"</em> is incremented. Note how each of the choose
steps is <em>dot chained</em> together. When used in this way <em>choose</em> behaves in the same
way as a <em>sideEffect</em> in that all of the airport vertices are passed to the next
choose rather than just those that pass the <em>if</em> test.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">choose</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">),</span> <span class="tok-n">groupCount</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'four'</span><span class="tok-o">))).</span>
      <span class="tok-n">choose</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-n">lte</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">)),</span> <span class="tok-n">groupCount</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'low'</span><span class="tok-o">))).</span>
      <span class="tok-n">choose</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-n">gte</span><span class="tok-o">(</span><span class="tok-mi">6</span><span class="tok-o">)),</span> <span class="tok-n">groupCount</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'high'</span><span class="tok-o">))).</span>
      <span class="tok-n">choose</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'FR'</span><span class="tok-o">),</span> <span class="tok-n">groupCount</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'France'</span><span class="tok-o">))).</span>
      <span class="tok-n">groupCount</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-s1">'total'</span><span class="tok-o">)).</span><span class="tok-na">cap</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we run the query this is what we might get back. We counted 3375 total airports,
found six airports that have six or more runways, 3079 that have two or fewer and
found 58 airports in France.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">total:</span><span class="tok-mi">3374</span><span class="tok-o">,</span><span class="tok-nl">high:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">low:</span><span class="tok-mi">3078</span><span class="tok-o">,</span><span class="tok-nl">four:</span><span class="tok-mi">51</span><span class="tok-o">,</span><span class="tok-nl">France:</span><span class="tok-mi">58</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using <em>choose</em> and <em>groupCount</em> in this way provides a very nice pattern for counting
somewhat disparate things during a traversal.</p>
</div>
</div>
<div class="sect3">
<h4 id="nestedgroup">5.1.16. Nesting one <em>group</em> step inside another</h4>
<div class="paragraph">
<p>Many examples of both the <em>groupCount</em> and <em>group</em> steps have already been presented
in this book. However, something I have not touched on so far, which by now may be
obvious but perhaps not, is that you can nest one <em>group</em> step inside another one.
This is made possible by the fact that the <em>by</em> modulators that are used to tell the
<em>group</em> step precisely what you want grouped can take arbitrary traversals. Take a
look at the example below. Hopefully the indentation makes it easier to read. We
begin by simply finding five airports and starting a group. The key for each group
will be one of the codes for each of these airports. This is specified by the first
<em>by</em> modulator. For the value part of each group, specified by the second <em>by</em>
modulator, we start a second traversal. That traversal begins by finding five places
you can fly to from each of the five airports that we initially found. Then another
<em>group</em> step is used to group each of those airports by the number of total outgoing
routes they have.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s2">"airport"</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s2">"route"</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span>
           <span class="tok-n">group</span><span class="tok-o">().</span>
             <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
             <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s2">"route"</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When the query is run here is what we get back. As expected the outer group has keys
that represent the first five airports that were found. The inner group has the five
airport destinations as the keys and their total outgoing route counts as their
values. I pretty printed the output a bit to make it easier to read.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">BNA:</span><span class="tok-o">[</span><span class="tok-nl">DCA:</span><span class="tok-mi">93</span><span class="tok-o">,</span><span class="tok-nl">DFW:</span><span class="tok-mi">221</span><span class="tok-o">,</span><span class="tok-nl">BWI:</span><span class="tok-mi">89</span><span class="tok-o">,</span><span class="tok-nl">FLL:</span><span class="tok-mi">142</span><span class="tok-o">,</span><span class="tok-nl">IAD:</span><span class="tok-mi">136</span><span class="tok-o">],</span>
 <span class="tok-nl">ANC:</span><span class="tok-o">[</span><span class="tok-nl">IAH:</span><span class="tok-mi">192</span><span class="tok-o">,</span><span class="tok-nl">LAX:</span><span class="tok-mi">195</span><span class="tok-o">,</span><span class="tok-nl">DFW:</span><span class="tok-mi">221</span><span class="tok-o">,</span><span class="tok-nl">PDX:</span><span class="tok-mi">76</span><span class="tok-o">,</span><span class="tok-nl">FAI:</span><span class="tok-mi">19</span><span class="tok-o">],</span>
 <span class="tok-nl">BOS:</span><span class="tok-o">[</span><span class="tok-nl">YVR:</span><span class="tok-mi">94</span><span class="tok-o">,</span><span class="tok-nl">LHR:</span><span class="tok-mi">191</span><span class="tok-o">,</span><span class="tok-nl">CDG:</span><span class="tok-mi">262</span><span class="tok-o">,</span><span class="tok-nl">YYZ:</span><span class="tok-mi">181</span><span class="tok-o">,</span><span class="tok-nl">LGW:</span><span class="tok-mi">200</span><span class="tok-o">],</span>
 <span class="tok-nl">ATL:</span><span class="tok-o">[</span><span class="tok-nl">MEI:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">MLB:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">MSL:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">MCN:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">MBS:</span><span class="tok-mi">4</span><span class="tok-o">],</span>
 <span class="tok-nl">AUS:</span><span class="tok-o">[</span><span class="tok-nl">MEX:</span><span class="tok-mi">105</span><span class="tok-o">,</span><span class="tok-nl">FRA:</span><span class="tok-mi">272</span><span class="tok-o">,</span><span class="tok-nl">LHR:</span><span class="tok-mi">191</span><span class="tok-o">,</span><span class="tok-nl">PIT:</span><span class="tok-mi">54</span><span class="tok-o">,</span><span class="tok-nl">YYZ:</span><span class="tok-mi">181</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So what we have created is a group, essentially a map, that has airport codes as the
key and an additional group as the values. Therefore, given each group is made up of
key value pairs, we can use a <em>select</em> step to only pick a few of the results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s2">"airport"</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s2">"route"</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span>
           <span class="tok-n">group</span><span class="tok-o">().</span>
             <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
             <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s2">"route"</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">())).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'ANC'</span><span class="tok-o">,</span><span class="tok-s1">'ATL'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This time only the selected results are returned</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">ANC:</span><span class="tok-o">[</span><span class="tok-nl">IAH:</span><span class="tok-mi">192</span><span class="tok-o">,</span><span class="tok-nl">LAX:</span><span class="tok-mi">195</span><span class="tok-o">,</span><span class="tok-nl">DFW:</span><span class="tok-mi">221</span><span class="tok-o">,</span><span class="tok-nl">PDX:</span><span class="tok-mi">76</span><span class="tok-o">,</span><span class="tok-nl">FAI:</span><span class="tok-mi">19</span><span class="tok-o">],</span>
 <span class="tok-nl">ATL:</span><span class="tok-o">[</span><span class="tok-nl">MEI:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">MLB:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">MSL:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">MCN:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">MBS:</span><span class="tok-mi">4</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to select results from one of the inner groups you can do that as well
using an additional <em>select</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s2">"airport"</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s2">"route"</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span>
           <span class="tok-n">group</span><span class="tok-o">().</span>
             <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
             <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s2">"route"</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">())).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'ANC'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'IAH'</span><span class="tok-o">,</span><span class="tok-s1">'LAX'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will first select the result with a key of <em>ANC</em> and then from that group select
the results for the keys of <em>IAH</em> and <em>LAX</em> only.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">IAH:</span><span class="tok-mi">192</span><span class="tok-o">,</span><span class="tok-nl">LAX:</span><span class="tok-mi">195</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="eu-usa">5.1.17. Analysis of routes between Europe and the USA</h4>
<div class="paragraph">
<p>The next few queries show how you can use a graph like <em>air-routes</em> to perform
analysis on a particular industry segment. The following queries analyze the
distribution and availability of routes between airports across Europe and airports
in the United States. First of all let’s just find out how many total routes there are
between airports anywhere in Europe and airports in the USA.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// How many routes from anywhere in Europe to the USA?</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'continent'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'EU'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'US'</span><span class="tok-o">).</span>
      <span class="tok-n">count</span><span class="tok-o">()</span>

<span class="tok-mi">351</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So we now know that there are 345 different routes. Remember though that the
<em>air-routes</em> graph does not track the number of airlines that operate any of these
routes. The graph just stores the data that at least one airline operates each of
these unique route pairs. Let’s dig a bit deeper into the 345 and find out how many
US airports have flights that arrive from Europe.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// How many different US airports have routes from Europe?</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'continent'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'EU'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'US'</span><span class="tok-o">).</span>
      <span class="tok-n">dedup</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">38</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So we can now see that the 345 routes from European airports arrive at one of 38
airports in the United States. We can dig a bit deeper and look at the distribution
of these routes across the 38 airports.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">//What is the distribution of the routes amongst those US airports?</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'continent'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'EU'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'US'</span><span class="tok-o">).</span>
      <span class="tok-n">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
      <span class="tok-n">order</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">,</span><span class="tok-n">asc</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>John F. Kennedy airport (JFK) in New York appears to have the most routes from Europe
with Newark (EWR) having the second most.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">PHX:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">CVG:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">RSW:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BDL:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">SJC:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">BWI:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">AUS:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">RDU:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">MSY:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">SAN:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">SLC:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">PDX:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">PIT:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">TPA:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">SFB:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">OAK:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">DTW:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">SWF:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">MSP:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">DEN:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">FLL:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">CLT:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">DFW:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">PVD:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">SEA:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">IAH:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">MCO:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">LAS:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">ATL:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-nl">SFO:</span><span class="tok-mi">15</span><span class="tok-o">,</span><span class="tok-nl">PHL:</span><span class="tok-mi">17</span><span class="tok-o">,</span><span class="tok-nl">IAD:</span><span class="tok-mi">19</span><span class="tok-o">,</span><span class="tok-nl">ORD:</span><span class="tok-mi">21</span><span class="tok-o">,</span><span class="tok-nl">BOS:</span><span class="tok-mi">22</span><span class="tok-o">,</span><span class="tok-nl">LAX:</span><span class="tok-mi">23</span><span class="tok-o">,</span><span class="tok-nl">MIA:</span><span class="tok-mi">25</span><span class="tok-o">,</span><span class="tok-nl">EWR:</span><span class="tok-mi">33</span><span class="tok-o">,</span><span class="tok-nl">JFK:</span><span class="tok-mi">40</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let’s repeat the process but looking at the European end of the routes. First of
all, we can calculate how many European airports have flights to the United States.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// How many European airports have service to the USA?</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'continent'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'EU'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'US'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">dedup</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">53</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Just as we did for the airports in the US we can figure out the distribution of
routes for the European airports.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// What is the distribution of US routes amongst</span>
<span class="tok-c1">// the European airports?</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'continent'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'EU'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'US'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
      <span class="tok-n">order</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">,</span><span class="tok-n">asc</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It appears that London Heathrow (LHR) offers the
most US destinations and Frankfurt (FRA) the second most.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">RIX:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">TER:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BRS:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">STN:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">NCE:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">KRK:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">ORK:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">KBP:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">PDL:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">DME:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">BEG:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">AGP:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">HAM:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">OPO:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">STR:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">VCE:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">BHX:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">ORY:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">ATH:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">MXP:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">BFS:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">BGO:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">GVA:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">VKO:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">HEL:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">WAW:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">SVO:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">GLA:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">EDI:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">SNN:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">CGN:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">TXL:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">VIE:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">LIS:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-nl">BRU:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">ARN:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-nl">OSL:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-nl">IST:</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-nl">BCN:</span><span class="tok-mi">10</span><span class="tok-o">,</span><span class="tok-nl">MAD:</span><span class="tok-mi">11</span><span class="tok-o">,</span><span class="tok-nl">LGW:</span><span class="tok-mi">11</span><span class="tok-o">,</span><span class="tok-nl">DUS:</span><span class="tok-mi">11</span><span class="tok-o">,</span><span class="tok-nl">CPH:</span><span class="tok-mi">11</span><span class="tok-o">,</span><span class="tok-nl">FCO:</span><span class="tok-mi">12</span><span class="tok-o">,</span><span class="tok-nl">ZRH:</span><span class="tok-mi">13</span><span class="tok-o">,</span><span class="tok-nl">MAN:</span><span class="tok-mi">13</span><span class="tok-o">,</span><span class="tok-nl">DUB:</span><span class="tok-mi">15</span><span class="tok-o">,</span><span class="tok-nl">MUC:</span><span class="tok-mi">16</span><span class="tok-o">,</span><span class="tok-nl">AMS:</span><span class="tok-mi">18</span><span class="tok-o">,</span><span class="tok-nl">KEF:</span><span class="tok-mi">18</span><span class="tok-o">,</span><span class="tok-nl">CDG:</span><span class="tok-mi">22</span><span class="tok-o">,</span><span class="tok-nl">FRA:</span><span class="tok-mi">24</span><span class="tok-o">,</span><span class="tok-nl">LHR:</span><span class="tok-mi">27</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lastly, we can find out what the list of routes flown is. For this example I decided
to just return 10 of the 345 routes. Note how the <em>path</em> step returns all parts of
the traversal including the continent code <em>EU</em>. We could remove that part of the
result by adding a <em>from</em> modulator as shown earlier in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#pathintro">What vertices and edges did I visit? - Introducing <em>path</em></a>" section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Selected routes from Europe to the USA.</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'continent'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'EU'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'US'</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
      <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The first 10 results returned feature routes from Warsaw, Belgrade and Istanbul.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">EU</span><span class="tok-o">,</span><span class="tok-n">WAW</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EU</span><span class="tok-o">,</span><span class="tok-n">WAW</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EU</span><span class="tok-o">,</span><span class="tok-n">WAW</span><span class="tok-o">,</span><span class="tok-n">ORD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EU</span><span class="tok-o">,</span><span class="tok-n">WAW</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EU</span><span class="tok-o">,</span><span class="tok-n">BEG</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EU</span><span class="tok-o">,</span><span class="tok-n">IST</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EU</span><span class="tok-o">,</span><span class="tok-n">IST</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EU</span><span class="tok-o">,</span><span class="tok-n">IST</span><span class="tok-o">,</span><span class="tok-n">IAD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EU</span><span class="tok-o">,</span><span class="tok-n">IST</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EU</span><span class="tok-o">,</span><span class="tok-n">IST</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapreduce">5.1.18. Using <em>fold</em> to do simple Map-Reduce computations</h4>
<div class="paragraph">
<p>Earlier in the book we saw examples of <em>sum</em> being used to count a
collection of values. You can also use <em>fold</em> to do something similar but in a
more <em>map-reduce</em> type of fashion.</p>
</div>
<div class="paragraph">
<p>First of all, here is a query that uses <em>fold</em> in a way that we have already seen. It
will find all routes from Austin and uses a <em>fold</em> step to return a list of those
names.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span>
      <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As expected the results show all of the cities that you can fly to from Austin
collected into a single list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">Toronto</span><span class="tok-o">,</span><span class="tok-n">London</span><span class="tok-o">,</span><span class="tok-n">Frankfurt</span><span class="tok-o">,</span><span class="tok-n">Mexico</span> <span class="tok-n">City</span><span class="tok-o">,</span><span class="tok-n">Pittsburgh</span><span class="tok-o">,</span><span class="tok-n">Portland</span><span class="tok-o">,</span><span class="tok-n">Charlotte</span><span class="tok-o">,</span><span class="tok-n">Cancun</span><span class="tok-o">,</span><span class="tok-n">Memphis</span><span class="tok-o">,</span><span class="tok-n">Cincinnati</span><span class="tok-o">,</span><span class="tok-n">Indianapolis</span><span class="tok-o">,</span><span class="tok-n">Kansas</span> <span class="tok-n">City</span><span class="tok-o">,</span><span class="tok-n">Dallas</span><span class="tok-o">,</span><span class="tok-n">St</span> <span class="tok-n">Louis</span><span class="tok-o">,</span><span class="tok-n">Albuquerque</span><span class="tok-o">,</span><span class="tok-n">Chicago</span><span class="tok-o">,</span><span class="tok-n">Lubbock</span><span class="tok-o">,</span><span class="tok-n">Harlingen</span><span class="tok-o">,</span><span class="tok-n">Guadalajara</span><span class="tok-o">,</span><span class="tok-n">Pensacola</span><span class="tok-o">,</span><span class="tok-n">Valparaiso</span><span class="tok-o">,</span><span class="tok-n">Orlando</span><span class="tok-o">,</span><span class="tok-n">Branson</span><span class="tok-o">,</span><span class="tok-n">St</span> <span class="tok-n">Petersburg</span><span class="tok-o">-</span><span class="tok-n">Clearwater</span><span class="tok-o">,</span><span class="tok-n">Atlanta</span><span class="tok-o">,</span><span class="tok-n">Nashville</span><span class="tok-o">,</span><span class="tok-n">Boston</span><span class="tok-o">,</span><span class="tok-n">Baltimore</span><span class="tok-o">,</span><span class="tok-n">Washington</span> <span class="tok-n">D</span><span class="tok-o">.</span><span class="tok-na">C</span><span class="tok-o">.,</span><span class="tok-n">Dallas</span><span class="tok-o">,</span><span class="tok-n">Fort</span> <span class="tok-n">Lauderdale</span><span class="tok-o">,</span><span class="tok-n">Washington</span> <span class="tok-n">D</span><span class="tok-o">.</span><span class="tok-na">C</span><span class="tok-o">.,</span><span class="tok-n">Houston</span><span class="tok-o">,</span><span class="tok-n">New</span> <span class="tok-n">York</span><span class="tok-o">,</span><span class="tok-n">Los</span> <span class="tok-n">Angeles</span><span class="tok-o">,</span><span class="tok-n">Orlando</span><span class="tok-o">,</span><span class="tok-n">Miami</span><span class="tok-o">,</span><span class="tok-n">Minneapolis</span><span class="tok-o">,</span><span class="tok-n">Chicago</span><span class="tok-o">,</span><span class="tok-n">Phoenix</span><span class="tok-o">,</span><span class="tok-n">Raleigh</span><span class="tok-o">,</span><span class="tok-n">Seattle</span><span class="tok-o">,</span><span class="tok-n">San</span> <span class="tok-n">Francisco</span><span class="tok-o">,</span><span class="tok-n">San</span> <span class="tok-n">Jose</span><span class="tok-o">,</span><span class="tok-n">Tampa</span><span class="tok-o">,</span><span class="tok-n">San</span> <span class="tok-n">Diego</span><span class="tok-o">,</span><span class="tok-n">Long</span> <span class="tok-n">Beach</span><span class="tok-o">,</span><span class="tok-n">Santa</span> <span class="tok-n">Ana</span><span class="tok-o">,</span><span class="tok-n">Salt</span> <span class="tok-n">Lake</span> <span class="tok-n">City</span><span class="tok-o">,</span><span class="tok-n">Las</span> <span class="tok-n">Vegas</span><span class="tok-o">,</span><span class="tok-n">Denver</span><span class="tok-o">,</span><span class="tok-n">New</span> <span class="tok-n">Orleans</span><span class="tok-o">,</span><span class="tok-n">Newark</span><span class="tok-o">,</span><span class="tok-n">Houston</span><span class="tok-o">,</span><span class="tok-n">El</span> <span class="tok-n">Paso</span><span class="tok-o">,</span><span class="tok-n">Cleveland</span><span class="tok-o">,</span><span class="tok-n">Oakland</span><span class="tok-o">,</span><span class="tok-n">Philadelphia</span><span class="tok-o">,</span><span class="tok-n">Detroit</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, what if we wanted to reduce our results further? Take a look at the modified
version of our query below. It finds all routes from Austin and looks at the names of
the destination cities. However, rather than return all the names, this time the
<em>fold</em> step is used differently and effectively reduces the city names to a single
value. That value being the total number of characters in all of those city names. We
have seen <em>fold</em> used elsewhere in the book but this time we provide <em>fold</em> with a
parameter and a closure. The parameter is passed to the closure as the first variable
and the name of the city as the second. The closure then adds the zero and the length
of each name effectively producing a running total.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span>
      <span class="tok-n">fold</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">)</span> <span class="tok-o">{</span><span class="tok-n">a</span><span class="tok-o">,</span><span class="tok-n">b</span> <span class="tok-o">-&gt;</span> <span class="tok-n">a</span> <span class="tok-o">+</span> <span class="tok-n">b</span><span class="tok-o">.</span><span class="tok-na">length</span><span class="tok-o">()}</span>

<span class="tok-mi">530</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
While this query will work as-is on TinkerGraph within the Gremlin Console,
some graph systems are more strict about their type checking and sandboxing of Groovy
closures. To be on the safe side you can always explicitly type cast the closure as
follows.
</td>
</tr>
</tbody></table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span>
                       <span class="tok-n">fold</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">)</span> <span class="tok-o">{</span><span class="tok-n">a</span><span class="tok-o">,</span><span class="tok-n">b</span> <span class="tok-o">-&gt;</span> <span class="tok-o">(</span><span class="tok-kt">int</span><span class="tok-o">)</span><span class="tok-n">a</span> <span class="tok-o">+</span> <span class="tok-o">((</span><span class="tok-n">String</span><span class="tok-o">)</span><span class="tok-n">b</span><span class="tok-o">).</span><span class="tok-na">length</span><span class="tok-o">()}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="meanmode">5.1.19. Distribution of routes in the graph (mode and mean)</h4>
<div class="paragraph">
<p>An example of a common question we might want to answer with a network graph, of
which air routes are an example, is "how are the routes in my graph distributed
between airport vertices?". We can also use this same query to find the statistical
<em>mode</em> (most common number) for a set of routes.</p>
</div>
<div class="paragraph">
<p>Take a look at the next query that shows how we can do analysis on the distribution
of routes throughout the graph. We are only interested in vertices that are airports and
for those vertices we want to count how many outgoing routes each airport has. We want
to return the results as a set of ordered <em>key:value</em> pairs where the key is the
number of outgoing routes and the value is the number of airports that have that
number of outgoing routes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()).</span>
      <span class="tok-n">order</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">,</span><span class="tok-n">desc</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When we run the query we get back the results below. As the results are sorted in
descending order by value, we can see that the <em>mode</em> (most common) number of
outgoing routes is actually just one route and that 786 airports have just one
outgoing route. We can see that 654 airports have just two routes and so on. We can
also see at the other end of the scale that one airport has 237 outgoing routes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">:</span><span class="tok-mi">770</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">:</span><span class="tok-mi">654</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">:</span><span class="tok-mi">369</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">:</span><span class="tok-mi">234</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">:</span><span class="tok-mi">148</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">:</span><span class="tok-mi">116</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">:</span><span class="tok-mi">93</span><span class="tok-o">,</span><span class="tok-mi">8</span><span class="tok-o">:</span><span class="tok-mi">81</span><span class="tok-o">,</span><span class="tok-mi">9</span><span class="tok-o">:</span><span class="tok-mi">68</span><span class="tok-o">,</span><span class="tok-mi">10</span><span class="tok-o">:</span><span class="tok-mi">61</span><span class="tok-o">,</span><span class="tok-mi">12</span><span class="tok-o">:</span><span class="tok-mi">43</span><span class="tok-o">,</span><span class="tok-mi">11</span><span class="tok-o">:</span><span class="tok-mi">39</span><span class="tok-o">,</span><span class="tok-mi">13</span><span class="tok-o">:</span><span class="tok-mi">39</span><span class="tok-o">,</span><span class="tok-mi">15</span><span class="tok-o">:</span><span class="tok-mi">31</span><span class="tok-o">,</span><span class="tok-mi">16</span><span class="tok-o">:</span><span class="tok-mi">27</span><span class="tok-o">,</span><span class="tok-mi">19</span><span class="tok-o">:</span><span class="tok-mi">25</span><span class="tok-o">,</span><span class="tok-mi">20</span><span class="tok-o">:</span><span class="tok-mi">25</span><span class="tok-o">,</span><span class="tok-mi">22</span><span class="tok-o">:</span><span class="tok-mi">25</span><span class="tok-o">,</span><span class="tok-mi">14</span><span class="tok-o">:</span><span class="tok-mi">19</span><span class="tok-o">,</span><span class="tok-mi">18</span><span class="tok-o">:</span><span class="tok-mi">18</span><span class="tok-o">,</span><span class="tok-mi">0</span><span class="tok-o">:</span><span class="tok-mi">16</span><span class="tok-o">,</span><span class="tok-mi">17</span><span class="tok-o">:</span><span class="tok-mi">15</span><span class="tok-o">,</span><span class="tok-mi">33</span><span class="tok-o">:</span><span class="tok-mi">15</span><span class="tok-o">,</span><span class="tok-mi">23</span><span class="tok-o">:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-mi">30</span><span class="tok-o">:</span><span class="tok-mi">13</span><span class="tok-o">,</span><span class="tok-mi">31</span><span class="tok-o">:</span><span class="tok-mi">13</span><span class="tok-o">,</span><span class="tok-mi">21</span><span class="tok-o">:</span><span class="tok-mi">12</span><span class="tok-o">,</span><span class="tok-mi">32</span><span class="tok-o">:</span><span class="tok-mi">12</span><span class="tok-o">,</span><span class="tok-mi">35</span><span class="tok-o">:</span><span class="tok-mi">11</span><span class="tok-o">,</span><span class="tok-mi">37</span><span class="tok-o">:</span><span class="tok-mi">11</span><span class="tok-o">,</span><span class="tok-mi">24</span><span class="tok-o">:</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-mi">25</span><span class="tok-o">:</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-mi">39</span><span class="tok-o">:</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-mi">26</span><span class="tok-o">:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">27</span><span class="tok-o">:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">36</span><span class="tok-o">:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">41</span><span class="tok-o">:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">42</span><span class="tok-o">:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">47</span><span class="tok-o">:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">59</span><span class="tok-o">:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">29</span><span class="tok-o">:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">34</span><span class="tok-o">:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">40</span><span class="tok-o">:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">44</span><span class="tok-o">:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">55</span><span class="tok-o">:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">63</span><span class="tok-o">:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">43</span><span class="tok-o">:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">48</span><span class="tok-o">:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">50</span><span class="tok-o">:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">67</span><span class="tok-o">:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">28</span><span class="tok-o">:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">45</span><span class="tok-o">:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">61</span><span class="tok-o">:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">62</span><span class="tok-o">:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">64</span><span class="tok-o">:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">94</span><span class="tok-o">:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">105</span><span class="tok-o">:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">52</span><span class="tok-o">:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">54</span><span class="tok-o">:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">68</span><span class="tok-o">:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">70</span><span class="tok-o">:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">80</span><span class="tok-o">:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">85</span><span class="tok-o">:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">38</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">51</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">53</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">56</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">60</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">74</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">76</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">83</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">84</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">93</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">104</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">106</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">107</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">46</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">57</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">58</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">65</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">73</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">77</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">78</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">79</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">82</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">86</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">91</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">95</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">97</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">98</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">109</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">116</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">118</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">124</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">143</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">144</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">145</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">182</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">192</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">232</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">262</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">269</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">270</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">272</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">49</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">66</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">69</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">71</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">72</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">75</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">81</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">89</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">90</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">92</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">101</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">102</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">108</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">110</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">112</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">113</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">114</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">115</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">119</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">122</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">123</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">126</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">127</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">129</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">130</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">132</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">133</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">136</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">137</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">141</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">142</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">146</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">151</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">152</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">156</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">162</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">163</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">164</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">165</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">166</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">168</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">171</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">180</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">181</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">186</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">187</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">188</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">189</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">190</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">191</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">195</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">200</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">201</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">214</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">221</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">229</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">234</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">237</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could change our query above, replacing <em>out()</em> with <em>__.in()</em> and we could find
out the distribution of incoming routes. Remembering that in an air route network
there is not always a one to one equivalent number of outgoing to incoming routes due
to the way airlines plan their routes.</p>
</div>
<div class="paragraph">
<p>Another change we could make to our query is to change the ordering to use the key
field for each key:value pair and this time sort in ascending order.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()).</span>
      <span class="tok-n">order</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">keys</span><span class="tok-o">,</span><span class="tok-n">asc</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When we run our query again we get the results below. Looking at the data sorted
this way helps some new interesting facts stand out. The most interesting thing
we can immediately spot is that there are 16 airports that currently have no
outgoing routes at all!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">:</span><span class="tok-mi">16</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">:</span><span class="tok-mi">770</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">:</span><span class="tok-mi">654</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">:</span><span class="tok-mi">369</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">:</span><span class="tok-mi">234</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">:</span><span class="tok-mi">148</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">:</span><span class="tok-mi">116</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">:</span><span class="tok-mi">93</span><span class="tok-o">,</span><span class="tok-mi">8</span><span class="tok-o">:</span><span class="tok-mi">81</span><span class="tok-o">,</span><span class="tok-mi">9</span><span class="tok-o">:</span><span class="tok-mi">68</span><span class="tok-o">,</span><span class="tok-mi">10</span><span class="tok-o">:</span><span class="tok-mi">61</span><span class="tok-o">,</span><span class="tok-mi">11</span><span class="tok-o">:</span><span class="tok-mi">39</span><span class="tok-o">,</span><span class="tok-mi">12</span><span class="tok-o">:</span><span class="tok-mi">43</span><span class="tok-o">,</span><span class="tok-mi">13</span><span class="tok-o">:</span><span class="tok-mi">39</span><span class="tok-o">,</span><span class="tok-mi">14</span><span class="tok-o">:</span><span class="tok-mi">19</span><span class="tok-o">,</span><span class="tok-mi">15</span><span class="tok-o">:</span><span class="tok-mi">31</span><span class="tok-o">,</span><span class="tok-mi">16</span><span class="tok-o">:</span><span class="tok-mi">27</span><span class="tok-o">,</span><span class="tok-mi">17</span><span class="tok-o">:</span><span class="tok-mi">15</span><span class="tok-o">,</span><span class="tok-mi">18</span><span class="tok-o">:</span><span class="tok-mi">18</span><span class="tok-o">,</span><span class="tok-mi">19</span><span class="tok-o">:</span><span class="tok-mi">25</span><span class="tok-o">,</span><span class="tok-mi">20</span><span class="tok-o">:</span><span class="tok-mi">25</span><span class="tok-o">,</span><span class="tok-mi">21</span><span class="tok-o">:</span><span class="tok-mi">12</span><span class="tok-o">,</span><span class="tok-mi">22</span><span class="tok-o">:</span><span class="tok-mi">25</span><span class="tok-o">,</span><span class="tok-mi">23</span><span class="tok-o">:</span><span class="tok-mi">14</span><span class="tok-o">,</span><span class="tok-mi">24</span><span class="tok-o">:</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-mi">25</span><span class="tok-o">:</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-mi">26</span><span class="tok-o">:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">27</span><span class="tok-o">:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">28</span><span class="tok-o">:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">29</span><span class="tok-o">:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">30</span><span class="tok-o">:</span><span class="tok-mi">13</span><span class="tok-o">,</span><span class="tok-mi">31</span><span class="tok-o">:</span><span class="tok-mi">13</span><span class="tok-o">,</span><span class="tok-mi">32</span><span class="tok-o">:</span><span class="tok-mi">12</span><span class="tok-o">,</span><span class="tok-mi">33</span><span class="tok-o">:</span><span class="tok-mi">15</span><span class="tok-o">,</span><span class="tok-mi">34</span><span class="tok-o">:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">35</span><span class="tok-o">:</span><span class="tok-mi">11</span><span class="tok-o">,</span><span class="tok-mi">36</span><span class="tok-o">:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">37</span><span class="tok-o">:</span><span class="tok-mi">11</span><span class="tok-o">,</span><span class="tok-mi">38</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">39</span><span class="tok-o">:</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-mi">40</span><span class="tok-o">:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">41</span><span class="tok-o">:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">42</span><span class="tok-o">:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">43</span><span class="tok-o">:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">44</span><span class="tok-o">:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">45</span><span class="tok-o">:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">46</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">47</span><span class="tok-o">:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">48</span><span class="tok-o">:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">49</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">50</span><span class="tok-o">:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">51</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">52</span><span class="tok-o">:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">53</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">54</span><span class="tok-o">:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">55</span><span class="tok-o">:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">56</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">57</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">58</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">59</span><span class="tok-o">:</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-mi">60</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">61</span><span class="tok-o">:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">62</span><span class="tok-o">:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">63</span><span class="tok-o">:</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">64</span><span class="tok-o">:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">65</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">66</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">67</span><span class="tok-o">:</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-mi">68</span><span class="tok-o">:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">69</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">70</span><span class="tok-o">:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">71</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">72</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">73</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">74</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">75</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">76</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">77</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">78</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">79</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">80</span><span class="tok-o">:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">81</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">82</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">83</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">84</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">85</span><span class="tok-o">:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">86</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">89</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">90</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">91</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">92</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">93</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">94</span><span class="tok-o">:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">95</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">97</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">98</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">101</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">102</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">104</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">105</span><span class="tok-o">:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">106</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">107</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">108</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">109</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">110</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">112</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">113</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">114</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">115</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">116</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">118</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">119</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">122</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">123</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">124</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">126</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">127</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">129</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">130</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">132</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">133</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">136</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">137</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">141</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">142</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">143</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">144</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">145</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">146</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">151</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">152</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">156</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">162</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">163</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">164</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">165</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">166</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">168</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">171</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">180</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">181</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">182</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">186</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">187</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">188</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">189</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">190</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">191</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">192</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">195</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">200</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">201</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">214</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">221</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">229</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">232</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">234</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">237</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">262</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">269</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">270</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">272</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we wanted to find the statistical mean number of routes in the graph we could
easily write a query like the one below to tell us how many airports and
outgoing routes in total there are in the graph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">union</span><span class="tok-o">(</span><span class="tok-n">count</span><span class="tok-o">(),</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">fold</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-mi">3374</span><span class="tok-o">,</span><span class="tok-mi">43400</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could then use the Gremlin Console do the division for us to calculate the mean.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-mi">43400</span><span class="tok-o">/</span><span class="tok-mi">3374</span>

<span class="tok-o">==&gt;</span><span class="tok-mf">12.8630705394</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, Gremlin also has a <em>mean</em> step that we can take advantage of if we can
figure out a way to use it in this case that will do the work for us. Take a look at
the next query. The key thing to note here is the way <em>local</em> has been used. This
will cause Gremlin to essentially do what we did a bit more manually above. If we did
not include <em>local</em> the answer would just be the total number of outgoing routes as
Gremlin would essentially calculate 43400/1. By using local we force Gremlin to in
essence create an array containing the number of routes for each airport, add those
values up and divide by the number of elements in the array (the number of airports).
I hope that makes sense. If it is confusing try the query yourself on the gremlin
console with and without local and try it without the <em>mean</em> step. You will see all
of the interim values instead!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">local</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">mean</span><span class="tok-o">()</span>

<span class="tok-mf">12.863070539419088</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So it seems there is an average of just over 12 outgoing routes per airport in
the graph whichever way we decide to calculate it!</p>
</div>
<div class="paragraph">
<p>Now that we have a query figured out for calculating the average number of
outgoing routes per airport, we can easily tweak it to do the same for incoming
routes and combined, incoming and outgoing, routes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Average number of incoming routes</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'type'</span><span class="tok-o">,</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">local</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">in</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">mean</span><span class="tok-o">()</span>

<span class="tok-mf">12.863070539419088</span>

<span class="tok-c1">// Average number of outgoing and incoming routes</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'type'</span><span class="tok-o">,</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">local</span><span class="tok-o">(</span><span class="tok-n">both</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">mean</span><span class="tok-o">()</span>

<span class="tok-mf">25.726141078838175</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_how_many_routes_are_there_from_airports_in_london_uk">5.1.20. How many routes are there from airports in London (UK)?</h4>
<div class="paragraph">
<p>This next query can be used to figure out how many outgoing routes each of the
airports classified as being in (or near) London, England has. Note that we
first find all airports in England using <em>has('region</em>,<em>GB-ENG</em>)'. If we did
not do this we would pick up airports in other countries as well such as
London, Ontario, in Canada.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'GB-ENG'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'London'</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">())</span>

<span class="tok-o">[</span><span class="tok-nl">LCY:</span><span class="tok-mi">42</span><span class="tok-o">,</span><span class="tok-nl">LHR:</span><span class="tok-mi">191</span><span class="tok-o">,</span><span class="tok-nl">LTN:</span><span class="tok-mi">104</span><span class="tok-o">,</span><span class="tok-nl">STN:</span><span class="tok-mi">186</span><span class="tok-o">,</span><span class="tok-nl">LGW:</span><span class="tok-mi">200</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is a twist on the above theme. How many places can I get to from London in two
hops but not including flights that end up back in London? It turns out there are
over 2,000 places!  Notice how <em>aggregate</em> is used to store the set of London
airports as a collection that can be referenced later on in the query to help with
ruling out any flights that would end up back in London.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Leave from London, fly with one stop, not ending back in London, how many places?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'GB-ENG'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'London'</span><span class="tok-o">).</span><span class="tok-na">aggregate</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">dedup</span><span class="tok-o">().</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">without</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">)).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">2236</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could have written the previous query like this and avoided using <em>aggregate</em> but
to me, this feels more clumsy and somewhat repetitive.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'GB-ENG'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'London'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">dedup</span><span class="tok-o">().</span>
      <span class="tok-n">not</span><span class="tok-o">(</span><span class="tok-n">and</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'London'</span><span class="tok-o">),</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'GB-ENG'</span><span class="tok-o">))).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">2236</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="englandroutes">5.1.21. How many routes are there between airports in England?</h4>
<div class="paragraph">
<p>We can use an <em>aggregate</em> step to quite elegantly find the routes that exist between
airports located in England. The following query finds all airports in England and
orders them by airport code. It then collects those airports using an <em>aggregate</em>
step. Finally the aggregated collection is used to find routes to airports also
within the UK. Note that as written, this query finds routes in both directions if
they exist.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Flights within England</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'GB-ENG'</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">aggregate</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">)).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the routes found when the query is run. I arranged the results into columns
to save space.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">BHX</span><span class="tok-o">,</span><span class="tok-n">NCL</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">LBA</span><span class="tok-o">,</span><span class="tok-n">SOU</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">NQY</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">NQY</span><span class="tok-o">,</span><span class="tok-n">ISC</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">BRS</span><span class="tok-o">,</span><span class="tok-n">NCL</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">LBA</span><span class="tok-o">,</span><span class="tok-n">NQY</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">NWI</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">NQY</span><span class="tok-o">,</span><span class="tok-n">LGW</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EMA</span><span class="tok-o">,</span><span class="tok-n">SOU</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">LCY</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">EXT</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">NQY</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EXT</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">LEQ</span><span class="tok-o">,</span><span class="tok-n">ISC</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">NQY</span><span class="tok-o">,</span><span class="tok-n">LPL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EXT</span><span class="tok-o">,</span><span class="tok-n">NQY</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span><span class="tok-n">NQY</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">LCY</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">NQY</span><span class="tok-o">,</span><span class="tok-n">LBA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EXT</span><span class="tok-o">,</span><span class="tok-n">ISC</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span><span class="tok-n">NCL</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">NCL</span><span class="tok-o">,</span><span class="tok-n">SOU</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">NWI</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">HUY</span><span class="tok-o">,</span><span class="tok-n">NWI</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">NCL</span><span class="tok-o">,</span><span class="tok-n">BRS</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">NWI</span><span class="tok-o">,</span><span class="tok-n">HUY</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">ISC</span><span class="tok-o">,</span><span class="tok-n">NQY</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">LBA</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">NCL</span><span class="tok-o">,</span><span class="tok-n">BHX</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">SOU</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">ISC</span><span class="tok-o">,</span><span class="tok-n">EXT</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">NCL</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">NCL</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">SOU</span><span class="tok-o">,</span><span class="tok-n">EMA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">ISC</span><span class="tok-o">,</span><span class="tok-n">LEQ</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">LPL</span><span class="tok-o">,</span><span class="tok-n">NQY</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">NCL</span><span class="tok-o">,</span><span class="tok-n">LGW</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">SOU</span><span class="tok-o">,</span><span class="tok-n">LBA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LBA</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">SOU</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">NQY</span><span class="tok-o">,</span><span class="tok-n">EXT</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">SOU</span><span class="tok-o">,</span><span class="tok-n">NCL</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is a different way the query can be written. This time a <em>where</em> step is used to
filter out the previously seen airport pairs so we only get routes in one direction.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'GB-ENG'</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'GB-ENG'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-n">lt</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">)).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see this time we only get each airport pair back once regardless of route
direction.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">BHX</span><span class="tok-o">,</span><span class="tok-n">NCL</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">LBA</span><span class="tok-o">,</span><span class="tok-n">NQY</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">BRS</span><span class="tok-o">,</span><span class="tok-n">NCL</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">LCY</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EMA</span><span class="tok-o">,</span><span class="tok-n">SOU</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span><span class="tok-n">NQY</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EXT</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span><span class="tok-n">NCL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EXT</span><span class="tok-o">,</span><span class="tok-n">NQY</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EXT</span><span class="tok-o">,</span><span class="tok-n">ISC</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">NCL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">HUY</span><span class="tok-o">,</span><span class="tok-n">NWI</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">LPL</span><span class="tok-o">,</span><span class="tok-n">NQY</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">ISC</span><span class="tok-o">,</span><span class="tok-n">NQY</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">SOU</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">ISC</span><span class="tok-o">,</span><span class="tok-n">LEQ</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">NQY</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LBA</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">NWI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LBA</span><span class="tok-o">,</span><span class="tok-n">SOU</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">NCL</span><span class="tok-o">,</span><span class="tok-n">SOU</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="topten">5.1.22. What are the top ten airports by route count?</h4>
<div class="paragraph">
<p>Earlier we calculated which airports have the most routes. These next three queries
are of a similar nature but produce a tables of the top ten airports in terms of
incoming, outgoing and overall routes. As mentioned before, because of the way some airlines
route flights, the number of outgoing and incoming routes to an airport will not
always be the same. For example, several KLM Airlines flights from Amsterdam to
airports in Africa continue on to other African airports before returning to
Amsterdam. As a result there are more inbound routes from than out bound routes to
these airports. In each example below the <em>project</em> step is used to generate the
results in a easily readable form.</p>
</div>
<div class="paragraph">
<p>First of all, this query will find the ten airports with the most incoming routes,
sorted in descending order.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Find the top ten overall in terms of incoming routes</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">in</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">(),</span><span class="tok-n">desc</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'ap'</span><span class="tok-o">,</span><span class="tok-s1">'routes'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">in</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So it seems that Frankfurt and Amsterdam are tied for the most incoming routes. It is
worth remembering that the version of the graph used for the examples in the book
represents a moment in time. If these queries are re run at a later date on a newer
version of the graph the results will quite likely be different. This is because
airlines regularly add, and in some cases drop, routes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">272</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">AMS</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">272</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">IST</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">270</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">CDG</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">262</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">MUC</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">237</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">PEK</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">235</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">232</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">ORD</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">232</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">229</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">221</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let’s do the same thing but for outgoing routes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Find the top ten overall in terms of outgoing routes</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">(),</span><span class="tok-n">desc</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'ap'</span><span class="tok-o">,</span><span class="tok-s1">'routes'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This time Frankfurt has the most routes. This reinforces a point that I made earlier.
The number of incoming and outgoing routes for a given airport will not always be the
same. This is because of the way airlines route flights. Some flights continue to
other destinations before returning so there will not always be direct flights
between airport pairs in both directions. I know as a passenger this is something
that I find frustrating!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">272</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">IST</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">270</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">AMS</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">269</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">CDG</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">262</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">MUC</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">237</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">PEK</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">234</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">232</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">ORD</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">232</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">229</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">221</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lastly, let’s find the top ten airports ordered by the total number of incoming and
outgoing routes that they have.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Find the top ten overall in terms of total routes</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">both</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">(),</span><span class="tok-n">desc</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'ap'</span><span class="tok-o">,</span><span class="tok-s1">'routes'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">both</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As expected, Frankfurt is the airport with the most overall routes. One small
side note while on the topic of airline routes. The graph does not track the frequency
at which any given route is operated. What this means is that the airport with the
most routes is not necessarily also the busiest. This is because many routes are
operated multiple times a day. I did not try to include this data in the graph as it
changes too often for me to keep up with.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">544</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">AMS</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">541</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">IST</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">540</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">CDG</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">524</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">MUC</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">474</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">PEK</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">469</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">464</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">ORD</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">464</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">458</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">ap:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">442</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="localfold">5.1.23. Using <em>local</em> while counting things</h4>
<div class="paragraph">
<p>In some of the earlier sections we saw examples of <em>local</em> scope being used. Here is
another example of how <em>local</em> scope can be used while counting things to achieve a
desired result.</p>
</div>
<div class="paragraph">
<p>Take a look at the query below. It finds any airports that have six or more runways
and then returns the airport’s IATA code along with the number of runways it has.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-n">gte</span><span class="tok-o">(</span><span class="tok-mi">6</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the output from running the query. As you can see what is returned is a list
of airport codes with each followed by its runway count.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-n">ORD</span><span class="tok-o">,</span><span class="tok-mi">8</span><span class="tok-o">,</span><span class="tok-n">DEN</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-n">DTW</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">,</span><span class="tok-n">AMS</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>While the output returned by the previous query is not bad, it might be nice to have
what is returned be a set of code and runway pairs each in its own list. We can
achieve this result by having the <em>fold</em> step applied to the interim or <em>local</em>
results of the query.</p>
</div>
<div class="paragraph">
<p>Take a look at the modified form of the query below. Part of the query is now wrapped
inside of a <em>local</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-n">gte</span><span class="tok-o">(</span><span class="tok-mi">6</span><span class="tok-o">)).</span><span class="tok-na">local</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the output from running our modified form of the query. Each airport code and
runway value pair is now in its own individual list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">ORD</span><span class="tok-o">,</span><span class="tok-mi">8</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DEN</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DTW</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AMS</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="noedges">5.1.24. How many vertices have no edges?</h4>
<div class="paragraph">
<p>In the air routes graph there are some vertices that have no outgoing edges, some
that have no incoming edges and a few, such as the vertex for the continent
of Antarctica, that have neither. We can use some simple
queries to count how many of each type exist.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Vertices with no outgoing edges.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">not</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">()).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">23</span>

<span class="tok-c1">// Vertices with no incoming edges.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">not</span><span class="tok-o">(</span><span class="tok-n">inE</span><span class="tok-o">()).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">245</span>

<span class="tok-c1">// Vertices with no edges.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">not</span><span class="tok-o">(</span><span class="tok-n">bothE</span><span class="tok-o">()).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">7</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The queries above provide a nice shorthand way of writing queries that we could also
write using <em>where</em> steps. As shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">)).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">23</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="wherefly">5.2. Where can I fly to from here?</h3>
<div class="paragraph">
<p>In this section you will find some more examples of queries that explore different
questions along the lines of "Where can I fly to from here?".</p>
</div>
<div class="sect3">
<h4 id="doesanyrouteexist">5.2.1. Does any route exist between two airports?</h4>
<div class="paragraph">
<p>We have already looked at different ways to discover shortest routes (by hops)
between two airports using queries such as the one below. This query looks for a
single route between Austin (AUS) and the Canadian city of Peawanuck in Ontario. It
just so happens that Peawanuck is one of the hardest places to get to from Austin in
the whole air-routes graph. In fact, to get there, requires six stops along the way!
With that in mind, the query below can easily run out of memory or time out trying to
find even a single route as there is so much work to do to analyze all of the
possible routes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span>
        <span class="tok-n">until</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'YPO'</span><span class="tok-o">)).</span>
      <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In cases such as this we can take a slightly different approach that will let us know
if any route exists and in fact will execute very efficiently. Note that this query
cannot find multiple routes but is very useful when trying to answer the question
"does any route exist?".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">dedup</span><span class="tok-o">()).</span>
        <span class="tok-n">until</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'YPO'</span><span class="tok-o">)).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">YTS</span><span class="tok-o">,</span><span class="tok-n">YMO</span><span class="tok-o">,</span><span class="tok-n">YFA</span><span class="tok-o">,</span><span class="tok-n">ZKE</span><span class="tok-o">,</span><span class="tok-n">YAT</span><span class="tok-o">,</span><span class="tok-n">YPO</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The difference between the two queries is the addition of a <em>dedup</em> step. This
ensures we only ever visit any airport along the route once no matter how we got
there. This is different from the <em>simplePath</em> step which makes sure we do not loop
back on ourselves during a traversal but allows us to visit the same airport multiple
times so long as we got there using a different path. Even if we were to make the
task of finding a route harder by explicitly avoiding a specific stop the execution
remains very efficient due to the <em>dedup</em> step being used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">without</span><span class="tok-o">(</span><span class="tok-s1">'YYZ'</span><span class="tok-o">)).</span><span class="tok-na">dedup</span><span class="tok-o">()).</span>
        <span class="tok-n">until</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'YPO'</span><span class="tok-o">)).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-n">YTZ</span><span class="tok-o">,</span><span class="tok-n">YTS</span><span class="tok-o">,</span><span class="tok-n">YMO</span><span class="tok-o">,</span><span class="tok-n">YFA</span><span class="tok-o">,</span><span class="tok-n">ZKE</span><span class="tok-o">,</span><span class="tok-n">YAT</span><span class="tok-o">,</span><span class="tok-n">YPO</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Keep in mind that this trick is only useful when trying to figure out if any route
(or path) exists in a group between a pair of vertices. It cannot be used to find
multiple routes but is still a very useful pattern to be aware of. You will see a
variation of this technique used again in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#longestroutes">Looking for the journey requiring the most stops</a>" section.</p>
</div>
</div>
<div class="sect3">
<h4 id="uscatoindia">5.2.2. Where in the USA or Canada can I fly to from any airport in India?</h4>
<div class="paragraph">
<p>This first query looks for routes to the USA or Canada from any airport in India.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Where in the USA or Canada can I fly to from any airport in India?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'IN'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'US'</span><span class="tok-o">,</span><span class="tok-s1">'CA'</span><span class="tok-o">)).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results of running the query. Note that because we used the <em>path</em> step
the country code for India "IN" is included in the output.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">IN</span><span class="tok-o">,</span><span class="tok-n">DEL</span><span class="tok-o">,</span><span class="tok-n">IAD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">IN</span><span class="tok-o">,</span><span class="tok-n">DEL</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">IN</span><span class="tok-o">,</span><span class="tok-n">DEL</span><span class="tok-o">,</span><span class="tok-n">ORD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">IN</span><span class="tok-o">,</span><span class="tok-n">DEL</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">IN</span><span class="tok-o">,</span><span class="tok-n">DEL</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">IN</span><span class="tok-o">,</span><span class="tok-n">DEL</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">IN</span><span class="tok-o">,</span><span class="tok-n">DEL</span><span class="tok-o">,</span><span class="tok-n">YVR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">IN</span><span class="tok-o">,</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">IN</span><span class="tok-o">,</span><span class="tok-n">BOM</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="flleurope">5.2.3. Which cities in Europe can I fly to from Ft. Lauderdale in Florida?</h4>
<div class="paragraph">
<p>This query looks for routes from Fort Lauderdale in Florida to cities in Europe.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Where can I fly to in Europe from Ft. Lauderdale?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'FLL'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">in</span><span class="tok-o">(</span><span class="tok-s1">'contains'</span><span class="tok-o">).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'EU'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results of running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">London</span>
<span class="tok-n">Paris</span>
<span class="tok-n">Oslo</span>
<span class="tok-n">Stockholm</span>
<span class="tok-n">Copenhagen</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="clteusa">5.2.4. Where can I fly to from Charlotte, to cities in Europe or South America?</h4>
<div class="paragraph">
<p>This query looks for routes from Charlotte, North Carolina to cities in Europe or
South America.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Flights from Charlotte to airports in Europe or South America</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'CLT'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">in</span><span class="tok-o">(</span><span class="tok-s1">'contains'</span><span class="tok-o">).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'EU'</span><span class="tok-o">,</span><span class="tok-s1">'SA'</span><span class="tok-o">)).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results of running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">LHR</span>     <span class="tok-n">FCO</span>
<span class="tok-n">CDG</span>     <span class="tok-n">MAD</span>
<span class="tok-n">FRA</span>     <span class="tok-n">MUC</span>
<span class="tok-n">GIG</span>     <span class="tok-n">DUB</span>
<span class="tok-n">GRU</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="usalon">5.2.5. Where in the United States can I fly from to airports in London?</h4>
<div class="paragraph">
<p>This query looks for routes from any one of the five airports in the
London area in the UK that end up in the United States.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Where in the United States can I fly to non-stop from any of the</span>
<span class="tok-c1">// airports in and around London in the UK?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'LHR'</span><span class="tok-o">,</span><span class="tok-s1">'LCY'</span><span class="tok-o">,</span><span class="tok-s1">'LGW'</span><span class="tok-o">,</span><span class="tok-s1">'LTN'</span><span class="tok-o">,</span><span class="tok-s1">'STN'</span><span class="tok-o">)).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'US'</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results of running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">SEA</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">RDU</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">DEN</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">SJC</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">DTW</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">PHL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">IAD</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">MSP</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span><span class="tok-n">TPA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span><span class="tok-n">FLL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">PHX</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">CLT</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span><span class="tok-n">MCO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">ORD</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">SAN</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="txny">5.2.6. Where in New York state can I fly to from any of the airports in Texas?</h4>
<div class="paragraph">
<p>This query looks for all the routes from any airport in Texas that end up in any of
the New York state airports.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Where in New York state can I fly to from any airport in Texas?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-NY'</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results of running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">HOU</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">LGA</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">HOU</span><span class="tok-o">,</span><span class="tok-n">LGA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">HOU</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-n">LGA</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="denmex">5.2.7. Which cities in Mexico can I fly to from Denver?</h4>
<div class="paragraph">
<p>This query looks for routes from Denver to anywhere in Mexico.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Where in Mexico can I fly to from Denver?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DEN'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'MX'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results of running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">Puerto</span> <span class="tok-n">Vallarta</span>
<span class="tok-n">San</span> <span class="tok-n">Josa</span> <span class="tok-n">del</span> <span class="tok-n">Cabo</span>
<span class="tok-n">Cozumel</span>
<span class="tok-n">Mexico</span> <span class="tok-n">City</span>
<span class="tok-n">Cancun</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="deleu">5.2.8. Which cities in Europe can I fly to from Delhi in India?</h4>
<div class="paragraph">
<p>This query looks for routes from Delhi that go to any airport in Europe.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Where in Europe can I fly to from Delhi?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DEL'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">in</span><span class="tok-o">(</span><span class="tok-s2">"contains"</span><span class="tok-o">).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'EU'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results of running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">London</span>
<span class="tok-n">Paris</span>
<span class="tok-n">Frankfurt</span>
<span class="tok-n">Helsinki</span>
<span class="tok-n">Rome</span>
<span class="tok-n">Amsterdam</span>
<span class="tok-n">Madrid</span>
<span class="tok-n">Vienna</span>
<span class="tok-n">Zurich</span>
<span class="tok-n">Brussels</span>
<span class="tok-n">Munich</span>
<span class="tok-n">Stockholm</span>
<span class="tok-n">Moscow</span>
<span class="tok-n">Milan</span>
<span class="tok-n">Istanbul</span>
<span class="tok-n">Copenhagen</span>
<span class="tok-n">Birmingham</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="aggrroutes">5.2.9. Finding all routes between London, Munich and Paris</h4>
<div class="paragraph">
<p>In the following example we find all the routes between airports in London, Munich
and Paris. Notice how by using <em>aggregate</em> to collect the results of the first
<em>within</em> test that we don’t have to repeat the names in the second <em>within</em>, we can
just refer to the aggregated collection.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'London'</span><span class="tok-o">,</span><span class="tok-s1">'Munich'</span><span class="tok-o">,</span><span class="tok-s1">'Paris'</span><span class="tok-o">)).</span><span class="tok-na">aggregate</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">)).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is what we might get back from the query. I have laid the results out in columns
to save space.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">MUC</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">CDG</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">MUC</span><span class="tok-o">,</span><span class="tok-n">STN</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">STN</span><span class="tok-o">,</span><span class="tok-n">MUC</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">ORY</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">CDG</span><span class="tok-o">,</span><span class="tok-n">LGW</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">MUC</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">ORY</span><span class="tok-o">,</span><span class="tok-n">LCY</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">CDG</span><span class="tok-o">,</span><span class="tok-n">MUC</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">MUC</span><span class="tok-o">,</span><span class="tok-n">LGW</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">ORY</span><span class="tok-o">,</span><span class="tok-n">MUC</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span><span class="tok-n">MUC</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">CDG</span><span class="tok-o">,</span><span class="tok-n">LCY</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">MUC</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">ORY</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">MUC</span><span class="tok-o">,</span><span class="tok-n">LTN</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">LCY</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">LTN</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">CDG</span><span class="tok-o">,</span><span class="tok-n">LTN</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">MUC</span><span class="tok-o">,</span><span class="tok-n">ORY</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">LCY</span><span class="tok-o">,</span><span class="tok-n">ORY</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">LTN</span><span class="tok-o">,</span><span class="tok-n">MUC</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="moredist">5.3. More analysis of distances between airports</h3>
<div class="paragraph">
<p>In this section you will find some more queries that examine distances between
airports. The query below returns a nice list of all the routes from Austin (AUS)
along with their distances. The results are sorted in ascending order by distance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Distances of all routes from AUS along with destination IATA CODE</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">asc</span><span class="tok-o">).</span>
      <span class="tok-n">inV</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results of running the query. For ease of reading I again broke the
results into four columns.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">142</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">755</span><span class="tok-o">,</span><span class="tok-n">GDL</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1080</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1430</span><span class="tok-o">,</span><span class="tok-n">PHL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">152</span><span class="tok-o">,</span><span class="tok-n">HOU</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">755</span><span class="tok-o">,</span><span class="tok-n">BNA</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1080</span><span class="tok-o">,</span><span class="tok-n">SLC</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1476</span><span class="tok-o">,</span><span class="tok-n">SJC</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">183</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">768</span><span class="tok-o">,</span><span class="tok-n">DEN</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1110</span><span class="tok-o">,</span><span class="tok-n">FLL</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1493</span><span class="tok-o">,</span><span class="tok-n">OAK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">189</span><span class="tok-o">,</span><span class="tok-n">DAL</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">809</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1140</span><span class="tok-o">,</span><span class="tok-n">DTW</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1500</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">274</span><span class="tok-o">,</span><span class="tok-n">HRL</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">866</span><span class="tok-o">,</span><span class="tok-n">PHX</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1160</span><span class="tok-o">,</span><span class="tok-n">SAN</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1500</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">341</span><span class="tok-o">,</span><span class="tok-n">LBB</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">922</span><span class="tok-o">,</span><span class="tok-n">CUN</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1173</span><span class="tok-o">,</span><span class="tok-n">CLE</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1520</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">444</span><span class="tok-o">,</span><span class="tok-n">MSY</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">925</span><span class="tok-o">,</span><span class="tok-n">TPA</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1220</span><span class="tok-o">,</span><span class="tok-n">LGB</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1690</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">527</span><span class="tok-o">,</span><span class="tok-n">ELP</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">972</span><span class="tok-o">,</span><span class="tok-n">MDW</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1230</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1712</span><span class="tok-o">,</span><span class="tok-n">PDX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">558</span><span class="tok-o">,</span><span class="tok-n">MEM</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">973</span><span class="tok-o">,</span><span class="tok-n">ORD</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1294</span><span class="tok-o">,</span><span class="tok-n">IAD</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1768</span><span class="tok-o">,</span><span class="tok-n">SEA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">618</span><span class="tok-o">,</span><span class="tok-n">ABQ</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">994</span><span class="tok-o">,</span><span class="tok-n">MCO</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1313</span><span class="tok-o">,</span><span class="tok-n">DCA</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">4901</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">722</span><span class="tok-o">,</span><span class="tok-n">STL</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1030</span><span class="tok-o">,</span><span class="tok-n">CLT</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1339</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">5294</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">748</span><span class="tok-o">,</span><span class="tok-n">MEX</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1040</span><span class="tok-o">,</span><span class="tok-n">MSP</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1357</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This query finds all routes from DFW that are longer than 4,000 miles and returns the
airport codes and the distances. Notice the use of two <em>by</em> modulators in this query
to decide which values are returned from the source vertex, the edge and the
destination vertex respectively. Also note that only two were specified but three
values are returned. This works because <em>by</em> is processed in a round robin fashion if
there are more values than <em>by</em> modulators.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Where can I fly to from DFW that is more than 4,000 miles away?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">4000</span><span class="tok-o">)).</span><span class="tok-na">inV</span><span class="tok-o">().</span>
                        <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results of running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">8105</span><span class="tok-o">,</span><span class="tok-n">HKG</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">8022</span><span class="tok-o">,</span><span class="tok-n">DXB</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">6951</span><span class="tok-o">,</span><span class="tok-n">PEK</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">6822</span><span class="tok-o">,</span><span class="tok-n">ICN</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">7332</span><span class="tok-o">,</span><span class="tok-n">PVG</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">5228</span><span class="tok-o">,</span><span class="tok-n">GIG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">4905</span><span class="tok-o">,</span><span class="tok-n">AMS</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">5119</span><span class="tok-o">,</span><span class="tok-n">GRU</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">4950</span><span class="tok-o">,</span><span class="tok-n">MAD</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">5299</span><span class="tok-o">,</span><span class="tok-n">EZE</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">4736</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">4884</span><span class="tok-o">,</span><span class="tok-n">SCL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">4933</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">7914</span><span class="tok-o">,</span><span class="tok-n">DOH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">5127</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">8053</span><span class="tok-o">,</span><span class="tok-n">AUH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">6410</span><span class="tok-o">,</span><span class="tok-n">NRT</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">5015</span><span class="tok-o">,</span><span class="tok-n">DUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">8574</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">5597</span><span class="tok-o">,</span><span class="tok-n">FCO</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The previous results are not sorted in any way. We could modify the query to include
an <em>order</em> step so that the results are sorted in descending order by distance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">4000</span><span class="tok-o">)).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">desc</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">().</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the, now sorted, results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">8574</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">5299</span><span class="tok-o">,</span><span class="tok-n">EZE</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">8105</span><span class="tok-o">,</span><span class="tok-n">HKG</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">5228</span><span class="tok-o">,</span><span class="tok-n">GIG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">8053</span><span class="tok-o">,</span><span class="tok-n">AUH</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">5127</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">8022</span><span class="tok-o">,</span><span class="tok-n">DXB</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">5119</span><span class="tok-o">,</span><span class="tok-n">GRU</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">7914</span><span class="tok-o">,</span><span class="tok-n">DOH</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">5015</span><span class="tok-o">,</span><span class="tok-n">DUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">7332</span><span class="tok-o">,</span><span class="tok-n">PVG</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">4950</span><span class="tok-o">,</span><span class="tok-n">MAD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">6951</span><span class="tok-o">,</span><span class="tok-n">PEK</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">4933</span><span class="tok-o">,</span><span class="tok-n">CDG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">6822</span><span class="tok-o">,</span><span class="tok-n">ICN</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">4905</span><span class="tok-o">,</span><span class="tok-n">AMS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">6410</span><span class="tok-o">,</span><span class="tok-n">NRT</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">4884</span><span class="tok-o">,</span><span class="tok-n">SCL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">5597</span><span class="tok-o">,</span><span class="tok-n">FCO</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">4736</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This next query also finds all routes longer than 4,000 miles but this time
originating in London Gatwick. Note also the use of <em>where</em> to query the edge
distance. The <em>has</em> form is simpler but I show <em>where</em> being used just to
demonstrate an alternative way we could do it. Note that this query uses
three <em>by</em> modulators as each of the values returned is from a different
property of the respective vertices and edges.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Routes longer than 4,000 miles starting at LGW</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LGW'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">4000L</span><span class="tok-o">))).</span>
      <span class="tok-n">inV</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results from running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">5287</span><span class="tok-o">,</span> <span class="tok-n">MalT</span><span class="tok-o">]</span>              <span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">4380</span><span class="tok-o">,</span> <span class="tok-n">Calgary</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">4618</span><span class="tok-o">,</span> <span class="tok-n">Varadero</span><span class="tok-o">]</span>          <span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">5987</span><span class="tok-o">,</span> <span class="tok-n">Cape</span> <span class="tok-n">Town</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">5147</span><span class="tok-o">,</span> <span class="tok-n">Tianjin</span><span class="tok-o">]</span>           <span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">4680</span><span class="tok-o">,</span> <span class="tok-n">Kingston</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">5303</span><span class="tok-o">,</span> <span class="tok-n">Chongqing</span><span class="tok-o">]</span>         <span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">4953</span><span class="tok-o">,</span> <span class="tok-n">Cancun</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">4410</span><span class="tok-o">,</span> <span class="tok-n">Ft</span><span class="tok-o">.</span> <span class="tok-n">Lauderdale</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">5399</span><span class="tok-o">,</span> <span class="tok-n">Colombo</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">5463</span><span class="tok-o">,</span> <span class="tok-n">Los</span> <span class="tok-n">Angeles</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">4197</span><span class="tok-o">,</span> <span class="tok-n">Bridgetown</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">4341</span><span class="tok-o">,</span> <span class="tok-n">Orlando</span><span class="tok-o">]</span>           <span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">4076</span><span class="tok-o">,</span> <span class="tok-n">St</span><span class="tok-o">.</span> <span class="tok-n">George</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">5374</span><span class="tok-o">,</span> <span class="tok-n">San</span> <span class="tok-n">Francisco</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">4408</span><span class="tok-o">,</span> <span class="tok-n">Port</span> <span class="tok-n">of</span> <span class="tok-n">Spain</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">4416</span><span class="tok-o">,</span> <span class="tok-n">Tampa</span><span class="tok-o">]</span>             <span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">4699</span><span class="tok-o">,</span> <span class="tok-n">Montego</span> <span class="tok-n">Bay</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">5236</span><span class="tok-o">,</span> <span class="tok-n">Las</span> <span class="tok-n">Vegas</span><span class="tok-o">]</span>         <span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">4283</span><span class="tok-o">,</span> <span class="tok-n">Punta</span> <span class="tok-n">Cana</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">5364</span><span class="tok-o">,</span> <span class="tok-n">Oakland</span><span class="tok-o">]</span>           <span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">5419</span><span class="tok-o">,</span> <span class="tok-n">San</span> <span class="tok-n">Jose</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">4731</span><span class="tok-o">,</span> <span class="tok-n">Vancouver</span><span class="tok-o">]</span>         <span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">4662</span><span class="tok-o">,</span> <span class="tok-n">Havana</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">5982</span><span class="tok-o">,</span> <span class="tok-n">Hong</span> <span class="tok-n">Kong</span><span class="tok-o">]</span>         <span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">6053</span><span class="tok-o">,</span> <span class="tok-n">Port</span> <span class="tok-n">Louis</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">5070</span><span class="tok-o">,</span> <span class="tok-n">Beijing</span><span class="tok-o">]</span>           <span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-mi">4222</span><span class="tok-o">,</span> <span class="tok-n">Vieux</span> <span class="tok-n">Fort</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This next query is similar to the previous ones. We look for any routes from DFW that
are longer than 4,500 miles. However, there are a few differences in this query
worthy of note. First of all it uses the preferred <em>has</em> technique again to test the
distance whereas in the previous query we used <em>where</em>. Also this time we just list
the distance and the destination airport’s code and we sort the end result using a
<em>sort</em>. We also use <em>select</em> and <em>as</em> rather than the perhaps more succinct <em>path</em>
and <em>by</em> to show a different way of achieving effectively the same results. The
<em>path</em> and <em>by</em> combination were introduced more recently into TinkerPop and I find
that to be a more convenient syntax to use most of the time but both ways work and
both have their benefits. We should also note that I show <em>sort</em> being used here just
to show a different way of ordering results, but in most cases we can re-write our
query to use <em>order</em>. This use of <em>sort</em> requires a Groovy closure to be provided.
This may not work when working with commercial graph databases that disallow
closures. You will find several examples of <em>order</em> being used throughout this book.
The <em>order</em> step is introduced in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#sort">Sorting things - introducing <em>order</em></a>" section. As much as possible staying
with the pure Gremlin syntax and avoiding closures is recommended.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Routes from DFW that are over 4,500 miles in length.</span>
<span class="tok-c1">// Sorted into ascending order</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">4500</span><span class="tok-o">)).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">).</span>
      <span class="tok-n">inV</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'c'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">,</span><span class="tok-s1">'c'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">sort</span><span class="tok-o">(){</span><span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">e</span><span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In general, I find using <em>path</em> rather than <em>select</em> and <em>as</em> to be cleaner. However,
as discussed in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#pathwarn">A warning that path finding can be memory and CPU intensive</a>" section, there are issues with <em>path</em> consuming
memory that you will likely run into with more complex queries so it is always good
to have some options as to how you write your Gremlin queries. Here is the output
produced by this query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">4736</span><span class="tok-o">,</span> <span class="tok-nl">c:</span><span class="tok-n">LHR</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">5597</span><span class="tok-o">,</span> <span class="tok-nl">c:</span><span class="tok-n">FCO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">4884</span><span class="tok-o">,</span> <span class="tok-nl">c:</span><span class="tok-n">SCL</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">6410</span><span class="tok-o">,</span> <span class="tok-nl">c:</span><span class="tok-n">NRT</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">4905</span><span class="tok-o">,</span> <span class="tok-nl">c:</span><span class="tok-n">AMS</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">6822</span><span class="tok-o">,</span> <span class="tok-nl">c:</span><span class="tok-n">ICN</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">4933</span><span class="tok-o">,</span> <span class="tok-nl">c:</span><span class="tok-n">CDG</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">6951</span><span class="tok-o">,</span> <span class="tok-nl">c:</span><span class="tok-n">PEK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">4950</span><span class="tok-o">,</span> <span class="tok-nl">c:</span><span class="tok-n">MAD</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">7332</span><span class="tok-o">,</span> <span class="tok-nl">c:</span><span class="tok-n">PVG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">5015</span><span class="tok-o">,</span> <span class="tok-nl">c:</span><span class="tok-n">DUS</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">7914</span><span class="tok-o">,</span> <span class="tok-nl">c:</span><span class="tok-n">DOH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">5119</span><span class="tok-o">,</span> <span class="tok-nl">c:</span><span class="tok-n">GRU</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">8022</span><span class="tok-o">,</span> <span class="tok-nl">c:</span><span class="tok-n">DXB</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">5127</span><span class="tok-o">,</span> <span class="tok-nl">c:</span><span class="tok-n">FRA</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">8053</span><span class="tok-o">,</span> <span class="tok-nl">c:</span><span class="tok-n">AUH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">5228</span><span class="tok-o">,</span> <span class="tok-nl">c:</span><span class="tok-n">GIG</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">8105</span><span class="tok-o">,</span> <span class="tok-nl">c:</span><span class="tok-n">HKG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">5299</span><span class="tok-o">,</span> <span class="tok-nl">c:</span><span class="tok-n">EZE</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">8574</span><span class="tok-o">,</span> <span class="tok-nl">c:</span><span class="tok-n">SYD</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For the sake of completeness, here is the query re-written to use an <em>order</em> step
rather than a call to <em>sort</em> as a post processing step at the end of the query. In
general this is the recommended way of achieving sorted results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">4500</span><span class="tok-o">)).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'c'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">,</span><span class="tok-s1">'c'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the results are ordered before being collected using the <em>select</em> step.
Here is the output from running the modified query</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">4736</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">LHR</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">5597</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">FCO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">4884</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">SCL</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">6410</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">NRT</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">4905</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">AMS</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">6822</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">ICN</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">4933</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">CDG</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">6951</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">PEK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">4950</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">MAD</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">7332</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">PVG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">5015</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">DUS</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">7914</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">DOH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">5119</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">GRU</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">8022</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">DXB</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">5127</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">FRA</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">8053</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">AUH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">5228</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">GIG</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">8105</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">HKG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">5299</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">EZE</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">e:</span><span class="tok-mi">8574</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">SYD</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The query can also be written with the <em>order</em> step coming after the <em>select</em> step.
As follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">4500</span><span class="tok-o">)).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">).</span>
<span class="tok-n">inV</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'c'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">,</span><span class="tok-s1">'c'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="gt8k">5.3.1. Finding routes longer than 8,000 miles</h4>
<div class="paragraph">
<p>This next set of queries show various ways of finding and presenting all routes
longer than 8,000 miles. Each query improves upon the one before by adding some
additional feature or using a step that simplifies the query. First of all let’s just
find all routes longer than 8,000 miles. This will includes routes in both directions
between airport pairs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// All routes longer than 8,000 miles</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'src'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">8000</span><span class="tok-o">)).</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'dest'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'src'</span><span class="tok-o">,</span><span class="tok-s1">'dest'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is what our query produces. As before I have arranged the output in columns to
aid readability.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">JNB</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">IAH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">SYD</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">LAX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">DXB</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">SFO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">HKG</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">AKL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">AUH</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">HKG</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">DFW</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">DXB</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">HKG</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">JFK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">DOH</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">HKG</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">EWR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">HKG</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">DXB</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">DOH</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">DOH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">AUH</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">DOH</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">IAH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">JED</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">DOH</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">LAX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">RUH</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">DOH</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">AKL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">DXB</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">JNB</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">ATL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">SIN</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">MEX</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">CAN</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">DXB</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">DFW</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">AUH</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">LAX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">HKG</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">SFO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">SYD</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">DFW</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">JED</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">LAX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">SIN</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">SFO</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">RUH</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">LAX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">DFW</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">CAN</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">MEX</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let’s improve the query by including the distance of each route in the query
results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Find routes longer than 8,000 miles.</span>
<span class="tok-c1">// Include the distance in returned values.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'src'</span><span class="tok-o">).</span>
      <span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">8000</span><span class="tok-o">)).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">).</span>
      <span class="tok-n">inV</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'dest'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'src'</span><span class="tok-o">,</span><span class="tok-s1">'e'</span><span class="tok-o">,</span><span class="tok-s1">'dest'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the modified output showing the distance between the airports.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8434</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">JNB</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8150</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">IAH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8574</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">SYD</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8321</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">LAX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8022</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">DXB</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8085</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">SFO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8105</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">HKG</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8818</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">AKL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8053</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">AUH</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">HKG</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8105</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">DFW</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8150</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">DXB</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">HKG</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8054</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">JFK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8030</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">DOH</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">HKG</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8047</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">EWR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8054</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">HKG</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8818</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">DXB</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8287</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">DOH</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">9025</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">DOH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8372</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">AUH</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">DOH</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8030</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">IAH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8314</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">JED</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">DOH</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8287</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">LAX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8246</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">RUH</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">DOH</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">9025</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">AKL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8321</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">DXB</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">JNB</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8434</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">ATL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8433</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">SIN</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">MEX</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8754</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">CAN</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8085</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">DXB</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8053</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">DFW</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8139</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">AUH</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8372</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">LAX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8047</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">HKG</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8139</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">SFO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">SYD</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8574</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">DFW</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">JED</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8314</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">LAX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">SIN</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8433</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">SFO</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">RUH</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8246</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">LAX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8022</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">DFW</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-nl">src:</span><span class="tok-n">CAN</span><span class="tok-o">,</span><span class="tok-nl">e:</span><span class="tok-mi">8754</span><span class="tok-o">,</span><span class="tok-nl">dest:</span><span class="tok-n">MEX</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next let’s simplify things a bit. While using <em>as</em> and <em>select</em> gets the job done,
using <em>path</em> and <em>by</em> shortens the query and makes it more readable. As before
remember the warning that in some cases using <em>path</em> can consume large amounts of
memory. That should not be an issue for us here as we are writing a fairly simple
query still.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Note that this also changes the way the result is returned</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">8000</span><span class="tok-o">)).</span>
       <span class="tok-n">inV</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output indeed now looks more readable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-mi">8434</span><span class="tok-o">,</span><span class="tok-n">JNB</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-mi">8314</span><span class="tok-o">,</span><span class="tok-n">JED</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-mi">8150</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">DOH</span><span class="tok-o">,</span><span class="tok-mi">8287</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">8574</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-mi">8246</span><span class="tok-o">,</span><span class="tok-n">RUH</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-mi">8321</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">DOH</span><span class="tok-o">,</span><span class="tok-mi">9025</span><span class="tok-o">,</span><span class="tok-n">AKL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">8022</span><span class="tok-o">,</span><span class="tok-n">DXB</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-mi">8321</span><span class="tok-o">,</span><span class="tok-n">DXB</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-mi">8085</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">JNB</span><span class="tok-o">,</span><span class="tok-mi">8434</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">8105</span><span class="tok-o">,</span><span class="tok-n">HKG</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-mi">8433</span><span class="tok-o">,</span><span class="tok-n">SIN</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-mi">8818</span><span class="tok-o">,</span><span class="tok-n">AKL</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">MEX</span><span class="tok-o">,</span><span class="tok-mi">8754</span><span class="tok-o">,</span><span class="tok-n">CAN</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">8053</span><span class="tok-o">,</span><span class="tok-n">AUH</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-mi">8085</span><span class="tok-o">,</span><span class="tok-n">DXB</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">HKG</span><span class="tok-o">,</span><span class="tok-mi">8105</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-mi">8053</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-mi">8150</span><span class="tok-o">,</span><span class="tok-n">DXB</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-mi">8139</span><span class="tok-o">,</span><span class="tok-n">AUH</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">HKG</span><span class="tok-o">,</span><span class="tok-mi">8054</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-mi">8372</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-mi">8030</span><span class="tok-o">,</span><span class="tok-n">DOH</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-mi">8047</span><span class="tok-o">,</span><span class="tok-n">HKG</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">HKG</span><span class="tok-o">,</span><span class="tok-mi">8047</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-mi">8139</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-mi">8054</span><span class="tok-o">,</span><span class="tok-n">HKG</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">SYD</span><span class="tok-o">,</span><span class="tok-mi">8574</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-mi">8818</span><span class="tok-o">,</span><span class="tok-n">DXB</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">JED</span><span class="tok-o">,</span><span class="tok-mi">8314</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-mi">8287</span><span class="tok-o">,</span><span class="tok-n">DOH</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">SIN</span><span class="tok-o">,</span><span class="tok-mi">8433</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-mi">9025</span><span class="tok-o">,</span><span class="tok-n">DOH</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">RUH</span><span class="tok-o">,</span><span class="tok-mi">8246</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-mi">8372</span><span class="tok-o">,</span><span class="tok-n">AUH</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-mi">8022</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">DOH</span><span class="tok-o">,</span><span class="tok-mi">8030</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">]</span>   <span class="tok-o">[</span><span class="tok-n">CAN</span><span class="tok-o">,</span><span class="tok-mi">8754</span><span class="tok-o">,</span><span class="tok-n">MEX</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Our query is looking pretty good but it would be nice to not report the same route
pair twice. In other words the distance between two airports in just one direction
is all we really want. This adds a little complexity to things as we have to find a
way to <em>filter</em> out the routes that we want to ignore. One way to do this is to
filter by making sure the code for the source airport is less than the code for the
destination airport. This may seem a bit odd but it is a way of saying we only want
route pairs we have not already seen. Consider the case of the route between ATL and
JNB. The less than (<em>lt</em>) test works as we will allow the route between ATL and JNB
through (as ATL is alphabetically less than JNB) but the route between JNB and ATL
will be filtered out. This is a useful technique that can be very helpful in many
situations where you are filtering out unwanted results. So let’s modify the query as
shown below to apply this filter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// We could avoid returning both directions of</span>
<span class="tok-c1">// travel by refining our query as follows.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">8000</span><span class="tok-o">)).</span>
      <span class="tok-n">inV</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span>
      <span class="tok-n">filter</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span> <span class="tok-n">lt</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">))).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the output from running the modified query. As you can see the route from ATL
to JNB is still shown but the reverse route from JNB to ATL is now gone. The same is
true for all the other <em>return journey</em> routes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-mi">8434</span><span class="tok-o">,</span><span class="tok-n">JNB</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">HKG</span><span class="tok-o">,</span><span class="tok-mi">8054</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">8574</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-mi">8818</span><span class="tok-o">,</span><span class="tok-n">DXB</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">8022</span><span class="tok-o">,</span><span class="tok-n">DXB</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-mi">9025</span><span class="tok-o">,</span><span class="tok-n">DOH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">8105</span><span class="tok-o">,</span><span class="tok-n">HKG</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">DOH</span><span class="tok-o">,</span><span class="tok-mi">8030</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-mi">8246</span><span class="tok-o">,</span><span class="tok-n">RUH</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">DOH</span><span class="tok-o">,</span><span class="tok-mi">8287</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-mi">8433</span><span class="tok-o">,</span><span class="tok-n">SIN</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-mi">8053</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-mi">8047</span><span class="tok-o">,</span><span class="tok-n">HKG</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-mi">8372</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-mi">8150</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-mi">8139</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-mi">8321</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">JED</span><span class="tok-o">,</span><span class="tok-mi">8314</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-mi">8085</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">CAN</span><span class="tok-o">,</span><span class="tok-mi">8754</span><span class="tok-o">,</span><span class="tok-n">MEX</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lastly, now that we have the routes we want, let’s tweak the query so that the routes
are sorted by descending order of distance. We can do this by adding an <em>order</em>
step after finding the routes we are interested in.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// As above but sorted by route lengths.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">8000</span><span class="tok-o">)).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">desc</span><span class="tok-o">).</span>
      <span class="tok-n">inV</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span>
      <span class="tok-n">filter</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span> <span class="tok-n">lt</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">))).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results again, this time sorted by route distance in descending order.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-mi">9025</span><span class="tok-o">,</span><span class="tok-n">DOH</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-mi">8246</span><span class="tok-o">,</span><span class="tok-n">RUH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-mi">8818</span><span class="tok-o">,</span><span class="tok-n">DXB</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-mi">8150</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">CAN</span><span class="tok-o">,</span><span class="tok-mi">8754</span><span class="tok-o">,</span><span class="tok-n">MEX</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-mi">8139</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">8574</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">8105</span><span class="tok-o">,</span><span class="tok-n">HKG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-mi">8434</span><span class="tok-o">,</span><span class="tok-n">JNB</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-mi">8085</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-mi">8433</span><span class="tok-o">,</span><span class="tok-n">SIN</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">HKG</span><span class="tok-o">,</span><span class="tok-mi">8054</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-mi">8372</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-mi">8053</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-mi">8321</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-mi">8047</span><span class="tok-o">,</span><span class="tok-n">HKG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">JED</span><span class="tok-o">,</span><span class="tok-mi">8314</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">DOH</span><span class="tok-o">,</span><span class="tok-mi">8030</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DOH</span><span class="tok-o">,</span><span class="tok-mi">8287</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">8022</span><span class="tok-o">,</span><span class="tok-n">DXB</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As part of the TinkerPop 3.2.3 release an additional capability was added to the
<em>where</em> step that allows it to be followed by a <em>by</em> modulator. This allows us,
should we so desire, to simplify our query a bit more as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">//Query changed to take advantage of the where().by() construct</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'s'</span><span class="tok-o">).</span>
      <span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">8000</span><span class="tok-o">)).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">desc</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'f'</span><span class="tok-o">).</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-s1">'f'</span><span class="tok-o">,</span><span class="tok-n">lt</span><span class="tok-o">(</span><span class="tok-s1">'s'</span><span class="tok-o">)).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, we got the same results from our modified query. Well, almost the same
results! Notice that we actually got the <em>return routes</em> returned. So for example,
we got the route from DXB to AKL and not the route from AKL to DXB that we got in the
prior case. This is because we compared the values in the opposite order!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">DOH</span><span class="tok-o">,</span><span class="tok-mi">9025</span><span class="tok-o">,</span><span class="tok-n">AKL</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">RUH</span><span class="tok-o">,</span><span class="tok-mi">8246</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-mi">8818</span><span class="tok-o">,</span><span class="tok-n">AKL</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-mi">8150</span><span class="tok-o">,</span><span class="tok-n">DXB</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">MEX</span><span class="tok-o">,</span><span class="tok-mi">8754</span><span class="tok-o">,</span><span class="tok-n">CAN</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-mi">8139</span><span class="tok-o">,</span><span class="tok-n">AUH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SYD</span><span class="tok-o">,</span><span class="tok-mi">8574</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">HKG</span><span class="tok-o">,</span><span class="tok-mi">8105</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">JNB</span><span class="tok-o">,</span><span class="tok-mi">8434</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-mi">8085</span><span class="tok-o">,</span><span class="tok-n">DXB</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SIN</span><span class="tok-o">,</span><span class="tok-mi">8433</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-mi">8054</span><span class="tok-o">,</span><span class="tok-n">HKG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-mi">8372</span><span class="tok-o">,</span><span class="tok-n">AUH</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">8053</span><span class="tok-o">,</span><span class="tok-n">AUH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-mi">8321</span><span class="tok-o">,</span><span class="tok-n">DXB</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">HKG</span><span class="tok-o">,</span><span class="tok-mi">8047</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-mi">8314</span><span class="tok-o">,</span><span class="tok-n">JED</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-mi">8030</span><span class="tok-o">,</span><span class="tok-n">DOH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-mi">8287</span><span class="tok-o">,</span><span class="tok-n">DOH</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-mi">8022</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As an interesting side note, and this would be true for the queries above as well, if
we replace the <em>lt</em> with a <em>gt</em> we will get the routes returned in the reverse order.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'s'</span><span class="tok-o">).</span>
      <span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">8000</span><span class="tok-o">)).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">desc</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'f'</span><span class="tok-o">).</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-s1">'f'</span><span class="tok-o">,</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-s1">'s'</span><span class="tok-o">)).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the prior query the first result was <em>[DOH,9025,AKL]</em>. As you will
see below, our first result is now <em>[AKL,9025,DOH]</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-mi">9025</span><span class="tok-o">,</span><span class="tok-n">DOH</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-mi">8246</span><span class="tok-o">,</span><span class="tok-n">RUH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-mi">8818</span><span class="tok-o">,</span><span class="tok-n">DXB</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-mi">8150</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">CAN</span><span class="tok-o">,</span><span class="tok-mi">8754</span><span class="tok-o">,</span><span class="tok-n">MEX</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-mi">8139</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">8574</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">8105</span><span class="tok-o">,</span><span class="tok-n">HKG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-mi">8434</span><span class="tok-o">,</span><span class="tok-n">JNB</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-mi">8085</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-mi">8433</span><span class="tok-o">,</span><span class="tok-n">SIN</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">HKG</span><span class="tok-o">,</span><span class="tok-mi">8054</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-mi">8372</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-mi">8053</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-mi">8321</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-mi">8047</span><span class="tok-o">,</span><span class="tok-n">HKG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">JED</span><span class="tok-o">,</span><span class="tok-mi">8314</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">DOH</span><span class="tok-o">,</span><span class="tok-mi">8030</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DOH</span><span class="tok-o">,</span><span class="tok-mi">8287</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">8022</span><span class="tok-o">,</span><span class="tok-n">DXB</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_finding_the_20_longest_routes_in_the_graph">5.3.2. Finding the 20 longest routes in the graph</h4>
<div class="paragraph">
<p>We could write the query from the previous section a different way looking at edges
first and using the <em>project</em> step instead of using the <em>as</em> and <em>select</em> steps.
While in general it is not recommended to start a query with <em>g.E()</em> as there are
typically a lot more edges than vertices in a graph this does illustrate a useful
pattern. Also, just to change things a bit, this time we just look for the 20 longest
routes rather than looking for routes longer than 8,000 miles. We again filter the
results to only show the route in one direction. Note that the limit step is passed a
parameter of 40 rather than 20 as we know we will be filtering out the same route in
the return direction so we will actually only get 20 routes back.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">desc</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">40</span><span class="tok-o">).</span>
      <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">,</span><span class="tok-s1">'c'</span><span class="tok-o">).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">inV</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">outV</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)).</span>
      <span class="tok-n">filter</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'c'</span><span class="tok-o">)).</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-n">lt</span><span class="tok-o">(</span><span class="tok-s1">'c'</span><span class="tok-o">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results from running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">9025</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">DOH</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8246</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">RUH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8818</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">DXB</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8150</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">IAH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">CAN</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8754</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">MEX</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8139</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">SFO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8574</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">SYD</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8105</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">HKG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8434</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">JNB</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8085</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">SFO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8433</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">SIN</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">HKG</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8054</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">JFK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8372</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">LAX</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8053</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">DFW</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8321</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">LAX</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8047</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">HKG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">JED</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8314</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">LAX</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">DOH</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8030</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">IAH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">DOH</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8287</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">LAX</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8022</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">DXB</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For completeness, here is the query rewritten slightly to again start with airport
vertices rather than with all <em>route</em> edges but using <em>as</em> and <em>select</em> steps rather
than using a <em>path</em> step as used in the previous section. A <em>where</em> step followed by
a <em>by</em> modulator is still used in this case. So once again, it is clear there are
often many ways to get the results that you are looking for. The key is to think
about which form of a query will be the most effective for the data that you are
working with.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
      <span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">desc</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">40</span><span class="tok-o">).</span>
      <span class="tok-n">inV</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'c'</span><span class="tok-o">).</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-n">lt</span><span class="tok-o">(</span><span class="tok-s1">'c'</span><span class="tok-o">)).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">,</span><span class="tok-s1">'c'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When the query is run the results look like the ones from the prior query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">9025</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">DOH</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8246</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">RUH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8818</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">DXB</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8150</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">IAH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">CAN</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8754</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">MEX</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8139</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">SFO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8574</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">SYD</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8105</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">HKG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8434</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">JNB</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8085</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">SFO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8433</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">SIN</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">HKG</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8054</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">JFK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8372</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">LAX</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8053</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">DFW</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8321</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">LAX</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8047</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">HKG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">JED</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8314</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">LAX</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">DOH</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8030</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">IAH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">DOH</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8287</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">LAX</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-mi">8022</span><span class="tok-o">,</span><span class="tok-nl">c:</span><span class="tok-n">DXB</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="longesteach">5.3.3. Finding the longest route from each airport</h4>
<div class="paragraph">
<p>The following query can be used to find the longest route from each airport in
the graph. I included a <em>limit</em> step so that just a few results are returned but
if you were to remove it then every airport in the graph would be represented in
the query results. A local step is used so that for each airport all of its
outgoing routes are analyzed. Those routes are ordered in descending order and
only the first one is selected in each case.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span>
            <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">desc</span><span class="tok-o">).</span>
            <span class="tok-n">inV</span><span class="tok-o">().</span>
            <span class="tok-n">path</span><span class="tok-o">().</span>
              <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
              <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span>
              <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When run the query produces the following results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-mi">8434</span><span class="tok-o">,</span><span class="tok-n">JNB</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-mi">3260</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">5294</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">BNA</span><span class="tok-o">,</span><span class="tok-mi">1972</span><span class="tok-o">,</span><span class="tok-n">SEA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-mi">7952</span><span class="tok-o">,</span><span class="tok-n">HKG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">BWI</span><span class="tok-o">,</span><span class="tok-mi">3622</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DCA</span><span class="tok-o">,</span><span class="tok-mi">2434</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">8574</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">FLL</span><span class="tok-o">,</span><span class="tok-mi">7808</span><span class="tok-o">,</span><span class="tok-n">DXB</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">IAD</span><span class="tok-o">,</span><span class="tok-mi">7487</span><span class="tok-o">,</span><span class="tok-n">DEL</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="aggrunion">5.3.4. Combining <em>aggregate</em>, <em>union</em> and <em>filter</em> to compute distances</h4>
<div class="paragraph">
<p>This next query is similar to the one we looked at in the <a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#aggrroutes">Finding all routes between London, Munich and Paris</a> section.
It uses <em>aggregate</em>, <em>union</em>, <em>filter</em> and <em>where</em> to factor certain airports in and
out of a query. We find all airports in London, Munich and Paris and then count the
total distance of all routes from those airports as the first half of a <em>union</em>. The
second half of the <em>union</em> only counts the distances of routes that end up in one of
our three selected cities.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'London'</span><span class="tok-o">,</span><span class="tok-s1">'Munich'</span><span class="tok-o">,</span><span class="tok-s1">'Paris'</span><span class="tok-o">)).</span>
      <span class="tok-n">aggregate</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span>
      <span class="tok-n">outE</span><span class="tok-o">().</span>
      <span class="tok-n">union</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">sum</span><span class="tok-o">(),</span>
            <span class="tok-n">filter</span><span class="tok-o">(</span><span class="tok-n">inV</span><span class="tok-o">().</span><span class="tok-na">where</span><span class="tok-o">((</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">)))).</span>
              <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">sum</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results from running the query. As expected the first number is a
lot bigger than the second one as it is the total distance of all routes from
the selected airports whereas the second number only reflects the total
distance of all routes between those airports.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-mi">2276209</span>
<span class="tok-mi">8906</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_more_queries_that_analyze_distances">5.3.5. More queries that analyze distances</h4>
<div class="paragraph">
<p>Calculating the distance between two directly connected airports is very easy. All we
have to do is look at the <em>dist</em> property of the edge that connects them. We can do
this using the <em>select</em> and <em>as</em> steps or in more recent versions of TinkerPop we can
use <em>path</em> and <em>by</em>. I prefer the latter technique. Both ways are shown in the
examples below that find the distance between Austin and Mexico City</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Distance between the AUS and MEX airports</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">).</span>
      <span class="tok-n">inV</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'MEX'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)</span>

<span class="tok-mi">748</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As above but using <em>path</em> and <em>by</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Distance between the AUS and MEX airports</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span>
      <span class="tok-n">inV</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'MEX'</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span> <span class="tok-mi">748</span><span class="tok-o">,</span> <span class="tok-n">MEX</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are some more queries that are based on the distance between airports. The first
query calculates how many routes there are between 100 and 200 miles. As an exercise,
If you remove the call to <em>count</em> the query will list the routes. As you can see
there are a lot of them!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Routes Between 100 and 200 miles in length</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-mi">100</span><span class="tok-o">..</span><span class="tok-mi">200</span><span class="tok-o">)).</span>
      <span class="tok-n">inV</span><span class="tok-o">().</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span>
      <span class="tok-n">count</span><span class="tok-o">()</span>

<span class="tok-mi">3029</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The next query is similar to the previous one but only counts routes that are between
airports located in the United States. As before, if you remove the call to <em>count</em>
the routes will be returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Routes Between 100 and 200 miles in length, but only within the US.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'US'</span><span class="tok-o">).</span>
      <span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-mi">100</span><span class="tok-o">..</span><span class="tok-mi">200</span><span class="tok-o">)).</span>
      <span class="tok-n">inV</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'US'</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span>
      <span class="tok-n">count</span><span class="tok-o">()</span>

<span class="tok-mi">583</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lastly, this query returns a list of all the routes from San Antonio along with their
distances. Some of the results are shown.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Return a list of routes and their distances,</span>
<span class="tok-c1">// starting from San Antonio (SAT)</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAT'</span><span class="tok-o">).</span>
  <span class="tok-n">outE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">().</span>
  <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are just a few of the results that this query returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-mi">872</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-mi">1140</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-mi">820</span><span class="tok-o">,</span><span class="tok-n">BNA</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-mi">698</span><span class="tok-o">,</span><span class="tok-n">MEX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-mi">1410</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-mi">1097</span><span class="tok-o">,</span><span class="tok-n">MSP</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-mi">248</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-mi">1093</span><span class="tok-o">,</span><span class="tok-n">CLT</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-mi">1360</span><span class="tok-o">,</span><span class="tok-n">IAD</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-mi">1040</span><span class="tok-o">,</span><span class="tok-n">ORD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-mi">190</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">]</span>      <span class="tok-o">[</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-mi">931</span><span class="tok-o">,</span><span class="tok-n">CUN</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-mi">1580</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-mi">841</span><span class="tok-o">,</span><span class="tok-n">PHX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-mi">1210</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-mi">624</span><span class="tok-o">,</span><span class="tok-n">MEM</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-mi">1038</span><span class="tok-o">,</span><span class="tok-n">MCO</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-mi">1772</span><span class="tok-o">,</span><span class="tok-n">SEA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-mi">1423</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-mi">707</span><span class="tok-o">,</span><span class="tok-n">MCI</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="AUSLHR-OS">5.3.6. How far is it from AUS to LHR with one stop?</h4>
<div class="paragraph">
<p>The next query begins to address the question "How far is it from AUS to LHR with one
stop?". We can quite easily come up with a query given what we now know about Gremlin
that will show us all possible options with one stop between AUS and LHR along with
the respective route distances.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Return all ways of getting from AUS to LHR with one stop.</span>
<span class="tok-c1">// Include the distances between each of the airports in the</span>
<span class="tok-c1">// query result.</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">inV</span><span class="tok-o">().</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output from running the query produces a nice set of data showing the starting,
intermediate and destination airports with the distances in miles between each. It
would be nice though if we could find a way to show the total distance that I will
have to travel in each case. That is the topic of the next section!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1476</span><span class="tok-o">,</span><span class="tok-n">SJC</span><span class="tok-o">,</span><span class="tok-mi">5352</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">183</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">4736</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1500</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-mi">5350</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1339</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">,</span><span class="tok-mi">3622</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1768</span><span class="tok-o">,</span><span class="tok-n">SEA</span><span class="tok-o">,</span><span class="tok-mi">4783</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1500</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-mi">3453</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">866</span><span class="tok-o">,</span><span class="tok-n">PHX</span><span class="tok-o">,</span><span class="tok-mi">5255</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>        <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1690</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-mi">3254</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">973</span><span class="tok-o">,</span><span class="tok-n">ORD</span><span class="tok-o">,</span><span class="tok-mi">3939</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>        <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">768</span><span class="tok-o">,</span><span class="tok-n">DEN</span><span class="tok-o">,</span><span class="tok-mi">4655</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1040</span><span class="tok-o">,</span><span class="tok-n">MSP</span><span class="tok-o">,</span><span class="tok-mi">4001</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1080</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">,</span><span class="tok-mi">5213</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1230</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-mi">5439</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">809</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-mi">4198</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1520</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-mi">3440</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1160</span><span class="tok-o">,</span><span class="tok-n">SAN</span><span class="tok-o">,</span><span class="tok-mi">5469</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1140</span><span class="tok-o">,</span><span class="tok-n">DTW</span><span class="tok-o">,</span><span class="tok-mi">3753</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1357</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-mi">3544</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">142</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-mi">4820</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>        <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">5294</span><span class="tok-o">,</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-mi">406</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1430</span><span class="tok-o">,</span><span class="tok-n">PHL</span><span class="tok-o">,</span><span class="tok-mi">3533</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">748</span><span class="tok-o">,</span><span class="tok-n">MEX</span><span class="tok-o">,</span><span class="tok-mi">5529</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1294</span><span class="tok-o">,</span><span class="tok-n">IAD</span><span class="tok-o">,</span><span class="tok-mi">3665</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span>       <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1030</span><span class="tok-o">,</span><span class="tok-n">CLT</span><span class="tok-o">,</span><span class="tok-mi">3980</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sackauslhr">5.3.7. Using <em>sack</em> to calculate the shortest AUS-LHR route with one stop</h4>
<div class="paragraph">
<p>Consider a typical use case for air travel. We want to calculate the shortest
distance we will have to travel to go from one airport to another with only one stop.
Let’s take a real example. What are the ten shortest distances from AUS to LHR with
one stop on the way?  Given what we know of Gremlin so far we can pretty easily come
up with a query that will give us routes from AUS to LHR with just one stop like we
did in the previous section. However, what is not so obvious, and this is an area
where the TinkerPop documentation is a little weak, is working out how to keep a
running total of values as we traverse a graph. This is where the <em>sack</em> step comes
in. As you will hopefully recall from some of the earlier sections, a <em>sack</em> allows
us to define a place where we can put things as the graph traversal proceeds. We can
give the sack an in initial value and can add to it during the traversal and then use
it as part of the information that our query will return. Take a look at the
rather lengthy query below. I have laid it out in a way that I hope makes it easy to
read.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Shortest distances from AUS to LHR with one stop</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">).</span>
  <span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">outE</span><span class="tok-o">().</span>
      <span class="tok-n">sack</span><span class="tok-o">(</span><span class="tok-n">sum</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span>
      <span class="tok-n">inV</span><span class="tok-o">().</span>
      <span class="tok-n">outE</span><span class="tok-o">().</span>
      <span class="tok-n">sack</span><span class="tok-o">(</span><span class="tok-n">sum</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span>
      <span class="tok-n">inV</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span>
      <span class="tok-n">sack</span><span class="tok-o">().</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">asc</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
        <span class="tok-n">by</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On the first line of the query, we initialize our sack with the value zero. During
the query, each time we take an outgoing edge, we add the distance value for that
edge to the sack. We filter out routes in the normal way by only keeping destinations
that are <em>LHR</em>. After finding the routes we care about we take the values that are
stored in our sack and use them to sort our results in ascending order. Finally on
we process the paths that we have taken. Note that the sack value is included
as part of the path output and referenced using a <em>by</em> modulator that has no
parameter. Running the query will produce the following results:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span> <span class="tok-mi">1140</span><span class="tok-o">,</span> <span class="tok-n">DTW</span><span class="tok-o">,</span> <span class="tok-mi">3753</span><span class="tok-o">,</span> <span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">4893</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span> <span class="tok-mi">1357</span><span class="tok-o">,</span> <span class="tok-n">YYZ</span><span class="tok-o">,</span> <span class="tok-mi">3544</span><span class="tok-o">,</span> <span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">4901</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span> <span class="tok-mi">973</span><span class="tok-o">,</span>  <span class="tok-n">ORD</span><span class="tok-o">,</span> <span class="tok-mi">3939</span><span class="tok-o">,</span> <span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">4912</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span> <span class="tok-mi">183</span><span class="tok-o">,</span>  <span class="tok-n">DFW</span><span class="tok-o">,</span> <span class="tok-mi">4736</span><span class="tok-o">,</span> <span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">4919</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span> <span class="tok-mi">1690</span><span class="tok-o">,</span> <span class="tok-n">BOS</span><span class="tok-o">,</span> <span class="tok-mi">3254</span><span class="tok-o">,</span> <span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">4944</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span> <span class="tok-mi">1500</span><span class="tok-o">,</span> <span class="tok-n">EWR</span><span class="tok-o">,</span> <span class="tok-mi">3453</span><span class="tok-o">,</span> <span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">4953</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span> <span class="tok-mi">1294</span><span class="tok-o">,</span> <span class="tok-n">IAD</span><span class="tok-o">,</span> <span class="tok-mi">3665</span><span class="tok-o">,</span> <span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">4959</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span> <span class="tok-mi">1520</span><span class="tok-o">,</span> <span class="tok-n">JFK</span><span class="tok-o">,</span> <span class="tok-mi">3440</span><span class="tok-o">,</span> <span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">4960</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span> <span class="tok-mi">1339</span><span class="tok-o">,</span> <span class="tok-n">BWI</span><span class="tok-o">,</span> <span class="tok-mi">3622</span><span class="tok-o">,</span> <span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">4961</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span> <span class="tok-mi">142</span><span class="tok-o">,</span>  <span class="tok-n">IAH</span><span class="tok-o">,</span> <span class="tok-mi">4820</span><span class="tok-o">,</span> <span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">4962</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In Tinkerpop 3.3 the syntax of <em>sack</em> was changed. Where previously you would
write something like <em>sack(sum,</em>'runways'<em>)</em> you are now required to write
<em>sack(sum).by(</em>'runways'<em>)</em>. The prior format was already deprecated in Tinkerpop
3.2.5 but is now fully removed starting with Tinkerpop 3.3.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>We could add a little post processing to our query to only output the airport codes
and the total mileage. Given this is post processing of a small data set, using a bit
of in-line code does not feel too ugly here.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">).</span><span class="tok-na">V</span><span class="tok-o">().</span>
  <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
  <span class="tok-n">outE</span><span class="tok-o">().</span>
  <span class="tok-n">sack</span><span class="tok-o">(</span><span class="tok-n">sum</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span>
  <span class="tok-n">inV</span><span class="tok-o">().</span>
  <span class="tok-n">outE</span><span class="tok-o">().</span>
  <span class="tok-n">sack</span><span class="tok-o">(</span><span class="tok-n">sum</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span>
  <span class="tok-n">inV</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span>
  <span class="tok-n">sack</span><span class="tok-o">().</span>
  <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">asc</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
  <span class="tok-n">path</span><span class="tok-o">().</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
    <span class="tok-n">by</span><span class="tok-o">().</span>
  <span class="tok-n">toList</span><span class="tok-o">().</span>
  <span class="tok-n">each</span><span class="tok-o">(){</span><span class="tok-n">println</span> <span class="tok-s2">"${it[0]} --&gt; ${it[2]} --&gt; ${it[4]} ${it[5]} miles"</span><span class="tok-o">}[];</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is what our modified query, with the Groovy post processing added, produces.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">AUS</span> <span class="tok-o">--&gt;</span> <span class="tok-n">DTW</span> <span class="tok-o">--&gt;</span> <span class="tok-n">LHR</span> <span class="tok-mi">4893</span> <span class="tok-n">miles</span>
<span class="tok-n">AUS</span> <span class="tok-o">--&gt;</span> <span class="tok-n">YYZ</span> <span class="tok-o">--&gt;</span> <span class="tok-n">LHR</span> <span class="tok-mi">4901</span> <span class="tok-n">miles</span>
<span class="tok-n">AUS</span> <span class="tok-o">--&gt;</span> <span class="tok-n">ORD</span> <span class="tok-o">--&gt;</span> <span class="tok-n">LHR</span> <span class="tok-mi">4912</span> <span class="tok-n">miles</span>
<span class="tok-n">AUS</span> <span class="tok-o">--&gt;</span> <span class="tok-n">DFW</span> <span class="tok-o">--&gt;</span> <span class="tok-n">LHR</span> <span class="tok-mi">4919</span> <span class="tok-n">miles</span>
<span class="tok-n">AUS</span> <span class="tok-o">--&gt;</span> <span class="tok-n">BOS</span> <span class="tok-o">--&gt;</span> <span class="tok-n">LHR</span> <span class="tok-mi">4944</span> <span class="tok-n">miles</span>
<span class="tok-n">AUS</span> <span class="tok-o">--&gt;</span> <span class="tok-n">EWR</span> <span class="tok-o">--&gt;</span> <span class="tok-n">LHR</span> <span class="tok-mi">4953</span> <span class="tok-n">miles</span>
<span class="tok-n">AUS</span> <span class="tok-o">--&gt;</span> <span class="tok-n">IAD</span> <span class="tok-o">--&gt;</span> <span class="tok-n">LHR</span> <span class="tok-mi">4959</span> <span class="tok-n">miles</span>
<span class="tok-n">AUS</span> <span class="tok-o">--&gt;</span> <span class="tok-n">JFK</span> <span class="tok-o">--&gt;</span> <span class="tok-n">LHR</span> <span class="tok-mi">4960</span> <span class="tok-n">miles</span>
<span class="tok-n">AUS</span> <span class="tok-o">--&gt;</span> <span class="tok-n">BWI</span> <span class="tok-o">--&gt;</span> <span class="tok-n">LHR</span> <span class="tok-mi">4961</span> <span class="tok-n">miles</span>
<span class="tok-n">AUS</span> <span class="tok-o">--&gt;</span> <span class="tok-n">IAH</span> <span class="tok-o">--&gt;</span> <span class="tok-n">LHR</span> <span class="tok-mi">4962</span> <span class="tok-n">miles</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="anothersack">5.3.8. Another example of how <em>sack</em> can be used</h4>
<div class="paragraph">
<p>The query below finds all airports with more than 200 routes and returns them as a
map of airport code and route count pairs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Print a table of airports with more than 200 routes and the number of routes</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">200</span><span class="tok-o">))).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results that the query generates.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">ORD:</span><span class="tok-mi">226</span><span class="tok-o">,</span> <span class="tok-nl">DFW:</span><span class="tok-mi">216</span><span class="tok-o">,</span> <span class="tok-nl">FRA:</span><span class="tok-mi">254</span><span class="tok-o">,</span> <span class="tok-nl">CDG:</span><span class="tok-mi">253</span><span class="tok-o">,</span> <span class="tok-nl">PEK:</span><span class="tok-mi">232</span><span class="tok-o">,</span> <span class="tok-nl">AMS:</span><span class="tok-mi">257</span><span class="tok-o">,</span> <span class="tok-nl">ATL:</span><span class="tok-mi">232</span><span class="tok-o">,</span> <span class="tok-nl">MUC:</span><span class="tok-mi">219</span><span class="tok-o">,</span> <span class="tok-nl">IST:</span><span class="tok-mi">259</span><span class="tok-o">,</span> <span class="tok-nl">DME:</span><span class="tok-mi">206</span><span class="tok-o">,</span> <span class="tok-nl">DXB:</span><span class="tok-mi">225</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The prevous query is a perfectly good way to achieve the desired result. Just for fun
let’s produce the same results using a <em>sack</em>. This is intended just as an example of
how <em>sack</em> works and is not the way you would actually want to perform this specific
query. That said, it is useful to have an example where the contents of the sack is
more complex than a simple integer value. At the start of the query we initialize our
sack with an empty map <em>[:]</em>. Later in the query, for each airport that has more than
200 outgoing routes, we update the map by adding the airport code and the route count
to the map. Note that the value part of each map entry is produced using a traversal.
So while this query is most definitely overkill for the task (as demonstrated by the
much simpler query above) it does provide us with another example of how you can use
sacks in powerful ways to store data as your query iterates.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// The same query but done using the new sack() step in TinkerPop 3</span>
<span class="tok-c1">// shown as an example only. The prior query works just fine for this.</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">([:]).</span>
  <span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
  <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">200</span><span class="tok-o">))).</span>
  <span class="tok-n">sack</span><span class="tok-o">{</span><span class="tok-n">m</span><span class="tok-o">,</span><span class="tok-n">v</span> <span class="tok-o">-&gt;</span> <span class="tok-n">m</span><span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">.</span><span class="tok-na">value</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)]=</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-n">v</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()}.</span>
  <span class="tok-n">fold</span><span class="tok-o">().</span><span class="tok-na">sack</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results that the new query generates. Other than the fact that the
results came back in a different order they are the same.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">ATL:</span><span class="tok-mi">232</span><span class="tok-o">,</span> <span class="tok-nl">DFW:</span><span class="tok-mi">216</span><span class="tok-o">,</span> <span class="tok-nl">ORD:</span><span class="tok-mi">226</span><span class="tok-o">,</span> <span class="tok-nl">CDG:</span><span class="tok-mi">253</span><span class="tok-o">,</span> <span class="tok-nl">FRA:</span><span class="tok-mi">254</span><span class="tok-o">,</span> <span class="tok-nl">DXB:</span><span class="tok-mi">225</span><span class="tok-o">,</span> <span class="tok-nl">PEK:</span><span class="tok-mi">232</span><span class="tok-o">,</span> <span class="tok-nl">AMS:</span><span class="tok-mi">257</span><span class="tok-o">,</span> <span class="tok-nl">MUC:</span><span class="tok-mi">219</span><span class="tok-o">,</span> <span class="tok-nl">DME:</span><span class="tok-mi">206</span><span class="tok-o">,</span> <span class="tok-nl">IST:</span><span class="tok-mi">259</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>fold</em> step is needed in the query above to make sure that the result we get back
is returned as a map. If we left the <em>fold</em> off we would just get the values stored
in the sack returned as a list of integers. Note that while the list of airports is
the same as the previous query, the order is different. This is a result of the way
the <em>group</em> step did its work in the previous query. Order should never be relied
upon. If you need a specific order for the results of a query it is always
recommended to perform an explicit <em>order</em> step as appropriate.</p>
</div>
<div class="paragraph">
<p>For completeness, a way of sorting the results of our original query by ascending
route count (values) is shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">200</span><span class="tok-o">))).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()).</span>
      <span class="tok-n">order</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">DME:</span><span class="tok-mi">213</span><span class="tok-o">,</span><span class="tok-nl">DFW:</span><span class="tok-mi">221</span><span class="tok-o">,</span><span class="tok-nl">DXB:</span><span class="tok-mi">229</span><span class="tok-o">,</span><span class="tok-nl">ORD:</span><span class="tok-mi">232</span><span class="tok-o">,</span><span class="tok-nl">PEK:</span><span class="tok-mi">232</span><span class="tok-o">,</span><span class="tok-nl">ATL:</span><span class="tok-mi">232</span><span class="tok-o">,</span><span class="tok-nl">MUC:</span><span class="tok-mi">237</span><span class="tok-o">,</span><span class="tok-nl">CDG:</span><span class="tok-mi">260</span><span class="tok-o">,</span><span class="tok-nl">FRA:</span><span class="tok-mi">266</span><span class="tok-o">,</span><span class="tok-nl">AMS:</span><span class="tok-mi">269</span><span class="tok-o">,</span><span class="tok-nl">IST:</span><span class="tok-mi">270</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you wanted to sort using the airport codes you could do it as follows. This time
we will sort the results of the <em>sack</em> based query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">([:]).</span>
  <span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">200</span><span class="tok-o">))).</span>
  <span class="tok-n">sack</span><span class="tok-o">{</span><span class="tok-n">m</span><span class="tok-o">,</span><span class="tok-n">v</span> <span class="tok-o">-&gt;</span> <span class="tok-n">m</span><span class="tok-o">[</span><span class="tok-n">v</span><span class="tok-o">.</span><span class="tok-na">value</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)]=</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-n">v</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()}.</span>
  <span class="tok-n">fold</span><span class="tok-o">().</span>
  <span class="tok-n">sack</span><span class="tok-o">().</span>
  <span class="tok-n">order</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">keys</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">AMS:</span><span class="tok-mi">269</span><span class="tok-o">,</span><span class="tok-nl">ATL:</span><span class="tok-mi">232</span><span class="tok-o">,</span><span class="tok-nl">CDG:</span><span class="tok-mi">260</span><span class="tok-o">,</span><span class="tok-nl">DFW:</span><span class="tok-mi">221</span><span class="tok-o">,</span><span class="tok-nl">DME:</span><span class="tok-mi">213</span><span class="tok-o">,</span><span class="tok-nl">DXB:</span><span class="tok-mi">229</span><span class="tok-o">,</span><span class="tok-nl">FRA:</span><span class="tok-mi">266</span><span class="tok-o">,</span><span class="tok-nl">IST:</span><span class="tok-mi">270</span><span class="tok-o">,</span><span class="tok-nl">MUC:</span><span class="tok-mi">237</span><span class="tok-o">,</span><span class="tok-nl">ORD:</span><span class="tok-mi">232</span><span class="tok-o">,</span><span class="tok-nl">PEK:</span><span class="tok-mi">232</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As well as using <em>withSack</em> to initialize a <em>sack</em> you can also use the <em>assign</em>
operator to do it. The query below uses a constant value of 0 to initialize the sack
and then uses the sack to count the number or runways that the airports you can fly
to from Austin have. At the end of the query we perform a <em>sum</em> step against the sack
which will contain a list holding number of runways for each individual airport so we
need to add all of those to get a single grand total.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">sack</span><span class="tok-o">(</span><span class="tok-n">assign</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">)).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span>
      <span class="tok-n">sack</span><span class="tok-o">(</span><span class="tok-n">sum</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span>
      <span class="tok-n">sack</span><span class="tok-o">().</span><span class="tok-na">sum</span><span class="tok-o">()</span>

<span class="tok-mi">212</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="latlonmanual">5.4. Using latitude, longitude and geographical region in queries</h3>
<div class="paragraph">
<p>The <em>air-routes</em> graph stores the geographic coordinates (latitude and longitude) of
each airport as floating point numbers. Some graph systems such as JanusGraph have
geographic coordinate and shape (geospatial) functions built in, but TinkerGraph does
not. Moreover, GraphML does not offer any specific geospatial support. To keep
things simple and flexible, the air routes data set does not assume any specific back
end capabilities. Having coordinates provided as basic floating point
numbers still allows us to write some interesting geospatial queries.</p>
</div>
<div class="paragraph">
<p>So far, we have not taken advantage of these latitude and longitude coordinates in
queries. In this section I have included some queries that perform interesting
geospatial calculations using just the standard Gremlin steps.</p>
</div>
<div class="paragraph">
<p>Here is a simple query that finds any airports located North of 77 degrees latitude.
Note that a <em>where</em> step could be used instead of <em>filter</em> as they are synonymous in
this case.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">filter</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">77</span><span class="tok-o">))).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'lat'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As discussed earlier in the book, you can often just use <em>has</em> steps instead of
<em>where</em> or <em>filter</em> steps. We could have written the previous query as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">,</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">77</span><span class="tok-o">)).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'lat'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It turns out that just two airports in the graph are located that far North as shown
below in the results from running either form of the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-o">[</span><span class="tok-n">Longyearbyen</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">78.2461013793945</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-o">[</span><span class="tok-n">Qaanaaq</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">77.4886016846</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could modify our query to look for airports with a latitude value outside of a
provided upper and lower bound thus finding the most Northerly and Southerly airports
with a single query. Here is a simple example of such a query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">,</span><span class="tok-n">outside</span><span class="tok-o">(-</span><span class="tok-mi">50</span><span class="tok-o">,</span><span class="tok-mi">77</span><span class="tok-o">)).</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">,</span><span class="tok-n">asc</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'lat'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the airports found by running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-o">[</span><span class="tok-n">Ushuahia</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[-</span><span class="tok-mf">54.8433</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-o">[</span><span class="tok-n">Rio</span> <span class="tok-n">Grande</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[-</span><span class="tok-mf">53.7777</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-o">[</span><span class="tok-n">Punta</span> <span class="tok-n">Arenas</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[-</span><span class="tok-mf">53.0026016235352</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-o">[</span><span class="tok-n">Mount</span> <span class="tok-n">Pleasant</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[-</span><span class="tok-mf">51.8227996826172</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-o">[</span><span class="tok-n">Stanley</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[-</span><span class="tok-mf">51.6856994628906</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-o">[</span><span class="tok-n">Puerto</span> <span class="tok-n">Natales</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[-</span><span class="tok-mf">51.671501159668</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-o">[</span><span class="tok-n">Rio</span> <span class="tok-n">Gallegos</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[-</span><span class="tok-mf">51.6089</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-o">[</span><span class="tok-n">El</span> <span class="tok-n">Calafate</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[-</span><span class="tok-mf">50.2803001404</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-o">[</span><span class="tok-n">Qaanaaq</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">77.4886016846</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">city:</span><span class="tok-o">[</span><span class="tok-n">Longyearbyen</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">78.2461013793945</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that while writing the above query it might have seemed appropriate to use a
<em>without</em> step with a range such as <em>-50..77</em> but that will not work as without looks
for exact matches against the values in the range and the range generated is of the
form <em>-50,-49,-48</em> and so on, so the only airports that would get filtered out would
be the ones having a latitude value that exactly matches one of the values generated
by the range. This is why the <em>outside</em> step is so useful in cases like this.</p>
</div>
<div class="paragraph">
<p>This next query just returns the coordinates for London Heathrow.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Query latitude and longitude for LHR</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">,</span><span class="tok-s1">'lon'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">0.461941003799</span><span class="tok-o">],</span> <span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.4706001282</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This next query returns the code, latitude and longitude for all airports in London,
England. Note that because there are other cities in the world also called London,
such as London, Ontario in Canada, we have to take advantage of the region code
<em>GB-ENG</em> to only return airports in London, England.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'London'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'GB-ENG'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'lat'</span><span class="tok-o">,</span><span class="tok-s1">'lon'</span><span class="tok-o">)</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">],</span> <span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">0.461941003799</span><span class="tok-o">],</span> <span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.4706001282</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">],</span> <span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">0.190277993679047</span><span class="tok-o">],</span> <span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.1481018066406</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LCY</span><span class="tok-o">],</span> <span class="tok-nl">lon:</span><span class="tok-o">[</span><span class="tok-mf">0.055278</span><span class="tok-o">],</span> <span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.505278</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">STN</span><span class="tok-o">],</span> <span class="tok-nl">lon:</span><span class="tok-o">[</span><span class="tok-mf">0.234999999404</span><span class="tok-o">],</span> <span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.8849983215</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LTN</span><span class="tok-o">],</span> <span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">0.368333011865616</span><span class="tok-o">],</span> <span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.874698638916</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we know how to query the geographic coordinates, we can write a query to
find out which airports in the graph are very close to the Greenwich Meridian. In
this case we will look for any airports that have a longitude between -0.1 and 0.1</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Which airports are very close to the Greenwich Meridian ?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">,</span><span class="tok-n">between</span><span class="tok-o">(-</span><span class="tok-mf">0.1</span><span class="tok-o">,</span><span class="tok-mf">0.1</span><span class="tok-o">)).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'lon'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LCY</span><span class="tok-o">],</span> <span class="tok-nl">lon:</span><span class="tok-o">[</span><span class="tok-mf">0.055278</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LDE</span><span class="tok-o">],</span> <span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">0.006438999902457</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LEH</span><span class="tok-o">],</span> <span class="tok-nl">lon:</span><span class="tok-o">[</span><span class="tok-mf">0.0880559980869293</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">CDT</span><span class="tok-o">],</span> <span class="tok-nl">lon:</span><span class="tok-o">[</span><span class="tok-mf">0.0261109992862</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This next query can be used to find out which airports are closest to the equator.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Which airports are closest to the Equator ?</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">,</span><span class="tok-n">between</span><span class="tok-o">(-</span><span class="tok-mf">0.1</span><span class="tok-o">,</span><span class="tok-mf">0.1</span><span class="tok-o">)).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'lat'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">EBB</span><span class="tok-o">],</span> <span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">0.0423859991133213</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">MDK</span><span class="tok-o">],</span> <span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">0.0226000007242</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">KIS</span><span class="tok-o">],</span> <span class="tok-nl">lat:</span><span class="tok-o">[-</span><span class="tok-mf">0.0861390009522438</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">MCP</span><span class="tok-o">],</span> <span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">0.0506640002131</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LGQ</span><span class="tok-o">],</span> <span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">0.0930560007691</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The code below will find all the airports in the geographic area defined by a one
degree box around London Heathrow. This type of thing can be done using the Geo shape
classes provided by JanusGraph but given we are not at that part of the book yet
this is the next best way!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">lat</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span>
<span class="tok-n">lon</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">and</span><span class="tok-o">(</span>
                          <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">between</span><span class="tok-o">(</span><span class="tok-n">lon</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">lon</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-o">)),</span>
                          <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">between</span><span class="tok-o">(</span><span class="tok-n">lat</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">lat</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-o">)))).</span>
                          <span class="tok-n">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'lat'</span><span class="tok-o">,</span><span class="tok-s1">'lon'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As we have discussed earlier in this book, it is often possible to avoid use of
<em>and</em> step by chaining <em>has</em> steps together. The code below is equivalent to the code
above but avoids the use of <em>where</em> and <em>and</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">lat</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span>
<span class="tok-n">lon</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">,</span><span class="tok-n">between</span><span class="tok-o">(</span><span class="tok-n">lon</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">lon</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-o">)).</span>
                          <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">,</span><span class="tok-n">between</span><span class="tok-o">(</span><span class="tok-n">lat</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">lat</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-o">)).</span>
                          <span class="tok-n">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'lat'</span><span class="tok-o">,</span><span class="tok-s1">'lon'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the output produced by running either of the snippets of code above inside
the Gremlin Console.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">0.461941003799</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.4706001282</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">0.190277993679047</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.1481018066406</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LCY</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[</span><span class="tok-mf">0.055278</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.505278</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">STN</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[</span><span class="tok-mf">0.234999999404</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.8849983215</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LTN</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">0.368333011865616</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.874698638916</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">SOU</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">1.35679996013641</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">50.9502983093262</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#tranges">Testing values and ranges of values</a>" section we came up with a query (shown below) to find routes
with one stop between Austin and Las Vegas, using only airports in the United States
or Canada and avoiding PHX and LAX for plane changes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'US'</span><span class="tok-o">,</span><span class="tok-s1">'CA'</span><span class="tok-o">)).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">without</span><span class="tok-o">(</span><span class="tok-s1">'PHX'</span><span class="tok-o">,</span><span class="tok-s1">'LAX'</span><span class="tok-o">)).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LAS'</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we know how to use the longitude and latitude coordinates stored in the air
routes graph, we could for fun, write this query a different way. If you take a look
at the query below you will see we have added a <em>where</em> step. We still check that we
are only looking at airports in the United States or Canada but then, in the <em>where</em>
step, we further limit the airports we want to consider further by saying we are only
interested if their longitude value is less than that of Austin. In other words, we
only want to change planes at an airport that is to the West of Austin. This is
actually an improvement on the previous query that would have returned routes that
included plane changes in New York and Nashville among other places. With our new
query, no airport that is East of Austin will be considered as a place to change
planes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// AUS to LAS with one stop but the stop has to be in the US or Canada</span>
<span class="tok-c1">// and West of Austin while avoiding PHX and LAX.</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'aus'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'US'</span><span class="tok-o">,</span><span class="tok-s1">'CA'</span><span class="tok-o">)).</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">lt</span><span class="tok-o">(</span><span class="tok-s1">'aus'</span><span class="tok-o">)).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">without</span><span class="tok-o">(</span><span class="tok-s1">'PHX'</span><span class="tok-o">,</span><span class="tok-s1">'LAX'</span><span class="tok-o">)).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LAS'</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Below you will find the output from running the query. If you know your airport codes
you will see that all of these airports are indeed to the West of Austin. We might
want to improve the query even more however, to factor in sensible nearby airports
that are not to the West of Austin. For example, Dallas Fort Worth (DFW) is not
included in the results as it is situated North of Austin but also a little to the
East. We will leave it as an exercise to come up with a refinement to the query so
that Dallas is also included!.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">PDX</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">ABQ</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LBB</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">SEA</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">SJC</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">SAN</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LGB</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">SNA</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">SLC</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DEN</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">ELP</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">OAK</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is one more example that is similar to the previous one. First of all we store
the longitude of the Dallas (DFW) airport in the variable <em>dfw</em>. Then we use that
variable to find routes to Las Vegas (LAS) from Austin (AUS) that have one stop but
avoid Phoenix (PHX) and Los Angeles (LAX) and only have a plane change either in
Dallas or to the West of Dallas. Note that we use <em>lte</em> and not <em>lt</em> when testing the
longitude value. It we used <em>lt</em> instead that would also rule out Dallas as an
option. This query, as in the prior one, has the effect of ruling out plane changes
at airports further to the East of Austin than Dallas.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">dfw</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'aus'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'US'</span><span class="tok-o">,</span><span class="tok-s1">'CA'</span><span class="tok-o">)).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">,</span><span class="tok-n">lte</span><span class="tok-o">(</span><span class="tok-n">dfw</span><span class="tok-o">)).</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">without</span><span class="tok-o">(</span><span class="tok-s1">'PHX'</span><span class="tok-o">,</span><span class="tok-s1">'LAX'</span><span class="tok-o">)).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LAS'</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is what we get back when we run the query. Still lots of choices even if we
avoid LAX and PHX it seems.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">PDX</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">ONT</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">ABQ</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LBB</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">SEA</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">SJC</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">SAN</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LGB</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">SNA</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">SLC</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DEN</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">ELP</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">OAK</span><span class="tok-o">,</span><span class="tok-n">LAS</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s look at one last query that uses the <em>region</em> property, present on all
airport vertices in the graph.</p>
</div>
<div class="paragraph">
<p>The query below starts at the DFW airport then looks for all routes to airports also
within the United States. Next those airports are grouped by their region code and
airport code. Finally a few states are selected. The query ends with an <em>unfold</em> step
to make the results a bit more readable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'US'</span><span class="tok-o">).</span>
      <span class="tok-n">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'US-CA'</span><span class="tok-o">,</span><span class="tok-s1">'US-TX'</span><span class="tok-o">,</span><span class="tok-s1">'US-FL'</span><span class="tok-o">,</span><span class="tok-s1">'US-CO'</span><span class="tok-o">,</span><span class="tok-s1">'US-IL'</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Below you can see the query results. Each of the selected states is listed along with
a list of airports reachable from DFW.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">CA</span><span class="tok-o">=[</span><span class="tok-n">LAX</span><span class="tok-o">,</span> <span class="tok-n">SFO</span><span class="tok-o">,</span> <span class="tok-n">SJC</span><span class="tok-o">,</span> <span class="tok-n">SAN</span><span class="tok-o">,</span> <span class="tok-n">SNA</span><span class="tok-o">,</span> <span class="tok-n">OAK</span><span class="tok-o">,</span> <span class="tok-n">ONT</span><span class="tok-o">,</span> <span class="tok-n">PSP</span><span class="tok-o">,</span> <span class="tok-n">SMF</span><span class="tok-o">,</span> <span class="tok-n">FAT</span><span class="tok-o">,</span> <span class="tok-n">SBA</span><span class="tok-o">]</span>
<span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span><span class="tok-o">=[</span><span class="tok-n">AUS</span><span class="tok-o">,</span> <span class="tok-n">IAH</span><span class="tok-o">,</span> <span class="tok-n">SAT</span><span class="tok-o">,</span> <span class="tok-n">HOU</span><span class="tok-o">,</span> <span class="tok-n">ELP</span><span class="tok-o">,</span> <span class="tok-n">LBB</span><span class="tok-o">,</span> <span class="tok-n">MAF</span><span class="tok-o">,</span> <span class="tok-n">CRP</span><span class="tok-o">,</span> <span class="tok-n">ABI</span><span class="tok-o">,</span> <span class="tok-n">ACT</span><span class="tok-o">,</span> <span class="tok-n">CLL</span><span class="tok-o">,</span>
       <span class="tok-n">BPT</span><span class="tok-o">,</span> <span class="tok-n">AMA</span><span class="tok-o">,</span> <span class="tok-n">BRO</span><span class="tok-o">,</span> <span class="tok-n">GGG</span><span class="tok-o">,</span> <span class="tok-n">GRK</span><span class="tok-o">,</span> <span class="tok-n">LRD</span><span class="tok-o">,</span> <span class="tok-n">MFE</span><span class="tok-o">,</span> <span class="tok-n">SJT</span><span class="tok-o">,</span> <span class="tok-n">SPS</span><span class="tok-o">,</span> <span class="tok-n">TYR</span><span class="tok-o">]</span>
<span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">FL</span><span class="tok-o">=[</span><span class="tok-n">FLL</span><span class="tok-o">,</span> <span class="tok-n">MCO</span><span class="tok-o">,</span> <span class="tok-n">MIA</span><span class="tok-o">,</span> <span class="tok-n">PBI</span><span class="tok-o">,</span> <span class="tok-n">TPA</span><span class="tok-o">,</span> <span class="tok-n">RSW</span><span class="tok-o">,</span> <span class="tok-n">TLH</span><span class="tok-o">,</span> <span class="tok-n">JAX</span><span class="tok-o">,</span> <span class="tok-n">PNS</span><span class="tok-o">,</span> <span class="tok-n">VPS</span><span class="tok-o">]</span>
<span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">CO</span><span class="tok-o">=[</span><span class="tok-n">DEN</span><span class="tok-o">,</span> <span class="tok-n">COS</span><span class="tok-o">,</span> <span class="tok-n">DRO</span><span class="tok-o">,</span> <span class="tok-n">GJT</span><span class="tok-o">,</span> <span class="tok-n">EGE</span><span class="tok-o">,</span> <span class="tok-n">HDN</span><span class="tok-o">,</span> <span class="tok-n">ASE</span><span class="tok-o">,</span> <span class="tok-n">GUC</span><span class="tok-o">,</span> <span class="tok-n">MTJ</span><span class="tok-o">]</span>
<span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">IL</span><span class="tok-o">=[</span><span class="tok-n">ORD</span><span class="tok-o">,</span> <span class="tok-n">PIA</span><span class="tok-o">,</span> <span class="tok-n">BMI</span><span class="tok-o">,</span> <span class="tok-n">CMI</span><span class="tok-o">,</span> <span class="tok-n">MLI</span><span class="tok-o">,</span> <span class="tok-n">SPI</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the next section we will look at a more complicated query that builds upon the
examples above and performs distance calculations using the latitude and longitude
coordinates present on the airport vertices.</p>
</div>
<div class="sect3">
<h4 id="GreatCircle">5.4.1. Using the <em>math</em> step to calculate Great Circle distances</h4>
<div class="paragraph">
<p>If the latitude and longitude of two places on the Earth are known, the approximate
distance between them can be calculated using the Haversine Great Circle Distance
formula. The formula includes some trigonometrical calculations that can be done in
Gremlin using the <em>math</em> step.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you are interested in better understanding the mathematics used by the
Haversine formula, details can be found
<a href="https://en.wikipedia.org/wiki/Haversine_formula">here</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>In this section I have included two queries. The first calculates the distance
between Austin and Dallas Fort Worth using a somewhat inflexible approach. This
reflects my first attempt to create a query that computes Great Circle distances all
in Gremlin. The airport codes are embedded in the query. Having got that working I
realized a more generic query would be better. The second example allows an arbitrary
source and destination to be specified.</p>
</div>
<div class="paragraph">
<p>Let’s take a look at the queries. At first, the number of steps used may look a bit
daunting, but if you work your way through it section by section it’s actually fairly
straightforward. The Haversine formula needs a couple of constant values. These are
injected into the query using <em>withSideEffect</em> steps. The first constant, <em>rdeg</em>
represents one degree in radians. This is the result from dividing PI by 180. The
second constant <em>gcmiles</em> represents the average radius of the Earth in miles. This
allows for the imperfect spherical shape of the Earth where the radius varies closer
to the poles.</p>
</div>
<div class="paragraph">
<p>In my first attempt at producing a query, I used a <em>has</em> step to find the AUS and DFW
airports and then produced a group with the airport codes being the keys and a
projection of their latitude and longitude being the values. If we take just that
part of the query and run it this is what we get back.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSideEffect</span><span class="tok-o">(</span><span class="tok-s2">"rdeg"</span><span class="tok-o">,</span> <span class="tok-mf">0.017453293</span><span class="tok-o">).</span>
  <span class="tok-n">withSideEffect</span><span class="tok-o">(</span><span class="tok-s2">"gcmiles"</span><span class="tok-o">,</span><span class="tok-mi">3956</span><span class="tok-o">).</span>
  <span class="tok-n">V</span><span class="tok-o">().</span>
  <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'AUS'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">)).</span>
  <span class="tok-n">group</span><span class="tok-o">().</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">,</span><span class="tok-s1">'lon'</span><span class="tok-o">).</span>
      <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">).</span>
      <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">))</span>

<span class="tok-o">[</span><span class="tok-nl">DFW:</span><span class="tok-o">[</span><span class="tok-nl">lat:</span><span class="tok-mf">32.896800994873</span><span class="tok-o">,</span><span class="tok-nl">lon:</span><span class="tok-o">-</span><span class="tok-mf">97.0380020141602</span><span class="tok-o">],</span>
 <span class="tok-nl">AUS:</span><span class="tok-o">[</span><span class="tok-nl">lat:</span><span class="tok-mf">30.1944999694824</span><span class="tok-o">,</span><span class="tok-nl">lon:</span><span class="tok-o">-</span><span class="tok-mf">97.6698989868164</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Haversine formula requires us to calculate the differences between the latitude
and longitude of the two coordinates. The next part of the query does that. A project
step <em>project('ladiff</em>,<em>lgdiff</em>,<em>lat1</em>,<em>lon1</em>,<em>lat2</em>,<em>lon2</em>)' is used to collect all
the values we need.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSideEffect</span><span class="tok-o">(</span><span class="tok-s2">"rdeg"</span><span class="tok-o">,</span> <span class="tok-mf">0.017453293</span><span class="tok-o">).</span>
  <span class="tok-n">withSideEffect</span><span class="tok-o">(</span><span class="tok-s2">"gcmiles"</span><span class="tok-o">,</span><span class="tok-mi">3956</span><span class="tok-o">).</span>
  <span class="tok-n">V</span><span class="tok-o">().</span>
  <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'AUS'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">)).</span>
  <span class="tok-n">group</span><span class="tok-o">().</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">,</span><span class="tok-s1">'lon'</span><span class="tok-o">).</span>
      <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">).</span>
      <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">)).</span>
  <span class="tok-k">as</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span>
  <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'ladiff'</span><span class="tok-o">,</span><span class="tok-s1">'lgdiff'</span><span class="tok-o">,</span><span class="tok-s1">'lat1'</span><span class="tok-o">,</span><span class="tok-s1">'lon1'</span><span class="tok-o">,</span><span class="tok-s1">'lat2'</span><span class="tok-o">,</span><span class="tok-s1">'lon2'</span><span class="tok-o">).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'la1'</span><span class="tok-o">,</span><span class="tok-s1">'la2'</span><span class="tok-o">).</span>
         <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">)).</span>
         <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">)).</span>
       <span class="tok-n">math</span><span class="tok-o">(</span><span class="tok-s1">'(la2 - la1) * rdeg'</span><span class="tok-o">)).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'lg1'</span><span class="tok-o">,</span><span class="tok-s1">'lg2'</span><span class="tok-o">).</span>
         <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">)).</span>
         <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">)).</span>
       <span class="tok-n">math</span><span class="tok-o">(</span><span class="tok-s1">'(lg2 - lg1) * rdeg'</span><span class="tok-o">)).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">)).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">)).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">)).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results. A map has been generated containing the differences as well as
the original coordinates.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">ladiff:</span><span class="tok-mf">0.04716405157034253</span><span class="tok-o">,</span>
 <span class="tok-nl">lgdiff:</span><span class="tok-mf">0.011028683009581777</span><span class="tok-o">,</span>
 <span class="tok-nl">lat1:</span><span class="tok-mf">30.1944999694824</span><span class="tok-o">,</span>
 <span class="tok-nl">lon1:</span><span class="tok-o">-</span><span class="tok-mf">97.6698989868164</span><span class="tok-o">,</span>
 <span class="tok-nl">lat2:</span><span class="tok-mf">32.896800994873</span><span class="tok-o">,</span>
 <span class="tok-nl">lon2:</span><span class="tok-o">-</span><span class="tok-mf">97.0380020141602</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The purpose of collecting the values like this is so they can be fed into the <em>math</em>
step to complete the calculation. One key takeaway from this example is the way that
a <em>math</em> step can be fed values from a prior <em>project</em> step. The final calculations
perform the necessary trigonometry as required by the Haversine formula. Here is the
complete version of my first attempt at solving this problem in Gremlin.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSideEffect</span><span class="tok-o">(</span><span class="tok-s2">"rdeg"</span><span class="tok-o">,</span> <span class="tok-mf">0.017453293</span><span class="tok-o">).</span>
  <span class="tok-n">withSideEffect</span><span class="tok-o">(</span><span class="tok-s2">"gcmiles"</span><span class="tok-o">,</span><span class="tok-mi">3956</span><span class="tok-o">).</span>
  <span class="tok-n">V</span><span class="tok-o">().</span>
  <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'AUS'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">)).</span>
  <span class="tok-n">group</span><span class="tok-o">().</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">,</span><span class="tok-s1">'lon'</span><span class="tok-o">).</span>
      <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">).</span>
      <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">)).</span>
  <span class="tok-k">as</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span>
  <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'ladiff'</span><span class="tok-o">,</span><span class="tok-s1">'lgdiff'</span><span class="tok-o">,</span><span class="tok-s1">'lat1'</span><span class="tok-o">,</span><span class="tok-s1">'lon1'</span><span class="tok-o">,</span><span class="tok-s1">'lat2'</span><span class="tok-o">,</span><span class="tok-s1">'lon2'</span><span class="tok-o">).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'la1'</span><span class="tok-o">,</span><span class="tok-s1">'la2'</span><span class="tok-o">).</span>
         <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">)).</span>
         <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">)).</span>
       <span class="tok-n">math</span><span class="tok-o">(</span><span class="tok-s1">'(la2 - la1) * rdeg'</span><span class="tok-o">)).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'lg1'</span><span class="tok-o">,</span><span class="tok-s1">'lg2'</span><span class="tok-o">).</span>
         <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">)).</span>
         <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">)).</span>
       <span class="tok-n">math</span><span class="tok-o">(</span><span class="tok-s1">'(lg2 - lg1) * rdeg'</span><span class="tok-o">)).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">)).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">)).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">)).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">)).</span>
  <span class="tok-n">math</span><span class="tok-o">(</span><span class="tok-s1">'(sin(ladiff/2))^2 + cos(lat1*rdeg) * cos(lat2*rdeg) * (sin(lgdiff/2))^2'</span><span class="tok-o">).</span>
  <span class="tok-n">math</span><span class="tok-o">(</span><span class="tok-s1">'gcmiles * (2 * asin(sqrt(_)))'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can see that the distance from Austin to Dallas Fort Worth is approximately 190
miles.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-mf">190.2483140396514</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A few adjustments are needed to make the query more flexible. I wanted to have a
query where you just provide any two airport codes at the start. This makes it easy
to parameterize the query when working with code. The main difference from my first
attempt is that the source and target airports are located at the start and
individually labelled. The <code>group</code> step is replaced by a <code>select</code> step and given a
label of "grp". The remainder of the query refers to "grp" as needed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSideEffect</span><span class="tok-o">(</span><span class="tok-s2">"rdeg"</span><span class="tok-o">,</span> <span class="tok-mf">0.017453293</span><span class="tok-o">).</span>
  <span class="tok-n">withSideEffect</span><span class="tok-o">(</span><span class="tok-s2">"gcmiles"</span><span class="tok-o">,</span><span class="tok-mi">3956</span><span class="tok-o">).</span>
  <span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'src'</span><span class="tok-o">).</span>
  <span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'dst'</span><span class="tok-o">).</span>
  <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'src'</span><span class="tok-o">,</span><span class="tok-s1">'dst'</span><span class="tok-o">).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">,</span><span class="tok-s1">'lon'</span><span class="tok-o">).</span>
         <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">).</span>
         <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">)).</span>
  <span class="tok-k">as</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span>
  <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'ladiff'</span><span class="tok-o">,</span><span class="tok-s1">'lgdiff'</span><span class="tok-o">,</span><span class="tok-s1">'lat1'</span><span class="tok-o">,</span><span class="tok-s1">'lon1'</span><span class="tok-o">,</span><span class="tok-s1">'lat2'</span><span class="tok-o">,</span><span class="tok-s1">'lon2'</span><span class="tok-o">).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'la1'</span><span class="tok-o">,</span><span class="tok-s1">'la2'</span><span class="tok-o">).</span>
         <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'src'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">)).</span>
         <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'dst'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">)).</span>
       <span class="tok-n">math</span><span class="tok-o">(</span><span class="tok-s1">'(la2 - la1) * rdeg'</span><span class="tok-o">)).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'lg1'</span><span class="tok-o">,</span><span class="tok-s1">'lg2'</span><span class="tok-o">).</span>
         <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'src'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">)).</span>
         <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'dst'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">)).</span>
       <span class="tok-n">math</span><span class="tok-o">(</span><span class="tok-s1">'(lg2 - lg1) * rdeg'</span><span class="tok-o">)).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'src'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">)).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'src'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">)).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'dst'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">)).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'dst'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">)).</span>
  <span class="tok-n">math</span><span class="tok-o">(</span><span class="tok-s1">'(sin(ladiff/2))^2 + cos(lat1*rdeg) * cos(lat2*rdeg) * (sin(lgdiff/2))^2'</span><span class="tok-o">).</span>
  <span class="tok-n">math</span><span class="tok-o">(</span><span class="tok-s1">'gcmiles * (2 * asin(sqrt(_)))'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The result from the more general purpose version of the query is the same as before.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-mf">190.2483140396514</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The code for this query is available in the sample-code folder at <a href="https://github.com/krlawrence/graph/blob/master/sample-code/great-circle.groovy" class="bare">https://github.com/krlawrence/graph/blob/master/sample-code/great-circle.groovy</a>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>We can go one step further and parameterize the query. Everything shown below can be
done using the Gremlin Console but it also represents the way you might use this
query within an application. This time San Francisco and Tokyo Narita are used as the
origin and destination.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">start</span> <span class="tok-o">=</span> <span class="tok-s1">'SFO'</span>
<span class="tok-n">stop</span> <span class="tok-o">=</span> <span class="tok-s1">'NRT'</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSideEffect</span><span class="tok-o">(</span><span class="tok-s2">"rdeg"</span><span class="tok-o">,</span> <span class="tok-mf">0.017453293</span><span class="tok-o">).</span>
  <span class="tok-n">withSideEffect</span><span class="tok-o">(</span><span class="tok-s2">"gcmiles"</span><span class="tok-o">,</span><span class="tok-mi">3956</span><span class="tok-o">).</span>
  <span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">start</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'src'</span><span class="tok-o">).</span>
  <span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">stop</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'dst'</span><span class="tok-o">).</span>
  <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'src'</span><span class="tok-o">,</span><span class="tok-s1">'dst'</span><span class="tok-o">).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">,</span><span class="tok-s1">'lon'</span><span class="tok-o">).</span>
         <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">).</span>
         <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">)).</span>
  <span class="tok-k">as</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span>
  <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'ladiff'</span><span class="tok-o">,</span><span class="tok-s1">'lgdiff'</span><span class="tok-o">,</span><span class="tok-s1">'lat1'</span><span class="tok-o">,</span><span class="tok-s1">'lon1'</span><span class="tok-o">,</span><span class="tok-s1">'lat2'</span><span class="tok-o">,</span><span class="tok-s1">'lon2'</span><span class="tok-o">).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'la1'</span><span class="tok-o">,</span><span class="tok-s1">'la2'</span><span class="tok-o">).</span>
         <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'src'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">)).</span>
         <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'dst'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">)).</span>
       <span class="tok-n">math</span><span class="tok-o">(</span><span class="tok-s1">'(la2 - la1) * rdeg'</span><span class="tok-o">)).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'lg1'</span><span class="tok-o">,</span><span class="tok-s1">'lg2'</span><span class="tok-o">).</span>
         <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'src'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">)).</span>
         <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'dst'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">)).</span>
       <span class="tok-n">math</span><span class="tok-o">(</span><span class="tok-s1">'(lg2 - lg1) * rdeg'</span><span class="tok-o">)).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'src'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">)).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'src'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">)).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'dst'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">)).</span>
    <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'grp'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'dst'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">)).</span>
  <span class="tok-n">math</span><span class="tok-o">(</span><span class="tok-s1">'(sin(ladiff/2))^2 + cos(lat1*rdeg) * cos(lat2*rdeg) * (sin(lgdiff/2))^2'</span><span class="tok-o">).</span>
  <span class="tok-n">math</span><span class="tok-o">(</span><span class="tok-s1">'gcmiles * (2 * asin(sqrt(_)))'</span><span class="tok-o">)</span>

<span class="tok-mf">5108.80166113392</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We will revisit the topic of performing geospatial queries in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#janusgeo">The JanusGraph GeoSpatial API</a>"
section where some additional capabilities that JanusGraph offers are discussed.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="via">5.5. Finding routes that go via a specific airport</h3>
<div class="paragraph">
<p>We have seen a number of examples that use a <em>has</em> step to filter routes. The example
below looks for five routes that start in Austin (AUS) and go via Dallas (DFW).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span>
      <span class="tok-n">out</span><span class="tok-o">().</span>
      <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When run the query, as expected finds us five routes that start in AUS and stop at
DFW on the way.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">ANC</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">BNA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This technique works well if we know which stop we want to be in DFW. However, we
might want to write a query that can only return results that include a visit to a
specific airport anywhere in the journey. Let’s build an example in two stages. First
of all look at the query below. It looks for ten routes that start in Austin and end
up in Edinburgh only stopping along the way in US or the UK airports.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span>
  <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
  <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'US'</span><span class="tok-o">,</span><span class="tok-s1">'UK'</span><span class="tok-o">))).</span>
    <span class="tok-n">until</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'EDI'</span><span class="tok-o">)).</span>
  <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
  <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When run we get the following results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">BHD</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">INV</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">PIT</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">PIT</span><span class="tok-o">,</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, for the sake of making the example more interesting, let’s assume that we
only want to get back routes that go via Manchester (MAN). We can do this by
adjusting the prior query to look for "MAN" as it traverses the graph and keep track,
using  a sack, of paths that encounter Manchester along the way. Once we arrive at
EDI we use a <em>where</em> step to filter out routes where the value of the sack is
anything but "1". A value of "1" means we encountered Manchester along the way.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">).</span><span class="tok-na">V</span><span class="tok-o">().</span>
  <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
  <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'US'</span><span class="tok-o">,</span><span class="tok-s1">'UK'</span><span class="tok-o">)).</span>
         <span class="tok-n">choose</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'MAN'</span><span class="tok-o">),</span><span class="tok-n">sack</span><span class="tok-o">(</span><span class="tok-n">sum</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">constant</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)))).</span>
    <span class="tok-n">until</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'EDI'</span><span class="tok-o">)).</span>
  <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">sack</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)).</span>
  <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
  <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When the modified query is run, each result includes MAN in the path.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">IAD</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">MCO</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">ORD</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we you increase the limit step to use a value such as 30, then you will start to
see that MAN can appear in any position in the path.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">GLA</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">ABZ</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">BHD</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">INV</span><span class="tok-o">,</span><span class="tok-n">MAN</span><span class="tok-o">,</span><span class="tok-n">EDI</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="storesideeffect">5.6. Using <em>store</em> and a <em>sideEffect</em> to make a set of unique values</h3>
<div class="paragraph">
<p>Take a look at the query below. All it does is return the city names for the airports
that have IDs between 1 and 200 (inclusive). The list is sorted by ascending aplhabetic
order.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-n">between</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">201</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">fold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And here are the names that get returned. If you look closely at the list you
will see that city names like <em>Dallas</em> and <em>London</em> appear more than once.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">Abu</span> <span class="tok-n">Dhabi</span><span class="tok-o">,</span> <span class="tok-n">Addis</span> <span class="tok-n">Ababa</span><span class="tok-o">,</span> <span class="tok-n">Albuquerque</span><span class="tok-o">,</span> <span class="tok-n">Alicante</span><span class="tok-o">,</span> <span class="tok-n">Alice</span> <span class="tok-n">Springs</span><span class="tok-o">,</span> <span class="tok-n">Amsterdam</span><span class="tok-o">,</span> <span class="tok-n">Anchorage</span><span class="tok-o">,</span> <span class="tok-n">Athens</span><span class="tok-o">,</span> <span class="tok-n">Atlanta</span><span class="tok-o">,</span> <span class="tok-n">Auckland</span><span class="tok-o">,</span> <span class="tok-n">Austin</span><span class="tok-o">,</span> <span class="tok-n">Ayers</span> <span class="tok-n">Rock</span><span class="tok-o">,</span> <span class="tok-n">Baltimore</span><span class="tok-o">,</span> <span class="tok-n">Bankok</span><span class="tok-o">,</span> <span class="tok-n">Barcelona</span><span class="tok-o">,</span> <span class="tok-n">Beijing</span><span class="tok-o">,</span> <span class="tok-n">Belgrade</span><span class="tok-o">,</span> <span class="tok-n">Bengaluru</span><span class="tok-o">,</span> <span class="tok-n">Berlin</span><span class="tok-o">,</span> <span class="tok-n">Bilbao</span><span class="tok-o">,</span> <span class="tok-n">Bologna</span><span class="tok-o">,</span> <span class="tok-n">Boston</span><span class="tok-o">,</span> <span class="tok-n">Brisbane</span><span class="tok-o">,</span> <span class="tok-n">Brussels</span><span class="tok-o">,</span> <span class="tok-n">Budapest</span><span class="tok-o">,</span> <span class="tok-n">Buenos</span> <span class="tok-n">Aires</span><span class="tok-o">,</span> <span class="tok-n">Cairns</span><span class="tok-o">,</span> <span class="tok-n">Cairo</span><span class="tok-o">,</span> <span class="tok-n">Calgary</span><span class="tok-o">,</span> <span class="tok-n">Calicut</span><span class="tok-o">,</span> <span class="tok-n">Canberra</span><span class="tok-o">,</span> <span class="tok-n">Cancun</span><span class="tok-o">,</span> <span class="tok-n">Cape</span> <span class="tok-n">Town</span><span class="tok-o">,</span> <span class="tok-n">Cedar</span> <span class="tok-n">Rapids</span><span class="tok-o">,</span> <span class="tok-n">Charlotte</span><span class="tok-o">,</span> <span class="tok-n">Chennai</span><span class="tok-o">,</span> <span class="tok-n">Chicago</span><span class="tok-o">,</span> <span class="tok-n">Chicago</span><span class="tok-o">,</span> <span class="tok-n">Christchurch</span><span class="tok-o">,</span> <span class="tok-n">Cincinnati</span><span class="tok-o">,</span> <span class="tok-n">Cleveland</span><span class="tok-o">,</span> <span class="tok-n">Cologne</span><span class="tok-o">,</span> <span class="tok-n">Copenhagen</span><span class="tok-o">,</span> <span class="tok-n">Dallas</span><span class="tok-o">,</span> <span class="tok-n">Dallas</span><span class="tok-o">,</span> <span class="tok-n">Denver</span><span class="tok-o">,</span> <span class="tok-n">Detroit</span><span class="tok-o">,</span> <span class="tok-n">Doha</span><span class="tok-o">,</span> <span class="tok-n">Dubai</span><span class="tok-o">,</span> <span class="tok-n">Dublin</span><span class="tok-o">,</span> <span class="tok-n">Durban</span><span class="tok-o">,</span> <span class="tok-n">Dusseldorf</span><span class="tok-o">,</span> <span class="tok-n">Edinburgh</span><span class="tok-o">,</span> <span class="tok-n">Edmonton</span><span class="tok-o">,</span> <span class="tok-n">El</span> <span class="tok-n">Paso</span><span class="tok-o">,</span> <span class="tok-n">Fairbanks</span><span class="tok-o">,</span> <span class="tok-n">Fort</span> <span class="tok-n">Lauderdale</span><span class="tok-o">,</span> <span class="tok-n">Fort</span> <span class="tok-n">Myers</span><span class="tok-o">,</span> <span class="tok-n">Frankfurt</span><span class="tok-o">,</span> <span class="tok-n">Geneva</span><span class="tok-o">,</span> <span class="tok-n">Genoa</span><span class="tok-o">,</span> <span class="tok-n">Glasgow</span><span class="tok-o">,</span> <span class="tok-n">Gold</span> <span class="tok-n">Coast</span><span class="tok-o">,</span> <span class="tok-n">Gothenburg</span><span class="tok-o">,</span> <span class="tok-n">Hagta</span><span class="tok-o">,</span> <span class="tok-n">Halifax</span><span class="tok-o">,</span> <span class="tok-n">Hamburg</span><span class="tok-o">,</span> <span class="tok-n">Harrison</span><span class="tok-o">,</span> <span class="tok-n">Helsinki</span><span class="tok-o">,</span> <span class="tok-n">Ho</span> <span class="tok-n">Chi</span> <span class="tok-n">Minh</span> <span class="tok-n">City</span><span class="tok-o">,</span> <span class="tok-n">Hong</span> <span class="tok-n">Kong</span><span class="tok-o">,</span> <span class="tok-n">Honolulu</span><span class="tok-o">,</span> <span class="tok-n">Houston</span><span class="tok-o">,</span> <span class="tok-n">Houston</span><span class="tok-o">,</span> <span class="tok-n">Hyderabad</span><span class="tok-o">,</span> <span class="tok-n">Ibiza</span><span class="tok-o">,</span> <span class="tok-n">Indianapolis</span><span class="tok-o">,</span> <span class="tok-n">Istanbul</span><span class="tok-o">,</span> <span class="tok-n">Johannesburg</span><span class="tok-o">,</span> <span class="tok-n">Kahului</span><span class="tok-o">,</span> <span class="tok-n">Kansas</span> <span class="tok-n">City</span><span class="tok-o">,</span> <span class="tok-n">Kingston</span><span class="tok-o">,</span> <span class="tok-n">Kolkata</span><span class="tok-o">,</span> <span class="tok-n">Kuala</span> <span class="tok-n">Lumpur</span><span class="tok-o">,</span> <span class="tok-n">Kuwait</span><span class="tok-o">,</span> <span class="tok-n">Larnaca</span><span class="tok-o">,</span> <span class="tok-n">Las</span> <span class="tok-n">Vegas</span><span class="tok-o">,</span> <span class="tok-n">Lima</span><span class="tok-o">,</span> <span class="tok-n">Liverpool</span><span class="tok-o">,</span> <span class="tok-n">London</span><span class="tok-o">,</span> <span class="tok-n">London</span><span class="tok-o">,</span> <span class="tok-n">London</span><span class="tok-o">,</span> <span class="tok-n">London</span><span class="tok-o">,</span> <span class="tok-n">Long</span> <span class="tok-n">Beach</span><span class="tok-o">,</span> <span class="tok-n">Los</span> <span class="tok-n">Angeles</span><span class="tok-o">,</span> <span class="tok-n">Luqa</span><span class="tok-o">,</span> <span class="tok-n">Luxembourg</span><span class="tok-o">,</span> <span class="tok-n">Madrid</span><span class="tok-o">,</span> <span class="tok-n">Manama</span><span class="tok-o">,</span> <span class="tok-n">Manchester</span><span class="tok-o">,</span> <span class="tok-n">Manila</span><span class="tok-o">,</span> <span class="tok-n">Maroochydore</span><span class="tok-o">,</span> <span class="tok-n">Melbourne</span><span class="tok-o">,</span> <span class="tok-n">Memphis</span><span class="tok-o">,</span> <span class="tok-n">Menorca</span><span class="tok-o">,</span> <span class="tok-n">Mexico</span> <span class="tok-n">City</span><span class="tok-o">,</span> <span class="tok-n">Miami</span><span class="tok-o">,</span> <span class="tok-n">Milan</span><span class="tok-o">,</span> <span class="tok-n">Milwaukee</span><span class="tok-o">,</span> <span class="tok-n">Minneapolis</span><span class="tok-o">,</span> <span class="tok-n">Mombasa</span><span class="tok-o">,</span> <span class="tok-n">Montevideo</span><span class="tok-o">,</span> <span class="tok-n">Montreal</span><span class="tok-o">,</span> <span class="tok-n">Moscow</span><span class="tok-o">,</span> <span class="tok-n">Moscow</span><span class="tok-o">,</span> <span class="tok-n">Mumbai</span><span class="tok-o">,</span> <span class="tok-n">Munich</span><span class="tok-o">,</span> <span class="tok-n">Nairobi</span><span class="tok-o">,</span> <span class="tok-n">Nantes</span><span class="tok-o">,</span> <span class="tok-n">Naples</span><span class="tok-o">,</span> <span class="tok-n">Nashville</span><span class="tok-o">,</span> <span class="tok-n">New</span> <span class="tok-n">Delhi</span><span class="tok-o">,</span> <span class="tok-n">New</span> <span class="tok-n">Orleans</span><span class="tok-o">,</span> <span class="tok-n">New</span> <span class="tok-n">York</span><span class="tok-o">,</span> <span class="tok-n">New</span> <span class="tok-n">York</span><span class="tok-o">,</span> <span class="tok-n">Newark</span><span class="tok-o">,</span> <span class="tok-n">Nice</span><span class="tok-o">,</span> <span class="tok-n">Nottingham</span><span class="tok-o">,</span> <span class="tok-n">Oaklahoma</span> <span class="tok-n">City</span><span class="tok-o">,</span> <span class="tok-n">Oakland</span><span class="tok-o">,</span> <span class="tok-n">Omaha</span><span class="tok-o">,</span> <span class="tok-n">Ontario</span><span class="tok-o">,</span> <span class="tok-n">Orlando</span><span class="tok-o">,</span> <span class="tok-n">Osaka</span><span class="tok-o">,</span> <span class="tok-n">Oslo</span><span class="tok-o">,</span> <span class="tok-n">Ottawa</span><span class="tok-o">,</span> <span class="tok-n">Palm</span> <span class="tok-n">Springs</span><span class="tok-o">,</span> <span class="tok-n">Paris</span><span class="tok-o">,</span> <span class="tok-n">Paris</span><span class="tok-o">,</span> <span class="tok-n">Perth</span><span class="tok-o">,</span> <span class="tok-n">Philadelphia</span><span class="tok-o">,</span> <span class="tok-n">Phnom</span> <span class="tok-n">Penh</span><span class="tok-o">,</span> <span class="tok-n">Phoenix</span><span class="tok-o">,</span> <span class="tok-n">Pisa</span><span class="tok-o">,</span> <span class="tok-n">Pittsburgh</span><span class="tok-o">,</span> <span class="tok-n">Portland</span><span class="tok-o">,</span> <span class="tok-n">Portland</span><span class="tok-o">,</span> <span class="tok-n">Prague</span><span class="tok-o">,</span> <span class="tok-n">Puerto</span> <span class="tok-n">Vallarta</span><span class="tok-o">,</span> <span class="tok-n">Raleigh</span><span class="tok-o">,</span> <span class="tok-n">Rio</span> <span class="tok-n">de</span> <span class="tok-n">Janeiro</span><span class="tok-o">,</span> <span class="tok-n">Rochester</span><span class="tok-o">,</span> <span class="tok-n">Rochester</span><span class="tok-o">,</span> <span class="tok-n">Rome</span><span class="tok-o">,</span> <span class="tok-n">Salina</span><span class="tok-o">,</span> <span class="tok-n">Salt</span> <span class="tok-n">Lake</span> <span class="tok-n">City</span><span class="tok-o">,</span> <span class="tok-n">San</span> <span class="tok-n">Antonio</span><span class="tok-o">,</span> <span class="tok-n">San</span> <span class="tok-n">Diego</span><span class="tok-o">,</span> <span class="tok-n">San</span> <span class="tok-n">Francisco</span><span class="tok-o">,</span> <span class="tok-n">San</span> <span class="tok-n">Jose</span><span class="tok-o">,</span> <span class="tok-n">San</span> <span class="tok-n">Juan</span><span class="tok-o">,</span> <span class="tok-n">Santa</span> <span class="tok-n">Ana</span><span class="tok-o">,</span> <span class="tok-n">Santa</span> <span class="tok-n">Fe</span><span class="tok-o">,</span> <span class="tok-n">Santiago</span><span class="tok-o">,</span> <span class="tok-n">Sao</span> <span class="tok-n">Paulo</span><span class="tok-o">,</span> <span class="tok-n">Seattle</span><span class="tok-o">,</span> <span class="tok-n">Seoul</span><span class="tok-o">,</span> <span class="tok-n">Shanghai</span><span class="tok-o">,</span> <span class="tok-n">Shannon</span><span class="tok-o">,</span> <span class="tok-n">Singapore</span><span class="tok-o">,</span> <span class="tok-n">Sofia</span><span class="tok-o">,</span> <span class="tok-n">St</span> <span class="tok-n">Louis</span><span class="tok-o">,</span> <span class="tok-n">St</span><span class="tok-o">.</span> <span class="tok-n">Johns</span><span class="tok-o">,</span> <span class="tok-n">Stockholm</span><span class="tok-o">,</span> <span class="tok-n">Stuttgart</span><span class="tok-o">,</span> <span class="tok-n">Sydney</span><span class="tok-o">,</span> <span class="tok-n">Tallahassee</span><span class="tok-o">,</span> <span class="tok-n">Tampa</span><span class="tok-o">,</span> <span class="tok-n">Tel</span> <span class="tok-n">Aviv</span><span class="tok-o">,</span> <span class="tok-n">Tenerife</span><span class="tok-o">,</span> <span class="tok-n">Tokyo</span><span class="tok-o">,</span> <span class="tok-n">Tokyo</span><span class="tok-o">,</span> <span class="tok-n">Toronto</span><span class="tok-o">,</span> <span class="tok-n">Tucson</span><span class="tok-o">,</span> <span class="tok-n">Tulsa</span><span class="tok-o">,</span> <span class="tok-n">Turin</span><span class="tok-o">,</span> <span class="tok-n">Vancouver</span><span class="tok-o">,</span> <span class="tok-n">Venice</span><span class="tok-o">,</span> <span class="tok-n">Venice</span><span class="tok-o">,</span> <span class="tok-n">Verona</span><span class="tok-o">,</span> <span class="tok-n">Vienna</span><span class="tok-o">,</span> <span class="tok-n">Warsaw</span><span class="tok-o">,</span> <span class="tok-n">Washington</span> <span class="tok-n">D</span><span class="tok-o">.</span><span class="tok-na">C</span><span class="tok-o">.,</span> <span class="tok-n">Washington</span> <span class="tok-n">D</span><span class="tok-o">.</span><span class="tok-na">C</span><span class="tok-o">.,</span> <span class="tok-n">Wellington</span><span class="tok-o">,</span> <span class="tok-n">West</span> <span class="tok-n">Palm</span> <span class="tok-n">Beach</span><span class="tok-o">,</span> <span class="tok-n">White</span> <span class="tok-n">Plains</span><span class="tok-o">,</span> <span class="tok-n">Winnipeg</span><span class="tok-o">,</span> <span class="tok-n">Zagreb</span><span class="tok-o">,</span> <span class="tok-n">Zurich</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Just to be sure, we can count how many city names we got back.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-n">between</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">201</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">200</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>What would be nice is if the duplicate names only appeared once. There are other ways
we could write this query such as using <em>dedup</em> but let’s rewrite it using <em>store</em>
and a <em>Set</em> as I think doing that demonstrates a capability quite well that is
useful in more complex scenarios than this one. By starting a query using
<em>withSideEffect</em> we can setup a named place we can <em>store</em> things into later in our
query and we can also give the store a type. In this case I chose to use a <em>Set</em>.
What this query does is store the City names of the first 200 vertices in the graph into
a Set and then displays them. As we know from our first attempt, city names, like
Dallas, appear more than once. However if we look at the Set that we get back from
our modified query (because by default Sets do not store duplicates) we will only see the
names Dallas and London appearing once.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSideEffect</span><span class="tok-o">(</span><span class="tok-s2">"x"</span><span class="tok-o">,</span> <span class="tok-o">[]</span> <span class="tok-k">as</span> <span class="tok-n">Set</span><span class="tok-o">).</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-n">between</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">201</span><span class="tok-o">)).</span>
  <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">store</span><span class="tok-o">(</span><span class="tok-s1">'x'</span><span class="tok-o">).</span><span class="tok-na">cap</span><span class="tok-o">(</span><span class="tok-s1">'x'</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">().</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">fold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the city names that we get back after running our modified query. You will notice
that all of the duplicate names are now gone.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">Abu</span> <span class="tok-n">Dhabi</span><span class="tok-o">,</span> <span class="tok-n">Addis</span> <span class="tok-n">Ababa</span><span class="tok-o">,</span> <span class="tok-n">Albuquerque</span><span class="tok-o">,</span> <span class="tok-n">Alicante</span><span class="tok-o">,</span> <span class="tok-n">Alice</span> <span class="tok-n">Springs</span><span class="tok-o">,</span> <span class="tok-n">Amsterdam</span><span class="tok-o">,</span> <span class="tok-n">Anchorage</span><span class="tok-o">,</span> <span class="tok-n">Athens</span><span class="tok-o">,</span> <span class="tok-n">Atlanta</span><span class="tok-o">,</span> <span class="tok-n">Auckland</span><span class="tok-o">,</span> <span class="tok-n">Austin</span><span class="tok-o">,</span> <span class="tok-n">Ayers</span> <span class="tok-n">Rock</span><span class="tok-o">,</span> <span class="tok-n">Baltimore</span><span class="tok-o">,</span> <span class="tok-n">Bankok</span><span class="tok-o">,</span> <span class="tok-n">Barcelona</span><span class="tok-o">,</span> <span class="tok-n">Beijing</span><span class="tok-o">,</span> <span class="tok-n">Belgrade</span><span class="tok-o">,</span> <span class="tok-n">Bengaluru</span><span class="tok-o">,</span> <span class="tok-n">Berlin</span><span class="tok-o">,</span> <span class="tok-n">Bilbao</span><span class="tok-o">,</span> <span class="tok-n">Bologna</span><span class="tok-o">,</span> <span class="tok-n">Boston</span><span class="tok-o">,</span> <span class="tok-n">Brisbane</span><span class="tok-o">,</span> <span class="tok-n">Brussels</span><span class="tok-o">,</span> <span class="tok-n">Budapest</span><span class="tok-o">,</span> <span class="tok-n">Buenos</span> <span class="tok-n">Aires</span><span class="tok-o">,</span> <span class="tok-n">Cairns</span><span class="tok-o">,</span> <span class="tok-n">Cairo</span><span class="tok-o">,</span> <span class="tok-n">Calgary</span><span class="tok-o">,</span> <span class="tok-n">Calicut</span><span class="tok-o">,</span> <span class="tok-n">Canberra</span><span class="tok-o">,</span> <span class="tok-n">Cancun</span><span class="tok-o">,</span> <span class="tok-n">Cape</span> <span class="tok-n">Town</span><span class="tok-o">,</span> <span class="tok-n">Cedar</span> <span class="tok-n">Rapids</span><span class="tok-o">,</span> <span class="tok-n">Charlotte</span><span class="tok-o">,</span> <span class="tok-n">Chennai</span><span class="tok-o">,</span> <span class="tok-n">Chicago</span><span class="tok-o">,</span> <span class="tok-n">Christchurch</span><span class="tok-o">,</span> <span class="tok-n">Cincinnati</span><span class="tok-o">,</span> <span class="tok-n">Cleveland</span><span class="tok-o">,</span> <span class="tok-n">Cologne</span><span class="tok-o">,</span> <span class="tok-n">Copenhagen</span><span class="tok-o">,</span> <span class="tok-n">Dallas</span><span class="tok-o">,</span> <span class="tok-n">Denver</span><span class="tok-o">,</span> <span class="tok-n">Detroit</span><span class="tok-o">,</span> <span class="tok-n">Doha</span><span class="tok-o">,</span> <span class="tok-n">Dubai</span><span class="tok-o">,</span> <span class="tok-n">Dublin</span><span class="tok-o">,</span> <span class="tok-n">Durban</span><span class="tok-o">,</span> <span class="tok-n">Dusseldorf</span><span class="tok-o">,</span> <span class="tok-n">Edinburgh</span><span class="tok-o">,</span> <span class="tok-n">Edmonton</span><span class="tok-o">,</span> <span class="tok-n">El</span> <span class="tok-n">Paso</span><span class="tok-o">,</span> <span class="tok-n">Fairbanks</span><span class="tok-o">,</span> <span class="tok-n">Fort</span> <span class="tok-n">Lauderdale</span><span class="tok-o">,</span> <span class="tok-n">Fort</span> <span class="tok-n">Myers</span><span class="tok-o">,</span> <span class="tok-n">Frankfurt</span><span class="tok-o">,</span> <span class="tok-n">Geneva</span><span class="tok-o">,</span> <span class="tok-n">Genoa</span><span class="tok-o">,</span> <span class="tok-n">Glasgow</span><span class="tok-o">,</span> <span class="tok-n">Gold</span> <span class="tok-n">Coast</span><span class="tok-o">,</span> <span class="tok-n">Gothenburg</span><span class="tok-o">,</span> <span class="tok-n">Hagta</span><span class="tok-o">,</span> <span class="tok-n">Halifax</span><span class="tok-o">,</span> <span class="tok-n">Hamburg</span><span class="tok-o">,</span> <span class="tok-n">Harrison</span><span class="tok-o">,</span> <span class="tok-n">Helsinki</span><span class="tok-o">,</span> <span class="tok-n">Ho</span> <span class="tok-n">Chi</span> <span class="tok-n">Minh</span> <span class="tok-n">City</span><span class="tok-o">,</span> <span class="tok-n">Hong</span> <span class="tok-n">Kong</span><span class="tok-o">,</span> <span class="tok-n">Honolulu</span><span class="tok-o">,</span> <span class="tok-n">Houston</span><span class="tok-o">,</span> <span class="tok-n">Hyderabad</span><span class="tok-o">,</span> <span class="tok-n">Ibiza</span><span class="tok-o">,</span> <span class="tok-n">Indianapolis</span><span class="tok-o">,</span> <span class="tok-n">Istanbul</span><span class="tok-o">,</span> <span class="tok-n">Johannesburg</span><span class="tok-o">,</span> <span class="tok-n">Kahului</span><span class="tok-o">,</span> <span class="tok-n">Kansas</span> <span class="tok-n">City</span><span class="tok-o">,</span> <span class="tok-n">Kingston</span><span class="tok-o">,</span> <span class="tok-n">Kolkata</span><span class="tok-o">,</span> <span class="tok-n">Kuala</span> <span class="tok-n">Lumpur</span><span class="tok-o">,</span> <span class="tok-n">Kuwait</span><span class="tok-o">,</span> <span class="tok-n">Larnaca</span><span class="tok-o">,</span> <span class="tok-n">Las</span> <span class="tok-n">Vegas</span><span class="tok-o">,</span> <span class="tok-n">Lima</span><span class="tok-o">,</span> <span class="tok-n">Liverpool</span><span class="tok-o">,</span> <span class="tok-n">London</span><span class="tok-o">,</span> <span class="tok-n">Long</span> <span class="tok-n">Beach</span><span class="tok-o">,</span> <span class="tok-n">Los</span> <span class="tok-n">Angeles</span><span class="tok-o">,</span> <span class="tok-n">Luqa</span><span class="tok-o">,</span> <span class="tok-n">Luxembourg</span><span class="tok-o">,</span> <span class="tok-n">Madrid</span><span class="tok-o">,</span> <span class="tok-n">Manama</span><span class="tok-o">,</span> <span class="tok-n">Manchester</span><span class="tok-o">,</span> <span class="tok-n">Manila</span><span class="tok-o">,</span> <span class="tok-n">Maroochydore</span><span class="tok-o">,</span> <span class="tok-n">Melbourne</span><span class="tok-o">,</span> <span class="tok-n">Memphis</span><span class="tok-o">,</span> <span class="tok-n">Menorca</span><span class="tok-o">,</span> <span class="tok-n">Mexico</span> <span class="tok-n">City</span><span class="tok-o">,</span> <span class="tok-n">Miami</span><span class="tok-o">,</span> <span class="tok-n">Milan</span><span class="tok-o">,</span> <span class="tok-n">Milwaukee</span><span class="tok-o">,</span> <span class="tok-n">Minneapolis</span><span class="tok-o">,</span> <span class="tok-n">Mombasa</span><span class="tok-o">,</span> <span class="tok-n">Montevideo</span><span class="tok-o">,</span> <span class="tok-n">Montreal</span><span class="tok-o">,</span> <span class="tok-n">Moscow</span><span class="tok-o">,</span> <span class="tok-n">Mumbai</span><span class="tok-o">,</span> <span class="tok-n">Munich</span><span class="tok-o">,</span> <span class="tok-n">Nairobi</span><span class="tok-o">,</span> <span class="tok-n">Nantes</span><span class="tok-o">,</span> <span class="tok-n">Naples</span><span class="tok-o">,</span> <span class="tok-n">Nashville</span><span class="tok-o">,</span> <span class="tok-n">New</span> <span class="tok-n">Delhi</span><span class="tok-o">,</span> <span class="tok-n">New</span> <span class="tok-n">Orleans</span><span class="tok-o">,</span> <span class="tok-n">New</span> <span class="tok-n">York</span><span class="tok-o">,</span> <span class="tok-n">Newark</span><span class="tok-o">,</span> <span class="tok-n">Nice</span><span class="tok-o">,</span> <span class="tok-n">Nottingham</span><span class="tok-o">,</span> <span class="tok-n">Oaklahoma</span> <span class="tok-n">City</span><span class="tok-o">,</span> <span class="tok-n">Oakland</span><span class="tok-o">,</span> <span class="tok-n">Omaha</span><span class="tok-o">,</span> <span class="tok-n">Ontario</span><span class="tok-o">,</span> <span class="tok-n">Orlando</span><span class="tok-o">,</span> <span class="tok-n">Osaka</span><span class="tok-o">,</span> <span class="tok-n">Oslo</span><span class="tok-o">,</span> <span class="tok-n">Ottawa</span><span class="tok-o">,</span> <span class="tok-n">Palm</span> <span class="tok-n">Springs</span><span class="tok-o">,</span> <span class="tok-n">Paris</span><span class="tok-o">,</span> <span class="tok-n">Perth</span><span class="tok-o">,</span> <span class="tok-n">Philadelphia</span><span class="tok-o">,</span> <span class="tok-n">Phnom</span> <span class="tok-n">Penh</span><span class="tok-o">,</span> <span class="tok-n">Phoenix</span><span class="tok-o">,</span> <span class="tok-n">Pisa</span><span class="tok-o">,</span> <span class="tok-n">Pittsburgh</span><span class="tok-o">,</span> <span class="tok-n">Portland</span><span class="tok-o">,</span> <span class="tok-n">Prague</span><span class="tok-o">,</span> <span class="tok-n">Puerto</span> <span class="tok-n">Vallarta</span><span class="tok-o">,</span> <span class="tok-n">Raleigh</span><span class="tok-o">,</span> <span class="tok-n">Rio</span> <span class="tok-n">de</span> <span class="tok-n">Janeiro</span><span class="tok-o">,</span> <span class="tok-n">Rochester</span><span class="tok-o">,</span> <span class="tok-n">Rome</span><span class="tok-o">,</span> <span class="tok-n">Salina</span><span class="tok-o">,</span> <span class="tok-n">Salt</span> <span class="tok-n">Lake</span> <span class="tok-n">City</span><span class="tok-o">,</span> <span class="tok-n">San</span> <span class="tok-n">Antonio</span><span class="tok-o">,</span> <span class="tok-n">San</span> <span class="tok-n">Diego</span><span class="tok-o">,</span> <span class="tok-n">San</span> <span class="tok-n">Francisco</span><span class="tok-o">,</span> <span class="tok-n">San</span> <span class="tok-n">Jose</span><span class="tok-o">,</span> <span class="tok-n">San</span> <span class="tok-n">Juan</span><span class="tok-o">,</span> <span class="tok-n">Santa</span> <span class="tok-n">Ana</span><span class="tok-o">,</span> <span class="tok-n">Santa</span> <span class="tok-n">Fe</span><span class="tok-o">,</span> <span class="tok-n">Santiago</span><span class="tok-o">,</span> <span class="tok-n">Sao</span> <span class="tok-n">Paulo</span><span class="tok-o">,</span> <span class="tok-n">Seattle</span><span class="tok-o">,</span> <span class="tok-n">Seoul</span><span class="tok-o">,</span> <span class="tok-n">Shanghai</span><span class="tok-o">,</span> <span class="tok-n">Shannon</span><span class="tok-o">,</span> <span class="tok-n">Singapore</span><span class="tok-o">,</span> <span class="tok-n">Sofia</span><span class="tok-o">,</span> <span class="tok-n">St</span> <span class="tok-n">Louis</span><span class="tok-o">,</span> <span class="tok-n">St</span><span class="tok-o">.</span> <span class="tok-n">Johns</span><span class="tok-o">,</span> <span class="tok-n">Stockholm</span><span class="tok-o">,</span> <span class="tok-n">Stuttgart</span><span class="tok-o">,</span> <span class="tok-n">Sydney</span><span class="tok-o">,</span> <span class="tok-n">Tallahassee</span><span class="tok-o">,</span> <span class="tok-n">Tampa</span><span class="tok-o">,</span> <span class="tok-n">Tel</span> <span class="tok-n">Aviv</span><span class="tok-o">,</span> <span class="tok-n">Tenerife</span><span class="tok-o">,</span> <span class="tok-n">Tokyo</span><span class="tok-o">,</span> <span class="tok-n">Toronto</span><span class="tok-o">,</span> <span class="tok-n">Tucson</span><span class="tok-o">,</span> <span class="tok-n">Tulsa</span><span class="tok-o">,</span> <span class="tok-n">Turin</span><span class="tok-o">,</span> <span class="tok-n">Vancouver</span><span class="tok-o">,</span> <span class="tok-n">Venice</span><span class="tok-o">,</span> <span class="tok-n">Verona</span><span class="tok-o">,</span> <span class="tok-n">Vienna</span><span class="tok-o">,</span> <span class="tok-n">Warsaw</span><span class="tok-o">,</span> <span class="tok-n">Washington</span> <span class="tok-n">D</span><span class="tok-o">.</span><span class="tok-na">C</span><span class="tok-o">.,</span> <span class="tok-n">Wellington</span><span class="tok-o">,</span> <span class="tok-n">West</span> <span class="tok-n">Palm</span> <span class="tok-n">Beach</span><span class="tok-o">,</span> <span class="tok-n">White</span> <span class="tok-n">Plains</span><span class="tok-o">,</span> <span class="tok-n">Winnipeg</span><span class="tok-o">,</span> <span class="tok-n">Zagreb</span><span class="tok-o">,</span> <span class="tok-n">Zurich</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And just to make sure we got fewer names back this time let’s count them again.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSideEffect</span><span class="tok-o">(</span><span class="tok-s2">"x"</span><span class="tok-o">,</span> <span class="tok-o">[]</span> <span class="tok-k">as</span> <span class="tok-n">Set</span><span class="tok-o">).</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-n">between</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">201</span><span class="tok-o">)).</span>
  <span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">store</span><span class="tok-o">(</span><span class="tok-s1">'x'</span><span class="tok-o">).</span><span class="tok-na">cap</span><span class="tok-o">(</span><span class="tok-s1">'x'</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">186</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As I mentioned at the start of this section, you could achieve this result other ways. For
example, here is a version of the query that uses <em>dedup</em> instead of <em>store</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-n">between</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">201</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">dedup</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">186</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is clearly a simpler query in this case but you will find cases where the example
that uses <em>withSideEffect</em> and <em>store</em> will come in very handy, especially in cases where
you want to store things into a Set or List from multiple parts of a traversal such as the
one below that finds and counts all the unique city names across multiple hops from a
starting airport.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSideEffect</span><span class="tok-o">(</span><span class="tok-s2">"x"</span><span class="tok-o">,</span> <span class="tok-o">[]</span> <span class="tok-k">as</span> <span class="tok-n">Set</span><span class="tok-o">).</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasId</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">store</span><span class="tok-o">(</span><span class="tok-s1">'x'</span><span class="tok-o">).</span>
   <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">store</span><span class="tok-o">(</span><span class="tok-s1">'x'</span><span class="tok-o">).</span>
   <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">store</span><span class="tok-o">(</span><span class="tok-s1">'x'</span><span class="tok-o">).</span><span class="tok-na">cap</span><span class="tok-o">(</span><span class="tok-s1">'x'</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">804</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lastly on this topic, let’s look at one more interesting use case. It is quite common
to want to get back from a query a collection of vertices and edges. This is often
because we want to examine properties on both the vertices and the edges. Imagine a
small graph that has the following relationships.</p>
</div>
<div class="paragraph">
<p>(A→B),
(A→C),
(A→D),
(C→D),
(C→E),
(D→F)</p>
</div>
<div class="paragraph">
<p>The code below can be used to create this graph using the Gremlin console and
TinkerGraph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">graph</span><span class="tok-o">=</span><span class="tok-n">TinkerGraph</span><span class="tok-o">.</span><span class="tok-na">open</span><span class="tok-o">()</span>
<span class="tok-n">g</span><span class="tok-o">=</span><span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">()</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">addV</span><span class="tok-o">(</span><span class="tok-s2">"A"</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s2">"a"</span><span class="tok-o">).</span>
  <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s2">"B"</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s2">"b"</span><span class="tok-o">).</span>
  <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s2">"C"</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s2">"c"</span><span class="tok-o">).</span>
  <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s2">"D"</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s2">"d"</span><span class="tok-o">).</span>
  <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s2">"E"</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s2">"e"</span><span class="tok-o">).</span>
  <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s2">"F"</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s2">"f"</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s2">"knows"</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s2">"a"</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s2">"b"</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s2">"knows"</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s2">"a"</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s2">"c"</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s2">"knows"</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s2">"a"</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s2">"d"</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s2">"knows"</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s2">"c"</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s2">"d"</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s2">"knows"</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s2">"c"</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s2">"e"</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s2">"knows"</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s2">"d"</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s2">"f"</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can see the IDs that were allocated for each vertex by looking at the <em>valueMap</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">0</span><span class="tok-o">,</span><span class="tok-nl">label:</span><span class="tok-n">A</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-nl">label:</span><span class="tok-n">B</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-nl">label:</span><span class="tok-n">C</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-nl">label:</span><span class="tok-n">D</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-nl">label:</span><span class="tok-n">E</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">id:</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-nl">label:</span><span class="tok-n">F</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Likewise we can look at the edges to see what IDs each edge was given.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">()</span>

<span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">6</span><span class="tok-o">][</span><span class="tok-mi">0</span><span class="tok-o">-</span><span class="tok-n">knows</span><span class="tok-o">-&gt;</span><span class="tok-mi">1</span><span class="tok-o">]</span>
<span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">7</span><span class="tok-o">][</span><span class="tok-mi">0</span><span class="tok-o">-</span><span class="tok-n">knows</span><span class="tok-o">-&gt;</span><span class="tok-mi">2</span><span class="tok-o">]</span>
<span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">][</span><span class="tok-mi">0</span><span class="tok-o">-</span><span class="tok-n">knows</span><span class="tok-o">-&gt;</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">9</span><span class="tok-o">][</span><span class="tok-mi">2</span><span class="tok-o">-</span><span class="tok-n">knows</span><span class="tok-o">-&gt;</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">10</span><span class="tok-o">][</span><span class="tok-mi">2</span><span class="tok-o">-</span><span class="tok-n">knows</span><span class="tok-o">-&gt;</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">11</span><span class="tok-o">][</span><span class="tok-mi">3</span><span class="tok-o">-</span><span class="tok-n">knows</span><span class="tok-o">-&gt;</span><span class="tok-mi">5</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have our test graph created let’s take a look at the query we will need
to develop. The problem we want to solve is to start from vertex A, find all of the
edges that go out from vertex A and also all of the vertices at the other ends of those
edges. Lastly we also want to find any edges between the vertices that are also
connected to A but ignore edges that connect to vertices that are not also connected to
A. In simple terms we want a query that will return all of the relationships except
(C→E) and (D-F) as A is not connected to E or F.</p>
</div>
<div class="paragraph">
<p>Using the <em>withSideEffect</em> pattern that we used earlier in this section we can again
develop a query that will collect for us the vertices and edges that we are interested
in. I added line numbers to make it easier to discuss what is going on but please,
note that these are not part of the query itself.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-mi">1</span><span class="tok-o">:</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSideEffect</span><span class="tok-o">(</span><span class="tok-s1">'x'</span><span class="tok-o">,</span> <span class="tok-o">[]</span> <span class="tok-k">as</span> <span class="tok-n">Set</span><span class="tok-o">).</span>
<span class="tok-mi">2</span><span class="tok-o">:</span>     <span class="tok-n">V</span><span class="tok-o">(</span><span class="tok-mi">0L</span><span class="tok-o">).</span><span class="tok-na">store</span><span class="tok-o">(</span><span class="tok-s1">'x'</span><span class="tok-o">).</span>
<span class="tok-mi">3</span><span class="tok-o">:</span>     <span class="tok-n">bothE</span><span class="tok-o">().</span><span class="tok-na">store</span><span class="tok-o">(</span><span class="tok-s1">'x'</span><span class="tok-o">).</span>
<span class="tok-mi">4</span><span class="tok-o">:</span>     <span class="tok-n">otherV</span><span class="tok-o">().</span><span class="tok-na">store</span><span class="tok-o">(</span><span class="tok-s1">'x'</span><span class="tok-o">).</span>
<span class="tok-mi">5</span><span class="tok-o">:</span>     <span class="tok-n">aggregate</span><span class="tok-o">(</span><span class="tok-s1">'tgtlist'</span><span class="tok-o">).</span>
<span class="tok-mi">6</span><span class="tok-o">:</span>     <span class="tok-n">bothE</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'ref'</span><span class="tok-o">).</span><span class="tok-na">otherV</span><span class="tok-o">().</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">within</span><span class="tok-o">(</span><span class="tok-s1">'tgtlist'</span><span class="tok-o">)).</span>
<span class="tok-mi">7</span><span class="tok-o">:</span>     <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'ref'</span><span class="tok-o">).</span><span class="tok-na">store</span><span class="tok-o">(</span><span class="tok-s1">'x'</span><span class="tok-o">).</span><span class="tok-na">cap</span><span class="tok-o">(</span><span class="tok-s1">'x'</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s look at the query above line by line.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1: Start the query and define 'x' as our, initially empty, Set.
2: Start at vertex 0 and 'store' it into our set 'x'.
3: Store all of the edges connected to 'V(0)' into our set.
4: Store the vertices connected to 'V(0)' into our set.
5: Aggregate all of these target vertices into 'tgtlist'.
6: Find more edges but only remember them if they connect to vertices also connected
to 'V(0)'.
7: Store the edges we found in 'x' and finally return the set as the overall result of the
query. The 'unfold' just makes the output a little easier to read.</pre>
</div>
</div>
<div class="paragraph">
<p>Here is the output we get from running the query. As you can see, the vertices and edges
that we were not interested in have been correctly left out of the result set.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">]</span>
<span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">5</span><span class="tok-o">][</span><span class="tok-mi">0</span><span class="tok-o">-</span><span class="tok-n">knows</span><span class="tok-o">-&gt;</span><span class="tok-mi">1</span><span class="tok-o">]</span>
<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">]</span>
<span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">6</span><span class="tok-o">][</span><span class="tok-mi">0</span><span class="tok-o">-</span><span class="tok-n">knows</span><span class="tok-o">-&gt;</span><span class="tok-mi">2</span><span class="tok-o">]</span>
<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]</span>
<span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">7</span><span class="tok-o">][</span><span class="tok-mi">0</span><span class="tok-o">-</span><span class="tok-n">knows</span><span class="tok-o">-&gt;</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">]</span>
<span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">][</span><span class="tok-mi">2</span><span class="tok-o">-</span><span class="tok-n">knows</span><span class="tok-o">-&gt;</span><span class="tok-mi">3</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you start to work with graphs and start to do more complex querying, this pattern
of query based around <em>withSideEffect</em> is extremely useful to keep in mind.</p>
</div>
</div>
<div class="sect2">
<h3 id="dfwcopy">5.7. Making a copy of the DFW vertex</h3>
<div class="paragraph">
<p>It is sometimes useful to be able to create a new vertex using the label and
properties from one or more existing vertices. In this section I am going to present
a small case study that shows how I investigated the creation of a query that could
create a copy of the Dallas Fort Worth (DFW) airport vertex.</p>
</div>
<div class="paragraph">
<p>Creating a vertex using the label from another vertex is quite straightforward. The
two queries shown below use the label from the DFW Airport vertex as the label for a
new vertex.</p>
</div>
<div class="paragraph">
<p>My first thought was to do this as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">addV</span><span class="tok-o">().</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-n">label</span><span class="tok-o">,</span><span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">label</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The query above does work but it felt a bit cumbersome and I also realized I was
going to need a way to refer to the DFW vertex more than once so I changed the query
as follows and ran it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">).</span>
      <span class="tok-n">addV</span><span class="tok-o">().</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-n">label</span><span class="tok-o">,</span> <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">).</span><span class="tok-na">label</span><span class="tok-o">())</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">57525</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we examine the new vertex we can see that it does indeed have the correct label.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">57525</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-nl">label:</span><span class="tok-n">airport</span><span class="tok-o">,</span><span class="tok-nl">id:</span><span class="tok-mi">57525</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we need to expand the query to also copy the property key names and their values
from the DFW vertex into our new vertex. Earlier in the book we looked at ways that a
<em>select</em> step combined with the <em>keys</em> and <em>values</em> keywords can be used to select
values from a map. We can use that same technique here.</p>
</div>
<div class="paragraph">
<p>First of all let’s remind ourselves about the properties of the DFW airport.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">()</span>

<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">country</span><span class="tok-o">-&gt;</span><span class="tok-n">US</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">code</span><span class="tok-o">-&gt;</span><span class="tok-n">DFW</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">longest</span><span class="tok-o">-&gt;</span><span class="tok-mi">13401</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">city</span><span class="tok-o">-&gt;</span><span class="tok-n">Dallas</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">elev</span><span class="tok-o">-&gt;</span><span class="tok-mi">607</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">icao</span><span class="tok-o">-&gt;</span><span class="tok-n">KDFW</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">lon</span><span class="tok-o">-&gt;-</span><span class="tok-mf">97.0380020141602</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">type</span><span class="tok-o">-&gt;</span><span class="tok-n">airport</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">region</span><span class="tok-o">-&gt;</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">runways</span><span class="tok-o">-&gt;</span><span class="tok-mi">7</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">lat</span><span class="tok-o">-&gt;</span><span class="tok-mf">32.896800994873</span><span class="tok-o">]</span>
<span class="tok-n">vp</span><span class="tok-o">[</span><span class="tok-n">desc</span><span class="tok-o">-&gt;</span><span class="tok-n">Dallas</span><span class="tok-o">/</span><span class="tok-n">Fort</span> <span class="tok-n">Worth</span><span class="tok-o">...]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s also count how many properties there are listed above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">12</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So we need to add some steps to our query that will copy the twelve keys and values
from these twelve properties belonging to the DFW vertex into our new one.</p>
</div>
<div class="paragraph">
<p>Below is the first query I tried when thinking about how to do this. The goal of the
query is to first capture the properties from the DFW airport and then to add them to
the new vertex being created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">).</span>
      <span class="tok-n">addV</span><span class="tok-o">().</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-n">label</span><span class="tok-o">,</span> <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">).</span><span class="tok-na">label</span><span class="tok-o">()).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'new'</span><span class="tok-o">).</span>
             <span class="tok-n">property</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">().</span><span class="tok-na">key</span><span class="tok-o">(),</span>
                      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">().</span><span class="tok-na">value</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When I ran it I got this result which looked encouraging as a new vertex had clearly
been created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">53767</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, when I inspected my new vertex I saw I had only managed to copy one of the
twelve properties over. So it was time to delete that vertex and have a bit of a
rethink.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">53767</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">()</span>

<span class="tok-n">country</span><span class="tok-o">=[</span><span class="tok-n">US</span><span class="tok-o">]</span>
<span class="tok-n">label</span><span class="tok-o">=</span><span class="tok-n">airport</span>
<span class="tok-n">id</span><span class="tok-o">=</span><span class="tok-mi">53767</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">53767</span><span class="tok-o">).</span><span class="tok-na">drop</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>What I realized was that my first attempt at copying the properties was only ever
going to copy one property as that was essentially what I had asked it to do. If it’s
not quite clear why this is the case, hopefully it will become clearer once you look
at the results from the profile step that are shown later in this section. I realized
that what I needed to do was to first get all of the DFW properties and then add them
to the new vertex. So I changed the query as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">).</span>
      <span class="tok-n">addV</span><span class="tok-o">().</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-n">label</span><span class="tok-o">,</span> <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">).</span><span class="tok-na">label</span><span class="tok-o">()).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'new'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'dfwprops'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'new'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'dfwprops'</span><span class="tok-o">).</span><span class="tok-na">key</span><span class="tok-o">(),</span>
                             <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'dfwprops'</span><span class="tok-o">).</span><span class="tok-na">value</span><span class="tok-o">())</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When run, this is what I saw in the Gremlin console. This is more output than I
wanted to get from the query but it has clearly done more work this time. If you
count the number of rows below you will find it also adds up to twelve. So this time
I got one result per property it would appear.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-mi">53768</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">53768</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">53768</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">53768</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">53768</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">53768</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">53768</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">53768</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">53768</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">53768</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">53768</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">53768</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In a moment I will explore a way to get rid of the unwanted output but first let’s
examine the contents of the new vertex.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">53768</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">()</span>

<span class="tok-n">country</span><span class="tok-o">=[</span><span class="tok-n">US</span><span class="tok-o">]</span>
<span class="tok-n">code</span><span class="tok-o">=[</span><span class="tok-n">DFW</span><span class="tok-o">]</span>
<span class="tok-n">longest</span><span class="tok-o">=[</span><span class="tok-mi">13401</span><span class="tok-o">]</span>
<span class="tok-n">city</span><span class="tok-o">=[</span><span class="tok-n">Dallas</span><span class="tok-o">]</span>
<span class="tok-n">lon</span><span class="tok-o">=[-</span><span class="tok-mf">97.0380020141602</span><span class="tok-o">]</span>
<span class="tok-n">type</span><span class="tok-o">=[</span><span class="tok-n">airport</span><span class="tok-o">]</span>
<span class="tok-n">elev</span><span class="tok-o">=[</span><span class="tok-mi">607</span><span class="tok-o">]</span>
<span class="tok-n">label</span><span class="tok-o">=</span><span class="tok-n">airport</span>
<span class="tok-n">icao</span><span class="tok-o">=[</span><span class="tok-n">KDFW</span><span class="tok-o">]</span>
<span class="tok-n">id</span><span class="tok-o">=</span><span class="tok-mi">53768</span>
<span class="tok-n">region</span><span class="tok-o">=[</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span><span class="tok-o">]</span>
<span class="tok-n">runways</span><span class="tok-o">=[</span><span class="tok-mi">7</span><span class="tok-o">]</span>
<span class="tok-n">lat</span><span class="tok-o">=[</span><span class="tok-mf">32.896800994873</span><span class="tok-o">]</span>
<span class="tok-n">desc</span><span class="tok-o">=[</span><span class="tok-n">Dallas</span><span class="tok-o">/</span><span class="tok-n">Fort</span> <span class="tok-n">Worth</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So a large part of my original goal has now been achieved. A vertex has been created
that is a copy in all but ID value of the original DFW vertex. So, what can be done
about the unwanted list of vertices that came back as the results from the query?</p>
</div>
<div class="paragraph">
<p>First of all, let’s take a look at what the <em>profile</em> step can tell us about this
query. Note that I deleted the new vertex using a <em>drop</em> step before running this
query so it did not pick up both the old and new DFW vertices.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">53768</span><span class="tok-o">).</span><span class="tok-na">drop</span><span class="tok-o">()</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">).</span>
      <span class="tok-n">addV</span><span class="tok-o">().</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-n">label</span><span class="tok-o">,</span> <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">).</span><span class="tok-na">label</span><span class="tok-o">()).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'new'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'dfwprops'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'new'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'dfwprops'</span><span class="tok-o">).</span><span class="tok-na">key</span><span class="tok-o">(),</span>
                             <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'dfwprops'</span><span class="tok-o">).</span><span class="tok-na">value</span><span class="tok-o">()).</span><span class="tok-na">profile</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you look at the results below you can see that for each property key/value pair,
a traverser was spawned. This explains why we got twelve results back. This also
explains why my first attempt at writing this query failed. If you were to profile
that query you would find that it only spawns one traverser rather than the twelve
that we need to be successful.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">Traversal Metrics      Step                      Count Traver-  Time   %Dur</span>
<span class="tok-go">                                                       sers      (ms)</span>
<span class="tok-go">===================================================================================</span>
<span class="tok-go">TinkerGraphStep(vertex,[code.eq(DFW)])@[dfw]        1     1    1.416    28.85</span>
<span class="tok-go">AddVertexStep({label=[[SelectOneStep(last,dfw),...  1     1    1.840    37.47</span>
<span class="tok-go">  SelectOneStep(last,dfw)                           1     1    0.171</span>
<span class="tok-go">  NoOpBarrierStep(2500)                             1     1    0.092</span>
<span class="tok-go">  LabelStep                                         1     1    0.059</span>
<span class="tok-go">SelectOneStep(last,dfw)                             1     1    0.132     2.70</span>
<span class="tok-go">NoOpBarrierStep(2500)                               1     1    0.032     0.66</span>
<span class="tok-go">PropertiesStep(property)@[dfwprops]                12    12    0.094     1.92</span>
<span class="tok-go">SelectOneStep(last,new)                            12    12    0.127     2.60</span>
<span class="tok-go">NoOpBarrierStep(2500)                              12    12    0.065     1.34</span>
<span class="tok-go">AddPropertyStep({value=[[SelectOneStep(last,dfw... 12    12    1.200    24.45</span>
<span class="tok-go">  SelectOneStep(last,dfwprops)                     12    12    0.168</span>
<span class="tok-go">  NoOpBarrierStep(2500)                            12    12    0.064</span>
<span class="tok-go">  PropertyKeyStep                                  12    12    0.066</span>
<span class="tok-go">  SelectOneStep(last,dfwprops)                     12    12    0.134</span>
<span class="tok-go">  NoOpBarrierStep(2500)                            12    12    0.070</span>
<span class="tok-go">  PropertyValueStep                                12    12    0.043</span>
<span class="tok-go">                                            &gt;TOTAL  -     -    4.911</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you will hopefully recall from our discussion of the <em>addV</em> and <em>property</em> steps
earlier in Chapter 4, a <em>property</em> step returns the vertex that the property was
added to and not the new property itself. This allows multiple <em>addV</em> and <em>property</em>
steps to be chained together.</p>
</div>
<div class="paragraph">
<p>So we need a way to still create our new properties but not have the twelve
traversers return any results to us. Hopefully your reaction to this is something
like "This feels like a good place to introduce a <em>sideEffect</em> step into the query".
If that was your reaction you are right!</p>
</div>
<div class="paragraph">
<p>Before running the new query we need to clean up the work done by the prior one.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-mi">8</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">53767</span><span class="tok-o">]</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">53767</span><span class="tok-o">).</span><span class="tok-na">drop</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So now let’s wrap the creation of the properties into a <em>sideEffect</em> step that should
stop the unwanted results from being returned.The modified  version of the query is
shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">).</span>
      <span class="tok-n">addV</span><span class="tok-o">().</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-n">label</span><span class="tok-o">,</span> <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">).</span><span class="tok-na">label</span><span class="tok-o">()).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'new'</span><span class="tok-o">).</span>
      <span class="tok-n">sideEffect</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">).</span><span class="tok-na">properties</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'dfwprops'</span><span class="tok-o">).</span>
                 <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'new'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'dfwprops'</span><span class="tok-o">).</span><span class="tok-na">key</span><span class="tok-o">(),</span>
                                        <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'dfwprops'</span><span class="tok-o">).</span><span class="tok-na">value</span><span class="tok-o">()))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When we run the modified version of the query this is what we get back.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-mi">53780</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a lot better as we now just got back the new vertex one time as the result.
Let’s double check that the query has worked as intended.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-mi">53780</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">).</span><span class="tok-na">unfold</span><span class="tok-o">()</span>

<span class="tok-n">country</span><span class="tok-o">=[</span><span class="tok-n">US</span><span class="tok-o">]</span>
<span class="tok-n">code</span><span class="tok-o">=[</span><span class="tok-n">DFW</span><span class="tok-o">]</span>
<span class="tok-n">longest</span><span class="tok-o">=[</span><span class="tok-mi">13401</span><span class="tok-o">]</span>
<span class="tok-n">city</span><span class="tok-o">=[</span><span class="tok-n">Dallas</span><span class="tok-o">]</span>
<span class="tok-n">lon</span><span class="tok-o">=[-</span><span class="tok-mf">97.0380020141602</span><span class="tok-o">]</span>
<span class="tok-n">type</span><span class="tok-o">=[</span><span class="tok-n">airport</span><span class="tok-o">]</span>
<span class="tok-n">elev</span><span class="tok-o">=[</span><span class="tok-mi">607</span><span class="tok-o">]</span>
<span class="tok-n">label</span><span class="tok-o">=</span><span class="tok-n">airport</span>
<span class="tok-n">icao</span><span class="tok-o">=[</span><span class="tok-n">KDFW</span><span class="tok-o">]</span>
<span class="tok-n">id</span><span class="tok-o">=</span><span class="tok-mi">53780</span>
<span class="tok-n">region</span><span class="tok-o">=[</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span><span class="tok-o">]</span>
<span class="tok-n">runways</span><span class="tok-o">=[</span><span class="tok-mi">7</span><span class="tok-o">]</span>
<span class="tok-n">lat</span><span class="tok-o">=[</span><span class="tok-mf">32.896800994873</span><span class="tok-o">]</span>
<span class="tok-n">desc</span><span class="tok-o">=[</span><span class="tok-n">Dallas</span><span class="tok-o">/</span><span class="tok-n">Fort</span> <span class="tok-n">Worth</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this small case study I have tried to show how I was able to evolve a query in
stages and also to adapt to unexpected outcomes along the way. You could use
essentially the same technique shown in this section to also copy one or more edges
if you needed to.</p>
</div>
</div>
<div class="sect2">
<h3 id="btree">5.8. Modelling an ordered binary tree as a graph</h3>
<div class="paragraph">
<p>You can of course model a tree structure as a graph. The following code will create a
new graph containing an ordered binary tree. A graph like this is sometimes referred
to as a <em>connected acyclic</em> graph as there are no cycles in the graph. This means
that once you leave a node there is no other path you could take that will allow you
to get there again. By contrast the air routes graph is an example of a <em>cyclic</em>
graph as there are clearly many ways to revisit vertices.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Builds a small ordered Binary (BST) Tree</span>
<span class="tok-n">graph</span><span class="tok-o">=</span><span class="tok-n">TinkerGraph</span><span class="tok-o">.</span><span class="tok-na">open</span><span class="tok-o">()</span>
<span class="tok-n">g</span><span class="tok-o">=</span><span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">()</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">addV</span><span class="tok-o">(</span><span class="tok-s1">'root'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'data'</span><span class="tok-o">,</span><span class="tok-mi">9</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'root'</span><span class="tok-o">).</span>
  <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s1">'node'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'data'</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span>
  <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s1">'node'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'data'</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'c'</span><span class="tok-o">).</span>
  <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s1">'node'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'data'</span><span class="tok-o">,</span><span class="tok-mi">11</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'d'</span><span class="tok-o">).</span>
  <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s1">'node'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'data'</span><span class="tok-o">,</span><span class="tok-mi">15</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">).</span>
  <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s1">'node'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'data'</span><span class="tok-o">,</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'f'</span><span class="tok-o">).</span>
  <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s1">'node'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'data'</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'g'</span><span class="tok-o">).</span>
  <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s1">'node'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'data'</span><span class="tok-o">,</span><span class="tok-mi">8</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'h'</span><span class="tok-o">).</span>
  <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s1">'node'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'data'</span><span class="tok-o">,</span><span class="tok-mi">22</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'i'</span><span class="tok-o">).</span>
  <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s1">'node'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'data'</span><span class="tok-o">,</span><span class="tok-mi">16</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'j'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'left'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'root'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'left'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'c'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'right'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'root'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'d'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'right'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'d'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'right'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'i'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'left'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'i'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'j'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'left'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'d'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'f'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'right'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'h'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'left'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'c'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'g'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could of course use the <em>max</em> and the <em>min</em> steps to find the largest and smallest
values in the graph. However, the queries below show how we can do it using the
semantics of an ordered binary tree.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Find the largest value in the graph</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'root'</span><span class="tok-o">).</span><span class="tok-na">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'right'</span><span class="tok-o">)).</span>
                       <span class="tok-n">until</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'right'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'data'</span><span class="tok-o">)</span>

<span class="tok-mi">22</span>

<span class="tok-c1">// Find the smallest value in the graph</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'root'</span><span class="tok-o">).</span><span class="tok-na">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'left'</span><span class="tok-o">)).</span>
                       <span class="tok-n">until</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'left'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'data'</span><span class="tok-o">)</span>

<span class="tok-mi">1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As a side note, here is a different way we could have written the query using <em>not</em>
instead of <em>count</em>. As <em>not</em> is a reserved word in Groovy, as we discussed
in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#rword">A warning about reserved word conflicts and collisions</a>" section, we have to prefix it with the <em>__.</em> notation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'root'</span><span class="tok-o">).</span><span class="tok-na">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'left'</span><span class="tok-o">)).</span>
                       <span class="tok-n">until</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">not</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'left'</span><span class="tok-o">))).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'data'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we wanted to see the values that the <em>repeat</em> is encountering as it traverses the
tree we could add an <em>emit</em> step and get the values of each node the <em>repeat</em> visits.
Note that this does not include the value from the root node.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'root'</span><span class="tok-o">).</span><span class="tok-na">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'left'</span><span class="tok-o">)).</span><span class="tok-na">emit</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'data'</span><span class="tok-o">)</span>

<span class="tok-mi">5</span>
<span class="tok-mi">2</span>
<span class="tok-mi">1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Perhaps a nicer way to look at all the values we encountered as we traversed the tree
would be to use <em>path</em> as follows. Note that this does include the root node’s value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'root'</span><span class="tok-o">).</span><span class="tok-na">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'left'</span><span class="tok-o">)).</span>
                       <span class="tok-n">until</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">not</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'left'</span><span class="tok-o">))).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'data'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can see all of the possible paths through the tree by running the following query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'root'</span><span class="tok-o">).</span><span class="tok-na">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">()).</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">4</span><span class="tok-o">).</span><span class="tok-na">emit</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'data'</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-mi">11</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">8</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-mi">11</span><span class="tok-o">,</span><span class="tok-mi">10</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-mi">11</span><span class="tok-o">,</span><span class="tok-mi">15</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-mi">11</span><span class="tok-o">,</span><span class="tok-mi">15</span><span class="tok-o">,</span><span class="tok-mi">22</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-mi">9</span><span class="tok-o">,</span><span class="tok-mi">11</span><span class="tok-o">,</span><span class="tok-mi">15</span><span class="tok-o">,</span><span class="tok-mi">22</span><span class="tok-o">,</span><span class="tok-mi">16</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We briefly explored the TinkerPop Tree API in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#tre">Turning graphs into trees</a>" section. We could use
what we discussed there to create a Tree object from our Binary Tree graph as
follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">t</span><span class="tok-o">=</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'root'</span><span class="tok-o">).</span><span class="tok-na">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">()).</span><span class="tok-na">emit</span><span class="tok-o">().</span><span class="tok-na">tree</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'data'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Just to be sure we can query what kind of object we just created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">t</span><span class="tok-o">.</span><span class="tok-na">getClass</span><span class="tok-o">()</span>

<span class="tok-kd">class</span> <span class="tok-nc">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.</span><span class="tok-na">step</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.</span><span class="tok-na">Tree</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we print the tree we can see how it has been created from our original graph. If
you study the nesting closely you will see that it does indeed represent the original
binary tree data that we used to create the graph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">println</span> <span class="tok-n">t</span>

<span class="tok-o">[</span><span class="tok-mi">9</span><span class="tok-o">:[</span><span class="tok-mi">5</span><span class="tok-o">:[</span><span class="tok-mi">2</span><span class="tok-o">:[</span><span class="tok-mi">1</span><span class="tok-o">:[:]],</span> <span class="tok-mi">8</span><span class="tok-o">:[:]],</span> <span class="tok-mi">11</span><span class="tok-o">:[</span><span class="tok-mi">10</span><span class="tok-o">:[:],</span> <span class="tok-mi">15</span><span class="tok-o">:[</span><span class="tok-mi">22</span><span class="tok-o">:[</span><span class="tok-mi">16</span><span class="tok-o">:[:]]]]]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use the <em>getObjectsAtDepth</em> method to further investigate the tree structure.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">t</span><span class="tok-o">.</span><span class="tok-na">getObjectsAtDepth</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)</span>

<span class="tok-mi">9</span>

<span class="tok-n">t</span><span class="tok-o">.</span><span class="tok-na">getObjectsAtDepth</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">)</span>

<span class="tok-mi">5</span>
<span class="tok-mi">11</span>

<span class="tok-n">t</span><span class="tok-o">.</span><span class="tok-na">getObjectsAtDepth</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">)</span>

<span class="tok-mi">2</span>
<span class="tok-mi">8</span>
<span class="tok-mi">10</span>
<span class="tok-mi">15</span>

<span class="tok-n">t</span><span class="tok-o">.</span><span class="tok-na">getObjectsAtDepth</span><span class="tok-o">(</span><span class="tok-mi">4</span><span class="tok-o">)</span>

<span class="tok-mi">1</span>
<span class="tok-mi">22</span>

<span class="tok-n">t</span><span class="tok-o">.</span><span class="tok-na">getObjectsAtDepth</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">)</span>

<span class="tok-mi">16</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapstr">5.9. Using <em>map</em> to produce a concatenated result string</h3>
<div class="paragraph">
<p>In the example below we use <em>map</em> to build a string containing the airport code
concatenated with the city the airport is in for airports in England.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'GB-ENG'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
  <span class="tok-n">map</span><span class="tok-o">{</span><span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">().</span><span class="tok-na">value</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)+</span><span class="tok-s2">" "</span><span class="tok-o">+</span><span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">().</span><span class="tok-na">value</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results of running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">LHR</span> <span class="tok-n">London</span>
<span class="tok-n">LGW</span> <span class="tok-n">London</span>
<span class="tok-n">MAN</span> <span class="tok-n">Manchester</span>
<span class="tok-n">LCY</span> <span class="tok-n">London</span>
<span class="tok-n">STN</span> <span class="tok-n">London</span>
<span class="tok-n">EMA</span> <span class="tok-n">Nottingham</span>
<span class="tok-n">LPL</span> <span class="tok-n">Liverpool</span>
<span class="tok-n">LTN</span> <span class="tok-n">London</span>
<span class="tok-n">SOU</span> <span class="tok-n">Southampton</span>
<span class="tok-n">LBA</span> <span class="tok-n">Leeds</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="randwalk">5.10. Randomly walking a graph</h3>
<div class="paragraph">
<p>When doing analysis of a graph sometimes you just want to randomly traverse or <em>walk</em>
parts of the graph. The example below shows a query that starts at the Austin (AUS)
vertex and then randomly goes to five connected vertices from there. The <em>random
walk</em> is achieved by picking a sample of one of the possible edges connected to the
vertex we are currently at by sampling using the distance property of the edge and
then moving to the vertex at the other end of that edge.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Random walk with five hops</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">bothE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span>
         <span class="tok-n">sample</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">otherV</span><span class="tok-o">()).</span>
      <span class="tok-n">times</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Below are the results of running the query five times. You can see each graph walk
starts at AUS and then goes to five places from there. The path shown displays the
names of the other airports and the distances between them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">992</span><span class="tok-o">,</span><span class="tok-n">SFB</span><span class="tok-o">,</span><span class="tok-mi">828</span><span class="tok-o">,</span><span class="tok-n">MDT</span><span class="tok-o">,</span><span class="tok-mi">592</span><span class="tok-o">,</span><span class="tok-n">ORD</span><span class="tok-o">,</span><span class="tok-mi">234</span><span class="tok-o">,</span><span class="tok-n">DTW</span><span class="tok-o">,</span><span class="tok-mi">500</span><span class="tok-o">,</span><span class="tok-n">LGA</span><span class="tok-o">]</span>

<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">957</span><span class="tok-o">,</span><span class="tok-n">CVG</span><span class="tok-o">,</span><span class="tok-mi">374</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-mi">1890</span><span class="tok-o">,</span><span class="tok-n">SAN</span><span class="tok-o">,</span><span class="tok-mi">2276</span><span class="tok-o">,</span><span class="tok-n">DCA</span><span class="tok-o">,</span><span class="tok-mi">204</span><span class="tok-o">,</span><span class="tok-n">PIT</span><span class="tok-o">]</span>

<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">1209</span><span class="tok-o">,</span><span class="tok-n">PIT</span><span class="tok-o">,</span><span class="tok-mi">1399</span><span class="tok-o">,</span><span class="tok-n">CUN</span><span class="tok-o">,</span><span class="tok-mi">941</span><span class="tok-o">,</span><span class="tok-n">BJX</span><span class="tok-o">,</span><span class="tok-mi">729</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-mi">1384</span><span class="tok-o">,</span><span class="tok-n">BZN</span><span class="tok-o">]</span>

<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">748</span><span class="tok-o">,</span><span class="tok-n">MEX</span><span class="tok-o">,</span><span class="tok-mi">1252</span><span class="tok-o">,</span><span class="tok-n">PHX</span><span class="tok-o">,</span><span class="tok-mi">5255</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-mi">2487</span><span class="tok-o">,</span><span class="tok-n">LXR</span><span class="tok-o">,</span><span class="tok-mi">492</span><span class="tok-o">,</span><span class="tok-n">JED</span><span class="tok-o">]</span>

<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">722</span><span class="tok-o">,</span><span class="tok-n">STL</span><span class="tok-o">,</span><span class="tok-mi">717</span><span class="tok-o">,</span><span class="tok-n">DCA</span><span class="tok-o">,</span><span class="tok-mi">893</span><span class="tok-o">,</span><span class="tok-n">RSW</span><span class="tok-o">,</span><span class="tok-mi">1103</span><span class="tok-o">,</span><span class="tok-n">HPN</span><span class="tok-o">,</span><span class="tok-mi">563</span><span class="tok-o">,</span><span class="tok-n">CLT</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the previous example, every random walk began at the same place. However, if we
wanted a more random walk that starts from a different airport each time we could
instead use a <em>sample</em> step to at the start of the query to pick a random airport to
start from out of the set of all vertices with an <em>airport</em> label.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Random walk with five hops</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">sample</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">bothE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span>
        <span class="tok-n">sample</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">otherV</span><span class="tok-o">()).</span>
      <span class="tok-n">times</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When run five times , as shown below, each walk begins at a different airport.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">OMA</span><span class="tok-o">,</span><span class="tok-mi">1144</span><span class="tok-o">,</span><span class="tok-n">LGA</span><span class="tok-o">,</span><span class="tok-mi">584</span><span class="tok-o">,</span><span class="tok-n">CVG</span><span class="tok-o">,</span><span class="tok-mi">750</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-mi">6682</span><span class="tok-o">,</span><span class="tok-n">NRT</span><span class="tok-o">,</span><span class="tok-mi">5951</span><span class="tok-o">,</span><span class="tok-n">VCE</span><span class="tok-o">]</span>

<span class="tok-o">[</span><span class="tok-n">CLE</span><span class="tok-o">,</span><span class="tok-mi">244</span><span class="tok-o">,</span><span class="tok-n">ROC</span><span class="tok-o">,</span><span class="tok-mi">263</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-mi">8054</span><span class="tok-o">,</span><span class="tok-n">HKG</span><span class="tok-o">,</span><span class="tok-mi">7952</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-mi">7288</span><span class="tok-o">,</span><span class="tok-n">PVG</span><span class="tok-o">]</span>

<span class="tok-o">[</span><span class="tok-n">EMA</span><span class="tok-o">,</span><span class="tok-mi">1126</span><span class="tok-o">,</span><span class="tok-n">AGP</span><span class="tok-o">,</span><span class="tok-mi">969</span><span class="tok-o">,</span><span class="tok-n">PMO</span><span class="tok-o">,</span><span class="tok-mi">708</span><span class="tok-o">,</span><span class="tok-n">VIE</span><span class="tok-o">,</span><span class="tok-mi">5684</span><span class="tok-o">,</span><span class="tok-n">NRT</span><span class="tok-o">,</span><span class="tok-mi">5152</span><span class="tok-o">,</span><span class="tok-n">DOH</span><span class="tok-o">]</span>

<span class="tok-o">[</span><span class="tok-n">SNN</span><span class="tok-o">,</span><span class="tok-mi">387</span><span class="tok-o">,</span><span class="tok-n">LGW</span><span class="tok-o">,</span><span class="tok-mi">1349</span><span class="tok-o">,</span><span class="tok-n">KBP</span><span class="tok-o">,</span><span class="tok-mi">264</span><span class="tok-o">,</span><span class="tok-n">KHE</span><span class="tok-o">,</span><span class="tok-mi">434</span><span class="tok-o">,</span><span class="tok-n">IST</span><span class="tok-o">,</span><span class="tok-mi">2831</span><span class="tok-o">,</span><span class="tok-n">DEL</span><span class="tok-o">]</span>

<span class="tok-o">[</span><span class="tok-n">ARN</span><span class="tok-o">,</span><span class="tok-mi">1814</span><span class="tok-o">,</span><span class="tok-n">LEI</span><span class="tok-o">,</span><span class="tok-mi">1232</span><span class="tok-o">,</span><span class="tok-n">PRG</span><span class="tok-o">,</span><span class="tok-mi">433</span><span class="tok-o">,</span><span class="tok-n">BRU</span><span class="tok-o">,</span><span class="tok-mi">1384</span><span class="tok-o">,</span><span class="tok-n">SVO</span><span class="tok-o">,</span><span class="tok-mi">3598</span><span class="tok-o">,</span><span class="tok-n">PEK</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Another way to write the query involves the introduction of a <em>local</em> step. In this
case the <em>repeat</em> step is applied against the current local state of the traversal.
In this way we can achieve multiple random walks. The <em>limit(5)</em> at the end of the
query limits the number of random walks returned to just five. Note that if the
<em>local</em> step was removed only one walk would occur.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Five random walks each of five hops</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">bothE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span>
        <span class="tok-n">sample</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">otherV</span><span class="tok-o">())).</span>
      <span class="tok-n">times</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When run, five results such as those shown below are returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-mi">1301</span><span class="tok-o">,</span><span class="tok-n">ASE</span><span class="tok-o">,</span><span class="tok-mi">845</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-mi">2580</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">,</span><span class="tok-mi">596</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-mi">546</span><span class="tok-o">,</span><span class="tok-n">PBI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">ANC</span><span class="tok-o">,</span><span class="tok-mi">2547</span><span class="tok-o">,</span><span class="tok-n">PHX</span><span class="tok-o">,</span><span class="tok-mi">1999</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">,</span><span class="tok-mi">368</span><span class="tok-o">,</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-mi">3576</span><span class="tok-o">,</span><span class="tok-n">CGN</span><span class="tok-o">,</span><span class="tok-mi">4745</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-mi">922</span><span class="tok-o">,</span><span class="tok-n">CUN</span><span class="tok-o">,</span><span class="tok-mi">931</span><span class="tok-o">,</span><span class="tok-n">SAT</span><span class="tok-o">,</span><span class="tok-mi">248</span><span class="tok-o">,</span><span class="tok-n">DAL</span><span class="tok-o">,</span><span class="tok-mi">1378</span><span class="tok-o">,</span><span class="tok-n">LGA</span><span class="tok-o">,</span><span class="tok-mi">736</span><span class="tok-o">,</span><span class="tok-n">MKE</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">BNA</span><span class="tok-o">,</span><span class="tok-mi">630</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">1430</span><span class="tok-o">,</span><span class="tok-n">SJC</span><span class="tok-o">,</span><span class="tok-mi">2110</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-mi">2180</span><span class="tok-o">,</span><span class="tok-n">SEA</span><span class="tok-o">,</span><span class="tok-mi">4868</span><span class="tok-o">,</span><span class="tok-n">AMS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-mi">3838</span><span class="tok-o">,</span><span class="tok-n">MUC</span><span class="tok-o">,</span><span class="tok-mi">4024</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">,</span><span class="tok-mi">8054</span><span class="tok-o">,</span><span class="tok-n">HKG</span><span class="tok-o">,</span><span class="tok-mi">858</span><span class="tok-o">,</span><span class="tok-n">YNZ</span><span class="tok-o">,</span><span class="tok-mi">901</span><span class="tok-o">,</span><span class="tok-n">HRB</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sevendegrees">5.11. Seven degrees of separation!</h3>
<div class="paragraph">
<p>No, the word seven in the heading above is not a mistake, read on! Most people I am
sure have heard of the famous "Six degrees of separation" theory. The theory
essentially states that for any living person, using "friend of a friend" style
connections, none of us is farther removed than six friendship relationships from
anyone else.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can read more about the Six degrees of separation theory on Wikipedia at
this location <a href="https://en.wikipedia.org/wiki/Six_degrees_of_separation" class="bare">https://en.wikipedia.org/wiki/Six_degrees_of_separation</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>I decided it would be fun to run an experiment using the <code>air-routes</code> data set to see
how far any airport, that is not a known orphan vertex, is from a major hub airport.
For this experiment I decided to use London Heathrow (LHR) airport as my target.</p>
</div>
<div class="paragraph">
<p>I came up with the queries below in order to do this. The first thing I wanted to do
was establish how many connections I would be looking for.</p>
</div>
<div class="paragraph">
<p>First of all I double checked how many airports are in the graph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">3374</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next I remembered there are some orphan airports that have no routes so we have to
rule those out. We can do this using a technique similar to the one that was
discussed in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#noroutes">Which airports have no routes?</a> section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">not</span><span class="tok-o">(</span><span class="tok-n">outE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">)).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-mi">16</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So we know that there are 16 airports we need to ignore for this experiment. Leaving
us with 3358 airports we care about but one of those will be LHR so we also need to
discount that one as we are not looking for cyclic paths. So, we need a query that
proves there is a route between all of these 3357 remaining airports and London
Heathrow but ignores the orphan airports and Heathrow itself as starting points.</p>
</div>
<div class="paragraph">
<p>The core part of the query is shown below. I started out using just one hop for
testing purposes. The query starts by ignoring LHR and the orphan nodes. It next uses
a <em>union</em> step within <em>local</em> scope to try and find a single path in one hop between
the starting airport and LHR. The result, for each starting airport will either be a
path containing the codes of all the airports from the starting airport to LHR or if
LHR was not reached the path will just contain the starting airport. Just to test
this part of the query I used a hop count of 1 and limited the results to just 10.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-s1">'LHR'</span><span class="tok-o">)).</span>
       <span class="tok-n">filter</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">))).</span>
       <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">union</span><span class="tok-o">(</span>
              <span class="tok-n">identity</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">),</span>
              <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span>
                      <span class="tok-n">emit</span><span class="tok-o">().</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span>
                      <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span>
                      <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)).</span>
              <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)).</span>
              <span class="tok-n">fold</span><span class="tok-o">()).</span>
        <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, the query we have so far seems to be working. We either get back a
starting airport and a path or just a starting airport if no route was found. This is
why I used the <em>union</em> step to guarantee that at a minimum the starting airport is
returned. The <em>local</em> scope is used as I wanted the results for each starting airport
to be in a separate list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">,[</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-n">ANC</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-n">BNA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">BOS</span><span class="tok-o">,[</span><span class="tok-n">BOS</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-n">BWI</span><span class="tok-o">,[</span><span class="tok-n">BWI</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-n">DCA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-n">FLL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">IAD</span><span class="tok-o">,[</span><span class="tok-n">IAD</span><span class="tok-o">,</span><span class="tok-n">LHR</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The final piece missing from the query is a way to decide if we reached LHR and count
the number of times we succeeded in doing so. This is done by checking to see that
the length of the result returned has more than one item in it. In other words, did
we get back more than just the starting airport code. To do this, the <em>where</em> step
filters out the paths that did not reach LHR in the specified number of steps.
Finally, rather than displaying the paths as I did in my testing, we now count how
many of the starting airports were able to get to LHR. For my first round of tests I
decided to see how many of the airports can reach LHR in five hops.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-s1">'LHR'</span><span class="tok-o">)).</span>
      <span class="tok-n">filter</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">))).</span>
      <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">union</span><span class="tok-o">(</span>
             <span class="tok-n">identity</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">),</span>
             <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span>
                     <span class="tok-n">emit</span><span class="tok-o">().</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">).</span>
                     <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span>
                     <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)).</span>
             <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)).</span>
             <span class="tok-n">fold</span><span class="tok-o">().</span>
             <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">count</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)))).</span>
      <span class="tok-n">count</span><span class="tok-o">()</span>

<span class="tok-mi">3345</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, with five hops were were able to reach LHR from 3345 of the 3357
airports we are testing. Next I ran the query again but using six hops.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-s1">'LHR'</span><span class="tok-o">)).</span>
      <span class="tok-n">filter</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">))).</span>
      <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">union</span><span class="tok-o">(</span>
             <span class="tok-n">identity</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">),</span>
             <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span>
                     <span class="tok-n">emit</span><span class="tok-o">().</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">6</span><span class="tok-o">).</span>
                     <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span>
                     <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)).</span>
             <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)).</span>
             <span class="tok-n">fold</span><span class="tok-o">().</span>
             <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">count</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)))).</span>
      <span class="tok-n">count</span><span class="tok-o">()</span>

<span class="tok-mi">3354</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So with six hops 3354 of our 3357 airports were able to get to LHR. I then tried
seven hops and found that all but two of the airports were able to reach LHR</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-s1">'LHR'</span><span class="tok-o">)).</span>
      <span class="tok-n">filter</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">))).</span>
      <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">union</span><span class="tok-o">(</span>
             <span class="tok-n">identity</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">),</span>
             <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span>
                     <span class="tok-n">emit</span><span class="tok-o">().</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">7</span><span class="tok-o">).</span>
                     <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span>
                     <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)).</span>
             <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)).</span>
             <span class="tok-n">fold</span><span class="tok-o">().</span>
             <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">count</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)))).</span>
      <span class="tok-n">count</span><span class="tok-o">()</span>

<span class="tok-mi">3355</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This made me curious. I was fairly convinced that there are no airports in the graph
that would not be able to reach LHR in seven hops unless of course they were orphans
but we have already ruled those out as part of our query. So, I decided to go with 30
hops just to make sure. However I still got the answer 3355.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-s1">'LHR'</span><span class="tok-o">)).</span>
      <span class="tok-n">filter</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">))).</span>
      <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">union</span><span class="tok-o">(</span>
             <span class="tok-n">identity</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">),</span>
             <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span>
                     <span class="tok-n">emit</span><span class="tok-o">().</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">30</span><span class="tok-o">).</span>
                     <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span>
                     <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)).</span>
             <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)).</span>
             <span class="tok-n">fold</span><span class="tok-o">().</span>
             <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">count</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)))).</span>
      <span class="tok-n">count</span><span class="tok-o">()</span>

<span class="tok-mi">3355</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This left me with an interesting conclusion. There must be two airports in the graph
that are not orphans, in other words they have some routes, but they are isolated
from the main network. So I needed a query to find them which is the subject of the
next section. What the queries in this section did prove is that from any airport in
the graph, with the exception of the two cases we need to investigate further, London
LHR can be reached in seven hops or less. Hence the title of this section being
"Seven degrees of separation" rather than "Six" !</p>
</div>
<div class="sect3">
<h4 id="mininetworks">5.11.1. Finding isolated sub-networks</h4>
<div class="paragraph">
<p>As discussed above, while I was working on the queries for the previous section I
realized that there are two airports in the graph that are not true orphans, as they
do have routes between each other but that they are part of a small network that is
not itself connected to the main route network. In other words, the network is an
isolated mini network within the main graph and you can never get to London from
either one of them. After more analysis I realized that this was actually due to an
error in my data set which I have fixed in subsequent updates but if you are using
the version 0.77 level of <code>air-routes</code> then the following query will yield the
results shown.</p>
</div>
<div class="paragraph">
<p>To solve the puzzle of the missing airports, I only had to slightly modify the seven
degrees of separation query. Note that if you use the most recent version of the
<code>air-routes</code> data set, this particular error is fixed, but you will find other
isolated networks within the main graph exist. However, these are not due to errors
but rather because there truly are a set of airports in Portugal connected to each
other via commuter airlines but with no way to get from any one of them to the main,
worldwide route network.</p>
</div>
<div class="paragraph">
<p>So, here is the modified form of the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-s1">'LHR'</span><span class="tok-o">)).</span>
      <span class="tok-n">filter</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">))).</span>
      <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">union</span><span class="tok-o">(</span>
             <span class="tok-n">identity</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">),</span>
             <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span>
                     <span class="tok-n">emit</span><span class="tok-o">().</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">7</span><span class="tok-o">).</span>
                     <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span>
                     <span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)).</span>
             <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)).</span>
             <span class="tok-n">fold</span><span class="tok-o">().</span>
             <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">count</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">))).</span>
       <span class="tok-n">unfold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The only change made to this query from the one used in the prior section is that the
<em>where</em> step has been changed to <em>where(count(local).is(1)))</em> so that it now looks
for paths of length one. These represent the airports for which no route to LHR was
found. Then rather than <em>count</em> the paths an <em>unfold</em> is used to return the codes for
the airports that had no route.</p>
</div>
<div class="paragraph">
<p>When the query is run, the codes for the airports with no route to London are
revealed. These airports are truly connected to each other but isolated from the main
route network.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">HPB</span>
<span class="tok-n">VAK</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Just to verify my findings I ran a couple of queries to double check on the routes
from each of these airports. As you can see they were just connected to each other.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'HPB'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>
<span class="tok-o">[</span><span class="tok-n">HPB</span><span class="tok-o">,</span><span class="tok-n">VAK</span><span class="tok-o">]</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'VAK'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>
<span class="tok-o">[</span><span class="tok-n">VAK</span><span class="tok-o">,</span><span class="tok-n">HPB</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This proved both an interesting and useful exercise and uncovered some errors in the
graph that had slipped through my error checking!</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="longestroutes">5.12. Looking for the journey requiring the most stops</h3>
<div class="paragraph">
<p>Sometimes it is interesting to ponder questions such as "Starting from a given
airport what are the most difficult places to get to?". For the sake of this example
let’s define "difficult to get to" as meaning "requires the most hops". By modifying
the query from the previous section we can come up with a way to detect some longest
routes. At the end of the section I have also included examples that show alternative
ways to generate the same result.</p>
</div>
<div class="paragraph">
<p>The query shown below finds every airport that has out going routes and is not Austin
(AUS). For each airport found an attempt is made to get to Austin in ten or fewer
hops. For each airport the attempt is only made once. I decided to use a value of 10
as I was already fairly confident that there would be no airports further away in
terms of stops than that. However, it really does not matter what value is used so
long as it is big enough. A value of 100 does not adversely affect the query given
that the <em>emit</em> step will return a result as soon as AUS is reached. The query will
find a single path between each starting airport and AUS. The <em>where</em> step on the
last line of the query only keeps any paths that have a length of eight or more. So
essentially that says find me only routes that take at least seven hops to get to
Austin as AUS.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-s1">'AUS'</span><span class="tok-o">)).</span>
      <span class="tok-n">filter</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">))).</span>
      <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span>
              <span class="tok-n">emit</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">)).</span>
              <span class="tok-n">times</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">count</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gte</span><span class="tok-o">(</span><span class="tok-mi">8</span><span class="tok-o">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When run, the query may take a few seconds to complete, but should not take more than
that on a typical laptop or desktop. Here are the results of running the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">YPO</span><span class="tok-o">,</span><span class="tok-n">YAT</span><span class="tok-o">,</span><span class="tok-n">ZKE</span><span class="tok-o">,</span><span class="tok-n">YFA</span><span class="tok-o">,</span><span class="tok-n">YMO</span><span class="tok-o">,</span><span class="tok-n">YTS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">YZG</span><span class="tok-o">,</span><span class="tok-n">YIK</span><span class="tok-o">,</span><span class="tok-n">AKV</span><span class="tok-o">,</span><span class="tok-n">YPX</span><span class="tok-o">,</span><span class="tok-n">YGL</span><span class="tok-o">,</span><span class="tok-n">YUL</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">THU</span><span class="tok-o">,</span><span class="tok-n">NAQ</span><span class="tok-o">,</span><span class="tok-n">JUV</span><span class="tok-o">,</span><span class="tok-n">JAV</span><span class="tok-o">,</span><span class="tok-n">GOH</span><span class="tok-o">,</span><span class="tok-n">KEF</span><span class="tok-o">,</span><span class="tok-n">PIT</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The query could also be written using <em>repeat</em> and <em>until</em> steps as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-s1">'AUS'</span><span class="tok-o">)).</span>
      <span class="tok-n">filter</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">neq</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">))).</span>
      <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">simplePath</span><span class="tok-o">()).</span>
        <span class="tok-n">until</span><span class="tok-o">(</span><span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">or</span><span class="tok-o">().</span><span class="tok-na">loops</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-mi">8</span><span class="tok-o">)).</span>
        <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">count</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gte</span><span class="tok-o">(</span><span class="tok-mi">8</span><span class="tok-o">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As before, the same three paths are found.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">YPO</span><span class="tok-o">,</span><span class="tok-n">YAT</span><span class="tok-o">,</span><span class="tok-n">ZKE</span><span class="tok-o">,</span><span class="tok-n">YFA</span><span class="tok-o">,</span><span class="tok-n">YMO</span><span class="tok-o">,</span><span class="tok-n">YTS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">YZG</span><span class="tok-o">,</span><span class="tok-n">YIK</span><span class="tok-o">,</span><span class="tok-n">AKV</span><span class="tok-o">,</span><span class="tok-n">YPX</span><span class="tok-o">,</span><span class="tok-n">YGL</span><span class="tok-o">,</span><span class="tok-n">YUL</span><span class="tok-o">,</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">THU</span><span class="tok-o">,</span><span class="tok-n">NAQ</span><span class="tok-o">,</span><span class="tok-n">JUV</span><span class="tok-o">,</span><span class="tok-n">JAV</span><span class="tok-o">,</span><span class="tok-n">GOH</span><span class="tok-o">,</span><span class="tok-n">KEF</span><span class="tok-o">,</span><span class="tok-n">PIT</span><span class="tok-o">,</span><span class="tok-n">AUS</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="quicklyfindhardest">5.12.1. Quickly finding the hardest to get to airports</h4>
<div class="paragraph">
<p>There are other ways we could write a query that looks for "hard to get to" airports.
The technique shown below essentially relies on using a de-duplication strategy to
make sure you only visit an airport exactly once. Note this is different from the way
the <em>sideEffect</em> step works. That step allows a query to fan out and visit the same
vertex from many places, a many to one type of pattern, but will not allow a
traversal to loop back on itself. By using a de-duplication approach we only visit a
vertex exactly once and remove all other instances of it as the query progresses.
This gives the query processor a lot less work to do and as a result the query
executes more efficiently. The queries below do a bit less filtering than the ones
above but work well if all you are looking for are destinations that, from a given
starting point, require at least a specified number of hops to reach.</p>
</div>
<div class="paragraph">
<p>This time I decided to start with Austin (AUS) and look for any airports that are
only reachable in seven hops. The fact that we are removing duplicates along the way
guarantees that there is not a shorter path to the destinations found. If you are
good at reading backwards, you will see that the results match those found above but
in the reverse order.</p>
</div>
<div class="paragraph">
<p>The first example keeps track of where it has been using a <em>store</em> step and only
continues on to places it has not seen before until seven hops have completed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">without</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">)).</span><span class="tok-na">store</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">)).</span>
        <span class="tok-n">times</span><span class="tok-o">(</span><span class="tok-mi">7</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the results look familiar.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">YUL</span><span class="tok-o">,</span><span class="tok-n">YGL</span><span class="tok-o">,</span><span class="tok-n">YPX</span><span class="tok-o">,</span><span class="tok-n">AKV</span><span class="tok-o">,</span><span class="tok-n">YIK</span><span class="tok-o">,</span><span class="tok-n">YZG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">CPH</span><span class="tok-o">,</span><span class="tok-n">SFJ</span><span class="tok-o">,</span><span class="tok-n">JAV</span><span class="tok-o">,</span><span class="tok-n">JUV</span><span class="tok-o">,</span><span class="tok-n">NAQ</span><span class="tok-o">,</span><span class="tok-n">THU</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">YTS</span><span class="tok-o">,</span><span class="tok-n">YMO</span><span class="tok-o">,</span><span class="tok-n">YFA</span><span class="tok-o">,</span><span class="tok-n">ZKE</span><span class="tok-o">,</span><span class="tok-n">YAT</span><span class="tok-o">,</span><span class="tok-n">YPO</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This alternate version of the query uses a <em>dedup</em> step to achieve the same goal. On
most Gremlin query engines this is an efficient way to look for targets only
reachable in at least the given number of hops. This query is similar to the one used
in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#doesanyrouteexist">Does any route exist between two airports?</a>" section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span>
      <span class="tok-n">repeat</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">dedup</span><span class="tok-o">()).</span>
        <span class="tok-n">times</span><span class="tok-o">(</span><span class="tok-mi">7</span><span class="tok-o">).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span>
        <span class="tok-n">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once again the same results are generated.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">YUL</span><span class="tok-o">,</span><span class="tok-n">YGL</span><span class="tok-o">,</span><span class="tok-n">YPX</span><span class="tok-o">,</span><span class="tok-n">AKV</span><span class="tok-o">,</span><span class="tok-n">YIK</span><span class="tok-o">,</span><span class="tok-n">YZG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">CPH</span><span class="tok-o">,</span><span class="tok-n">SFJ</span><span class="tok-o">,</span><span class="tok-n">JAV</span><span class="tok-o">,</span><span class="tok-n">JUV</span><span class="tok-o">,</span><span class="tok-n">NAQ</span><span class="tok-o">,</span><span class="tok-n">THU</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">YYZ</span><span class="tok-o">,</span><span class="tok-n">YTS</span><span class="tok-o">,</span><span class="tok-n">YMO</span><span class="tok-o">,</span><span class="tok-n">YFA</span><span class="tok-o">,</span><span class="tok-n">ZKE</span><span class="tok-o">,</span><span class="tok-n">YAT</span><span class="tok-o">,</span><span class="tok-n">YPO</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When looking for longest routes in a graph, especially in a highly connected one, you
need to be careful. Notice how I chose a very specific target or a specific number of
hops for my searches.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Looking for longest paths must be done carefully as it can result in very long
running queries.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>If you were to try and write a query that arbitrarily looked for the longest route
between any two airports you run the risk of writing a query that runs for an
extremely long time. In many ways the concept of "longest path" can be viewed as an
anti pattern. This is especially true in highly connected graphs of which
<code>air-routes</code> is an example.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="unwantededges">5.13. Finding unwanted parallel edges</h3>
<div class="paragraph">
<p>In general terms there are many reasons in a graph that there could be more than one
edge between the same two vertices in the same direction. Most property graph
systems allow this and many data models take advantage of this capability. We call
these parallel edges. However, in the <em>air-routes</em> graph we only model the existence
of a route using a single edge from airport A to airport B. It is considered an error
for there to be more than one edge between the same two airports in the same
direction. Note this does not include an edge going the other way (from B to A).</p>
</div>
<div class="paragraph">
<p>During development of the <em>air-routes</em> graph, when I was still cleaning up the data,
I frequently ran into problems with parallel edges getting included in the graph by
mistake. I realized I could use Gremlin to help me detect these error cases.</p>
</div>
<div class="paragraph">
<p>Initially I tried something very basic, that still required quite a bit of manual
reading of the output. I used the following query to tell me if for a given airport
there was more than one outgoing edge to any other airport. This required me to have
a hunch ahead of time which airport vertices might have an issue. Far from ideal when
there are over 3,300 airport vertices in the graph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span>
  <span class="tok-n">order</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">,</span><span class="tok-n">desc</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">().</span><span class="tok-na">max</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the answer came back greater than one I then ran the following query and manually
looked at each result to see where the duplicate edge was.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">,</span><span class="tok-n">desc</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As I said this was a very manual and time consuming process. I clearly needed a
better query. Given what we know about <em>groupCount</em> I realized I could write an
arbitrary query to tell me how many times every single route in the graph exists.
However, given there are over 43,000 routes I was not going to be able to check that
manually. So as is often the best way with Gremlin I built up my query in stages.
First of all I wrote the query to count the occurrence of all routes. I have not
shown all the output from this query as it would take tens of pages but as you can
see from what we have shown, this result would still need a person studying all of
the results. Far from ideal!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s2">"a"</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s2">"b"</span><span class="tok-o">).</span><span class="tok-na">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s2">"a"</span><span class="tok-o">,</span><span class="tok-s2">"b"</span><span class="tok-o">))</span>

<span class="tok-o">[[</span><span class="tok-nl">a:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">],</span><span class="tok-nl">b:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">]]:</span><span class="tok-mi">1</span><span class="tok-o">,[</span><span class="tok-nl">a:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">],</span><span class="tok-nl">b:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">6</span><span class="tok-o">]]:</span><span class="tok-mi">1</span><span class="tok-o">,[</span><span class="tok-nl">a:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">],</span><span class="tok-nl">b:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">7</span><span class="tok-o">]]:</span><span class="tok-mi">1</span> <span class="tok-o">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I then added a filter to only select any routes that occurred more than once. Note
that I had to use <em>unfold</em> before I applied the <em>filter</em> to turn the map back into a
stream of values that could be filtered.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s2">"a"</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s2">"b"</span><span class="tok-o">).</span><span class="tok-na">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s2">"a"</span><span class="tok-o">,</span><span class="tok-s2">"b"</span><span class="tok-o">)).</span><span class="tok-na">unfold</span><span class="tok-o">().</span>
                            <span class="tok-n">filter</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next I added one more step to tell me which routes contained the error.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s2">"a"</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s2">"b"</span><span class="tok-o">).</span><span class="tok-na">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s2">"a"</span><span class="tok-o">,</span><span class="tok-s2">"b"</span><span class="tok-o">)).</span><span class="tok-na">unfold</span><span class="tok-o">().</span>
                            <span class="tok-n">filter</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">))).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">keys</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>One of the errors I ran into was that I had erroneously added the LHR to JFK route
twice into the graph. LHR has the ID of 49 and JFK has the ID of 12. When I ran the
above query I got the following output which told me exactly which route I needed to
correct. This is clearly a much more useful query than the prior ones. I could
happily have stopped at this point but I wanted to see if I could improve the query
some more.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">49</span><span class="tok-o">],</span><span class="tok-nl">b:</span><span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">12</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I was still not totally happy with my query as I really wanted it to give me back the
airport codes. So I added a few more tweaks to do the <em>groupCount</em> using the airport
codes. I have also left the <em>select(keys)</em> off the end of this query as I think it
aids understanding to see what is returned before that step is performed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s2">"a"</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s2">"b"</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">groupCount</span><span class="tok-o">().</span><span class="tok-na">unfold</span><span class="tok-o">()</span>
                           <span class="tok-o">.</span><span class="tok-na">filter</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So what we get back when we run that query is the airport codes as well of the number
of times they have appeared connected to each other by a parallel edge. This is
actually a key/value pair where the contents of the <em>{}</em> are the keys and the <em>=2</em>
part is the value. You could reasonably argue that this is sufficient for me to go
and fix the mistake in the graph. However I want to add just a couple of additional
steps to demonstrate other possible refinements that you may find useful in other
circumstances.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">{</span><span class="tok-n">a</span><span class="tok-o">=</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-n">b</span><span class="tok-o">=</span><span class="tok-n">JFK</span><span class="tok-o">}=</span><span class="tok-mi">2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we don’t want the <em>=2</em> part returned we can just select the keys part.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s2">"a"</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s2">"b"</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">groupCount</span><span class="tok-o">().</span><span class="tok-na">unfold</span><span class="tok-o">()</span>
                           <span class="tok-o">.</span><span class="tok-na">filter</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">))).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">keys</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is what was now returned. Note that the keys themselves are returned in a map
using the <em>a</em> and <em>b</em> terms from our <em>as</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">a:</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-nl">b:</span><span class="tok-n">JFK</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is almost exactly what I wanted but we can add one more tiny step to clean up the
output by just selecting the values from the map returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s2">"a"</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s2">"b"</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">groupCount</span><span class="tok-o">().</span><span class="tok-na">unfold</span><span class="tok-o">()</span>
                           <span class="tok-o">.</span><span class="tok-na">filter</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">).</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">))).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">keys</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So here is the final output, just the codes for the airports with parallel edges
that needed fixing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Note how I built up my Gremlin query in stages to solve this problem. I
recommend this as a sensible way to approach all but the most basic of queries that
you may need to write. Doing it this way has the advantage that you can also check
that each part of the query is working the way you intend it to before you add more
parts to it.
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="groupcountpath">5.13.1. Using <em>groupCount</em> with <em>path</em> to find duplicate edges</h4>
<div class="paragraph">
<p>The prior example found duplicate edges by working with a map created using <em>select</em>
and <em>groupCount</em> steps. It is also possible to use a <em>path</em> step inside a
<em>groupCount</em> step to achieve a similar result.</p>
</div>
<div class="paragraph">
<p>First of all let’s create a duplicate edge between Austin (AUS) and Cancun (CUN).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">addE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'CUN'</span><span class="tok-o">))</span>

<span class="tok-n">e</span><span class="tok-o">[</span><span class="tok-mi">53791</span><span class="tok-o">][</span><span class="tok-mi">3</span><span class="tok-o">-</span><span class="tok-n">route</span><span class="tok-o">-&gt;</span><span class="tok-mi">180</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now use a <em>groupCount</em> step containing a <em>path</em> step to look for duplicate
edges originating in Austin. I used a <em>limit</em> step just to reduce the amount of
output a bit.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
      <span class="tok-n">groupCount</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">,</span><span class="tok-mi">5</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see from the results below the route between AUS and CUN has a count of 2
associated with it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">CUN</span><span class="tok-o">]:</span><span class="tok-mi">2</span><span class="tok-o">,[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">MDW</span><span class="tok-o">]:</span><span class="tok-mi">1</span><span class="tok-o">,[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">MIA</span><span class="tok-o">]:</span><span class="tok-mi">1</span><span class="tok-o">,[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">]:</span><span class="tok-mi">1</span><span class="tok-o">,[</span><span class="tok-n">AUS</span><span class="tok-o">,</span><span class="tok-n">BWI</span><span class="tok-o">]:</span><span class="tok-mi">1</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that this technique does not replace the full query shown in the prior section.
It is more intended to show that you can place a <em>path</em> step inside of a <em>groupCount</em>
step and achieve some useful results.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="flr">5.14. Finding the longest flight route between two adjacent airports in the graph</h3>
<div class="paragraph">
<p>This section is in a way a case study in the good and the bad of the Gremlin query
language. I have documented here the learning steps I went through to get what I
thought was a very simple question expressed as a single Gremlin query. This
documents well the Good,the bad and the sometimes ugly aspects of working with
Gremlin. On the good side it is powerful and some things that should be easy are
easy. On the bad side, some things that appear easy are in fact very hard to get
right especially if you want to build a single query to do a job rather than break it
up into a set of smaller programmatic steps. Let’s look at an example of this with a
real-world query.</p>
</div>
<div class="paragraph">
<p>The query we want to build is to find the route(s) in the graph that are of the
maximum length between any two airports. It turns out that this simple looking query
takes a lot of work to get right if you want to handle the case where there could be
more than one route that is of the maximum length (return flights between the same
two airports don’t count as different routes for this example).</p>
</div>
<div class="paragraph">
<p>While using a <em>max</em> step, as shown below, might seem like the obvious and easy to do
what we need, because of the way that <em>max</em> is implemented it will not work.
Currently the <em>max</em> and <em>min</em> steps cause the prior paths that have been taken in a
traversal to be lost. There is an issue open against TinkerPop for this but until
that issue gets resolved, we need to explore other ways of achieving our desired
result.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">max</span><span class="tok-o">().</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>First of all we could do this (below) The down side of this approach is that both
queries have to look at a lot of edges which is likely to use additional memory and
CPU to process.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">r</span><span class="tok-o">=</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">max</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">r</span><span class="tok-o">).</span><span class="tok-na">bothV</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This next query is more efficient as using an ID means the edges are only searched
once, but this approach would miss the case where more than one route was of the same
(max) length so it does not meet our required success criteria.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">r</span><span class="tok-o">=</span><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span> <span class="tok-n">desc</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'e'</span><span class="tok-o">).</span><span class="tok-na">id</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">(</span><span class="tok-n">r</span><span class="tok-o">).</span><span class="tok-na">dist</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">(</span><span class="tok-n">r</span><span class="tok-o">).</span><span class="tok-na">bothV</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This query is what Daniel Kuppitz from the TinkerPop team recommended after we
discussed this on the mailing list and it does indeed work but from where we started
our experiments to build up this query from there is a non trivial journey!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s2">"route"</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s2">"dist"</span><span class="tok-o">,</span> <span class="tok-n">desc</span><span class="tok-o">).</span><span class="tok-na">store</span><span class="tok-o">(</span><span class="tok-s2">"d"</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s2">"dist"</span><span class="tok-o">).</span>
  <span class="tok-n">filter</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s2">"dist"</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s2">"cd"</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s2">"d"</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">,</span> <span class="tok-mi">1</span><span class="tok-o">)).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s2">"md"</span><span class="tok-o">).</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-s2">"cd"</span><span class="tok-o">,</span><span class="tok-n">eq</span><span class="tok-o">(</span><span class="tok-s2">"md"</span><span class="tok-o">))).</span>
  <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s2">"from"</span><span class="tok-o">,</span><span class="tok-s2">"to"</span><span class="tok-o">,</span><span class="tok-s2">"dist"</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">outV</span><span class="tok-o">()).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">inV</span><span class="tok-o">()).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s2">"dist"</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, to output airport codes rather than just vertices, we can tweak the query
one more time as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">E</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s2">"route"</span><span class="tok-o">).</span><span class="tok-na">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s2">"dist"</span><span class="tok-o">,</span><span class="tok-n">desc</span><span class="tok-o">).</span><span class="tok-na">store</span><span class="tok-o">(</span><span class="tok-s2">"d"</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s2">"dist"</span><span class="tok-o">).</span><span class="tok-err">\</span>
  <span class="tok-n">filter</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s2">"dist"</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s2">"cd"</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s2">"d"</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">limit</span><span class="tok-o">(</span><span class="tok-n">local</span><span class="tok-o">,</span> <span class="tok-mi">1</span><span class="tok-o">)).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s2">"md"</span><span class="tok-o">).</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-s2">"cd"</span><span class="tok-o">,</span><span class="tok-n">eq</span><span class="tok-o">(</span><span class="tok-s2">"md"</span><span class="tok-o">))).</span><span class="tok-err">\</span>
  <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s2">"from"</span><span class="tok-o">,</span><span class="tok-s2">"to"</span><span class="tok-o">,</span><span class="tok-s2">"dist"</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">outV</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">inV</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s2">"dist"</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we are ready to run our query. This is the output from it. Notice how both routes
are between the same city pairs. We could have further refined our query to only show
such combinations once but I will leave that as an exercise for the reader!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">from:</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-nl">to:</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-nl">dist:</span><span class="tok-mi">8818</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">from:</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-nl">to:</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-nl">dist:</span><span class="tok-mi">8818</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="miscq">5.15. Miscellaneous other queries</h3>
<div class="paragraph">
<p>The examples in this section demonstrate a few miscellaneous features and queries
that we have not yet had a chance to examine. Over time, these queries should
probably be moved to other sections of the book.</p>
</div>
<div class="sect3">
<h4 id="_using_a_calculation_inside_of_an_is_step">5.15.1. Using a calculation inside of an <em>is</em> step</h4>
<div class="paragraph">
<p>It is possible to use a mathematical expression inside of an <em>is</em> step. At times this
comes in quite handy. The example below simply divides 500 by 2 as part of a test.
Clearly you would normally just enter 250 but this shows the capability.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">500</span><span class="tok-o">/</span><span class="tok-mi">2</span><span class="tok-o">))).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-n">CDG</span>
<span class="tok-n">FRA</span>
<span class="tok-n">AMS</span>
<span class="tok-n">IST</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The capability becomes more interesting when used in conjunction with a variable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-mi">500</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-n">a</span><span class="tok-o">/</span><span class="tok-mi">2</span><span class="tok-o">))).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-n">CDG</span>
<span class="tok-n">FRA</span>
<span class="tok-n">AMS</span>
<span class="tok-n">IST</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is one more example where we start by setting the variable <em>a</em> to the value that
represents the maximum number of routes from any single airport. The we use a query
to find all the airports that have at least as many outgoing routes as 50 fewer than
our value <em>a</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">local</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()).</span><span class="tok-na">max</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-n">a</span><span class="tok-o">-</span><span class="tok-mi">50</span><span class="tok-o">))).</span>
      <span class="tok-n">project</span><span class="tok-o">(</span><span class="tok-s1">'apt'</span><span class="tok-o">,</span><span class="tok-s1">'routes'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">())</span>

<span class="tok-o">[</span><span class="tok-nl">apt:</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">232</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">apt:</span><span class="tok-n">ORD</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">232</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">apt:</span><span class="tok-n">CDG</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">262</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">apt:</span><span class="tok-n">FRA</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">272</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">apt:</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">230</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">apt:</span><span class="tok-n">PEK</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">234</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">apt:</span><span class="tok-n">AMS</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">269</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">apt:</span><span class="tok-n">MUC</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">237</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-nl">apt:</span><span class="tok-n">IST</span><span class="tok-o">,</span><span class="tok-nl">routes:</span><span class="tok-mi">270</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="beyond">6. MOVING BEYOND THE CONSOLE AND TINKERGRAPH</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Most of the examples we have looked at so far were produced using the Gremlin console
and the TinkerGraph in-memory graph all running on a single machine. However, there
are many ways to deploy and interact with a graph while still using Gremlin and
optionally the Gremlin Console, and many of them go beyond doing everything on a
single machine. The Apache TinkerPop package for example includes a component called
Gremlin Server. Gremlin Server allows you to host a graph database locally or
remotely and talk to it over HTTP or WebSockets. The Gremlin console supports
accessing graphs both locally or remotely or you can access them using your own code
or other tools or even command line utilities such as <em>curl</em>.</p>
</div>
<div class="paragraph">
<p>For a production environment it is likely you will use a technology such as JanusGraph
backed by something like HBase or Cassandra and an indexing technology such as
Solr or Elasticsearch. In these cases the way you work with and manage
the graph and the way that query results are returned will vary.</p>
</div>
<div class="paragraph">
<p>In some cases data returned will be in the form of a GraphSON (JSON) in others it
might be as variables within a program. There are also ways to work with graphs using
Gremlin from a Python Notebook. You might setup your own on-premise graph system or
you might use a hosted service. It’s quite possible you might still
wish to connect to a remote graph using Gremlin Server via the Gremlin Console but
you just as likely could use <em>curl</em> or some other HTTP/REST type of technology. So
that is a long winded way of saying that once you move beyond the basics and head
towards putting a system into production, there are a lot of options to consider.</p>
</div>
<div class="paragraph">
<p>In this section you will find a selection of examples from these more sophisticated
environments. The focus of this book so far has been to teach the Gremlin query and
traversal language, using the Gremlin Console and TinkerGraph as our learning
environment. However, it would be remiss to end our discussion without at least
touching on some of these other environments, how you might configure them and why
you might use them. The following sections are an attempt to whet your appetite for
moving beyond the Gremlin Console into the world of graph application programming and
graph system deployment!</p>
</div>
<div class="sect2">
<h3 id="javatinker">6.1. Working with TinkerGraph from a Java Application</h3>
<div class="paragraph">
<p>So far in this book we have looked at many ways of working with a TinkerGraph
from within the Gremlin Console. As you start to create more sophisticated
applications you will find that the Gremlin Console is just one of the tools you will
need to have available in your toolbox. It is very likely, if not certain, that you
will want to write standalone applications that can work with a graph. There are a
number of different language bindings currently available for TinkerPop 3. One of the
most widely used is the Java API. Apache TinkerPop itself is coded in Java.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You will find several Java samples at the GitHub repository associated with
this book. <a href="https://github.com/krlawrence/graph" class="bare">https://github.com/krlawrence/graph</a>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>As briefly discussed already, when building a commercial application, you may
need capabilities such as ACID transactions and would not use TinkerGraph as your
graph database in those cases. There are however, places where TinkerGraph may be
just what you need. One example might be doing analysis on a static graph that can
fit into memory on your laptop. The <em>air-routes</em> graph is a good example of such a
graph. As a first step towards writing standalone applications that use different
graph database back ends, lets look at a few examples of how you can create a Java
application that uses Gremlin and TinkerGraph.</p>
</div>
<div class="sect3">
<h4 id="tpinterfaces">6.1.1. The Apache TinkerPop interfaces and classes</h4>
<div class="paragraph">
<p>There are a number of Java interfaces and classes, defined by the Apache TinkerPop
project, that you will want to become familiar with. The most recent JavaDoc format
API documentation is always available at
<a href="http://tinkerpop.apache.org/javadocs/current/full" class="bare">http://tinkerpop.apache.org/javadocs/current/full</a></p>
</div>
<div class="paragraph">
<p>The TinkerPop JavaDoc is a bit lacking in terms of English prose but is still a
useful source of reference information when it comes to methods, parameters and
types. Once you have coded up a couple of test programs and got them running, you
should find it gets easier to make progress faster. To that end I recommend you take
a look at the sample code I have included with the book.</p>
</div>
<div class="paragraph">
<p>When using the Gremlin Console your environment is pre-configured for you so you do
not have to import any classes or interfaces. However, as soon as you move to the
domain of the standalone Java application you will need to start importing the
relevant classes that your application builds upon and learn to do a few other things
that you may not have realized that the Gremlin Console was doing on your behalf.</p>
</div>
<div class="paragraph">
<p>By way of a reasonable start, here are some imports that will enable us to do a
number of Gremlin tasks from a Java application. As you add more capabilities to your
application you will of course need to add the appropriate import statements.</p>
</div>
<div class="paragraph">
<p>Take particular note of the rather odd import of the class called "__"
(underscore underscore) on the second line. This is required to enable calling
methods such as <em>in()</em> and <em>out()</em> in a traversal where there is no prior step
to "dot" attach them to (such as inside of a <em>repeat</em> step). If you prefer you
can statically import the "__" class which will make explicit use of
".__" in your code unnecessary except where you are faced with reserved
word conflicts as discussed earlier in this book.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kn">import</span> <span class="tok-nn">org.apache.tinkerpop.gremlin.process.traversal.dsl.graph.GraphTraversalSource</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.tinkerpop.gremlin.process.traversal.dsl.graph.__</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.tinkerpop.gremlin.process.traversal.Path</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.tinkerpop.gremlin.process.traversal.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.tinkerpop.gremlin.structure.Edge</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.tinkerpop.gremlin.structure.Vertex</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.tinkerpop.gremlin.structure.io.IoCore</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.tinkerpop.gremlin.tinkergraph.structure.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.IOException</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.ArrayList</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Map</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Set</span><span class="tok-o">;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="javatp1">6.1.2. Writing our first TinkerPop Java program</h4>
<div class="paragraph">
<p>Now that we have some imports in place, we can start to craft the basic outline of a
Java application. The code below defines a class called <em>TinkerGraphTest</em>, and defines a
<em>main</em> method that creates an in memory TinkerGraph and loads the air routes GraphML
data. Note that as we are now going to be running as a Java program we have to catch
exceptions. This is another thing that is hidden from you when you are working within
the Gremlin Console.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The source code for TinkerGraphTest.java is available in the <em>sample-code</em> folder
located at <a href="https://github.com/krlawrence/graph/tree/master/sample-code" class="bare">https://github.com/krlawrence/graph/tree/master/sample-code</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Lastly in this initial class definition we create a
<em>GraphTraversalSource</em> and we make a Gremlin query to get the property <em>valueMap</em> for
the Austin airport vertex and print it. The <em>toString</em> method provided by the <em>Map</em>
should give us some useful output. Take note of the call to <em>next()</em>. This terminates
the graph traversal and causes the result to be returned. If this call is left off
you will not get back what you were expecting!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">TinkerGraphTest</span>
<span class="tok-o">{</span>
  <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">main</span><span class="tok-o">(</span><span class="tok-n">String</span><span class="tok-o">[]</span> <span class="tok-n">args</span><span class="tok-o">)</span>
  <span class="tok-o">{</span>
    <span class="tok-n">TinkerGraph</span> <span class="tok-n">tg</span> <span class="tok-o">=</span> <span class="tok-n">TinkerGraph</span><span class="tok-o">.</span><span class="tok-na">open</span><span class="tok-o">()</span> <span class="tok-o">;</span>

    <span class="tok-k">try</span>
    <span class="tok-o">{</span>
      <span class="tok-n">tg</span><span class="tok-o">.</span><span class="tok-na">io</span><span class="tok-o">(</span><span class="tok-n">IoCore</span><span class="tok-o">.</span><span class="tok-na">graphml</span><span class="tok-o">()).</span><span class="tok-na">readGraph</span><span class="tok-o">(</span><span class="tok-s">"./air-routes.graphml"</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
    <span class="tok-k">catch</span><span class="tok-o">(</span> <span class="tok-n">IOException</span> <span class="tok-n">e</span> <span class="tok-o">)</span>
    <span class="tok-o">{</span>
      <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">"File not found"</span><span class="tok-o">);</span>
      <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">exit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
    <span class="tok-n">GraphTraversalSource</span> <span class="tok-n">g</span> <span class="tok-o">=</span> <span class="tok-n">tg</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">();</span>
    <span class="tok-n">Map</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">,?&gt;</span> <span class="tok-n">aus</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s">"code"</span><span class="tok-o">,</span><span class="tok-s">"AUS"</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">();</span>
    <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">aus</span><span class="tok-o">);</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="javacompile">6.1.3. Compiling our code</h4>
<div class="paragraph">
<p>Before we can test our program we of course need to compile it. The easiest way to do
this while experimenting is to setup the Java <em>classpath</em> to include the TinkerPop JAR
files. Once you get into writing bigger solutions you will most likely be using a
tool like Apache Maven to control your build. For the purpose of our experiments
here, simple use of the <em>classpath</em> will suffice.</p>
</div>
<div class="paragraph">
<p>The following lines of Bash shell script will setup what you need to both build and
run our small test program. Note that the <em>GREMLIN</em> variable should be set to point
to the root directory of wherever your TinkerPop JAR files are. Later when we start
using JanusGraph you will see that rather than TinkerGraph we will need to adjust
these settings to point to the JanusGraph JAR files.</p>
</div>
<div class="listingblock">
<div class="content">
<pre># Root directory for Gremlin Console install
GREMLIN=...

# Path to Gremlin core JARs
LIBPATH=$GREMLIN/lib/*

# Path to TinkerGraph JARs
EXTPATH=$GREMLIN/ext/*

#Path to additional JARs
ADDL=$GREMLIN/ext/tinkergraph-gremlin/lib/*

# Classpath
export CP=$CLASSPATH:$LIBPATH:$EXTPATH:$ADDL


# Compile
javac -cp $CP TinkerGraphTest.java</pre>
</div>
</div>
<div class="paragraph">
<p>Assuming everything we have coded so far compiled OK, then we can run it using the
same <em>classpath</em> that we created previously.</p>
</div>
<div class="listingblock">
<div class="content">
<pre># Run
java -cp $CP TinkerGraphTest</pre>
</div>
</div>
<div class="paragraph">
<p>The output we get back should look something like the following. If it does, take 30
seconds to celebrate as you have just successfully built and run your first TinkerPop
aware Java app!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-o">{</span><span class="tok-n">country</span><span class="tok-o">=[</span><span class="tok-n">US</span><span class="tok-o">],</span> <span class="tok-n">code</span><span class="tok-o">=[</span><span class="tok-n">AUS</span><span class="tok-o">],</span> <span class="tok-n">longest</span><span class="tok-o">=[</span><span class="tok-mi">12250</span><span class="tok-o">],</span> <span class="tok-n">city</span><span class="tok-o">=[</span><span class="tok-n">Austin</span><span class="tok-o">],</span> <span class="tok-n">elev</span><span class="tok-o">=[</span><span class="tok-mi">542</span><span class="tok-o">],</span> <span class="tok-n">icao</span><span class="tok-o">=[</span><span class="tok-n">KAUS</span><span class="tok-o">],</span> <span class="tok-n">lon</span><span class="tok-o">=[-</span><span class="tok-mf">97.6698989868164</span><span class="tok-o">],</span> <span class="tok-n">type</span><span class="tok-o">=[</span><span class="tok-n">airport</span><span class="tok-o">],</span> <span class="tok-n">region</span><span class="tok-o">=[</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span><span class="tok-o">],</span> <span class="tok-n">runways</span><span class="tok-o">=[</span><span class="tok-mi">2</span><span class="tok-o">],</span> <span class="tok-n">lat</span><span class="tok-o">=[</span><span class="tok-mf">30.1944999694824</span><span class="tok-o">],</span> <span class="tok-n">desc</span><span class="tok-o">=[</span><span class="tok-n">Austin</span> <span class="tok-n">Bergstrom</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span><span class="tok-o">]}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="javaadd">6.1.4. Adding to our Java program</h4>
<div class="paragraph">
<p>Now that we have a basic skeleton application that compiles and runs, we can start to
add more experiments to it. If we add the two lines below we can extract the city
name from the value map that we just generated. From now on as we add to our program
I am just going to show the lines that we add and the additional output that those
new lines will generate.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">List</span> <span class="tok-n">city</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">List</span><span class="tok-o">)(</span><span class="tok-n">aus</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s">"city"</span><span class="tok-o">));</span>
<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">"The AUS airport is in "</span> <span class="tok-o">+</span> <span class="tok-n">city</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So when we compile and run again we should now see this additional line of output.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">The AUS airport is in Austin</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we wanted to nicely print out all of the values returned in our value map we could
do it as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">aus</span><span class="tok-o">.</span><span class="tok-na">forEach</span><span class="tok-o">(</span> <span class="tok-o">(</span><span class="tok-n">k</span><span class="tok-o">,</span><span class="tok-n">v</span><span class="tok-o">)</span> <span class="tok-o">-&gt;</span> <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">"Key: "</span> <span class="tok-o">+</span> <span class="tok-n">k</span> <span class="tok-o">+</span> <span class="tok-s">": Value: "</span> <span class="tok-o">+</span> <span class="tok-n">v</span><span class="tok-o">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Which will generate this output.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-nl">Key:</span> <span class="tok-n">country</span><span class="tok-o">:</span> <span class="tok-n">Value</span><span class="tok-o">:</span> <span class="tok-o">[</span><span class="tok-n">US</span><span class="tok-o">]</span>
<span class="tok-nl">Key:</span> <span class="tok-n">code</span><span class="tok-o">:</span> <span class="tok-n">Value</span><span class="tok-o">:</span> <span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-nl">Key:</span> <span class="tok-n">longest</span><span class="tok-o">:</span> <span class="tok-n">Value</span><span class="tok-o">:</span> <span class="tok-o">[</span><span class="tok-mi">12250</span><span class="tok-o">]</span>
<span class="tok-nl">Key:</span> <span class="tok-n">city</span><span class="tok-o">:</span> <span class="tok-n">Value</span><span class="tok-o">:</span> <span class="tok-o">[</span><span class="tok-n">Austin</span><span class="tok-o">]</span>
<span class="tok-nl">Key:</span> <span class="tok-n">elev</span><span class="tok-o">:</span> <span class="tok-n">Value</span><span class="tok-o">:</span> <span class="tok-o">[</span><span class="tok-mi">542</span><span class="tok-o">]</span>
<span class="tok-nl">Key:</span> <span class="tok-n">icao</span><span class="tok-o">:</span> <span class="tok-n">Value</span><span class="tok-o">:</span> <span class="tok-o">[</span><span class="tok-n">KAUS</span><span class="tok-o">]</span>
<span class="tok-nl">Key:</span> <span class="tok-n">lon</span><span class="tok-o">:</span> <span class="tok-n">Value</span><span class="tok-o">:</span> <span class="tok-o">[-</span><span class="tok-mf">97.6698989868164</span><span class="tok-o">]</span>
<span class="tok-nl">Key:</span> <span class="tok-n">type</span><span class="tok-o">:</span> <span class="tok-n">Value</span><span class="tok-o">:</span> <span class="tok-o">[</span><span class="tok-n">airport</span><span class="tok-o">]</span>
<span class="tok-nl">Key:</span> <span class="tok-n">region</span><span class="tok-o">:</span> <span class="tok-n">Value</span><span class="tok-o">:</span> <span class="tok-o">[</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span><span class="tok-o">]</span>
<span class="tok-nl">Key:</span> <span class="tok-n">runways</span><span class="tok-o">:</span> <span class="tok-n">Value</span><span class="tok-o">:</span> <span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]</span>
<span class="tok-nl">Key:</span> <span class="tok-n">lat</span><span class="tok-o">:</span> <span class="tok-n">Value</span><span class="tok-o">:</span> <span class="tok-o">[</span><span class="tok-mf">30.1944999694824</span><span class="tok-o">]</span>
<span class="tok-nl">Key:</span> <span class="tok-n">desc</span><span class="tok-o">:</span> <span class="tok-n">Value</span><span class="tok-o">:</span> <span class="tok-o">[</span><span class="tok-n">Austin</span> <span class="tok-n">Bergstrom</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So we now know one way to get the property values from a vertex and manipulate them.
Let’s now add something a bit more interesting to our program. The following two
lines count the number of airports you can fly to non stop starting at
Dallas Fort Worth (DFW) and print out that result for us.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Long</span> <span class="tok-n">n</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s">"code"</span><span class="tok-o">,</span><span class="tok-s">"DFW"</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">();</span>
<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">"There are "</span> <span class="tok-o">+</span> <span class="tok-n">n</span> <span class="tok-o">+</span> <span class="tok-s">" routes from Dallas"</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">There are 221 routes from Dallas</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s now add some code to retrieve the airport IATA codes of these 221 airports that we
can fly to non stop from DFW. Note that this time we ended our query with a call to
the <em>toList()</em> method. This will terminate the traversal, and as the name implies,
return the results to us in a list. An <em>order</em> step is used in the traversal so that
we get the airport codes back in ascending order.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">List</span> <span class="tok-n">fromDfw</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s">"code"</span><span class="tok-o">,</span><span class="tok-s">"DFW"</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span>
                     <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s">"code"</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s">"code"</span><span class="tok-o">).</span><span class="tok-na">toList</span><span class="tok-o">();</span>

<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">fromDfw</span><span class="tok-o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The new output that we get back should look like this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-o">[</span><span class="tok-n">ABI</span><span class="tok-o">,</span> <span class="tok-n">ABQ</span><span class="tok-o">,</span> <span class="tok-n">ACT</span><span class="tok-o">,</span> <span class="tok-n">AEX</span><span class="tok-o">,</span> <span class="tok-n">AGU</span><span class="tok-o">,</span> <span class="tok-n">AMA</span><span class="tok-o">,</span> <span class="tok-n">AMS</span><span class="tok-o">,</span> <span class="tok-n">ANC</span><span class="tok-o">,</span> <span class="tok-n">ASE</span><span class="tok-o">,</span> <span class="tok-n">ATL</span><span class="tok-o">,</span> <span class="tok-n">AUH</span><span class="tok-o">,</span> <span class="tok-n">AUS</span><span class="tok-o">,</span> <span class="tok-n">BDL</span><span class="tok-o">,</span> <span class="tok-n">BHM</span><span class="tok-o">,</span> <span class="tok-n">BIL</span><span class="tok-o">,</span> <span class="tok-n">BIS</span><span class="tok-o">,</span> <span class="tok-n">BJX</span><span class="tok-o">,</span> <span class="tok-n">BKG</span><span class="tok-o">,</span> <span class="tok-n">BMI</span><span class="tok-o">,</span> <span class="tok-n">BNA</span><span class="tok-o">,</span> <span class="tok-n">BOG</span><span class="tok-o">,</span> <span class="tok-n">BOI</span><span class="tok-o">,</span> <span class="tok-n">BOS</span><span class="tok-o">,</span> <span class="tok-n">BPT</span><span class="tok-o">,</span> <span class="tok-n">BRO</span><span class="tok-o">,</span> <span class="tok-n">BTR</span><span class="tok-o">,</span> <span class="tok-n">BWI</span><span class="tok-o">,</span> <span class="tok-n">BZE</span><span class="tok-o">,</span> <span class="tok-n">BZN</span><span class="tok-o">,</span> <span class="tok-n">CAE</span><span class="tok-o">,</span> <span class="tok-n">CCS</span><span class="tok-o">,</span> <span class="tok-n">CDG</span><span class="tok-o">,</span> <span class="tok-n">CHA</span><span class="tok-o">,</span> <span class="tok-n">CHS</span><span class="tok-o">,</span> <span class="tok-n">CID</span><span class="tok-o">,</span> <span class="tok-n">CLE</span><span class="tok-o">,</span> <span class="tok-n">CLL</span><span class="tok-o">,</span> <span class="tok-n">CLT</span><span class="tok-o">,</span> <span class="tok-n">CMH</span><span class="tok-o">,</span> <span class="tok-n">CMI</span><span class="tok-o">,</span> <span class="tok-n">CNM</span><span class="tok-o">,</span> <span class="tok-n">COS</span><span class="tok-o">,</span> <span class="tok-n">COU</span><span class="tok-o">,</span> <span class="tok-n">CRP</span><span class="tok-o">,</span> <span class="tok-n">CUN</span><span class="tok-o">,</span> <span class="tok-n">CUU</span><span class="tok-o">,</span> <span class="tok-n">CVG</span><span class="tok-o">,</span> <span class="tok-n">CVN</span><span class="tok-o">,</span> <span class="tok-n">CZM</span><span class="tok-o">,</span> <span class="tok-n">DAY</span><span class="tok-o">,</span> <span class="tok-n">DCA</span><span class="tok-o">,</span> <span class="tok-n">DEN</span><span class="tok-o">,</span> <span class="tok-n">DOH</span><span class="tok-o">,</span> <span class="tok-n">DRO</span><span class="tok-o">,</span> <span class="tok-n">DSM</span><span class="tok-o">,</span> <span class="tok-n">DTW</span><span class="tok-o">,</span> <span class="tok-n">DUS</span><span class="tok-o">,</span> <span class="tok-n">DXB</span><span class="tok-o">,</span> <span class="tok-n">EGE</span><span class="tok-o">,</span> <span class="tok-n">ELP</span><span class="tok-o">,</span> <span class="tok-n">EVV</span><span class="tok-o">,</span> <span class="tok-n">EWR</span><span class="tok-o">,</span> <span class="tok-n">EZE</span><span class="tok-o">,</span> <span class="tok-n">FAR</span><span class="tok-o">,</span> <span class="tok-n">FAT</span><span class="tok-o">,</span> <span class="tok-n">FCO</span><span class="tok-o">,</span> <span class="tok-n">FLL</span><span class="tok-o">,</span> <span class="tok-n">FRA</span><span class="tok-o">,</span> <span class="tok-n">FSD</span><span class="tok-o">,</span> <span class="tok-n">FSM</span><span class="tok-o">,</span> <span class="tok-n">FWA</span><span class="tok-o">,</span> <span class="tok-n">GCK</span><span class="tok-o">,</span> <span class="tok-n">GCM</span><span class="tok-o">,</span> <span class="tok-n">GDL</span><span class="tok-o">,</span> <span class="tok-n">GEG</span><span class="tok-o">,</span> <span class="tok-n">GGG</span><span class="tok-o">,</span> <span class="tok-n">GIG</span><span class="tok-o">,</span> <span class="tok-n">GJT</span><span class="tok-o">,</span> <span class="tok-n">GLH</span><span class="tok-o">,</span> <span class="tok-n">GPT</span><span class="tok-o">,</span> <span class="tok-n">GRI</span><span class="tok-o">,</span> <span class="tok-n">GRK</span><span class="tok-o">,</span> <span class="tok-n">GRR</span><span class="tok-o">,</span> <span class="tok-n">GRU</span><span class="tok-o">,</span> <span class="tok-n">GSO</span><span class="tok-o">,</span> <span class="tok-n">GSP</span><span class="tok-o">,</span> <span class="tok-n">GUA</span><span class="tok-o">,</span> <span class="tok-n">GUC</span><span class="tok-o">,</span> <span class="tok-n">HDN</span><span class="tok-o">,</span> <span class="tok-n">HKG</span><span class="tok-o">,</span> <span class="tok-n">HNL</span><span class="tok-o">,</span> <span class="tok-n">HOU</span><span class="tok-o">,</span> <span class="tok-n">HSV</span><span class="tok-o">,</span> <span class="tok-n">IAD</span><span class="tok-o">,</span> <span class="tok-n">IAH</span><span class="tok-o">,</span> <span class="tok-n">ICN</span><span class="tok-o">,</span> <span class="tok-n">ICT</span><span class="tok-o">,</span> <span class="tok-n">IND</span><span class="tok-o">,</span> <span class="tok-n">JAC</span><span class="tok-o">,</span> <span class="tok-n">JAN</span><span class="tok-o">,</span> <span class="tok-n">JAX</span><span class="tok-o">,</span> <span class="tok-n">JFK</span><span class="tok-o">,</span> <span class="tok-n">JLN</span><span class="tok-o">,</span> <span class="tok-n">KOA</span><span class="tok-o">,</span> <span class="tok-n">LAS</span><span class="tok-o">,</span> <span class="tok-n">LAW</span><span class="tok-o">,</span> <span class="tok-n">LAX</span><span class="tok-o">,</span> <span class="tok-n">LBB</span><span class="tok-o">,</span> <span class="tok-n">LCH</span><span class="tok-o">,</span> <span class="tok-n">LEX</span><span class="tok-o">,</span> <span class="tok-n">LFT</span><span class="tok-o">,</span> <span class="tok-n">LGA</span><span class="tok-o">,</span> <span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-n">LIM</span><span class="tok-o">,</span> <span class="tok-n">LIR</span><span class="tok-o">,</span> <span class="tok-n">LIT</span><span class="tok-o">,</span> <span class="tok-n">LRD</span><span class="tok-o">,</span> <span class="tok-n">MAD</span><span class="tok-o">,</span> <span class="tok-n">MAF</span><span class="tok-o">,</span> <span class="tok-n">MBJ</span><span class="tok-o">,</span> <span class="tok-n">MCI</span><span class="tok-o">,</span> <span class="tok-n">MCO</span><span class="tok-o">,</span> <span class="tok-n">MEI</span><span class="tok-o">,</span> <span class="tok-n">MEM</span><span class="tok-o">,</span> <span class="tok-n">MEX</span><span class="tok-o">,</span> <span class="tok-n">MFE</span><span class="tok-o">,</span> <span class="tok-n">MGA</span><span class="tok-o">,</span> <span class="tok-n">MGM</span><span class="tok-o">,</span> <span class="tok-n">MHK</span><span class="tok-o">,</span> <span class="tok-n">MIA</span><span class="tok-o">,</span> <span class="tok-n">MID</span><span class="tok-o">,</span> <span class="tok-n">MKE</span><span class="tok-o">,</span> <span class="tok-n">MLI</span><span class="tok-o">,</span> <span class="tok-n">MLM</span><span class="tok-o">,</span> <span class="tok-n">MLU</span><span class="tok-o">,</span> <span class="tok-n">MOB</span><span class="tok-o">,</span> <span class="tok-n">MSN</span><span class="tok-o">,</span> <span class="tok-n">MSP</span><span class="tok-o">,</span> <span class="tok-n">MSY</span><span class="tok-o">,</span> <span class="tok-n">MTJ</span><span class="tok-o">,</span> <span class="tok-n">MTY</span><span class="tok-o">,</span> <span class="tok-n">MYR</span><span class="tok-o">,</span> <span class="tok-n">MZT</span><span class="tok-o">,</span> <span class="tok-n">NAS</span><span class="tok-o">,</span> <span class="tok-n">NRT</span><span class="tok-o">,</span> <span class="tok-n">OAK</span><span class="tok-o">,</span> <span class="tok-n">OGG</span><span class="tok-o">,</span> <span class="tok-n">OKC</span><span class="tok-o">,</span> <span class="tok-n">OMA</span><span class="tok-o">,</span> <span class="tok-n">ONT</span><span class="tok-o">,</span> <span class="tok-n">ORD</span><span class="tok-o">,</span> <span class="tok-n">ORF</span><span class="tok-o">,</span> <span class="tok-n">PBC</span><span class="tok-o">,</span> <span class="tok-n">PBI</span><span class="tok-o">,</span> <span class="tok-n">PDX</span><span class="tok-o">,</span> <span class="tok-n">PEK</span><span class="tok-o">,</span> <span class="tok-n">PHL</span><span class="tok-o">,</span> <span class="tok-n">PHX</span><span class="tok-o">,</span> <span class="tok-n">PIA</span><span class="tok-o">,</span> <span class="tok-n">PIB</span><span class="tok-o">,</span> <span class="tok-n">PIT</span><span class="tok-o">,</span> <span class="tok-n">PLS</span><span class="tok-o">,</span> <span class="tok-n">PNS</span><span class="tok-o">,</span> <span class="tok-n">PSP</span><span class="tok-o">,</span> <span class="tok-n">PTY</span><span class="tok-o">,</span> <span class="tok-n">PUJ</span><span class="tok-o">,</span> <span class="tok-n">PVG</span><span class="tok-o">,</span> <span class="tok-n">PVR</span><span class="tok-o">,</span> <span class="tok-n">QRO</span><span class="tok-o">,</span> <span class="tok-n">RAP</span><span class="tok-o">,</span> <span class="tok-n">RDU</span><span class="tok-o">,</span> <span class="tok-n">RIC</span><span class="tok-o">,</span> <span class="tok-n">RNO</span><span class="tok-o">,</span> <span class="tok-n">ROW</span><span class="tok-o">,</span> <span class="tok-n">RSW</span><span class="tok-o">,</span> <span class="tok-n">RTB</span><span class="tok-o">,</span> <span class="tok-n">SAF</span><span class="tok-o">,</span> <span class="tok-n">SAL</span><span class="tok-o">,</span> <span class="tok-n">SAN</span><span class="tok-o">,</span> <span class="tok-n">SAT</span><span class="tok-o">,</span> <span class="tok-n">SAV</span><span class="tok-o">,</span> <span class="tok-n">SBA</span><span class="tok-o">,</span> <span class="tok-n">SCL</span><span class="tok-o">,</span> <span class="tok-n">SDF</span><span class="tok-o">,</span> <span class="tok-n">SEA</span><span class="tok-o">,</span> <span class="tok-n">SFO</span><span class="tok-o">,</span> <span class="tok-n">SGF</span><span class="tok-o">,</span> <span class="tok-n">SHV</span><span class="tok-o">,</span> <span class="tok-n">SJC</span><span class="tok-o">,</span> <span class="tok-n">SJD</span><span class="tok-o">,</span> <span class="tok-n">SJO</span><span class="tok-o">,</span> <span class="tok-n">SJT</span><span class="tok-o">,</span> <span class="tok-n">SJU</span><span class="tok-o">,</span> <span class="tok-n">SLC</span><span class="tok-o">,</span> <span class="tok-n">SLP</span><span class="tok-o">,</span> <span class="tok-n">SMF</span><span class="tok-o">,</span> <span class="tok-n">SNA</span><span class="tok-o">,</span> <span class="tok-n">SPI</span><span class="tok-o">,</span> <span class="tok-n">SPS</span><span class="tok-o">,</span> <span class="tok-n">STL</span><span class="tok-o">,</span> <span class="tok-n">SUX</span><span class="tok-o">,</span> <span class="tok-n">SWO</span><span class="tok-o">,</span> <span class="tok-n">SYD</span><span class="tok-o">,</span> <span class="tok-n">TLH</span><span class="tok-o">,</span> <span class="tok-n">TPA</span><span class="tok-o">,</span> <span class="tok-n">TRC</span><span class="tok-o">,</span> <span class="tok-n">TUL</span><span class="tok-o">,</span> <span class="tok-n">TUS</span><span class="tok-o">,</span> <span class="tok-n">TVC</span><span class="tok-o">,</span> <span class="tok-n">TXK</span><span class="tok-o">,</span> <span class="tok-n">TYR</span><span class="tok-o">,</span> <span class="tok-n">TYS</span><span class="tok-o">,</span> <span class="tok-n">UIO</span><span class="tok-o">,</span> <span class="tok-n">VPS</span><span class="tok-o">,</span> <span class="tok-n">XNA</span><span class="tok-o">,</span> <span class="tok-n">YEG</span><span class="tok-o">,</span> <span class="tok-n">YUL</span><span class="tok-o">,</span> <span class="tok-n">YVR</span><span class="tok-o">,</span> <span class="tok-n">YYC</span><span class="tok-o">,</span> <span class="tok-n">YYZ</span><span class="tok-o">,</span> <span class="tok-n">ZCL</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The next lines will find all routes from London Heathrow to any airport in the United
States. A list of paths will be returned where each path contains the airport codes
and the distance between them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">List</span> <span class="tok-o">&lt;</span><span class="tok-n">Path</span><span class="tok-o">&gt;</span> <span class="tok-n">lhrToUsa</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s">"code"</span><span class="tok-o">,</span><span class="tok-s">"LHR"</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">inV</span><span class="tok-o">().</span>
                             <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s">"country"</span><span class="tok-o">,</span><span class="tok-s">"US"</span><span class="tok-o">).</span>
                             <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s">"code"</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s">"dist"</span><span class="tok-o">).</span><span class="tok-na">toList</span><span class="tok-o">();</span>

<span class="tok-n">lhrToUsa</span><span class="tok-o">.</span><span class="tok-na">forEach</span><span class="tok-o">((</span><span class="tok-n">k</span><span class="tok-o">)</span> <span class="tok-o">-&gt;</span> <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">k</span><span class="tok-o">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should look like this. I arranged the results in columns to aid
readability.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">4896</span><span class="tok-o">,</span> <span class="tok-n">PDX</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">4820</span><span class="tok-o">,</span> <span class="tok-n">IAH</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">3665</span><span class="tok-o">,</span> <span class="tok-n">IAD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">3980</span><span class="tok-o">,</span> <span class="tok-n">CLT</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">4414</span><span class="tok-o">,</span> <span class="tok-n">MIA</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">3860</span><span class="tok-o">,</span> <span class="tok-n">RDU</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">3254</span><span class="tok-o">,</span> <span class="tok-n">BOS</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">4001</span><span class="tok-o">,</span> <span class="tok-n">MSP</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">4783</span><span class="tok-o">,</span> <span class="tok-n">SEA</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">3622</span><span class="tok-o">,</span> <span class="tok-n">BWI</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">3440</span><span class="tok-o">,</span> <span class="tok-n">JFK</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">3939</span><span class="tok-o">,</span> <span class="tok-n">ORD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">4198</span><span class="tok-o">,</span> <span class="tok-n">ATL</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">5439</span><span class="tok-o">,</span> <span class="tok-n">LAX</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">5255</span><span class="tok-o">,</span> <span class="tok-n">PHX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">4901</span><span class="tok-o">,</span> <span class="tok-n">AUS</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">5469</span><span class="tok-o">,</span> <span class="tok-n">SAN</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">5350</span><span class="tok-o">,</span> <span class="tok-n">SFO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">4736</span><span class="tok-o">,</span> <span class="tok-n">DFW</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">4850</span><span class="tok-o">,</span> <span class="tok-n">SLC</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">3753</span><span class="tok-o">,</span> <span class="tok-n">DTW</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">5352</span><span class="tok-o">,</span> <span class="tok-n">SJC</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">3453</span><span class="tok-o">,</span> <span class="tok-n">EWR</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">4655</span><span class="tok-o">,</span> <span class="tok-n">DEN</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">4616</span><span class="tok-o">,</span> <span class="tok-n">MSY</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">5213</span><span class="tok-o">,</span> <span class="tok-n">LAS</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">3533</span><span class="tok-o">,</span> <span class="tok-n">PHL</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The final part of our first Java program shows how to perform a simple <em>repeat</em>
operation. The code below will look for any cities in the UK that you can get to from
Austin with one stop on the way. A key thing to note here is that we have to prefix
the call to <em>out()</em> with the strangely named class "__." that we mentioned at
the start of this discussion of using Java with TinkerPop. If you do not include the
"__." prefix you will get a compilation error as the compiler does not know
where the <em>out</em> step is from.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">List</span> <span class="tok-o">&lt;</span><span class="tok-n">Object</span><span class="tok-o">&gt;</span> <span class="tok-n">eng</span> <span class="tok-o">=</span>
      <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s">"code"</span><span class="tok-o">,</span><span class="tok-s">"AUS"</span><span class="tok-o">).</span><span class="tok-na">repeat</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">()).</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">).</span>
            <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s">"region"</span><span class="tok-o">,</span><span class="tok-s">"GB-ENG"</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s">"city"</span><span class="tok-o">).</span><span class="tok-na">dedup</span><span class="tok-o">().</span><span class="tok-na">toList</span><span class="tok-o">();</span>

<span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">"\nPlaces in England I can get to with one stop from AUS.\n"</span><span class="tok-o">);</span>
<span class="tok-n">eng</span><span class="tok-o">.</span><span class="tok-na">forEach</span><span class="tok-o">(</span> <span class="tok-o">(</span><span class="tok-n">p</span><span class="tok-o">)</span> <span class="tok-o">-&gt;</span> <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">print</span><span class="tok-o">(</span><span class="tok-n">p</span> <span class="tok-o">+</span> <span class="tok-s">" "</span><span class="tok-o">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The code we just added should generate output that looks like this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">Places in England I can get to with one stop from AUS.</span>

<span class="tok-go">Birmingham Bristol London Manchester Leeds Newcastle</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="javastatics">6.1.5. Important Classes and Enums to be aware of</h4>
<div class="paragraph">
<p>When you are using the Gremlin Console, as I have already mentioned, a few things are
done for you that you need to take care of yourself when writing standalone Java
code. A key area that I have found that people making the jump from the console to
Java find confusing is figuring out which Classes and Enums have been statically
imported "behind the scenes" and how to access those same capabilities from Java. You
should also bookmark the TinkerPop javadoc pages as you can find more detail on all
of the classes and enums covered below there. The latest javadoc is always available
at <a href="http://tinkerpop.apache.org/javadocs/current/full/" class="bare">http://tinkerpop.apache.org/javadocs/current/full/</a></p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
There is a sample program called TestImports.java in the <em>sample-code</em> folder
located at <a href="https://github.com/krlawrence/graph/tree/master/sample-code" class="bare">https://github.com/krlawrence/graph/tree/master/sample-code</a> that
demonstrates these constructs being used.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The tables below show some commonly used Gremlin keywords in the left column. The
second column shows how you would reference those same keywords explicitly from a
Java program. The third column shows an example of the context in which they might be
used in a Java program. You may chose to statically import some of these classes into
your code. I prefer to use the explicit prefix but that is a matter of personal
preference in many cases. There is a table of all the available predicates in the
"<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#tranges">Testing values and ranges of values</a>" section. For the special ".__" class I have just shown a few
examples. In general you use this prefix when you have nothing prior in the query
that you can "dot chain" to.</p>
</div>
<div class="paragraph">
<p>If you need to specify how a property value should be treated when added to a vertex
you can use one of the keywords defined as part of the <em>Cardinality</em> enum
which is part of the <em>VertexProperty</em> interface.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. Cardinality</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">single</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cardinality.local</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">property(Cardinality.single,"mykey","ABC")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cardinality.list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">property(Cardinality.list,"mykey","ABC")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">set</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cardinality.set</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">property(Cardinality.set,"mykey","ABC")</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When local scope needs to be specified as a parameter of sort order direction needs
to be specified the statics defined in the  <em>Scope</em> and <em>Order</em> Enums can be used.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <em>Order.incr</em> and <em>Order.decr</em> enumerations were deprecated in the TinkerPop
3.3.4 release in favor of <em>Order.asc</em> and <em>Order.desc</em> to bring the keywords more
into line with other commonly used query languages. As of TinkerPop 3.5.0, <em>incr</em> and
<em>decr</em> were removed from the Gremlin query language altogether.
</td>
</tr>
</tbody></table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Scope and ordering</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">local</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Scope.local</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">order(Scope.local)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">global</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Scope.global</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">order(Scope.global)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">desc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Order.desc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">order().by(Order.desc)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">decr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Order.decr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">order().by(Order.decr)  [Deprecated since 3.3.4, removed
in 3.5.0]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">asc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Order.asc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">order().by(Order.asc)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">incr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Order.incr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">order().by(Order.incr)  [Deprecated since 3.3.4, removed
in 3.5.0]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">shuffle</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Order.shuffle</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">order().by(Order.shuffle)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If you need to access the keys or values from a map data structure you can use the
statics defined in the <em>Column</em> enum.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. Keys and values</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">keys</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Column.keys</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">order().by(Column.keys)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">values</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Column.values</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">order().by(Column.values)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When accessing the <em>id</em> and <em>label</em> values from a <em>valueMap</em> you need to use the
statics defined in the <em>T</em> Enum. The same is true if you want to access the keys and
values from a set of properties.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. Label and id</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">label</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">T.label</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">valueMap(true).next().get(T.label)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">T.id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">valueMap(true).next().get(T.id)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">T.key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">properties().order().by(T.key)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">T.value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">properties().order().by(T.value)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When there is no previous step to "dot chain" to then we can use the ".__"
class as our prefix. If you look at the javadoc for the class you will see it defines
static methods that we can use to call Gremlin functionality in cases like the ones
shown below.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 11. Anonymous references</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">out</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">__.out</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">repeat(__.out())</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">in</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">__.in</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">order().by(__.in("contains"))</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">constant</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">__.constant</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">union(__.constant("b"),__.constant("a"))</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Whenever we need to use a predicate to perform a test, we can use the static methods
defined in the <em>P</em> class. Not all the methods defined are shown below.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 12. Predicates</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">gt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P.gt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">has("runways",P.gt(3))</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">gte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P.gte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">has("runways",P.gte(5))</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P.lt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">has("runways",P.lt(2))</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P.lte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">has("runways",P.lte(2))</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">eq</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P.eq</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">has("city",P.eq("Dallas"))</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">neq</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P.neq</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">has("city",P.neq("Dallas"))</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">within</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P.within</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">has("city",P.within("Dallas","Austin"))</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">without</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P.without</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">has("city",P.without("Dallas"))</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">inside</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P.inside</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">has("runways",P.inside(3,5))</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">outside</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P.outside</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">has("runways",P.outside(2,5))</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">between</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P.between</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">has("runways",P.between(2,5))</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The Apache TinkerPop release 3.4 introduced some new text predicates and a new TextP
class.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 13. Text Predicates</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">startingWith</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TextP.startingWith</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">has("city",TextP.startingWith("Dal"))</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">endingWith</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TextP.endingWith</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">has("city",TextP.endingWith("as"))</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">containing</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TextP.containing</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">has("city",TextP.containing("all"))</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">notStartingWith</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TextP.notStartingWith</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">has("city",TextP.notStartingWith("Dal"))</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">notEndingWith</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TextP.notEndingWith</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">has("city",TextP.notEndingWith("as"))</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">notContaining</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TextP.notContaining</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">has("city",TextP.notContaining("all"))</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If a traversal path has multiple values associated with a single label, such as <em>"x"</em>
then you can use the <em>first</em>, <em>last</em> , <em>all</em> and <em>mixed</em> statics that are defined as
part of the <em>Pop</em> Enum. As the name suggest, <em>first</em> returns the first item in a
collection. Specifying <em>last</em> returns the last item and <em>all</em> returns all of the
items in a collection. Specifying <em>mixed</em> will return a <em>List</em> if the collection has
more than one item. Otherwise an <em>Object</em> will be returned.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 14. First, last, all and mixed</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">first</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pop.first</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">select(Pop.first,"x")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">last</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pop.last</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">select(Pop.last,"x")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">all</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pop.all</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">select(Pop.all,"x")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mixed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pop.mixed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">select(Pop.mixed,"x")</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When working with a <em>sack</em> the operators like <em>sum</em> and <em>assign</em> are defined in the
<em>Operator</em> Enum.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 15. Operators</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sum</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operator.sum</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sack(Operator.sum)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">minus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operator.minus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sack(Operator.minus)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mult</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operator.mult</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sack(Operator.mult)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">div</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operator.div</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sack(Operator.div)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">assign</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operator.assign</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sack(Operator.assign).by(constant(0))</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">min</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operator.min</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sack(Operator.min)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">max</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operator.max</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sack(Operator.max)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">addAll</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operator.addAll</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sack(Operator.addAll)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">and</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operator.and</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sack(Operator.and)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">or</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operator.or</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sack(Operator.or)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <em>Direction</em> Enum defines constants that are used in association with edge
direction.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 16. Direction</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Direction.IN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">myEdge.vertices(Direction.IN)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OUT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Direction.OUT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">myEdge.vertices(Direction.OUT)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BOTH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Direction.BOTH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">myEdge.vertices(Direction.BOTH)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <em>Pick</em> Enum defines constants that are used in association with the <em>branch</em>,
<code>choose</code> and <code>option</code> steps.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 17. Pick</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pick.none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">option(none,constant(<em>no match</em>))</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">any</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pick.any</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">option(any,constant(<em>any picked</em>))</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Another useful tip, that was shared on the Gremlin Users mailing list, is that you
can ask the Gremlin Console to show you a list of everything that has been imported
on your behalf "behind the scenes" using the command <em>:show imports</em>. What might
typically be returned is shown below. I included a version check in the output so in
case this changes in the future you can see which version of Gremlin I queried.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-n">Gremlin</span><span class="tok-o">.</span><span class="tok-na">version</span>
<span class="tok-o">==&gt;</span><span class="tok-mf">3.4</span><span class="tok-o">.</span><span class="tok-mi">10</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the list of imports that the Gremlin Console has setup for us quietly behind
the scenes when we started it. Take particular note of the ones that are <em>static</em>
imports as those are the ones that contain the definitions we discussed above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-o">:</span><span class="tok-n">show</span> <span class="tok-n">imports</span>
<span class="tok-n">Custom</span> <span class="tok-nl">imports:</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">structure</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">structure</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">structure</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.</span><span class="tok-na">reference</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.</span><span class="tok-na">step</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.</span><span class="tok-na">step</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">remote</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">structure</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.</span><span class="tok-na">empty</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">structure</span><span class="tok-o">.</span><span class="tok-na">io</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">structure</span><span class="tok-o">.</span><span class="tok-na">io</span><span class="tok-o">.</span><span class="tok-na">graphml</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">structure</span><span class="tok-o">.</span><span class="tok-na">io</span><span class="tok-o">.</span><span class="tok-na">graphson</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">structure</span><span class="tok-o">.</span><span class="tok-na">io</span><span class="tok-o">.</span><span class="tok-na">gryo</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">commons</span><span class="tok-o">.</span><span class="tok-na">configuration</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.</span><span class="tok-na">strategy</span><span class="tok-o">.</span><span class="tok-na">decoration</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.</span><span class="tok-na">strategy</span><span class="tok-o">.</span><span class="tok-na">optimization</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.</span><span class="tok-na">strategy</span><span class="tok-o">.</span><span class="tok-na">finalization</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.</span><span class="tok-na">strategy</span><span class="tok-o">.</span><span class="tok-na">verification</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.</span><span class="tok-na">dsl</span><span class="tok-o">.</span><span class="tok-na">graph</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">computer</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">computer</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.</span><span class="tok-na">step</span><span class="tok-o">.</span><span class="tok-na">map</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">computer</span><span class="tok-o">.</span><span class="tok-na">clustering</span><span class="tok-o">.</span><span class="tok-na">connected</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">computer</span><span class="tok-o">.</span><span class="tok-na">clone</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">computer</span><span class="tok-o">.</span><span class="tok-na">bulkdumping</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">computer</span><span class="tok-o">.</span><span class="tok-na">bulkloading</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">computer</span><span class="tok-o">.</span><span class="tok-na">clustering</span><span class="tok-o">.</span><span class="tok-na">peerpressure</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">computer</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">computer</span><span class="tok-o">.</span><span class="tok-na">ranking</span><span class="tok-o">.</span><span class="tok-na">pagerank</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">computer</span><span class="tok-o">.</span><span class="tok-na">search</span><span class="tok-o">.</span><span class="tok-na">path</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">computer</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.</span><span class="tok-na">strategy</span><span class="tok-o">.</span><span class="tok-na">optimization</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">computer</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.</span><span class="tok-na">strategy</span><span class="tok-o">.</span><span class="tok-na">decoration</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.</span><span class="tok-na">iterator</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.</span><span class="tok-na">function</span><span class="tok-o">.*</span>
  <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.*</span>
  <span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">sql</span><span class="tok-o">.*</span>
  <span class="tok-kd">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">structure</span><span class="tok-o">.</span><span class="tok-na">io</span><span class="tok-o">.</span><span class="tok-na">IoCore</span><span class="tok-o">.*</span>
  <span class="tok-kd">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.</span><span class="tok-na">P</span><span class="tok-o">.*</span>
  <span class="tok-kd">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.</span><span class="tok-na">AnonymousTraversalSource</span><span class="tok-o">.*</span>
  <span class="tok-kd">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.</span><span class="tok-na">TextP</span><span class="tok-o">.*</span>
  <span class="tok-kd">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.</span><span class="tok-na">dsl</span><span class="tok-o">.</span><span class="tok-na">graph</span><span class="tok-o">.</span><span class="tok-na">__</span><span class="tok-o">.*</span>
  <span class="tok-kd">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">computer</span><span class="tok-o">.</span><span class="tok-na">Computer</span><span class="tok-o">.*</span>
  <span class="tok-kd">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.</span><span class="tok-na">TimeUtil</span><span class="tok-o">.*</span>
  <span class="tok-kd">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">util</span><span class="tok-o">.</span><span class="tok-na">function</span><span class="tok-o">.</span><span class="tok-na">Lambda</span><span class="tok-o">.*</span>
  <span class="tok-kd">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.</span><span class="tok-na">SackFunctions</span><span class="tok-o">.</span><span class="tok-na">Barrier</span><span class="tok-o">.*</span>
  <span class="tok-kd">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">structure</span><span class="tok-o">.</span><span class="tok-na">VertexProperty</span><span class="tok-o">.</span><span class="tok-na">Cardinality</span><span class="tok-o">.*</span>
  <span class="tok-kd">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">structure</span><span class="tok-o">.</span><span class="tok-na">Column</span><span class="tok-o">.*</span>
  <span class="tok-kd">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">structure</span><span class="tok-o">.</span><span class="tok-na">Direction</span><span class="tok-o">.*</span>
  <span class="tok-kd">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.</span><span class="tok-na">Operator</span><span class="tok-o">.*</span>
  <span class="tok-kd">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.</span><span class="tok-na">Order</span><span class="tok-o">.*</span>
  <span class="tok-kd">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.</span><span class="tok-na">Pop</span><span class="tok-o">.*</span>
  <span class="tok-kd">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.</span><span class="tok-na">Scope</span><span class="tok-o">.*</span>
  <span class="tok-kd">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">structure</span><span class="tok-o">.</span><span class="tok-na">T</span><span class="tok-o">.*</span>
  <span class="tok-kd">static</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.</span><span class="tok-na">step</span><span class="tok-o">.</span><span class="tok-na">TraversalOptionParent</span><span class="tok-o">.</span><span class="tok-na">Pick</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">driver</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">driver</span><span class="tok-o">.</span><span class="tok-na">exception</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">driver</span><span class="tok-o">.</span><span class="tok-na">message</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">driver</span><span class="tok-o">.</span><span class="tok-na">ser</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">driver</span><span class="tok-o">.</span><span class="tok-na">remote</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">tinkergraph</span><span class="tok-o">.</span><span class="tok-na">structure</span><span class="tok-o">.*</span>
  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">tinkergraph</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">computer</span><span class="tok-o">.*</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As discussed earlier, you can always use the <em>getClass</em> method or simply <em>.class</em>
while using the Gremlin Console to, in many cases, find out where something is
defined. As we saw in the examples earlier in this section, lot of the keywords such
as  <em>values</em>, <em>id</em> and <em>local</em> are defined as Enums so you can use <em>getClass</em> on them
directly. A few examples are shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-n">label</span><span class="tok-o">.</span><span class="tok-na">getClass</span><span class="tok-o">()</span>
<span class="tok-o">==&gt;</span><span class="tok-kd">class</span> <span class="tok-nc">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">structure</span><span class="tok-o">.</span><span class="tok-na">T</span><span class="tok-n">$1</span>
<span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-n">key</span><span class="tok-o">.</span><span class="tok-na">getClass</span><span class="tok-o">()</span>
<span class="tok-o">==&gt;</span><span class="tok-kd">class</span> <span class="tok-nc">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">structure</span><span class="tok-o">.</span><span class="tok-na">T</span><span class="tok-n">$3</span>
<span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-n">keys</span><span class="tok-o">.</span><span class="tok-na">getClass</span><span class="tok-o">()</span>
<span class="tok-o">==&gt;</span><span class="tok-kd">class</span> <span class="tok-nc">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">structure</span><span class="tok-o">.</span><span class="tok-na">Column</span><span class="tok-n">$1</span>
<span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-n">values</span><span class="tok-o">.</span><span class="tok-na">getClass</span><span class="tok-o">()</span>
<span class="tok-o">==&gt;</span><span class="tok-kd">class</span> <span class="tok-nc">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">structure</span><span class="tok-o">.</span><span class="tok-na">Column</span><span class="tok-n">$2</span>
<span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-n">local</span><span class="tok-o">.</span><span class="tok-na">getClass</span><span class="tok-o">()</span>
<span class="tok-o">==&gt;</span><span class="tok-kd">class</span> <span class="tok-nc">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.</span><span class="tok-na">Scope</span>
<span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-n">Order</span><span class="tok-o">.</span><span class="tok-na">class</span>
<span class="tok-o">==&gt;</span><span class="tok-kd">class</span> <span class="tok-nc">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">process</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">.</span><span class="tok-na">Order</span>
<span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-n">Column</span><span class="tok-o">.</span><span class="tok-na">class</span>
<span class="tok-o">==&gt;</span><span class="tok-kd">class</span> <span class="tok-nc">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">structure</span><span class="tok-o">.</span><span class="tok-na">Column</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you compare this output to the tables above you can see that we have been able to
verify that, for example, that <em>label</em> and <em>key</em> are defined in the <em>T</em> Enum. We can
also see that <em>keys</em> and <em>values</em> are indeed defined in the <em>Column</em> Enum. Lastly, we
can see that <em>local</em> is, as we expected, defined in the <em>Scope</em> Enum.</p>
</div>
</div>
<div class="sect3">
<h4 id="javapredicates">6.1.6. Using Gremlin predicates in a Java application</h4>
<div class="paragraph">
<p>As discussed in the previous section, when you use a Gremlin predicate such as <em>eq</em>
or <em>neq</em> from a Java program you need to prefix it with a <em>"P."</em> which is a reference
to the TinkerPop class of the same name where a set of static methods, representing
the Gremlin predicates, are defined.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You will find a sample program called GraphRegion.java, which contains the code
used in this section, in the sample files directory located at
<a href="https://github.com/krlawrence/graph/tree/master/sample-code" class="bare">https://github.com/krlawrence/graph/tree/master/sample-code</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Take a look at the code below. A method called <em>findByRegion</em> is defined that takes
a String representing a three character airport IATA code as input. The method then
uses a Gremlin query to figure out which geographical region the specified airport is
in and then returns all airports also in that region. Note the use of <em>P.eq</em> as part
of the <em>where</em> step. This is another case of where, because we are not running inside
the Gremlin console, we have to more precisely specify things.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-c1">// Find all airports in the region of the specified airport</span>
<span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">findByRegion</span><span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">iata</span><span class="tok-o">)</span>
<span class="tok-o">{</span>
  <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">"\nRegion code lookup for "</span> <span class="tok-o">+</span> <span class="tok-n">iata</span> <span class="tok-o">);</span>

  <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Object</span><span class="tok-o">&gt;&gt;</span> <span class="tok-n">list</span> <span class="tok-o">=</span>
  <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s">"code"</span><span class="tok-o">,</span><span class="tok-n">iata</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s">"region"</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s">"r"</span><span class="tok-o">).</span>
    <span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s">"airport"</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s">"a"</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s">"region"</span><span class="tok-o">).</span>
        <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">P</span><span class="tok-o">.</span><span class="tok-na">eq</span><span class="tok-o">(</span><span class="tok-s">"r"</span><span class="tok-o">)).</span><span class="tok-na">by</span><span class="tok-o">().</span>
        <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s">"a"</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s">"city"</span><span class="tok-o">,</span><span class="tok-s">"code"</span><span class="tok-o">,</span><span class="tok-s">"region"</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()).</span><span class="tok-na">toList</span><span class="tok-o">();</span>

  <span class="tok-k">for</span><span class="tok-o">(</span><span class="tok-n">List</span> <span class="tok-n">t</span> <span class="tok-o">:</span> <span class="tok-n">list</span><span class="tok-o">)</span>
  <span class="tok-o">{</span>
    <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">t</span><span class="tok-o">);</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we were to call the <em>findByRegion</em> method, passing in a parameter of <em>DEN</em>,
representing the airport in Denver Colorado, the following output should be returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">Region code lookup for DEN</span>
<span class="tok-go">[COS, Colorado Springs, US-CO]</span>
<span class="tok-go">[DEN, Denver, US-CO]</span>
<span class="tok-go">[DRO, Durango, US-CO]</span>
<span class="tok-go">[GJT, Grand Junction, US-CO]</span>
<span class="tok-go">[EGE, Eagle, US-CO]</span>
<span class="tok-go">[HDN, Hayden, US-CO]</span>
<span class="tok-go">[APA, Denver, US-CO]</span>
<span class="tok-go">[TEX, Telluride, US-CO]</span>
<span class="tok-go">[ASE, Aspen, US-CO]</span>
<span class="tok-go">[ALS, Alamosa, US-CO]</span>
<span class="tok-go">[CEZ, Cortez, US-CO]</span>
<span class="tok-go">[GUC, Gunnison, US-CO]</span>
<span class="tok-go">[MTJ, Montrose, US-CO]</span>
<span class="tok-go">[PUB, Pueblo, US-CO]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="javacheck">6.1.7. Checking to see if a query returned a result</h4>
<div class="paragraph">
<p>It is often important to know if a query returned a result before trying to reference
it to avoid those pesky Java Null Pointer Exceptions. Without worrying about Java for
a second consider the query below purely from a Gremlin point of view.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s2">"code"</span><span class="tok-o">,</span><span class="tok-s2">"AUS"</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s2">"edge"</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s2">"code"</span><span class="tok-o">,</span><span class="tok-s2">"SYD"</span><span class="tok-o">).</span>
                        <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s2">"edge"</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s2">"dist"</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The query finds the Austin (AUS) airport and then looks for an outgoing edge
connecting Austin with Sydney (SYD) and then returns the distance value from that
edge. The problem here is that there is no direct route between Austin and Sydney and
therefore no edge to retrieve the distance from. In other words, this query returns no
result. Now, within the Gremlin Console this is not a problem as we just get nothing
back and life goes on. However, take a look at the code below which is a first
attempt at moving the query into Java code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Long</span> <span class="tok-n">result</span> <span class="tok-o">=</span>
      <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s">"code"</span><span class="tok-o">,</span><span class="tok-s">"AUS"</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s">"edge"</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s">"code"</span><span class="tok-o">,</span><span class="tok-s">"SYD"</span><span class="tok-o">).</span>
            <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s">"edge"</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s">"dist"</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On the surface, this looks fine. However, were we to execute this code we would get a
Null Pointer Exception as when we try to call <em>next</em> there is no result to process as
there is no edge between Austin and Sydney and hence no distance value to process.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You will find a sample program called GraphSearch2.java, which contains the code
used in this section, in the sample files directory located at
<a href="https://github.com/krlawrence/graph/tree/master/sample-code" class="bare">https://github.com/krlawrence/graph/tree/master/sample-code</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>So we need a way to check to see if we go a valid result. One such way is to store
the result of the query into a list. Then, worst case, if no results are found, we
will get an empty list back. So, we can rewrite the query as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">List</span> <span class="tok-n">result</span> <span class="tok-o">=</span>
      <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s">"code"</span><span class="tok-o">,</span><span class="tok-s">"AUS"</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s">"edge"</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s">"code"</span><span class="tok-o">,</span><span class="tok-s">"SYD"</span><span class="tok-o">).</span>
            <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s">"edge"</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s">"dist"</span><span class="tok-o">).</span><span class="tok-na">toList</span><span class="tok-o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that the result is in a list we can safely check to see if we got any results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">result</span><span class="tok-o">.</span><span class="tok-na">isEmpty</span><span class="tok-o">())</span>
<span class="tok-o">{</span>
  <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">"No results were found"</span><span class="tok-o">);</span>
<span class="tok-o">}</span>
<span class="tok-k">else</span>
<span class="tok-o">{</span>
  <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">"The distance is "</span> <span class="tok-o">+</span> <span class="tok-n">result</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">));</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we wanted a "pure Gremlin" solution, without using a List and without doing some
post processing, one way we could do it is to use the <em>coalesce</em> step and return a
special constant value, in this case minus one, to indicate that there were no
results found.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">Integer</span> <span class="tok-n">d</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">Integer</span><span class="tok-o">)</span>
    <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s">"code"</span><span class="tok-o">,</span><span class="tok-s">"AUS"</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s">"edge"</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s">"code"</span><span class="tok-o">,</span><span class="tok-s">"SYD"</span><span class="tok-o">).</span>
          <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s">"edge"</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s">"dist"</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">().</span>
          <span class="tok-n">coalesce</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">unfold</span><span class="tok-o">(),</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">constant</span><span class="tok-o">(-</span><span class="tok-mi">1</span><span class="tok-o">)).</span><span class="tok-na">next</span><span class="tok-o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the route exists the distance will be found and returned, otherwise a value of
<em>"-1"</em> will be returned. This is really using the same concept as the <em>toList</em>
example except in this case we generate the list using the <em>fold</em> step within the
query itself. The <em>unfold</em> will return a result if the list is not null, otherwise
the constant value will be returned as <em>coalesce</em> returns the first to yield a
result.</p>
</div>
<div class="paragraph">
<p>There are of course many other ways that you might come up with to solve this problem
but using lists often provides a fairly easy to use solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="javacreate">6.1.8. Creating a new graph from a Java application</h4>
<div class="paragraph">
<p>The code below creates a new (empty) TinkerGraph instance, creates a graph traversal
source object and then uses a traversal to create a small graph.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The full source code for this sample can be found in the file CreateGraph.java
located at <a href="https://github.com/krlawrence/graph/tree/master/sample-code" class="bare">https://github.com/krlawrence/graph/tree/master/sample-code</a>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Note the call to <em>iterate()</em> at the end of the traversal. When running as a
standalone application this is necessary. This is another of those little things that
the Gremlin Console does for you without you realizing it that we have to remember to
do ourselves when not running inside the console.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-c1">// Create a new (empty) TinkerGrap</span>
<span class="tok-n">TinkerGraph</span> <span class="tok-n">tg</span> <span class="tok-o">=</span> <span class="tok-n">TinkerGraph</span><span class="tok-o">.</span><span class="tok-na">open</span><span class="tok-o">()</span> <span class="tok-o">;</span>

<span class="tok-c1">// Create a Traversal source object</span>
<span class="tok-n">GraphTraversalSource</span> <span class="tok-n">g</span> <span class="tok-o">=</span> <span class="tok-n">tg</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">();</span>

<span class="tok-c1">// Add some nodes and vertices - Note the use of "iterate".</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">addV</span><span class="tok-o">(</span><span class="tok-s">"airport"</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s">"code"</span><span class="tok-o">,</span><span class="tok-s">"AUS"</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s">"aus"</span><span class="tok-o">).</span>
  <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s">"airport"</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s">"code"</span><span class="tok-o">,</span><span class="tok-s">"DFW"</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s">"dfw"</span><span class="tok-o">).</span>
  <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s">"airport"</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s">"code"</span><span class="tok-o">,</span><span class="tok-s">"LAX"</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s">"lax"</span><span class="tok-o">).</span>
  <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s">"airport"</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s">"code"</span><span class="tok-o">,</span><span class="tok-s">"JFK"</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s">"jfk"</span><span class="tok-o">).</span>
  <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s">"airport"</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s">"code"</span><span class="tok-o">,</span><span class="tok-s">"ATL"</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s">"atl"</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s">"route"</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s">"aus"</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s">"dfw"</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s">"route"</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s">"aus"</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s">"atl"</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s">"route"</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s">"atl"</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s">"dfw"</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s">"route"</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s">"atl"</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s">"jfk"</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s">"route"</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s">"dfw"</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s">"jfk"</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s">"route"</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s">"dfw"</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s">"lax"</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s">"route"</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s">"lax"</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s">"jfk"</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s">"route"</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s">"lax"</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s">"aus"</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s">"route"</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s">"lax"</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s">"dfw"</span><span class="tok-o">).</span><span class="tok-na">iterate</span><span class="tok-o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Having created a new graph we can run some queries to make sure it looks correct.
Firstly, let’s check that the vertices were created and look at the IDs that were
allocated to them. As with prior examples, a call to <em>valueMap</em> with a parameter of
<em>true</em> will return what we need. What we will get back from this code is a list of
maps, with each map containing keys for the airport code, the vertex ID and the
vertex label.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Map</span><span class="tok-o">&lt;</span><span class="tok-n">Object</span><span class="tok-o">,</span><span class="tok-n">Object</span><span class="tok-o">&gt;&gt;</span> <span class="tok-n">vm</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">ArrayList</span><span class="tok-o">&lt;</span><span class="tok-n">Map</span><span class="tok-o">&lt;</span><span class="tok-n">Object</span><span class="tok-o">,</span><span class="tok-n">Object</span><span class="tok-o">&gt;&gt;()</span> <span class="tok-o">;</span>

<span class="tok-n">vm</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">).</span><span class="tok-na">toList</span><span class="tok-o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Having got our list of maps back we can process them. Note that to get the <em>id</em> and
<em>label</em> values from the map I had to prefix the key name with a <em>"T."</em>. This is
because while most of property keys are Strings, IDs and labels are a special case.
If you look at the TinkerPop documentation you will see that T is a Java Enum that
contains definitions for <em>T.id</em>, <em>T.label</em>, <em>T.value</em> and <em>T.key</em>. When working with
Gremlin in Java it is important to remember that we need to use the <em>"T."</em> prefix in
cases where when using the Gremlin Console we would not have to.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-c1">// Dislpay the code property as well as the label and id.</span>
<span class="tok-k">for</span><span class="tok-o">(</span> <span class="tok-n">Map</span> <span class="tok-n">m</span> <span class="tok-o">:</span> <span class="tok-n">vm</span><span class="tok-o">)</span>
<span class="tok-o">{</span>
  <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(((</span><span class="tok-n">List</span><span class="tok-o">)(</span><span class="tok-n">m</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s">"code"</span><span class="tok-o">))).</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">)</span> <span class="tok-o">+</span> <span class="tok-s">" "</span> <span class="tok-o">+</span>
                             <span class="tok-n">m</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-n">T</span><span class="tok-o">.</span><span class="tok-na">id</span><span class="tok-o">)</span> <span class="tok-o">+</span> <span class="tok-s">" "</span> <span class="tok-o">+</span> <span class="tok-n">m</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-n">T</span><span class="tok-o">.</span><span class="tok-na">label</span><span class="tok-o">));</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If all has gone well during graph creation, we should get back a list like the one
below that shows us the ID that has been given to each vertex.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-n">AUS</span> <span class="tok-mi">0</span> <span class="tok-n">airport</span>
<span class="tok-n">DFW</span> <span class="tok-mi">2</span> <span class="tok-n">airport</span>
<span class="tok-n">LAX</span> <span class="tok-mi">4</span> <span class="tok-n">airport</span>
<span class="tok-n">JFK</span> <span class="tok-mi">6</span> <span class="tok-n">airport</span>
<span class="tok-n">ATL</span> <span class="tok-mi">8</span> <span class="tok-n">airport</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, let’s check that the edges were created correctly by displaying all of the
paths between vertices in our new graph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-c1">// Display the routes in the graph we just created</span>

<span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Path</span><span class="tok-o">&gt;</span> <span class="tok-n">paths</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">ArrayList</span><span class="tok-o">&lt;</span><span class="tok-n">Path</span><span class="tok-o">&gt;();</span>

<span class="tok-n">paths</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s">"code"</span><span class="tok-o">).</span><span class="tok-na">toList</span><span class="tok-o">();</span>

<span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Path</span> <span class="tok-n">p</span> <span class="tok-o">:</span> <span class="tok-n">paths</span><span class="tok-o">)</span>
<span class="tok-o">{</span>
  <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-na">toString</span><span class="tok-o">());</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once again, if everything has worked as expected, here is what we should get back.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span> <span class="tok-n">DFW</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">,</span> <span class="tok-n">ATL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span> <span class="tok-n">JFK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span> <span class="tok-n">LAX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LAX</span><span class="tok-o">,</span> <span class="tok-n">JFK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LAX</span><span class="tok-o">,</span> <span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LAX</span><span class="tok-o">,</span> <span class="tok-n">DFW</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">,</span> <span class="tok-n">DFW</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">,</span> <span class="tok-n">JFK</span><span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="javasave">6.1.9. Saving a graph from a Java application</h4>
<div class="paragraph">
<p>Having created our new graph, we may want to save it. The code below shows how to
save the graph as either GraphSON (TinkerPop’s JSON format) or as GraphML (XML). This
is another instance where we have to do a bit more work as we are running in a
standalone program and not inside the Gremlin Console. Our attempts to save our data
have to catch any exceptions that may occur. This code is also included as part of
the CreateGraph.java sample program.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-c1">// Save the graph we just created as GraphML (XML) or GraphSON (JSON)</span>
<span class="tok-k">try</span>
<span class="tok-o">{</span>
  <span class="tok-c1">// If you want to save the graph as GraphML uncomment the next line</span>
  <span class="tok-n">tg</span><span class="tok-o">.</span><span class="tok-na">io</span><span class="tok-o">(</span><span class="tok-n">IoCore</span><span class="tok-o">.</span><span class="tok-na">graphml</span><span class="tok-o">()).</span><span class="tok-na">writeGraph</span><span class="tok-o">(</span><span class="tok-s">"mygraph.graphml"</span><span class="tok-o">);</span>

  <span class="tok-c1">// If you want to save the graph as JSON uncomment the next line</span>
  <span class="tok-n">tg</span><span class="tok-o">.</span><span class="tok-na">io</span><span class="tok-o">(</span><span class="tok-n">IoCore</span><span class="tok-o">.</span><span class="tok-na">graphson</span><span class="tok-o">()).</span><span class="tok-na">writeGraph</span><span class="tok-o">(</span><span class="tok-s">"mygraph.json"</span><span class="tok-o">);</span>
<span class="tok-o">}</span>
<span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">IOException</span> <span class="tok-n">ioe</span><span class="tok-o">)</span>
<span class="tok-o">{</span>
  <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s">"Graph failed to save"</span><span class="tok-o">);</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="groovyapp">6.2. Working with TinkerGraph from a Groovy application</h3>
<div class="paragraph">
<p>Earlier in this book, in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#grv">Making Gremlin even Groovier</a>" section we explored the ways that you can
use Groovy code within the Gremlin Console. However, we have not yet looked at how
you can use a standalone Groovy application to work with a TinkerGraph.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You will find several Groovy samples at the GitHub repository associated with
this book. <a href="https://github.com/krlawrence/graph" class="bare">https://github.com/krlawrence/graph</a>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>In this section we will rewrite parts of the test application we coded in Java
earlier in Groovy. A lot of what was covered in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#javatinker">Working with TinkerGraph from a Java Application</a>" section is
equally relevant here and I have not duplicated that material. So even if you are
writing a Groovy application please also give that section a read.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The examples in this section are taken from a sample program called
TinkerGraphTest.groovy that you will find in the sample code folder located at
<a href="https://github.com/krlawrence/graph/tree/master/sample-code" class="bare">https://github.com/krlawrence/graph/tree/master/sample-code</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>It is assumed that you have downloaded and installed Groovy for your environment and
have set the PATH to point to wherever the Groovy binaries are located. Just as in
the Java example, the first thing we need to do is pull in via <em>import</em> all of the
TinkerPop 3 classes that our program will use.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">import</span> <span class="tok-nn">org.apache.tinkerpop.gremlin.process.traversal.dsl.graph.GraphTraversalSource</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.tinkerpop.gremlin.process.traversal.dsl.graph.__</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.tinkerpop.gremlin.process.traversal.Path</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.tinkerpop.gremlin.process.traversal.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.tinkerpop.gremlin.structure.Edge</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.tinkerpop.gremlin.structure.Vertex</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.tinkerpop.gremlin.structure.io.IoCore</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.tinkerpop.gremlin.tinkergraph.structure.*</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.tinkerpop.gremlin.tinkergraph.structure.TinkerGraph</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.tinkerpop.gremlin.util.Gremlin</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.io.IOException</span><span class="tok-o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Having imported the classes we need, we can make a start on our application.
Initially we are just going to display the version of TinkerPop that we are using.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">println</span> <span class="tok-s2">"The Gremlin version is ${Gremlin.version()}"</span>

<span class="tok-kt">def</span> <span class="tok-n">tg</span> <span class="tok-o">=</span> <span class="tok-n">TinkerGraph</span><span class="tok-o">.</span><span class="tok-na">open</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We are now ready to create a new TinkerGraph instance and try to load the air routes
graph. We can do this in Groovy just like we did in the Java example. Unlike Java,
however, Groovy does not require you to catch exceptions that may get thrown but as a
best practice it is probably a good idea to still do so when you need to take some
specific action if an exception does happen.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">println</span> <span class="tok-s2">"Loading the air-routes graph...\n"</span>

<span class="tok-c1">// Load the air-routes graph</span>
<span class="tok-k">try</span>
<span class="tok-o">{</span>
  <span class="tok-n">tg</span><span class="tok-o">.</span><span class="tok-na">io</span><span class="tok-o">(</span><span class="tok-n">IoCore</span><span class="tok-o">.</span><span class="tok-na">graphml</span><span class="tok-o">()).</span><span class="tok-na">readGraph</span><span class="tok-o">(</span><span class="tok-s2">"air-routes.graphml"</span><span class="tok-o">);</span>
<span class="tok-o">}</span>
<span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">IOException</span> <span class="tok-n">e</span><span class="tok-o">)</span>
<span class="tok-o">{</span>
  <span class="tok-n">println</span> <span class="tok-s2">"Could not load the graph file"</span>
  <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">exit</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">);</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Assuming we did not get an exception we can go ahead and create our graph traversal
object.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Create a graph traversal source object and find the Austin airport vertex</span>
<span class="tok-kt">def</span> <span class="tok-n">g</span> <span class="tok-o">=</span> <span class="tok-n">tg</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>First we just do a simple query to find the vertex representing the AUS airport and
use <em>println</em> to display some information about it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">aus</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()</span>

<span class="tok-n">println</span> <span class="tok-n">aus</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Just as when we were looking at building a Java application, you need to
terminate your query with a step such as <em>next</em>, <em>toList</em> or <em>fill</em> to make sure you
get back the results that you expect.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Now we have the beginnings of an application it’s time to make sure we can compile
it. The key thing we need to do is make sure we pickup the TinkerPop specific JAR
files as shown in the next section.</p>
</div>
<div class="sect3">
<h4 id="groovyc">6.2.1. Compiling our Groovy application</h4>
<div class="paragraph">
<p>In the Java example, I included the CLASSPATH on the <em>javac</em> invokation using the
<em>-cp</em> flag. That can also be done when using Groovy, however, if you are using
Microsoft Windows as your build environment you may find that using <em>-cp</em> gives
unexpected errors. Therefore, it is recommended to define the CLASSPATH variable in
your environment before running the Groovy compiler.</p>
</div>
<div class="paragraph">
<p>The commands below work in a Bash shell but could be easily ported to other
environments. The GREMLIN variable should point to wherever you have installed and
unzipped the Gremlin Console download</p>
</div>
<div class="listingblock">
<div class="content">
<pre># Root directory for Gremlin Console install
GREMLIN=...

# Path to Gremlin core JARs
LIBPATH=$GREMLIN/lib/*

# Path to TinkerGraph JARs
EXTPATH=$GREMLIN/ext/*

#Path to additional JARs
ADDL=$GREMLIN/ext/tinkergraph-gremlin/lib/*

# Classpath
export CLASSPATH=$CLASSPATH:$LIBPATH:$EXTPATH:$ADDL

# Compile
groovyc TinkerGraphTest.groovy</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_running_our_groovy_application">6.2.2. Running our Groovy application</h4>
<div class="paragraph">
<p>Assuming everything compiled cleanly we can now run our Groovy application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">groovy</span> <span class="tok-n">TinkerGraphTest</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And here is the sort of output we should get back.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">Gremlin</span> <span class="tok-n">version</span> <span class="tok-n">is</span> <span class="tok-mf">3.3</span><span class="tok-o">.</span><span class="tok-mi">1</span>
<span class="tok-n">Loading</span> <span class="tok-n">the</span> <span class="tok-n">air</span><span class="tok-o">-</span><span class="tok-n">routes</span> <span class="tok-n">graph</span><span class="tok-o">...</span>

<span class="tok-o">[</span><span class="tok-nl">country:</span><span class="tok-o">[</span><span class="tok-n">US</span><span class="tok-o">],</span> <span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">],</span> <span class="tok-nl">longest:</span><span class="tok-o">[</span><span class="tok-mi">12250</span><span class="tok-o">],</span> <span class="tok-nl">city:</span><span class="tok-o">[</span><span class="tok-n">Austin</span><span class="tok-o">],</span> <span class="tok-nl">elev:</span><span class="tok-o">[</span><span class="tok-mi">542</span><span class="tok-o">],</span> <span class="tok-nl">icao:</span><span class="tok-o">[</span><span class="tok-n">KAUS</span><span class="tok-o">],</span> <span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">97.6698989868164</span><span class="tok-o">],</span> <span class="tok-nl">type:</span><span class="tok-o">[</span><span class="tok-n">airport</span><span class="tok-o">],</span> <span class="tok-nl">region:</span><span class="tok-o">[</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span><span class="tok-o">],</span> <span class="tok-nl">runways:</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">],</span> <span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">30.1944999694824</span><span class="tok-o">],</span> <span class="tok-nl">desc:</span><span class="tok-o">[</span><span class="tok-n">Austin</span> <span class="tok-n">Bergstrom</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have a small skeleton of a test program running, we can start to add a
few more interesting features to it.</p>
</div>
</div>
<div class="sect3">
<h4 id="_adding_to_our_groovy_application">6.2.3. Adding to our Groovy application</h4>
<div class="paragraph">
<p>The code below demonstrates how to work with the <em>valueMap</em> for the Austin vertex
that we created a few lines back in our program.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Retieve the city name property and display it</span>
<span class="tok-kt">def</span> <span class="tok-n">city</span> <span class="tok-o">=</span> <span class="tok-n">aus</span><span class="tok-o">[</span><span class="tok-s1">'city'</span><span class="tok-o">]</span>
<span class="tok-n">println</span> <span class="tok-s2">"\nThe AUS airport is in ${city[0]}\n"</span>

<span class="tok-c1">// Iterate through the keys we got back and print them along with their values</span>
<span class="tok-n">aus</span><span class="tok-o">.</span><span class="tok-na">each</span> <span class="tok-o">{</span><span class="tok-n">println</span> <span class="tok-s2">"${it.key} : ${it.value[0]}"</span><span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we were to re-compile and run our program now, the lines that we added will
generate the following output.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">The</span> <span class="tok-n">AUS</span> <span class="tok-n">airport</span> <span class="tok-n">is</span> <span class="tok-k">in</span> <span class="tok-n">Austin</span>

<span class="tok-n">country</span> <span class="tok-o">:</span> <span class="tok-n">US</span>
<span class="tok-n">code</span> <span class="tok-o">:</span> <span class="tok-n">AUS</span>
<span class="tok-n">longest</span> <span class="tok-o">:</span> <span class="tok-mi">12250</span>
<span class="tok-n">city</span> <span class="tok-o">:</span> <span class="tok-n">Austin</span>
<span class="tok-n">elev</span> <span class="tok-o">:</span> <span class="tok-mi">542</span>
<span class="tok-n">icao</span> <span class="tok-o">:</span> <span class="tok-n">KAUS</span>
<span class="tok-n">lon</span> <span class="tok-o">:</span> <span class="tok-o">-</span><span class="tok-mf">97.6698989868164</span>
<span class="tok-n">type</span> <span class="tok-o">:</span> <span class="tok-n">airport</span>
<span class="tok-n">region</span> <span class="tok-o">:</span> <span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span>
<span class="tok-n">runways</span> <span class="tok-o">:</span> <span class="tok-mi">2</span>
<span class="tok-n">lat</span> <span class="tok-o">:</span> <span class="tok-mf">30.1944999694824</span>
<span class="tok-n">desc</span> <span class="tok-o">:</span> <span class="tok-n">Austin</span> <span class="tok-n">Bergstrom</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As we did in our Java program earlier, we can add a query to see how many routes
there are that originate at the DFW airport.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">n</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s2">"code"</span><span class="tok-o">,</span><span class="tok-s2">"DFW"</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()</span>
<span class="tok-n">println</span> <span class="tok-s2">"\nThere are  ${n} routes from Dallas"</span>

<span class="tok-n">There</span> <span class="tok-n">are</span>  <span class="tok-mi">221</span> <span class="tok-n">routes</span> <span class="tok-n">from</span> <span class="tok-n">Dallas</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next we can add some code to find the IATA codes representing the places that we can
fly to from DFW.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Where can I fly to from DFW?</span>
<span class="tok-kt">def</span> <span class="tok-n">fromDfw</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s2">"code"</span><span class="tok-o">,</span><span class="tok-s2">"DFW"</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s2">"code"</span><span class="tok-o">).</span><span class="tok-na">toList</span><span class="tok-o">()</span>
<span class="tok-n">println</span> <span class="tok-s2">"\nHere are the places you can fly to from DFW\n"</span>
<span class="tok-n">println</span> <span class="tok-n">fromDfw</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When we run the code we should get back some results that look like this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">Here</span> <span class="tok-n">are</span> <span class="tok-n">the</span> <span class="tok-n">places</span> <span class="tok-n">you</span> <span class="tok-n">can</span> <span class="tok-n">fly</span> <span class="tok-n">to</span> <span class="tok-n">from</span> <span class="tok-n">DFW</span>

<span class="tok-o">[</span><span class="tok-n">CID</span><span class="tok-o">,</span> <span class="tok-n">HNL</span><span class="tok-o">,</span> <span class="tok-n">HOU</span><span class="tok-o">,</span> <span class="tok-n">SAN</span><span class="tok-o">,</span> <span class="tok-n">SNA</span><span class="tok-o">,</span> <span class="tok-n">SLC</span><span class="tok-o">,</span> <span class="tok-n">LAS</span><span class="tok-o">,</span> <span class="tok-n">DEN</span><span class="tok-o">,</span> <span class="tok-n">SAT</span><span class="tok-o">,</span> <span class="tok-n">MSY</span><span class="tok-o">,</span> <span class="tok-n">EWR</span><span class="tok-o">,</span> <span class="tok-n">DTW</span><span class="tok-o">,</span> <span class="tok-n">ELP</span><span class="tok-o">,</span> <span class="tok-n">SJU</span><span class="tok-o">,</span> <span class="tok-n">CLE</span><span class="tok-o">,</span> <span class="tok-n">OAK</span><span class="tok-o">,</span> <span class="tok-n">TUS</span><span class="tok-o">,</span> <span class="tok-n">SAF</span><span class="tok-o">,</span> <span class="tok-n">PHL</span><span class="tok-o">,</span> <span class="tok-n">GEG</span><span class="tok-o">,</span> <span class="tok-n">BZN</span><span class="tok-o">,</span> <span class="tok-n">JAC</span><span class="tok-o">,</span> <span class="tok-n">GCM</span><span class="tok-o">,</span> <span class="tok-n">MEI</span><span class="tok-o">,</span> <span class="tok-n">PIB</span><span class="tok-o">,</span> <span class="tok-n">KOA</span><span class="tok-o">,</span> <span class="tok-n">SUX</span><span class="tok-o">,</span> <span class="tok-n">SBA</span><span class="tok-o">,</span> <span class="tok-n">ASE</span><span class="tok-o">,</span> <span class="tok-n">CVN</span><span class="tok-o">,</span> <span class="tok-n">BKG</span><span class="tok-o">,</span> <span class="tok-n">BIS</span><span class="tok-o">,</span> <span class="tok-n">GUC</span><span class="tok-o">,</span> <span class="tok-n">MTJ</span><span class="tok-o">,</span> <span class="tok-n">TVC</span><span class="tok-o">,</span> <span class="tok-n">CNM</span><span class="tok-o">,</span> <span class="tok-n">GLH</span><span class="tok-o">,</span> <span class="tok-n">SWO</span><span class="tok-o">,</span> <span class="tok-n">BIL</span><span class="tok-o">,</span> <span class="tok-n">MAF</span><span class="tok-o">,</span> <span class="tok-n">BDL</span><span class="tok-o">,</span> <span class="tok-n">RAP</span><span class="tok-o">,</span> <span class="tok-n">SDF</span><span class="tok-o">,</span> <span class="tok-n">SHV</span><span class="tok-o">,</span> <span class="tok-n">BOI</span><span class="tok-o">,</span> <span class="tok-n">LBB</span><span class="tok-o">,</span> <span class="tok-n">RNO</span><span class="tok-o">,</span> <span class="tok-n">CMH</span><span class="tok-o">,</span> <span class="tok-n">ICT</span><span class="tok-o">,</span> <span class="tok-n">ACT</span><span class="tok-o">,</span> <span class="tok-n">CLL</span><span class="tok-o">,</span> <span class="tok-n">ABI</span><span class="tok-o">,</span> <span class="tok-n">SGF</span><span class="tok-o">,</span> <span class="tok-n">RIC</span><span class="tok-o">,</span> <span class="tok-n">CCS</span><span class="tok-o">,</span> <span class="tok-n">TXK</span><span class="tok-o">,</span> <span class="tok-n">PIA</span><span class="tok-o">,</span> <span class="tok-n">LEX</span><span class="tok-o">,</span> <span class="tok-n">GUA</span><span class="tok-o">,</span> <span class="tok-n">CRP</span><span class="tok-o">,</span> <span class="tok-n">MTY</span><span class="tok-o">,</span> <span class="tok-n">AMA</span><span class="tok-o">,</span> <span class="tok-n">BJX</span><span class="tok-o">,</span> <span class="tok-n">BMI</span><span class="tok-o">,</span> <span class="tok-n">BOG</span><span class="tok-o">,</span> <span class="tok-n">BPT</span><span class="tok-o">,</span> <span class="tok-n">DSM</span><span class="tok-o">,</span> <span class="tok-n">MYR</span><span class="tok-o">,</span> <span class="tok-n">AEX</span><span class="tok-o">,</span> <span class="tok-n">CZM</span><span class="tok-o">,</span> <span class="tok-n">AGU</span><span class="tok-o">,</span> <span class="tok-n">COU</span><span class="tok-o">,</span> <span class="tok-n">DAY</span><span class="tok-o">,</span> <span class="tok-n">CUU</span><span class="tok-o">,</span> <span class="tok-n">DRO</span><span class="tok-o">,</span> <span class="tok-n">BRO</span><span class="tok-o">,</span> <span class="tok-n">BTR</span><span class="tok-o">,</span> <span class="tok-n">BZE</span><span class="tok-o">,</span> <span class="tok-n">CAE</span><span class="tok-o">,</span> <span class="tok-n">CHA</span><span class="tok-o">,</span> <span class="tok-n">CHS</span><span class="tok-o">,</span> <span class="tok-n">CMI</span><span class="tok-o">,</span> <span class="tok-n">GCK</span><span class="tok-o">,</span> <span class="tok-n">GDL</span><span class="tok-o">,</span> <span class="tok-n">GGG</span><span class="tok-o">,</span> <span class="tok-n">GJT</span><span class="tok-o">,</span> <span class="tok-n">GPT</span><span class="tok-o">,</span> <span class="tok-n">EVV</span><span class="tok-o">,</span> <span class="tok-n">FAR</span><span class="tok-o">,</span> <span class="tok-n">FAT</span><span class="tok-o">,</span> <span class="tok-n">FSD</span><span class="tok-o">,</span> <span class="tok-n">FSM</span><span class="tok-o">,</span> <span class="tok-n">FWA</span><span class="tok-o">,</span> <span class="tok-n">JAN</span><span class="tok-o">,</span> <span class="tok-n">JLN</span><span class="tok-o">,</span> <span class="tok-n">YYZ</span><span class="tok-o">,</span> <span class="tok-n">LAW</span><span class="tok-o">,</span> <span class="tok-n">YVR</span><span class="tok-o">,</span> <span class="tok-n">LCH</span><span class="tok-o">,</span> <span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-n">LFT</span><span class="tok-o">,</span> <span class="tok-n">CDG</span><span class="tok-o">,</span> <span class="tok-n">LIR</span><span class="tok-o">,</span> <span class="tok-n">GRI</span><span class="tok-o">,</span> <span class="tok-n">GRK</span><span class="tok-o">,</span> <span class="tok-n">GRR</span><span class="tok-o">,</span> <span class="tok-n">GSO</span><span class="tok-o">,</span> <span class="tok-n">GSP</span><span class="tok-o">,</span> <span class="tok-n">MLI</span><span class="tok-o">,</span> <span class="tok-n">PEK</span><span class="tok-o">,</span> <span class="tok-n">MLM</span><span class="tok-o">,</span> <span class="tok-n">PVG</span><span class="tok-o">,</span> <span class="tok-n">MLU</span><span class="tok-o">,</span> <span class="tok-n">FCO</span><span class="tok-o">,</span> <span class="tok-n">MOB</span><span class="tok-o">,</span> <span class="tok-n">AMS</span><span class="tok-o">,</span> <span class="tok-n">MSN</span><span class="tok-o">,</span> <span class="tok-n">MAD</span><span class="tok-o">,</span> <span class="tok-n">MZT</span><span class="tok-o">,</span> <span class="tok-n">RSW</span><span class="tok-o">,</span> <span class="tok-n">PBC</span><span class="tok-o">,</span> <span class="tok-n">FRA</span><span class="tok-o">,</span> <span class="tok-n">LRD</span><span class="tok-o">,</span> <span class="tok-n">NRT</span><span class="tok-o">,</span> <span class="tok-n">MFE</span><span class="tok-o">,</span> <span class="tok-n">SYD</span><span class="tok-o">,</span> <span class="tok-n">MGM</span><span class="tok-o">,</span> <span class="tok-n">DXB</span><span class="tok-o">,</span> <span class="tok-n">MHK</span><span class="tok-o">,</span> <span class="tok-n">HKG</span><span class="tok-o">,</span> <span class="tok-n">QRO</span><span class="tok-o">,</span> <span class="tok-n">ICN</span><span class="tok-o">,</span> <span class="tok-n">ROW</span><span class="tok-o">,</span> <span class="tok-n">GIG</span><span class="tok-o">,</span> <span class="tok-n">SAL</span><span class="tok-o">,</span> <span class="tok-n">GRU</span><span class="tok-o">,</span> <span class="tok-n">SAV</span><span class="tok-o">,</span> <span class="tok-n">EZE</span><span class="tok-o">,</span> <span class="tok-n">SJD</span><span class="tok-o">,</span> <span class="tok-n">LIM</span><span class="tok-o">,</span> <span class="tok-n">SJT</span><span class="tok-o">,</span> <span class="tok-n">SCL</span><span class="tok-o">,</span> <span class="tok-n">SLP</span><span class="tok-o">,</span> <span class="tok-n">MEX</span><span class="tok-o">,</span> <span class="tok-n">SPI</span><span class="tok-o">,</span> <span class="tok-n">YUL</span><span class="tok-o">,</span> <span class="tok-n">PLS</span><span class="tok-o">,</span> <span class="tok-n">YEG</span><span class="tok-o">,</span> <span class="tok-n">PNS</span><span class="tok-o">,</span> <span class="tok-n">YYC</span><span class="tok-o">,</span> <span class="tok-n">PTY</span><span class="tok-o">,</span> <span class="tok-n">DOH</span><span class="tok-o">,</span> <span class="tok-n">OKC</span><span class="tok-o">,</span> <span class="tok-n">TYS</span><span class="tok-o">,</span> <span class="tok-n">ONT</span><span class="tok-o">,</span> <span class="tok-n">VPS</span><span class="tok-o">,</span> <span class="tok-n">AUH</span><span class="tok-o">,</span> <span class="tok-n">XNA</span><span class="tok-o">,</span> <span class="tok-n">CLT</span><span class="tok-o">,</span> <span class="tok-n">ZCL</span><span class="tok-o">,</span> <span class="tok-n">CUN</span><span class="tok-o">,</span> <span class="tok-n">EGE</span><span class="tok-o">,</span> <span class="tok-n">PSP</span><span class="tok-o">,</span> <span class="tok-n">HDN</span><span class="tok-o">,</span> <span class="tok-n">MEM</span><span class="tok-o">,</span> <span class="tok-n">UIO</span><span class="tok-o">,</span> <span class="tok-n">CVG</span><span class="tok-o">,</span> <span class="tok-n">MID</span><span class="tok-o">,</span> <span class="tok-n">TYR</span><span class="tok-o">,</span> <span class="tok-n">ATL</span><span class="tok-o">,</span> <span class="tok-n">ANC</span><span class="tok-o">,</span> <span class="tok-n">TLH</span><span class="tok-o">,</span> <span class="tok-n">SPS</span><span class="tok-o">,</span> <span class="tok-n">PIT</span><span class="tok-o">,</span> <span class="tok-n">TRC</span><span class="tok-o">,</span> <span class="tok-n">PDX</span><span class="tok-o">,</span> <span class="tok-n">ABQ</span><span class="tok-o">,</span> <span class="tok-n">MKE</span><span class="tok-o">,</span> <span class="tok-n">OMA</span><span class="tok-o">,</span> <span class="tok-n">TUL</span><span class="tok-o">,</span> <span class="tok-n">PVR</span><span class="tok-o">,</span> <span class="tok-n">OGG</span><span class="tok-o">,</span> <span class="tok-n">DUS</span><span class="tok-o">,</span> <span class="tok-n">LGA</span><span class="tok-o">,</span> <span class="tok-n">NAS</span><span class="tok-o">,</span> <span class="tok-n">STL</span><span class="tok-o">,</span> <span class="tok-n">JFK</span><span class="tok-o">,</span> <span class="tok-n">LAX</span><span class="tok-o">,</span> <span class="tok-n">AUS</span><span class="tok-o">,</span> <span class="tok-n">IND</span><span class="tok-o">,</span> <span class="tok-n">MGA</span><span class="tok-o">,</span> <span class="tok-n">BNA</span><span class="tok-o">,</span> <span class="tok-n">MCI</span><span class="tok-o">,</span> <span class="tok-n">BOS</span><span class="tok-o">,</span> <span class="tok-n">BWI</span><span class="tok-o">,</span> <span class="tok-n">DCA</span><span class="tok-o">,</span> <span class="tok-n">FLL</span><span class="tok-o">,</span> <span class="tok-n">IAD</span><span class="tok-o">,</span> <span class="tok-n">IAH</span><span class="tok-o">,</span> <span class="tok-n">JAX</span><span class="tok-o">,</span> <span class="tok-n">PUJ</span><span class="tok-o">,</span> <span class="tok-n">SJO</span><span class="tok-o">,</span> <span class="tok-n">SMF</span><span class="tok-o">,</span> <span class="tok-n">RTB</span><span class="tok-o">,</span> <span class="tok-n">COS</span><span class="tok-o">,</span> <span class="tok-n">SJC</span><span class="tok-o">,</span> <span class="tok-n">HSV</span><span class="tok-o">,</span> <span class="tok-n">TPA</span><span class="tok-o">,</span> <span class="tok-n">BHM</span><span class="tok-o">,</span> <span class="tok-n">LIT</span><span class="tok-o">,</span> <span class="tok-n">ORF</span><span class="tok-o">,</span> <span class="tok-n">SFO</span><span class="tok-o">,</span> <span class="tok-n">MCO</span><span class="tok-o">,</span> <span class="tok-n">MBJ</span><span class="tok-o">,</span> <span class="tok-n">MIA</span><span class="tok-o">,</span> <span class="tok-n">MSP</span><span class="tok-o">,</span> <span class="tok-n">ORD</span><span class="tok-o">,</span> <span class="tok-n">PBI</span><span class="tok-o">,</span> <span class="tok-n">PHX</span><span class="tok-o">,</span> <span class="tok-n">RDU</span><span class="tok-o">,</span> <span class="tok-n">SEA</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The code below will discover all of the airports in the United States that you can
fly to from London’s Heathrow airport (LHR). Only the first 10 results are selected
using a <em>limit</em> step. A <em>path</em> step is used to nicely return the airport pairs and
the distance between them. What we get back is a list of paths so we can use a simple
Groovy <em>each</em> loop to print the results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">lhrToUsa</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s2">"code"</span><span class="tok-o">,</span><span class="tok-s2">"LHR"</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">inV</span><span class="tok-o">().</span>
                     <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s2">"country"</span><span class="tok-o">,</span><span class="tok-s2">"US"</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span>
                     <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s2">"code"</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s2">"dist"</span><span class="tok-o">).</span><span class="tok-na">toList</span><span class="tok-o">()</span>

<span class="tok-n">println</span> <span class="tok-s2">"\nFrom LHR to airports in the USA (only 10 shown)\n"</span>

<span class="tok-n">lhrToUsa</span><span class="tok-o">.</span><span class="tok-na">each</span> <span class="tok-o">{</span><span class="tok-n">println</span> <span class="tok-n">it</span><span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the 10 routes that were returned when I ran the code having added this new
query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">From</span> <span class="tok-n">LHR</span> <span class="tok-n">to</span> <span class="tok-n">airports</span> <span class="tok-k">in</span> <span class="tok-n">the</span> <span class="tok-nf">USA</span> <span class="tok-o">(</span><span class="tok-n">only</span> <span class="tok-mi">10</span> <span class="tok-n">shown</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">4896</span><span class="tok-o">,</span> <span class="tok-n">PDX</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">3980</span><span class="tok-o">,</span> <span class="tok-n">CLT</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">4198</span><span class="tok-o">,</span> <span class="tok-n">ATL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">4901</span><span class="tok-o">,</span> <span class="tok-n">AUS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">3254</span><span class="tok-o">,</span> <span class="tok-n">BOS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">3622</span><span class="tok-o">,</span> <span class="tok-n">BWI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">4736</span><span class="tok-o">,</span> <span class="tok-n">DFW</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">3665</span><span class="tok-o">,</span> <span class="tok-n">IAD</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">4820</span><span class="tok-o">,</span> <span class="tok-n">IAH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-mi">3440</span><span class="tok-o">,</span> <span class="tok-n">JFK</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, lets write the code to find the airports in England that you can get to from
Austin with no more than one stop.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">eng</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s2">"code"</span><span class="tok-o">,</span><span class="tok-s2">"AUS"</span><span class="tok-o">).</span><span class="tok-na">repeat</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">()).</span><span class="tok-na">emit</span><span class="tok-o">().</span><span class="tok-na">times</span><span class="tok-o">(</span><span class="tok-mi">2</span><span class="tok-o">).</span>
                <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s2">"region"</span><span class="tok-o">,</span><span class="tok-s2">"GB-ENG"</span><span class="tok-o">).</span><span class="tok-na">dedup</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s2">"code"</span><span class="tok-o">).</span><span class="tok-na">toList</span><span class="tok-o">();</span>

<span class="tok-n">println</span> <span class="tok-s2">"\nAirports in England reachable with no more than one stop from AUS"</span>
<span class="tok-n">println</span> <span class="tok-s2">"\n${eng}\n"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results, looks like we can get to a total of nine different airports if
we make no more than one stop on the way.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">Airports</span> <span class="tok-k">in</span> <span class="tok-n">England</span> <span class="tok-n">reachable</span> <span class="tok-n">with</span> <span class="tok-n">no</span> <span class="tok-n">more</span> <span class="tok-n">than</span> <span class="tok-n">one</span> <span class="tok-n">stop</span> <span class="tok-n">from</span> <span class="tok-n">AUS</span>

<span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">,</span> <span class="tok-n">BRS</span><span class="tok-o">,</span> <span class="tok-n">LGW</span><span class="tok-o">,</span> <span class="tok-n">STN</span><span class="tok-o">,</span> <span class="tok-n">MAN</span><span class="tok-o">,</span> <span class="tok-n">BHX</span><span class="tok-o">,</span> <span class="tok-n">LBA</span><span class="tok-o">,</span> <span class="tok-n">NCL</span><span class="tok-o">,</span> <span class="tok-n">LCY</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have a somewhat interesting Groovy application up and running, should you
so choose, you can build upon this foundation just as we did in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#javatinker">Working with TinkerGraph from a Java Application</a>"
section.</p>
</div>
</div>
<div class="sect3">
<h4 id="groovypredicates">6.2.4. Using Gremlin predicates in a Groovy application</h4>
<div class="paragraph">
<p>Just as we had to do when writing a standalone Java application, when you use a
Gremlin predicate such as <em>eq</em> or <em>neq</em> from a Groovy program you need to prefix it
with a <em>"P."</em> which references the TinkerPop class of the same name where a
set of static methods, representing the Gremlin predicates, are defined.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You will find a sample program called GraphRegion.groovy, which contains the
code used in this section, in the sample files directory located at
<a href="https://github.com/krlawrence/graph/tree/master/sample-code" class="bare">https://github.com/krlawrence/graph/tree/master/sample-code</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>In the code below, the <em>findByRegion</em> method that we wrote in Java earlier has been
ported to Groovy. As before a String representing a three character airport IATA code
is expected as input. The method then uses a Gremlin query to figure out which
geographical region the specified airport is in and then returns all airports also in
that region. Once again, note the use of <em>P.eq</em> as part of the <em>where</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-nf">findByRegion</span><span class="tok-o">(</span><span class="tok-n">iata</span><span class="tok-o">)</span>
<span class="tok-o">{</span>
  <span class="tok-n">println</span><span class="tok-o">(</span><span class="tok-s2">"\nRegion code lookup for "</span> <span class="tok-o">+</span> <span class="tok-n">iata</span> <span class="tok-o">)</span>

  <span class="tok-kt">def</span> <span class="tok-n">list</span> <span class="tok-o">=</span>
    <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s2">"code"</span><span class="tok-o">,</span><span class="tok-n">iata</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s2">"region"</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s2">"r"</span><span class="tok-o">).</span>
      <span class="tok-n">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s2">"airport"</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s2">"a"</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s2">"region"</span><span class="tok-o">).</span>
          <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">P</span><span class="tok-o">.</span><span class="tok-na">eq</span><span class="tok-o">(</span><span class="tok-s2">"r"</span><span class="tok-o">)).</span><span class="tok-na">by</span><span class="tok-o">().</span>
          <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">__</span><span class="tok-o">.</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s2">"a"</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s2">"city"</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">,</span><span class="tok-s2">"region"</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()).</span><span class="tok-na">toList</span><span class="tok-o">()</span>

  <span class="tok-n">list</span><span class="tok-o">.</span><span class="tok-na">each</span> <span class="tok-o">{</span><span class="tok-n">println</span> <span class="tok-n">it</span><span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="janusintro">6.3. Introducing JanusGraph</h3>
<div class="paragraph">
<p>So far we have been using the TinkerGraph graph that is included with Apache
TinkerPop in our examples. Once you move beyond learning about Gremlin and its
related technologies and moving towards a production deployment, you will need a
graph store that provides capabilities such as reliable persistence, the ability to
define schemas and support for ACID transactions. The JanusGraph project, which
began in 2016 as an open source fork of the popular Titan graph database, is hosted by
the Linux Foundation and provides these advanced capabilities.</p>
</div>
<div class="paragraph">
<p>In this book I have attempted to provide a reasonable amount of JanusGraph
coverage but it is still recommended to become familiar with the official
JanusGraph documentation where you will find more in depth discussions of advanced
topics and explanations of the many settings that you can manipulate to suit your
needs.</p>
</div>
<div class="paragraph">
<p>JanusGraph can run on a laptop, which is useful for learning and experimenting, but
it is designed to handle very large graphs stored on distributed clusters. It can
handle graphs containing billions of vertices and edges. As we shall discuss, JanusGraph
is designed to work with a variety of persistent storage options including
Apache Cassandra and Apache HBase as well as indexing technology such as Apache Solr
and Elasticsearch.</p>
</div>
<div class="dlist">
<div class="title">Here are some useful JanusGraph resources</div>
<dl>
<dt class="hdlist1">Runtime download (JAR files and more)</dt>
<dd>
<p><a href="http://janusgraph.org/" class="bare">http://janusgraph.org/</a></p>
</dd>
<dt class="hdlist1">Documentation</dt>
<dd>
<p><a href="http://docs.janusgraph.org/latest/" class="bare">http://docs.janusgraph.org/latest/</a>.</p>
</dd>
<dt class="hdlist1">API Documentation</dt>
<dd>
<p><a href="http://docs.janusgraph.org/latest/javadoc.html" class="bare">http://docs.janusgraph.org/latest/javadoc.html</a>
<a href="http://javadoc.io/doc/org.janusgraph/janusgraph-core/0.2.0" class="bare">http://javadoc.io/doc/org.janusgraph/janusgraph-core/0.2.0</a></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>In the following sections we will take an in depth look at JanusGraph and other
technologies that, when combined, provide a way to build and deploy a massively
scalable graph database solution. We will start by quickly looking at how to install
JanusGraph and access it from the Gremlin Console before getting into more advanced
topics including how to create and manage both schemas and indexes and how to use the
transactional capabilities provided by JanusGraph.</p>
</div>
<div class="paragraph">
<p>It is also recommended that you read and get familiar with the official JanusGraph
documentation as well as reading what is presented below.</p>
</div>
<div class="sect3">
<h4 id="janusinstall">6.3.1. Installing JanusGraph</h4>
<div class="paragraph">
<p>JanusGraph itself is very easy to install. You just have to download the ZIP file
and unzip it into a convenient location. Having done that you can immediately begin
to experiment with it if you use the <em>inmemory</em> option which is explained more in the
<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#janusinmemory">Using JanusGraph with the <em>inmemory</em> option</a> section below. However, for a production deployment you will
probably be using JanusGraph in conjunction with some sort of persistent storage, an
indexing service and other components that will also have to be installed. We will
get into that a bit later on. The download page has information regarding versions of
related technologies like Apache Cassandra and Apache Solr that JanusGraph has been
tested with.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is important to remember that JanusGraph does not have its own process, it
is not a delivered as a service that you run, rather it is a set of Java classes that
have to be invoked either from your own code, the Gremlin Console hosted using
something like Gremlin Server.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The install package for JanusGraph is located at <a href="http://janusgraph.org/" class="bare">http://janusgraph.org/</a> and is a
single ZIP file. Once you have it downloaded and unzipped you are ready to experiment
using the Gremlin Console. As will be discussed below, when working with JanusGraph
you must use the version of the Gremlin Console that is packaged as part of the
JanusGraph download.</p>
</div>
</div>
<div class="sect3">
<h4 id="janusconsole">6.3.2. Using JanusGraph from the Gremlin Console</h4>
<div class="paragraph">
<p>A version of the Gremlin Console is included as part of the JanusGraph download. The
only major difference between this version of the console and the one you get as part
of the standard Apache TinkerPop download is that the console has been preconfigured
to recognize and find the JanusGraph specific classes. A good example of one such
class is <em>JanusGraphFactory</em> that is used from the Console to create a new JanusGraph
instance.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When working with JanusGraph you must use the version of the Gremlin Console
that is packaged as part of the JanusGraph download.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>As mentioned above, JanusGraph is not a standalone service, it is a set of Java
classes that still need to be invoked by a calling process. The Gremlin Console can
play that role. After you have unzipped JanusGraph you will find the <code>gremlin.sh</code> and
<code>gremlin.bat</code> scripts in the <code>bin</code> directory under the JanusGraph parent directory. Once
you have started the Gremlin Console you can, as we will explore in the next few
sections, tell JanusGraph about the environment you will be operating in in terms of
back end store and index.</p>
</div>
</div>
<div class="sect3">
<h4 id="janusinmemory">6.3.3. Using JanusGraph with the <em>inmemory</em> option</h4>
<div class="paragraph">
<p>For almost all production use cases, you will be using JanusGraph along with a
persistent back end store such as Apache Cassandra or Apache HBase. However while
experimenting with JanusGraph it is incredibly useful to be able to get up and
running quickly without having to worry about configuring all of the back end storage
components. This is made possible by the <em>inmemory</em> option that JanusGraph
provides. This essentially allows us to use JanusGraph in the same way as we have
been using TinkerGraph with all of our graph data stored in the memory of the
computer. The one big difference however is that JanusGraph, even while using the
<em>inmemory</em> storage model, allows us to experiment with features that TinkerGraph does
not offer, such as schemas and transactions. We will get into those topics a bit
later on. First, let’s create an instance of JanusGraph from the Gremlin console
that uses the <em>inmemory</em> storage model.</p>
</div>
<div class="paragraph">
<p>Creating a JanusGraph instance is very similar to the way we created a TinkerGraph
instance earlier in the book. The only difference is that we use the
<em>JanusGraphFactory</em> to create the graph and in this case we specify <em>inmemory</em> as the
only parameter to tell JanusGraph that we want to use the all in memory storage
model. We create our graph traversal object <em>g</em> in just the same way as before.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">graph</span> <span class="tok-o">=</span> <span class="tok-n">JanusGraphFactory</span><span class="tok-o">.</span><span class="tok-na">open</span><span class="tok-o">(</span><span class="tok-s1">'inmemory'</span><span class="tok-o">)</span>
<span class="tok-n">g</span> <span class="tok-o">=</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the <em>open</em> command above is a shorthand form of the command shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">graph</span> <span class="tok-o">=</span> <span class="tok-n">JanusGraphFactory</span><span class="tok-o">.</span><span class="tok-na">build</span><span class="tok-o">().</span><span class="tok-na">set</span><span class="tok-o">(</span><span class="tok-s2">"storage.backend"</span><span class="tok-o">,</span><span class="tok-s2">"inmemory"</span><span class="tok-o">).</span><span class="tok-na">open</span><span class="tok-o">()</span>
<span class="tok-n">g</span> <span class="tok-o">=</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have a graph instance created, just like with TinkerGraph, we can query
which features the graph supports. Earlier in the book in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#tgintro">Introducing TinkerGraph</a>"
section we looked at the features offered by TinkerGraph. If we compare those
features to what JanusGraph offers we can spot some key differences.</p>
</div>
<div class="paragraph">
<p>We can get the feature set back by calling the <em>features</em> method as shown below. The
first thing that stands out is that the various features that involve transactions
are now set to <em>true</em> indicating that JanusGraph supports transactions. We will take
a look at how to use these transactional capabilities in the next section. Note that
<em>Persistence</em> still shows as <em>false</em> as we are using the <em>inmemory</em> mode. Another
thing to note is that, unlike with TinkerGraph, <em>UserSuppliedIds</em> is set to false,
indicating that JanusGraph will create its own ID values and ignore any that we
provide. The list is formatted in two columns to aid readability.</p>
</div>
<div class="listingblock">
<div class="title">JanusGraph features</div>
<div class="content">
<pre>graph.features()

&gt; GraphFeatures                            &gt; VertexPropertyFeatures
&gt;-- Transactions: true                     &gt;-- AddProperty: true
&gt;-- Computer: true                         &gt;-- RemoveProperty: true
&gt;-- ConcurrentAccess: true                 &gt;-- NumericIds: false
&gt;-- ThreadedTransactions: true             &gt;-- StringIds: true
&gt;-- Persistence: false                     &gt;-- UuidIds: false
&gt; VariableFeatures                         &gt;-- CustomIds: true
&gt;-- Variables: true                        &gt;-- AnyIds: false
&gt;-- LongValues: true                       &gt;-- UserSuppliedIds: false
&gt;-- BooleanArrayValues: true               &gt;-- Properties: true
&gt;-- ByteArrayValues: true                  &gt;-- LongValues: true
&gt;-- DoubleArrayValues: true                &gt;-- BooleanArrayValues: true
&gt;-- FloatArrayValues: true                 &gt;-- ByteArrayValues: true
&gt;-- IntegerArrayValues: true               &gt;-- DoubleArrayValues: true
&gt;-- StringArrayValues: true                &gt;-- FloatArrayValues: true
&gt;-- LongArrayValues: true                  &gt;-- IntegerArrayValues: true
&gt;-- StringValues: true                     &gt;-- StringArrayValues: true
&gt;-- MapValues: true                        &gt;-- LongArrayValues: true
&gt;-- MixedListValues: false                 &gt;-- StringValues: true
&gt;-- SerializableValues: false              &gt;-- MapValues: true
&gt;-- UniformListValues: false               &gt;-- MixedListValues: false
&gt;-- BooleanValues: true                    &gt;-- SerializableValues: false
&gt;-- ByteValues: true                       &gt;-- UniformListValues: false
&gt;-- DoubleValues: true                     &gt;-- BooleanValues: true
&gt;-- FloatValues: true                      &gt;-- ByteValues: true
&gt;-- IntegerValues: true                    &gt;-- DoubleValues: true
&gt; VertexFeatures                           &gt;-- FloatValues: true
&gt;-- MetaProperties: true                   &gt;-- IntegerValues: true
&gt;-- AddVertices: true                      &gt; EdgePropertyFeatures
&gt;-- RemoveVertices: true                   &gt;-- Properties: true
&gt;-- MultiProperties: true                  &gt;-- LongValues: true
&gt;-- AddProperty: true                      &gt;-- BooleanArrayValues: true
&gt;-- RemoveProperty: true                   &gt;-- ByteArrayValues: true
&gt;-- NumericIds: true                       &gt;-- DoubleArrayValues: true
&gt;-- StringIds: false                       &gt;-- FloatArrayValues: true
&gt;-- UuidIds: false                         &gt;-- IntegerArrayValues: true
&gt;-- CustomIds: false                       &gt;-- StringArrayValues: true
&gt;-- AnyIds: false                          &gt;-- LongArrayValues: true
&gt;-- UserSuppliedIds: false                 &gt;-- StringValues: true
&gt; EdgeFeatures                             &gt;-- MapValues: true
&gt;-- RemoveEdges: true                      &gt;-- MixedListValues: false
&gt;-- AddEdges: true                         &gt;-- SerializableValues: false
&gt;-- AddProperty: true                      &gt;-- UniformListValues: false
&gt;-- RemoveProperty: true                   &gt;-- BooleanValues: true
&gt;-- NumericIds: false                      &gt;-- ByteValues: true
&gt;-- StringIds: false                       &gt;-- DoubleValues: true
&gt;-- UuidIds: false                         &gt;-- FloatValues: true
&gt;-- CustomIds: true                        &gt;-- IntegerValues: true
&gt;-- AnyIds: false
&gt;-- UserSuppliedIds: false</pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have an empty instance of an <em>inmemory</em> JanusGraph we can use it from
the Gremlin Console just as we did with TinkerGraph in our prior examples. Notice
that the ID values that JanusGraph generates look quite different (as in they don’t
start at zero) from what we might expect from TinkerGraph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">addV</span><span class="tok-o">(</span><span class="tok-s1">'person'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'name'</span><span class="tok-o">,</span><span class="tok-s1">'Kelvin'</span><span class="tok-o">)</span>
<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">4232</span><span class="tok-o">]</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'name'</span><span class="tok-o">,</span><span class="tok-s1">'Kelvin'</span><span class="tok-o">)</span>
<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">4232</span><span class="tok-o">]</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'name'</span><span class="tok-o">,</span><span class="tok-s1">'Kelvin'</span><span class="tok-o">).</span><span class="tok-na">id</span><span class="tok-o">()</span>
<span class="tok-mi">4232</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Before we experiment too much more with JanusGraph there are three important subjects
we need to discuss. One is transactions, another is defining a schema and indexes for
our vertices, edges and properties and the third is the JanusGraph management API. We
will cover each of these key subjects in the following sections.</p>
</div>
</div>
<div class="sect3">
<h4 id="janustrans">6.3.4. JanusGraph transactions</h4>
<div class="paragraph">
<p>So far we have been mainly using a TinkerGraph to perform our experiments.
TinkerGraph does not provide support for transactions. To be fair, for the type of
use cases where TinkerGraph is a good solution this is not really an issue. However,
a typical use case for JanusGraph might be storing and mutating (updating) a very
large graph persisted by a back end store. In such an environment, support for
transactions becomes a lot more important. If you are used to other databases that
offer transactional support, and as the JanusGraph documentation points out, you
should not rely on JanusGraph transactions being fully Atomic, Consistent, Isolated
and Durable (ACID). The amount of ACID support will depend on the backend store being
used. We will take a look at some of the backend storage options in the
"<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#janusstorage">Choosing a persistent storage technology for JanusGraph</a> section".</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The official JanusGraph documentation includes detailed coverage of how
transactions are processed and techniques to use based on different usage scenarios.
You will always find the latest version here:
<a href="http://docs.janusgraph.org/latest/tx.html" class="bare">http://docs.janusgraph.org/latest/tx.html</a>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>In many cases, when using JanusGraph, you do not have to explicitly open a new
transaction. Instead, it will be opened for you as needed. Take a look at the example
below. A transaction is opened when <em>addVertex</em> is called and remains open until
<em>commit</em> is called. Note also that in order to access the JanusGraph transaction
capabilities, we use the <em>tx</em> method associated with our <em>graph</em> instance. The
examples below assume you have the Gremlin Console connected to a JanusGraph
instance. The <em>inmemory</em> JanusGraph we created earlier will work fine for these
examples as transactions are supported even with <em>inmemory</em> JanusGraph instances.
Note that I have not shown the warning message that JanusGraph will display reminding
us that we have not created an index for our new property. We will explore how to
create an index in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#jaindexintro">JanusGraph indexes</a>" section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Start a new transaction</span>
<span class="tok-n">xyz</span> <span class="tok-o">=</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">addVertex</span><span class="tok-o">()</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">4344</span><span class="tok-o">]</span>

<span class="tok-c1">// Add a property</span>
<span class="tok-n">xyz</span><span class="tok-o">.</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'name'</span><span class="tok-o">,</span> <span class="tok-s1">'XYZ'</span><span class="tok-o">)</span>

<span class="tok-c1">// Commit the transaction</span>
<span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">tx</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">()</span>

<span class="tok-c1">// Check to make sure our new vertex was created</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'name'</span><span class="tok-o">,</span><span class="tok-s1">'XYZ'</span><span class="tok-o">)</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">4344</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above used the <em>graph</em> object to add a vertex. As discussed earlier in
this book, the TinkerPop documentation recommends against this. Instead it recommends
adding vertices as part of a traversal as shown below. Note that the <em>graph</em> object
is still used to <em>commit</em> the transaction.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Start a new transaction</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">addV</span><span class="tok-o">().</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'name'</span><span class="tok-o">,</span><span class="tok-s1">'XYZ'</span><span class="tok-o">)</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">4216</span><span class="tok-o">]</span>

<span class="tok-c1">// Commit the transaction</span>
<span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">tx</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">()</span>

<span class="tok-c1">// Check to make sure our new vertex was created</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'name'</span><span class="tok-o">,</span><span class="tok-s1">'XYZ'</span><span class="tok-o">)</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">4216</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Sometimes, it may be necessary to undo or <em>rollback</em> what we have done rather than
continue and <em>commit</em> the transaction. This can be achieved calling the <em>rollback</em>
method as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Start a new transaction</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">addV</span><span class="tok-o">().</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'name'</span><span class="tok-o">,</span><span class="tok-s1">'ABC'</span><span class="tok-o">)</span>

<span class="tok-c1">// Rollback the transaction</span>
<span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">tx</span><span class="tok-o">().</span><span class="tok-na">rollback</span><span class="tok-o">()</span>

<span class="tok-c1">// Nothing will be returned</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'ABC'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the JanusGraph Management system, that is the subject of the next section,
has its own transaction system that is used when creating schema entries and
otherwise configuring a graph.</p>
</div>
</div>
<div class="sect3">
<h4 id="janusmgmt">6.3.5. The JanusGraph management API</h4>
<div class="paragraph">
<p>JanusGraph includes a management API that is made available via the ManagementSystem
class. You can use the management API to perform various important functions that
include querying metadata about the graph, defining the edge, vertex and property
schema types and creating and updating the index.</p>
</div>
<div class="paragraph">
<p>You can create an instance of the ManagementSystem object using the <em>openManagement</em>
method call as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">mgmt</span> <span class="tok-o">=</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">openManagement</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the following sections we will show how to use the management API to create both a
schema and an index for the <em>air-routes</em> graph and then load it. Before we do that we
should take a few minutes to introduce the JanusGraph Management API. For the
time being, assume we have created an in memory JanusGraph instance and loaded the
<em>air-routes</em> graph into it but have not defined an index or a schema. In this
situation, JanusGraph will give us the best defaults it can as it loads the graph
for schema types.</p>
</div>
<div class="paragraph">
<p>The example below uses the Management API to get a list of all the vertex labels
currently defined in graph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">getVertexLabels</span><span class="tok-o">()</span>

<span class="tok-n">version</span>
<span class="tok-n">airport</span>
<span class="tok-n">country</span>
<span class="tok-n">continent</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This query similarly finds all of the currently defined edge labels.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">getRelationTypes</span><span class="tok-o">(</span><span class="tok-n">EdgeLabel</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>

<span class="tok-n">route</span>
<span class="tok-n">contains</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This query will find all of the currently defined property keys. Note that this
list will include both vertex and edge property key names</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">getRelationTypes</span><span class="tok-o">(</span><span class="tok-n">PropertyKey</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>

<span class="tok-n">dist</span>
<span class="tok-n">code</span>
<span class="tok-n">type</span>
<span class="tok-n">desc</span>
<span class="tok-n">country</span>
<span class="tok-n">longest</span>
<span class="tok-n">city</span>
<span class="tok-n">elev</span>
<span class="tok-n">icao</span>
<span class="tok-n">lon</span>
<span class="tok-n">region</span>
<span class="tok-n">runways</span>
<span class="tok-n">lat</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can query the cardinality of a property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">getPropertyKey</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">cardinality</span><span class="tok-o">()</span>

<span class="tok-n">SINGLE</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that as we have not so far defined a schema for the <em>air-routes</em> graph. if we
query the dataType for any of the already loaded properties we will get back
<em>Object.class</em> and by default that is what JanusGraph will use in the absence of a schema
having been defined.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">getPropertyKey</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">dataType</span><span class="tok-o">()</span>

<span class="tok-n">Object</span><span class="tok-o">.</span><span class="tok-na">class</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also test for the existence of a label definition in the graph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">containsEdgeLabel</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">)</span>

<span class="tok-kc">true</span>

<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">containsEdgeLabel</span><span class="tok-o">(</span><span class="tok-s1">'travels'</span><span class="tok-o">)</span>

<span class="tok-kc">false</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cardlist">6.3.6. Creating a property with cardinality LIST</h4>
<div class="paragraph">
<p>Using the JanusGraph Management API it is possible to specify that a property can
accept as list of values. This can be done by specifying a cardinality of <em>LIST</em> when
the property key is created. Unless we explicitly do this, whenever a property is
created the cardinality will default to <em>SINGLE</em>. The code below can be run from a
Gremlin Console connected to a JanusGraph instance. A property key called <em>mylist</em> is
created that can accept <em>String</em> values'. Before the key is created, its cardinality
is specified as <em>LIST</em>. Always remember to <em>commit</em> the management transaction when you
are done making changes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">mgmt</span> <span class="tok-o">=</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">openManagement</span><span class="tok-o">()</span>
<span class="tok-n">maker</span> <span class="tok-o">=</span> <span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">makePropertyKey</span><span class="tok-o">(</span><span class="tok-s1">'mylist'</span><span class="tok-o">)</span>
<span class="tok-n">maker</span><span class="tok-o">.</span><span class="tok-na">dataType</span><span class="tok-o">(</span><span class="tok-n">String</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
<span class="tok-n">maker</span><span class="tok-o">.</span><span class="tok-na">cardinality</span><span class="tok-o">(</span><span class="tok-n">LIST</span><span class="tok-o">)</span>
<span class="tok-n">maker</span><span class="tok-o">.</span><span class="tok-na">make</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">commit</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the previous steps could be chained together as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">mgmt</span> <span class="tok-o">=</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">openManagement</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">makePropertyKey</span><span class="tok-o">(</span><span class="tok-s1">'mylist'</span><span class="tok-o">).</span><span class="tok-na">dataType</span><span class="tok-o">(</span><span class="tok-n">String</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">).</span><span class="tok-na">cardinality</span><span class="tok-o">(</span><span class="tok-n">LIST</span><span class="tok-o">).</span><span class="tok-na">make</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">commit</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have created a new key, when can use the Management API to check that its
cardinality is indeed set to <em>LIST</em>. As always, whenever we are done using the API we
should close the transaction with a call to <em>commit</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">mgmt</span> <span class="tok-o">=</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">openManagement</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">getPropertyKey</span><span class="tok-o">(</span><span class="tok-s1">'mylist'</span><span class="tok-o">).</span><span class="tok-na">cardinality</span><span class="tok-o">()</span>

<span class="tok-n">LIST</span>

<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">commit</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now create a new vertex and add some values using our new <em>mylist</em> property.
Note that as our cardinality is <em>LIST</em> and not <em>SET</em> that we can have duplicate values
associated with our new property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">n</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">addV</span><span class="tok-o">().</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'mylist'</span><span class="tok-o">,</span><span class="tok-s1">'one'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'mylist'</span><span class="tok-o">,</span><span class="tok-s1">'two'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">3043568</span><span class="tok-o">]</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-n">n</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-n">list</span><span class="tok-o">,</span><span class="tok-s1">'mylist'</span><span class="tok-o">,</span><span class="tok-s1">'one'</span><span class="tok-o">)</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-n">n</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">()</span>

<span class="tok-c1">// Duplicates allowed</span>
<span class="tok-o">[</span><span class="tok-nl">mylist:</span><span class="tok-o">[</span><span class="tok-n">one</span><span class="tok-o">,</span><span class="tok-n">one</span><span class="tok-o">,</span><span class="tok-n">two</span><span class="tok-o">]]</span>

<span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">tx</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">()</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cardset">6.3.7. Creating a property with cardinality SET</h4>
<div class="paragraph">
<p>Using the JanusGraph Management API we can also specify that a property can contain a
<em>SET</em> of values. The difference between a cardinality of <em>SET</em> and a cardinality of
<em>LIST</em> is that sets do not allow duplicate values.</p>
</div>
<div class="paragraph">
<p>Let’s create a new property key called <em>numbers</em> that will accept a set of integer
values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">mgmt</span> <span class="tok-o">=</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">openManagement</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">makePropertyKey</span><span class="tok-o">(</span><span class="tok-s1">'numbers'</span><span class="tok-o">).</span><span class="tok-na">dataType</span><span class="tok-o">(</span><span class="tok-n">Integer</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">).</span><span class="tok-na">cardinality</span><span class="tok-o">(</span><span class="tok-n">SET</span><span class="tok-o">).</span><span class="tok-na">make</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As before we can double check the cardinality of our new property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">getPropertyKey</span><span class="tok-o">(</span><span class="tok-s1">'numbers'</span><span class="tok-o">).</span><span class="tok-na">cardinality</span><span class="tok-o">()</span>

<span class="tok-n">SET</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Also as before once we are done making changes we need to commit our management
transaction.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">commit</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s now create a new vertex and do some testing to make sure that JanusGraph does
enforce the rules we expect from a set. First of all we create a new vertex and put
the values 1,2 and 3 into the property. This works as expected.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">n</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">addV</span><span class="tok-o">().</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'numbers'</span><span class="tok-o">,</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'numbers'</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'numbers'</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">2846792</span><span class="tok-o">]</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-n">n</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-nl">numbers:</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let’s try adding a second value of 2 and see what happens. As you can see, our
second 2 was not added to our set as there was already a 2 present.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-n">n</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-n">set</span><span class="tok-o">,</span><span class="tok-s1">'numbers'</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">)</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-n">n</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">()</span>

<span class="tok-c1">// Duplicates not allowed</span>
<span class="tok-o">[</span><span class="tok-nl">numbers:</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s try adding a 4 instead. This works as there is no existing value of 4 already
in the set.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-n">n</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-n">set</span><span class="tok-o">,</span><span class="tok-s1">'numbers'</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">)</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-n">n</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">()</span>

<span class="tok-o">[</span><span class="tok-nl">numbers:</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally we can commit our graph transaction as we are all done creating properties.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">tx</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="janusschema">6.4. Defining a JanusGraph schema for the air-routes graph</h3>
<div class="paragraph">
<p>You are not required to define the types and labels of your edges, vertices and
properties ahead of time but it is strongly recommended that you do so. If you do not
define anything and load the air routes data for example, it will work fine but JanusGraph
will make assumptions about various things. One thing it will do is default the
type of all property keys to Java’s <em>Object.class</em> which is not ideal if you want the
graph to help you enforce stricter type checking. Also, without a schema being
defined, JanusGraph will default the usage constraint or <em>multiplicity</em> setting on
all edges to <em>MULTI</em>. We will explain what that means in a minute but in essence it
means there is no restriction by default on how many edges with the same label that
can exist between two vertices.</p>
</div>
<div class="paragraph">
<p>You can use the Management API do define your schema. You can add additional property
types at any time but once defined you cannot change their types. The only thing you
can do once they have been created is to change the names of the keys.</p>
</div>
<div class="paragraph">
<p>A best practice when working with JanusGraph is to define your labels and property
types before you load any data into the graph. As the graph grows if you find you
need to add additional property types or labels you are allowed to do that.</p>
</div>
<div class="paragraph">
<p>Using the management API you can define the labels that will be used by vertices and
edges. These values must be unique across the graph. You can also define the type and
cardinality (<em>SINGLE</em>, <em>LIST</em> or <em>SET</em>) of each property key and for edges you can specify
the allowed usage of edges for any given label (<em>MULTI</em>, <em>MANY2ONE</em>, <em>ONE2MANY</em>, <em>ONE2ONE</em> or
<em>SIMPLE</em>). Property key names must also be unique across the graph.</p>
</div>
<div class="paragraph">
<p>Before we can define a schema for our edge labels we need to understand what each
option allows and decide on the best fit for each of our edge types.</p>
</div>
<div class="dlist">
<div class="title">The multiplicity options provide the following constraints:</div>
<dl>
<dt class="hdlist1">MULTI</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>This is the default option if no multiplicity has been defined for an edge with
a given label. This setting permits multiple edges of the same label between any
pair of vertices. The <em>air-routes</em> graph uses a multiplicity of <em>MULTI</em> for the
<em>routes</em> edges between airports.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">SIMPLE</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>This setting permits at most one edge of a given label between any pair of
vertices. In the <em>air-routes</em> graph this setting is used for the edges between a
continent and an airport as an airport cannot be in more than one continent. The
same is used for the edges between airports and countries.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">MANY2ONE</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>This setting permits at most one outgoing edge of a given label name from any vertex
in the graph but places no constraint on the number of incoming edges with this
label.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">ONE2MANY</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>This setting permits at most one incoming edge of a given label to any vertex in the
graph but places no constraint on the number of outgoing edges</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">ONE2ONE</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>This setting permits at most one incoming and one outgoing edge of a given label to
and from any vertex in the graph.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="_defining_edge_labels_and_usage">6.4.1. Defining edge labels and usage</h4>
<div class="paragraph">
<p>Let’s look at how we can use the JanusGraph Management API to specify the
multiplicty for the <em>route</em> and <em>contains</em> edges used by the <em>air-routes</em> graph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Define edge labels and usage</span>
<span class="tok-n">mgmt</span> <span class="tok-o">=</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">openManagement</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">makeEdgeLabel</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">multiplicity</span><span class="tok-o">(</span><span class="tok-n">MULTI</span><span class="tok-o">).</span><span class="tok-na">make</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">makeEdgeLabel</span><span class="tok-o">(</span><span class="tok-s1">'contains'</span><span class="tok-o">).</span><span class="tok-na">multiplicity</span><span class="tok-o">(</span><span class="tok-n">SIMPLE</span><span class="tok-o">).</span><span class="tok-na">make</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">commit</span><span class="tok-o">()</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_defining_vertex_labels">6.4.2. Defining vertex labels</h4>
<div class="paragraph">
<p>Now let’s tell JanusGraph about the vertex labels that we are going to be using. The
<em>air-routes</em> graph has four different vertex types, namely, <em>version</em>, <em>airport</em>,
<em>country</em> and <em>continent</em> so we will create a label for each of those.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Define vertex labels</span>
<span class="tok-n">mgmt</span> <span class="tok-o">=</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">openManagement</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">makeVertexLabel</span><span class="tok-o">(</span><span class="tok-s1">'version'</span><span class="tok-o">).</span><span class="tok-na">make</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">makeVertexLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">make</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">makeVertexLabel</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">).</span><span class="tok-na">make</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">makeVertexLabel</span><span class="tok-o">(</span><span class="tok-s1">'continent'</span><span class="tok-o">).</span><span class="tok-na">make</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">commit</span><span class="tok-o">()</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_defining_vertex_property_keys">6.4.3. Defining vertex property keys</h4>
<div class="paragraph">
<p>Next we need to define the property keys and data types that our vertices will be
using. The <em>air-routes</em> graph only uses properties that have a cardinality of <em>SINGLE</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Define vertex property keys</span>
<span class="tok-n">mgmt</span> <span class="tok-o">=</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">openManagement</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">makePropertyKey</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">dataType</span><span class="tok-o">(</span><span class="tok-n">String</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">).</span><span class="tok-na">cardinality</span><span class="tok-o">(</span><span class="tok-n">Cardinality</span><span class="tok-o">.</span><span class="tok-na">SINGLE</span><span class="tok-o">).</span><span class="tok-na">make</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">makePropertyKey</span><span class="tok-o">(</span><span class="tok-s1">'icao'</span><span class="tok-o">).</span><span class="tok-na">dataType</span><span class="tok-o">(</span><span class="tok-n">String</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">).</span><span class="tok-na">cardinality</span><span class="tok-o">(</span><span class="tok-n">Cardinality</span><span class="tok-o">.</span><span class="tok-na">SINGLE</span><span class="tok-o">).</span><span class="tok-na">make</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">makePropertyKey</span><span class="tok-o">(</span><span class="tok-s1">'type'</span><span class="tok-o">).</span><span class="tok-na">dataType</span><span class="tok-o">(</span><span class="tok-n">String</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">).</span><span class="tok-na">cardinality</span><span class="tok-o">(</span><span class="tok-n">Cardinality</span><span class="tok-o">.</span><span class="tok-na">SINGLE</span><span class="tok-o">).</span><span class="tok-na">make</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">makePropertyKey</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">).</span><span class="tok-na">dataType</span><span class="tok-o">(</span><span class="tok-n">String</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">).</span><span class="tok-na">cardinality</span><span class="tok-o">(</span><span class="tok-n">Cardinality</span><span class="tok-o">.</span><span class="tok-na">SINGLE</span><span class="tok-o">).</span><span class="tok-na">make</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">makePropertyKey</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">).</span><span class="tok-na">dataType</span><span class="tok-o">(</span><span class="tok-n">String</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">).</span><span class="tok-na">cardinality</span><span class="tok-o">(</span><span class="tok-n">Cardinality</span><span class="tok-o">.</span><span class="tok-na">SINGLE</span><span class="tok-o">).</span><span class="tok-na">make</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">makePropertyKey</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">).</span><span class="tok-na">dataType</span><span class="tok-o">(</span><span class="tok-n">String</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">).</span><span class="tok-na">cardinality</span><span class="tok-o">(</span><span class="tok-n">Cardinality</span><span class="tok-o">.</span><span class="tok-na">SINGLE</span><span class="tok-o">).</span><span class="tok-na">make</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">makePropertyKey</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">).</span><span class="tok-na">dataType</span><span class="tok-o">(</span><span class="tok-n">String</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">).</span><span class="tok-na">cardinality</span><span class="tok-o">(</span><span class="tok-n">Cardinality</span><span class="tok-o">.</span><span class="tok-na">SINGLE</span><span class="tok-o">).</span><span class="tok-na">make</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">makePropertyKey</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">dataType</span><span class="tok-o">(</span><span class="tok-n">Integer</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">).</span><span class="tok-na">cardinality</span><span class="tok-o">(</span><span class="tok-n">Cardinality</span><span class="tok-o">.</span><span class="tok-na">SINGLE</span><span class="tok-o">).</span><span class="tok-na">make</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">makePropertyKey</span><span class="tok-o">(</span><span class="tok-s1">'elev'</span><span class="tok-o">).</span><span class="tok-na">dataType</span><span class="tok-o">(</span><span class="tok-n">Integer</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">).</span><span class="tok-na">cardinality</span><span class="tok-o">(</span><span class="tok-n">Cardinality</span><span class="tok-o">.</span><span class="tok-na">SINGLE</span><span class="tok-o">).</span><span class="tok-na">make</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">makePropertyKey</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">).</span><span class="tok-na">dataType</span><span class="tok-o">(</span><span class="tok-n">Double</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">).</span><span class="tok-na">cardinality</span><span class="tok-o">(</span><span class="tok-n">Cardinality</span><span class="tok-o">.</span><span class="tok-na">SINGLE</span><span class="tok-o">).</span><span class="tok-na">make</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">makePropertyKey</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">).</span><span class="tok-na">dataType</span><span class="tok-o">(</span><span class="tok-n">Double</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">).</span><span class="tok-na">cardinality</span><span class="tok-o">(</span><span class="tok-n">Cardinality</span><span class="tok-o">.</span><span class="tok-na">SINGLE</span><span class="tok-o">).</span><span class="tok-na">make</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">commit</span><span class="tok-o">()</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_defining_edge_property_keys">6.4.4. Defining edge property keys</h4>
<div class="paragraph">
<p>We also need to define the property keys and data types that will be used on edges.
Currently the <em>air-routes</em> graph only has one edge property, <em>dist</em> that is used to
store the distance between two airports.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Define edge property keys</span>
<span class="tok-n">mgmt</span> <span class="tok-o">=</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">openManagement</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">makePropertyKey</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">dataType</span><span class="tok-o">(</span><span class="tok-n">Integer</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">).</span><span class="tok-na">cardinality</span><span class="tok-o">(</span><span class="tok-n">Cardinality</span><span class="tok-o">.</span><span class="tok-na">SINGLE</span><span class="tok-o">).</span><span class="tok-na">make</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">commit</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have defined our schema, we can use the management API to double check
that everything we just did looks correct. The snippet of code below can be run from
within the Gremlin console and will display the property keys along with their data
types and cardinality settings.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Look at the properties</span>
<span class="tok-n">mgmt</span> <span class="tok-o">=</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">openManagement</span><span class="tok-o">()</span>
<span class="tok-n">types</span> <span class="tok-o">=</span> <span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">getRelationTypes</span><span class="tok-o">(</span><span class="tok-n">PropertyKey</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
<span class="tok-n">types</span><span class="tok-o">.</span><span class="tok-na">each</span><span class="tok-o">{</span><span class="tok-n">println</span> <span class="tok-s2">"$it\t: "</span> <span class="tok-o">+</span>
                    <span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">getPropertyKey</span><span class="tok-o">(</span><span class="tok-s2">"$it"</span><span class="tok-o">).</span><span class="tok-na">dataType</span><span class="tok-o">()</span> <span class="tok-o">+</span>
                    <span class="tok-s2">" "</span> <span class="tok-o">+</span> <span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">getPropertyKey</span><span class="tok-o">(</span><span class="tok-s2">"$it"</span><span class="tok-o">).</span><span class="tok-na">cardinality</span><span class="tok-o">()}</span>

<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">commit</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the output we should get back if our schema creation has succeeded. Note that
both the edge and vertex property keys are displayed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">lat</span>     <span class="tok-o">:</span> <span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">Double</span> <span class="tok-n">SINGLE</span>
<span class="tok-n">lon</span>     <span class="tok-o">:</span> <span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">Double</span> <span class="tok-n">SINGLE</span>
<span class="tok-n">dist</span>    <span class="tok-o">:</span> <span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">Integer</span> <span class="tok-n">SINGLE</span>
<span class="tok-n">longest</span> <span class="tok-o">:</span> <span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">Object</span> <span class="tok-n">SINGLE</span>
<span class="tok-n">code</span>    <span class="tok-o">:</span> <span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">String</span> <span class="tok-n">SINGLE</span>
<span class="tok-n">icao</span>    <span class="tok-o">:</span> <span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">String</span> <span class="tok-n">SINGLE</span>
<span class="tok-n">type</span>    <span class="tok-o">:</span> <span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">String</span> <span class="tok-n">SINGLE</span>
<span class="tok-n">city</span>    <span class="tok-o">:</span> <span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">String</span> <span class="tok-n">SINGLE</span>
<span class="tok-n">country</span> <span class="tok-o">:</span> <span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">String</span> <span class="tok-n">SINGLE</span>
<span class="tok-n">region</span>  <span class="tok-o">:</span> <span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">String</span> <span class="tok-n">SINGLE</span>
<span class="tok-n">desc</span>    <span class="tok-o">:</span> <span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">String</span> <span class="tok-n">SINGLE</span>
<span class="tok-n">runways</span> <span class="tok-o">:</span> <span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">Integer</span> <span class="tok-n">SINGLE</span>
<span class="tok-n">elev</span>    <span class="tok-o">:</span> <span class="tok-kd">class</span> <span class="tok-nc">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">Integer</span> <span class="tok-n">SINGLE</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="janusload">6.4.5. Loading air-routes into a JanusGraph instance</h4>
<div class="paragraph">
<p>Now that we know how to create a schema and an index for the <em>air-routes</em> graph
we can use the same basic steps to load it into a JanusGraph
instance that we used with TinkerGraph. Note that after loading the graph from the
XML file we then call <em>commit</em> to finalize the transaction.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">io</span><span class="tok-o">(</span><span class="tok-n">graphml</span><span class="tok-o">()).</span><span class="tok-na">readGraph</span><span class="tok-o">(</span><span class="tok-s1">'air-routes.graphml'</span><span class="tok-o">)</span>
<span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">tx</span><span class="tok-o">().</span><span class="tok-na">commit</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that had we not defined a schema before loading the <em>air-routes</em> graph that
JanusGraph would have still created the vertices, edges and properties but using
default types and settings. A bit later we will look at creating an index for the
<em>air-routes</em> graph as well. It is strongly recommended to create the index as well as
the schema before loading the data but lets examine a few more things before we
discuss how to do that.</p>
</div>
<div class="paragraph">
<p>Unlike TinkerGraph, JanusGraph does not, by default, guarantee to respect user
provided vertex and edge ID values. Instead it creates its own ID values as vertices
and edges are added to the graph. You may have noticed from earlier in the book
or from the <code>air-routes.graphml</code> file if you happened to look in there, that the ID
provided for Austin in the GraphML markup is 3. However, having loaded <em>air-routes</em>
into JanusGraph if we query the ID for the Austin vertex we can see that it is no
longer 3. There is a setting that can be changed to force JanusGraph to honor user
provided ID values but it is not recommended this be used as it will disable some
other useful JanusGraph features. If you are interested in learning more about this
option this please refer to the JanusGraph documentation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">id</span><span class="tok-o">()</span>

<span class="tok-mi">4240</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Having the graph system allocate its own ID values is not a big problem as we can
always query the graph to get the ID but it is a reminder that you should not get
into the habit of relying on any user provided ID values as you work with graphs.</p>
</div>
<div class="paragraph">
<p>If necessary, as discussed earlier, we can always store important ID values in a
variable for later use.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">ausid</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">id</span><span class="tok-o">().</span><span class="tok-na">next</span><span class="tok-o">()</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">(</span><span class="tok-n">ausid</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'desc'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">).</span><span class="tok-na">join</span><span class="tok-o">(</span><span class="tok-s1">', '</span><span class="tok-o">)</span>

<span class="tok-n">Austin</span> <span class="tok-n">Bergstrom</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span><span class="tok-o">,</span> <span class="tok-n">Austin</span><span class="tok-o">,</span> <span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that property values are not necessarily returned in the order you requested.
That can be seen by looking at the example above. Our <em>values</em> step had <em>city</em> first
but in fact the <em>desc</em> properties value was returned first. Gremlin makes no
guarantees that items will be returned in the specific order you requested. They are
returned in the order in which they are found during a traversal. You should not
build in dependencies to your queries on the order things are returned in. If you
need a specific ordering you should sort or otherwise manipulate the returned results
of a query to match your needs.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jaindexintro">6.5. JanusGraph indexes</h3>
<div class="paragraph">
<p>JanusGraph supports two different types of indexing known as <em>graph indexes</em> and
<em>vertex centric indexes</em> respectively. JanusGraph also supports the use of
<em>composite</em> and <em>mixed</em> indexes as well as the use of external indexing technologies.
All of these concepts will be discussed and explained in the following sections.
Using an index will greatly improve performance of your graph queries and is
something you should get familiar with doing for any graphs that you create or
manage. While in many cases use of an index is optional by default, I strongly
recommend that you view it as mandatory. The JanusGraph documentation provides some
fairly in depth coverage of indexing and can be read by visiting the following URL:
<a href="http://docs.janusgraph.org/latest/indexes.html" class="bare">http://docs.janusgraph.org/latest/indexes.html</a></p>
</div>
<div class="sect3">
<h4 id="graphindexes">6.5.1. Graph indexes</h4>
<div class="paragraph">
<p>If you have used other types of database such as a relational database, you may
already be familiar with the concept of using an index to speed up random access to
the entire database. When using JanusGraph that is the role played by a <em>graph
index</em>. The main job of a <em>graph index</em> is to get you to the starting point of your
query as efficiently as possible without having to first search the entire graph to
find the vertices or edges that you are looking for.</p>
</div>
<div class="paragraph">
<p>You should always establish a <em>graph index</em> for the property keys, or combinations of
keys, you will use regularly in your queries when working with JanusGraph. In some
situations you will also need to create <em>vertex centric indexes</em>, a subject we will
discuss next, but most likely this will be part of tuning the performance of your
graph rather than from the start. Conversely, You should plan on creating your
<em>graph indexes</em> long with your initial graph schema. The simplest form of <em>graph
index</em> is the composite index that we will see how to create and use soon.</p>
</div>
</div>
<div class="sect3">
<h4 id="vciintro">6.5.2. Vertex centric indexes</h4>
<div class="paragraph">
<p>A vertex centric index, as the name suggests is an index associated with a vertex.
These are typically used when the number of incident edges on a given vertex becomes
significantly large such that it can impact performance. As mentioned above, it is
likely that when you first create your graph and graph schema that you will just
create a set of <em>graph indexes</em> and only create <em>vertex centric indexes</em> as the need
arises.</p>
</div>
</div>
<div class="sect3">
<h4 id="compositeintro">6.5.3. Introducing <em>composite</em> indexes</h4>
<div class="paragraph">
<p>A composite index can be used to speed up queries where an exact match with the value
for  given property key is sufficient. For example, the query below could take
advantage of a composite index as we are only looking for exact matches where the
value associated with the <em>city</em> key is the value <em>Paris</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'Paris'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A composite index can be defined to support queries that use more than one key. For
example we could create an index that can be used for queries that look at the <em>city</em>
and <em>country</em> property keys to help with a query like the one below that will find
the vertex for the airport in the city of London in Ontario, Canada, but not the ones
in London, England.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'London'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'CA'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A composite index will not help if we want to get more sophisticated and look for
partial matches, use predicates other than <em>equal to</em> or use regular expressions in
our queries. That is where the <em>mixed index</em> comes in to play. So for example, a
composite index would not help with the following query that looks for airports in
the <em>air-routes</em> graph with more than five runways.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">,</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">))</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mixedintro">6.5.4. Introducing <em>mixed</em> indexes</h4>
<div class="paragraph">
<p>As mentioned above, if the queries that you expect to be writing require more than a
simple test for equality then you will need to create what is referred to as a <em>mixed
index</em>. Once you decide to create a mixed index you will also need to configure an
indexing backend such as Apache Solr or Elasticsearch. We will explore the
use of mixed indexes in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#extindex">Using an external index with JanusGraph</a>" section.</p>
</div>
</div>
<div class="sect3">
<h4 id="compositeindex">6.5.5. Building a composite index to speed up exact match searching</h4>
<div class="paragraph">
<p>It is strongly recommended that you create graph indexes for any property keys that
you are likely to be using regularly in queries. An index can greatly speed up
searching a graph as without an index being present JanusGraph has to search your
entire graph each time you issue a query looking for one or more specific properties.
If you issue a query that uses property keys that have not been indexed, the query
will still work but unless warnings have been turned off, JanusGraph will remind you
that you should consider creating an index to improve the performance of your query.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You should be aware that some graph systems running JanusGraph may have disabled
the ability to do a full graph search thus requiring that you always have an index
for any property keys that you use in your queries.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Take a look at the example below. We issue a simple query looking for the airport
with a <em>code</em> property containing the value <em>LHR</em>. Because we have not yet created an
index for that property key, JanusGraph gives us a warning before also returning the
vertex that we are looking for. If the administrator of the JanusGraph system you are
using has disabled the ability to do full graph searches (a feature that is on by
default but can be disabled) the query below will fail with an error message.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">)</span>

<span class="tok-n">WARN</span>  <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">janusgraph</span><span class="tok-o">.</span><span class="tok-na">graphdb</span><span class="tok-o">.</span><span class="tok-na">transaction</span><span class="tok-o">.</span><span class="tok-na">StandardJanusGraphTx</span>
    <span class="tok-o">-</span> <span class="tok-n">Query</span> <span class="tok-n">requires</span> <span class="tok-n">iterating</span> <span class="tok-n">over</span> <span class="tok-n">all</span> <span class="tok-n">vertices</span> <span class="tok-o">[(</span><span class="tok-n">code</span> <span class="tok-o">=</span> <span class="tok-n">LHR</span><span class="tok-o">)].</span>
      <span class="tok-n">For</span> <span class="tok-n">better</span> <span class="tok-n">performance</span><span class="tok-o">,</span> <span class="tok-n">use</span> <span class="tok-n">indexes</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">32904</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If an index is present, before looking at the graph itself, JanusGraph will look at
the index. If the property key being searched for has been indexed, there will be
entries in the index pointing to each occurrence of that property key within the
graph. This enables JanusGraph to directly fetch those elements without having to
search the entire graph looking for them. With a large graph this can provide a very
substantial performance improvement. Depending on your indexing needs you may or may
not need to also use an external indexing technology such as Apache Solr or
Elasticsearch. The subject of using an external index is discussed a bit later.
First of all let’s take a look at the types of index that you can create that
JanusGraph can manage by itself without needing help from an external index.</p>
</div>
<div class="paragraph">
<p>Using JanusGraph you can create and manipulate an index using the Management API. The
JanusGraph documentation strongly recommends that you always make a call to
<em>graph().tx().rollback()</em> before you start to create an index to make sure that no
other transactions are currently active.</p>
</div>
<div class="paragraph">
<p>The example below shows how to use the Management API to create a new composite index
for the airport <em>code</em> property in the <em>air-routes</em> graph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Make sure no other transactions are open</span>
<span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">tx</span><span class="tok-o">().</span><span class="tok-na">rollback</span><span class="tok-o">()</span>

<span class="tok-c1">// Open a new management transaction</span>
<span class="tok-n">mgmt</span> <span class="tok-o">=</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">openManagement</span><span class="tok-o">()</span>

<span class="tok-c1">// Create a composite index for the code key for use with vertices</span>
<span class="tok-n">idx</span> <span class="tok-o">=</span> <span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">buildIndex</span><span class="tok-o">(</span><span class="tok-s1">'airportIndex'</span><span class="tok-o">,</span><span class="tok-n">Vertex</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
<span class="tok-n">iata</span> <span class="tok-o">=</span> <span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">getPropertyKey</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>
<span class="tok-n">idx</span><span class="tok-o">.</span><span class="tok-na">addKey</span><span class="tok-o">(</span><span class="tok-n">iata</span><span class="tok-o">).</span><span class="tok-na">buildCompositeIndex</span><span class="tok-o">()</span>

<span class="tok-c1">// All done commit our changes to end the transaction</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">commit</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Having created the index it is important to wait until it is available before trying
to do anything else. We can do that by calling the <em>awaitGraphIndexStatus</em> method
that is also part of the JanusGraph Management API.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">awaitGraphIndexStatus</span><span class="tok-o">(</span><span class="tok-n">graph</span><span class="tok-o">,</span> <span class="tok-s1">'airportIndex'</span><span class="tok-o">).</span>
     <span class="tok-n">status</span><span class="tok-o">(</span><span class="tok-n">SchemaStatus</span><span class="tok-o">.</span><span class="tok-na">REGISTERED</span><span class="tok-o">).</span><span class="tok-na">call</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we already have data in the graph we now also need to tell JanusGraph to perform a
re-index. Once again we use the Management API to do this but this time using the
<em>updateIndex</em> method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">mgmt</span> <span class="tok-o">=</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">openManagement</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">updateIndex</span><span class="tok-o">(</span><span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">getGraphIndex</span><span class="tok-o">(</span><span class="tok-s2">"airportIndex"</span><span class="tok-o">),</span> <span class="tok-n">SchemaAction</span><span class="tok-o">.</span><span class="tok-na">REINDEX</span><span class="tok-o">).</span><span class="tok-na">get</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">commit</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we re-run the same query we used earlier and got the warning about using indexes from
JanusGraph, this time we get the same result but without the warning. This tells us
that JanusGraph was able to satisfy our query using the index that we just created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">)</span>

<span class="tok-n">v</span><span class="tok-o">[</span><span class="tok-mi">32904</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also use the JanusGraph Management API to query information about the index
that we just defined. As you can see below, as we have only created one index so far,
that is all that is returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">mgmt</span> <span class="tok-o">=</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">openManagement</span><span class="tok-o">()</span>

<span class="tok-c1">// What indexes are defined?</span>
<span class="tok-n">v_idxes</span> <span class="tok-o">=</span> <span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">getGraphIndexes</span><span class="tok-o">(</span><span class="tok-n">Vertex</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>

<span class="tok-n">airportIndex</span>

<span class="tok-c1">// Print the key names they are associated with</span>
<span class="tok-n">v_idxes</span><span class="tok-o">.</span><span class="tok-na">each</span> <span class="tok-o">{</span><span class="tok-n">println</span> <span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">getFieldKeys</span><span class="tok-o">()}</span>

<span class="tok-o">[</span><span class="tok-n">code</span><span class="tok-o">]</span>

<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">commit</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is also possible to define an index that will support a query containing more than
one key. For example we might want to create an index that would be used to help with
queries like the one below which is essentially a query looking for any vertex that
has a <em>city</em> property with a value of <em>London</em> AND a country property with a value
of <em>CA</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'London'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'CA'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could define an index to support such a query using the code that follows. Note
that the only differences from the prior example are that we add two keys rather than
one to the index. Note also that the <em>addKey</em> methods are called with the <em>country</em>
key coming before the <em>city</em> key which is the reverse order to which we expect the
Gremlin query to use the keys.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Make sure no other transactions are active</span>
<span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">tx</span><span class="tok-o">().</span><span class="tok-na">rollback</span><span class="tok-o">()</span>

<span class="tok-c1">// Start a new management transaction</span>
<span class="tok-n">mgmt</span> <span class="tok-o">=</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">openManagement</span><span class="tok-o">()</span>

<span class="tok-c1">// Find the property keys that we need to index</span>
<span class="tok-n">city</span> <span class="tok-o">=</span> <span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">getPropertyKey</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span>
<span class="tok-n">country</span> <span class="tok-o">=</span> <span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">getPropertyKey</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">)</span>

<span class="tok-c1">// Create a new index and add our keys</span>
<span class="tok-n">index</span> <span class="tok-o">=</span> <span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">buildIndex</span><span class="tok-o">(</span><span class="tok-s1">'byCityAndCountry'</span><span class="tok-o">,</span> <span class="tok-n">Vertex</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">)</span>
<span class="tok-n">index</span><span class="tok-o">.</span><span class="tok-na">addKey</span><span class="tok-o">(</span><span class="tok-n">country</span><span class="tok-o">).</span><span class="tok-na">addKey</span><span class="tok-o">(</span><span class="tok-n">city</span><span class="tok-o">).</span><span class="tok-na">buildCompositeIndex</span><span class="tok-o">()</span>

<span class="tok-c1">// All done</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">commit</span><span class="tok-o">()</span>

<span class="tok-c1">// Wait for the index to be active</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">awaitGraphIndexStatus</span><span class="tok-o">(</span><span class="tok-n">graph</span><span class="tok-o">,</span> <span class="tok-s1">'byCityAndCountry'</span><span class="tok-o">).</span><span class="tok-na">call</span><span class="tok-o">()</span>

<span class="tok-c1">// Force a re-index</span>
<span class="tok-n">mgmt</span> <span class="tok-o">=</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">openManagement</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">updateIndex</span><span class="tok-o">(</span><span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">getGraphIndex</span><span class="tok-o">(</span><span class="tok-s2">"byCityAndCountry"</span><span class="tok-o">),</span> <span class="tok-n">SchemaAction</span><span class="tok-o">.</span><span class="tok-na">REINDEX</span><span class="tok-o">).</span><span class="tok-na">get</span><span class="tok-o">()</span>
<span class="tok-n">mgmt</span><span class="tok-o">.</span><span class="tok-na">commit</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use the Gremlin <em>profile</em> step to verify that JanusGraph is indeed now using
our new index. I have truncated some of the output so it will fit on the page but you
can see from the output that the query did indeed use our new index.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'London'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'country'</span><span class="tok-o">,</span><span class="tok-s1">'CA'</span><span class="tok-o">).</span><span class="tok-na">profile</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the output returned by the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">Traversal Metrics</span>
<span class="tok-go">Step                                              Traversers  Time (ms)</span>
<span class="tok-go">========================================================================</span>
<span class="tok-go">JanusGraphStep([],[city.eq(London), country.eq(...      1          1.036</span>
<span class="tok-go">    \_condition=(city = London AND country = CA)</span>
<span class="tok-go">    \_isFitted=true</span>
<span class="tok-go">    \_query=multiKSQ[1]@2147483647</span>
<span class="tok-go">    \_index=byCityAndCountry</span>
<span class="tok-go">    \_orders=[]</span>
<span class="tok-go">    \_isOrdered=true</span>
<span class="tok-go">  optimization                                                     0.741</span>
<span class="tok-go">  backend-query                                         1          0.085</span>
<span class="tok-go">    \_query=byCityAndCountry:multiKSQ[1]@2147483647</span>
<span class="tok-go">                                            &gt;TOTAL      -          1.036</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_a_script_to_automate_schema_creation_indexing_and_graph_loading">6.5.6. A script to automate schema creation, indexing and graph loading</h4>
<div class="paragraph">
<p>In the sample code directory of my GitHub project for this book you will find a small
Gremlin (Groovy) script in a file called <em>janusgraph-inmemory.groovy</em>. You can get to
the file by visiting this URL:
<a href="https://github.com/krlawrence/graph/blob/master/sample-code/janus-inmemory.groovy" class="bare">https://github.com/krlawrence/graph/blob/master/sample-code/janus-inmemory.groovy</a></p>
</div>
<div class="paragraph">
<p>The script will create an <em>inmemory</em> JanusGraph instance, define the schema, create
several indexes and load the <code>air-routes.graphml</code> file so that you can try some
queries using the Gremlin Console. You might find that a good way to experiment with
the concepts that we have covered in this discussion of JanusGraph so far.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="janpred">6.6. Additional JanusGraph text search predicates</h3>
<div class="paragraph">
<p>We have already looked, in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#tranges">Testing values and ranges of values</a> section, at the predicates TinkerPop
defines such as <em>neq</em>, <em>gte</em> and <em>lte</em>. JanusGraph offers an additional set of
predicates that can be used when looking for specific patterns within text in a
graph.</p>
</div>
<div class="paragraph">
<p>The methods that include the word <em>Contains</em> in their name look for whole words that
match the specified search pattern. The methods that do not include <em>Contains</em> in the
name look at the entire string being inspected for matches.</p>
</div>
<div class="paragraph">
<p>The table below summarizes the additional text search predicates that JanusGraph
provides.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 18. Additional JanusGraph text search predicates</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">textContains</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True if a whole word matches the search string provided.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">textContainsPrefix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True if at least one word starts with the search string provided.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">textContainsRegex</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True if at least one word matches the regular expression provided.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">textContainsFuzzy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True if a word matches the fuzzy search text provided.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">textPrefix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True if the string being inspected starts with the search text.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">textRegex</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True if the string being inspected matches the regular expression provided.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">textFuzzy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True if the string being inspected matches the fuzzy search text.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Let’s take a look at each of these predicates and what they offer with examples of
each being used. First off, the query below will find any vertex that has a <em>desc</em>
(description) property that contains the word <em>"Dallas"</em>. Note that this matches
<em>Dallas</em> followed by any word break character such as a space or a forward slash.</p>
</div>
<div class="sect3">
<h4 id="_text_comparison_predicates">6.6.1. Text comparison predicates</h4>
<div class="paragraph">
<p>The simplest of the search predicates allow you to specify an exact match that string
must be present either as a whole word (complete word match) or as part of the entire
text being examined. These searches are <strong>not</strong> case sensitive.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">,</span><span class="tok-n">textContains</span><span class="tok-o">(</span><span class="tok-s2">"Dallas"</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is what the query should return.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">Dallas/Fort Worth International Airport</span>
<span class="tok-go">Dallas Love Field</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The word being searched for using <em>textContains</em> does not have to be the first word
within the string. It just has to exist as a whole word. The query below looks for
the word <em>"Love"</em> appearing anywhere in the <em>desc</em> property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">,</span><span class="tok-n">textContains</span><span class="tok-o">(</span><span class="tok-s2">"Love"</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is what the query returns.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">Dallas Love Field</span>
<span class="tok-go">Ernest A. Love Field</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example the word <em>fort</em> is found no matter where it occurs in the <em>city</em>
name so long as it occurs as a standalone word.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">textContains</span><span class="tok-o">(</span><span class="tok-s2">"fort"</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see in the results below <em>Vieux Fort</em> was found as well as all of the
cities with names that start with <em>Fort</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">Fort Myers           Fort Worth</span>
<span class="tok-go">Fort-de-France       Fort McMurray</span>
<span class="tok-go">Fort Lauderdale      Fort Sandeman</span>
<span class="tok-go">Fort Wayne           Fort Smith</span>
<span class="tok-go">Fort St.John         Fort Yukon</span>
<span class="tok-go">Fort Nelson          Fort Albany</span>
<span class="tok-go">Fort Chipewyan       Fort Hood/Killeen</span>
<span class="tok-go">Fort Mcpherson       Vieux Fort</span>
<span class="tok-go">Fort Smith           Fort Good Hope</span>
<span class="tok-go">Fort Severn          Fort Frances</span>
<span class="tok-go">Fort Simpson         Fort Hope</span>
<span class="tok-go">Fort Leonard Wood    Fort Dodge</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The query below does not match any whole word in any description anywhere in the
graph so no results will be returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Matches no whole word so no results</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">,</span><span class="tok-n">textContains</span><span class="tok-o">(</span><span class="tok-s2">"Dalla"</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we use <em>textContainsPrefix</em> instead of <em>textContains</em>, the search will look for
whole words that start with the specified text and we will get some results. Take a
look at the next query and the results it generates.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Searches using <em>textContains</em> and <em>textContainsPrefix</em> are <strong>not</strong> case sensitive.
</td>
</tr>
</tbody></table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">,</span><span class="tok-n">textContainsPrefix</span><span class="tok-o">(</span><span class="tok-s2">"dalla"</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is what the query returns. This time we got some results as <em>Dallas</em> starts with
the characters <em>dalla</em>. Again, remember these are case insensitive queries.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">Dallas/Fort Worth International Airport</span>
<span class="tok-go">Dallas Love Field</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could use a <em>textContains</em> query to find airports that have the
word <em>Regional</em> as part of their description. An example of such a query is given
below. Only the first five matching airport descriptions found are returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">,</span><span class="tok-n">textContains</span><span class="tok-o">(</span><span class="tok-s1">'Regional'</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the descriptions returned by the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">Rapid City Regional Airport</span>
<span class="tok-go">Abilene Regional Airport</span>
<span class="tok-go">Grand Junction Regional Airport</span>
<span class="tok-go">San Luis County Regional Airport</span>
<span class="tok-go">Liberal Mid-America Regional Airport</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could adjust the regional airport query we did above to use  <em>textContainsPrefix</em>
if we wanted to be a bit less specific and look for any airport with <em>Reg</em> at the
start of any word in its description.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">,</span><span class="tok-n">textContainsPrefix</span><span class="tok-o">(</span><span class="tok-s1">'Reg'</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">5</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We still get the same five results back.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">Rapid City Regional Airport</span>
<span class="tok-go">Abilene Regional Airport</span>
<span class="tok-go">Grand Junction Regional Airport</span>
<span class="tok-go">San Luis County Regional Airport</span>
<span class="tok-go">Liberal Mid-America Regional Airport</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>textPrefix</em> predicate will look at the entire string being inspected and compare it to
the string you provide and only return a result if the string starts with the specified
pattern. So in this case we look at just the start of the whole string and not at
individual words within it. The query below looks for any cities whose name starts
with the characters <em>Los</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">textPrefix</span><span class="tok-o">(</span><span class="tok-s1">'Los'</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Searches using <em>textPrefix</em> <strong>are</strong> case sensitive.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>This is what we get back from the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">Los Alamos</span>
<span class="tok-go">Los Angeles</span>
<span class="tok-go">Los Mochis</span>
<span class="tok-go">Losuia</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice how the query did not find the city of <em>Chapelco/San Martin de los Andes</em> as
in this case the <em>Los</em> is not at the start of the name. If we did want to also have
that city discovered we could use <em>textContainsPrefix</em> instead as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">textContainsPrefix</span><span class="tok-o">(</span><span class="tok-s1">'Los'</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see this time we also found <em>Chapelco/San Martin de los Ande</em> and it is
part of the results returned. As before the case of the search term is ignored.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">Los Alamos</span>
<span class="tok-go">Chapelco/San Martin de los Andes</span>
<span class="tok-go">Los Angeles</span>
<span class="tok-go">Los Mochis</span>
<span class="tok-go">Losuia</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_regular_expression_predicates">6.6.2. Regular expression predicates</h4>
<div class="paragraph">
<p>The JanusGraph regular expression predicates recognize the syntax defined as part of
the Java 1.8 Pattern class that is documented at
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/regex/Pattern.html" class="bare">https://docs.oracle.com/javase/8/docs/api/java/util/regex/Pattern.html</a>. The Java
regular expression syntax may be different than the one you are used to so it is
worth taking a few minutes to study the documentation at that URL.</p>
</div>
<div class="paragraph">
<p>The query below uses a <em>textContainsRegex</em> predicate to search for any city name that
contains a word starting with <em>for</em>, while ignoring case.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">textContainsRegex</span><span class="tok-o">(</span><span class="tok-s2">"(?i)for.*"</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice how names that start with <em>For</em> such as <em>Fort Myers</em> as well as city names
containing words that start with the text <em>For</em> in a subsequent word are found. For example
<em>La Fortuna</em>  and <em>View Fort</em> are also found.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">Fort Myers                Fort Worth</span>
<span class="tok-go">La Fortuna/San Carlos     Fort McMurray</span>
<span class="tok-go">Fort-de-France            Fort Sandeman</span>
<span class="tok-go">Fort Lauderdale           Fortaleza</span>
<span class="tok-go">Fort Wayne                Fort Smith</span>
<span class="tok-go">Jerez de la Forntera      Fort Yukon</span>
<span class="tok-go">Fort St.John              Fort Albany</span>
<span class="tok-go">Fort Nelson               Fort Hood/Killeen</span>
<span class="tok-go">Fort Chipewyan            Vieux Fort</span>
<span class="tok-go">Formosa                   Fort Good Hope</span>
<span class="tok-go">Fort Mcpherson            Grand Forks</span>
<span class="tok-go">Fort Smith                Fort Frances</span>
<span class="tok-go">Juiz de Fora              Fort Hope</span>
<span class="tok-go">Fort Severn               Fort Dodge</span>
<span class="tok-go">Fort Simpson              Fort Leonard Wood</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The query below shows another way of searching for the word <em>dallas</em> at the start of
a string of text while ignoring case. This time we use a very simple regular
expression. Of course, in reality, this yields the same result that we could achieve
by simply using <em>textContainsPrefix</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Matches dallas ignoring case</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">textRegex</span><span class="tok-o">(</span><span class="tok-s2">"(?i)dallas"</span><span class="tok-o">)).</span><span class="tok-na">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'city'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As we can see the query worked as expected.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">[code:[DFW],city:[Dallas]]</span>
<span class="tok-go">[code:[DAL],city:[Dallas]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we wanted to expand our search a bit we could modify the regular expression, as
shown below, to find an city name that starts with the characters <em>dal</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Matches any city that contains dal followed by anything, ignoring case.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">textRegex</span><span class="tok-o">(</span><span class="tok-s1">'(?i)dal.*'</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This time we get some additional cities back.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">Dallas</span>
<span class="tok-go">Dallas</span>
<span class="tok-go">Dalcahue</span>
<span class="tok-go">Dalat</span>
<span class="tok-go">Dalaman</span>
<span class="tok-go">Dalanzadgad</span>
<span class="tok-go">Dalian</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we instead wanted to get more specific we could again adjust the regular
expression. This time we look for any city name that starts with any three characters
followed by the characters <em>cah</em> followed by any number of other characters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Anything that matches 3 characters followed by 'cah' followed by anything.</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">textRegex</span><span class="tok-o">(</span><span class="tok-s2">".{3}cah.*"</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using our modified, and much more specific search pattern we find just one city that
matches the pattern.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">Dalcahue</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is another example that looks for a city name that starts with any three
characters followed by either <em>cah</em> or <em>anz</em> followed by any number of characters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">textRegex</span><span class="tok-o">(</span><span class="tok-s2">".{3}(cah|anz).*"</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is what we get back using this regular expression.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">Dalcahue</span>
<span class="tok-go">Dalanzadgad</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is another query that uses a regular expression to find airports that have a
region code that starts with the characters <em>US-</em> followed by any of <em>O</em>, <em>R</em> or <em>D</em>
followed by any number of characters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-n">textRegex</span><span class="tok-o">(</span><span class="tok-s2">"US-[ORD].*"</span><span class="tok-o">)).</span>
      <span class="tok-n">local</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()).</span><span class="tok-na">fold</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is what this query returns.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[[</span><span class="tok-n">PVD</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">RI</span><span class="tok-o">],[</span><span class="tok-n">LMT</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">OR</span><span class="tok-o">],[</span><span class="tok-n">SWO</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">OK</span><span class="tok-o">],[</span><span class="tok-n">PDX</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">OR</span><span class="tok-o">],[</span><span class="tok-n">EUG</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">OR</span><span class="tok-o">],[</span><span class="tok-n">MFR</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">OR</span><span class="tok-o">],[</span><span class="tok-n">TOL</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">OH</span><span class="tok-o">],[</span><span class="tok-n">PDT</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">OR</span><span class="tok-o">],[</span><span class="tok-n">CMH</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">OH</span><span class="tok-o">],[</span><span class="tok-n">OTH</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">OR</span><span class="tok-o">],[</span><span class="tok-n">YNG</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">OH</span><span class="tok-o">],[</span><span class="tok-n">OKC</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">OK</span><span class="tok-o">],[</span><span class="tok-n">DAY</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">OH</span><span class="tok-o">],[</span><span class="tok-n">LAW</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">OK</span><span class="tok-o">],[</span><span class="tok-n">LCK</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">OH</span><span class="tok-o">],[</span><span class="tok-n">LUK</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">OH</span><span class="tok-o">],[</span><span class="tok-n">RDM</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">OR</span><span class="tok-o">],[</span><span class="tok-n">DCA</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">DC</span><span class="tok-o">],[</span><span class="tok-n">CLE</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">OH</span><span class="tok-o">],[</span><span class="tok-n">TUL</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">OK</span><span class="tok-o">],[</span><span class="tok-n">CAK</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">OH</span><span class="tok-o">],[</span><span class="tok-n">ILG</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">DE</span><span class="tok-o">],[</span><span class="tok-n">BID</span><span class="tok-o">,</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">RI</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is a slightly more complicated query that uses a regular expression. The pattern
matches any airport description containing a word that starts with any character
followed by <em>al</em>, optionally followed by another <em>l</em> and then followed by any
character that is not one of <em>"s,k,e,i"</em> ignoring case.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">,</span><span class="tok-n">textContainsRegex</span><span class="tok-o">(</span><span class="tok-s2">"(?i).all?[^(s|k|e|i)]"</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the list of airport descriptions that the query returns.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">Dinard-Pleurtuit-Saint-Malo Airport</span>
<span class="tok-go">Walla Walla Regional Airport</span>
<span class="tok-go">Salt Lake City</span>
<span class="tok-go">Palm Springs International Airport</span>
<span class="tok-go">Eduardo Falla Solano Airport</span>
<span class="tok-go">Palm Beach International Airport</span>
<span class="tok-go">Salt Cay Airport</span>
<span class="tok-go">Melville Hall Airport</span>
<span class="tok-go">Hall Beach Airport</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_fuzzy_search_predicates">6.6.3. Fuzzy search predicates</h4>
<div class="paragraph">
<p>These predicates use the
<a href="https://en.wikipedia.org/wiki/Levenshtein_distance">Levenshtein distance</a> method to
decide if a piece of text is <em>close enough</em> to the pattern being looked for. This is
based on assessing how many characterss would have to change in the pattern word to
achieve a match in the text being inspected. For example <em>pall</em> would match <em>palm</em>,
<em>paul</em> and <em>palm</em>.</p>
</div>
<div class="paragraph">
<p>The query below uses a fuzzy sort to find any words that are close to the word
<em>pall</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">,</span><span class="tok-n">textContainsFuzzy</span><span class="tok-o">(</span><span class="tok-s2">"pall"</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the results from running the query. You can see that airport descriptions
that contain the whole words <em>Paul</em>, <em>Palm</em> and <em>Hall</em> have been found.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">Minneapolis-St.Paul International Airport</span>
<span class="tok-go">Palm Beach International Airport</span>
<span class="tok-go">Palm Springs International Airport</span>
<span class="tok-go">John Paul II International Airport Krakow-Balice Airport</span>
<span class="tok-go">Melville Hall Airport</span>
<span class="tok-go">Hall Beach Airport</span>
<span class="tok-go">St Paul Island Airport</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This query uses <em>textFuzzy</em> to find cities whose names are close to Dublin.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-n">textFuzzy</span><span class="tok-o">(</span><span class="tok-s1">'Dublin'</span><span class="tok-o">)).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is what the query returns. You can see that the method used by <em>fuzzy</em> searches
is more than just single character replacement. Note that not all of the city names
returned are of the same length. To better understand the <em>fuzzy search</em> algorithm it
is recommended to look at the Wikipedia page mentioned above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">Yulin</span>
<span class="tok-go">Hubli</span>
<span class="tok-go">Dublin</span>
<span class="tok-go">Lublin</span>
<span class="tok-go">Dubois</span>
<span class="tok-go">Dubai</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="janusgeo">6.7. The JanusGraph GeoSpatial API</h3>
<div class="paragraph">
<p>Earlier, in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#latlonmanual">Using latitude, longitude and geographical region in queries</a>" section, I provided a few examples of how we could
write some queries that took advantage of the fact that the airports in the
<em>air-routes</em> graph include their latitude and longitude among their properties. When
working with JanusGraph there are some additional built in capabilities that we can
take advantage of.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The official JanusGraph API documentation is a good place to read up on the
GeoShape class and related classes. That documentation can always be found by
starting here: <a href="http://docs.janusgraph.org/latest/javadoc.html" class="bare">http://docs.janusgraph.org/latest/javadoc.html</a>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The example below shows one way that we could use the GeoSpatial API to find airports
within a circle having a 100 kilometer radius with London Heathrow (LHR) at the
center of that circle. A key class to be aware of is the <em>Geoshape</em> class. It can be
used to create areas that we can use when testing for other coordinates falling
within that area.</p>
</div>
<div class="paragraph">
<p>Notice in the code below that for each airport in the graph a <em>point</em> is created
based on the latitude and longitude of that airport. A test is then performed to see
if that <em>point</em> lies within our 100km circle. Only airports that do are passed on to
the <em>valueMap</em> step. Notice also how a <em>map</em> step is used so that we can do some
calculations inside of a closure while creating the <em>point</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Get the lat/lon for LHR</span>
<span class="tok-n">lon</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span>
<span class="tok-n">lat</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span>

<span class="tok-c1">// Create a 100km radius circle with LHR at the center</span>
<span class="tok-n">boundary</span> <span class="tok-o">=</span> <span class="tok-n">Geoshape</span><span class="tok-o">.</span><span class="tok-na">circle</span><span class="tok-o">(</span><span class="tok-n">lat</span><span class="tok-o">,</span><span class="tok-n">lon</span><span class="tok-o">,</span><span class="tok-mi">100</span><span class="tok-o">)</span>

<span class="tok-c1">// Find other airports that are within that circle</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">map</span><span class="tok-o">{</span><span class="tok-n">a</span><span class="tok-o">=</span><span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">().</span><span class="tok-na">value</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">);</span>
                <span class="tok-n">b</span><span class="tok-o">=</span><span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">().</span><span class="tok-na">value</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">);</span>
                <span class="tok-n">Geoshape</span><span class="tok-o">.</span><span class="tok-na">point</span><span class="tok-o">(</span><span class="tok-n">a</span><span class="tok-o">,</span><span class="tok-n">b</span><span class="tok-o">).</span><span class="tok-na">within</span><span class="tok-o">(</span><span class="tok-n">boundary</span><span class="tok-o">)}.</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">)).</span>
                <span class="tok-n">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'lat'</span><span class="tok-o">,</span><span class="tok-s1">'lon'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Below is the output that you might bet back from running the above query. The query
can be run as-is from the Gremlin Console connected to a JanusGraph instance
containing the <em>air-routes</em> graph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">0.190277993679047</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.1481018066406</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">BZZ</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">1.58361995220184</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.749964</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">STN</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[</span><span class="tok-mf">0.234999999404</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.8849983215</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LTN</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">0.368333011865616</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.874698638916</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">SOU</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">1.35679996013641</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">50.9502983093262</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">0.461941003799</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.4706001282</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LCY</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[</span><span class="tok-mf">0.055278</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.505278</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">SEN</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[</span><span class="tok-mf">0.695555984973907</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.5713996887207</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are many ways we could optimize our query to avoid creating a <em>point</em> for every
single airport in the graph. In this particular case, we might decide, for example,
that we are only interested in airports in England. To do this we could add a check
to our query to make sure that only airports with a region code of <em>GB-ENG</em> are
tested. Here is the query modified with that check added.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Find other airports that within 100km of LHR</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'GB-ENG'</span><span class="tok-o">).</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">map</span><span class="tok-o">{</span><span class="tok-n">a</span><span class="tok-o">=</span><span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">().</span><span class="tok-na">value</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">);</span>
                <span class="tok-n">b</span><span class="tok-o">=</span><span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">().</span><span class="tok-na">value</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">);</span>
                <span class="tok-n">Geoshape</span><span class="tok-o">.</span><span class="tok-na">point</span><span class="tok-o">(</span><span class="tok-n">a</span><span class="tok-o">,</span><span class="tok-n">b</span><span class="tok-o">).</span><span class="tok-na">within</span><span class="tok-o">(</span><span class="tok-n">boundary</span><span class="tok-o">)}.</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">)).</span>
                <span class="tok-n">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'lat'</span><span class="tok-o">,</span><span class="tok-s1">'lon'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the output from running the query again. Other than the order in which
results were returned being different we got the same results. However this query is
more efficient as it is able to take advantage of the index that we created earlier
for the <em>region</em> property to filter out all airports not in the region <em>GB-ENG</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">0.190277993679047</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.1481018066406</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">0.461941003799</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.4706001282</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LCY</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[</span><span class="tok-mf">0.055278</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.505278</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">STN</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[</span><span class="tok-mf">0.234999999404</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.8849983215</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LTN</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">0.368333011865616</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.874698638916</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">SOU</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">1.35679996013641</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">50.9502983093262</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">SEN</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[</span><span class="tok-mf">0.695555984973907</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.5713996887207</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">BZZ</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">1.58361995220184</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.749964</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the GeoSpatial API we can create shapes representing different geographic
regions and compare them. The example below shows how to create a 100km circle with
Longdon heathrow (LHR) at the center and a second circle with Manchester (MAN) at the
center. The <em>intersect</em> method is then used to see if any points appear in both
circles.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Create a 100km radius circle with LHR at the center</span>

<span class="tok-n">lon_lhr</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span>
<span class="tok-n">lat_lhr</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span>

<span class="tok-n">lhr_circ</span> <span class="tok-o">=</span> <span class="tok-n">Geoshape</span><span class="tok-o">.</span><span class="tok-na">circle</span><span class="tok-o">(</span><span class="tok-n">lat_lhr</span><span class="tok-o">,</span><span class="tok-n">lon_lhr</span><span class="tok-o">,</span><span class="tok-mi">100</span><span class="tok-o">)</span>

<span class="tok-c1">// Create a 100km radius circle with MAN at the center</span>

<span class="tok-n">lat_man</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'MAN'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span>
<span class="tok-n">lon_man</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'MAN'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span>

<span class="tok-n">man_circ</span> <span class="tok-o">=</span> <span class="tok-n">Geoshape</span><span class="tok-o">.</span><span class="tok-na">circle</span><span class="tok-o">(</span><span class="tok-n">lat_man</span><span class="tok-o">,</span><span class="tok-n">lon_man</span><span class="tok-o">,</span><span class="tok-mi">100</span><span class="tok-o">)</span>

<span class="tok-c1">// Do any points in the two circles intersect?</span>

<span class="tok-n">lhr_circ</span><span class="tok-o">.</span><span class="tok-na">intersect</span><span class="tok-o">(</span><span class="tok-n">man_circ</span><span class="tok-o">)</span>

<span class="tok-kc">false</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the test returns <em>false</em> indicating that there are no shared points.
To prove that the tests work when points do overlap, let’s create another 100km
circle with Liverpool (LPL) in the middle and compare that one with the Manchester
circle.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Create a 100km radius circle with LPL at the center</span>

<span class="tok-n">lat_lpl</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LPL'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span>
<span class="tok-n">lon_lpl</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LPL'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span>

<span class="tok-n">lpl_circ</span> <span class="tok-o">=</span> <span class="tok-n">Geoshape</span><span class="tok-o">.</span><span class="tok-na">circle</span><span class="tok-o">(</span><span class="tok-n">lat_lpl</span><span class="tok-o">,</span><span class="tok-n">lon_lpl</span><span class="tok-o">,</span><span class="tok-mi">100</span><span class="tok-o">)</span>

<span class="tok-c1">// Do any points in the two circles intersect?</span>

<span class="tok-n">lpl_circ</span><span class="tok-o">.</span><span class="tok-na">intersect</span><span class="tok-o">(</span><span class="tok-n">man_circ</span><span class="tok-o">)</span>

<span class="tok-kc">true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>Geoshape</em> class provides a number of useful methods. If we wanted to verify that
the latitude and longitude values we got back from the LHR vertex were valid, meaning
they do indeed represent a point somewhere on Earth, we could do so as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">Geoshape</span><span class="tok-o">.</span><span class="tok-na">isValidCoordinate</span><span class="tok-o">(</span><span class="tok-n">lat</span><span class="tok-o">,</span><span class="tok-n">lon</span><span class="tok-o">)</span>

<span class="tok-kc">true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Earlier, in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#latlonmanual">Using latitude, longitude and geographical region in queries</a>" section I demonstrated the query below. The query
finds all airports within a conceptual rectangle around the London Heathrow (LHR)
airport. The rectangle is defined by adding or subtracting one degree of latitude and
longitude to the opposite diagonals with LHR at the center.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">lat</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span>
<span class="tok-n">lon</span> <span class="tok-o">=</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LHR'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">).</span><span class="tok-na">next</span><span class="tok-o">()</span>

<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">,</span><span class="tok-n">between</span><span class="tok-o">(</span><span class="tok-n">lon</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">lon</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-o">)).</span>
                          <span class="tok-n">has</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">,</span><span class="tok-n">between</span><span class="tok-o">(</span><span class="tok-n">lat</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">lat</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-o">)).</span>
                          <span class="tok-n">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'lat'</span><span class="tok-o">,</span><span class="tok-s1">'lon'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the output that query produced.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">0.461941003799</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.4706001282</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">0.190277993679047</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.1481018066406</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LCY</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[</span><span class="tok-mf">0.055278</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.505278</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">STN</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[</span><span class="tok-mf">0.234999999404</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.8849983215</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LTN</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">0.368333011865616</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.874698638916</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">SOU</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">1.35679996013641</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">50.9502983093262</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use the JanusGraph Geoshape class to rewrite the query as shown below. Instead
of using a <em>circle</em> this time we will create a <em>box</em> representing a geographical
region around London Heathrow (LHR).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Define a box around LHR with opposite diagonal corners</span>
<span class="tok-c1">// each one degree from LHR.</span>
<span class="tok-n">box</span> <span class="tok-o">=</span> <span class="tok-n">Geoshape</span><span class="tok-o">.</span><span class="tok-na">box</span><span class="tok-o">(</span><span class="tok-n">lat_lhr</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">lon_lhr</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">lat_lhr</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-o">,</span><span class="tok-n">lon_lhr</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-o">)</span>

<span class="tok-c1">// Find other airports that within the box</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">,</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'GB-ENG'</span><span class="tok-o">).</span>
      <span class="tok-n">where</span><span class="tok-o">(</span><span class="tok-n">map</span><span class="tok-o">{</span><span class="tok-n">a</span><span class="tok-o">=</span><span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">().</span><span class="tok-na">value</span><span class="tok-o">(</span><span class="tok-s1">'lat'</span><span class="tok-o">);</span>
                <span class="tok-n">b</span><span class="tok-o">=</span><span class="tok-n">it</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">().</span><span class="tok-na">value</span><span class="tok-o">(</span><span class="tok-s1">'lon'</span><span class="tok-o">);</span>
                <span class="tok-n">Geoshape</span><span class="tok-o">.</span><span class="tok-na">point</span><span class="tok-o">(</span><span class="tok-n">a</span><span class="tok-o">,</span><span class="tok-n">b</span><span class="tok-o">).</span><span class="tok-na">within</span><span class="tok-o">(</span><span class="tok-n">box</span><span class="tok-o">)}.</span><span class="tok-na">is</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">)).</span>
                <span class="tok-n">valueMap</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'lat'</span><span class="tok-o">,</span><span class="tok-s1">'lon'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The results from running our new query are shown below. As you can see the same
airports were found.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LGW</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">0.190277993679047</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.1481018066406</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LHR</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">0.461941003799</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.4706001282</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LCY</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[</span><span class="tok-mf">0.055278</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.505278</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">STN</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[</span><span class="tok-mf">0.234999999404</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.8849983215</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">LTN</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">0.368333011865616</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">51.874698638916</span><span class="tok-o">]]</span>
<span class="tok-o">[</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">SOU</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">1.35679996013641</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">50.9502983093262</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I have just shown a few examples of the many things that you can do using the
JanusGraph GeoSpatial API. If this is an area that interests you I recommend reading
the API documentation for the <em>Geoshape</em> and related classes.</p>
</div>
</div>
<div class="sect2">
<h3 id="janusstorage">6.8. Choosing a persistent storage technology for JanusGraph</h3>
<div class="paragraph">
<p>So far we have concentrated on examples where the graph data resides in the memory of
the computer system. The only form of persistence we have so far looked at is saving
an entire graph as JSON or XML and reading it back into memory at a future date.
Clearly, for many production systems, we need a better story for data persistence. As
delivered, JanusGraph supports a number of different back end databases that can be
used to persist graph data. A bit later, in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#dockercass">Using Docker to experiment with Cassandra and JanusGraph</a>" section, we will
explore a simple way to experiment with one of these database options.</p>
</div>
<div class="paragraph">
<p>Once JanusGraph has been downloaded and installed (unzipped) you will find a
directory called /conf below the directory where JanusGraph was installed. In this
directory you will find a number of Java properties files that can be used to connect
JanusGraph to different back end data stores. Depending upon your configuration these
property files may work unchanged or may need to be edited. Each property file has
detailed comments that explain what the various setting do.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The official JanusGraph documentation provides detailed configuration
information for each of the currently supported back end stores.
<a href="http://docs.janusgraph.org/latest/storage-backends.html" class="bare">http://docs.janusgraph.org/latest/storage-backends.html</a>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Let’s now take a brief look at some of the persistent storage options available to us
when using JanusGraph.</p>
</div>
<div class="sect3">
<h4 id="berkleyintro">6.8.1. Oracle Berkley DB</h4>
<div class="paragraph">
<p>Oracle Berkely DB may be a good choice if your application runs on a single machine
but needs a persistent store. All data is persisted to the same local disk of the
system where your application runs. Berkley DB is popular with developers who want to
develop and test graph applications on a single machine using more than an in-memory
back end. Assuming you are developing an application using Java or Groovy, the Java
version of Berkley DB, known as Berkley DB Java Edition, is provided as a set of
libraries that you embed with your application and run using the same JVM as your
application. Because Berkley DB JE runs on a single machine, the amount of graph data
that you can store will depend on the size of the disk available on that machine.</p>
</div>
<div class="paragraph">
<p>For production systems that only need a modest sized graph this may also be a valid
choice. If your application is likely to generate very large graphs in excess of 100
million vertices you will probably need to investigate some of the other, multi node
cluster capable, storage options that we will discuss next. Berkley DB is probably
not a good choice if you need multiple users to be accessing and changing the graph
concurrently.</p>
</div>
<div class="paragraph">
<p>The JanusGraph <em>/conf</em> directory contains a file called
<em>janusgraph-berkleyje.properties</em> that can be used to create a new instance of a
JanusGraph backed by Berkley as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">graph</span> <span class="tok-o">=</span> <span class="tok-n">JanusGraphFactory</span><span class="tok-o">.</span><span class="tok-na">open</span><span class="tok-o">(</span><span class="tok-s2">"conf/janusgraph-berkleyje.properties"</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, as there is not much to configure when using Berkley DB, you could
decide to pass the properties directly to JanusGraph as follows. The second <em>set</em>
command specifies where your data will be stored on the disk.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">graph</span> <span class="tok-o">=</span> <span class="tok-n">JanusGraphFactory</span><span class="tok-o">.</span><span class="tok-na">build</span><span class="tok-o">().</span>
          <span class="tok-n">set</span><span class="tok-o">(</span><span class="tok-s2">"storage.backend"</span><span class="tok-o">,</span><span class="tok-s2">"berkleyje"</span><span class="tok-o">).</span>
          <span class="tok-n">set</span><span class="tok-o">(</span><span class="tok-s2">"storage.directory"</span><span class="tok-o">,</span><span class="tok-s2">"/mydata"</span><span class="tok-o">).</span>
          <span class="tok-n">open</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Oracle Berkley DB can be downloaded from the Oracle web site from the following URL.
<a href="http://www.oracle.com/technetwork/database/database-technologies/berkeleydb/overview/index.html" class="bare">http://www.oracle.com/technetwork/database/database-technologies/berkeleydb/overview/index.html</a></p>
</div>
</div>
<div class="sect3">
<h4 id="cassandraintro">6.8.2. Apache Cassandra</h4>
<div class="paragraph">
<p>If a single machine storage solution, such as that offered by Berkley DB, is
insufficient for your needs then there are several other choices that offer
horizontal scaling and high availability. Apache Cassandra is one such choice. Which
storage solution you chose will depend on many factors that go beyond the scope of
this book. However, if you already have Apache Cassandra deployed in your
organization or data center and have people that know how to manage and configure it,
it might be the right choice for your JanusGraph back end storage needs. Like any big
data system Apache Cassandra requires tuning and maintenance to get the best
performance for your workload type. That potentially requires developing new skills
and doing some experimentation. Apache Cassandra is written in Java and it is
important to keep a careful eye on the amount of garbage collection taking place
within the virtual machines that are running your Cassandra instances. Excessive
garbage collection can significantly impact your graph’s performance. There are many
ways that Cassandra can be deployed ranging from a single instance on your local
machine to a multi node cluster. How you deploy it will depend on your scalability
and redundancy needs. Note that Cassandra, like Berkley DB can, if needed, also run
in embedded mode.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For detailed configuration information you should refer to the official JanusGraph
documentation located at <a href="http://docs.janusgraph.org/latest/storage-backends.html" class="bare">http://docs.janusgraph.org/latest/storage-backends.html</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>A bit later, in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#dockercass">Using Docker to experiment with Cassandra and JanusGraph</a>" section, we will take a look at deploying a
single node instance of Cassandra using Docker containers which provides a nice
environment for development and testing.</p>
</div>
<div class="paragraph">
<p>The JanusGraph <em>/conf</em> directory contains several property files that can be used
when working with Apache Cassandra. Which one you use will depend on the way you
chose to deploy Cassandra. Later on we will look at the additional steps you need to
take to configure your environment when external indexes are used. However, if you
were using Cassandra without an external index being needed you might connect to it
as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">graph</span> <span class="tok-o">=</span> <span class="tok-n">JanusGraphFactory</span><span class="tok-o">.</span><span class="tok-na">open</span><span class="tok-o">(</span><span class="tok-s2">"conf/janusgraph-cassandra.properties"</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You will need to edit the properties file to contain the host name and IP address of
your Cassandra system. By default the properties file is configured for use with
<em>localhost</em>.</p>
</div>
<div class="paragraph">
<p>Apache Cassandra can be downloaded from the Apache web site from the following
URL. <a href="http://cassandra.apache.org/" class="bare">http://cassandra.apache.org/</a></p>
</div>
</div>
<div class="sect3">
<h4 id="scyllaintro">6.8.3. ScyllaDB</h4>
<div class="paragraph">
<p>ScyllaDB is API compatible with Apache Cassandra but implemented in C++. The same
configuration files that you use when working with Apache Cassandra should also work
with ScyllaDB.</p>
</div>
<div class="paragraph">
<p>ScyllaDB can be downloaded from the following URL. <a href="http://www.scylladb.com/" class="bare">http://www.scylladb.com/</a></p>
</div>
</div>
<div class="sect3">
<h4 id="hbaseintro">6.8.4. Apache HBase</h4>
<div class="paragraph">
<p>If you already have a Hadoop and HDFS environment setup or are planning to deploy
one, then Apache HBase may be a good choice for your JanusGraph data store. Apache
HBase, like Apache Cassandra, is a database that supports very large tables. There
are several properties files in the <em>/conf</em> directory that can be used to connect
JanusGraph to an Apache HBase store.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For detailed configuration information you should refer to the official JanusGraph
documentation located at <a href="http://docs.janusgraph.org/latest/storage-backends.html" class="bare">http://docs.janusgraph.org/latest/storage-backends.html</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Which properties file you use will depend on whether or not you need to use an
external index. However, if you were using HBase without an external index being
needed you might connect to it as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">graph</span> <span class="tok-o">=</span> <span class="tok-n">JanusGraphFactory</span><span class="tok-o">.</span><span class="tok-na">open</span><span class="tok-o">(</span><span class="tok-s2">"conf/janusgraph-hbase.properties"</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As with the Cassandra properties file, The HBase properties file is preconfigured to
connect to <em>localhost</em>. You will need to edit it and update the hostname and IP
address as appropriate before calling <em>open</em> if you want to connect to a different
machine.</p>
</div>
<div class="paragraph">
<p>Apache HBase can be downloaded from the Apache web site at the following
URL. <a href="https://hbase.apache.org/" class="bare">https://hbase.apache.org/</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_google_bigtable">6.8.5. Google Bigtable</h4>
<div class="paragraph">
<p>All of the options discussed so far are open source alternatives that you could
download and run in-house. For the sake of completeness I am including a few pointers
to some "for fee" alternatives to hosting your JanusGraph data in house. Google
Bigtable is API compatible with Apache HBase. It offers a hosted alternative to
hosting your own HBase cluster for use with JanusGraph. Of course you will have to
decide if paying for a hosted database service is the way you want to go versus
hosting your graph data in house or setting up your own environment that you manage
on a hosting service of your choice.</p>
</div>
<div class="paragraph">
<p>You can read more about Google Bigtable at the following URL. <a href="https://cloud.google.com/bigtable/" class="bare">https://cloud.google.com/bigtable/</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_ibm_compose_for_janusgraph">6.8.6. IBM Compose for JanusGraph</h4>
<div class="paragraph">
<p>IBM offers a hosted and managed JanusGraph environment via its Compose platform. In
this environment IBM manages the whole environment for you which includes JanusGraph
backed by a ScyllaDB cluster. As with Google Bigtable this is a hosted service that
you pay to use. If the idea of managing a Cassandra compatible cluster for use with
JanusGraph yourself is not something you want to take on this is an option you can
consider.</p>
</div>
<div class="paragraph">
<p>You can read more about this service at the following
URL. <a href="https://www.ibm.com/cloud/compose/janusgraph" class="bare">https://www.ibm.com/cloud/compose/janusgraph</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_other_tinkerpop_compatible_products_and_services">6.8.7. Other TinkerPop compatible products and services</h4>
<div class="paragraph">
<p>There are now several other products and cloud hosted environments that do not offer
JanusGraph support per-se but do offer TinkerPop and Gremlin support backed by other
stores. There are a selection of both hosted and in-house options to choose from. The
Apache TinkerPop project maintains a list of TinkerPop compatible graph stores. You
can find that list here <a href="http://tinkerpop.apache.org/providers.html" class="bare">http://tinkerpop.apache.org/providers.html</a>.</p>
</div>
<div class="paragraph">
<p>What is really good to see is that ApacheTinkerpop, and in particular the Gremlin
query and traversal language, has become one of the primary ways that people are
building and interacting with, graph databases.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dockercass">6.9. Using Docker to experiment with Cassandra and JanusGraph</h3>
<div class="paragraph">
<p>I find that using Docker containers can be a great way to quickly get things running
when you are experimenting with new ideas or new technology, or as if often the case,
both at the same time! There is a very useful containerized implementation of Apache
Cassandra available that you can download and get running in a few seconds and use to
test things with JanusGraph. In this section I will walk you through the steps that I
use to get a single Cassandra node up and running and use it with JanusGraph to setup
the <em>air-routes</em> graph. I am going to make the assumption that you have already
downloaded and installed the necessary Docker runtime for your platform. I do most of
my Docker testing using Linux systems but there are runtimes available for Windows
and Mac OS as well. Assuming you have docker installed, Cassandra can be installed
using a simple <em>docker pull</em> command as shown below.</p>
</div>
<div class="paragraph">
<p>Note that to make it clearer where commands need to be entered commands that need to
be entered into the Linux terminal shell are prefixed with  <em>"sh&gt;"</em> and commands
that are entered into the Gremlin Console have the <em>"gremlin&gt;"</em> prefix.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">sh&gt; docker pull cassandra</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="cassstart">6.9.1. Starting the Cassandra container</h4>
<div class="paragraph">
<p>Once Docker has downloaded the Cassandra image for you, it is quite simple to get a
single instance of Cassandra up and running. There are different ways that you can
use to configure Docker. To keep things simple I am going to just use command line
parameters. The command does several things as shown in the notes below it. I split
the command over four lines to make it easier to read.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">sh&gt; docker run -d -p 7001:7001 -p 7199:7199 -p 9042:9042 -p 9160:9160 \    </span><i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-go">-v  /var/lib/cassandra:/var/lib/cassandra \  </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-go">-e CASSANDRA_START_RPC=true \  </span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-go">--name cass  cassandra   </span><i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Starts a new instance of the Cassandra container.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Runs the command in the background using the <em>"-d"</em> flag.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Exposes the key ports that Cassandra uses so that JanusGraph can connect to this
Cassandra instance (<em>"-p"</em> flags).</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Maps (mounts) the Cassandra volume to the local disk. This is where the data will
be stored. If we did not do this the data would be lost whenever the container gets
deleted (<em>"-v"</em> flag).</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Enables Thrift support using the <em>-e CASSANDRA_START_RPC=true</em> setting. This is not
needed if you use CQL which is enabled by default.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Names the container "cass" which makes it easier for us to refer to it later.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>If you want to check on the progress of your new container at any time you can just
check the logs using the command below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">sh&gt; docker logs cass</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As with other Docker containers, our Cassandra container can be stopped and started
as needed using the following commands. Care should be taken not to stop the
container if JanusGraph is still busy writing data.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">sh&gt; docker stop cass</span>

<span class="tok-go">sh&gt; docker start cass</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cassconnect">6.9.2. Connecting JanusGraph to Cassandra</h4>
<div class="paragraph">
<p>Now that we have an instance of a Cassandra running, it’s time to start the Gremlin
Console that is included with the JanusGraph download and connect to Cassandra.
Cassandra supports different protocols that can be used when connecting to it. These
include Astyanax (from Netflix), Thrift and CQL. In this section I am just going to
discuss Thrift and CQL. An in depth study of these protocols is beyond the scope of
this book but if you want to read more about them a few web searches will find you
plenty of documentation. It should be noted that both Thrift and Astyanax are being
deprecated in favor of CQL. At some point in the future support for the older
protocols is likely to be dropped so it is probably a good idea to get comfortable
using CQL as the primary way that you connect JanusGraph to Cassandra,</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
A script called <em>janus-cassandra.groovy</em> is available in the sample-code
folder at <a href="https://github.com/krlawrence/graph/tree/master/sample-code" class="bare">https://github.com/krlawrence/graph/tree/master/sample-code</a>. The script
will automate everything that we are about to discuss in this section and you are
encouraged to study it.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>A number of properties files are included with the JanusGraph download. They are
located in the <em>/conf</em> folder below the root of the JanusGraph folder. The properties
files can be used to help connect JanusGraph to a number of different back end
technologies. These properties files can be edited as needed but so long as you are
using the default Cassandra ports with Cassandra running on your local machine
(localhost) you should not have to edit anything for the purpose of this discussion.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you decide to run Cassandra on a remote machine, you will need to edit the
properties file, or create a new one, so that it contains the appropriate host names
and IP addresses of the remote system.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>If you want to connect JanusGraph to Cassandra using the CQL protocol you can use the
<em>janusgraph-cql.properties</em> file as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-n">graph</span> <span class="tok-o">=</span> <span class="tok-n">JanusGraphFactory</span><span class="tok-o">.</span><span class="tok-na">open</span><span class="tok-o">(</span><span class="tok-s1">'conf/janusgraph-cql.properties'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You may see a warning message followed by a long stack trace when you issue this
command. Despite looking like something horrible has happened this can be ignored and
things will still work. I believe that this is a known issue in the community.</p>
</div>
<div class="paragraph">
<p>Aside from a potential warning message, if all goes well you should see something
like the output below after the command has run. This shows that we have a CQL
connection to our Cassandra instance running on or local machine at 127.0.0.1.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">graphtraversalsource</span><span class="tok-o">[</span><span class="tok-n">standardjanusgraph</span><span class="tok-o">[</span><span class="tok-nl">cql:</span><span class="tok-o">[</span><span class="tok-mf">127.0</span><span class="tok-o">.</span><span class="tok-mf">0.1</span><span class="tok-o">]],</span> <span class="tok-n">standard</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to connect JanusGraph to Cassandra using the Thrift protocol you can use
the <em>janusgraph-cassandra.properties</em> file as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-n">graph</span> <span class="tok-o">=</span> <span class="tok-n">JanusGraphFactory</span><span class="tok-o">.</span><span class="tok-na">open</span><span class="tok-o">(</span><span class="tok-s1">'conf/janusgraph-cassandra.properties'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the command succeeds, you should get back some output that looks like this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">standardjanusgraph</span><span class="tok-o">[</span><span class="tok-nl">cassandrathrift:</span><span class="tok-o">[</span><span class="tok-mf">127.0</span><span class="tok-o">.</span><span class="tok-mf">0.1</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When either of these commands are run, a new JanusGraph instance will be created and
JanusGraph will attempt to connect to Cassandra using the specified protocols. The
first time you connect to a brand new (empty) Cassandra instance you should first
define the graph’s schema by creating key definitions and create any indexes that you
need before creating any vertices, edges or properties. If you would like to
experiment with the <em>air-routes</em> data using Cassandra as the backing store, the script
called <code>janus-cassandra.groovy</code> from the <code>sample-code</code> folder can be used for this. If
you prefer you can experiment yourself from the console using the JanusGraph
management API to create keys and indexes and creating a traversal source object
before adding any vertices and edges.</p>
</div>
<div class="paragraph">
<p>If you choose run the <code>janus-cassandra.groovy</code> script it will create the keys and
indexes needed and then load the <em>air-routes</em> graph and also run a few tests to make
sure everything is working. Note that you only need to do this setup step once as
next time the data will have already been loaded and the schema defined.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As we are storing our graph into an instance of Cassandra where the data is
being persisted on our local file system, the next time you start JanusGraph and
re-connect to Cassandra your data will be waiting for you!
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>To run the script from the Gremlin Console you can just use the <em>:load</em> command to
load it as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-o">:</span><span class="tok-n">load</span> <span class="tok-n">janus</span><span class="tok-o">-</span><span class="tok-n">cassandra</span><span class="tok-o">.</span><span class="tok-na">groovy</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the script works as expected you should now be able to query the graph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'type'</span><span class="tok-o">,</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-o">==&gt;</span><span class="tok-mi">3379</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Whenever you are finished working with the graph, it is a good idea to close it. Once
closed you will have to reconnect using one of the two <em>open</em> steps shown above before
you can start working with it again.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are reconnecting to your graph, having previously loaded some data and closed
it, you can use the following commands. If you are using Thrift instead of
CQL you would use the <em>janusgraph-cassandra.properties</em> file instead.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// Reconnect using CQL</span>
<span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-n">graph</span> <span class="tok-o">=</span> <span class="tok-n">JanusGraphFactory</span><span class="tok-o">.</span><span class="tok-na">open</span><span class="tok-o">(</span><span class="tok-s1">'conf/janusgraph-cql.properties'</span><span class="tok-o">)</span>

<span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-n">g</span> <span class="tok-o">=</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A common requirement when testing and experimenting is to throw everything away and
start again. The easiest way to do this is to use the command shown below. This will
remove all of your data, indexes and schema definitions so only do this if you really
want to start over.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-n">JanusGraphFactory</span><span class="tok-o">.</span><span class="tok-na">drop</span><span class="tok-o">(</span><span class="tok-n">graph</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Having done a <em>drop</em> operation, if you previously loaded the <em>air-routes</em> data using
the janus-cassandra.groovy script, you will need to run the script again to get the
data, indexes and schema back.</p>
</div>
<div class="paragraph">
<p>One other thing to realize is that using the techniques shown in this section we are
connecting the Gremlin Console and JanusGraph directly to Cassandra. This means that
we can issue commands directly from the Gremlin Console without needing to use any
additional configuration or setup steps other than telling JanusGraph how to connect
to Cassandra using a properties file. Later in the book we will introduce the Gremlin
Server that allows you to front end a graph with an HTTP server. Remember also that
JanusGraph is really a set of Java libraries (JAR files). It does not create any
processes of its own and does not run as a service. So in this instance JanusGraph is
running on the process of the Gremlin Console. Cassandra of course is running as a
standalone service.</p>
</div>
</div>
<div class="sect3">
<h4 id="nodetool">6.9.3. Finding nodetool</h4>
<div class="paragraph">
<p>If for any reason you need to check on Cassandra settings or overall status, you
typically use the <em>nodetool</em> command. Because in this case we are using a
containerized version of the Cassandra code, to run <em>nodetool</em> you need to start a
shell session inside the container. This can be done using the <em>docker exec</em> command
as shown below. Once you are inside the container you will find <em>nodetool</em> available
on the default path. The examples below show how to start a bash session and enter a
few <em>nodetool</em> commands. Finally we exit the session.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">sh&gt; docker exec -it cass bash</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the shell process has started the prompt will change and you are now running
inside the context of the container.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">root@115ed53ef189:/</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now enter <em>nodetool</em> commands. I have truncated the output a bit to aid
reading. First, let’s check the version of Cassandra we are running.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">root@115ed53ef189:/ nodetool version</span>

<span class="tok-go">ReleaseVersion: 3.11.1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s check to see that Thrift is running.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">root@115ed53ef189:/ nodetool statusthrift</span>

<span class="tok-go">running</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want more information about the overall state of things you can use the
<em>nodetool info</em> command. I have truncated this output.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">root@115ed53ef189:/ nodetool info</span>

<span class="tok-go">ID                     : 094e9a8c-99af-4d32-94da-49ed8c61b9fd</span>
<span class="tok-go">Gossip active          : true</span>
<span class="tok-go">Thrift active          : true</span>
<span class="tok-go">Native Transport active: true</span>
<span class="tok-go">Load                   : 3.64 MiB</span>
<span class="tok-go">Generation No          : 1517842270</span>
<span class="tok-go">Uptime (seconds)       : 2636</span>
<span class="tok-go">Heap Memory (MB)       : 102.43 / 1956.00</span>
<span class="tok-go">Off Heap Memory (MB)   : 0.03</span>
<span class="tok-go">Data Center            : datacenter1</span>
<span class="tok-go">Rack                   : rack1</span>
<span class="tok-go">Exceptions             : 0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once we are done with the container typing <em>exit</em> will return us to the Linux
terminal session we entered the container from.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">root@115ed53ef189:/ exit</span>

<span class="tok-go">sh&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="extindex">6.10. Using an external index with JanusGraph</h3>
<div class="paragraph">
<p>JanusGraph allows an external index to be created using a technology such as
ElasticSearch or Apache Solr. You would create such an index in cases where you need
to do more sophisticated pattern matching as part of a graph query. This topic is
currently a little beyond the main focus of this book which is to give a detailed
introduction to the Gremlin Query and Traversal language and some of the ways that
technology can be deployed. You can find a detailed explanation of how to create an
external index in the JanusGraph documentation which is located at the following
URLs: <a href="https://docs.janusgraph.org/latest/indexes.html" class="bare">https://docs.janusgraph.org/latest/indexes.html</a> and
<a href="https://docs.janusgraph.org/latest/index-backends.html" class="bare">https://docs.janusgraph.org/latest/index-backends.html</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="gremlinserver">7. INTRODUCING GREMLIN SERVER</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far in this book we have looked at a few different ways to setup a TinkerPop
enabled graph store. Initially we focussed on running a TinkerGraph or a JanusGraph
graph locally with the data kept in memory. We also looked at how to configure
Cassandra with JanusGraph  so that you could connect to it from the Gremlin Console.
As you will recall, Cassandra could be running locally or remotely but either way
successfully making the connection to it required knowing the specific details of the
back end configuration. This included knowing the IP addresses, ports and protocols
being used.</p>
</div>
<div class="paragraph">
<p>While this may be acceptable in scenarios where it is OK for the user of the graph to
have this level of insight and access into the back end there are many scenarios
where it is desirable to keep most of the implementation detail hidden and access
secured. This is where Gremlin Server comes in.</p>
</div>
<div class="paragraph">
<p>Gremlin Server, as its name suggests, offers a way of setting up access to a graph
that goes via a front end web server. In this way the user of the graph only has to
know the name or IP address of the Gremlin Server in order to communicate with a
graph. You can set Gremlin Server up on your local machine, which is useful for
testing but you can also use it to setup a graph on a remote server and allow users
to access it. Gremlin Server supports a number of different connection protocols and
methods. You can connect to it from a Gremlin console, from a command line using
<em>curl</em> commands or from an application. Gremlin Server has a second advantage over
allowing us to hide the graph implementation details. It allows people using
programming languages that do not yet have Apache TinkerPop language bindings to work
with a graph using simple HTTP protocols.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The official Apache TinkerPop documentation includes in depth coverage of
configuring and using Gremlin Server.
<a href="http://tinkerpop.apache.org/docs/current/reference/#gremlin-server" class="bare">http://tinkerpop.apache.org/docs/current/reference/#gremlin-server</a>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Gremlin Server offers a lot of valuable capabilities. In this section I am going to
explain how to take the JanusGraph backed by Cassandra that we built earlier and
expose it via Gremlin Server. There are many other useful ways that Gremlin Server
can be configured, deployed and used. If you plan to experiment further with Gremlin
Server I very much encourage you to read the official documentation.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When this book was first released, the majority of "real world" use cases
focussed on directly attached or even in memory graphs. As Apache TinkerPop has
evolved, it has become a lot more common to connect to a graph remotely via a Gremlin
Server.
</td>
</tr>
</tbody></table>
</div>
<div class="sect2">
<h3 id="serverconfig">7.1. Configuring Gremlin Server</h3>
<div class="paragraph">
<p>The Gremlin Server runtime is a separate download available from the Apache TinkerPop
Web site. However, if you are going to be using Gremlin Server in conjunction with
JanusGraph you should use the version of Gremlin Server that comes bundled as part of
the JanusGraph download. The JanusGraph version comes preconfigured to work more
easily with the JanusGraph runtimes and connect more easily to JanusGraph managed
back end stores like Cassandra. The simplest way to configure Gremlin Server is to
use the YAML and properties files that are delivered as part of the Gremlin Server or
JanusGraph downloads. Depending on your configuration, you may need to edit these
files.</p>
</div>
<div class="paragraph">
<p>The Apache TinkerPop documentation has detailed instructions and examples showing
different ways of configuring a Gremlin Server. In this section I am going to focus
on setting up a Gremlin Server that can front end the JanusGraph and Dockerized
Cassandra instance that we configured earlier.</p>
</div>
<div class="paragraph">
<p>If you look at the files that were installed on your machine when you unzipped the
JanusGraph download, you will find a path of <em>conf/gremlin-server</em>. Inside this
directory you will find a set of YAML and properties files that can be used to start
a Gremlin Server working with JanusGraph and a variety of different back end stores.</p>
</div>
<div class="paragraph">
<p>For the rest of this discussion I am going to use the <em>gremlin-server.yaml</em> file as
my starting point and make minor modifications to it.</p>
</div>
<div class="paragraph">
<p>The Gremlin Server by default is configured for a WebSockets connection and that is
how the Gremlin Console connects to it. Using WebSockets is the recommended approach
when possible as it allows for a long running full duplex connection. However, there
are still many use cases where supporting an HTTP connection is desirable. There is
also a third option that allows both WebSockets and HTTP connections. In the YAML
file that is used when starting a Gremlin Server you need to specify one of the
following.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">org.apache.tinkerpop.gremlin.server.channel.WebSocketChannelizer</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>The server will expect a WebSockets connection (this is the default).</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">org.apache.tinkerpop.gremlin.server.channel.HttpChannelizer</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>The server will expect an HTTP connection.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">org.apache.tinkerpop.gremlin.server.channel.WsAndHttpChannelizer</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>The server will accept both WebSockets and HTTP connections.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The first part of the <em>gremlin-server.yaml</em> file, modified to meet our needs is shown
below. I did not modify the parts of the file that are not shown but I encourage you
to look at the whole file and study the settings. For our current needs the defaults
are fine. However, in your environment the defaults may not meet your needs. The
TinkerPop documentation has detailed coverage of the settings and what they do.</p>
</div>
<div class="paragraph">
<p>OK so let’s look at the parts of the YAML file that are relevant to this experiment.
Note that I have chosen to use the <em>WsAndHttpChannelizer</em>. This is because I want to
allow both the Gremlin Console over WebSockets and other applications such as <em>curl</em>
and <em>Ruby</em> over HTTP to connect to my new Gremlin Server.</p>
</div>
<div class="paragraph">
<p>Notice also that the <em>janusgraph-cassandra-es.server.properties</em> file is specified in
the <em>graphs</em> section. This is a file that is provided as part of the JanusGraph
download. This is the file that Gremlin Server will use to connect to our JanusGraph
backed by Cassandra. Note that the <em>"-es"</em> in the properties file name refers to
Elasticsearch. As we did not configure an external index when we setup our
JanusGraph the lines referring to Elasticsearch inside the properties file should be
commented out.</p>
</div>
<div class="paragraph">
<p>The <em>scriptEvaluationTimeout</em> setting is important. It tells the Gremlin Server how
long to let a query run before terminating it. This essentially establishes the
maximum amount of time any query will be allowed to run, regardless of whether it has
completed or not. For this experiment the default setting of 30000 should be more
than adequate. The value represents the number of milliseconds allowed. If you want
to allow queries sent to the server to run for longer you can increase this value.
Just keep in mind that if you have multiple users using the same Gremlin Server you
may not want to allow someone to run a really complex query that might take a long
time to complete. As a side note, I have seen people increase this value to allow
queries to complete when in fact what they should have been doing is creating an
index in the graph to allow the query to run faster and hence take less time! If you
want to disable the timeout feature you can do that by specifying a timeout value of
0 (zero).</p>
</div>
<div class="listingblock">
<div class="title">gremlin-server.yaml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-nl">host:</span> <span class="tok-mf">0.0</span><span class="tok-o">.</span><span class="tok-mf">0.0</span>
<span class="tok-nl">port:</span> <span class="tok-mi">8182</span>
<span class="tok-nl">scriptEvaluationTimeout:</span> <span class="tok-mi">30000</span>
<span class="tok-nl">channelizer:</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">server</span><span class="tok-o">.</span><span class="tok-na">channel</span><span class="tok-o">.</span><span class="tok-na">WsAndHttpChannelizer</span>
<span class="tok-nl">graphs:</span> <span class="tok-o">{</span>
  <span class="tok-nl">graph:</span> <span class="tok-n">conf</span><span class="tok-s">/gremlin-server/</span><span class="tok-n">janusgraph</span><span class="tok-o">-</span><span class="tok-n">cassandra</span><span class="tok-o">-</span><span class="tok-n">es</span><span class="tok-o">-</span><span class="tok-n">server</span><span class="tok-o">.</span><span class="tok-na">properties</span>
<span class="tok-o">}</span>
<span class="tok-nl">plugins:</span>
  <span class="tok-o">-</span> <span class="tok-n">janusgraph</span><span class="tok-o">.</span><span class="tok-na">imports</span>
<span class="tok-nl">scriptEngines:</span> <span class="tok-o">{</span>
  <span class="tok-n">gremlin</span><span class="tok-o">-</span><span class="tok-nl">groovy:</span> <span class="tok-o">{</span>
    <span class="tok-nl">imports:</span> <span class="tok-o">[</span><span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">Math</span><span class="tok-o">],</span>
    <span class="tok-nl">staticImports:</span> <span class="tok-o">[</span><span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">Math</span><span class="tok-o">.</span><span class="tok-na">PI</span><span class="tok-o">],</span>
    <span class="tok-nl">scripts:</span> <span class="tok-o">[</span><span class="tok-n">scripts</span><span class="tok-o">/</span><span class="tok-n">empty</span><span class="tok-o">-</span><span class="tok-n">sample</span><span class="tok-o">.</span><span class="tok-na">groovy</span><span class="tok-o">]}}</span>

<span class="tok-err">#</span> <span class="tok-n">The</span> <span class="tok-n">rest</span> <span class="tok-n">of</span> <span class="tok-n">the</span> <span class="tok-n">file</span> <span class="tok-n">is</span> <span class="tok-n">not</span> <span class="tok-n">shown</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As well as the YAML file and the properties file, there is a third file that we need
to provide when starting a Gremlin Server. This file can contain Groovy code that
will be run when the server starts. For our purposes the default file is all we need.
These files should be placed in the <em>scripts</em> directory that is part of the standard
Gremlin Server or JanusGraph install. We will take a look at the default script in a
moment.</p>
</div>
<div class="paragraph">
<p>By default both Gremlin Server and JanusGraph include a Groovy script called
<code>empty-sample.groovy</code>. That name is a bit misleading as the file actually does some
interesting things. For our purposes the most useful thing that the script does is to
configure and make available to us in the Gremlin Console, the graph traversal
source, <em>g</em> object that hopefully by now you are very familiar with. This provides
you with a template for any other <em>global</em> variables that you may want to make
available to the user of the console connected to your Gremlin Server. The file also
configures some default log messages  that will be generated when the server starts
and stops. Note that you can add your own code to this script or replace it with your
own script entirely. You will find additional example scripts included as part of the
Gremlin Server download. These scripts do things such as create a TinkerGraph
instance and load some graph data as part of the server startup process. Using this
technique, we could easily add a line to the script so that when the server starts an
empty TinkerGraph is created and the <em>air-routes</em> data loaded.</p>
</div>
<div class="listingblock">
<div class="title">empty-sample.groovy</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-c1">// an init script that returns a Map allows explicit setting of global bindings.</span>
<span class="tok-kt">def</span> <span class="tok-n">globals</span> <span class="tok-o">=</span> <span class="tok-o">[:]</span>

<span class="tok-c1">// defines a sample LifeCycleHook that prints some output to the Gremlin Server console.</span>
<span class="tok-c1">// note that the name of the key in the "global" map is unimportant.</span>
<span class="tok-n">globals</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-o">[</span><span class="tok-n">hook</span> <span class="tok-o">:</span> <span class="tok-o">[</span>
        <span class="tok-nl">onStartUp:</span> <span class="tok-o">{</span> <span class="tok-n">ctx</span> <span class="tok-o">-&gt;</span>
            <span class="tok-n">ctx</span><span class="tok-o">.</span><span class="tok-na">logger</span><span class="tok-o">.</span><span class="tok-na">info</span><span class="tok-o">(</span><span class="tok-s2">"Executed once at startup of Gremlin Server."</span><span class="tok-o">)</span>
        <span class="tok-o">},</span>
        <span class="tok-nl">onShutDown:</span> <span class="tok-o">{</span> <span class="tok-n">ctx</span> <span class="tok-o">-&gt;</span>
            <span class="tok-n">ctx</span><span class="tok-o">.</span><span class="tok-na">logger</span><span class="tok-o">.</span><span class="tok-na">info</span><span class="tok-o">(</span><span class="tok-s2">"Executed once at shutdown of Gremlin Server."</span><span class="tok-o">)</span>
        <span class="tok-o">}</span>
<span class="tok-o">]</span> <span class="tok-k">as</span> <span class="tok-n">LifeCycleHook</span><span class="tok-o">]</span>

<span class="tok-c1">// define the default TraversalSource to bind queries to - this one will be named "g".</span>
<span class="tok-n">globals</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-o">[</span><span class="tok-n">g</span> <span class="tok-o">:</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">()]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have all of our configuration files in place we can start the Gremlin
Server by typing the following command into a terminal window. The
<em>gremlin-server.sh</em> file is located in the <em>bin</em> directory of your Gremlin Server or
JanusGraph installation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">sh&gt; gremlin-server.sh conf/gremlin-server/gremlin-server.yaml</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If all goes well you should see output from the Gremlin Server displayed. The server
will keep running until you kill it. In this case a simple CTRL-C is all you need to
do to kill the server. After you press CTRL-C the server will do a bit of cleaning
up.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can use the <em>start</em> keyword to start the Gremlin Server as a background
task.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>You can also start the Gremlin Server in the background rather than have it take over
your current terminal window by adding the <em>start</em> keyword as part of the invocation
command as shown below. The examples below assume that you are starting the server
from the place where you installed the Gremlin Server zip file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">sh&gt; bin/gremlin-server.sh start</span>

<span class="tok-go">Server started 25897</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By default the configuration information for the server being started will be looked
for in the file <code>conf/gremlin-server.yaml</code>. If you want to override this value you
need to provide an environment variable called <em>GREMLIN_YAML</em> before starting the
server as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">sh&gt; export GREMLIN_YAML='conf/mysettings.yaml'</span>
<span class="tok-go">sh&gt; bin/gremlin-server.sh start</span>

<span class="tok-go">Server started 25897</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As an alternative to defining an environment variable, you can instead create a file
called <code>bin/gremlin-server.conf</code> and put the name of your YAML file in it. An example
is shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">GREMLIN_YAML='conf/mysettings.yaml'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to check whether or not the Gremlin Server is currently running you can
use the <em>status</em> keyword.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">sh&gt; bin/gremlin-server.sh status</span>

<span class="tok-go">Server running with PID 25897</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To stop the server you can use the <em>stop</em> keyword as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">sh&gt; bin/gremlin-server.sh stop</span>

<span class="tok-go">Server stopped [25897]</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="serverconsole">7.2. Connecting to a Gremlin Server from the Gremlin Console</h3>
<div class="paragraph">
<p>It is fairly straightforward to connect to a running Gremlin Server from a Gremlin
Console. In this case it should not matter whether you are using the Gremlin Console
that is part of the Apache TinkerPop download or the one that comes as part of the
JanusGraph download. This is because the Gremlin Server very nicely hides the back
end implementation details from us. As far as we are concerned it is just an HTTP or
WebSockets endpoint that can handle Gremlin queries.</p>
</div>
<div class="paragraph">
<p>There is one exception, that I am currently aware of, to my statement about not
needing to worry about server side implementation details. This exception is a result
of potential version mismatches. Typically, the TinkerPop download, assuming you have
the very latest, will be at least a few minor point releases ahead of any given graph
store release. This is purely because whenever TinkerPop has a release, it takes a
bit of time for the GraphDB maintainers to catch up. I will give a concrete example
of this in a moment.</p>
</div>
<div class="paragraph">
<p>As with Gremlin Server, YAML files can be used to configure a remote connection from
the Gremlin Console. The Gremlin Console as well as the version that comes bundled
with JanusGraph includes a set of YAML files that can be used as-is or edited as
needed. In order to connect the Gremlin Console to the Gremlin Server that we just
configured, the file <em>remote.yaml</em> can be used. I had to make one change, as shown
below. I commented out the <em>serializer</em> line and replaced it with a slightly modified
version. I had to do this because of the version issues I mentioned above. At time of
writing, JanusGraph supports version V1d0 of the GyroMessageSerializer that is used
as the communication serialization protocol between the Gremlin Console and the
Gremlin Server. However, my Gremlin Console was pre configured with the newer version
V3d0 of the serializer. It is essential that the console and the server be using the
same version. If I did not make this change, the Gremlin Console and the Gremlin
Server would not be able to correctly communicate. Note that in <em>remote.yaml</em> file we
also specify the name and port of the Gremlin Server host that we will be connecting
to. As we are running everything locally the default host name of <em>localhost</em> is
fine. If you are connecting to a remote Gremlin Server the <em>hosts</em> value needs to be
edited to correctly identify name or IP address of the server where the Gremlin
Server is running. Also we can use the default port of 8182. By default a Gremlin
Server listens on port 8182. The only reason you would need to change this value is
if you are connecting to a Gremlin Server using a different port.</p>
</div>
<div class="listingblock">
<div class="title">remote.yaml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-nl">hosts:</span> <span class="tok-o">[</span><span class="tok-n">localhost</span><span class="tok-o">]</span>
<span class="tok-nl">port:</span> <span class="tok-mi">8182</span>
<span class="tok-err">#</span><span class="tok-nl">serializer:</span> <span class="tok-o">{</span> <span class="tok-nl">className:</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">driver</span><span class="tok-o">.</span><span class="tok-na">ser</span><span class="tok-o">.</span><span class="tok-na">GryoMessageSerializerV3d0</span><span class="tok-o">,</span> <span class="tok-nl">config:</span> <span class="tok-o">{</span> <span class="tok-nl">serializeResultToString:</span> <span class="tok-kc">true</span> <span class="tok-o">}}</span>
<span class="tok-nl">serializer:</span> <span class="tok-o">{</span> <span class="tok-nl">className:</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">driver</span><span class="tok-o">.</span><span class="tok-na">ser</span><span class="tok-o">.</span><span class="tok-na">GryoMessageSerializerV1d0</span><span class="tok-o">,</span> <span class="tok-nl">config:</span> <span class="tok-o">{</span> <span class="tok-nl">serializeResultToString:</span> <span class="tok-kc">true</span> <span class="tok-o">}}</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="remoteconn">7.2.1. Making the remote connection</h4>
<div class="paragraph">
<p>Now that we have our YAML file ready, all that we have to do to establish a
connection between our Gremlin Console and the Gremlin Server is to issue the
following command once the console is running.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">gremlin&gt; :remote connect tinkerpop.server conf/remote.yaml</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we are connected to the Gremlin Server we can issue some Gremlin commands.
Given that the <em>air-routes</em> graph is already loaded into our remote graph we can
immediately start to issue some queries. In order to make sure the query goes to the
remote graph, the query needs to be prefixed with <em>":&gt;"</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-o">:&gt;</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-o">==&gt;</span><span class="tok-mi">3624</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="resultvar">7.2.2. The Gremlin Console’s <em>result</em> variable</h4>
<div class="paragraph">
<p>When working within the Gremlin console, one other useful thing to be aware of is
that the results of queries sent to a server, when the console is in <em>"local mode"</em>,
as well as being displayed are stored in a variable called <em>result</em>. Take a look at
the query below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-o">:&gt;</span>  <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'continent'</span><span class="tok-o">).</span><span class="tok-na">group</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'desc'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">())</span>

<span class="tok-o">==&gt;{</span><span class="tok-n">South</span> <span class="tok-n">America</span><span class="tok-o">=</span><span class="tok-mi">305</span><span class="tok-o">,</span> <span class="tok-n">Asia</span><span class="tok-o">=</span><span class="tok-mi">941</span><span class="tok-o">,</span> <span class="tok-n">Europe</span><span class="tok-o">=</span><span class="tok-mi">596</span><span class="tok-o">,</span> <span class="tok-n">Africa</span><span class="tok-o">=</span><span class="tok-mi">298</span><span class="tok-o">,</span> <span class="tok-n">Antarctica</span><span class="tok-o">=</span><span class="tok-mi">0</span><span class="tok-o">,</span> <span class="tok-n">North</span> <span class="tok-n">America</span><span class="tok-o">=</span><span class="tok-mi">981</span><span class="tok-o">,</span> <span class="tok-n">Oceania</span><span class="tok-o">=</span><span class="tok-mi">287</span><span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we were to print the contents of the <em>result</em> variable we would find it contains
the results from the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-n">println</span> <span class="tok-n">result</span>

<span class="tok-o">[</span><span class="tok-n">result</span><span class="tok-o">{</span><span class="tok-n">object</span><span class="tok-o">={</span><span class="tok-n">South</span> <span class="tok-n">America</span><span class="tok-o">=</span><span class="tok-mi">305</span><span class="tok-o">,</span> <span class="tok-n">Asia</span><span class="tok-o">=</span><span class="tok-mi">941</span><span class="tok-o">,</span> <span class="tok-n">Europe</span><span class="tok-o">=</span><span class="tok-mi">596</span><span class="tok-o">,</span> <span class="tok-n">Africa</span><span class="tok-o">=</span><span class="tok-mi">298</span><span class="tok-o">,</span> <span class="tok-n">Antarctica</span><span class="tok-o">=</span><span class="tok-mi">0</span><span class="tok-o">,</span> <span class="tok-n">North</span> <span class="tok-n">America</span><span class="tok-o">=</span><span class="tok-mi">981</span><span class="tok-o">,</span> <span class="tok-n">Oceania</span><span class="tok-o">=</span><span class="tok-mi">287</span><span class="tok-o">}</span> <span class="tok-n">class</span><span class="tok-o">=</span><span class="tok-n">java</span><span class="tok-o">.</span><span class="tok-na">lang</span><span class="tok-o">.</span><span class="tok-na">String</span><span class="tok-o">}]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As the console is still in local mode we can use some inline Groovy code to post
process, in this case  pretty print, the contents of <em>result</em>. This capability is
worth keeping in mind. There are some interesting things it allows you to do such as
easily post processing results and saving them to a file locally when working with a
remote server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">x</span> <span class="tok-k">in</span> <span class="tok-n">result</span><span class="tok-o">[</span><span class="tok-s1">'object'</span><span class="tok-o">][</span><span class="tok-mi">0</span><span class="tok-o">][</span><span class="tok-mi">1</span><span class="tok-o">..-</span><span class="tok-mi">2</span><span class="tok-o">].</span><span class="tok-na">split</span><span class="tok-o">(</span><span class="tok-s1">', '</span><span class="tok-o">))</span> <span class="tok-n">println</span> <span class="tok-n">x</span>

<span class="tok-n">South</span> <span class="tok-n">America</span><span class="tok-o">=</span><span class="tok-mi">305</span>
<span class="tok-n">Asia</span><span class="tok-o">=</span><span class="tok-mi">941</span>
<span class="tok-n">Europe</span><span class="tok-o">=</span><span class="tok-mi">596</span>
<span class="tok-n">Africa</span><span class="tok-o">=</span><span class="tok-mi">298</span>
<span class="tok-n">Antarctica</span><span class="tok-o">=</span><span class="tok-mi">0</span>
<span class="tok-n">North</span> <span class="tok-n">America</span><span class="tok-o">=</span><span class="tok-mi">981</span>
<span class="tok-n">Oceania</span><span class="tok-o">=</span><span class="tok-mi">287</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="remotemode">7.2.3. Working in remote mode</h4>
<div class="paragraph">
<p>As useful as keeping the console in <em>"local mode"</em> can be, if you are going to be
issuing a lot of queries to the remote graph, I find it more convenient to put the
console into <em>"remote mode"</em>. This can be done as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">gremlin&gt; :remote console</span>

<span class="tok-go">All scripts will now be sent to Gremlin Server - [localhost/127.0.0.1:8182] - type ':remote console' to return to local mode</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The console is now in <em>"remote mode"</em>. All queries that you enter will be sent to the
Gremlin Server and there is no need to use the <em>":&gt;"</em> prefix.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-o">==&gt;</span><span class="tok-mi">3624</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>One thing to notice is that the output that comes back from a Gremlin Server looks a
little different at times from when you use the commands using the Gremlin Console
attached to a local TinkerGraph. This is because Gremlin Console essentially does a
<em>toString()</em> on the output before it is shown to the user in these cases.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">()</span>

<span class="tok-o">==&gt;{</span><span class="tok-n">country</span><span class="tok-o">=[</span><span class="tok-n">US</span><span class="tok-o">],</span> <span class="tok-n">code</span><span class="tok-o">=[</span><span class="tok-n">AUS</span><span class="tok-o">],</span> <span class="tok-n">longest</span><span class="tok-o">=[</span><span class="tok-mi">12250</span><span class="tok-o">],</span> <span class="tok-n">city</span><span class="tok-o">=[</span><span class="tok-n">Austin</span><span class="tok-o">],</span> <span class="tok-n">elev</span><span class="tok-o">=[</span><span class="tok-mi">542</span><span class="tok-o">],</span> <span class="tok-n">icao</span><span class="tok-o">=[</span><span class="tok-n">KAUS</span><span class="tok-o">],</span> <span class="tok-n">lon</span><span class="tok-o">=[-</span><span class="tok-mf">97.6698989868164</span><span class="tok-o">],</span> <span class="tok-n">type</span><span class="tok-o">=[</span><span class="tok-n">airport</span><span class="tok-o">],</span> <span class="tok-n">region</span><span class="tok-o">=[</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span><span class="tok-o">],</span> <span class="tok-n">runways</span><span class="tok-o">=[</span><span class="tok-mi">2</span><span class="tok-o">],</span> <span class="tok-n">lat</span><span class="tok-o">=[</span><span class="tok-mf">30.1944999694824</span><span class="tok-o">],</span> <span class="tok-n">desc</span><span class="tok-o">=[</span><span class="tok-n">Austin</span> <span class="tok-n">Bergstrom</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span><span class="tok-o">]}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As an example of the slight differences in the output format, below you will find the
results from the same query when the graph was running as a local, in memory,
TinkerGraph.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-nl">country:</span><span class="tok-o">[</span><span class="tok-n">US</span><span class="tok-o">],</span><span class="tok-nl">code:</span><span class="tok-o">[</span><span class="tok-n">AUS</span><span class="tok-o">],</span><span class="tok-nl">longest:</span><span class="tok-o">[</span><span class="tok-mi">12250</span><span class="tok-o">],</span><span class="tok-nl">city:</span><span class="tok-o">[</span><span class="tok-n">Austin</span><span class="tok-o">],</span><span class="tok-nl">elev:</span><span class="tok-o">[</span><span class="tok-mi">542</span><span class="tok-o">],</span><span class="tok-nl">icao:</span><span class="tok-o">[</span><span class="tok-n">KAUS</span><span class="tok-o">],</span><span class="tok-nl">lon:</span><span class="tok-o">[-</span><span class="tok-mf">97.6698989868164</span><span class="tok-o">],</span><span class="tok-nl">type:</span><span class="tok-o">[</span><span class="tok-n">airport</span><span class="tok-o">],</span><span class="tok-nl">region:</span><span class="tok-o">[</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">TX</span><span class="tok-o">],</span><span class="tok-nl">runways:</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">],</span><span class="tok-nl">lat:</span><span class="tok-o">[</span><span class="tok-mf">30.1944999694824</span><span class="tok-o">],</span><span class="tok-nl">desc:</span><span class="tok-o">[</span><span class="tok-n">Austin</span> <span class="tok-n">Bergstrom</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span><span class="tok-o">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you are done sending all commands to the Gremlin Server you can switch out of
that mode as follows. Commands will now be sent to your local console. This means
that you can work with a local and remote graph at the same time. The <em>:remote
console</em> command is therefore a toggle. Each time you use the command the console
will switch between local mode and remote mode or vice versa.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">gremlin&gt; :remote console</span>

<span class="tok-go">==&gt;All scripts will now be evaluated locally - type ':remote console' to return to</span>
<span class="tok-go">remote mode for Gremlin Server - [localhost/127.0.0.1:8182]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are completely done with the remote connection for this console session you can
truly close it as follows. Having done this you will need to reestablish the
connection before the <em>:remote console</em> will work again.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">gremlin&gt; :remote close</span>

<span class="tok-go">==&gt;Removed - Gremlin Server - [localhost/127.0.0.1:8182]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="servercli">7.3. Connecting to a Gremlin Server from the command line</h3>
<div class="paragraph">
<p>Now that we have a Gremlin Server up and running that supports both HTTP and Web
Sockets connections, we can, if we wish, communicate with it using nothing more than
a <em>curl</em> command. The <em>curl</em> command below uses an HTTP GET to send a query to our
Gremlin Server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">sh&gt; curl "http://localhost:8182?gremlin=g.V().has('code','AUS').valueMap()"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In response to the HTTP GET request the server sends back the result packaged as JSON
as follows. I have formatted the output in a way that makes it easier to read. What
was actually returned did not have any line breaks in it at all and was quite hard to
read..</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"a8ad654a-a5a3-4bb9-8474-69aca3c3db1e"</span><span class="tok-o">,</span>
 <span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span>
 <span class="tok-s2">"result"</span><span class="tok-o">:{</span><span class="tok-s2">"data"</span><span class="tok-o">:[{</span><span class="tok-s2">"country"</span><span class="tok-o">:[</span><span class="tok-s2">"US"</span><span class="tok-o">],</span>
                       <span class="tok-s2">"code"</span><span class="tok-o">:[</span><span class="tok-s2">"AUS"</span><span class="tok-o">],</span>
                    <span class="tok-s2">"longest"</span><span class="tok-o">:[</span><span class="tok-mi">12250</span><span class="tok-o">],</span>
                       <span class="tok-s2">"city"</span><span class="tok-o">:[</span><span class="tok-s2">"Austin"</span><span class="tok-o">],</span>
                       <span class="tok-s2">"elev"</span><span class="tok-o">:[</span><span class="tok-mi">542</span><span class="tok-o">],</span>
                       <span class="tok-s2">"icao"</span><span class="tok-o">:[</span><span class="tok-s2">"KAUS"</span><span class="tok-o">],</span>
                        <span class="tok-s2">"lon"</span><span class="tok-o">:[-</span><span class="tok-mf">97.6698989868164</span><span class="tok-o">],</span>
                       <span class="tok-s2">"type"</span><span class="tok-o">:[</span><span class="tok-s2">"airport"</span><span class="tok-o">],</span>
                     <span class="tok-s2">"region"</span><span class="tok-o">:[</span><span class="tok-s2">"US-TX"</span><span class="tok-o">],</span>
                    <span class="tok-s2">"runways"</span><span class="tok-o">:[</span><span class="tok-mi">2</span><span class="tok-o">],</span>
                        <span class="tok-s2">"lat"</span><span class="tok-o">:[</span><span class="tok-mf">30.1944999694824</span><span class="tok-o">],</span>
                       <span class="tok-s2">"desc"</span><span class="tok-o">:[</span><span class="tok-s2">"Austin Bergstrom International Airport"</span><span class="tok-o">]}],</span>
           <span class="tok-s2">"meta"</span><span class="tok-o">:{}}}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example shows how to send the same query, but with the <em>valueMap</em> step
removed, using an HTTP POST. The Apache TinkerPop documentation states that using
POST is the recommended way to send queries over HTTP to a Gremlin Server. Note how
in this case we are sending the query packaged as JSON and that we have to escape the
quote characters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-go">sh&gt; curl -X POST -d "{\"gremlin\":\"g.V().has('code','AUS')\"}" \</span>
<span class="tok-go">            "http://localhost:8182"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As with the prior query, the HTTP POST form of the query also returns the result
packaged as JSON. However, in this case, because I left off the <em>valueMap</em> step, the
JSON includes additional information in the form of the ID values and labels for the
vertex and its properties. This is because the result represents a vertex this time
rather than a map. I have again formatted the output in a way that is easier
to read.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"64c757b8-27a6-4509-a54c-ea35ba517667"</span><span class="tok-o">,</span>
 <span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span>
 <span class="tok-s2">"result"</span><span class="tok-o">:{</span>
   <span class="tok-s2">"data"</span><span class="tok-o">:[</span>
     <span class="tok-o">{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-mi">12352</span><span class="tok-o">,</span>
      <span class="tok-s2">"label"</span><span class="tok-o">:</span><span class="tok-s2">"airport"</span><span class="tok-o">,</span>
      <span class="tok-s2">"type"</span><span class="tok-o">:</span><span class="tok-s2">"vertex"</span><span class="tok-o">,</span>
      <span class="tok-s2">"properties"</span><span class="tok-o">:</span>
        <span class="tok-o">{</span><span class="tok-s2">"country"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"8p4-9j4-8p1"</span><span class="tok-o">,</span> <span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"US"</span><span class="tok-o">}],</span>
            <span class="tok-s2">"code"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"93c-9j4-5j9"</span><span class="tok-o">,</span> <span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"AUS"</span><span class="tok-o">}],</span>
         <span class="tok-s2">"longest"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"9hk-9j4-mx1"</span><span class="tok-o">,</span> <span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-mi">12250</span><span class="tok-o">}],</span>
            <span class="tok-s2">"city"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"9vs-9j4-7wl"</span><span class="tok-o">,</span> <span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"Austin"</span><span class="tok-o">}],</span>
            <span class="tok-s2">"elev"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"aa0-9j4-but"</span><span class="tok-o">,</span> <span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-mi">542</span><span class="tok-o">}],</span>
            <span class="tok-s2">"icao"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"ao8-9j4-6bp"</span><span class="tok-o">,</span> <span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"KAUS"</span><span class="tok-o">}],</span>
             <span class="tok-s2">"lon"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"b2g-9j4-dfp"</span><span class="tok-o">,</span> <span class="tok-s2">"value"</span><span class="tok-o">:-</span><span class="tok-mf">97.6698989868164</span><span class="tok-o">}],</span>
            <span class="tok-s2">"type"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"bgo-9j4-745"</span><span class="tok-o">,</span> <span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"airport"</span><span class="tok-o">}],</span>
          <span class="tok-s2">"region"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"buw-9j4-9hh"</span><span class="tok-o">,</span> <span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"US-TX"</span><span class="tok-o">}],</span>
         <span class="tok-s2">"runways"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"c94-9j4-b2d"</span><span class="tok-o">,</span> <span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-mi">2</span><span class="tok-o">}],</span>
             <span class="tok-s2">"lat"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"cnc-9j4-cn9"</span><span class="tok-o">,</span> <span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-mf">30.1944999694824</span><span class="tok-o">}],</span>
            <span class="tok-s2">"desc"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"d1k-9j4-a9x"</span><span class="tok-o">,</span>
                  <span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"Austin Bergstrom International Airport"</span><span class="tok-o">}]}}],</span>
            <span class="tok-s2">"meta"</span><span class="tok-o">:{}}}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I have included examples of the different types of JSON result that you are likely to
have to process in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#serverjson">More examples of the JSON returned from a Gremlin Server</a>" section that is coming up soon.</p>
</div>
</div>
<div class="sect2">
<h3 id="javagsclient">7.4. Connecting to a Gremlin Server from Java using <em>withRemote</em></h3>
<div class="paragraph">
<p>While it is perfectly possible to work directly with the JSON returned from a Gremlin
Server it is often more desirable to have the results placed directly into variables
of the appropriate type. If the appropriate Grelmin language driver exists for the
programming language that you are using, this is quite easy to setup. In this section
we will look at connecting to a Gremlin Server from a Java application and taking
advantage of the <em>withRemote</em> capability that TinkerPop provides.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The source code for the example shown in this section comes from the
<em>RemoteClient.java</em> sample located at
<a href="https://github.com/krlawrence/graph/tree/master/sample-code" class="bare">https://github.com/krlawrence/graph/tree/master/sample-code</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Let’s look at the small application in sections. First of all it is necessary to
import the required classes that we will need to make the connection to the server
and retrieve the query results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kn">import</span> <span class="tok-nn">org.apache.tinkerpop.gremlin.driver.Cluster</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.tinkerpop.gremlin.process.traversal.dsl.graph.GraphTraversalSource</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.tinkerpop.gremlin.structure.util.empty.EmptyGraph</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.tinkerpop.gremlin.driver.remote.DriverRemoteConnection</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">org.apache.tinkerpop.gremlin.driver.ser.GryoMessageSerializerV1d0</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.Map</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.List</span><span class="tok-o">;</span>
<span class="tok-kn">import</span> <span class="tok-nn">java.util.ArrayList</span><span class="tok-o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now define a small Java class that we will call <em>RemoteClient</em> and setup the
connection to the Gremlin Server. This is done by first of all creating a
<em>Cluster.Builder</em> instance that will be used to describe the server we are connecting
to and the protocol we want to use. It is important that these settings match what
the Gremlin Server is configured to use. For this simple example we are just using
<em>localhost</em> as the host name but the name of any Gremlin Server that you have access
to can be used instead. The default Gremlin Server port of <em>8182</em> is specified and the
<em>GyroMessageServializerV1d0</em> serialization format is selected. Again, this needs to
match both the protocol and the version of the protocol that your Gremlin Server is
supporting.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">RemoteClient</span>
<span class="tok-o">{</span>
  <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">main</span><span class="tok-o">(</span> <span class="tok-n">String</span><span class="tok-o">[]</span> <span class="tok-n">args</span> <span class="tok-o">)</span>
  <span class="tok-o">{</span>
    <span class="tok-n">Cluster</span><span class="tok-o">.</span><span class="tok-na">Builder</span> <span class="tok-n">builder</span> <span class="tok-o">=</span> <span class="tok-n">Cluster</span><span class="tok-o">.</span><span class="tok-na">build</span><span class="tok-o">();</span>
    <span class="tok-n">builder</span><span class="tok-o">.</span><span class="tok-na">addContactPoint</span><span class="tok-o">(</span><span class="tok-s2">"localhost"</span><span class="tok-o">);</span>
    <span class="tok-n">builder</span><span class="tok-o">.</span><span class="tok-na">port</span><span class="tok-o">(</span><span class="tok-mi">8182</span><span class="tok-o">);</span>
    <span class="tok-n">builder</span><span class="tok-o">.</span><span class="tok-na">serializer</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-n">GryoMessageSerializerV1d0</span><span class="tok-o">());</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the Cluster.Builder instance has been setup we can use it to create our
<em>Cluster</em> instance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">    <span class="tok-n">Cluster</span> <span class="tok-n">cluster</span> <span class="tok-o">=</span> <span class="tok-n">builder</span><span class="tok-o">.</span><span class="tok-na">create</span><span class="tok-o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lastly, we need to setup a GraphTraversalSource object for the Gremlin Server hosted
graph that we will be working with. The TinkerPop documentation recommends that an
instance of an <em>EmptyGraph</em> is used when creating the traversal. Having done that,
the <em>withRemote</em> method can be called to establish the remote connection. Note that
the cluster instance that we just created is passed in as a parameter. While this
looks a little complicated it is really not a lot different than when we connect to a
local graph using the Gremlin Console. The only difference is that by setting up the
remote connection this way, when we start to issue queries against the graph, rather
than getting JSON objects back, the results will automatically be serialized into
Java variables for us. This makes our code a lot easier to write and essentially is
the same code from this point onwards that would also work with a local graph that we
are directly connected to.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">    <span class="tok-n">GraphTraversalSource</span> <span class="tok-n">g</span> <span class="tok-o">=</span>
      <span class="tok-n">EmptyGraph</span><span class="tok-o">.</span><span class="tok-na">instance</span><span class="tok-o">().</span><span class="tok-na">traversal</span><span class="tok-o">().</span>
        <span class="tok-n">withRemote</span><span class="tok-o">(</span><span class="tok-n">DriverRemoteConnection</span><span class="tok-o">.</span><span class="tok-na">using</span><span class="tok-o">(</span><span class="tok-n">cluster</span><span class="tok-o">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now use our new graph traversal source object to issue a Gremlin query. The
results will be placed directly into the <em>List</em> called <em>vmaps</em>. The query finds the
first 10 airports with a region code of <em>GB-ENG</em> which is short for Great Britain
- England.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy">    <span class="tok-n">List</span> <span class="tok-o">&lt;</span><span class="tok-n">Map</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">,</span><span class="tok-n">Object</span><span class="tok-o">&gt;&gt;</span> <span class="tok-n">vmaps</span> <span class="tok-o">=</span>
      <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s2">"airport"</span><span class="tok-o">,</span><span class="tok-s2">"region"</span><span class="tok-o">,</span><span class="tok-s2">"GB-ENG"</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">10</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">().</span><span class="tok-na">toList</span><span class="tok-o">();</span>

    <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-s2">"\n\nThe following airports were found\n"</span><span class="tok-o">);</span>
    <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Map</span> <span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">,</span><span class="tok-n">Object</span><span class="tok-o">&gt;</span> <span class="tok-n">m</span> <span class="tok-o">:</span> <span class="tok-n">vmaps</span><span class="tok-o">)</span>
    <span class="tok-o">{</span>
      <span class="tok-n">ArrayList</span> <span class="tok-n">code</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">ArrayList</span><span class="tok-o">)</span> <span class="tok-n">m</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s2">"code"</span><span class="tok-o">);</span>
      <span class="tok-n">ArrayList</span> <span class="tok-n">desc</span> <span class="tok-o">=</span> <span class="tok-o">(</span><span class="tok-n">ArrayList</span><span class="tok-o">)</span> <span class="tok-n">m</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s2">"desc"</span><span class="tok-o">);</span>
      <span class="tok-n">System</span><span class="tok-o">.</span><span class="tok-na">out</span><span class="tok-o">.</span><span class="tok-na">println</span><span class="tok-o">(</span><span class="tok-n">code</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">)</span> <span class="tok-o">+</span> <span class="tok-s2">" , "</span> <span class="tok-o">+</span> <span class="tok-n">desc</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">));</span>
    <span class="tok-o">}</span>

    <span class="tok-n">cluster</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When the Java application is compiled and run the output should look similar to that
shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">LEQ</span> <span class="tok-o">,</span> <span class="tok-n">Land</span><span class="tok-err">'</span><span class="tok-n">s</span> <span class="tok-n">End</span> <span class="tok-n">Airport</span>
<span class="tok-n">LGW</span> <span class="tok-o">,</span> <span class="tok-n">London</span> <span class="tok-n">Gatwick</span>
<span class="tok-n">MAN</span> <span class="tok-o">,</span> <span class="tok-n">Manchester</span> <span class="tok-n">Airport</span>
<span class="tok-n">LHR</span> <span class="tok-o">,</span> <span class="tok-n">London</span> <span class="tok-n">Heathrow</span>
<span class="tok-n">LCY</span> <span class="tok-o">,</span> <span class="tok-n">London</span> <span class="tok-n">City</span> <span class="tok-n">Airport</span>
<span class="tok-n">STN</span> <span class="tok-o">,</span> <span class="tok-n">London</span> <span class="tok-n">Stansted</span> <span class="tok-n">Airport</span>
<span class="tok-n">EMA</span> <span class="tok-o">,</span> <span class="tok-n">East</span> <span class="tok-n">Midlands</span> <span class="tok-n">Airport</span>
<span class="tok-n">LPL</span> <span class="tok-o">,</span> <span class="tok-n">Liverpool</span> <span class="tok-n">John</span> <span class="tok-n">Lennon</span> <span class="tok-n">Airport</span>
<span class="tok-n">LBA</span> <span class="tok-o">,</span> <span class="tok-n">Leeds</span> <span class="tok-n">Bradford</span> <span class="tok-n">Airport</span>
<span class="tok-n">NCL</span> <span class="tok-o">,</span> <span class="tok-n">Newcastle</span> <span class="tok-n">Airport</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="rubyclient">7.5. Connecting to a Gremlin Server from Ruby</h3>
<div class="paragraph">
<p>As far as I know, at time of writing, there is currently no formal Gremlin language
binding support available for Ruby programmers. This is therefore a perfect use case
to show how, using a small amount of code, a Ruby programmer can connect to a Gremlin
Server and issue Gremlin Queries.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The source code for the Ruby example, <em>gremlin-client-http.rb</em>, as shown below,
is available in the sample-code folder.
<a href="https://github.com/krlawrence/graph/tree/master/sample-code" class="bare">https://github.com/krlawrence/graph/tree/master/sample-code</a>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The code below represents a complete, standalone Ruby application. It uses the
standard Ruby libraries. No additional Ruby Gems or third party libraries should be
required. The example as shown connects to a Gremlin Server running on your local
machine. It packages up an HTTP POST request and sends it to the Gremlin Server. The
body of the HTTP request is encoded as JSON.</p>
</div>
<div class="listingblock">
<div class="title">gremlin-client-http.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><table class="pyhltable"><tbody><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</div></td><td class="code"><span class="tok-c1"># Simple example of how you can connect to a Gremlin Server and</span>
<span class="tok-c1"># issue queries from a Ruby application.</span>

<span class="tok-nb">require</span> <span class="tok-s1">'net/http'</span>
<span class="tok-nb">require</span> <span class="tok-s1">'uri'</span>
<span class="tok-nb">require</span> <span class="tok-s1">'json'</span>

<span class="tok-n">uri</span> <span class="tok-o">=</span> <span class="tok-no">URI</span><span class="tok-o">.</span><span class="tok-n">parse</span><span class="tok-p">(</span><span class="tok-s2">"http://localhost:8182"</span><span class="tok-p">)</span>

<span class="tok-n">request</span> <span class="tok-o">=</span> <span class="tok-no">Net</span><span class="tok-o">::</span><span class="tok-no">HTTP</span><span class="tok-o">::</span><span class="tok-no">Post</span><span class="tok-o">.</span><span class="tok-n">new</span><span class="tok-p">(</span><span class="tok-n">uri</span><span class="tok-p">)</span>
<span class="tok-n">req_options</span> <span class="tok-o">=</span> <span class="tok-p">{</span> <span class="tok-ss">use_ssl</span><span class="tok-p">:</span> <span class="tok-n">uri</span><span class="tok-o">.</span><span class="tok-n">scheme</span> <span class="tok-o">==</span> <span class="tok-s2">"https"</span><span class="tok-p">,</span> <span class="tok-p">}</span>

<span class="tok-n">query</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s2">"gremlin"</span> <span class="tok-o">=&gt;</span> <span class="tok-s2">"g.V().has('code','AUS').out().count()"</span><span class="tok-p">}</span>
<span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">body</span> <span class="tok-o">=</span> <span class="tok-no">JSON</span><span class="tok-o">.</span><span class="tok-n">dump</span><span class="tok-p">(</span><span class="tok-n">query</span><span class="tok-p">)</span>

<span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-no">Net</span><span class="tok-o">::</span><span class="tok-no">HTTP</span><span class="tok-o">.</span><span class="tok-n">start</span><span class="tok-p">(</span><span class="tok-n">uri</span><span class="tok-o">.</span><span class="tok-n">hostname</span><span class="tok-p">,</span> <span class="tok-n">uri</span><span class="tok-o">.</span><span class="tok-n">port</span><span class="tok-p">,</span> <span class="tok-n">req_options</span><span class="tok-p">)</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">http</span><span class="tok-o">|</span>
  <span class="tok-n">http</span><span class="tok-o">.</span><span class="tok-n">request</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">)</span>
<span class="tok-k">end</span>

<span class="tok-nb">puts</span> <span class="tok-s2">"Response code from the server was </span><span class="tok-si">#{</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">code</span><span class="tok-si">}</span><span class="tok-s2">"</span>
<span class="tok-nb">puts</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">body</span>
</td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the output that was returned when I ran the program using Ruby version 2.3.1.
As you can see the result body contains a JSON object just as when we issued requests
using the <em>curl</em> command earlier.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">Response</span> <span class="tok-n">code</span> <span class="tok-n">from</span> <span class="tok-n">the</span> <span class="tok-n">server</span> <span class="tok-n">was</span> <span class="tok-mi">200</span>

<span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"0129e905-6903-4658-9cfb-23404842ba12"</span><span class="tok-o">,</span>
 <span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span>
 <span class="tok-s2">"result"</span><span class="tok-o">:{</span><span class="tok-s2">"data"</span><span class="tok-o">:[</span><span class="tok-mi">62</span><span class="tok-o">],</span><span class="tok-s2">"meta"</span><span class="tok-o">:{}}}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="servertinkergraph">7.6. Configuring a Gremlin Server to use a TinkerGraph</h3>
<div class="paragraph">
<p>We have already seen how a Gremlin Server can be configured as a way to provide
remote access to a JanusGraph and Cassandra deployment. Sometimes it can be useful to
setup a Gremlin Server with just a basic TinkerGraph, in-memory graph, as the
backend. This is often a handy way to work if you are developing code that will
ultimately work with a remote TinkerPop enabled graph database but want to do some
testing and development locally. A Gremlin Server can of course be configured as a
genuinely remote endpoint, perhaps running on a cloud hosted machine, but it can also
be configured to run on your local computer. I often set it up this way on my laptop
while experimenting. In this section I am going to walk through the steps required
to configure a Gremlin Server running locally that hosts the air-routes dataset in a
TinkerGraph.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You will find the configuration files discussed in this section in the
<code>sample-data</code> folder at this location
<a href="https://github.com/krlawrence/graph/tree/master/sample-data" class="bare">https://github.com/krlawrence/graph/tree/master/sample-data</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="TGConfig">7.6.1. Creating the configuration files</h4>
<div class="paragraph">
<p>To get our remote TinkerGraph up and running, all we have to do is to configure a few
settings files and start the Gremlin Server. The first file we need to create is the
YAML file that will be read by the Gremlin Server as it starts. I created a file
called <code>gremlin-server-air-routes.yaml</code> for this purpose. The file actually only
contains minor changes from the default <code>gremlin-server.yaml</code> file that comes
included as part of the Gremlin Server download. The key change is that the file
includes a reference to a script in the <code>/scripts</code> folder called <code>air-routes.groovy</code>.
The script will load the air-routes data set into a TinkerGraph instance once it has
been created.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
All folders referenced in this section, such as <code>/data</code> and <code>/script</code> are
relative to the location where the Gremlin Server is installed.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The <code>gremlin-server-air-routes.yaml</code> file should be placed in the <code>/conf</code> folder.</p>
</div>
<div class="listingblock">
<div class="title">gremlin-server-air-routes.yaml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-nl">host:</span> <span class="tok-n">localhost</span>
<span class="tok-nl">port:</span> <span class="tok-mi">8182</span>
<span class="tok-nl">scriptEvaluationTimeout:</span> <span class="tok-mi">30000</span>
<span class="tok-nl">channelizer:</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">server</span><span class="tok-o">.</span><span class="tok-na">channel</span><span class="tok-o">.</span><span class="tok-na">WsAndHttpChannelizer</span>
<span class="tok-nl">graphs:</span> <span class="tok-o">{</span>
  <span class="tok-nl">graph:</span> <span class="tok-n">conf</span><span class="tok-s">/tinkergraph-empty.properties}</span>
<span class="tok-s">scriptEngines: {</span>
<span class="tok-s">  gremlin-groovy: {</span>
<span class="tok-s">    plugins: { org.apache.tinkerpop.gremlin.server.jsr223.GremlinServerGremlinPlugin: {},</span>
<span class="tok-s">               org.apache.tinkerpop.gremlin.tinkergraph.jsr223.TinkerGraphGremlinPlugin: {},</span>
<span class="tok-s">               org.apache.tinkerpop.gremlin.jsr223.ImportGremlinPlugin: {classImports: [java.lang.Math], methodImports: [java.lang.Math#*]},</span>
<span class="tok-s">               org.apache.tinkerpop.gremlin.jsr223.ScriptFileGremlinPlugin: {files: [scripts/</span><span class="tok-n">air</span><span class="tok-o">-</span><span class="tok-n">routes</span><span class="tok-o">.</span><span class="tok-na">groovy</span><span class="tok-o">]}}}}</span>
<span class="tok-nl">serializers:</span>
  <span class="tok-o">-</span> <span class="tok-o">{</span> <span class="tok-nl">className:</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">driver</span><span class="tok-o">.</span><span class="tok-na">ser</span><span class="tok-o">.</span><span class="tok-na">GryoMessageSerializerV3d0</span><span class="tok-o">,</span> <span class="tok-nl">config:</span> <span class="tok-o">{</span> <span class="tok-nl">ioRegistries:</span> <span class="tok-o">[</span><span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">tinkergraph</span><span class="tok-o">.</span><span class="tok-na">structure</span><span class="tok-o">.</span><span class="tok-na">TinkerIoRegistryV3d0</span><span class="tok-o">]</span> <span class="tok-o">}}</span>            <span class="tok-err">#</span> <span class="tok-n">application</span><span class="tok-s">/vnd.gremlin-v3.0+gryo</span>
<span class="tok-s">  - { className: org.apache.tinkerpop.gremlin.driver.ser.GryoMessageSerializerV3d0, config: { serializeResultToString: true }}                                                                      # application/</span><span class="tok-n">vnd</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">-</span><span class="tok-n">v3</span><span class="tok-o">.</span><span class="tok-mi">0</span><span class="tok-o">+</span><span class="tok-n">gryo</span><span class="tok-o">-</span><span class="tok-n">stringd</span>
  <span class="tok-o">-</span> <span class="tok-o">{</span> <span class="tok-nl">className:</span> <span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">driver</span><span class="tok-o">.</span><span class="tok-na">ser</span><span class="tok-o">.</span><span class="tok-na">GraphSONMessageSerializerV1d0</span><span class="tok-o">,</span> <span class="tok-nl">config:</span> <span class="tok-o">{</span> <span class="tok-nl">ioRegistries:</span> <span class="tok-o">[</span><span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">tinkergraph</span><span class="tok-o">.</span><span class="tok-na">structure</span><span class="tok-o">.</span><span class="tok-na">TinkerIoRegistryV3d0</span><span class="tok-o">]</span> <span class="tok-o">}}</span>        <span class="tok-err">#</span> <span class="tok-n">application</span><span class="tok-o">/</span><span class="tok-n">json</span>
<span class="tok-nl">metrics:</span> <span class="tok-o">{</span>
  <span class="tok-nl">slf4jReporter:</span> <span class="tok-o">{</span><span class="tok-nl">enabled:</span> <span class="tok-kc">true</span><span class="tok-o">,</span> <span class="tok-nl">interval:</span> <span class="tok-mi">180000</span><span class="tok-o">}}</span>
<span class="tok-nl">strictTransactionManagement:</span> <span class="tok-kc">false</span>
<span class="tok-nl">idleConnectionTimeout:</span> <span class="tok-mi">0</span>
<span class="tok-nl">keepAliveInterval:</span> <span class="tok-mi">0</span>
<span class="tok-nl">maxInitialLineLength:</span> <span class="tok-mi">4096</span>
<span class="tok-nl">maxHeaderSize:</span> <span class="tok-mi">8192</span>
<span class="tok-nl">maxChunkSize:</span> <span class="tok-mi">8192</span>
<span class="tok-nl">maxContentLength:</span> <span class="tok-mi">65536</span>
<span class="tok-nl">maxAccumulationBufferComponents:</span> <span class="tok-mi">1024</span>
<span class="tok-nl">resultIterationBatchSize:</span> <span class="tok-mi">64</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that I configured the YAML file so that when JSON is returned it is in the
original V1 GraphSON format. This is done by specifying that the
<em>GraphSONMessageSerializerV1d0</em> message serializer be used. The main difference
between the V1 format and the newer V3 format is that no type information will be
returned as part of the V1 format. I find that users find this format much easier to
read while learning Gremlin.</p>
</div>
<div class="paragraph">
<p>The properties file that is referenced in the YAML file is unchanged from the default
one that comes with Gremlin Server. It creates an empty in-memory TinkerGraph.</p>
</div>
<div class="paragraph">
<p>The <code>tinkergraph-empty.properties</code> file should also be placed in the <code>/conf</code> folder.</p>
</div>
<div class="listingblock">
<div class="title">tinkergraph-empty.properties</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">gremlin</span><span class="tok-o">.</span><span class="tok-na">graph</span><span class="tok-o">=</span><span class="tok-n">org</span><span class="tok-o">.</span><span class="tok-na">apache</span><span class="tok-o">.</span><span class="tok-na">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">gremlin</span><span class="tok-o">.</span><span class="tok-na">tinkergraph</span><span class="tok-o">.</span><span class="tok-na">structure</span><span class="tok-o">.</span><span class="tok-na">TinkerGraph</span>
<span class="tok-n">gremlin</span><span class="tok-o">.</span><span class="tok-na">tinkergraph</span><span class="tok-o">.</span><span class="tok-na">vertexIdManager</span><span class="tok-o">=</span><span class="tok-n">LONG</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The file <code>air-routes.groovy</code> invokes the necessary method to load the
<code>air-routes.graphml</code> file from the <code>/data</code> folder. The file should be placed in the
<code>/scripts</code> folder.</p>
</div>
<div class="listingblock">
<div class="title">air-routes.groovy</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">globals</span> <span class="tok-o">=</span> <span class="tok-o">[:]</span>

<span class="tok-n">globals</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-o">[</span><span class="tok-n">hook</span> <span class="tok-o">:</span> <span class="tok-o">[</span>
  <span class="tok-nl">onStartUp:</span> <span class="tok-o">{</span> <span class="tok-n">ctx</span> <span class="tok-o">-&gt;</span>
    <span class="tok-n">ctx</span><span class="tok-o">.</span><span class="tok-na">logger</span><span class="tok-o">.</span><span class="tok-na">info</span><span class="tok-o">(</span><span class="tok-s2">"Loading 'air-routes' graph data."</span><span class="tok-o">)</span>
    <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">io</span><span class="tok-o">(</span><span class="tok-n">graphml</span><span class="tok-o">()).</span><span class="tok-na">readGraph</span><span class="tok-o">(</span><span class="tok-s1">'data/air-routes.graphml'</span><span class="tok-o">)</span>
  <span class="tok-o">}</span>
<span class="tok-o">]</span> <span class="tok-k">as</span> <span class="tok-n">LifeCycleHook</span><span class="tok-o">]</span>

<span class="tok-n">globals</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-o">[</span><span class="tok-n">g</span> <span class="tok-o">:</span> <span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">()]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="TGStart">7.6.2. Starting the Server</h4>
<div class="paragraph">
<p>As discussed in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#serverconfig">Configuring Gremlin Server</a>" section, you can start the Gremlin Server in the
foreground or in the background. For our initial test let’s just start the server
running in the foregorund.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> bin/gremlin-server.sh conf/gremlin-server-air-routes.yaml</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="TGTest">7.6.3. Testing the Server</h4>
<div class="paragraph">
<p>Now that the Gremlin Server is up and running you can access it using <em>localhost</em> as
the host name and a port of 8182 just as we did earlier while setting up a Gremlin
Server and JanusGraph. It’s always a good idea to try a simple <em>curl</em> command to make
sure that things are working.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> curl <span class="tok-s2">"localhost:8182/gremlin?gremlin=g.V().has('code','SFO').valueMap()"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the output returned. Note that it is in the GraphSON V1 format that
we configured for earlier.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"fbcab664-7538-402f-85b4-1b14db88c968"</span><span class="tok-o">,</span><span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span><span class="tok-s2">"result"</span><span class="tok-o">:{</span><span class="tok-s2">"data"</span><span class="tok-o">:[{</span><span class="tok-s2">"country"</span><span class="tok-o">:[</span><span class="tok-s2">"US"</span><span class="tok-o">],</span><span class="tok-s2">"code"</span><span class="tok-o">:[</span><span class="tok-s2">"SFO"</span><span class="tok-o">],</span><span class="tok-s2">"longest"</span><span class="tok-o">:[</span><span class="tok-mi">11870</span><span class="tok-o">],</span><span class="tok-s2">"city"</span><span class="tok-o">:[</span><span class="tok-s2">"San Francisco"</span><span class="tok-o">],</span><span class="tok-s2">"elev"</span><span class="tok-o">:[</span><span class="tok-mi">13</span><span class="tok-o">],</span><span class="tok-s2">"icao"</span><span class="tok-o">:[</span><span class="tok-s2">"KSFO"</span><span class="tok-o">],</span><span class="tok-s2">"lon"</span><span class="tok-o">:[-</span><span class="tok-mf">122.375</span><span class="tok-o">],</span><span class="tok-s2">"type"</span><span class="tok-o">:[</span><span class="tok-s2">"airport"</span><span class="tok-o">],</span><span class="tok-s2">"region"</span><span class="tok-o">:[</span><span class="tok-s2">"US-CA"</span><span class="tok-o">],</span><span class="tok-s2">"runways"</span><span class="tok-o">:[</span><span class="tok-mi">4</span><span class="tok-o">],</span><span class="tok-s2">"lat"</span><span class="tok-o">:[</span><span class="tok-mf">37.6189994812012</span><span class="tok-o">],</span><span class="tok-s2">"desc"</span><span class="tok-o">:[</span><span class="tok-s2">"San Francisco International Airport"</span><span class="tok-o">]}],</span><span class="tok-s2">"meta"</span><span class="tok-o">:{}}}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The same Gremlin Console remote connections configuration we looked at earlier can
also be reused. Likewise, you can connect to your Gremlin Server using the host name
<em>localhost</em> and port 8182. The example below assumes that you have already started
the Gremlin Console.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-o">:</span><span class="tok-n">remote</span> <span class="tok-n">connect</span> <span class="tok-n">tinkerpop</span><span class="tok-o">.</span><span class="tok-na">server</span> <span class="tok-n">conf</span><span class="tok-s">/remote.yaml</span>
<span class="tok-s">==&gt;Configured localhost/</span><span class="tok-mf">127.0</span><span class="tok-o">.</span><span class="tok-mf">0.1</span><span class="tok-o">:</span><span class="tok-mi">8182</span>

<span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-o">:</span><span class="tok-n">remote</span> <span class="tok-n">console</span>
<span class="tok-o">==&gt;</span><span class="tok-n">All</span> <span class="tok-n">scripts</span> <span class="tok-n">will</span> <span class="tok-n">now</span> <span class="tok-n">be</span> <span class="tok-n">sent</span> <span class="tok-n">to</span> <span class="tok-n">Gremlin</span> <span class="tok-n">Server</span> <span class="tok-o">-</span> <span class="tok-o">[</span><span class="tok-n">localhost</span><span class="tok-o">/</span><span class="tok-mf">127.0</span><span class="tok-o">.</span><span class="tok-mf">0.1</span><span class="tok-o">:</span><span class="tok-mi">8182</span><span class="tok-o">]</span> <span class="tok-o">-</span> <span class="tok-n">type</span> <span class="tok-s1">':remote console'</span> <span class="tok-n">to</span> <span class="tok-k">return</span> <span class="tok-n">to</span> <span class="tok-n">local</span> <span class="tok-n">mode</span>

<span class="tok-n">gremlin</span><span class="tok-o">&gt;</span> <span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SFO'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">().</span><span class="tok-na">unfold</span><span class="tok-o">()</span>
<span class="tok-o">==&gt;</span><span class="tok-n">country</span><span class="tok-o">=[</span><span class="tok-n">US</span><span class="tok-o">]</span>
<span class="tok-o">==&gt;</span><span class="tok-n">code</span><span class="tok-o">=[</span><span class="tok-n">SFO</span><span class="tok-o">]</span>
<span class="tok-o">==&gt;</span><span class="tok-n">longest</span><span class="tok-o">=[</span><span class="tok-mi">11870</span><span class="tok-o">]</span>
<span class="tok-o">==&gt;</span><span class="tok-n">city</span><span class="tok-o">=[</span><span class="tok-n">San</span> <span class="tok-n">Francisco</span><span class="tok-o">]</span>
<span class="tok-o">==&gt;</span><span class="tok-n">elev</span><span class="tok-o">=[</span><span class="tok-mi">13</span><span class="tok-o">]</span>
<span class="tok-o">==&gt;</span><span class="tok-n">icao</span><span class="tok-o">=[</span><span class="tok-n">KSFO</span><span class="tok-o">]</span>
<span class="tok-o">==&gt;</span><span class="tok-n">lon</span><span class="tok-o">=[-</span><span class="tok-mf">122.375</span><span class="tok-o">]</span>
<span class="tok-o">==&gt;</span><span class="tok-n">type</span><span class="tok-o">=[</span><span class="tok-n">airport</span><span class="tok-o">]</span>
<span class="tok-o">==&gt;</span><span class="tok-n">region</span><span class="tok-o">=[</span><span class="tok-n">US</span><span class="tok-o">-</span><span class="tok-n">CA</span><span class="tok-o">]</span>
<span class="tok-o">==&gt;</span><span class="tok-n">runways</span><span class="tok-o">=[</span><span class="tok-mi">4</span><span class="tok-o">]</span>
<span class="tok-o">==&gt;</span><span class="tok-n">lat</span><span class="tok-o">=[</span><span class="tok-mf">37.6189994812012</span><span class="tok-o">]</span>
<span class="tok-o">==&gt;</span><span class="tok-n">desc</span><span class="tok-o">=[</span><span class="tok-n">San</span> <span class="tok-n">Francisco</span> <span class="tok-n">International</span> <span class="tok-n">Airport</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hopefully having read this section you now have an understanding of how to setup a
Gremlin Server that hosts an in-memory TinkerGraph containing the <em>air-routes</em> data
set. This can be a useful environment when you want to test queries and code locally
that will ultimately need to work with a remote TinkerPop enabled graph
database.</p>
</div>
<div class="paragraph">
<p>In the next section we will look at ways to make the JSON returned easier to work
with and also add to our Ruby program to work with the JSON.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="servertweaks">7.7. Tweaking queries to make the JSON returned easier to work with</h3>
<div class="paragraph">
<p>Below is a query that we have seen used earlier in this book. It finds all
routes longer than 8,000 miles and returns the airport pairs and the distance
between them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">8000</span><span class="tok-o">)).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">desc</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span>
      <span class="tok-n">filter</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span> <span class="tok-n">lt</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">))).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When we run this query using the Gremlin console with TinkerGraph we get
back results that have been to a degree <em>pretty printed</em> by the Console as
shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-mi">9025</span><span class="tok-o">,</span><span class="tok-n">DOH</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-mi">8246</span><span class="tok-o">,</span><span class="tok-n">RUH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AKL</span><span class="tok-o">,</span><span class="tok-mi">8818</span><span class="tok-o">,</span><span class="tok-n">DXB</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">MEL</span><span class="tok-o">,</span><span class="tok-mi">8197</span><span class="tok-o">,</span><span class="tok-n">YVR</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">LAX</span><span class="tok-o">,</span><span class="tok-mi">8756</span><span class="tok-o">,</span><span class="tok-n">SIN</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-mi">8150</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">CAN</span><span class="tok-o">,</span><span class="tok-mi">8754</span><span class="tok-o">,</span><span class="tok-n">MEX</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-mi">8139</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">IAH</span><span class="tok-o">,</span><span class="tok-mi">8591</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">8105</span><span class="tok-o">,</span><span class="tok-n">HKG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">8574</span><span class="tok-o">,</span><span class="tok-n">SYD</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-mi">8085</span><span class="tok-o">,</span><span class="tok-n">SFO</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-mi">8434</span><span class="tok-o">,</span><span class="tok-n">JNB</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">HKG</span><span class="tok-o">,</span><span class="tok-mi">8054</span><span class="tok-o">,</span><span class="tok-n">JFK</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">SFO</span><span class="tok-o">,</span><span class="tok-mi">8433</span><span class="tok-o">,</span><span class="tok-n">SIN</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-mi">8053</span><span class="tok-o">,</span><span class="tok-n">DFW</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">AUH</span><span class="tok-o">,</span><span class="tok-mi">8372</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">EWR</span><span class="tok-o">,</span><span class="tok-mi">8047</span><span class="tok-o">,</span><span class="tok-n">HKG</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DXB</span><span class="tok-o">,</span><span class="tok-mi">8321</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">DOH</span><span class="tok-o">,</span><span class="tok-mi">8030</span><span class="tok-o">,</span><span class="tok-n">IAH</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">JED</span><span class="tok-o">,</span><span class="tok-mi">8314</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span>    <span class="tok-o">[</span><span class="tok-n">DFW</span><span class="tok-o">,</span><span class="tok-mi">8022</span><span class="tok-o">,</span><span class="tok-n">DXB</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">DOH</span><span class="tok-o">,</span><span class="tok-mi">8287</span><span class="tok-o">,</span><span class="tok-n">LAX</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, if you were to use a system that returns the full JSON response, as is the
case when using a Gremlin Server over an HTTP connection, you will not get the
benefit <em>"pretty printing"</em> that the Gremlin Console does
for you. Instead, you will get back something that looks a lot like this from the
exact same query as the one we used above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"5acca62c-7351-4b3d-bb20-3660f6feb3cc"</span><span class="tok-o">,</span>
 <span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span>
 <span class="tok-s2">"result"</span><span class="tok-o">:{</span><span class="tok-s2">"data"</span><span class="tok-o">:</span>
    <span class="tok-o">[{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[</span><span class="tok-s2">"a"</span><span class="tok-o">],[],[</span><span class="tok-s2">"b"</span><span class="tok-o">]],</span><span class="tok-s2">"objects"</span><span class="tok-o">:[</span><span class="tok-s2">"AKL"</span><span class="tok-o">,</span><span class="tok-mi">9025</span><span class="tok-o">,</span><span class="tok-s2">"DOH"</span><span class="tok-o">]},</span>
    <span class="tok-o">{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[</span><span class="tok-s2">"a"</span><span class="tok-o">],[],[</span><span class="tok-s2">"b"</span><span class="tok-o">]],</span><span class="tok-s2">"objects"</span><span class="tok-o">:[</span><span class="tok-s2">"AKL"</span><span class="tok-o">,</span><span class="tok-mi">8818</span><span class="tok-o">,</span><span class="tok-s2">"DXB"</span><span class="tok-o">]},</span>
    <span class="tok-o">{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[</span><span class="tok-s2">"a"</span><span class="tok-o">],[],[</span><span class="tok-s2">"b"</span><span class="tok-o">]],</span><span class="tok-s2">"objects"</span><span class="tok-o">:[</span><span class="tok-s2">"LAX"</span><span class="tok-o">,</span><span class="tok-mi">8756</span><span class="tok-o">,</span><span class="tok-s2">"SIN"</span><span class="tok-o">]},</span>
    <span class="tok-o">{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[</span><span class="tok-s2">"a"</span><span class="tok-o">],[],[</span><span class="tok-s2">"b"</span><span class="tok-o">]],</span><span class="tok-s2">"objects"</span><span class="tok-o">:[</span><span class="tok-s2">"CAN"</span><span class="tok-o">,</span><span class="tok-mi">8754</span><span class="tok-o">,</span><span class="tok-s2">"MEX"</span><span class="tok-o">]},</span>
    <span class="tok-o">{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[</span><span class="tok-s2">"a"</span><span class="tok-o">],[],[</span><span class="tok-s2">"b"</span><span class="tok-o">]],</span><span class="tok-s2">"objects"</span><span class="tok-o">:[</span><span class="tok-s2">"IAH"</span><span class="tok-o">,</span><span class="tok-mi">8591</span><span class="tok-o">,</span><span class="tok-s2">"SYD"</span><span class="tok-o">]},</span>
    <span class="tok-o">{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[</span><span class="tok-s2">"a"</span><span class="tok-o">],[],[</span><span class="tok-s2">"b"</span><span class="tok-o">]],</span><span class="tok-s2">"objects"</span><span class="tok-o">:[</span><span class="tok-s2">"DFW"</span><span class="tok-o">,</span><span class="tok-mi">8574</span><span class="tok-o">,</span><span class="tok-s2">"SYD"</span><span class="tok-o">]},</span>
    <span class="tok-o">{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[</span><span class="tok-s2">"a"</span><span class="tok-o">],[],[</span><span class="tok-s2">"b"</span><span class="tok-o">]],</span><span class="tok-s2">"objects"</span><span class="tok-o">:[</span><span class="tok-s2">"ATL"</span><span class="tok-o">,</span><span class="tok-mi">8434</span><span class="tok-o">,</span><span class="tok-s2">"JNB"</span><span class="tok-o">]},</span>
    <span class="tok-o">{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[</span><span class="tok-s2">"a"</span><span class="tok-o">],[],[</span><span class="tok-s2">"b"</span><span class="tok-o">]],</span><span class="tok-s2">"objects"</span><span class="tok-o">:[</span><span class="tok-s2">"SFO"</span><span class="tok-o">,</span><span class="tok-mi">8433</span><span class="tok-o">,</span><span class="tok-s2">"SIN"</span><span class="tok-o">]},</span>
    <span class="tok-o">{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[</span><span class="tok-s2">"a"</span><span class="tok-o">],[],[</span><span class="tok-s2">"b"</span><span class="tok-o">]],</span><span class="tok-s2">"objects"</span><span class="tok-o">:[</span><span class="tok-s2">"AUH"</span><span class="tok-o">,</span><span class="tok-mi">8372</span><span class="tok-o">,</span><span class="tok-s2">"LAX"</span><span class="tok-o">]},</span>
    <span class="tok-o">{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[</span><span class="tok-s2">"a"</span><span class="tok-o">],[],[</span><span class="tok-s2">"b"</span><span class="tok-o">]],</span><span class="tok-s2">"objects"</span><span class="tok-o">:[</span><span class="tok-s2">"DXB"</span><span class="tok-o">,</span><span class="tok-mi">8321</span><span class="tok-o">,</span><span class="tok-s2">"LAX"</span><span class="tok-o">]},</span>
    <span class="tok-o">{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[</span><span class="tok-s2">"a"</span><span class="tok-o">],[],[</span><span class="tok-s2">"b"</span><span class="tok-o">]],</span><span class="tok-s2">"objects"</span><span class="tok-o">:[</span><span class="tok-s2">"JED"</span><span class="tok-o">,</span><span class="tok-mi">8314</span><span class="tok-o">,</span><span class="tok-s2">"LAX"</span><span class="tok-o">]},</span>
    <span class="tok-o">{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[</span><span class="tok-s2">"a"</span><span class="tok-o">],[],[</span><span class="tok-s2">"b"</span><span class="tok-o">]],</span><span class="tok-s2">"objects"</span><span class="tok-o">:[</span><span class="tok-s2">"DOH"</span><span class="tok-o">,</span><span class="tok-mi">8287</span><span class="tok-o">,</span><span class="tok-s2">"LAX"</span><span class="tok-o">]},</span>
    <span class="tok-o">{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[</span><span class="tok-s2">"a"</span><span class="tok-o">],[],[</span><span class="tok-s2">"b"</span><span class="tok-o">]],</span><span class="tok-s2">"objects"</span><span class="tok-o">:[</span><span class="tok-s2">"LAX"</span><span class="tok-o">,</span><span class="tok-mi">8246</span><span class="tok-o">,</span><span class="tok-s2">"RUH"</span><span class="tok-o">]},</span>
    <span class="tok-o">{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[</span><span class="tok-s2">"a"</span><span class="tok-o">],[],[</span><span class="tok-s2">"b"</span><span class="tok-o">]],</span><span class="tok-s2">"objects"</span><span class="tok-o">:[</span><span class="tok-s2">"MEL"</span><span class="tok-o">,</span><span class="tok-mi">8197</span><span class="tok-o">,</span><span class="tok-s2">"YVR"</span><span class="tok-o">]},</span>
    <span class="tok-o">{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[</span><span class="tok-s2">"a"</span><span class="tok-o">],[],[</span><span class="tok-s2">"b"</span><span class="tok-o">]],</span><span class="tok-s2">"objects"</span><span class="tok-o">:[</span><span class="tok-s2">"DXB"</span><span class="tok-o">,</span><span class="tok-mi">8150</span><span class="tok-o">,</span><span class="tok-s2">"IAH"</span><span class="tok-o">]},</span>
    <span class="tok-o">{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[</span><span class="tok-s2">"a"</span><span class="tok-o">],[],[</span><span class="tok-s2">"b"</span><span class="tok-o">]],</span><span class="tok-s2">"objects"</span><span class="tok-o">:[</span><span class="tok-s2">"AUH"</span><span class="tok-o">,</span><span class="tok-mi">8139</span><span class="tok-o">,</span><span class="tok-s2">"SFO"</span><span class="tok-o">]},</span>
    <span class="tok-o">{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[</span><span class="tok-s2">"a"</span><span class="tok-o">],[],[</span><span class="tok-s2">"b"</span><span class="tok-o">]],</span><span class="tok-s2">"objects"</span><span class="tok-o">:[</span><span class="tok-s2">"DFW"</span><span class="tok-o">,</span><span class="tok-mi">8105</span><span class="tok-o">,</span><span class="tok-s2">"HKG"</span><span class="tok-o">]},</span>
    <span class="tok-o">{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[</span><span class="tok-s2">"a"</span><span class="tok-o">],[],[</span><span class="tok-s2">"b"</span><span class="tok-o">]],</span><span class="tok-s2">"objects"</span><span class="tok-o">:[</span><span class="tok-s2">"DXB"</span><span class="tok-o">,</span><span class="tok-mi">8085</span><span class="tok-o">,</span><span class="tok-s2">"SFO"</span><span class="tok-o">]},</span>
    <span class="tok-o">{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[</span><span class="tok-s2">"a"</span><span class="tok-o">],[],[</span><span class="tok-s2">"b"</span><span class="tok-o">]],</span><span class="tok-s2">"objects"</span><span class="tok-o">:[</span><span class="tok-s2">"HKG"</span><span class="tok-o">,</span><span class="tok-mi">8054</span><span class="tok-o">,</span><span class="tok-s2">"JFK"</span><span class="tok-o">]},</span>
    <span class="tok-o">{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[</span><span class="tok-s2">"a"</span><span class="tok-o">],[],[</span><span class="tok-s2">"b"</span><span class="tok-o">]],</span><span class="tok-s2">"objects"</span><span class="tok-o">:[</span><span class="tok-s2">"AUH"</span><span class="tok-o">,</span><span class="tok-mi">8053</span><span class="tok-o">,</span><span class="tok-s2">"DFW"</span><span class="tok-o">]},</span>
    <span class="tok-o">{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[</span><span class="tok-s2">"a"</span><span class="tok-o">],[],[</span><span class="tok-s2">"b"</span><span class="tok-o">]],</span><span class="tok-s2">"objects"</span><span class="tok-o">:[</span><span class="tok-s2">"EWR"</span><span class="tok-o">,</span><span class="tok-mi">8047</span><span class="tok-o">,</span><span class="tok-s2">"HKG"</span><span class="tok-o">]},</span>
    <span class="tok-o">{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[</span><span class="tok-s2">"a"</span><span class="tok-o">],[],[</span><span class="tok-s2">"b"</span><span class="tok-o">]],</span><span class="tok-s2">"objects"</span><span class="tok-o">:[</span><span class="tok-s2">"DOH"</span><span class="tok-o">,</span><span class="tok-mi">8030</span><span class="tok-o">,</span><span class="tok-s2">"IAH"</span><span class="tok-o">]},</span>
    <span class="tok-o">{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[</span><span class="tok-s2">"a"</span><span class="tok-o">],[],[</span><span class="tok-s2">"b"</span><span class="tok-o">]],</span><span class="tok-s2">"objects"</span><span class="tok-o">:[</span><span class="tok-s2">"DFW"</span><span class="tok-o">,</span><span class="tok-mi">8022</span><span class="tok-o">,</span><span class="tok-s2">"DXB"</span><span class="tok-o">]}],</span>
    <span class="tok-s2">"meta"</span><span class="tok-o">:{}}}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>What is being returned is useful in some cases, for example we can see the
<em>a</em> and <em>b</em> labels that we used in our query but in this case all we really
wanted was the last part with the airport codes and the distances. We could
decide to write code to process this JSON as-is (probably using a JSON helper
class) and that is a valid choice you could make. However by tweaking the
query slightly, we can enable Gremlin to give us back what we really wanted.
Let’s start by looking at what happens if we add <em>.toList().toString()</em> to the
end of the query. Take a look at the modified form of the query below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">8000</span><span class="tok-o">)).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">desc</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span>
      <span class="tok-n">filter</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span> <span class="tok-n">lt</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">))).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">toList</span><span class="tok-o">().</span><span class="tok-na">toString</span><span class="tok-o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we were to send this modified form of the query to our Gremlin Server, we should
get back something that looks a lot more like the result we got back when working
with the Gremlin Console. As shown below, it is certainly a bit easier to process in
your application now. However, this is still not an ideal result as what we now have
is a list containing  a single string with all of our routes in it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"63c660d0-28cf-41fc-86cf-5560a4e2fac0"</span><span class="tok-o">,</span><span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span><span class="tok-s2">"result"</span><span class="tok-o">:{</span><span class="tok-s2">"data"</span><span class="tok-o">:[</span><span class="tok-s2">"[[AKL, 9025, DOH], [AKL, 8818, DXB], [LAX, 8756, SIN], [CAN, 8754, MEX], [IAH, 8591, SYD], [DFW, 8574, SYD], [ATL, 8434, JNB], [SFO, 8433, SIN], [AUH, 8372, LAX], [DXB, 8321, LAX], [JED, 8314, LAX], [DOH, 8287, LAX], [LAX, 8246, RUH], [MEL, 8197, YVR], [DXB, 8150, IAH], [AUH, 8139, SFO], [DFW, 8105, HKG], [DXB, 8085, SFO], [HKG, 8054, JFK], [AUH, 8053, DFW], [EWR, 8047, HKG], [DOH, 8030, IAH], [DFW, 8022, DXB]]"</span><span class="tok-o">],</span><span class="tok-s2">"meta"</span><span class="tok-o">:{}}}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can add a little more post processing to split up our single string into an
array of strings where each string is a single route of the form
<em>[AKL,9025,DOH]</em>. One way to do this is to trim off the unwanted characters at
each end of the string and then use split to divide it up. As there are a lot
of commas in the string I could not just do a simple <em>split(",")</em> as that
would not have returned what I wanted. To make the split work, I replaced
every occurence of <em>],</em> in the string with <em>]x</em> and then did the split using
<em>split("x")</em>. Here is the modified query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">gt</span><span class="tok-o">(</span><span class="tok-mi">8000</span><span class="tok-o">)).</span>
      <span class="tok-n">order</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">,</span><span class="tok-n">desc</span><span class="tok-o">).</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span>
      <span class="tok-n">filter</span><span class="tok-o">(</span><span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">where</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span> <span class="tok-n">lt</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">))).</span>
      <span class="tok-n">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">toList</span><span class="tok-o">().</span><span class="tok-na">toString</span><span class="tok-o">()[</span><span class="tok-mi">1</span><span class="tok-o">..-</span><span class="tok-mi">2</span><span class="tok-o">].</span>
      <span class="tok-n">replaceAll</span><span class="tok-o">(</span><span class="tok-s1">'],'</span><span class="tok-o">,</span><span class="tok-s1">']x'</span><span class="tok-o">).</span><span class="tok-na">split</span><span class="tok-o">(</span><span class="tok-s1">'x'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is what we now get back in the returned JSON. Each route is now a string
in an array of strings. From here it is a simple task to extract the airport
names and distances for each route.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"9d8324a8-89e4-4c1e-be59-ff433784a3da"</span><span class="tok-o">,</span>
 <span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span>
 <span class="tok-s2">"result"</span><span class="tok-o">:{</span><span class="tok-s2">"data"</span><span class="tok-o">:[</span> <span class="tok-s2">" [AKL, 9025, DOH]"</span><span class="tok-o">,</span>
                    <span class="tok-s2">" [AKL, 8818, DXB]"</span><span class="tok-o">,</span>
                    <span class="tok-s2">" [LAX, 8756, SIN]"</span><span class="tok-o">,</span>
                    <span class="tok-s2">" [CAN, 8754, MEX]"</span><span class="tok-o">,</span>
                    <span class="tok-s2">" [IAH, 8591, SYD]"</span><span class="tok-o">,</span>
                    <span class="tok-s2">" [DFW, 8574, SYD]"</span><span class="tok-o">,</span>
                    <span class="tok-s2">" [ATL, 8434, JNB]"</span><span class="tok-o">,</span>
                    <span class="tok-s2">" [SFO, 8433, SIN]"</span><span class="tok-o">,</span>
                    <span class="tok-s2">" [AUH, 8372, LAX]"</span><span class="tok-o">,</span>
                    <span class="tok-s2">" [DXB, 8321, LAX]"</span><span class="tok-o">,</span>
                    <span class="tok-s2">" [JED, 8314, LAX]"</span><span class="tok-o">,</span>
                    <span class="tok-s2">" [DOH, 8287, LAX]"</span><span class="tok-o">,</span>
                    <span class="tok-s2">" [LAX, 8246, RUH]"</span><span class="tok-o">,</span>
                    <span class="tok-s2">" [MEL, 8197, YVR]"</span><span class="tok-o">,</span>
                    <span class="tok-s2">" [DXB, 8150, IAH]"</span><span class="tok-o">,</span>
                    <span class="tok-s2">" [AUH, 8139, SFO]"</span><span class="tok-o">,</span>
                    <span class="tok-s2">" [DFW, 8105, HKG]"</span><span class="tok-o">,</span>
                    <span class="tok-s2">" [DXB, 8085, SFO]"</span><span class="tok-o">,</span>
                    <span class="tok-s2">" [HKG, 8054, JFK]"</span><span class="tok-o">,</span>
                    <span class="tok-s2">" [AUH, 8053, DFW]"</span><span class="tok-o">,</span>
                    <span class="tok-s2">" [EWR, 8047, HKG]"</span><span class="tok-o">,</span>
                    <span class="tok-s2">" [DOH, 8030, IAH]"</span><span class="tok-o">,</span>
                    <span class="tok-s2">" [DFW, 8022, DXB]"</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It’s really a matter of personal preference whether you decide to have the query
return less data or just return the full set of data that we got back from the
initial query. One advantage to having the query limit what is returned is that less
data, potentially a lot less data, will need to be sent back to your application and
stored in memory or on disk. However, as, most programming languages have built in
support that makes it easy de serialize JSON objects into native data structures such
as maps, you may prefer to just have all the JSON be returned and do the rest of the
processing yourself.</p>
</div>
<div class="paragraph">
<p>By way of a simple example, if we added the following lines to our Ruby application
that we created in the previous section, and used the original query from before we
added any post processing, we could easily get at the parts of the JSON that we are
interested in.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span class="tok-n">res</span> <span class="tok-o">=</span> <span class="tok-no">JSON</span><span class="tok-o">.</span><span class="tok-n">parse</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">body</span><span class="tok-p">)</span><span class="tok-o">[</span><span class="tok-s1">'result'</span><span class="tok-o">][</span><span class="tok-s1">'data'</span><span class="tok-o">]</span>

<span class="tok-n">res</span><span class="tok-o">.</span><span class="tok-n">each</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">x</span><span class="tok-o">|</span>
  <span class="tok-nb">p</span> <span class="tok-n">x</span><span class="tok-o">[</span><span class="tok-s1">'objects'</span><span class="tok-o">]</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The code uses Ruby’s <em>JSON</em> class to convert the JSON response from the Gremlin
Server into a map data structure. We can then access each part of the map by the
names contained in the JSON. Note that the code as written expects a specific set of
keywords to be present in the JSON. Not all query results contain these keywords.
Therefore, it would take a little more work to turn this into a more general purpose
piece of code that could handle any of the possible JSON return formats the server
could send to us. Here is the output from running the updated Ruby code. Notice that
what we have now is a nice collection of lists, each one containing two strings and
an integer. The data is now in a form that is really easy and convenient to process
further.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-o">[</span><span class="tok-s2">"AKL"</span><span class="tok-o">,</span> <span class="tok-mi">9025</span><span class="tok-o">,</span> <span class="tok-s2">"DOH"</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-s2">"LAX"</span><span class="tok-o">,</span> <span class="tok-mi">8246</span><span class="tok-o">,</span> <span class="tok-s2">"RUH"</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-s2">"AKL"</span><span class="tok-o">,</span> <span class="tok-mi">8818</span><span class="tok-o">,</span> <span class="tok-s2">"DXB"</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-s2">"MEL"</span><span class="tok-o">,</span> <span class="tok-mi">8197</span><span class="tok-o">,</span> <span class="tok-s2">"YVR"</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-s2">"LAX"</span><span class="tok-o">,</span> <span class="tok-mi">8756</span><span class="tok-o">,</span> <span class="tok-s2">"SIN"</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-s2">"DXB"</span><span class="tok-o">,</span> <span class="tok-mi">8150</span><span class="tok-o">,</span> <span class="tok-s2">"IAH"</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-s2">"CAN"</span><span class="tok-o">,</span> <span class="tok-mi">8754</span><span class="tok-o">,</span> <span class="tok-s2">"MEX"</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-s2">"AUH"</span><span class="tok-o">,</span> <span class="tok-mi">8139</span><span class="tok-o">,</span> <span class="tok-s2">"SFO"</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-s2">"IAH"</span><span class="tok-o">,</span> <span class="tok-mi">8591</span><span class="tok-o">,</span> <span class="tok-s2">"SYD"</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-s2">"DFW"</span><span class="tok-o">,</span> <span class="tok-mi">8105</span><span class="tok-o">,</span> <span class="tok-s2">"HKG"</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-s2">"DFW"</span><span class="tok-o">,</span> <span class="tok-mi">8574</span><span class="tok-o">,</span> <span class="tok-s2">"SYD"</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-s2">"DXB"</span><span class="tok-o">,</span> <span class="tok-mi">8085</span><span class="tok-o">,</span> <span class="tok-s2">"SFO"</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-s2">"ATL"</span><span class="tok-o">,</span> <span class="tok-mi">8434</span><span class="tok-o">,</span> <span class="tok-s2">"JNB"</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-s2">"HKG"</span><span class="tok-o">,</span> <span class="tok-mi">8054</span><span class="tok-o">,</span> <span class="tok-s2">"JFK"</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-s2">"SFO"</span><span class="tok-o">,</span> <span class="tok-mi">8433</span><span class="tok-o">,</span> <span class="tok-s2">"SIN"</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-s2">"AUH"</span><span class="tok-o">,</span> <span class="tok-mi">8053</span><span class="tok-o">,</span> <span class="tok-s2">"DFW"</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-s2">"AUH"</span><span class="tok-o">,</span> <span class="tok-mi">8372</span><span class="tok-o">,</span> <span class="tok-s2">"LAX"</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-s2">"EWR"</span><span class="tok-o">,</span> <span class="tok-mi">8047</span><span class="tok-o">,</span> <span class="tok-s2">"HKG"</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-s2">"DXB"</span><span class="tok-o">,</span> <span class="tok-mi">8321</span><span class="tok-o">,</span> <span class="tok-s2">"LAX"</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-s2">"DOH"</span><span class="tok-o">,</span> <span class="tok-mi">8030</span><span class="tok-o">,</span> <span class="tok-s2">"IAH"</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-s2">"JED"</span><span class="tok-o">,</span> <span class="tok-mi">8314</span><span class="tok-o">,</span> <span class="tok-s2">"LAX"</span><span class="tok-o">]</span>     <span class="tok-o">[</span><span class="tok-s2">"DFW"</span><span class="tok-o">,</span> <span class="tok-mi">8022</span><span class="tok-o">,</span> <span class="tok-s2">"DXB"</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-s2">"DOH"</span><span class="tok-o">,</span> <span class="tok-mi">8287</span><span class="tok-o">,</span> <span class="tok-s2">"LAX"</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the next section you will find more examples of the JSON that can be returned by
Gremlin Server and also some examples of how to reduce the amount of data that is
returned.</p>
</div>
</div>
<div class="sect2">
<h3 id="serverjson">7.8. More examples of the JSON returned from a Gremlin Server</h3>
<div class="paragraph">
<p>The JSON returned by the Gremlin Server depends on query that is used and more
specifically, what that query returns. Everything that is returned in the <em>data</em> part
of the <em>result</em>  will, at the outermost level be an array. What is inside that array
could be a simple number or a string. It could also be a list of strings or other
objects including maps. If you plan to write some general purpose code that can
handle the different possible formats it is important to know what they look like. In
the examples that follow I have attempted to show several of the possible response
formats that you may encounter. I am mainly going to focus of the parts of the JSON
that follow the <em>data</em> key. Each example assumes that the query shown was sent to a
Gremlin Server using the HTTP protocol. As always, if you are unsure what JSON a
particular query may generate, you should always run some experiments to find out.</p>
</div>
<div class="paragraph">
<p>Please note that some of the queries that follow  may not represent the best way to
achieve the specific result. I have deliberately picked queries that show different
Gremlin steps to give you a feel for the type of JSON result each generates.</p>
</div>
<div class="sect3">
<h4 id="_no_result">7.8.1. No result</h4>
<div class="paragraph">
<p>The following query does not return any results. The JSON reflects this in the form
of the <em>data</em> returned being an empty list <em>"[]"</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SYD'</span><span class="tok-o">)</span>

<span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"e68ce6d6-29a0-4a70-af35-b4e8bb123458"</span><span class="tok-o">,</span>
 <span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span>
 <span class="tok-s2">"result"</span><span class="tok-o">:{</span><span class="tok-s2">"data"</span><span class="tok-o">:[],</span><span class="tok-s2">"meta"</span><span class="tok-o">:{}}}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_integer_result">7.8.2. Integer result</h4>
<div class="paragraph">
<p>A simple query that just returns a single integer result will generate JSON as shown
below. The <em>result</em> section of the JSON will contain a <em>data</em> section with the single
integer value encoded as a list with one member.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">()</span>

<span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"25fc4d45-3e58-4f72-99b1-fe1c6575fdd0"</span><span class="tok-o">,</span>
 <span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span>
 <span class="tok-s2">"result"</span><span class="tok-o">:{</span><span class="tok-s2">"data"</span><span class="tok-o">:[</span><span class="tok-mi">3624</span><span class="tok-o">],</span><span class="tok-s2">"meta"</span><span class="tok-o">:{}}}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_string_result">7.8.3. String result</h4>
<div class="paragraph">
<p>As with integer results, a query that just returns a single string  result will
generate JSON as shown below. The <em>result</em> section of the JSON will contain a <em>data</em>
section with the single string value encoded as a list with one member.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">)</span>

<span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"0ae1e2af-adea-487c-b365-7ef76bb56791"</span><span class="tok-o">,</span>
 <span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span>
 <span class="tok-s2">"result"</span><span class="tok-o">:{</span><span class="tok-s2">"data"</span><span class="tok-o">:[</span><span class="tok-s2">"Dallas"</span><span class="tok-o">],</span><span class="tok-s2">"meta"</span><span class="tok-o">:{}}}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_list_of_strings">7.8.4. List of strings</h4>
<div class="paragraph">
<p>The query below generates a <em>data</em> array containing a list of strings representing
airport codes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"264cbaf8-6679-43b0-936c-f65b9f6fd0ed"</span><span class="tok-o">,</span>
<span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span>
<span class="tok-s2">"result"</span><span class="tok-o">:{</span><span class="tok-s2">"data"</span><span class="tok-o">:[</span><span class="tok-s2">"PHX"</span><span class="tok-o">,</span><span class="tok-s2">"DFW"</span><span class="tok-o">,</span><span class="tok-s2">"LAX"</span><span class="tok-o">,</span><span class="tok-s2">"DEN"</span><span class="tok-o">],</span><span class="tok-s2">"meta"</span><span class="tok-o">:{}}}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_list_of_integers">7.8.5. List of integers</h4>
<div class="paragraph">
<p>The query below generates a <em>data</em> array containing a list of integers representing
runway counts. Note that in reality you would not use a <em>sack</em> for this, a simple
<em>values</em> step will generate the same results, but I wanted to show an example that
uses a <em>sack</em> step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">withSack</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">).</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">sack</span><span class="tok-o">(</span><span class="tok-n">sum</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'runways'</span><span class="tok-o">).</span><span class="tok-na">sack</span><span class="tok-o">()</span>

<span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"23598951-ffa4-440d-910f-eebc6d5f620a"</span><span class="tok-o">,</span>
 <span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span>
 <span class="tok-s2">"result"</span><span class="tok-o">:{</span><span class="tok-s2">"data"</span><span class="tok-o">:[</span><span class="tok-mi">3</span><span class="tok-o">,</span><span class="tok-mi">7</span><span class="tok-o">,</span><span class="tok-mi">4</span><span class="tok-o">,</span><span class="tok-mi">6</span><span class="tok-o">],</span><span class="tok-s2">"meta"</span><span class="tok-o">:{}}}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_list_of_mixed_types">7.8.6. List of mixed types</h4>
<div class="paragraph">
<p>It is common for a query result to contain a variety of different data types. The
example below generates a list containing a string, and integer and a double. Note,
as we have seen before, TinkerPop does not guarantee the order in which results are
returned so do not create any dependencies on that.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LGW'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'city'</span><span class="tok-o">,</span><span class="tok-s1">'lat'</span><span class="tok-o">,</span><span class="tok-s1">'runways'</span><span class="tok-o">)</span>

<span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"6043ce66-221b-49b8-a3f9-6131eef3b9c2"</span><span class="tok-o">,</span>
 <span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span>
 <span class="tok-s2">"result"</span><span class="tok-o">:{</span><span class="tok-s2">"data"</span><span class="tok-o">:[</span><span class="tok-s2">"London"</span><span class="tok-o">,</span><span class="tok-mi">2</span><span class="tok-o">,</span><span class="tok-mf">51.1481018066406</span><span class="tok-o">],</span><span class="tok-s2">"meta"</span><span class="tok-o">:{}}}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_value_map">7.8.7. Value map</h4>
<div class="paragraph">
<p>As you might expect, when a <em>valueMap</em> is used to generate the result from a query,
the JSON generated also contains a map. Note how each property value is encoded in a
list even if there is only one value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'CDG'</span><span class="tok-o">).</span><span class="tok-na">valueMap</span><span class="tok-o">()</span>

<span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"c989a182-aa97-4ed7-bddb-7f0e3ad237d6"</span><span class="tok-o">,</span>
    <span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span>
    <span class="tok-s2">"result"</span><span class="tok-o">:{</span><span class="tok-s2">"data"</span><span class="tok-o">:[{</span>
       <span class="tok-s2">"country"</span><span class="tok-o">:[</span><span class="tok-s2">"FR"</span><span class="tok-o">],</span>
          <span class="tok-s2">"code"</span><span class="tok-o">:[</span><span class="tok-s2">"CDG"</span><span class="tok-o">],</span>
       <span class="tok-s2">"longest"</span><span class="tok-o">:[</span><span class="tok-mi">13829</span><span class="tok-o">],</span>
          <span class="tok-s2">"city"</span><span class="tok-o">:[</span><span class="tok-s2">"Paris"</span><span class="tok-o">],</span>
          <span class="tok-s2">"elev"</span><span class="tok-o">:[</span><span class="tok-mi">392</span><span class="tok-o">],</span>
          <span class="tok-s2">"icao"</span><span class="tok-o">:[</span><span class="tok-s2">"LFPG"</span><span class="tok-o">],</span>
           <span class="tok-s2">"lon"</span><span class="tok-o">:[</span><span class="tok-mf">2.54999995232</span><span class="tok-o">],</span>
          <span class="tok-s2">"type"</span><span class="tok-o">:[</span><span class="tok-s2">"airport"</span><span class="tok-o">],</span>
        <span class="tok-s2">"region"</span><span class="tok-o">:[</span><span class="tok-s2">"FR-J"</span><span class="tok-o">],</span>
       <span class="tok-s2">"runways"</span><span class="tok-o">:[</span><span class="tok-mi">4</span><span class="tok-o">],</span>
           <span class="tok-s2">"lat"</span><span class="tok-o">:[</span><span class="tok-mf">49.0127983093</span><span class="tok-o">],</span>
          <span class="tok-s2">"desc"</span><span class="tok-o">:[</span><span class="tok-s2">"Paris Charles de Gaulle"</span><span class="tok-o">]}],</span><span class="tok-s2">"meta"</span><span class="tok-o">:{}}}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_single_vertex">7.8.8. Single vertex</h4>
<div class="paragraph">
<p>When your query returns a vertex, unlike in the Gremlin Console where you would get
back something like "<em>v[51]</em>" when talking to the Gremlin Server what you get back is
a JSON object representing everything that is known about the vertex including its ID
, label, properties and the ID of each property. If you do not need the entire vertex
returned it might be worth writing your query in a way such that you only get back
the properties that you are interested in. This is especially pertinent if your
query could potentially return a lot of vertices in the result.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'CDG'</span><span class="tok-o">)</span>

<span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"a70cab32-73a5-492f-a00b-0c7d66485b18"</span><span class="tok-o">,</span>
    <span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span>
    <span class="tok-s2">"result"</span><span class="tok-o">:{</span><span class="tok-s2">"data"</span><span class="tok-o">:</span>
       <span class="tok-o">[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-mi">69736</span><span class="tok-o">,</span>
      <span class="tok-s2">"label"</span><span class="tok-o">:</span><span class="tok-s2">"airport"</span><span class="tok-o">,</span>
      <span class="tok-s2">"type"</span><span class="tok-o">:</span><span class="tok-s2">"vertex"</span><span class="tok-o">,</span>
<span class="tok-s2">"properties"</span><span class="tok-o">:</span>
     <span class="tok-o">{</span><span class="tok-s2">"country"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"2e4t-1ht4-8p1"</span><span class="tok-o">,</span> <span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"FR"</span><span class="tok-o">}],</span>
         <span class="tok-s2">"code"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"2ej1-1ht4-5j9"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"CDG"</span><span class="tok-o">}],</span>
      <span class="tok-s2">"longest"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"2ex9-1ht4-mx1"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-mi">13829</span><span class="tok-o">}],</span>
         <span class="tok-s2">"city"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"2fbh-1ht4-7wl"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"Paris"</span><span class="tok-o">}],</span>
         <span class="tok-s2">"elev"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"2fpp-1ht4-but"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-mi">392</span><span class="tok-o">}],</span>
         <span class="tok-s2">"icao"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"2g3x-1ht4-6bp"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"LFPG"</span><span class="tok-o">}],</span>
         <span class="tok-s2">" lon"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"2gi5-1ht4-dfp"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-mf">2.54999995232</span><span class="tok-o">}],</span>
         <span class="tok-s2">"type"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"2gwd-1ht4-745"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"airport"</span><span class="tok-o">}],</span>
       <span class="tok-s2">"region"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"2hal-1ht4-9hh"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"FR-J"</span><span class="tok-o">}],</span>
      <span class="tok-s2">"runways"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"2hot-1ht4-b2d"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-mi">4</span><span class="tok-o">}],</span>
          <span class="tok-s2">"lat"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"2i31-1ht4-cn9"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-mf">49.0127983093</span><span class="tok-o">}],</span>
         <span class="tok-s2">"desc"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"2ih9-1ht4-a9x"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"Paris Charles de Gaulle"</span><span class="tok-o">}]}}],</span>
    <span class="tok-s2">"meta"</span><span class="tok-o">:{}}}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_selected_vertex_information">7.8.9. Selected vertex information</h4>
<div class="paragraph">
<p>One way to limit the amount of JSON we get back is shown below. Let’s assume for a
selection of airport vertices, all we are interested in is the ID, airport code and
city name. We can construct a query, as shown below, that will return just those
values for each vertex.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">hasLabel</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">sample</span><span class="tok-o">(</span><span class="tok-mi">3</span><span class="tok-o">).</span>
      <span class="tok-n">union</span><span class="tok-o">(</span><span class="tok-n">id</span><span class="tok-o">(),</span><span class="tok-n">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'city'</span><span class="tok-o">))</span>

<span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"4d308287-9725-4fa6-8c2b-b7e517ca5009"</span><span class="tok-o">,</span>
 <span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span>
 <span class="tok-s2">"result"</span><span class="tok-o">:{</span><span class="tok-s2">"data"</span><span class="tok-o">:[</span><span class="tok-mi">45096</span><span class="tok-o">,</span><span class="tok-s2">"SCL"</span><span class="tok-o">,</span><span class="tok-s2">"Santiago"</span><span class="tok-o">,</span>
                  <span class="tok-mi">610336</span><span class="tok-o">,</span><span class="tok-s2">"YWK"</span><span class="tok-o">,</span><span class="tok-s2">"Wabush"</span><span class="tok-o">,</span>
                  <span class="tok-mi">163880</span><span class="tok-o">,</span><span class="tok-s2">"CAK"</span><span class="tok-o">,</span><span class="tok-s2">"Akron"</span><span class="tok-o">],</span><span class="tok-s2">"meta"</span><span class="tok-o">:{}}}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_single_edge">7.8.10. Single edge</h4>
<div class="paragraph">
<p>Just as when we queried a single vertex, when we query a single edge, we get back a
lot of information including its label and ID and information about the vertices the
edge is connected to.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)</span>

<span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"cac0a975-33a0-4714-a797-1be782201a27"</span><span class="tok-o">,</span>
 <span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span>
 <span class="tok-s2">"result"</span><span class="tok-o">:{</span><span class="tok-s2">"data"</span><span class="tok-o">:[{</span><span class="tok-s2">"</span>
<span class="tok-s2">        id"</span><span class="tok-o">:</span><span class="tok-s2">"2xhcd-1560-pat-39s"</span><span class="tok-o">,</span>
    <span class="tok-s2">"label"</span><span class="tok-o">:</span><span class="tok-s2">"route"</span><span class="tok-o">,</span>
     <span class="tok-s2">"type"</span><span class="tok-o">:</span><span class="tok-s2">"edge"</span><span class="tok-o">,</span><span class="tok-s2">"inVLabel"</span><span class="tok-o">:</span><span class="tok-s2">"airport"</span><span class="tok-o">,</span>
                  <span class="tok-s2">"outVLabel"</span><span class="tok-o">:</span><span class="tok-s2">"airport"</span><span class="tok-o">,</span><span class="tok-s2">"</span>
<span class="tok-s2">                         inV"</span><span class="tok-o">:</span><span class="tok-mi">4240</span><span class="tok-o">,</span>
                       <span class="tok-s2">"outV"</span><span class="tok-o">:</span><span class="tok-mi">53352</span><span class="tok-o">,</span>
                 <span class="tok-s2">"properties"</span><span class="tok-o">:{</span><span class="tok-s2">"dist"</span><span class="tok-o">:</span><span class="tok-mi">369</span><span class="tok-o">}}],</span><span class="tok-s2">"meta"</span><span class="tok-o">:{}}}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_new_vertex">7.8.11. New vertex</h4>
<div class="paragraph">
<p>When a new vertex and some properties are added the returned JSON will contain all of
the information about the vertex including its ID, label and type as well as its
properties.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">addV</span><span class="tok-o">(</span><span class="tok-s1">'test'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'fruit'</span><span class="tok-o">,</span><span class="tok-s1">'apple'</span><span class="tok-o">)</span>

<span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"accd4354-0db9-417d-927f-c0945e1721dc"</span><span class="tok-o">,</span>
 <span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span>
 <span class="tok-s2">"result"</span><span class="tok-o">:{</span><span class="tok-s2">"data"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-mi">4248</span><span class="tok-o">,</span>
          <span class="tok-s2">"label"</span><span class="tok-o">:</span><span class="tok-s2">"test"</span><span class="tok-o">,</span>
           <span class="tok-s2">"type"</span><span class="tok-o">:</span><span class="tok-s2">"vertex"</span><span class="tok-o">,</span>
     <span class="tok-s2">"properties"</span><span class="tok-o">:{</span><span class="tok-s2">"fruit"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"177-3a0-28lh"</span><span class="tok-o">,</span>
                          <span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"apple"</span><span class="tok-o">}]}}],</span><span class="tok-s2">"meta"</span><span class="tok-o">:{}}}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_new_vertex_only_returning_the_id">7.8.12. New vertex only returning the ID</h4>
<div class="paragraph">
<p>When adding a new vertex, if you are not really interested in getting back the entire
new vertex and its properties, you can write the query to only return the ID of the
new vertex as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">addV</span><span class="tok-o">(</span><span class="tok-s1">'test'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'fruit'</span><span class="tok-o">,</span><span class="tok-s1">'apple'</span><span class="tok-o">).</span><span class="tok-na">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">id</span><span class="tok-o">()</span>

<span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"c50d0fa7-5caa-4294-8eca-310f032b1c42"</span><span class="tok-o">,</span>
 <span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span>
 <span class="tok-s2">"result"</span><span class="tok-o">:{</span><span class="tok-s2">"data"</span><span class="tok-o">:[</span><span class="tok-mi">8344</span><span class="tok-o">],</span><span class="tok-s2">"meta"</span><span class="tok-o">:{}}}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_path_by_value_list_of_strings">7.8.13. Path by value (list of strings)</h4>
<div class="paragraph">
<p>The query below returns a path between two airports as a list of airport codes.
Note the new <em>objects</em> key that is used when the returned JSON represents a path.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)</span>

<span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"b9a1655f-1b14-4313-96d0-085858f47de7"</span><span class="tok-o">,</span>
 <span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span>
 <span class="tok-s2">"result"</span><span class="tok-o">:{</span><span class="tok-s2">"data"</span><span class="tok-o">:[{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[],[]],</span>
                   <span class="tok-s2">"objects"</span><span class="tok-o">:[</span><span class="tok-s2">"SAF"</span><span class="tok-o">,</span><span class="tok-s2">"PHX"</span><span class="tok-o">]}],</span><span class="tok-s2">"meta"</span><span class="tok-o">:{}}}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_path_by_values_list_of_strings_and_integers">7.8.14. Path by values (list of strings and integers)</h4>
<div class="paragraph">
<p>Similar to the previous query but this time the path also includes the distance
between the airports.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'dist'</span><span class="tok-o">).</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)</span>


<span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"c4eb3141-be1e-4335-aa04-50843f73838b"</span><span class="tok-o">,</span>
    <span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span>
    <span class="tok-s2">"result"</span><span class="tok-o">:{</span><span class="tok-s2">"data"</span><span class="tok-o">:[{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[],[],[]],</span>
                      <span class="tok-s2">"objects"</span><span class="tok-o">:[</span><span class="tok-s2">"SAF"</span><span class="tok-o">,</span><span class="tok-mi">369</span><span class="tok-o">,</span><span class="tok-s2">"PHX"</span><span class="tok-o">]}],</span><span class="tok-s2">"meta"</span><span class="tok-o">:{}}}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_two_vertex_path">7.8.15. Two vertex path</h4>
<div class="paragraph">
<p>The query below returns a path but does not include a <em>by</em> modulator so what is
returned is the two vertices along with their IDs, labels and properties.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)</span>

<span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"bcdc3113-d1f6-41cf-b2ad-b1409646677e"</span><span class="tok-o">,</span>
    <span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span>
    <span class="tok-s2">"result"</span><span class="tok-o">:{</span><span class="tok-s2">"data"</span><span class="tok-o">:[{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[],[]],</span>
           <span class="tok-s2">"objects"</span><span class="tok-o">:[{</span>
              <span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-mi">53352</span><span class="tok-o">,</span>
           <span class="tok-s2">"label"</span><span class="tok-o">:</span><span class="tok-s2">"airport"</span><span class="tok-o">,</span>
            <span class="tok-s2">"type"</span><span class="tok-o">:</span><span class="tok-s2">"vertex"</span><span class="tok-o">,</span>
      <span class="tok-s2">"properties"</span><span class="tok-o">:{</span>
         <span class="tok-s2">"country"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1s0d-1560-8p1"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"US"</span><span class="tok-o">}],</span>
             <span class="tok-s2">"code"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1sel-1560-5j9"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"SAF"</span><span class="tok-o">}],</span>
          <span class="tok-s2">"longest"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1sst-1560-mx1"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-mi">8366</span><span class="tok-o">}],</span>
             <span class="tok-s2">"city"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1t71-1560-7wl"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"Santa Fe"</span><span class="tok-o">}],</span>
             <span class="tok-s2">"elev"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1tl9-1560-but"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-mi">6348</span><span class="tok-o">}],</span>
             <span class="tok-s2">"icao"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1tzh-1560-6bp"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"KSAF"</span><span class="tok-o">}],</span>
              <span class="tok-s2">"lon"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1udp-1560-dfp"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:-</span><span class="tok-mf">106.088996887</span><span class="tok-o">}],</span>
             <span class="tok-s2">"type"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1urx-1560-745"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"airport"</span><span class="tok-o">}],</span>
           <span class="tok-s2">"region"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1v65-1560-9hh"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"US-NM"</span><span class="tok-o">}],</span>
          <span class="tok-s2">"runways"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1vkd-1560-b2d"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">}],</span>
              <span class="tok-s2">"lat"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1vyl-1560-cn9"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-mf">35.617099762</span><span class="tok-o">}],</span>
             <span class="tok-s2">"desc"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1wct-1560-a9x"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"Santa Fe"</span><span class="tok-o">}]}},</span>

             <span class="tok-o">{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-mi">4240</span><span class="tok-o">,</span>
           <span class="tok-s2">"label"</span><span class="tok-o">:</span><span class="tok-s2">"airport"</span><span class="tok-o">,</span>
            <span class="tok-s2">"type"</span><span class="tok-o">:</span><span class="tok-s2">"vertex"</span><span class="tok-o">,</span>
      <span class="tok-s2">"properties"</span><span class="tok-o">:{</span>
          <span class="tok-s2">"country"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"176-39s-8p1"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"US"</span><span class="tok-o">}],</span>
             <span class="tok-s2">"code"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1le-39s-5j9"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"PHX"</span><span class="tok-o">}],</span>
          <span class="tok-s2">"longest"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1zm-39s-mx1"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-mi">11489</span><span class="tok-o">}],</span>
             <span class="tok-s2">"city"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"2du-39s-7wl"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"Phoenix"</span><span class="tok-o">}],</span>
             <span class="tok-s2">"elev"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"2s2-39s-but"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-mi">1135</span><span class="tok-o">}],</span>
             <span class="tok-s2">"icao"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"36a-39s-6bp"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"KPHX"</span><span class="tok-o">}],</span>
              <span class="tok-s2">"lon"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"3ki-39s-dfp"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:-</span><span class="tok-mf">112.012001037598</span><span class="tok-o">}],</span>
             <span class="tok-s2">"type"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"3yq-39s-745"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"airport"</span><span class="tok-o">}],</span>
           <span class="tok-s2">"region"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"4cy-39s-9hh"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"US-AZ"</span><span class="tok-o">}],</span>
          <span class="tok-s2">"runways"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"4r6-39s-b2d"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">}],</span>
              <span class="tok-s2">"lat"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"55e-39s-cn9"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-mf">33.4342994689941</span><span class="tok-o">}],</span>
             <span class="tok-s2">"desc"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"5jm-39s-a9x"</span><span class="tok-o">,</span>
              <span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"Phoenix Sky Harbor International Airport"</span><span class="tok-o">}]}}]}],</span>
      <span class="tok-s2">"meta"</span><span class="tok-o">:{}}}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_path_with_two_vertices_and_an_edge">7.8.16. Path with two vertices and an edge</h4>
<div class="paragraph">
<p>The following query is similar to the previous one but also includes an edge. You can
hopefully see here how the JSON can rapidly get large if we are not more specific in
our queries about what results we really need back. Notice how, because this is a
path result, most of the data is contained inside an <em>objects</em> key.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">)</span>

<span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"171d0f30-2f93-4ae6-a421-4601a35388a2"</span><span class="tok-o">,</span>
 <span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span>
  <span class="tok-s2">"result"</span><span class="tok-o">:{</span><span class="tok-s2">"data"</span><span class="tok-o">:[{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[],[],[]],</span>
  <span class="tok-s2">"objects"</span><span class="tok-o">:[</span>
       <span class="tok-o">{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-mi">53352</span><span class="tok-o">,</span><span class="tok-s2">"label"</span><span class="tok-o">:</span><span class="tok-s2">"airport"</span><span class="tok-o">,</span><span class="tok-s2">"type"</span><span class="tok-o">:</span><span class="tok-s2">"vertex"</span><span class="tok-o">,</span>
       <span class="tok-s2">"properties"</span><span class="tok-o">:</span>
           <span class="tok-o">{</span><span class="tok-s2">"country"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1s0d-1560-8p1"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"US"</span><span class="tok-o">}],</span>
           <span class="tok-s2">"code"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1sel-1560-5j9"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"SAF"</span><span class="tok-o">}],</span>
           <span class="tok-s2">"longest"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1sst-1560-mx1"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-mi">8366</span><span class="tok-o">}],</span>
           <span class="tok-s2">"city"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1t71-1560-7wl"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"Santa Fe"</span><span class="tok-o">}],</span>
           <span class="tok-s2">"elev"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1tl9-1560-but"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-mi">6348</span><span class="tok-o">}],</span>
           <span class="tok-s2">"icao"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1tzh-1560-6bp"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"KSAF"</span><span class="tok-o">}],</span>
           <span class="tok-s2">"lon"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1udp-1560-dfp"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:-</span><span class="tok-mf">106.088996887</span><span class="tok-o">}],</span>
           <span class="tok-s2">"type"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1urx-1560-745"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"airport"</span><span class="tok-o">}],</span>
           <span class="tok-s2">"region"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1v65-1560-9hh"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"US-NM"</span><span class="tok-o">}],</span>
           <span class="tok-s2">"runways"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1vkd-1560-b2d"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">}],</span>
           <span class="tok-s2">"lat"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1vyl-1560-cn9"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-mf">35.617099762</span><span class="tok-o">}],</span>
           <span class="tok-s2">"desc"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1wct-1560-a9x"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"Santa Fe"</span><span class="tok-o">}]}},</span>

       <span class="tok-o">{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"2xhcd-1560-pat-39s"</span><span class="tok-o">,</span>
        <span class="tok-s2">"label"</span><span class="tok-o">:</span><span class="tok-s2">"route"</span><span class="tok-o">,</span>
        <span class="tok-s2">"type"</span><span class="tok-o">:</span><span class="tok-s2">"edge"</span><span class="tok-o">,</span>
        <span class="tok-s2">"inVLabel"</span><span class="tok-o">:</span><span class="tok-s2">"airport"</span><span class="tok-o">,</span>
        <span class="tok-s2">"outVLabel"</span><span class="tok-o">:</span><span class="tok-s2">"airport"</span><span class="tok-o">,</span>
        <span class="tok-s2">"inV"</span><span class="tok-o">:</span><span class="tok-mi">4240</span><span class="tok-o">,</span><span class="tok-s2">"outV"</span><span class="tok-o">:</span><span class="tok-mi">53352</span><span class="tok-o">,</span>
            <span class="tok-s2">"properties"</span><span class="tok-o">:{</span><span class="tok-s2">"dist"</span><span class="tok-o">:</span><span class="tok-mi">369</span><span class="tok-o">}},</span>

       <span class="tok-o">{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-mi">4240</span><span class="tok-o">,</span><span class="tok-s2">"label"</span><span class="tok-o">:</span><span class="tok-s2">"airport"</span><span class="tok-o">,</span><span class="tok-s2">"type"</span><span class="tok-o">:</span><span class="tok-s2">"vertex"</span><span class="tok-o">,</span>
       <span class="tok-s2">"properties"</span><span class="tok-o">:</span>
           <span class="tok-o">{</span><span class="tok-s2">"country"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"176-39s-8p1"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"US"</span><span class="tok-o">}],</span>
            <span class="tok-s2">"code"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1le-39s-5j9"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"PHX"</span><span class="tok-o">}],</span>
            <span class="tok-s2">"longest"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"1zm-39s-mx1"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-mi">11489</span><span class="tok-o">}],</span>
            <span class="tok-s2">"city"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"2du-39s-7wl"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"Phoenix"</span><span class="tok-o">}],</span>
            <span class="tok-s2">"elev"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"2s2-39s-but"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-mi">1135</span><span class="tok-o">}],</span>
            <span class="tok-s2">"icao"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"36a-39s-6bp"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"KPHX"</span><span class="tok-o">}],</span>
            <span class="tok-s2">"lon"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"3ki-39s-dfp"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:-</span><span class="tok-mf">112.012001037598</span><span class="tok-o">}],</span>
            <span class="tok-s2">"type"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"3yq-39s-745"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"airport"</span><span class="tok-o">}],</span>
            <span class="tok-s2">"region"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"4cy-39s-9hh"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"US-AZ"</span><span class="tok-o">}],</span>
            <span class="tok-s2">"runways"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"4r6-39s-b2d"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-o">}],</span>
            <span class="tok-s2">"lat"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"55e-39s-cn9"</span><span class="tok-o">,</span><span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-mf">33.4342994689941</span><span class="tok-o">}],</span>
            <span class="tok-s2">"desc"</span><span class="tok-o">:[{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"5jm-39s-a9x"</span><span class="tok-o">,</span>
              <span class="tok-s2">"value"</span><span class="tok-o">:</span><span class="tok-s2">"Phoenix Sky Harbor International Airport"</span><span class="tok-o">}]}}]}],</span>
      <span class="tok-s2">"meta"</span><span class="tok-o">:{}}}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_selection_map">7.8.17. Selection map</h4>
<div class="paragraph">
<p>If a query ends with a <em>select</em> step that references labels defined earlier in the
query, what is returned is a map where the labels are the keys and the values are the
things that the labels were attached to in the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">).</span><span class="tok-na">out</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'b'</span><span class="tok-o">).</span>
      <span class="tok-n">select</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">)</span>

<span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"af8de8e6-4137-4378-bb31-921e134d0661"</span><span class="tok-o">,</span>
 <span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span>
 <span class="tok-s2">"result"</span><span class="tok-o">:{</span><span class="tok-s2">"data"</span><span class="tok-o">:[{</span><span class="tok-s2">"a"</span><span class="tok-o">:</span><span class="tok-s2">"SAF"</span><span class="tok-o">,</span><span class="tok-s2">"b"</span><span class="tok-o">:</span><span class="tok-s2">"DFW"</span><span class="tok-o">}],</span><span class="tok-s2">"meta"</span><span class="tok-o">:{}}}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_projected_map">7.8.18. Projected map</h4>
<div class="paragraph">
<p>The <em>project</em> step also generates a map just as the <em>select</em> step did in the previous
example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LGW'</span><span class="tok-o">).</span><span class="tok-na">project</span><span class="tok-o">(</span><span class="tok-s1">'a'</span><span class="tok-o">,</span><span class="tok-s1">'b'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">out</span><span class="tok-o">().</span><span class="tok-na">count</span><span class="tok-o">())</span>


<span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"57819d0b-c27e-40d7-a89a-e69a6b4872a1"</span><span class="tok-o">,</span>
 <span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span>
 <span class="tok-s2">"result"</span><span class="tok-o">:{</span><span class="tok-s2">"data"</span><span class="tok-o">:[{</span><span class="tok-s2">"a"</span><span class="tok-o">:</span><span class="tok-s2">"LGW"</span><span class="tok-o">,</span><span class="tok-s2">"b"</span><span class="tok-o">:</span><span class="tok-mi">204</span><span class="tok-o">}],</span><span class="tok-s2">"meta"</span><span class="tok-o">:{}}}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_strings_and_a_map">7.8.19. Strings and a map</h4>
<div class="paragraph">
<p>The following path query returns a list containing two strings representing airport
codes and the full JSON object representing an edge.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'SAF'</span><span class="tok-o">).</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">limit</span><span class="tok-o">(</span><span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">()</span>

<span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"5102bb14-e594-41ec-8643-89882377b1e7"</span><span class="tok-o">,</span>
 <span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span>
 <span class="tok-s2">"result"</span><span class="tok-o">:{</span><span class="tok-s2">"data"</span><span class="tok-o">:[{</span><span class="tok-s2">"labels"</span><span class="tok-o">:[[],[],[]],</span>
           <span class="tok-s2">"objects"</span><span class="tok-o">:[</span><span class="tok-s2">"SAF"</span><span class="tok-o">,</span>
                      <span class="tok-o">{</span><span class="tok-s2">"id"</span><span class="tok-o">:</span><span class="tok-s2">"2xhcd-1560-pat-39s"</span><span class="tok-o">,</span>
                      <span class="tok-s2">"label"</span><span class="tok-o">:</span><span class="tok-s2">"route"</span><span class="tok-o">,</span>
                      <span class="tok-s2">"type"</span><span class="tok-o">:</span><span class="tok-s2">"edge"</span><span class="tok-o">,</span>
                      <span class="tok-s2">"inVLabel"</span><span class="tok-o">:</span><span class="tok-s2">"airport"</span><span class="tok-o">,</span>
                      <span class="tok-s2">"outVLabel"</span><span class="tok-o">:</span><span class="tok-s2">"airport"</span><span class="tok-o">,</span>
                      <span class="tok-s2">"inV"</span><span class="tok-o">:</span><span class="tok-mi">4240</span><span class="tok-o">,</span>
                      <span class="tok-s2">"outV"</span><span class="tok-o">:</span><span class="tok-mi">53352</span><span class="tok-o">,</span>
                      <span class="tok-s2">"properties"</span><span class="tok-o">:{</span><span class="tok-s2">"dist"</span><span class="tok-o">:</span><span class="tok-mi">369</span><span class="tok-o">}},</span>
                      <span class="tok-s2">"PHX"</span><span class="tok-o">]}],</span><span class="tok-s2">"meta"</span><span class="tok-o">:{}}}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_nested_lists">7.8.20. Nested lists</h4>
<div class="paragraph">
<p>When using the console or issuing Gremlin commands via the TinkerPop API from an
application program, ending a query with a <em>fold</em> step can be a nice way to put all
the results into a list. When working with a Gremlin Server, ending a query with a
<em>fold</em> step in many cases is redundant as the results will be placed in a list inside
the JSON anyway. In the example below, the <em>fold</em> step simply caused an extra list to
be nested inside the one that was generated while the JSON was being assembled.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">has</span><span class="tok-o">(</span><span class="tok-s1">'region'</span><span class="tok-o">,</span><span class="tok-s1">'US-OK'</span><span class="tok-o">).</span><span class="tok-na">values</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">fold</span><span class="tok-o">()</span>


<span class="tok-o">{</span><span class="tok-s2">"requestId"</span><span class="tok-o">:</span><span class="tok-s2">"edcea305-086d-4f8d-b79a-ff72c5a26847"</span><span class="tok-o">,</span>
 <span class="tok-s2">"status"</span><span class="tok-o">:{</span><span class="tok-s2">"message"</span><span class="tok-o">:</span><span class="tok-s2">""</span><span class="tok-o">,</span><span class="tok-s2">"code"</span><span class="tok-o">:</span><span class="tok-mi">200</span><span class="tok-o">,</span><span class="tok-s2">"attributes"</span><span class="tok-o">:{}},</span>
 <span class="tok-s2">"result"</span><span class="tok-o">:{</span><span class="tok-s2">"data"</span><span class="tok-o">:[[</span><span class="tok-s2">"OKC"</span><span class="tok-o">,</span><span class="tok-s2">"TUL"</span><span class="tok-o">,</span><span class="tok-s2">"LAW"</span><span class="tok-o">,</span><span class="tok-s2">"SWO"</span><span class="tok-o">]],</span><span class="tok-s2">"meta"</span><span class="tok-o">:{}}}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="serialize">8. COMMON GRAPH SERIALIZATION FORMATS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are a number of ways that graph data can be stored in a file. In this section I
have provided a brief overview of a few of them. As you will see there are a number
of ways you can represent graph data using simple CSV files. There are also XML
format, JSON formats and many more. Of these, the one that still seems to be
supported across most tools and platforms is GraphML. Not all of the features offered
by Apache TinkerPop can be expressed using GraphML however. So let’s take a look at
some of the more commonly used formats.</p>
</div>
<div class="sect2">
<h3 id="csv">8.1. Comma Separated Values (CSV)</h3>
<div class="paragraph">
<p>There are a number of ways that a graph can be stored using CSV files. There is no
single preferred format that I am aware of. However, a common and convenient way,
especially when vertices contain lots of properties is to use two CSV files. One will
contain all of the vertex data and the other will contain all of the edge data.</p>
</div>
<div class="sect3">
<h4 id="csvair">8.1.1. Using two CSV files to represent the air-routes data</h4>
<div class="paragraph">
<p>If we were to store the airport data from the <em>air-routes</em> graph in CSV format we might
do something like the example below. Note that to improve readability I have not
included every property (or indeed every airport) in this example. Notice how each
vertex has a unique ID assigned. This is important as when we define the edges we will
need the vertex IDs to build the connections.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>"ID","LABEL","CODE","IATA","CITY","REGION","RUNWAYS","LONGEST","ELEV","COUNTRY"
"1","airport","ATL","KATL","Atlanta","US-GA","5","12390","1026","US"
"2","airport","ANC","PANC","Anchorage","US-AK","3","12400","151","US"
"3","airport","AUS","KAUS","Austin","Austin","US-TX","2","12250","542","US"
"4","airport","BNA","KBNA","Nashville","US-TN","4","11030","599","US"
"5","airport","BOS","KBOS","Boston","US-MA","6","10083","19","US"
"6","airport","BWI","KBWI","Baltimore","US-MD","3","10502","143","US"
"7","airport","DCA","KDCA","Washington D.C.","US-DC","3","7169","14","US"
"8","airport","DFW","KDFW","Dallas Ft. Worth","US-TX","7","13401","607","US"
"9","airport","FLL","KFLL","Fort Lauderdale","US-FL","2","9000","64","US"</pre>
</div>
</div>
<div class="paragraph">
<p>For the route data, the edges in our graph, we might use a format like the one below.
I did not include an edge ID as we typically let the graph system assign those. For
completeness I did include a label however when every edge is of the same type you
could choose to leave this out so long as the program ingesting the data knew what
label to assign. Most graph systems require edges to have a label even if it is
optional for vertices. This is equally true for the airport data. However, in cases
where vertices and edges within the same CSV file are of different types then clearly
for those cases it is best to always include the label for each entry.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>"LABEL","FROM","TO","DIST"
"route",1,3,811
"route",1,4,214
"route",2,8,3036
"route",3,4,755
"route",4,6,586
"route",5,1,945</pre>
</div>
</div>
<div class="paragraph">
<p>Some graph systems provide ingestion tools that, when presented with a CSV file like
the ones we have shown here can figure out how to process them and build a graph.
However, in many other situations you may also find yourself writing your own scripts
or small programs to do it.</p>
</div>
<div class="paragraph">
<p>I often find myself writing Ruby or Groovy scripts that can generate CSV or GraphML
files so that a graph system can ingest them. In some cases I have used scripts to
take CSV or GraphML data and generate the Gremlin statements that would create the
graph. This is very similar to another common practice, namely, using a  script to
generate <em>INSERT</em> statements when working with SQL databases.</p>
</div>
<div class="paragraph">
<p>I have also written Java and Groovy programs that will read the CSV file and use the
TinkerPop API or the Gremlin Server REST API to insert vertices and edges into a graph.
If you work with graph systems for a while you will probably find yourself also doing
similar things.</p>
</div>
</div>
<div class="sect3">
<h4 id="_adjacency_matrix_format">8.1.2. Adjacency matrix format</h4>
<div class="paragraph">
<p>The examples shown above of how a CSV file can be used to store data about vertices and
edges presents a convenient way to do it. However, this is by no means the only way
you could do it. For graphs that do not contain properties you could lay the graph
out using an <em>adjacency matrix</em> as shown below. The letters represent the vertex labels
and a 1 indicates there is an edge between them and a zero indicates no edge. This
format can be useful if your vertices and edges do not have properties and if the graph is
small but in general is not a great way to try and represent large graphs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>A,B,C,D,E,F,G
A,0,1,1,0,1,0,1
B,1,0,0,1,0,1,0
C,1,1,0,1,1,0,1
D,0,1,1,0,1,0,1
E,0,0,0,1,0,1,0
F,1,1,0,1,0,0,1
G,1,1,1,0,1,1,0</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adjacency_list_format">8.1.3. Adjacency List format</h4>
<div class="paragraph">
<p>The adjacency matrix shown above could also be represented as an <em>adjacency list</em>. In
this case, the first column of each row represents a vertex. The remaining parts of
each row represent all of the other vertices that this vertex is connected to.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>A,C,D,F,G
B,A,D,F
C,A,B,D,E,1
D,B,C,E,G
E,D,E
F,A,B,D,G
G,A,B,C,E,F</pre>
</div>
</div>
<div class="paragraph">
<p>While this is a simple example, it is possible to represent a more complex graph such
as the <em>air-routes</em> graph in this way. We could build a more complex CSV file where the
vertex and its properties are listed first, followed by all of the other vertices it
connects to and the properties for those edges.</p>
</div>
<div class="paragraph">
<p>Some graph database systems actually store their graphs to disk using a variation of
this format. JanusGraph in fact uses a system a lot like this when storing vertex and
edge data to its persistent store.</p>
</div>
</div>
<div class="sect3">
<h4 id="_edge_list_format">8.1.4. Edge List format</h4>
<div class="paragraph">
<p>When using an <em>edge list</em> format, each line represents an edge. So our simple example
could be represented as follows. Only a few edges are shown.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>A,C
A,D
A,F
A,G
B,A
B,D
B,F
C,A
C,B</pre>
</div>
</div>
<div class="paragraph">
<p>There are many ways you could construct an edge list. By way of another simple
example we could represent routes in the <em>air-routes</em> graph in a format similar to that
shown below. In this case we also include the label of the edge between each of the
vertices. The vertices are represented by their ID value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[1,route,623]
[1,route,624]
[1,route,625]
[1,route,626]
[1,route,627]
[1,route,628]
[1,route,629]
[1,route,630]
[1,route,631]
[1,route,632]</pre>
</div>
</div>
<div class="paragraph">
<p>If you wanted to export a very simple version of the <em>air-routes</em> graph, using just the
airport IATA codes and the edge labels you could write a Gremlin query to do it for
you as follows. Only the first 10 results returned are shown.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">label</span><span class="tok-o">)</span>

<span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">route</span><span class="tok-o">,</span><span class="tok-n">MBS</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">route</span><span class="tok-o">,</span><span class="tok-n">MCN</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">route</span><span class="tok-o">,</span><span class="tok-n">MEI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">route</span><span class="tok-o">,</span><span class="tok-n">MLB</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">route</span><span class="tok-o">,</span><span class="tok-n">MSL</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">route</span><span class="tok-o">,</span><span class="tok-n">PHF</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">route</span><span class="tok-o">,</span><span class="tok-n">PIB</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">route</span><span class="tok-o">,</span><span class="tok-n">SBN</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">route</span><span class="tok-o">,</span><span class="tok-n">TRI</span><span class="tok-o">]</span>
<span class="tok-o">[</span><span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">route</span><span class="tok-o">,</span><span class="tok-n">TTN</span><span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
There is a sample program called GraphFromCSV.java in the sample programs folder
that shows how to read a CSV file like the one above and create a graph from it.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>If you wanted to print the list without the containing square brackets you could take
advantage of the Java <em>forEachRemaining</em> method from the Iterator interface to add a
bit of post processing to the end of the query. Once again only the first 10 results
are shown.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">V</span><span class="tok-o">().</span><span class="tok-na">outE</span><span class="tok-o">().</span><span class="tok-na">inV</span><span class="tok-o">().</span><span class="tok-na">path</span><span class="tok-o">().</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">).</span><span class="tok-na">by</span><span class="tok-o">(</span><span class="tok-n">label</span><span class="tok-o">).</span>
      <span class="tok-n">forEachRemaining</span><span class="tok-o">{</span><span class="tok-n">println</span> <span class="tok-n">it</span><span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">]</span> <span class="tok-o">+</span> <span class="tok-s1">','</span> <span class="tok-o">+</span> <span class="tok-n">it</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">]</span> <span class="tok-o">+</span> <span class="tok-s1">','</span> <span class="tok-o">+</span> <span class="tok-n">it</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]}</span>

<span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">route</span><span class="tok-o">,</span><span class="tok-n">MBS</span>
<span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">route</span><span class="tok-o">,</span><span class="tok-n">MCN</span>
<span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">route</span><span class="tok-o">,</span><span class="tok-n">MEI</span>
<span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">route</span><span class="tok-o">,</span><span class="tok-n">MLB</span>
<span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">route</span><span class="tok-o">,</span><span class="tok-n">MSL</span>
<span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">route</span><span class="tok-o">,</span><span class="tok-n">PHF</span>
<span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">route</span><span class="tok-o">,</span><span class="tok-n">PIB</span>
<span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">route</span><span class="tok-o">,</span><span class="tok-n">SBN</span>
<span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">route</span><span class="tok-o">,</span><span class="tok-n">TRI</span>
<span class="tok-n">ATL</span><span class="tok-o">,</span><span class="tok-n">route</span><span class="tok-o">,</span><span class="tok-n">TTN</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_graphml">8.2. GraphML</h3>
<div class="paragraph">
<p>To be written</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span class="tok-cp">&lt;?xml version='1.0' ?&gt;</span>
<span class="tok-c">&lt;!-- ******************************************************* --&gt;</span>
<span class="tok-c">&lt;!-- Small sample taken from the air-routes.graphml file.    --&gt;</span>
<span class="tok-c">&lt;!-- ******************************************************* --&gt;</span>

<span class="tok-nt">&lt;graphml</span> <span class="tok-na">xmlns=</span><span class="tok-s">'http://graphml.graphdrawing.org/xmlns'</span><span class="tok-nt">&gt;</span>
  <span class="tok-nt">&lt;key</span> <span class="tok-na">id=</span><span class="tok-s">'type'</span>    <span class="tok-na">for=</span><span class="tok-s">'node'</span> <span class="tok-na">attr.name=</span><span class="tok-s">'type'</span>    <span class="tok-na">attr.type=</span><span class="tok-s">'string'</span><span class="tok-nt">&gt;&lt;/key&gt;</span>
  <span class="tok-nt">&lt;key</span> <span class="tok-na">id=</span><span class="tok-s">'code'</span>    <span class="tok-na">for=</span><span class="tok-s">'node'</span> <span class="tok-na">attr.name=</span><span class="tok-s">'code'</span>    <span class="tok-na">attr.type=</span><span class="tok-s">'string'</span><span class="tok-nt">&gt;&lt;/key&gt;</span>
  <span class="tok-nt">&lt;key</span> <span class="tok-na">id=</span><span class="tok-s">'icao'</span>    <span class="tok-na">for=</span><span class="tok-s">'node'</span> <span class="tok-na">attr.name=</span><span class="tok-s">'icao'</span>    <span class="tok-na">attr.type=</span><span class="tok-s">'string'</span><span class="tok-nt">&gt;&lt;/key&gt;</span>
  <span class="tok-nt">&lt;key</span> <span class="tok-na">id=</span><span class="tok-s">'desc'</span>    <span class="tok-na">for=</span><span class="tok-s">'node'</span> <span class="tok-na">attr.name=</span><span class="tok-s">'desc'</span>    <span class="tok-na">attr.type=</span><span class="tok-s">'string'</span><span class="tok-nt">&gt;&lt;/key&gt;</span>
  <span class="tok-nt">&lt;key</span> <span class="tok-na">id=</span><span class="tok-s">'region'</span>  <span class="tok-na">for=</span><span class="tok-s">'node'</span> <span class="tok-na">attr.name=</span><span class="tok-s">'region'</span>  <span class="tok-na">attr.type=</span><span class="tok-s">'string'</span><span class="tok-nt">&gt;&lt;/key&gt;</span>
  <span class="tok-nt">&lt;key</span> <span class="tok-na">id=</span><span class="tok-s">'runways'</span> <span class="tok-na">for=</span><span class="tok-s">'node'</span> <span class="tok-na">attr.name=</span><span class="tok-s">'runways'</span> <span class="tok-na">attr.type=</span><span class="tok-s">'int'</span><span class="tok-nt">&gt;&lt;/key&gt;</span>
  <span class="tok-nt">&lt;key</span> <span class="tok-na">id=</span><span class="tok-s">'longest'</span> <span class="tok-na">for=</span><span class="tok-s">'node'</span> <span class="tok-na">attr.name=</span><span class="tok-s">'longest'</span> <span class="tok-na">attr.type=</span><span class="tok-s">'int'</span><span class="tok-nt">&gt;&lt;/key&gt;</span>
  <span class="tok-nt">&lt;key</span> <span class="tok-na">id=</span><span class="tok-s">'elev'</span>    <span class="tok-na">for=</span><span class="tok-s">'node'</span> <span class="tok-na">attr.name=</span><span class="tok-s">'elev'</span>    <span class="tok-na">attr.type=</span><span class="tok-s">'int'</span><span class="tok-nt">&gt;&lt;/key&gt;</span>
  <span class="tok-nt">&lt;key</span> <span class="tok-na">id=</span><span class="tok-s">'country'</span> <span class="tok-na">for=</span><span class="tok-s">'node'</span> <span class="tok-na">attr.name=</span><span class="tok-s">'country'</span> <span class="tok-na">attr.type=</span><span class="tok-s">'string'</span><span class="tok-nt">&gt;&lt;/key&gt;</span>
  <span class="tok-nt">&lt;key</span> <span class="tok-na">id=</span><span class="tok-s">'city'</span>    <span class="tok-na">for=</span><span class="tok-s">'node'</span> <span class="tok-na">attr.name=</span><span class="tok-s">'city'</span>    <span class="tok-na">attr.type=</span><span class="tok-s">'string'</span><span class="tok-nt">&gt;&lt;/key&gt;</span>
  <span class="tok-nt">&lt;key</span> <span class="tok-na">id=</span><span class="tok-s">'lat'</span>     <span class="tok-na">for=</span><span class="tok-s">'node'</span> <span class="tok-na">attr.name=</span><span class="tok-s">'lat'</span>     <span class="tok-na">attr.type=</span><span class="tok-s">'double'</span><span class="tok-nt">&gt;&lt;/key&gt;</span>
  <span class="tok-nt">&lt;key</span> <span class="tok-na">id=</span><span class="tok-s">'lon'</span>     <span class="tok-na">for=</span><span class="tok-s">'node'</span> <span class="tok-na">attr.name=</span><span class="tok-s">'lon'</span>     <span class="tok-na">attr.type=</span><span class="tok-s">'double'</span><span class="tok-nt">&gt;&lt;/key&gt;</span>
  <span class="tok-nt">&lt;key</span> <span class="tok-na">id=</span><span class="tok-s">'dist'</span>    <span class="tok-na">for=</span><span class="tok-s">'edge'</span> <span class="tok-na">attr.name=</span><span class="tok-s">'dist'</span>    <span class="tok-na">attr.type=</span><span class="tok-s">'int'</span><span class="tok-nt">&gt;&lt;/key&gt;</span>
  <span class="tok-nt">&lt;key</span> <span class="tok-na">id=</span><span class="tok-s">'labelV'</span>  <span class="tok-na">for=</span><span class="tok-s">'node'</span> <span class="tok-na">attr.name=</span><span class="tok-s">'labelV'</span>  <span class="tok-na">attr.type=</span><span class="tok-s">'string'</span><span class="tok-nt">&gt;&lt;/key&gt;</span>
  <span class="tok-nt">&lt;key</span> <span class="tok-na">id=</span><span class="tok-s">'labelE'</span>  <span class="tok-na">for=</span><span class="tok-s">'edge'</span> <span class="tok-na">attr.name=</span><span class="tok-s">'labelE'</span>  <span class="tok-na">attr.type=</span><span class="tok-s">'string'</span><span class="tok-nt">&gt;&lt;/key&gt;</span>

  <span class="tok-nt">&lt;graph</span> <span class="tok-na">id=</span><span class="tok-s">'routes'</span> <span class="tok-na">edgedefault=</span><span class="tok-s">'directed'</span><span class="tok-nt">&gt;</span>

    <span class="tok-nt">&lt;node</span> <span class="tok-na">id=</span><span class="tok-s">'1'</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;data</span> <span class="tok-na">key=</span><span class="tok-s">'labelV'</span><span class="tok-nt">&gt;</span>airport<span class="tok-nt">&lt;/data&gt;</span>
    <span class="tok-nt">&lt;data</span> <span class="tok-na">key=</span><span class="tok-s">'type'</span><span class="tok-nt">&gt;</span>airport<span class="tok-nt">&lt;/data&gt;</span>
    <span class="tok-nt">&lt;data</span> <span class="tok-na">key=</span><span class="tok-s">'code'</span><span class="tok-nt">&gt;</span>ATL<span class="tok-nt">&lt;/data&gt;</span>
    <span class="tok-nt">&lt;data</span> <span class="tok-na">key=</span><span class="tok-s">'icao'</span><span class="tok-nt">&gt;</span>KATL<span class="tok-nt">&lt;/data&gt;</span>
    <span class="tok-nt">&lt;data</span> <span class="tok-na">key=</span><span class="tok-s">'city'</span><span class="tok-nt">&gt;</span>Atlanta<span class="tok-nt">&lt;/data&gt;</span>
    <span class="tok-nt">&lt;data</span> <span class="tok-na">key=</span><span class="tok-s">'desc'</span><span class="tok-nt">&gt;</span>Hartsfield - Jackson Atlanta International Airport<span class="tok-nt">&lt;/data&gt;</span>
    <span class="tok-nt">&lt;data</span> <span class="tok-na">key=</span><span class="tok-s">'region'</span><span class="tok-nt">&gt;</span>US-GA<span class="tok-nt">&lt;/data&gt;</span>
    <span class="tok-nt">&lt;data</span> <span class="tok-na">key=</span><span class="tok-s">'runways'</span><span class="tok-nt">&gt;</span>5<span class="tok-nt">&lt;/data&gt;</span>
    <span class="tok-nt">&lt;data</span> <span class="tok-na">key=</span><span class="tok-s">'longest'</span><span class="tok-nt">&gt;</span>12390<span class="tok-nt">&lt;/data&gt;</span>
    <span class="tok-nt">&lt;data</span> <span class="tok-na">key=</span><span class="tok-s">'elev'</span><span class="tok-nt">&gt;</span>1026<span class="tok-nt">&lt;/data&gt;</span>
    <span class="tok-nt">&lt;data</span> <span class="tok-na">key=</span><span class="tok-s">'country'</span><span class="tok-nt">&gt;</span>US<span class="tok-nt">&lt;/data&gt;</span>
    <span class="tok-nt">&lt;data</span> <span class="tok-na">key=</span><span class="tok-s">'lat'</span><span class="tok-nt">&gt;</span>33.6366996765137<span class="tok-nt">&lt;/data&gt;</span>
    <span class="tok-nt">&lt;data</span> <span class="tok-na">key=</span><span class="tok-s">'lon'</span><span class="tok-nt">&gt;</span>-84.4281005859375<span class="tok-nt">&lt;/data&gt;</span>
  <span class="tok-nt">&lt;/node&gt;</span>

  <span class="tok-nt">&lt;edge</span> <span class="tok-na">id=</span><span class="tok-s">'3610'</span> <span class="tok-na">source=</span><span class="tok-s">'1'</span> <span class="tok-na">target=</span><span class="tok-s">'3'</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;data</span> <span class="tok-na">key=</span><span class="tok-s">'labelE'</span><span class="tok-nt">&gt;</span>route<span class="tok-nt">&lt;/data&gt;</span>
    <span class="tok-nt">&lt;data</span> <span class="tok-na">key=</span><span class="tok-s">'dist'</span><span class="tok-nt">&gt;</span>811<span class="tok-nt">&lt;/data&gt;</span>
  <span class="tok-nt">&lt;/edge&gt;</span>

  <span class="tok-nt">&lt;/graph&gt;</span>
<span class="tok-nt">&lt;/graphml&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_graphson">8.3. GraphSON</h3>
<div class="paragraph">
<p>As discussed in the "<a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html#graphmlandjsonintro">Working with GraphML and GraphSON</a>" section, since TinkerPop 3.2.2 there
have been multiple versions of the GraphSON format. The original 1.0 version did not
contain any type information. Version 2.0 introduced the concept of including data
types within the JSON. As part of TinkerPop 3.3 GraphSON 3.0 was introduced to add a
few additional types. All three formats are still supported. The default is now
GraphSON 3.0.</p>
</div>
<div class="paragraph">
<p>To be written</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">graph</span><span class="tok-o">=</span><span class="tok-n">TinkerGraph</span><span class="tok-o">.</span><span class="tok-na">open</span><span class="tok-o">()</span>
<span class="tok-n">g</span><span class="tok-o">=</span><span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-na">traversal</span><span class="tok-o">()</span>
<span class="tok-n">g</span><span class="tok-o">.</span><span class="tok-na">addV</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'AUS'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'aus'</span><span class="tok-o">).</span>
  <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'DFW'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">).</span>
  <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'LAX'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'lax'</span><span class="tok-o">).</span>
  <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'JFK'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'jfk'</span><span class="tok-o">).</span>
  <span class="tok-n">addV</span><span class="tok-o">(</span><span class="tok-s1">'airport'</span><span class="tok-o">).</span><span class="tok-na">property</span><span class="tok-o">(</span><span class="tok-s1">'code'</span><span class="tok-o">,</span><span class="tok-s1">'ATL'</span><span class="tok-o">).</span><span class="tok-na">as</span><span class="tok-o">(</span><span class="tok-s1">'atl'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'aus'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'aus'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'atl'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'atl'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'atl'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'jfk'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'jfk'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'lax'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'lax'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'jfk'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'lax'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'aus'</span><span class="tok-o">).</span>
  <span class="tok-n">addE</span><span class="tok-o">(</span><span class="tok-s1">'route'</span><span class="tok-o">).</span><span class="tok-na">from</span><span class="tok-o">(</span><span class="tok-s1">'lax'</span><span class="tok-o">).</span><span class="tok-na">to</span><span class="tok-o">(</span><span class="tok-s1">'dfw'</span><span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_adjacency_list_format_graphson">8.3.1. Adjacency list format GraphSON</h4>
<div class="paragraph">
<p>To be written</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="json"><span class="tok-p">{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">0</span><span class="tok-p">,</span><span class="tok-nt">"label"</span><span class="tok-p">:</span><span class="tok-s2">"airport"</span><span class="tok-p">,</span><span class="tok-nt">"inE"</span><span class="tok-p">:{</span><span class="tok-nt">"route"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">17</span><span class="tok-p">,</span><span class="tok-nt">"outV"</span><span class="tok-p">:</span><span class="tok-mi">4</span><span class="tok-p">}]},</span> <span class="tok-err">...</span> <span class="tok-p">}</span>
<span class="tok-p">{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">2</span><span class="tok-p">,</span><span class="tok-nt">"label"</span><span class="tok-p">:</span><span class="tok-s2">"airport"</span><span class="tok-p">,</span><span class="tok-nt">"inE"</span><span class="tok-p">:{</span><span class="tok-nt">"route"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">18</span><span class="tok-p">,</span><span class="tok-nt">"outV"</span><span class="tok-p">:</span><span class="tok-mi">4</span><span class="tok-p">},</span> <span class="tok-err">...</span> <span class="tok-p">]}}</span>
<span class="tok-p">{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">4</span><span class="tok-p">,</span><span class="tok-nt">"label"</span><span class="tok-p">:</span><span class="tok-s2">"airport"</span><span class="tok-p">,</span><span class="tok-nt">"inE"</span><span class="tok-p">:{</span><span class="tok-nt">"route"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">15</span><span class="tok-p">,</span><span class="tok-nt">"outV"</span><span class="tok-p">:</span><span class="tok-mi">2</span><span class="tok-p">}]},</span> <span class="tok-err">...</span> <span class="tok-p">}</span>
<span class="tok-p">{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">6</span><span class="tok-p">,</span><span class="tok-nt">"label"</span><span class="tok-p">:</span><span class="tok-s2">"airport"</span><span class="tok-p">,</span><span class="tok-nt">"inE"</span><span class="tok-p">:{</span><span class="tok-nt">"route"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">16</span><span class="tok-p">,</span><span class="tok-nt">"outV"</span><span class="tok-p">:</span><span class="tok-mi">4</span><span class="tok-p">},</span> <span class="tok-err">...</span> <span class="tok-p">]}}</span>
<span class="tok-p">{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">8</span><span class="tok-p">,</span><span class="tok-nt">"label"</span><span class="tok-p">:</span><span class="tok-s2">"airport"</span><span class="tok-p">,</span><span class="tok-nt">"inE"</span><span class="tok-p">:{</span><span class="tok-nt">"route"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">11</span><span class="tok-p">,</span><span class="tok-nt">"outV"</span><span class="tok-p">:</span><span class="tok-mi">0</span><span class="tok-p">}]},</span> <span class="tok-err">...</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="json"><span class="tok-p">{</span>
    <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">0</span><span class="tok-p">,</span>
    <span class="tok-nt">"label"</span><span class="tok-p">:</span> <span class="tok-s2">"airport"</span><span class="tok-p">,</span>
    <span class="tok-nt">"inE"</span><span class="tok-p">:</span> <span class="tok-p">{</span>
        <span class="tok-nt">"route"</span><span class="tok-p">:</span> <span class="tok-p">[{</span>
            <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">17</span><span class="tok-p">,</span>
            <span class="tok-nt">"outV"</span><span class="tok-p">:</span> <span class="tok-mi">4</span>
        <span class="tok-p">}]</span>
    <span class="tok-p">},</span>
    <span class="tok-nt">"outE"</span><span class="tok-p">:</span> <span class="tok-p">{</span>
        <span class="tok-nt">"route"</span><span class="tok-p">:</span> <span class="tok-p">[{</span>
            <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">10</span><span class="tok-p">,</span>
            <span class="tok-nt">"inV"</span><span class="tok-p">:</span> <span class="tok-mi">2</span>
        <span class="tok-p">},</span> <span class="tok-p">{</span>
            <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">11</span><span class="tok-p">,</span>
            <span class="tok-nt">"inV"</span><span class="tok-p">:</span> <span class="tok-mi">8</span>
        <span class="tok-p">}]</span>
    <span class="tok-p">},</span>
    <span class="tok-nt">"properties"</span><span class="tok-p">:</span> <span class="tok-p">{</span>
        <span class="tok-nt">"code"</span><span class="tok-p">:</span> <span class="tok-p">[{</span>
            <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
            <span class="tok-nt">"value"</span><span class="tok-p">:</span> <span class="tok-s2">"AUS"</span>
        <span class="tok-p">}]</span>
    <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="json"><span class="tok-p">{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">197</span><span class="tok-p">,</span><span class="tok-nt">"label"</span><span class="tok-p">:</span><span class="tok-s2">"airport"</span><span class="tok-p">,</span><span class="tok-nt">"inE"</span><span class="tok-p">:{</span><span class="tok-nt">"contains"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">46566</span><span class="tok-p">,</span><span class="tok-nt">"outV"</span><span class="tok-p">:</span><span class="tok-mi">3378</span><span class="tok-p">},{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">49931</span><span class="tok-p">,</span><span class="tok-nt">"outV"</span><span class="tok-p">:</span><span class="tok-mi">3608</span><span class="tok-p">}],</span><span class="tok-nt">"route"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">9524</span><span class="tok-p">,</span><span class="tok-nt">"outV"</span><span class="tok-p">:</span><span class="tok-mi">55</span><span class="tok-p">,</span><span class="tok-nt">"properties"</span><span class="tok-p">:{</span><span class="tok-nt">"dist"</span><span class="tok-p">:</span><span class="tok-mi">520</span><span class="tok-p">}},{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">9753</span><span class="tok-p">,</span><span class="tok-nt">"outV"</span><span class="tok-p">:</span><span class="tok-mi">57</span><span class="tok-p">,</span><span class="tok-nt">"properties"</span><span class="tok-p">:{</span><span class="tok-nt">"dist"</span><span class="tok-p">:</span><span class="tok-mi">903</span><span class="tok-p">}},{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">22158</span><span class="tok-p">,</span><span class="tok-nt">"outV"</span><span class="tok-p">:</span><span class="tok-mi">231</span><span class="tok-p">,</span><span class="tok-nt">"properties"</span><span class="tok-p">:{</span><span class="tok-nt">"dist"</span><span class="tok-p">:</span><span class="tok-mi">1036</span><span class="tok-p">}}]},</span><span class="tok-nt">"outE"</span><span class="tok-p">:{</span><span class="tok-nt">"route"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">20448</span><span class="tok-p">,</span><span class="tok-nt">"inV"</span><span class="tok-p">:</span><span class="tok-mi">231</span><span class="tok-p">,</span><span class="tok-nt">"properties"</span><span class="tok-p">:{</span><span class="tok-nt">"dist"</span><span class="tok-p">:</span><span class="tok-mi">1036</span><span class="tok-p">}},{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">20446</span><span class="tok-p">,</span><span class="tok-nt">"inV"</span><span class="tok-p">:</span><span class="tok-mi">55</span><span class="tok-p">,</span><span class="tok-nt">"properties"</span><span class="tok-p">:{</span><span class="tok-nt">"dist"</span><span class="tok-p">:</span><span class="tok-mi">520</span><span class="tok-p">}},{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">20447</span><span class="tok-p">,</span><span class="tok-nt">"inV"</span><span class="tok-p">:</span><span class="tok-mi">57</span><span class="tok-p">,</span><span class="tok-nt">"properties"</span><span class="tok-p">:{</span><span class="tok-nt">"dist"</span><span class="tok-p">:</span><span class="tok-mi">903</span><span class="tok-p">}}]},</span><span class="tok-nt">"properties"</span><span class="tok-p">:{</span><span class="tok-nt">"country"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">2356</span><span class="tok-p">,</span><span class="tok-nt">"value"</span><span class="tok-p">:</span><span class="tok-s2">"AU"</span><span class="tok-p">}],</span><span class="tok-nt">"code"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">2357</span><span class="tok-p">,</span><span class="tok-nt">"value"</span><span class="tok-p">:</span><span class="tok-s2">"MCY"</span><span class="tok-p">}],</span><span class="tok-nt">"longest"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">2358</span><span class="tok-p">,</span><span class="tok-nt">"value"</span><span class="tok-p">:</span><span class="tok-mi">5896</span><span class="tok-p">}],</span><span class="tok-nt">"city"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">2359</span><span class="tok-p">,</span><span class="tok-nt">"value"</span><span class="tok-p">:</span><span class="tok-s2">"Maroochydore"</span><span class="tok-p">}],</span><span class="tok-nt">"elev"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">2360</span><span class="tok-p">,</span><span class="tok-nt">"value"</span><span class="tok-p">:</span><span class="tok-mi">15</span><span class="tok-p">}],</span><span class="tok-nt">"icao"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">2361</span><span class="tok-p">,</span><span class="tok-nt">"value"</span><span class="tok-p">:</span><span class="tok-s2">"YBSU"</span><span class="tok-p">}],</span><span class="tok-nt">"lon"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">2362</span><span class="tok-p">,</span><span class="tok-nt">"value"</span><span class="tok-p">:</span><span class="tok-mf">153.091003418</span><span class="tok-p">}],</span><span class="tok-nt">"type"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">2363</span><span class="tok-p">,</span><span class="tok-nt">"value"</span><span class="tok-p">:</span><span class="tok-s2">"airport"</span><span class="tok-p">}],</span><span class="tok-nt">"region"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">2364</span><span class="tok-p">,</span><span class="tok-nt">"value"</span><span class="tok-p">:</span><span class="tok-s2">"AU-QLD"</span><span class="tok-p">}],</span><span class="tok-nt">"runways"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">2365</span><span class="tok-p">,</span><span class="tok-nt">"value"</span><span class="tok-p">:</span><span class="tok-mi">2</span><span class="tok-p">}],</span><span class="tok-nt">"lat"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">2366</span><span class="tok-p">,</span><span class="tok-nt">"value"</span><span class="tok-p">:</span><span class="tok-mf">-26.6033000946</span><span class="tok-p">}],</span><span class="tok-nt">"desc"</span><span class="tok-p">:[{</span><span class="tok-nt">"id"</span><span class="tok-p">:</span><span class="tok-mi">2367</span><span class="tok-p">,</span><span class="tok-nt">"value"</span><span class="tok-p">:</span><span class="tok-s2">"Sunshine Coast Airport"</span><span class="tok-p">}]}}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_wrapped_adjacency_list_format_graphson">8.3.2. Wrapped adjacency list format GraphSON</h4>
<div class="paragraph">
<p>To be written</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="json"><span class="tok-p">{</span>
    <span class="tok-nt">"vertices"</span><span class="tok-p">:</span> <span class="tok-p">[{</span>
        <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">0</span><span class="tok-p">,</span>
        <span class="tok-nt">"label"</span><span class="tok-p">:</span> <span class="tok-s2">"airport"</span><span class="tok-p">,</span>
        <span class="tok-nt">"inE"</span><span class="tok-p">:</span> <span class="tok-p">{</span>
            <span class="tok-nt">"route"</span><span class="tok-p">:</span> <span class="tok-p">[{</span>
                <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">17</span><span class="tok-p">,</span>
                <span class="tok-nt">"outV"</span><span class="tok-p">:</span> <span class="tok-mi">4</span>
            <span class="tok-p">}]</span>
        <span class="tok-p">},</span>
        <span class="tok-nt">"outE"</span><span class="tok-p">:</span> <span class="tok-p">{</span>
            <span class="tok-nt">"route"</span><span class="tok-p">:</span> <span class="tok-p">[{</span>
                <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">10</span><span class="tok-p">,</span>
                <span class="tok-nt">"inV"</span><span class="tok-p">:</span> <span class="tok-mi">2</span>
            <span class="tok-p">},</span> <span class="tok-p">{</span>
                <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">11</span><span class="tok-p">,</span>
                <span class="tok-nt">"inV"</span><span class="tok-p">:</span> <span class="tok-mi">8</span>
            <span class="tok-p">}]</span>
        <span class="tok-p">},</span>
        <span class="tok-nt">"properties"</span><span class="tok-p">:</span> <span class="tok-p">{</span>
            <span class="tok-nt">"code"</span><span class="tok-p">:</span> <span class="tok-p">[{</span>
                <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
                <span class="tok-nt">"value"</span><span class="tok-p">:</span> <span class="tok-s2">"AUS"</span>
            <span class="tok-p">}]</span>
        <span class="tok-p">}</span>
    <span class="tok-p">},</span> <span class="tok-p">{</span>
        <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
        <span class="tok-nt">"label"</span><span class="tok-p">:</span> <span class="tok-s2">"airport"</span><span class="tok-p">,</span>
        <span class="tok-nt">"inE"</span><span class="tok-p">:</span> <span class="tok-p">{</span>
            <span class="tok-nt">"route"</span><span class="tok-p">:</span> <span class="tok-p">[{</span>
                <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">18</span><span class="tok-p">,</span>
                <span class="tok-nt">"outV"</span><span class="tok-p">:</span> <span class="tok-mi">4</span>
            <span class="tok-p">},</span> <span class="tok-p">{</span>
                <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">10</span><span class="tok-p">,</span>
                <span class="tok-nt">"outV"</span><span class="tok-p">:</span> <span class="tok-mi">0</span>
            <span class="tok-p">},</span> <span class="tok-p">{</span>
                <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">12</span><span class="tok-p">,</span>
                <span class="tok-nt">"outV"</span><span class="tok-p">:</span> <span class="tok-mi">8</span>
            <span class="tok-p">}]</span>
        <span class="tok-p">},</span>
        <span class="tok-nt">"outE"</span><span class="tok-p">:</span> <span class="tok-p">{</span>
            <span class="tok-nt">"route"</span><span class="tok-p">:</span> <span class="tok-p">[{</span>
                <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">14</span><span class="tok-p">,</span>
                <span class="tok-nt">"inV"</span><span class="tok-p">:</span> <span class="tok-mi">6</span>
            <span class="tok-p">},</span> <span class="tok-p">{</span>
                <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">15</span><span class="tok-p">,</span>
                <span class="tok-nt">"inV"</span><span class="tok-p">:</span> <span class="tok-mi">4</span>
            <span class="tok-p">}]</span>
        <span class="tok-p">},</span>
        <span class="tok-nt">"properties"</span><span class="tok-p">:</span> <span class="tok-p">{</span>
            <span class="tok-nt">"code"</span><span class="tok-p">:</span> <span class="tok-p">[{</span>
                <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">3</span><span class="tok-p">,</span>
                <span class="tok-nt">"value"</span><span class="tok-p">:</span> <span class="tok-s2">"DFW"</span>
            <span class="tok-p">}]</span>
        <span class="tok-p">}</span>
    <span class="tok-p">},</span> <span class="tok-p">{</span>
        <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">4</span><span class="tok-p">,</span>
        <span class="tok-nt">"label"</span><span class="tok-p">:</span> <span class="tok-s2">"airport"</span><span class="tok-p">,</span>
        <span class="tok-nt">"inE"</span><span class="tok-p">:</span> <span class="tok-p">{</span>
            <span class="tok-nt">"route"</span><span class="tok-p">:</span> <span class="tok-p">[{</span>
                <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">15</span><span class="tok-p">,</span>
                <span class="tok-nt">"outV"</span><span class="tok-p">:</span> <span class="tok-mi">2</span>
            <span class="tok-p">}]</span>
        <span class="tok-p">},</span>
        <span class="tok-nt">"outE"</span><span class="tok-p">:</span> <span class="tok-p">{</span>
            <span class="tok-nt">"route"</span><span class="tok-p">:</span> <span class="tok-p">[{</span>
                <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">16</span><span class="tok-p">,</span>
                <span class="tok-nt">"inV"</span><span class="tok-p">:</span> <span class="tok-mi">6</span>
            <span class="tok-p">},</span> <span class="tok-p">{</span>
                <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">17</span><span class="tok-p">,</span>
                <span class="tok-nt">"inV"</span><span class="tok-p">:</span> <span class="tok-mi">0</span>
            <span class="tok-p">},</span> <span class="tok-p">{</span>
                <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">18</span><span class="tok-p">,</span>
                <span class="tok-nt">"inV"</span><span class="tok-p">:</span> <span class="tok-mi">2</span>
            <span class="tok-p">}]</span>
        <span class="tok-p">},</span>
        <span class="tok-nt">"properties"</span><span class="tok-p">:</span> <span class="tok-p">{</span>
            <span class="tok-nt">"code"</span><span class="tok-p">:</span> <span class="tok-p">[{</span>
                <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">5</span><span class="tok-p">,</span>
                <span class="tok-nt">"value"</span><span class="tok-p">:</span> <span class="tok-s2">"LAX"</span>
            <span class="tok-p">}]</span>
        <span class="tok-p">}</span>
    <span class="tok-p">},</span> <span class="tok-p">{</span>
        <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">6</span><span class="tok-p">,</span>
        <span class="tok-nt">"label"</span><span class="tok-p">:</span> <span class="tok-s2">"airport"</span><span class="tok-p">,</span>
        <span class="tok-nt">"inE"</span><span class="tok-p">:</span> <span class="tok-p">{</span>
            <span class="tok-nt">"route"</span><span class="tok-p">:</span> <span class="tok-p">[{</span>
                <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">16</span><span class="tok-p">,</span>
                <span class="tok-nt">"outV"</span><span class="tok-p">:</span> <span class="tok-mi">4</span>
            <span class="tok-p">},</span> <span class="tok-p">{</span>
                <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">13</span><span class="tok-p">,</span>
                <span class="tok-nt">"outV"</span><span class="tok-p">:</span> <span class="tok-mi">8</span>
            <span class="tok-p">},</span> <span class="tok-p">{</span>
                <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">14</span><span class="tok-p">,</span>
                <span class="tok-nt">"outV"</span><span class="tok-p">:</span> <span class="tok-mi">2</span>
            <span class="tok-p">}]</span>
        <span class="tok-p">},</span>
        <span class="tok-nt">"properties"</span><span class="tok-p">:</span> <span class="tok-p">{</span>
            <span class="tok-nt">"code"</span><span class="tok-p">:</span> <span class="tok-p">[{</span>
                <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">7</span><span class="tok-p">,</span>
                <span class="tok-nt">"value"</span><span class="tok-p">:</span> <span class="tok-s2">"JFK"</span>
            <span class="tok-p">}]</span>
        <span class="tok-p">}</span>
    <span class="tok-p">},</span> <span class="tok-p">{</span>
        <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">8</span><span class="tok-p">,</span>
        <span class="tok-nt">"label"</span><span class="tok-p">:</span> <span class="tok-s2">"airport"</span><span class="tok-p">,</span>
        <span class="tok-nt">"inE"</span><span class="tok-p">:</span> <span class="tok-p">{</span>
            <span class="tok-nt">"route"</span><span class="tok-p">:</span> <span class="tok-p">[{</span>
                <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">11</span><span class="tok-p">,</span>
                <span class="tok-nt">"outV"</span><span class="tok-p">:</span> <span class="tok-mi">0</span>
            <span class="tok-p">}]</span>
        <span class="tok-p">},</span>
        <span class="tok-nt">"outE"</span><span class="tok-p">:</span> <span class="tok-p">{</span>
            <span class="tok-nt">"route"</span><span class="tok-p">:</span> <span class="tok-p">[{</span>
                <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">12</span><span class="tok-p">,</span>
                <span class="tok-nt">"inV"</span><span class="tok-p">:</span> <span class="tok-mi">2</span>
            <span class="tok-p">},</span> <span class="tok-p">{</span>
                <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">13</span><span class="tok-p">,</span>
                <span class="tok-nt">"inV"</span><span class="tok-p">:</span> <span class="tok-mi">6</span>
            <span class="tok-p">}]</span>
        <span class="tok-p">},</span>
        <span class="tok-nt">"properties"</span><span class="tok-p">:</span> <span class="tok-p">{</span>
            <span class="tok-nt">"code"</span><span class="tok-p">:</span> <span class="tok-p">[{</span>
                <span class="tok-nt">"id"</span><span class="tok-p">:</span> <span class="tok-mi">9</span><span class="tok-p">,</span>
                <span class="tok-nt">"value"</span><span class="tok-p">:</span> <span class="tok-s2">"ATL"</span>
            <span class="tok-p">}]</span>
        <span class="tok-p">}</span>
    <span class="tok-p">}]</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fr">9. FURTHER READING</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Below you will find a selection of links to additional material related to the topics
covered in this book. The links include additional web sites maintained by the Apache
TinkerPop community as well as some mailing lists where Gremlin and related topics
are discussed daily.</p>
</div>
<div class="sect2">
<h3 id="tplinks">9.1. Additional Apache TinkerPop community links</h3>
<div class="paragraph">
<div class="title">Official Apache TinkerPop home page and Gremlin downloads</div>
<p><a href="http://tinkerpop.apache.org/" class="bare">http://tinkerpop.apache.org/</a></p>
</div>
<div class="paragraph">
<div class="title">Apache TinkerPop Getting Started guide</div>
<p><a href="http://tinkerpop.apache.org/docs/current/tutorials/getting-started/" class="bare">http://tinkerpop.apache.org/docs/current/tutorials/getting-started/</a></p>
</div>
<div class="paragraph">
<div class="title">Current Apache TinkerPop documention</div>
<p><a href="http://tinkerpop.apache.org/docs/current/reference/" class="bare">http://tinkerpop.apache.org/docs/current/reference/</a></p>
</div>
<div class="paragraph">
<div class="title">Apache TinkerPop JavaDoc API reference material</div>
<p><a href="http://tinkerpop.apache.org/javadocs/current/core/" class="bare">http://tinkerpop.apache.org/javadocs/current/core/</a></p>
</div>
<div class="paragraph">
<p><a href="http://tinkerpop.apache.org/javadocs/current/full/" class="bare">http://tinkerpop.apache.org/javadocs/current/full/</a></p>
</div>
<div class="paragraph">
<div class="title">Gremlin IO serialization and file formats documentation</div>
<p><a href="http://tinkerpop.apache.org/docs/current/dev/io/" class="bare">http://tinkerpop.apache.org/docs/current/dev/io/</a></p>
</div>
<div class="paragraph">
<div class="title">Useful Gremlin "recipies"</div>
<p><a href="http://tinkerpop.apache.org/docs/current/recipes/" class="bare">http://tinkerpop.apache.org/docs/current/recipes/</a></p>
</div>
<div class="paragraph">
<div class="title">Apache TinkerPop documentation describing new features per release</div>
<p><a href="http://tinkerpop.apache.org/docs/current/upgrade/" class="bare">http://tinkerpop.apache.org/docs/current/upgrade/</a></p>
</div>
<div class="paragraph">
<div class="title">Apache TinkerPop documentation for graph database providers</div>
<p><a href="http://tinkerpop.apache.org/docs/current/dev/provider/" class="bare">http://tinkerpop.apache.org/docs/current/dev/provider/</a></p>
</div>
<div class="sect3">
<h4 id="tutorials">9.1.1. Tutorials</h4>
<div class="paragraph">
<p>There are a series of tutorials that can be found at the link below.</p>
</div>
<div class="paragraph">
<div class="title">Apache TinkerPop Tutorials</div>
<p><a href="http://tinkerpop.apache.org/docs/current/tutorials/" class="bare">http://tinkerpop.apache.org/docs/current/tutorials/</a></p>
</div>
<div class="paragraph">
<p>The tutorials include the following</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Getting started</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="http://tinkerpop.apache.org/docs/current/tutorials/getting-started/" class="bare">http://tinkerpop.apache.org/docs/current/tutorials/getting-started/</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Gremlin language variants</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="http://tinkerpop.apache.org/docs/current/tutorials/gremlin-language-variants/" class="bare">http://tinkerpop.apache.org/docs/current/tutorials/gremlin-language-variants/</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Gremlin’s anatomy</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="http://tinkerpop.apache.org/docs/current/tutorials/gremlins-anatomy/" class="bare">http://tinkerpop.apache.org/docs/current/tutorials/gremlins-anatomy/</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">The Gremlin console</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="http://tinkerpop.apache.org/docs/current/tutorials/the-gremlin-console/" class="bare">http://tinkerpop.apache.org/docs/current/tutorials/the-gremlin-console/</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="gremlindiscussionlists">9.2. Gremlin related mailing lists and discussion groups</h3>
<div class="paragraph">
<div class="title">Public mailing list for Gremlin users</div>
<p><a href="https://groups.google.com/forum/#!forum/gremlin-users" class="bare">https://groups.google.com/forum/#!forum/gremlin-users</a></p>
</div>
<div class="paragraph">
<div class="title">Apache TinkerPop developers mailing list archive</div>
<p><a href="https://lists.apache.org/" class="bare">https://lists.apache.org/</a></p>
</div>
<div class="paragraph">
<div class="title">Stack Overflow posts tagged with "gremlin"</div>
<p><a href="https://stackoverflow.com/questions/tagged/gremlin" class="bare">https://stackoverflow.com/questions/tagged/gremlin</a></p>
</div>
</div>
<div class="sect2">
<h3 id="janusgraphlinks">9.3. JanusGraph links</h3>
<div class="paragraph">
<div class="title">JanusGraph home page</div>
<p><a href="http://janusgraph.org/" class="bare">http://janusgraph.org/</a></p>
</div>
<div class="paragraph">
<div class="title">JanusGraph overview documentation</div>
<p><a href="http://docs.janusgraph.org/latest/" class="bare">http://docs.janusgraph.org/latest/</a></p>
</div>
<div class="paragraph">
<div class="title">JanusGraph API documentation</div>
<p><a href="http://docs.janusgraph.org/latest/javadoc.html" class="bare">http://docs.janusgraph.org/latest/javadoc.html</a></p>
</div>
<div class="paragraph">
<div class="title">Public mailing list for JanusGraph users</div>
<p><a href="https://groups.google.com/forum/#!forum/janusgraph-users" class="bare">https://groups.google.com/forum/#!forum/janusgraph-users</a></p>
</div>
<div class="paragraph">
<div class="title">Stack Overflow posts tagged with "janusgraph"</div>
<p><a href="https://stackoverflow.com/questions/tagged/janusgraph" class="bare">https://stackoverflow.com/questions/tagged/janusgraph</a></p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 283-preview<br>
Last updated 2022-05-04 18:47:05 CDT
</div>
</div>


<div id="snippet_sidebar_container" class="minimal">
        <div id="snippet_sidebar_iframe">
          <iframe src="./PRACTICAL GREMLIN_ An Apache TinkerPop Tutorial_files/index.html" allowtransparency="false" frameborder="0" style="width:100%;height:100%"></iframe>
        </div>
     </div><div id="snippet_popover_container" class="bottom-caret" style="opacity: 0; top: 791.8px; left: 223.9px; display: none; height: 84px;">
      <iframe class="snippet_popover_iframe" src="./PRACTICAL GREMLIN_ An Apache TinkerPop Tutorial_files/index(1).html" allowtransparency="false" frameborder="0" scrolling="no"></iframe>
     </div><div class="snippet-img-button" style="background-image: url(&quot;chrome-extension://fkaokedhimpifhfadmgjpfjimkogdlcm/images/button_add.svg&quot;); display: none; z-index: 8700000; top: 10px; left: 284.6px;"></div></body><grammarly-desktop-integration data-grammarly-shadow-root="true"></grammarly-desktop-integration></html>